<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>ServiFlow — Support Platform</title>
<!-- Ionic Framework -->
<script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
<script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"/>
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<!-- jQuery (for DataTables only) -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
  // Set Ionic to iOS mode for consistent look
  window.Ionic = { mode: 'ios' };
</script>
<!-- PWA Meta Tags -->
<meta name="description" content="ServiFlow - Full-featured support ticket management platform with AI-powered insights"/>
<meta name="theme-color" content="#003366"/>
<meta name="mobile-web-app-capable" content="yes"/>
<!-- iOS PWA Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="ServiFlow"/>
<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json"/>
<!-- Icons -->
<link rel="icon" type="image/svg+xml" href="/icons/icon.svg"/>
<link rel="apple-touch-icon" href="/icons/icon-180x180.png"/>
<link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png"/>
<link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png"/>
<link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-167x167.png"/>
<!-- iOS Splash Screens -->
<link rel="apple-touch-startup-image" href="/icons/splash-1170x2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1284x2778.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1290x2796.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1179x2556.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1620x2160.png" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2)"/>
<!-- Mobile Responsive CSS -->
<link rel="stylesheet" href="/public/css/responsive.css?v=20231223"/>
<!-- Build: 2026-02-03T20:50 - APO-58 Fullscreen Mode -->
<!-- Changelog:
vNext-FULL-ActionsSLA: 
- ADDED mandatory completion text modal for Admin/Expert when resolving or reassigning.
- KEPT status transitions, live SLA timers, 3 role dashboards, CMDB, Raise, Experts, Customers, Wizard, Chat.
- NON‑DESTRUCTIVE: prior flows preserved.
-->
<style>
  /* Theme: Light (default) */
  :root,html.theme-light{color-scheme:light;--bg:#fafafa;--card:#ffffff;--ink:#1a1a1a;--muted:#717171;--primary:#1a1a1a;--primary-dark:#000000;--accent:#1a1a1a;--danger:#dc2626;--warn:#ca8a04;--ok:#16a34a;--radius:8px;--shadow:0 1px 2px rgba(0,0,0,.04);--shadow-lg:0 2px 8px rgba(0,0,0,.08);--border:#e5e5e5;--card-hover:#f5f5f5;--table-header:#fafafa;--input-bg:#ffffff;--topnav-bg:#ffffff;--logo-bg:#1a1a1a;--logo-text:#ffffff;--avatar-bg:#1a1a1a;--badge-bg:#fafafa}

  /* Theme: Dark */
  html.theme-dark{color-scheme:dark;--bg:#0a0a0a;--card:#141414;--ink:#f5f5f5;--muted:#a3a3a3;--primary:#ffffff;--primary-dark:#e5e5e5;--accent:#ffffff;--danger:#dc2626;--warn:#ca8a04;--ok:#16a34a;--border:#262626;--card-hover:#1f1f1f;--table-header:#141414;--input-bg:#1a1a1a;--topnav-bg:#0a0a0a;--logo-bg:#ffffff;--logo-text:#0a0a0a;--avatar-bg:#ffffff;--badge-bg:#1a1a1a}

  *{box-sizing:border-box}
  /* Override Ionic's body styles that break scrolling */
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--ink);padding-top:56px;transition:background .2s,color .2s;position:static !important;overflow-y:auto !important;height:auto !important;max-height:none !important}

  /* Clean Top Navigation */
  .topnav{position:fixed;top:0;left:0;right:0;height:56px;background:var(--topnav-bg);border-bottom:1px solid var(--border);z-index:100;display:flex;align-items:center;padding:0 24px;transition:background .2s,border-color .2s}
  .topnav-inner{max-width:1200px;width:100%;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
  .topnav-brand{display:flex;align-items:center;gap:10px;text-decoration:none}
  .topnav-brand .logo-icon{width:32px;height:32px;flex-shrink:0}
  .topnav-brand .logo-icon svg{width:100%;height:100%;display:block}
  .topnav-brand .logo-icon svg rect{fill:var(--logo-bg);transition:fill .2s}
  .topnav-brand .logo-icon svg text{fill:var(--logo-text);transition:fill .2s}
  .topnav-brand span{font-weight:600;font-size:16px;color:var(--ink);letter-spacing:-.3px}
  .topnav-right{display:flex;align-items:center;gap:12px}
  .topnav-user{display:flex;align-items:center;gap:8px;padding:4px 10px 4px 4px;border:1px solid var(--border);border-radius:999px;cursor:pointer;transition:all .15s}
  .topnav-user:hover{background:var(--card-hover)}
  .topnav-avatar{width:28px;height:28px;border-radius:999px;background:var(--avatar-bg);display:flex;align-items:center;justify-content:center;color:var(--logo-text);font-weight:500;font-size:12px;transition:background .2s}
  .topnav-name{font-weight:500;font-size:13px;color:var(--ink)}
  .topnav-role{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
  .topnav-actions{display:flex;gap:6px}
  .topnav-btn{padding:6px 12px;border-radius:6px;font-size:13px;font-weight:500;border:1px solid var(--border);cursor:pointer;transition:all .15s;background:var(--card)}
  .topnav-btn.ghost{background:transparent;color:var(--muted);border-color:transparent}
  .topnav-btn.ghost:hover{background:var(--card-hover);color:var(--ink)}
  .topnav-btn.primary{background:var(--primary);color:var(--bg);border-color:var(--primary)}
  .topnav-btn.primary:hover{background:var(--primary-dark)}

  /* Theme Toggle Dropdown */
  .theme-dropdown{position:relative}
  .theme-toggle{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
  .theme-toggle:hover{background:var(--card-hover)}
  .theme-toggle svg{width:18px;height:18px;color:var(--ink)}
  .theme-menu{position:absolute;top:calc(100% + 4px);right:0;background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:var(--shadow-lg);min-width:120px;z-index:1000;display:none;overflow:hidden}
  .theme-dropdown.open .theme-menu{display:block}
  .theme-menu-item{display:flex;align-items:center;gap:8px;padding:10px 14px;cursor:pointer;font-size:13px;color:var(--ink);transition:background .1s}
  .theme-menu-item:hover{background:var(--card-hover)}
  .theme-menu-item.active{background:var(--card-hover);font-weight:500}
  .theme-menu-item svg{width:16px;height:16px;color:var(--muted)}

  .container{max-width:1200px;margin:0 auto;padding:20px}

  /* Hide old brandbar - replaced by topnav */
  .brandbar{display:none}
  .screen{display:none;animation:fade .2s ease-in} .screen.active{display:block}
  @keyframes fade{from{opacity:.7;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
  .card{background:var(--card);border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--border);transition:background .2s,border-color .2s}
  .card.clickable:hover{transform:scale(1.02);background:var(--card-hover)}
  .card.stat-card-active{font-weight:500}
  .p-12{padding:12px} .p-16{padding:16px} .p-20{padding:20px} .p-24{padding:24px}
  .mb-8{margin-bottom:8px} .mb-12{margin-bottom:12px} .mb-16{margin-bottom:16px} .mb-24{margin-bottom:24px}
  .title{font-size:20px;font-weight:600;margin:0 0 6px;letter-spacing:-.3px} .subtitle{font-size:13px;color:var(--muted);margin:0 0 12px}
  .row{display:flex;gap:12px;align-items:center} .space{justify-content:space-between} .wrap{flex-wrap:wrap}
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px} .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px} .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px}
.ai-trend-card{background:rgba(255,255,255,0.08);border-radius:8px;padding:16px;border-left:4px solid #667eea}
.ai-trend-card.critical{border-left-color:#ff6b6b;background:rgba(255,107,107,0.1)}
.ai-trend-card.warning{border-left-color:#ffc107;background:rgba(255,193,7,0.1)}
.ai-trend-card.info{border-left-color:#48bb78;background:rgba(72,187,120,0.1)}
.ai-category-badge{background:rgba(255,255,255,0.15);padding:6px 12px;border-radius:20px;font-size:12px;display:inline-flex;align-items:center;gap:6px}
  /* Clean Sidebar Layout */
  .two-col{display:grid;grid-template-columns:220px 1fr;gap:24px;transition:grid-template-columns .25s ease}
  .leftnav{position:sticky;top:76px;height:fit-content;transition:opacity .2s ease,transform .2s ease}

  /* Sidebar Collapse (Desktop only) */
  .sidebar-toggle-btn{display:none;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;align-items:center;justify-content:center;gap:6px;transition:all .15s;flex-shrink:0;font-size:13px;font-weight:500;color:var(--muted)}
  .sidebar-toggle-btn:hover{background:var(--primary);color:var(--bg);border-color:var(--primary)}
  .sidebar-toggle-btn:hover svg{stroke:var(--bg)}
  .sidebar-toggle-btn svg{width:16px;height:16px;stroke:currentColor;transition:transform .2s}
  @media (min-width:769px){
    .sidebar-toggle-btn{display:flex}
    .sidebar-collapsed .two-col{grid-template-columns:0 1fr;gap:0}
    .sidebar-collapsed .leftnav{opacity:0;pointer-events:none;transform:translateX(-20px);width:0;overflow:hidden}
    .sidebar-collapsed .sidebar-toggle-btn svg{transform:rotate(180deg)}
    .sidebar-collapsed .sidebar-toggle-label{display:none}
  }
  @media (max-width:900px){
    .sidebar-toggle-label{display:none}
    .search-shortcut{display:none}
  }

  /* Fullscreen Mode */
  body.fullscreen-mode .topnav{display:none}
  body.fullscreen-mode{padding-top:0}
  body.fullscreen-mode .two-col{grid-template-columns:1fr !important;gap:0 !important}
  body.fullscreen-mode .leftnav{display:none !important}
  body.fullscreen-mode #view-ticket-detail{position:fixed;inset:0;z-index:200;background:var(--bg);overflow-y:auto;padding:20px;margin:0}
  .fullscreen-exit-btn{display:none;position:fixed;top:12px;right:12px;z-index:9999;padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:13px;font-weight:500;color:var(--ink);transition:all .15s;box-shadow:var(--shadow-lg)}
  .fullscreen-exit-btn:hover{background:var(--card-hover);border-color:var(--primary);color:var(--primary)}
  body.fullscreen-mode .fullscreen-exit-btn{display:flex;align-items:center;gap:6px}
  .fullscreen-toggle-btn{padding:8px 14px;border-radius:6px;border:2px solid var(--primary);background:var(--card);cursor:pointer;font-size:13px;font-weight:600;color:var(--primary);transition:all .15s;display:inline-flex;align-items:center;gap:6px}
  .fullscreen-toggle-btn:hover{background:var(--primary);color:var(--bg)}
  .fullscreen-toggle-btn:hover svg{stroke:var(--bg)}
  .leftnav .subtitle{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin:0 0 2px 10px;font-weight:500}
  .navlink{display:flex;align-items:center;gap:6px;padding:2px 10px;border-radius:6px;margin-bottom:0;cursor:pointer;font-size:13px;font-weight:400;color:var(--muted);transition:all .15s ease}
  .navlink svg{flex-shrink:0;opacity:.7;transition:opacity .15s}
  .navlink:hover svg{opacity:1}
  .navlink.active svg{opacity:1;stroke:var(--bg)}
  .navlink:hover{background:var(--card-hover);color:var(--ink)}
  .navlink.active{background:var(--primary);color:var(--bg)}
  .nav-subitem svg{flex-shrink:0;opacity:.6;transition:opacity .15s}
  .nav-subitem:hover svg{opacity:1}
  .nav-subitem.active svg{opacity:1;stroke:var(--bg)}
  .navlink:focus,.navlink:active:not(.active){background:transparent;color:var(--muted);outline:none;-webkit-tap-highlight-color:transparent}
  .navlink:hover:active:not(.active){background:var(--card-hover);color:var(--ink)}
  /* Collapsible Nav Group */
  .nav-group{margin-bottom:0}
  .nav-group .navlink{display:flex;justify-content:space-between;align-items:center}
  .nav-group .chev{font-size:10px;transition:transform .15s}
  .nav-group.open > .navlink > .chev,
  .nav-group.open > .subtitle > .chev{transform:rotate(90deg)}
  .nav-subitems{display:none;padding-left:10px}
  .nav-group.open > .nav-subitems{display:block}
  .nav-subitem{display:flex;align-items:center;gap:6px;padding:2px 10px;border-radius:6px;margin-bottom:0;cursor:pointer;font-size:12px;color:var(--muted);transition:all .15s ease}
  .nav-subitem:hover{background:var(--card-hover);color:var(--ink)}
  .nav-subitem.active{background:var(--primary);color:var(--bg)}
  .nav-subitem:focus,.nav-subitem:active:not(.active){background:transparent;color:var(--muted);outline:none;-webkit-tap-highlight-color:transparent}
  .nav-subitem:hover:active:not(.active){background:var(--card-hover);color:var(--ink)}
  /* Admin-only sections in ticket detail */
  .admin-section{position:relative;background:var(--card-hover);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px}
  .admin-section::before{content:'Admin';position:absolute;top:-8px;left:12px;background:var(--card);padding:0 6px;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);font-weight:500}
  .admin-section.collapsed{display:none}
  .admin-only-inline.hidden,.admin-only-btn.hidden{display:none!important}
  .admin-section-card{position:relative}
  .admin-section-card::before{content:'Admin';position:absolute;top:8px;right:12px;background:var(--card-hover);padding:2px 8px;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);font-weight:500;border-radius:4px}
  .admin-section-card.collapsed{display:none}
  .btn{appearance:none;border:1px solid var(--border);border-radius:8px;padding:8px 14px;font-weight:500;font-size:13px;cursor:pointer;background:var(--card);color:var(--ink);transition:all .15s ease}
  .btn:hover{background:var(--card-hover)}
  .btn.primary{background:var(--primary);color:var(--bg);border-color:var(--primary)}
  .btn.primary:hover{opacity:.9}
  .btn.ghost{background:transparent;border-color:transparent;color:var(--muted)}
  .btn.ghost:hover{background:var(--card-hover);color:var(--ink)}
  .btn.accent{background:var(--primary);color:var(--bg);border-color:var(--primary)}
  .btn.warn{background:#fefce8;border-color:#fde047;color:#a16207} .btn.danger{background:#fef2f2;border-color:#fecaca;color:#dc2626}
  .btn.ai-btn{background:var(--primary);color:var(--bg);border:1px solid var(--primary);font-weight:500}
  .btn.ai-btn:hover{opacity:.9} .btn.ai-action{background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);font-size:12px;padding:6px 10px}
  .btn.ai-action:hover{background:rgba(255,255,255,0.2)} .ai-action-confidence{font-size:10px;opacity:0.7;margin-left:4px}
  .input, select, textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:var(--input-bg);color:var(--ink);font-size:14px;transition:all .15s}
  .input:focus, select:focus, textarea:focus{outline:none;border-color:var(--primary)}
  textarea{min-height:100px;resize:vertical}
  table{width:100%;border-collapse:collapse} th{text-align:left;padding:10px 12px;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);font-weight:500;border-bottom:1px solid var(--border);background:var(--table-header)}
  td{text-align:left;padding:12px;border-bottom:1px solid var(--border);font-size:13px} tr:hover{background:var(--card-hover);cursor:pointer}
  .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:500;border:1px solid var(--border);background:#fafafa;color:var(--ink)}
  .badge.plan-trial{background:#f3e8ff;color:#7c3aed;border-color:#e9d5ff}
  .badge.plan-starter{background:#dbeafe;color:#2563eb;border-color:#bfdbfe}
  .badge.plan-pro{background:#fef3c7;color:#d97706;border-color:#fde68a}
  .badge.status-active{background:#dcfce7;color:#16a34a;border-color:#bbf7d0}
  .badge.status-pending{background:#fef3c7;color:#d97706;border-color:#fde68a}
  .badge.status-cancelled{background:#fef2f2;color:#dc2626;border-color:#fecaca}
  .badge.status-success{background:#dcfce7;color:#16a34a;border-color:#bbf7d0}
  .badge-red{background:#fef2f2;color:#dc2626;border-color:#fecaca}
  .badge-amber{background:#fef3c7;color:#d97706;border-color:#fde68a}
  .badge-green{background:#dcfce7;color:#16a34a;border-color:#bbf7d0}
  .badge-gray{background:#f5f5f5;color:#525252;border-color:#e5e5e5}
  .badge.status-warning{background:#fef3c7;color:#d97706;border-color:#fde68a}
  .badge.status-error{background:#fef2f2;color:#dc2626;border-color:#fecaca}
  
  .progress-bar{width:100%;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#4caf50 0%,#ff9800 70%,#f44336 100%);transition:width 0.3s ease}
  .usage-alert{padding:12px;margin:8px 0;border-radius:4px;border-left:4px solid}
  .usage-alert.warning{background:#fff3cd;border-color:#ff9800;color:#856404}
  .usage-alert.danger{background:#f8d7da;border-color:#f44336;color:#721c24}
  .usage-alert.info{background:#d1ecf1;border-color:#17a2b8;color:#0c5460}
  .sla.ok{color:var(--ok);border-color:#bbf7d0;background:#f0fdf4}
  .sla.warn{color:var(--warn);border-color:#fed7aa;background:#fffbeb}
  .sla.danger{color:var(--danger);border-color:#fecaca;background:#fef2f2}
  .progress{height:6px;border-radius:999px;background:var(--border);overflow:hidden}
  .progress>span{display:block;height:100%;background:var(--primary)}
  #chat-toggle{position:fixed;right:20px;bottom:20px;border-radius:999px;padding:12px 16px;box-shadow:var(--shadow-lg);background:var(--primary);color:var(--bg);border:none;cursor:pointer;font-weight:500;font-size:13px;transition:all .2s;z-index:91}
  #chat-toggle:hover{opacity:.9}
  #chat-toggle .chat-badge{position:absolute;top:-4px;right:-4px;background:#dc2626;color:#fff;border-radius:50%;width:20px;height:20px;font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:700}
  #chat{position:fixed;right:20px;bottom:72px;width:380px;height:520px;display:none;flex-direction:column;z-index:90;border-radius:12px;overflow:hidden;box-shadow:var(--shadow-lg);border:1px solid var(--border)}
  #chat .chat-header{padding:12px 16px;background:var(--primary);color:var(--bg);font-weight:500;font-size:14px;display:flex;align-items:center;justify-content:space-between}
  #chat .chat-header .chat-status{font-size:11px;opacity:.8;font-weight:400}
  #chat .chat-messages{flex:1;padding:12px;overflow-y:auto;background:var(--bg);display:flex;flex-direction:column;gap:6px}
  #chat .chat-msg{padding:8px 12px;border-radius:10px;max-width:80%;font-size:13px;line-height:1.5;word-break:break-word}
  #chat .chat-msg.system{background:var(--table-header);color:var(--muted);text-align:center;font-size:11px;max-width:100%;align-self:center;padding:4px 10px;border-radius:20px}
  #chat .chat-msg.incoming{background:var(--card);border:1px solid var(--border);align-self:flex-start}
  #chat .chat-msg.outgoing{background:var(--primary);color:var(--bg);align-self:flex-end}
  #chat .chat-msg .msg-sender{font-size:10px;font-weight:600;margin-bottom:2px;opacity:.7}
  #chat .chat-msg .msg-time{font-size:10px;opacity:.6;margin-top:2px}
  #chat .chat-msg .msg-file{display:flex;align-items:center;gap:6px;padding:6px 8px;background:rgba(0,0,0,.05);border-radius:6px;margin-top:4px;font-size:12px;cursor:pointer;text-decoration:none;color:inherit}
  #chat .chat-footer{padding:8px 12px;border-top:1px solid var(--border);background:var(--card);display:flex;gap:8px;align-items:center}
  #chat .chat-footer input{flex:1;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;outline:none;background:var(--bg)}
  #chat .chat-footer input:focus{border-color:var(--primary)}
  #chat .chat-typing{padding:2px 12px;font-size:11px;color:var(--muted);min-height:16px}
  #chat .chat-queue{padding:20px;text-align:center;background:var(--bg);flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
  #chat .chat-queue .queue-pos{font-size:48px;font-weight:800;color:var(--primary)}
  #chat .chat-qualify{padding:16px;background:var(--bg);flex:1;overflow-y:auto}
  #chat .chat-qualify .q-item{margin-bottom:12px}
  #chat .chat-qualify .q-label{font-size:12px;font-weight:600;margin-bottom:4px}
  #chat .chat-rating{padding:20px;text-align:center;background:var(--bg);flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px}
  #chat .chat-rating .stars{display:flex;gap:8px;font-size:28px;cursor:pointer}
  #chat .chat-rating .stars span:hover{transform:scale(1.2)}
  .expert-chat-panel{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden}
  .expert-chat-panel .ech-header{padding:10px 14px;background:var(--table-header);font-weight:600;font-size:13px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
  .expert-chat-panel .ech-list{max-height:300px;overflow-y:auto}
  .expert-chat-panel .ech-item{padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;display:flex;align-items:center;justify-content:space-between}
  .expert-chat-panel .ech-item:hover{background:var(--table-header)}
  .expert-chat-panel .ech-item.active{background:#eff6ff;border-left:3px solid var(--primary)}
  .expert-chat-panel .ech-item .ech-name{font-weight:500;font-size:13px}
  .expert-chat-panel .ech-item .ech-preview{font-size:11px;color:var(--muted);margin-top:2px}
  .expert-chat-panel .ech-item .ech-badge{background:#dc2626;color:#fff;border-radius:50%;width:18px;height:18px;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:700}
  .expert-chat-panel .ech-empty{padding:20px;text-align:center;color:var(--muted);font-size:12px}
  .expert-chat-window{border:1px solid var(--border);border-radius:10px;overflow:hidden;display:flex;flex-direction:column;height:400px;background:var(--bg)}
  .expert-chat-window .ecw-header{padding:10px 14px;background:var(--primary);color:var(--bg);font-weight:500;font-size:13px;display:flex;justify-content:space-between;align-items:center}
  .expert-chat-window .ecw-messages{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;gap:4px}
  .expert-chat-window .ecw-footer{padding:8px;border-top:1px solid var(--border);display:flex;gap:6px;background:var(--card)}
  .expert-chat-window .ecw-footer input{flex:1;border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;outline:none}
  .canned-resp-btn{padding:4px 10px;border-radius:20px;background:var(--table-header);border:1px solid var(--border);font-size:11px;cursor:pointer;white-space:nowrap;transition:all .15s}
  .canned-resp-btn:hover{background:var(--primary);color:var(--bg);border-color:var(--primary)}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  #err{display:none;position:fixed;left:0;right:0;bottom:0;background:#fef2f2;color:#dc2626;padding:10px 16px;font-size:13px;border-top:1px solid #fecaca;z-index:200}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;padding-top:60px;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:1000;overflow-y:auto}
  .modal .sheet{width:min(560px,calc(100vw - 32px));background:var(--card);border-radius:12px;box-shadow:var(--shadow-lg);overflow:hidden;border:1px solid var(--border);margin-bottom:40px}
  .modal .head{padding:16px 20px;background:var(--primary);color:var(--bg);font-weight:500;font-size:15px}
  .modal .body{padding:20px}
  .modal .foot{padding:12px 20px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border);background:var(--table-header)}

  /* Ensure modal-content class (used by invite-user-modal) is styled */
  .modal-content {
    width: min(500px, calc(100vw - 32px));
    background: var(--card);
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    padding: 20px;
    border: 1px solid var(--border);
  }

  /* Popover mode for Edit (anchored to button) */
  .sheet.popover{position:fixed;z-index:2000;width:500px;max-width:92vw;max-height:85vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.35)}

  /* Compact mode for Quick Edit popovers */
  .sheet.compact .sla-description-row{display:none}
  .sheet.compact .head{padding:10px 16px;font-size:14px}
  .sheet.compact .body{padding:12px 16px}
  .sheet.compact .body .mb-12{margin-bottom:8px}
  .sheet.compact .body .subtitle{margin-bottom:2px;font-size:12px}
  .sheet.compact .body .input{padding:6px 10px;font-size:13px}
  .sheet.compact .foot{padding:8px 16px}

  /* Wizard Nav */
  .wizard-nav-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);font-size:13px;transition:background .15s}
  .wizard-nav-item:last-child{border-bottom:none}
  .wizard-nav-item:hover{background:var(--bg)}
  .wizard-nav-item.active{background:var(--primary);color:var(--bg);font-weight:500}

  /* CMDB Hub Nav */
  .cmdb-nav-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);font-size:13px;transition:background .15s}
  .cmdb-nav-item:last-child{border-bottom:none}
  .cmdb-nav-item:hover{background:var(--bg)}
  .cmdb-nav-item.active{background:var(--primary);color:var(--bg);font-weight:500}

  /* CMDB Detail Tabs */
  .cmdb-tab{background:var(--bg);border:1px solid var(--border);font-weight:500}
  .cmdb-tab.active{background:var(--primary);color:white;border-color:var(--primary)}
  .cmdb-tab-content{animation:fadeIn .2s ease}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}

  /* History Timeline */
  .history-item{padding:12px;border-left:3px solid var(--border);margin-left:12px;margin-bottom:8px;background:var(--bg);border-radius:0 6px 6px 0}
  .history-item.created{border-left-color:#22c55e}
  .history-item.updated{border-left-color:#3b82f6}
  .history-item.deleted{border-left-color:#ef4444}
  .history-item.relationship_added{border-left-color:#8b5cf6}
  .history-item.relationship_removed{border-left-color:#f59e0b}
  .history-item.custom_field_updated{border-left-color:#06b6d4}

  /* Impact Tree */
  .impact-node{padding:8px 12px;margin:4px 0;background:var(--card);border:1px solid var(--border);border-radius:6px}
  .impact-node.level-0{border-left:3px solid var(--primary)}
  .impact-node.level-1{margin-left:20px;border-left:3px solid #ef4444}
  .impact-node.level-2{margin-left:40px;border-left:3px solid #f59e0b}
  .impact-node.level-3{margin-left:60px;border-left:3px solid #22c55e}

  /* Toggle Switch */
  .toggle-switch{position:relative;display:inline-block;width:60px;height:32px}
  .toggle-switch input{opacity:0;width:0;height:0}
  .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#e2e8f0;transition:.3s;border-radius:32px}
  .toggle-slider:before{position:absolute;content:"";height:24px;width:24px;left:4px;bottom:4px;background-color:white;transition:.3s;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
  .toggle-switch input:checked+.toggle-slider{background-color:#22c55e}
  .toggle-switch input:checked+.toggle-slider:before{transform:translateX(28px)}
  .toggle-switch input:focus+.toggle-slider{box-shadow:0 0 0 2px rgba(34,197,94,0.3)}
  .mt-16{margin-top:16px}
  .btn.success{background:#22c55e;color:#fff}

  /* Compact Filter Bar */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    padding: 8px 0;
    margin-bottom: 8px;
  }
  .filter-bar .filter-group {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }
  /* Compact inputs */
  .filter-compact {
    padding: 6px 10px !important;
    font-size: 13px !important;
    min-height: 32px;
    border-radius: 6px !important;
  }
  /* Search with icon */
  .filter-search {
    min-width: 180px;
    max-width: 220px;
    padding-left: 32px !important;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.3-4.3'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 8px center;
  }
  /* Compact selects */
  .filter-bar select {
    min-width: 110px;
    max-width: 150px;
  }
  /* Inline checkbox */
  .filter-checkbox {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--muted);
    white-space: nowrap;
    cursor: pointer;
  }
  .filter-checkbox input { margin: 0; }
  /* Clear button */
  .btn-clear {
    padding: 4px 8px;
    font-size: 11px;
    color: var(--muted);
    border: none;
    background: transparent;
    cursor: pointer;
  }
  .btn-clear:hover { color: var(--ink); text-decoration: underline; }
  /* Filter toggle - ONLY visible on mobile when filters are collapsed */
  .filter-toggle {
    display: none !important;
    padding: 4px 8px;
    font-size: 11px;
  }
  /* Collapsible section */
  .filter-collapsible { display: contents; }
  /* Mobile responsive filters */
  @media (max-width: 768px) {
    .filter-bar { flex-direction: column; align-items: stretch; gap: 8px; }
    .filter-bar .filter-toggle { display: flex !important; justify-content: center; }
    .filter-bar .filter-collapsible { display: none !important; flex-direction: column; gap: 8px; }
    .filter-bar.expanded .filter-collapsible { display: flex !important; }
    .filter-bar.expanded .filter-toggle { display: none !important; }
    .filter-search, .filter-bar select { width: 100%; max-width: none; min-width: auto; }
    .filter-bar .filter-group { flex-direction: column; width: 100%; }
  }

  /* Mobile Menu Toggle */
  .mobile-menu-toggle{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:8px;border-radius:6px;background:transparent;border:none}
  .mobile-menu-toggle span{width:20px;height:2px;background:var(--ink);border-radius:1px;transition:all .2s}
  .mobile-menu-toggle.active span:nth-child(1){transform:rotate(45deg) translate(4px,4px)}
  .mobile-menu-toggle.active span:nth-child(2){opacity:0}
  .mobile-menu-toggle.active span:nth-child(3){transform:rotate(-45deg) translate(4px,-4px)}

  /* Mobile Sidebar Overlay */
  .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:89}
  .sidebar-overlay.active{display:block}

  /* Responsive Tablet */
  @media (max-width:1024px){
    .container{padding:16px}
    .grid4{grid-template-columns:repeat(2,1fr)}
    .grid3{grid-template-columns:repeat(2,1fr)}
    .two-col{gap:16px}
    .leftnav{width:200px}
  }

  /* Responsive Mobile */
  @media (max-width:768px){
    body{padding-top:56px}

    /* Top Nav */
    .topnav{padding:0 12px}
    .topnav-inner{gap:8px}
    .topnav-brand span{display:none}
    .topnav-actions{display:none}
    .topnav-user{padding:4px 8px 4px 4px}
    .topnav-name{font-size:12px}
    .topnav-role{display:none}
    .mobile-menu-toggle{display:flex}

    /* Layout */
    .container{padding:12px}
    .two-col{grid-template-columns:1fr;gap:0}

    /* Sidebar */
    .leftnav{
      position:fixed;
      top:56px;
      left:0;
      bottom:0;
      width:260px;
      background:var(--card);
      border-right:1px solid var(--border);
      padding:16px;
      z-index:90;
      transform:translateX(-100%);
      transition:transform .25s ease;
      overflow-y:auto
    }
    .leftnav.open{transform:translateX(0)}

    /* Grids - force single column on mobile */
    .grid4,.grid3,.grid2{grid-template-columns:1fr !important}
    .grid4{gap:10px}
    .grid3{gap:10px}

    /* Override inline grid styles */
    [style*="grid-template-columns"]{grid-template-columns:1fr !important}
    [style*="display:grid"]{grid-template-columns:1fr !important}

    /* Cards */
    .card{border-radius:10px}
    .p-24{padding:16px}
    .p-20{padding:14px}
    .p-16{padding:12px}

    /* Typography */
    .title{font-size:18px}
    .subtitle{font-size:12px}

    /* Header rows - stack on mobile */
    .row.space{flex-wrap:wrap;gap:10px}
    .row.space.mb-20,.row.space.mb-16,.row.space.mb-12{flex-direction:column;align-items:stretch !important;gap:12px}
    .row.space .row{flex-wrap:wrap}

    /* Tables */
    table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
    th,td{white-space:nowrap;padding:10px 8px;font-size:12px}

    /* Buttons */
    .btn{padding:10px 14px;font-size:13px;min-height:44px}
    .row.wrap{gap:8px}
    .topnav-btn{padding:8px 10px;font-size:12px}

    /* Forms */
    .input,select,textarea{font-size:16px;padding:12px}

    /* Chat */
    #chat{right:12px;left:12px;width:auto;bottom:68px}
    #chat-toggle{right:12px;bottom:12px;padding:14px 18px}

    /* Modal */
    .modal .sheet{width:calc(100vw - 24px);max-height:90vh;overflow-y:auto}
    .modal .head{padding:14px 16px;font-size:14px}
    .modal .body{padding:16px}
    .modal .foot{padding:10px 16px;flex-wrap:wrap}
    .modal .foot .btn{flex:1;min-width:120px}

    /* Hide wizard nav on mobile */
    #wizard-nav{display:none}

    /* Dashboard stats */
    .stat-card{text-align:center}
    #ai-trends-panel .grid4{grid-template-columns:repeat(2,1fr)}

    /* All row layouts - stack on mobile */
    .row{flex-direction:column !important;align-items:stretch !important;gap:10px !important}
    .row .btn, .row a.btn{width:100% !important;min-width:100% !important;text-align:center;justify-content:center;min-height:48px;display:flex !important}
    .row .input, .row select{width:100% !important;min-width:100% !important}

    /* Exceptions - keep some rows horizontal */
    .topnav-inner, .topnav-inner .row{flex-direction:row !important;align-items:center !important}
    .row.space > .row:first-child{flex-direction:row !important;align-items:center !important;gap:8px !important}

    /* Ticket list items */
    tr td:first-child{max-width:120px;overflow:hidden;text-overflow:ellipsis}

    /* Badge */
    .badge{font-size:10px;padding:2px 6px}

    /* SLA Timer */
    .sla{font-size:11px;padding:4px 8px}

    /* Navigation links */
    .navlink{padding:3px 10px;font-size:13px;min-height:auto}
    .nav-subitem{padding:2px 10px;font-size:12px}

    /* Filter panel - collapsible */
    #ticket-filters-card .row.wrap{display:none !important}
    #ticket-filters-card.filters-expanded .row.wrap{display:flex !important;flex-direction:column !important}
    .mobile-filter-toggle{display:inline-flex !important}

    /* Chat bubble - larger */
    #chat-toggle{width:56px;height:56px;border-radius:50%;padding:0;font-size:20px;display:flex;align-items:center;justify-content:center}

    /* Dashboard - AI Insights first on mobile */
    #dash-admin{display:flex !important;flex-direction:column !important}
    #ai-trends-panel{order:-1 !important}

    /* Tables - hide less important columns */
    table th:nth-child(3), table td:nth-child(3), /* Location */
    table th:nth-child(4), table td:nth-child(4), /* Email */
    table th:nth-child(6), table td:nth-child(6)  /* Last Login */
    {display:none}

    /* Table cells - better mobile styling */
    table{width:100%;font-size:14px}
    th,td{padding:12px 8px;text-align:left}
    th{font-size:11px;text-transform:uppercase;letter-spacing:0.5px}

    /* Action buttons in tables */
    td .btn{padding:8px 12px;font-size:12px;min-height:36px}

    /* Mobile card alternative for lists */
    .mobile-card{display:none}
    .mobile-cards{display:flex;flex-direction:column;gap:12px}
    .mobile-cards .mobile-card{display:block;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .mobile-cards .mobile-card-header{font-weight:600;font-size:16px;margin-bottom:8px}
    .mobile-cards .mobile-card-meta{font-size:13px;color:var(--muted);margin-bottom:12px}
    .mobile-cards .mobile-card-actions{display:flex;gap:8px;flex-wrap:wrap}
    .mobile-cards .mobile-card-actions .btn{flex:1;min-width:80px}
  }

  /* Small Mobile */
  @media (max-width:480px){
    .topnav-avatar{width:24px;height:24px;font-size:10px}
    .logo-icon{width:28px;height:28px}
    .theme-toggle{width:32px;height:32px}
    .theme-toggle svg{width:16px;height:16px}

    .title{font-size:16px}
    .card .title{font-size:15px}

    #ai-trends-panel .grid4{grid-template-columns:1fr 1fr}
    #ai-trends-panel .card{padding:10px}
    #ai-trends-panel [style*="font-size:28px"]{font-size:22px!important}

    .modal .sheet{width:calc(100vw - 16px)}
    .modal .foot .btn{min-width:100%;flex:none}

    /* Login card */
    #scr-login .card{margin:20px 8px}
  }

  /* Touch-friendly targets */
  @media (max-width:768px){
    .navlink,.btn,.topnav-btn,.topnav-user,.theme-toggle{min-height:44px}
    a,button{-webkit-tap-highlight-color:transparent}
  }

  /* Safe area insets for notched devices */
  @supports (padding-top: env(safe-area-inset-top)){
    .topnav{padding-top:env(safe-area-inset-top);height:calc(56px + env(safe-area-inset-top))}
    body{padding-top:calc(56px + env(safe-area-inset-top))}
    .leftnav{top:calc(56px + env(safe-area-inset-top));padding-bottom:env(safe-area-inset-bottom)}
    #chat-toggle{bottom:calc(12px + env(safe-area-inset-bottom))}
    #chat{bottom:calc(68px + env(safe-area-inset-bottom))}
    .modal .foot{padding-bottom:calc(12px + env(safe-area-inset-bottom))}
    .container{padding-left:max(12px, env(safe-area-inset-left));padding-right:max(12px, env(safe-area-inset-right))}
  }

  /* Capacitor iOS Native Enhancements */
  @media (max-width:768px){
    /* Native-like scrolling - CRITICAL for mobile */
    html{
      height:100%;
    }
    body{
      min-height:100%;
      overflow-y:scroll;
      -webkit-overflow-scrolling:touch;
    }
    .container{
      padding-bottom:100px; /* Extra space for scrolling */
    }
    .leftnav,.modal .sheet,#chat .body{-webkit-overflow-scrolling:touch}

    /* Prevent text selection on interactive elements */
    .btn,.navlink,.topnav-user,.topnav-btn,.theme-toggle,.card[onclick]{-webkit-user-select:none;user-select:none}

    /* Native-like active states */
    .btn:active,.navlink:active,.topnav-btn:active{transform:scale(0.97);opacity:0.8}
    .card[onclick]:active{transform:scale(0.99);opacity:0.9}
    tr:active{background:var(--card-hover)}

    /* Smoother transitions */
    .btn,.navlink,.card,.topnav-btn{transition:transform 0.1s ease,opacity 0.1s ease,background 0.15s ease}

    /* iOS-style form focus */
    .input:focus,select:focus,textarea:focus{border-color:#007aff;box-shadow:0 0 0 3px rgba(0,122,255,0.15)}

    /* Prevent iOS bounce on fixed elements */
    .topnav,.modal{overscroll-behavior:contain}

    /* Better bottom sheet modals on mobile */
    .modal .sheet{border-radius:16px 16px 0 0;position:fixed;bottom:0;max-height:85vh;animation:slideUp 0.3s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

    /* iOS-style list separators */
    td{border-bottom:0.5px solid var(--border)}

    /* Larger touch targets for table rows */
    tr{min-height:52px}
    td{padding:14px 10px}

    /* Floating action button style */
    #chat-toggle{
      width:56px;height:56px;padding:0;
      border-radius:50%;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      display:flex;align-items:center;justify-content:center
    }

    /* Pull-to-refresh indicator space */
    .container{min-height:calc(100vh - 56px - env(safe-area-inset-top, 0px))}
  }

  /* iOS Dark Mode detection */
  @media (prefers-color-scheme:dark){
    :root{--ios-keyboard-bg:#1c1c1e}
  }

  /* Prevent iOS zoom on input focus */
  @media screen and (max-width:768px){
    input[type="text"],input[type="email"],input[type="password"],input[type="number"],input[type="tel"],select,textarea{font-size:16px!important}
  }

  /* Capacitor status bar area */
  .capacitor-ios .topnav{background:var(--topnav-bg)}
  html.theme-dark .capacitor-ios .topnav{background:var(--topnav-bg)}

  /* ========================================
     IONIC FRAMEWORK INTEGRATION
     ======================================== */

  /* Ionic CSS Variables - Light Mode */
  :root {
    --ion-color-primary: #1a1a1a;
    --ion-color-primary-rgb: 26,26,26;
    --ion-color-primary-contrast: #ffffff;
    --ion-color-primary-shade: #000000;
    --ion-color-primary-tint: #333333;

    --ion-color-secondary: #667eea;
    --ion-color-secondary-rgb: 102,126,234;
    --ion-color-secondary-contrast: #ffffff;

    --ion-color-success: #16a34a;
    --ion-color-warning: #ca8a04;
    --ion-color-danger: #dc2626;

    --ion-background-color: var(--bg, #fafafa);
    --ion-text-color: var(--ink, #1a1a1a);
    --ion-toolbar-background: var(--topnav-bg, #ffffff);
    --ion-item-background: var(--card, #ffffff);

    --ion-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  /* Ionic Dark Mode */
  html.theme-dark {
    --ion-background-color: var(--bg);
    --ion-text-color: var(--ink);
    --ion-toolbar-background: var(--topnav-bg);
    --ion-item-background: var(--card);
    --ion-card-background: var(--card);
  }

  /* Ionic Component Overrides */
  ion-app {
    --ion-safe-area-top: env(safe-area-inset-top);
    --ion-safe-area-bottom: env(safe-area-inset-bottom);
  }

  ion-content {
    --background: var(--bg, #fafafa);
  }

  ion-card {
    --background: var(--card, #ffffff);
    border-radius: var(--radius, 8px);
    box-shadow: var(--shadow-lg);
    margin: 12px;
  }

  ion-button {
    --border-radius: 10px;
    --padding-top: 12px;
    --padding-bottom: 12px;
    font-weight: 600;
    text-transform: none;
  }

  ion-item {
    --background: var(--card, #ffffff);
    --border-color: var(--border, #e5e5e5);
    --min-height: 52px;
  }

  ion-list {
    background: transparent;
  }

  ion-toolbar {
    --background: var(--topnav-bg, #ffffff);
    --color: var(--ink, #1a1a1a);
    --border-color: var(--border, #e5e5e5);
  }

  ion-menu {
    --background: var(--card, #ffffff);
    --width: 280px;
  }

  ion-menu ion-item {
    --padding-start: 16px;
    font-size: 15px;
  }

  /* Ionic FAB for chat */
  ion-fab {
    --background: var(--primary, #1a1a1a);
  }

  ion-fab-button {
    --background: var(--primary, #1a1a1a);
    --color: white;
  }

  /* Modal styling */
  ion-modal {
    --border-radius: 16px 16px 0 0;
  }

  ion-modal .modal-wrapper {
    bottom: 0;
    position: absolute;
  }

  /* Hide Ionic components on desktop, show on mobile */
  @media (min-width: 769px) {
    .ionic-mobile-only {
      display: none !important;
    }
  }

  @media (max-width: 768px) {
    .ionic-desktop-only {
      display: none !important;
    }

    /* Use Ionic navigation on mobile */
    ion-menu-button {
      display: block;
      --padding-start: 0;
      --padding-end: 0;
      min-height: 44px;
      min-width: 44px;
    }

    /* Style Ionic menu */
    ion-menu {
      --background: var(--card, #ffffff);
      --width: 280px;
    }

    ion-menu ion-header ion-toolbar {
      --background: var(--primary, #1a1a1a);
      --color: var(--bg, #ffffff);
    }

    ion-menu ion-content {
      --background: var(--card, #ffffff);
    }

    ion-menu ion-item {
      --background: transparent;
      --color: var(--ink, #1a1a1a);
      --padding-start: 16px;
      font-size: 15px;
    }

    ion-menu ion-item:hover {
      --background: var(--card-hover, #f5f5f5);
    }

    ion-menu ion-icon {
      color: var(--muted, #717171);
      font-size: 20px;
    }

    ion-menu ion-item-divider {
      --background: var(--bg, #fafafa);
      --color: var(--muted, #717171);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
  }

  /* Dark mode for Ionic menu */
  html.theme-dark ion-menu {
    --background: var(--card);
  }

  html.theme-dark ion-menu ion-content {
    --background: var(--card);
  }

  html.theme-dark ion-menu ion-item {
    --color: var(--ink);
  }

  html.theme-dark ion-menu ion-icon {
    color: var(--muted);
  }

  html.theme-dark ion-menu ion-item-divider {
    --background: var(--bg);
    --color: var(--muted);
  }

  /* Asset Viewer Styles */
  .av-container { display: flex; gap: 15px; height: calc(100vh - 200px); max-width: 100%; overflow: hidden; }
  .av-grid-panel { flex: 1; min-width: 0; background: var(--card); border-radius: 8px; box-shadow: var(--shadow); padding: 15px; overflow: auto; }
  .av-detail-panel { width: 380px; flex-shrink: 0; background: var(--card); border-radius: 8px; box-shadow: var(--shadow); padding: 0; overflow: auto; display: none; }
  .av-detail-panel.active { display: block; }

  #av-table { width: 100% !important; font-size: 12px; }
  #av-table thead th { white-space: nowrap; padding: 8px 6px; }
  #av-table tbody td { padding: 6px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  #av-table tbody tr { cursor: pointer; }
  #av-table tbody tr:hover { background-color: #e8f4f8 !important; }
  #av-table tbody tr.selected { background-color: var(--primary) !important; color: white; }
  #av-table tbody tr.selected td { color: white; }
  #av-table_wrapper { width: 100%; overflow-x: auto; }
  .dataTables_wrapper { font-size: 12px; }

  .av-detail-header { background: linear-gradient(135deg, var(--primary), #0056b3); color: white; padding: 15px 20px; font-size: 16px; font-weight: bold; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
  .av-detail-close { cursor: pointer; font-size: 24px; opacity: 0.8; line-height: 1; }
  .av-detail-close:hover { opacity: 1; }
  .av-section-header { background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 10px 15px; font-weight: bold; font-size: 13px; margin-top: 0; }
  .av-detail-content { padding: 0; }
  .av-detail-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .av-detail-table tr { border-bottom: 1px solid var(--border); }
  .av-detail-table tr:hover { background-color: var(--card-hover); }
  .av-detail-table td { padding: 8px 15px; vertical-align: top; }
  .av-detail-table td:first-child { font-weight: 500; color: var(--muted); width: 40%; background-color: var(--table-header); }
  .av-detail-table td:last-child { color: var(--ink); white-space: pre-wrap; word-break: break-word; }
  .av-loading { text-align: center; padding: 40px; color: var(--muted); }
  .av-comment-field { max-height: 150px; overflow-y: auto; background: var(--bg); padding: 10px; border-radius: 4px; font-family: inherit; white-space: pre-wrap; }

  .av-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .av-export-btn { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
  .av-export-btn:hover { background: linear-gradient(135deg, #1e7e34, #155724); }
  .av-export-btn:disabled { background: #ccc; cursor: not-allowed; }
  .av-export-info { font-size: 12px; color: var(--muted); margin-left: 12px; }

  @media (max-width: 1400px) {
    .av-detail-panel { width: 320px; }
  }
  @media (max-width: 1200px) {
    .av-container { flex-direction: column; height: auto; }
    .av-detail-panel { width: 100%; max-height: 500px; }
  }

  /* Asset Viewer Edit Mode Styles */
  .av-header-actions { display: flex; align-items: center; gap: 12px; }
  .av-edit-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
  .av-edit-btn:hover { background: rgba(255,255,255,0.3); }
  .av-edit-form { padding: 15px; }
  .av-form-group { margin-bottom: 12px; }
  .av-form-group label { display: block; font-size: 12px; font-weight: 500; color: var(--muted); margin-bottom: 4px; }
  .av-form-group input, .av-form-group select, .av-form-group textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--input-bg); color: var(--ink); box-sizing: border-box; }
  .av-form-group input:focus, .av-form-group select:focus, .av-form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0,123,255,0.1); }
  .av-form-group textarea { resize: vertical; min-height: 80px; }
  .av-form-actions { display: flex; gap: 10px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
  .av-save-btn { flex: 1; background: linear-gradient(135deg, #28a745, #1e7e34); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
  .av-save-btn:hover { background: linear-gradient(135deg, #1e7e34, #155724); }
  .av-save-btn:disabled { background: #ccc; cursor: not-allowed; }
  .av-cancel-btn { flex: 1; background: var(--card); color: var(--ink); border: 1px solid var(--border); padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
  .av-cancel-btn:hover { background: var(--card-hover); }

  /* Configuration Items List */
  .av-ci-list { padding: 0; }
  .av-ci-item { padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
  .av-ci-item:hover { background: var(--card-hover); }
  .av-ci-item:last-child { border-bottom: none; }
  .av-ci-name { font-weight: 500; color: var(--ink); margin-bottom: 4px; }
  .av-ci-meta { display: flex; gap: 8px; align-items: center; }
  .av-ci-type { font-size: 12px; color: var(--muted); }
  .av-ci-detail { padding: 15px; background: var(--bg); border-radius: 6px; margin: 10px 15px; }
  .av-ci-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .av-ci-detail-title { font-weight: 600; color: var(--ink); }
  .av-ci-back-btn { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 13px; padding: 4px 8px; }
  .av-ci-back-btn:hover { text-decoration: underline; }

  /* Global Search / Command Palette */
  .topnav-search-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card);
    cursor: pointer;
    transition: all 0.2s;
    margin-right: 8px;
    font-size: 13px;
    font-weight: 500;
    color: var(--muted);
  }
  .topnav-search-btn:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: var(--bg);
  }
  .topnav-search-btn svg {
    width: 16px;
    height: 16px;
    stroke: currentColor;
  }
  .topnav-search-btn .search-shortcut {
    font-size: 11px;
    padding: 2px 6px;
    background: var(--bg);
    border-radius: 4px;
    color: var(--muted);
  }
  .topnav-search-btn:hover .search-shortcut {
    background: rgba(255,255,255,0.2);
    color: var(--bg);
  }

  .global-search-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding: 10vh 16px 16px;
    backdrop-filter: blur(4px);
  }
  .global-search-modal.active {
    display: flex;
  }
  .global-search-container {
    width: 100%;
    max-width: 600px;
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    animation: searchSlideIn 0.15s ease-out;
  }
  @keyframes searchSlideIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  .global-search-header {
    display: flex;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--border);
    gap: 12px;
  }
  .global-search-header svg {
    width: 20px;
    height: 20px;
    stroke: var(--muted);
    flex-shrink: 0;
  }
  .global-search-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 16px;
    color: var(--ink);
    outline: none;
  }
  .global-search-input::placeholder {
    color: var(--muted);
  }
  .global-search-esc {
    font-size: 11px;
    color: var(--muted);
    background: var(--bg);
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid var(--border);
  }
  .global-search-tabs {
    display: flex;
    padding: 8px 16px;
    gap: 4px;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
  }
  .global-search-tab {
    padding: 6px 12px;
    font-size: 13px;
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap;
    color: var(--muted);
    background: transparent;
    border: none;
    transition: all 0.15s;
  }
  .global-search-tab:hover {
    background: var(--bg);
    color: var(--ink);
  }
  .global-search-tab.active {
    background: var(--primary);
    color: white;
  }
  .global-search-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 8px;
  }
  .global-search-empty {
    padding: 40px 20px;
    text-align: center;
    color: var(--muted);
  }
  .global-search-empty svg {
    width: 48px;
    height: 48px;
    stroke: var(--border);
    margin-bottom: 12px;
  }
  .global-search-group {
    margin-bottom: 8px;
  }
  .global-search-group-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--muted);
    padding: 8px 12px 4px;
  }
  .global-search-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    gap: 12px;
    transition: background 0.1s;
  }
  .global-search-item:hover,
  .global-search-item.selected {
    background: var(--bg);
  }
  .global-search-item.selected {
    outline: 2px solid var(--primary);
    outline-offset: -2px;
  }
  .global-search-item-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .global-search-item-icon svg {
    width: 18px;
    height: 18px;
    stroke: white;
  }
  .global-search-item-icon.ticket { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
  .global-search-item-icon.cmdb { background: linear-gradient(135deg, #10b981, #059669); }
  .global-search-item-icon.customer { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
  .global-search-item-icon.sla { background: linear-gradient(135deg, #f59e0b, #d97706); }
  .global-search-item-content {
    flex: 1;
    min-width: 0;
  }
  .global-search-item-title {
    font-weight: 500;
    color: var(--ink);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .global-search-item-meta {
    font-size: 12px;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .global-search-item-badge {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 4px;
    background: var(--bg);
    color: var(--muted);
    flex-shrink: 0;
  }
  .global-search-footer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    background: var(--bg);
    font-size: 12px;
    color: var(--muted);
  }
  .global-search-footer kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 5px;
    font-size: 11px;
    font-family: inherit;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin: 0 3px;
  }
  @media (max-width: 600px) {
    .global-search-modal { padding: 5vh 12px 12px; }
    .global-search-container { border-radius: 10px; }
    .global-search-footer { display: none; }
    .global-search-results { max-height: 50vh; }
  }
  /* Walkthrough overlay + tooltip */
  #wt-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1100;cursor:pointer;display:none}
  #wt-tooltip{position:fixed;z-index:1101;background:var(--bg);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.25);max-width:340px;width:90vw;display:none;animation:wtFadeIn .2s ease}
  @keyframes wtFadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .wt-head{padding:14px 16px 0;font-weight:700;font-size:15px;color:var(--ink)}
  .wt-body{padding:8px 16px 12px;font-size:13px;line-height:1.5;color:var(--muted)}
  .wt-foot{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-top:1px solid var(--border)}
  .wt-foot .wt-counter{font-size:11px;color:var(--muted)}
  .wt-foot .wt-btns{display:flex;gap:6px}
  .wt-foot .wt-btns button{padding:5px 12px;font-size:12px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--ink);cursor:pointer;font-weight:500}
  .wt-foot .wt-btns button.wt-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .wt-foot .wt-btns button:hover{opacity:.85}
</style>
</head>
<body>
<!-- Demo Mode Banner -->
<div id="demo-banner" style="display:none;background:#6366f1;color:white;text-align:center;padding:8px;font-size:13px;position:relative;z-index:10000">
  Demo Mode — Data resets nightly. <span id="demo-persona-label"></span>
</div>
<ion-app>

<!-- Ionic Side Menu for Mobile Navigation -->
<ion-menu content-id="main-content" type="overlay" class="ionic-mobile-only" id="ionic-side-menu">
  <ion-header>
    <ion-toolbar color="primary">
      <ion-title>ServiFlow</ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ion-list id="ionic-menu-list">
      <ion-item button onclick="ionicNav('dash'); closeIonicMenu();">
        <ion-icon name="home-outline" slot="start"></ion-icon>
        <ion-label>Dashboard</ion-label>
      </ion-item>
      <ion-item button onclick="ionicNav('tickets'); closeIonicMenu();">
        <ion-icon name="ticket-outline" slot="start"></ion-icon>
        <ion-label>Tickets</ion-label>
      </ion-item>
      <ion-item button onclick="ionicNav('experts'); closeIonicMenu();">
        <ion-icon name="people-outline" slot="start"></ion-icon>
        <ion-label>Manage Experts</ion-label>
      </ion-item>
      <ion-item button onclick="ionicNav('customers'); closeIonicMenu();">
        <ion-icon name="business-outline" slot="start"></ion-icon>
        <ion-label>Manage Customers</ion-label>
      </ion-item>
      <ion-item button onclick="toggleIonicCmdb()">
        <ion-icon name="server-outline" slot="start"></ion-icon>
        <ion-label>CMDB</ion-label>
        <ion-icon name="chevron-forward-outline" slot="end" id="ionic-cmdb-chev" style="font-size:14px;transition:transform .15s"></ion-icon>
      </ion-item>
      <div id="ionic-cmdb-subitems" style="display:none;padding-left:32px;background:var(--card-hover)">
        <ion-item button onclick="openCmdb('cmdb-section-items'); closeIonicMenu();">
          <ion-label style="font-size:14px">CMDB Items</ion-label>
        </ion-item>
        <ion-item button onclick="openCmdb('cmdb-section-types'); closeIonicMenu();">
          <ion-label style="font-size:14px">CMDB Types</ion-label>
        </ion-item>
        <ion-item button onclick="openCmdb('cmdb-section-management'); closeIonicMenu();">
          <ion-label style="font-size:14px">CMDB Management</ion-label>
        </ion-item>
        <ion-item button class="av-nav-item" onclick="openCmdb('cmdb-section-assetviewer'); closeIonicMenu();" style="display:none">
          <ion-label style="font-size:14px">Asset Viewer</ion-label>
        </ion-item>
      </div>
      <ion-item button onclick="ionicNav('knowledge-base'); closeIonicMenu();">
        <ion-icon name="book-outline" slot="start"></ion-icon>
        <ion-label>Knowledge Base</ion-label>
      </ion-item>
      <ion-item button onclick="ionicNav('ai-insights'); closeIonicMenu();">
        <ion-icon name="bulb-outline" slot="start"></ion-icon>
        <ion-label>AI Insights</ion-label>
      </ion-item>
      <ion-item button onclick="toggleIonicAdminSettings()">
        <ion-icon name="settings-outline" slot="start"></ion-icon>
        <ion-label>Admin Settings</ion-label>
        <ion-icon name="chevron-forward-outline" slot="end" id="ionic-admin-settings-chev" style="font-size:14px;transition:transform .15s"></ion-icon>
      </ion-item>
      <div id="ionic-admin-settings-subitems" style="display:none;padding-left:32px;background:var(--card-hover)">
        <ion-item button onclick="openAdminSettings('admin-section-support'); closeIonicMenu();">
          <ion-label style="font-size:14px">Support Settings</ion-label>
        </ion-item>
        <ion-item button onclick="openAdminSettings('admin-section-sla'); closeIonicMenu();">
          <ion-label style="font-size:14px">SLA Management</ion-label>
        </ion-item>
        <ion-item button onclick="openAdminSettings('admin-section-profile'); closeIonicMenu();">
          <ion-label style="font-size:14px">Company Profile</ion-label>
        </ion-item>
        <ion-item button onclick="openAdminSettings('admin-section-cmdb-fields'); closeIonicMenu();">
          <ion-label style="font-size:14px">CMDB Custom Fields</ion-label>
        </ion-item>
        <ion-item button onclick="openAdminSettings('admin-section-expert-reg'); closeIonicMenu();">
          <ion-label style="font-size:14px">Expert Registration</ion-label>
        </ion-item>
        <ion-item button onclick="openAdminSettings('admin-section-chat'); closeIonicMenu();">
          <ion-label style="font-size:14px">Chat Settings</ion-label>
        </ion-item>
        <ion-item button onclick="openAdminSettings('admin-section-reports'); closeIonicMenu();">
          <ion-label style="font-size:14px">Monthly Reports</ion-label>
        </ion-item>
        <ion-item button onclick="openAdminSettings('admin-section-billing'); closeIonicMenu();">
          <ion-label style="font-size:14px">Billing & Subscription</ion-label>
        </ion-item>
      </div>
      <div id="ionic-system-admin-tools" style="display:none">
        <ion-item-divider><ion-label>System Admin Tools</ion-label></ion-item-divider>
        <ion-item button onclick="openAdminSettings('admin-section-email-ingest'); closeIonicMenu();">
          <ion-icon name="mail-outline" slot="start"></ion-icon>
          <ion-label style="font-size:14px">Email Ingest</ion-label>
        </ion-item>
        <ion-item button onclick="openAdminSettings('admin-section-integrations'); closeIonicMenu();">
          <ion-icon name="link-outline" slot="start"></ion-icon>
          <ion-label style="font-size:14px">Integrations</ion-label>
        </ion-item>
        <ion-item button onclick="ionicNav('audit-log'); closeIonicMenu();">
          <ion-icon name="list-outline" slot="start"></ion-icon>
          <ion-label style="font-size:14px">Audit Log</ion-label>
        </ion-item>
        <ion-item button onclick="ionicNav('system-control'); closeIonicMenu();">
          <ion-icon name="construct-outline" slot="start"></ion-icon>
          <ion-label style="font-size:14px">System Control</ion-label>
        </ion-item>
        <ion-item button onclick="openAdminSettings('admin-section-housekeeping'); closeIonicMenu();">
          <ion-icon name="trash-outline" slot="start"></ion-icon>
          <ion-label style="font-size:14px">Housekeeping</ion-label>
        </ion-item>
        <ion-item button onclick="ionicNav('raw-variables'); closeIonicMenu();">
          <ion-icon name="code-outline" slot="start"></ion-icon>
          <ion-label style="font-size:14px">Raw Variables</ion-label>
        </ion-item>
      </div>
      <ion-item button onclick="ionicNav('raise'); closeIonicMenu();">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        <ion-label>Raise Request</ion-label>
      </ion-item>
    </ion-list>
    <ion-list>
      <ion-item-divider>
        <ion-label>Account</ion-label>
      </ion-item-divider>
      <ion-item button id="ionic-switch-role-btn" onclick="switchRole(); closeIonicMenu();">
        <ion-icon name="swap-horizontal-outline" slot="start"></ion-icon>
        <ion-label>Switch Role</ion-label>
      </ion-item>
      <ion-item button onclick="logout(); closeIonicMenu();">
        <ion-icon name="log-out-outline" slot="start"></ion-icon>
        <ion-label>Sign Out</ion-label>
      </ion-item>
    </ion-list>
  </ion-content>
</ion-menu>

<div id="main-content">
<!-- NoScript Warning for users without JavaScript -->
<noscript>
  <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:#fff;z-index:10000;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:40px;text-align:center">
    <div style="width:64px;height:64px;margin-bottom:20px;border-radius:12px;background:#003366;display:flex;align-items:center;justify-content:center">
      <span style="color:#fff;font-weight:600;font-size:24px">SF</span>
    </div>
    <h1 style="margin:0 0 12px;color:#1a1a1a;font-size:24px">JavaScript Required</h1>
    <p style="margin:0;color:#717171;font-size:16px;max-width:400px">ServiFlow requires JavaScript to be enabled. Please enable JavaScript in your browser settings and reload the page.</p>
  </div>
</noscript>
<!-- Modern Top Navigation -->
<nav class="topnav" id="topnav">
  <div class="topnav-inner">
    <div style="display:flex;align-items:center;gap:12px">
      <!-- Ionic menu button for mobile (hidden on login, shown by go()) -->
      <ion-menu-button class="ionic-mobile-only" id="ionic-menu-btn" style="--color:var(--ink);font-size:24px;display:none" onclick="openIonicMenu()"></ion-menu-button>
      <!-- Legacy hamburger for desktop sidebar toggle (hidden on login, shown by go()) -->
      <button class="mobile-menu-toggle ionic-desktop-only" id="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu" style="display:none">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <!-- Sidebar collapse toggle (desktop only) -->
      <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle sidebar (Ctrl+B)" style="display:none;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;align-items:center;justify-content:center;gap:6px;font-size:13px;font-weight:500;color:var(--muted)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <line x1="9" y1="3" x2="9" y2="21"/>
          <polyline points="14 9 11 12 14 15"/>
        </svg>
        <span class="sidebar-toggle-label">Menu</span>
      </button>
      <a href="#" class="topnav-brand" onclick="go('login'); return false;">
        <div class="logo-icon">
          <svg viewBox="0 0 100 100">
            <rect width="100" height="100" rx="16"/>
            <text x="50" y="66" text-anchor="middle" font-family="system-ui, sans-serif" font-size="44" font-weight="600">SF</text>
          </svg>
        </div>
        <span>ServiFlow</span>
      </a>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="theme-dropdown" id="theme-dropdown">
        <button class="theme-toggle" onclick="toggleThemeMenu(event)" title="Theme" id="theme-toggle-btn">
          <svg id="theme-icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <svg id="theme-icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>
        <div class="theme-menu">
          <div class="theme-menu-item" data-theme="light" onclick="selectTheme('light')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
            Light
          </div>
          <div class="theme-menu-item" data-theme="dark" onclick="selectTheme('dark')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            Dark
          </div>
          <div class="theme-menu-item" data-theme="system" onclick="selectTheme('system')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            System
          </div>
        </div>
      </div>
      <button class="topnav-search-btn" onclick="openGlobalSearch()" title="Search (Ctrl+K)" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
        Search
        <span class="search-shortcut">Ctrl+K</span>
      </button>
      <div class="topnav-right" id="topnav-right" style="display:none">
      <div class="topnav-user" onclick="go('login')">
        <div class="topnav-avatar" id="topnav-avatar">A</div>
        <div>
          <div class="topnav-name" id="topnav-username">Admin</div>
          <div class="topnav-role" id="topnav-role">Admin</div>
        </div>
      </div>
      <div id="topnav-impersonation" style="display:none;padding:4px 12px;border-radius:999px;background:#fef3c7;color:#92400e;font-size:11px;font-weight:500;border:1px solid #f59e0b;display:none;align-items:center;gap:6px;white-space:nowrap;">
        <span>👁️</span>
        <span id="topnav-impersonation-name">—</span>
        <button onclick="clearImpersonation()" style="background:none;border:none;cursor:pointer;color:#92400e;font-weight:bold;padding:0 2px;font-size:14px;line-height:1;" title="Exit impersonation">×</button>
      </div>
      <div id="elevation-badge" style="display:none;padding:4px 12px;border-radius:999px;background:#dcfce7;color:#166534;font-size:11px;font-weight:500;border:1px solid #22c55e;align-items:center;gap:4px;white-space:nowrap;margin-right:8px;cursor:default;" title="Elevated System Admin session active (30 min)">
        <span>System Admin</span>
      </div>
      <div id="mode-switcher" style="display:none;margin-right:8px;">
        <button onclick="showContextChooser()" style="padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--card-bg);color:var(--ink);font-size:12px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:4px;">
          <span id="mode-switcher-label">Admin</span>
          <span style="font-size:10px;opacity:.6">&#9662;</span>
        </button>
      </div>
      <div id="persona-switcher" style="display:none;margin-right:8px;">
        <select id="persona-select" onchange="switchPersona(this.value)" style="padding:4px 8px;border-radius:6px;border:1px solid #6366f1;background:#eef2ff;color:#4338ca;font-size:12px;font-weight:500;cursor:pointer;max-width:180px;">
          <option value="">Switch Persona...</option>
        </select>
      </div>
      <div class="topnav-actions">
        <div style="position:relative;display:inline-block;">
          <button id="wt-help-btn" class="topnav-btn ghost" onclick="toggleHelpMenu(event)" title="Help">? Help</button>
          <div id="help-menu" style="display:none;position:absolute;right:0;top:100%;margin-top:4px;background:var(--card-bg,#fff);border:1px solid var(--border,#e2e8f0);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);min-width:180px;z-index:9999;overflow:hidden;">
            <button onclick="helpMenuAction('tour')" style="display:flex;align-items:center;gap:8px;width:100%;padding:10px 14px;border:none;background:none;cursor:pointer;font-size:13px;color:var(--text,#1e293b);text-align:left;" onmouseenter="this.style.background='var(--hover-bg,#f1f5f9)'" onmouseleave="this.style.background='none'">
              <span style="font-size:15px;">&#x1F44B;</span> Welcome Tour
            </button>
            <button onclick="helpMenuAction('manual')" style="display:flex;align-items:center;gap:8px;width:100%;padding:10px 14px;border:none;background:none;cursor:pointer;font-size:13px;color:var(--text,#1e293b);text-align:left;" onmouseenter="this.style.background='var(--hover-bg,#f1f5f9)'" onmouseleave="this.style.background='none'">
              <span style="font-size:15px;">&#x1F4D6;</span> User Manual
            </button>
          </div>
        </div>
        <button class="topnav-btn ghost" id="topnav-switch-btn" onclick="switchRole()">Switch</button>
        <button class="topnav-btn ghost" onclick="logout()">Sign out</button>
      </div>
    </div>
    </div>
  </div>
</nav>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeMobileMenu()"></div>
<div id="err"></div>
<canvas id="wt-overlay" onclick="endWalkthrough()"></canvas>
<div id="wt-tooltip">
  <div class="wt-head" id="wt-title"></div>
  <div class="wt-body" id="wt-body"></div>
  <div class="wt-foot">
    <span class="wt-counter" id="wt-counter"></span>
    <div class="wt-btns">
      <button id="wt-back" onclick="wtBack()">Back</button>
      <button onclick="endWalkthrough()">Skip</button>
      <button id="wt-next" class="wt-primary" onclick="wtNext()">Next</button>
    </div>
  </div>
</div>
<div class="container">
  <div class="brandbar">
    <div class="logo-icon">
        <svg viewBox="0 0 100 100">
            <defs><linearGradient id="navGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#2563eb"/><stop offset="100%" style="stop-color:#8b5cf6"/></linearGradient></defs>
            <rect width="100" height="100" rx="20" fill="url(#navGrad)"/>
            <text x="50" y="68" text-anchor="middle" font-family="system-ui, sans-serif" font-size="48" font-weight="700" fill="white">SF</text>
            <circle cx="82" cy="24" r="8" fill="#10b981"/>
        </svg>
    </div>
    <div style="font-weight:800;color:#003366">ServiFlow • Support Platform</div>
  </div>

  <!-- LOGIN -->
  <section id="scr-login" class="screen active" style="display:block">
    <div class="card p-24" style="max-width:380px;margin:40px auto">
      <div style="text-align:center;margin-bottom:24px">
        <div style="width:48px;height:48px;margin:0 auto 14px;border-radius:12px;background:var(--logo-bg);display:flex;align-items:center;justify-content:center;transition:background .2s">
          <span style="color:var(--logo-text);font-weight:600;font-size:18px;transition:color .2s">SF</span>
        </div>
        <h1 class="title" style="margin-bottom:4px">Sign in</h1>
        <p class="subtitle" style="margin:0">Welcome back to ServiFlow</p>
      </div>

      <!-- Magic Link Login Form (shown on demo/magic-link-enabled hosts) -->
      <div id="magic-link-form" style="display:none">
        <div id="magic-link-request" >
          <div class="mb-16">
            <label for="magic-email" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;color:var(--ink)">Email address</label>
            <input type="email" id="magic-email" class="input" placeholder="you@company.com">
          </div>
          <div style="margin-bottom:16px">
            <button class="btn primary" onclick="requestMagicLink()" style="width:100%;padding:10px;font-size:14px">Email me a sign-in link</button>
          </div>
          <div style="text-align:center;margin-bottom:16px">
            <a href="#" onclick="toggleLoginMode('password'); return false;" style="color:var(--primary);text-decoration:none;font-size:13px">Or sign in with password</a>
          </div>
        </div>
        <div id="magic-link-sent" style="display:none;text-align:center;padding:16px 0;">
          <div style="width:48px;height:48px;margin:0 auto 12px;border-radius:50%;background:#ecfdf5;display:flex;align-items:center;justify-content:center;">
            <span style="font-size:24px;">&#x2709;</span>
          </div>
          <h3 style="margin:0 0 8px;color:var(--ink)">Check your inbox</h3>
          <p style="color:var(--muted);font-size:13px;margin:0 0 16px;">We sent a sign-in link to <strong id="magic-link-email-display"></strong> — check your email to sign in.</p>
          <a href="#" onclick="resetMagicLinkForm(); return false;" style="color:var(--primary);text-decoration:none;font-size:13px">Use a different email</a>
        </div>
      </div>

      <!-- Password Login Form (default) -->
      <div id="password-form">
      <div class="mb-16">
        <label for="username" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;color:var(--ink)">Username or Email</label>
        <input type="text" id="username" class="input" placeholder="Enter your username or email">
      </div>

      <div class="mb-16">
        <label for="password" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;color:var(--ink)">Password</label>
        <input type="password" id="password" class="input" placeholder="Enter your password">
      </div>

      <div class="mb-16">
        <label for="role" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;color:var(--ink)">Role</label>
        <select id="role" class="input" onchange="toggleTenantField()" style="cursor:pointer">
          <option value="admin">Admin</option>
          <option value="expert">Expert</option>
          <option value="customer">Customer</option>
          <option value="master_admin">Master Admin</option>
        </select>
      </div>

      <div class="mb-16" id="tenant-field">
        <label for="tenant" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;color:var(--ink)">Tenant Code</label>
        <input type="text" id="tenant" class="input" placeholder="Enter Tenant Code">
        </div>

      <div style="margin-bottom:16px">
        <button class="btn primary" onclick="login()" style="width:100%;padding:10px;font-size:14px">Sign in</button>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <a href="#" onclick="showForgotPassword(); return false;" style="color:var(--ink);text-decoration:none;font-size:12px;font-weight:500">Forgot password?</a>
        <a href="#" id="magic-link-toggle" onclick="toggleLoginMode('magic'); return false;" style="color:var(--muted);text-decoration:none;font-size:12px;display:none">Sign in with email link</a>
      </div>
      </div>

      <div id="login-error" style="display:none;color:#dc2626;background:#fef2f2;padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #fecaca;font-size:13px"></div>

      <div style="text-align:center;padding-top:14px;border-top:1px solid var(--border)">
        <span style="font-size:11px;color:var(--muted)">Enterprise-grade security</span>
      </div>
    </div>
  </section>

  <!-- Context Chooser Modal (role/company picker) -->
  <div id="context-chooser-modal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.5);align-items:center;justify-content:center;">
    <div class="card p-24" style="max-width:420px;width:90%;margin:auto;position:relative;">
      <div style="text-align:center;margin-bottom:20px;">
        <h2 style="margin:0 0 4px;color:var(--ink)">Choose your view</h2>
        <p style="color:var(--muted);font-size:13px;margin:0" id="context-chooser-subtitle">Select a role to continue</p>
      </div>
      <div id="context-role-picker" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:16px;"></div>
      <div id="context-company-picker" style="display:none;margin-bottom:16px;">
        <p style="font-weight:500;font-size:14px;margin:0 0 8px;color:var(--ink)">Select company</p>
        <div id="context-company-list" style="display:flex;flex-direction:column;gap:8px;"></div>
      </div>
    </div>
  </div>

  <!-- FORGOT PASSWORD -->
  <section id="scr-forgot-password" class="screen">
    <div class="card p-24" style="max-width:760px;margin:20px auto;">
      <h1 class="title">Forgot Password</h1>
      <p class="subtitle">Enter your email address and tenant code to receive a password reset link.</p>

      <div class="mb-16">
        <label for="forgot-tenant" style="display:block;margin-bottom:8px;font-weight:600;">Tenant Code:</label>
        <input type="text" id="forgot-tenant" class="input" placeholder="Enter Tenant Code">
      </div>

      <div class="mb-16">
        <label for="forgot-email" style="display:block;margin-bottom:8px;font-weight:600;">Email Address:</label>
        <input type="email" id="forgot-email" class="input" placeholder="Enter your email address">
      </div>

      <div class="row mb-12">
        <button class="btn primary" onclick="sendPasswordReset()">Send Reset Link</button>
        <button class="btn ghost" onclick="backToLogin()">Back to Login</button>
      </div>

      <div id="forgot-message" style="display:none;padding:12px;border-radius:8px;margin-top:12px;border:1px solid;"></div>
    </div>
  </section>

  <!-- APP - Hidden by default, shown after authentication -->
  <section id="scr-app" class="screen" style="display:none">
    <div class="row space mb-20 wrap" style="padding-bottom:16px;border-bottom:1px solid var(--border)">
      <div>
        <h2 class="title" id="app-title">Dashboard</h2>
        <div class="subtitle" id="app-subtitle">ServiFlow – role-based workspace</div>
      </div>
      <div class="row wrap" style="gap:8px">
        <span id="chip-role" style="display:none">admin</span>
        <div id="tenant-chip" style="display:none;padding:4px 12px;border-radius:999px;background:var(--primary);color:var(--bg);font-size:12px;font-weight:500">
          <span id="chip-tenant">—</span>
        </div>
      </div>
    </div>

    <div class="two-col">
      <!-- Left Nav -->
      <aside class="leftnav">
        <div id="nav-master" style="display:none">
          <div class="subtitle">Master Admin Navigation</div>
          <div class="navlink" data-target="dash" onclick="nav(this)">🏠 Master Dashboard</div>
          <div class="navlink" data-target="tenants" onclick="nav(this)">🏢 Tenant Management</div>
          <div class="navlink" data-target="subscriptions" onclick="nav(this)">💳 Subscriptions</div>
          <div class="navlink" data-target="billing" onclick="nav(this)">💰 Billing</div>
          <div class="navlink" data-target="plans" onclick="nav(this)">📋 Plan Management</div>
          <div class="navlink" data-target="currencies" onclick="nav(this)">💱 Currencies</div>
          <div class="navlink" data-target="system" onclick="nav(this)">⚙️ System Overview</div>
        </div>
        
        <div id="nav-admin">
          <div class="nav-group" id="nav-section-operations">
            <div class="subtitle" style="margin-top:4px;cursor:pointer" onclick="toggleNavGroup('nav-section-operations')">Operations <span class="chev">▸</span></div>
            <div class="nav-subitems">
              <div class="navlink" data-target="dash" onclick="nav(this)">🏠 Dashboard</div>
              <div class="navlink" data-target="tickets" onclick="nav(this)">🎫 Tickets</div>
              <div class="nav-group" id="nav-cmdb-group">
                <div class="navlink" onclick="toggleNavGroup('nav-cmdb-group')">🗃️ CMDB <span class="chev">▸</span></div>
                <div class="nav-subitems">
                  <div class="nav-subitem" data-section="cmdb-section-items" onclick="openCmdb('cmdb-section-items')">CMDB Items</div>
                  <div class="nav-subitem" data-section="cmdb-section-types" onclick="openCmdb('cmdb-section-types')">CMDB Types</div>
                  <div class="nav-subitem" data-section="cmdb-section-management" onclick="openCmdb('cmdb-section-management')">CMDB Management</div>
                  <div class="nav-subitem av-nav-item" data-section="cmdb-section-assetviewer" onclick="openCmdb('cmdb-section-assetviewer')" style="display:none">Asset Viewer</div>
                </div>
              </div>
              <div class="navlink" data-target="knowledge-base" onclick="nav(this)">📚 Knowledge Base</div>
              <div class="navlink" data-target="experts" onclick="nav(this)">👩‍🔧 Manage Experts</div>
              <div class="navlink" data-target="customers" onclick="nav(this)">🧑‍💼 Manage Customers</div>
              <div class="navlink" data-target="raise" onclick="nav(this)">📝 Raise Request</div>
              <div class="navlink" data-target="notifications" onclick="nav(this)">🔔 Notifications <span id="notif-badge-admin" style="display:none;background:#ef4444;color:white;padding:1px 6px;border-radius:10px;font-size:11px;margin-left:4px"></span></div>
            </div>
          </div>

          <div class="nav-group" id="nav-section-insights">
            <div class="subtitle" style="margin-top:4px;cursor:pointer" onclick="toggleNavGroup('nav-section-insights')">Insights <span class="chev">▸</span></div>
            <div class="nav-subitems">
              <div class="navlink" data-target="ai-insights" onclick="nav(this)">🤖 AI Insights</div>
              <div class="navlink" data-target="analytics" onclick="nav(this)">📈 Analytics</div>
              <div class="navlink" data-target="usage" onclick="nav(this)">📊 Usage & Limits</div>
            </div>
          </div>

          <div class="nav-group" id="nav-section-config">
            <div class="subtitle" style="margin-top:4px;cursor:pointer" onclick="toggleNavGroup('nav-section-config')">Config <span class="chev">▸</span></div>
            <div class="nav-subitems">
              <div class="navlink" data-target="ticket-rules" onclick="nav(this)">⚙️ Automated Actions</div>
              <div class="nav-group" id="nav-admin-settings-group">
                <div class="navlink" onclick="toggleNavGroup('nav-admin-settings-group')">🪄 Admin Settings <span class="chev">▸</span></div>
                <div class="nav-subitems">
                  <div class="nav-subitem" data-section="admin-section-support" onclick="openAdminSettings('admin-section-support')">🎫 Support Settings</div>
                  <div class="nav-subitem" data-section="admin-section-sla" onclick="openAdminSettings('admin-section-sla')">⏱️ SLA Management</div>
                  <div class="nav-subitem" data-section="admin-section-profile" onclick="openAdminSettings('admin-section-profile')">🏢 Company Profile</div>
                  <div class="nav-subitem" data-section="admin-section-cmdb-fields" onclick="openAdminSettings('admin-section-cmdb-fields')">🗃️ CMDB Custom Fields</div>
                  <div class="nav-subitem" data-section="admin-section-expert-reg" onclick="openAdminSettings('admin-section-expert-reg')">👤 Expert Registration</div>
                  <div class="nav-subitem" data-section="admin-section-chat" onclick="openAdminSettings('admin-section-chat')">💬 Chat Settings</div>
                  <div class="nav-subitem" data-section="admin-section-reports" onclick="openAdminSettings('admin-section-reports')">📊 Monthly Reports</div>
                  <div class="nav-subitem" data-section="admin-section-billing" onclick="openAdminSettings('admin-section-billing')">💳 Billing & Subscription</div>
                </div>
              </div>
            </div>
          </div>

          <div id="nav-system-admin-tools" style="display:none">
            <div class="nav-group" id="nav-system-tools-group">
              <div class="subtitle" style="margin-top:4px;cursor:pointer" onclick="openSystemAdminTools()">System Admin Tools <span class="chev">▸</span></div>
              <div class="nav-subitems">
                <div class="nav-subitem" data-section="admin-section-email-ingest" onclick="openAdminSettings('admin-section-email-ingest')">📧 Email Ingest</div>
                <div class="nav-subitem" data-section="admin-section-integrations" onclick="openAdminSettings('admin-section-integrations')">🔗 Integrations</div>
                <div class="nav-subitem" data-target="audit-log" onclick="nav(this)">📋 Audit Log</div>
                <div class="nav-subitem" data-target="system-control" onclick="nav(this)">🔧 System Control</div>
                <div class="nav-subitem" data-section="admin-section-housekeeping" onclick="openAdminSettings('admin-section-housekeeping')">🧹 Housekeeping</div>
                <div class="nav-subitem" data-target="raw-variables" onclick="nav(this)">⚙️ Raw Variables</div>
              </div>
            </div>
          </div>
        </div>
        <div id="nav-expert" style="display:none">
          <div class="subtitle">Expert Navigation</div>
          <div class="navlink" data-target="dash" onclick="nav(this)">🏠 My Dashboard</div>
          <div class="navlink" data-target="profile" onclick="nav(this)">👤 My Profile</div>
          <div class="navlink" data-target="tickets" onclick="nav(this)">🎫 Tickets</div>
          <div class="navlink" data-target="knowledge-base" onclick="nav(this)">📚 Knowledge Base</div>
          <div class="nav-group" id="nav-cmdb-group-expert">
            <div class="navlink" onclick="toggleNavGroup('nav-cmdb-group-expert')">🗃️ CMDB <span class="chev">▸</span></div>
            <div class="nav-subitems">
              <div class="nav-subitem" data-section="cmdb-section-items" onclick="openCmdb('cmdb-section-items')">CMDB Items</div>
              <div class="nav-subitem" data-section="cmdb-section-types" onclick="openCmdb('cmdb-section-types')">CMDB Types</div>
              <div class="nav-subitem" data-section="cmdb-section-management" onclick="openCmdb('cmdb-section-management')">CMDB Management</div>
              <div class="nav-subitem av-nav-item" data-section="cmdb-section-assetviewer" onclick="openCmdb('cmdb-section-assetviewer')" style="display:none">👁️ Asset Viewer</div>
            </div>
          </div>
          <div class="navlink" data-target="analytics" onclick="nav(this)">📈 Analytics</div>
          <div class="navlink" data-target="ai-insights" onclick="nav(this)">🤖 AI Insights</div>
          <div class="navlink" data-target="raise" onclick="nav(this)">📝 Raise Request</div>
          <div class="navlink" data-target="notifications" onclick="nav(this)">🔔 Notifications <span id="notif-badge-expert" style="display:none;background:#ef4444;color:white;padding:1px 6px;border-radius:10px;font-size:11px;margin-left:4px"></span></div>
        </div>
        <div id="nav-customer" style="display:none">
          <div style="padding:12px 12px 8px;margin-bottom:4px">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent">My Portal</div>
          </div>
          <div class="navlink" data-target="dash" onclick="nav(this)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Home</div>
          <div class="navlink" data-target="raise" onclick="nav(this)" style="background:linear-gradient(135deg,rgba(99,102,241,.08),rgba(139,92,246,.06));font-weight:600;color:#667eea"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg> New Request</div>
          <div style="height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:8px 12px"></div>
          <div class="navlink" data-target="profile" onclick="nav(this)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> My Profile</div>
          <div class="navlink" data-target="my-company" onclick="nav(this)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg> My Company</div>
          <div class="navlink" id="nav-company-admin" data-target="company-admin" onclick="nav(this)" style="display:none"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg> Team Admin</div>
          <div class="navlink" id="nav-company-reports" data-target="company-reports" onclick="nav(this)" style="display:none"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg> Monthly Reports</div>
          <div class="navlink" data-target="usage" onclick="nav(this)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg> Usage</div>
          <div class="navlink" id="nav-customer-billing" data-target="customer-billing" onclick="nav(this)" style="display:none"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg> Billing</div>
          <div class="navlink" id="nav-customer-plans" data-target="customer-plans" onclick="nav(this)" style="display:none"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> Plans</div>
          <div class="nav-group" id="nav-cmdb-group-customer">
            <div class="navlink" onclick="toggleNavGroup('nav-cmdb-group-customer')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg> My Equipment <span class="chev">▸</span></div>
            <div class="nav-subitems">
              <div class="nav-subitem" data-section="cmdb-section-items" onclick="openCmdb('cmdb-section-items')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg> Asset List</div>
              <div class="nav-subitem" data-section="cmdb-section-types" onclick="openCmdb('cmdb-section-types')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg> Categories</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main>
        <!-- ---- Role Dashboards ---- -->
        <div id="view-dash">
          <!-- Master Admin -->
          <div id="dash-master" class="card p-16 mb-16" style="display:none">
            <h3 class="title">Master Admin Dashboard</h3>
            <div class="subtitle">System-wide management & tenant oversight</div>
            <div class="grid3 mb-16">
              <div class="card p-16"><div class="subtitle">Total Tenants</div><div id="ma-tenants" style="font-size:28px;font-weight:800">0</div></div>
              <div class="card p-16"><div class="subtitle">Active Tenants</div><div id="ma-active" style="font-size:28px;font-weight:800">0</div></div>
              <div class="card p-16"><div class="subtitle">System Health</div><div id="ma-health" style="font-size:28px;font-weight:800">100%</div></div>
            </div>
            <div class="card p-16">
              <h4>Recent Tenant Activity</h4>
              <div id="ma-activity" class="subtitle">Loading tenant activity...</div>
            </div>
          </div>
          
          <!-- Admin -->
          <div id="dash-admin" class="card p-16 mb-16">
            <h3 class="title">Admin Dashboard</h3>
            <div class="subtitle">Health & governance at a glance</div>

            <!-- Quick Admin Section (First) -->
            <div class="card p-12 mb-16" style="background:var(--table-header)">
              <div class="row space">
                <strong>Quick Admin</strong>
                <span class="subtitle">Common tasks</span>
              </div>
              <div class="row wrap" style="margin-top:12px;gap:8px">
                <button class="btn primary" onclick="navTo('experts')">Manage Experts</button>
                <button class="btn primary" onclick="navTo('customers')">Manage Customers</button>
                <button class="btn primary" onclick="openCmdb('cmdb-section-assetviewer')">Open CMDB</button>
                <button class="btn" onclick="navTo('tickets')">View All Tickets</button>
                <button class="btn" onclick="navTo('wizard')">Admin Settings</button>
                <button class="btn" onclick="openGlobalSearch()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;margin-right:6px;vertical-align:middle">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                  </svg>Power Search
                </button>
              </div>
            </div>

            <!-- Compact Stats Row -->
            <div class="grid4 mb-16" style="gap:12px">
              <div class="card p-12 stat-card" onclick="viewOpenTickets()" style="cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                <div class="subtitle" style="font-size:11px">Open Tickets</div>
                <div id="ad-open" style="font-size:24px;font-weight:800">0</div>
              </div>
              <div class="card p-12 stat-card" onclick="viewSLAAtRisk()" style="cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                <div class="subtitle" style="font-size:11px">SLA at Risk</div>
                <div id="ad-sla-risk" style="font-size:24px;font-weight:800;color:var(--danger)">0</div>
              </div>
              <div class="card p-12 stat-card" onclick="viewCMDBItems()" style="cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                <div class="subtitle" style="font-size:11px">CMDB Items</div>
                <div id="ad-items" style="font-size:24px;font-weight:800;color:var(--ok)">0</div>
              </div>
              <div class="card p-12">
                <div class="subtitle" style="font-size:11px">Resolved Today</div>
                <div id="ad-resolved-today" style="font-size:24px;font-weight:800;color:#667eea">0</div>
              </div>
            </div>

            <!-- AI Insights & Trends (Second) -->
            <div id="ai-trends-panel" class="card p-16 mb-16" style="background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);color:white;border:none;">
              <div class="row space">
                <div class="row" style="gap:12px;align-items:center">
                  <span style="font-size:24px">AI</span>
                  <div>
                    <strong style="font-size:16px">AI Insights & Trends</strong>
                    <div style="font-size:12px;opacity:0.7">Powered by Claude AI - analyzing ticket patterns</div>
                  </div>
                </div>
                <div class="row" style="gap:8px">
                  <select id="ai-trends-period" class="input" onchange="loadAITrends()" style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);min-width:120px">
                    <option value="24">Last 24 hours</option>
                    <option value="72">Last 3 days</option>
                    <option value="168" selected>Last 7 days</option>
                    <option value="720">Last 30 days</option>
                  </select>
                  <button class="btn" onclick="loadAITrends()" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.2)">Refresh</button>
                </div>
              </div>

              <!-- Loading State -->
              <div id="ai-trends-loading" style="text-align:center;padding:40px;display:none">
                <div style="font-size:14px;opacity:0.7">Analyzing ticket patterns...</div>
              </div>

              <!-- Summary Stats -->
              <div id="ai-trends-content" style="margin-top:20px">
                <div class="grid4" style="gap:12px;margin-bottom:20px">
                  <div class="card p-12" onclick="viewAllTrendTickets()" style="background:rgba(255,255,255,0.1);border:none;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                    <div style="font-size:11px;opacity:0.7;text-transform:uppercase">Active Trends</div>
                    <div id="ai-trends-count" style="font-size:28px;font-weight:800">0</div>
                    <div id="ai-trends-tickets" style="font-size:10px;opacity:0.5;margin-top:4px">0 tickets affected</div>
                  </div>
                  <div class="card p-12" onclick="viewTrendTicketsBySeverity('critical')" style="background:rgba(255,99,71,0.2);border:none;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                    <div style="font-size:11px;opacity:0.7;text-transform:uppercase">Critical Tickets</div>
                    <div id="ai-critical-count" style="font-size:28px;font-weight:800;color:#ff6b6b">0</div>
                    <div style="font-size:10px;opacity:0.5;margin-top:4px">Click to view</div>
                  </div>
                  <div class="card p-12" onclick="viewTrendTicketsBySeverity('warning')" style="background:rgba(255,193,7,0.2);border:none;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                    <div style="font-size:11px;opacity:0.7;text-transform:uppercase">Warning Tickets</div>
                    <div id="ai-warning-count" style="font-size:28px;font-weight:800;color:#ffc107">0</div>
                    <div style="font-size:10px;opacity:0.5;margin-top:4px">Click to view</div>
                  </div>
                  <div class="card p-12" onclick="navTo('tickets')" style="background:rgba(72,187,120,0.2);border:none;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                    <div style="font-size:11px;opacity:0.7;text-transform:uppercase">Tickets Analyzed</div>
                    <div id="ai-analyzed-count" style="font-size:28px;font-weight:800;color:#48bb78">0</div>
                    <div style="font-size:10px;opacity:0.5;margin-top:4px">View all tickets</div>
                  </div>
                </div>

                <!-- Trending Issues List -->
                <div id="ai-trends-list" style="display:flex;flex-direction:column;gap:12px">
                  <div style="text-align:center;padding:30px;opacity:0.6">
                    <div style="font-size:14px">Click "Refresh" to analyze recent tickets and detect trends</div>
                  </div>
                </div>

                <!-- Category Breakdown -->
                <div id="ai-category-breakdown" style="margin-top:20px;display:none">
                  <div style="font-weight:600;margin-bottom:12px">Issue Categories</div>
                  <div id="ai-categories" class="row wrap" style="gap:8px"></div>
                </div>
              </div>
            </div>

            <!-- Feedback Scoreboard -->
            <div class="card p-16 mb-16">
              <div class="row space"><strong>Customer Satisfaction Feedback</strong><button class="btn ghost" onclick="loadFeedbackScoreboard()">🔄 Refresh</button></div>
              <div class="grid3 mb-16">
                <div class="card p-16">
                  <div class="subtitle">Average Rating</div>
                  <div id="feedback-avg-rating" style="font-size:28px;font-weight:800">-</div>
                  <div id="feedback-avg-stars" style="font-size:20px;margin-top:4px"></div>
                </div>
                <div class="card p-16">
                  <div class="subtitle">Total Feedback</div>
                  <div id="feedback-total-count" style="font-size:28px;font-weight:800">0</div>
                </div>
                <div class="card p-16">
                  <div class="subtitle">Rating Distribution</div>
                  <div id="feedback-distribution" style="font-size:14px;margin-top:8px">
                    <div class="row space"><span>5⭐</span><span id="feedback-5star">0</span></div>
                    <div class="row space"><span>4⭐</span><span id="feedback-4star">0</span></div>
                    <div class="row space"><span>3⭐</span><span id="feedback-3star">0</span></div>
                    <div class="row space"><span>2⭐</span><span id="feedback-2star">0</span></div>
                    <div class="row space"><span>1⭐</span><span id="feedback-1star">0</span></div>
                  </div>
                </div>
              </div>
              <div class="card p-16">
                <strong>Recent Feedback</strong>
                <table><thead><tr><th>Ticket</th><th>Rating</th><th>Resolved By</th><th>Comment</th><th>Date</th></tr></thead><tbody id="feedback-recent"></tbody></table>
              </div>
            </div>
          </div>

          <!-- Expert -->
          <div id="dash-expert" class="card p-16 mb-16" style="display:none">
            <div class="row space mb-12">
              <div>
                <h3 class="title" style="margin:0">Expert Dashboard</h3>
                <div class="subtitle">Your queue & SLA focus</div>
              </div>
              <div class="row" style="gap:8px">
                <button class="btn" onclick="navTo('tickets')" style="gap:6px">📥 Open Queue</button>
                <button class="btn" onclick="navTo('cmdb')" style="gap:6px">🔍 Search CMDB</button>
                <button class="btn" onclick="navTo('knowledge-base')" style="gap:6px">📚 Knowledge Base</button>
                <button class="btn primary" onclick="navTo('raise')" style="gap:6px">➕ Log Request</button>
              </div>
            </div>

            <!-- Power Search Bar -->
            <div class="card p-12 mb-16" style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
              <div class="row" style="gap:12px">
                <input id="expert-power-search" class="input" style="flex:1;border:2px solid #0ea5e9" placeholder="🔍 Power Search - tickets, assets, knowledge base..." onkeyup="if(event.key==='Enter')expertPowerSearch()">
                <button class="btn primary" onclick="expertPowerSearch()" style="background:#0ea5e9">Search</button>
              </div>
              <div id="expert-search-results" style="display:none;margin-top:12px"></div>
            </div>

            <!-- Stats Row -->
            <div class="grid3 mb-16">
              <div id="stat-card-open" class="card p-16 clickable stat-card-active" onclick="filterExpertTickets('open')" style="cursor:pointer;transition:all 0.15s;box-shadow:0 0 0 2px #2563eb">
                <div class="subtitle">My open</div>
                <div id="ex-open" style="font-size:28px;font-weight:800;color:#2563eb">0</div>
              </div>
              <div id="stat-card-today" class="card p-16 clickable" onclick="filterExpertTickets('today')" style="cursor:pointer;transition:all 0.15s">
                <div class="subtitle">Due today</div>
                <div id="ex-today" style="font-size:28px;font-weight:800;color:#d97706">0</div>
              </div>
              <div id="stat-card-risk" class="card p-16 clickable" onclick="filterExpertTickets('risk')" style="cursor:pointer;transition:all 0.15s">
                <div class="subtitle">SLA at risk</div>
                <div id="ex-risk" style="font-size:28px;font-weight:800;color:#dc2626">0</div>
              </div>
            </div>

            <!-- Main Content: Left Tickets Panel + Right Panels -->
            <div style="display:flex;gap:16px;align-items:flex-start">
              <!-- Left: Tickets Panel with Pool/My Tickets Tabs -->
              <div class="card p-16" style="flex:1;min-width:0">
                <!-- Tab Switcher -->
                <div class="row space mb-12">
                  <div class="row" style="gap:4px;background:var(--badge-bg);padding:4px;border-radius:8px">
                    <button id="pool-tab-btn" class="btn" onclick="switchExpertView('pool')" style="padding:8px 16px;font-size:13px;border-radius:6px">🎯 Requests</button>
                    <button id="my-tickets-tab-btn" class="btn primary" onclick="switchExpertView('my')" style="padding:8px 16px;font-size:13px;border-radius:6px">📋 My Tickets</button>
                  </div>
                  <div class="row" style="gap:8px">
                    <select id="ex-ticket-filter" class="input" style="width:140px;padding:4px 8px;font-size:12px" onchange="syncStatCardHighlight(); renderExpertDash()">
                      <option value="all">All Mine</option>
                      <option value="claimed">Claimed</option>
                      <option value="today">Due Today</option>
                      <option value="risk">SLA Risk</option>
                    </select>
                    <button class="btn ghost" onclick="navTo('tickets')" style="font-size:12px">View all →</button>
                  </div>
                </div>

                <!-- Pool View (Hidden by default) -->
                <div id="expert-pool-view" style="display:none">
                  <div class="row space mb-8">
                    <span style="font-size:13px;color:var(--muted)">AI-ranked tickets available for claim</span>
                    <button class="btn ghost" onclick="refreshPoolView()" style="font-size:12px">↻ Refresh</button>
                  </div>
                  <!-- Pool Filters -->
                  <div id="pool-filters" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;padding:8px;background:var(--badge-bg);border-radius:8px">
                    <select id="pool-filter-work-type" onchange="applyPoolFilters()" style="padding:4px 8px;font-size:12px;border-radius:4px;border:1px solid var(--border)">
                      <option value="">All Types</option>
                      <option value="incident">Incident</option>
                      <option value="request">Request</option>
                      <option value="problem">Problem</option>
                      <option value="change_request">Change Request</option>
                      <option value="operational_action">Operational</option>
                      <option value="question">Question</option>
                      <option value="feedback">Feedback</option>
                      <option value="unknown">Unknown</option>
                    </select>
                    <select id="pool-filter-exec-mode" onchange="applyPoolFilters()" style="padding:4px 8px;font-size:12px;border-radius:4px;border:1px solid var(--border)">
                      <option value="">All Modes</option>
                      <option value="escalation_required">Escalation Required</option>
                      <option value="expert_required">Expert Required</option>
                      <option value="human_review">Human Review</option>
                      <option value="mixed">Mixed</option>
                      <option value="automated">Automated</option>
                    </select>
                    <div style="display:flex;align-items:center;gap:4px">
                      <input type="text" id="pool-filter-tag" placeholder="Tag..." style="width:80px;padding:4px 8px;font-size:12px;border-radius:4px;border:1px solid var(--border)" onkeypress="if(event.key==='Enter'){addPoolTagFilter();event.preventDefault()}">
                      <div id="pool-tag-chips" style="display:flex;gap:4px;flex-wrap:wrap"></div>
                    </div>
                    <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer">
                      <input type="checkbox" id="pool-filter-needs-triage" onchange="applyPoolFilters()">
                      <span>Needs Triage</span>
                    </label>
                    <button class="btn ghost" onclick="clearPoolFilters()" style="font-size:11px;padding:2px 8px">Clear</button>
                  </div>
                  <div style="max-height:400px;overflow-y:auto">
                    <table style="font-size:13px"><thead><tr><th style="cursor:pointer" onclick="sortPoolBy('score')">Score ⇅</th><th style="cursor:pointer" onclick="sortPoolBy('id')">ID ⇅</th><th style="cursor:pointer" onclick="sortPoolBy('title')">Title ⇅</th><th style="cursor:pointer" onclick="sortPoolBy('customer')">Customer ⇅</th><th style="cursor:pointer" onclick="sortPoolBy('sla')">SLA ⇅</th><th>Action</th></tr></thead><tbody id="pool-list"></tbody></table>
                  </div>
                  <!-- Pool Pagination Controls -->
                  <div id="pool-pagination" style="display:none;margin-top:12px;padding:8px;background:var(--badge-bg);border-radius:8px;display:flex;justify-content:space-between;align-items:center">
                    <span id="pool-pagination-info" style="font-size:12px;color:var(--muted)">Page 1 of 1</span>
                    <div style="display:flex;gap:8px">
                      <button id="pool-prev-btn" class="btn ghost" onclick="poolPrevPage()" style="font-size:12px;padding:4px 12px" disabled>← Prev</button>
                      <button id="pool-next-btn" class="btn ghost" onclick="poolNextPage()" style="font-size:12px;padding:4px 12px" disabled>Next →</button>
                    </div>
                  </div>
                  <div id="pool-no-tickets" style="display:none;text-align:center;padding:40px;color:var(--muted)">
                    <div style="font-size:32px;margin-bottom:8px">📭</div>
                    <div id="pool-no-tickets-message">No tickets in pool</div>
                    <div style="font-size:12px;margin-top:8px">Try clearing filters or check back later</div>
                  </div>
                </div>

                <!-- My Tickets View (Shown by default) -->
                <div id="expert-my-view">
                  <div style="max-height:400px;overflow-y:auto">
                    <table style="font-size:13px"><thead><tr><th style="cursor:pointer" onclick="sortMyTicketsBy('id')">ID ⇅</th><th style="cursor:pointer" onclick="sortMyTicketsBy('title')">Title ⇅</th><th style="cursor:pointer" onclick="sortMyTicketsBy('date')">Date/Time ⇅</th><th style="cursor:pointer" onclick="sortMyTicketsBy('status')">Status ⇅</th><th style="cursor:pointer" onclick="sortMyTicketsBy('sla')">SLA ⇅</th></tr></thead><tbody id="ex-list"></tbody></table>
                  </div>
                  <div id="ex-no-tickets" style="display:none;text-align:center;padding:40px;color:var(--muted)">
                    <div style="font-size:32px;margin-bottom:8px">✅</div>
                    <div>No tickets in queue</div>
                  </div>
                </div>
              </div>

              <!-- Right: Stacked Panels -->
              <div style="width:380px;flex-shrink:0;display:flex;flex-direction:column;gap:16px">
                <!-- AI Insights Panel -->
                <div class="card p-16" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white">
                  <div class="row space mb-12">
                    <strong style="display:flex;align-items:center;gap:6px">🤖 AI Insights</strong>
                    <button class="btn ghost" onclick="refreshExpertAIInsights()" style="color:white;border-color:rgba(255,255,255,0.3);padding:4px 8px;font-size:11px">Refresh</button>
                  </div>
                  <div id="ex-ai-insights">
                    <div id="ex-ai-loading" style="text-align:center;padding:12px;font-size:13px">Analyzing your queue...</div>
                    <div id="ex-ai-content" style="display:none;font-size:13px">
                      <div id="ex-ai-summary" style="margin-bottom:12px;line-height:1.5"></div>
                      <div id="ex-ai-suggestions"></div>
                    </div>
                  </div>
                </div>

                <!-- Asset Viewer Mini -->
                <div class="card p-16">
                  <div class="row space mb-12">
                    <strong style="display:flex;align-items:center;gap:6px">🖥️ Recent Assets</strong>
                    <button class="btn ghost" onclick="navTo('cmdb')" style="font-size:12px">View all →</button>
                  </div>
                  <div id="ex-assets-list" style="max-height:150px;overflow-y:auto;font-size:13px">
                    <div style="color:var(--muted);text-align:center;padding:20px">Loading assets...</div>
                  </div>
                </div>

                <!-- Live Chat Panel -->
                <div class="expert-chat-panel">
                  <div class="ech-header">
                    <span>💬 Live Chat <span id="ech-waiting-count" style="background:#dc2626;color:#fff;border-radius:10px;padding:1px 7px;font-size:11px;font-weight:700;display:none">0</span></span>
                    <div style="display:flex;gap:4px">
                      <button class="btn ghost" onclick="refreshExpertChatList()" style="font-size:11px;padding:2px 6px">↻</button>
                    </div>
                  </div>
                  <div id="ech-tabs" style="display:flex;border-bottom:1px solid var(--border)">
                    <button class="btn ghost" id="ech-tab-waiting" onclick="switchExpertChatTab('waiting')" style="flex:1;border-radius:0;font-size:12px;padding:6px;border-bottom:2px solid var(--primary)">Waiting</button>
                    <button class="btn ghost" id="ech-tab-active" onclick="switchExpertChatTab('active')" style="flex:1;border-radius:0;font-size:12px;padding:6px">My Active</button>
                    <button class="btn ghost" id="ech-tab-history" onclick="switchExpertChatTab('history')" style="flex:1;border-radius:0;font-size:12px;padding:6px">History</button>
                  </div>
                  <div id="ech-list" class="ech-list">
                    <div class="ech-empty">No chat sessions</div>
                  </div>
                </div>

                <!-- Expert Chat Window (hidden until a chat is selected) -->
                <div id="ech-window" class="expert-chat-window" style="display:none">
                  <div class="ecw-header">
                    <div>
                      <span id="ech-window-name">Chat</span>
                      <span id="ech-window-status" style="font-size:11px;opacity:.7;margin-left:6px"></span>
                    </div>
                    <div style="display:flex;gap:4px">
                      <button class="btn ghost" onclick="expertChatCreateTicket()" style="padding:2px 8px;font-size:11px;color:#fff;border-color:rgba(255,255,255,.3)">🎫 Ticket</button>
                      <button class="btn ghost" onclick="expertChatTransfer()" style="padding:2px 8px;font-size:11px;color:#fff;border-color:rgba(255,255,255,.3)">↗ Transfer</button>
                      <button class="btn ghost" onclick="expertChatClose()" style="padding:2px 8px;font-size:11px;color:#fff;border-color:rgba(255,255,255,.3)">✕ End</button>
                    </div>
                  </div>
                  <div id="ech-messages" class="ecw-messages"></div>
                  <div id="ech-canned" style="padding:4px 8px;display:flex;gap:4px;overflow-x:auto;border-top:1px solid var(--border);background:var(--table-header)"></div>
                  <div id="ech-typing" style="padding:2px 8px;font-size:11px;color:var(--muted);min-height:14px"></div>
                  <div class="ecw-footer">
                    <label style="cursor:pointer;font-size:16px;padding:2px" title="Attach file">📎<input type="file" id="ech-file-input" style="display:none" onchange="expertChatUploadFile(this)"></label>
                    <input id="ech-msg-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')expertChatSend()">
                    <button class="btn primary" style="padding:4px 10px;font-size:12px" onclick="expertChatSend()">Send</button>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- Customer -->
          <div id="dash-customer" style="display:none">
            <div id="cu-open" style="display:none">0</div>
            <div id="cu-items" style="display:none">0</div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start">
              <!-- Left: My Requests list -->
              <div style="border-radius:14px;padding:16px;background:var(--card);border:1px solid var(--border);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)">
                <div class="row space" style="margin-bottom:8px">
                  <strong style="font-size:14px">My Requests</strong>
                  <div class="row" style="gap:8px;align-items:center">
                    <div id="cu-system-toggle" style="display:none;gap:0;border-radius:6px;overflow:hidden;border:1px solid var(--border)">
                      <button id="cu-req-mode-requests" onclick="setCuReqMode('requests')" style="padding:3px 10px;font-size:11px;font-weight:600;border:none;cursor:pointer;background:#667eea;color:#fff">My Requests</button>
                      <button id="cu-req-mode-monitoring" onclick="setCuReqMode('monitoring')" style="padding:3px 10px;font-size:11px;font-weight:500;border:none;cursor:pointer;background:var(--card);color:var(--muted)">Monitoring</button>
                    </div>
                    <button class="btn ghost" onclick="navTo('tickets')" style="font-size:11px;padding:2px 8px">View all →</button>
                  </div>
                </div>
                <!-- Filters -->
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;align-items:center">
                  <select id="cu-req-filter-status" onchange="renderCustomerRequests()" style="-webkit-appearance:none;appearance:none;padding:3px 8px;font-size:12px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--ink);cursor:pointer">
                    <option value="">All Statuses</option>
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Pending">Pending</option>
                    <option value="Resolved">Resolved</option>
                    <option value="Closed">Closed</option>
                  </select>
                  <select id="cu-req-filter-priority" onchange="renderCustomerRequests()" style="-webkit-appearance:none;appearance:none;padding:3px 8px;font-size:12px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--ink);cursor:pointer">
                    <option value="">All Priorities</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                  </select>
                  <select id="cu-req-sort" onchange="renderCustomerRequests()" style="-webkit-appearance:none;appearance:none;padding:3px 8px;font-size:12px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--ink);cursor:pointer">
                    <option value="newest">Newest</option>
                    <option value="oldest">Oldest</option>
                    <option value="priority">Priority</option>
                    <option value="status">Status</option>
                  </select>
                  <button class="btn ghost" onclick="clearCustomerReqFilters()" style="font-size:11px;padding:2px 6px">Clear</button>
                  <span id="cu-req-count" style="margin-left:auto;font-size:11px;color:var(--muted)"></span>
                </div>
                <div style="max-height:480px;overflow-y:auto">
                  <table style="font-size:13px"><thead><tr><th style="width:50px">ID</th><th>Title</th><th style="width:80px">Priority</th><th style="width:90px">Status</th><th style="width:80px">SLA</th></tr></thead><tbody id="cu-req-body"></tbody></table>
                </div>
              </div>

              <!-- Right column -->
              <div style="display:flex;flex-direction:column;gap:16px">
                <!-- Quick actions -->
                <div style="border-radius:14px;padding:20px;background:var(--card);border:1px solid var(--border);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)">
                  <strong style="font-size:15px;display:block;margin-bottom:16px">What would you like to do?</strong>
                  <div style="display:flex;flex-direction:column;gap:10px">
                    <button onclick="navTo('raise')" style="display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:12px;border:none;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;cursor:pointer;font-size:14px;font-weight:600;transition:all .2s;text-align:left" onmouseenter="this.style.transform='translateX(4px)';this.style.boxShadow='0 4px 15px rgba(102,126,234,.4)'" onmouseleave="this.style.transform='';this.style.boxShadow=''">
                      New Request — Submit a support request
                    </button>
                    <button onclick="navTo('tickets')" style="display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:12px;border:1px solid rgba(99,102,241,.2);background:linear-gradient(135deg,rgba(99,102,241,.06),rgba(139,92,246,.04));color:var(--ink);cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;text-align:left" onmouseenter="this.style.transform='translateX(4px)';this.style.borderColor='rgba(99,102,241,.4)'" onmouseleave="this.style.transform='';this.style.borderColor='rgba(99,102,241,.2)'">
                      My Requests — Track progress
                    </button>
                    <button onclick="openCmdb('cmdb-section-items')" style="display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:12px;border:1px solid rgba(16,185,129,.2);background:linear-gradient(135deg,rgba(16,185,129,.06),rgba(5,150,105,.04));color:var(--ink);cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;text-align:left" onmouseenter="this.style.transform='translateX(4px)';this.style.borderColor='rgba(16,185,129,.4)'" onmouseleave="this.style.transform='';this.style.borderColor='rgba(16,185,129,.2)'">
                      My Equipment — View your assets
                    </button>
                    <button onclick="liveChatToggle()" style="display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:12px;border:1px solid rgba(245,158,11,.2);background:linear-gradient(135deg,rgba(245,158,11,.06),rgba(217,119,6,.04));color:var(--ink);cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;text-align:left" onmouseenter="this.style.transform='translateX(4px)';this.style.borderColor='rgba(245,158,11,.4)'" onmouseleave="this.style.transform='';this.style.borderColor='rgba(245,158,11,.2)'">
                      Live Chat — Talk to our support team
                    </button>
                  </div>
                </div>

                <!-- Requests by Category -->
                <div style="border-radius:14px;padding:20px;background:var(--card);border:1px solid var(--border);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)">
                  <div class="row space" style="margin-bottom:12px">
                    <strong style="font-size:15px;display:flex;align-items:center;gap:6px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg> Requests by Category</strong>
                  </div>
                  <div id="cu-trending-body" style="font-size:13px">
                    <div style="text-align:center;padding:20px;color:var(--muted)">Loading trends...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- My Profile -->
        <div id="view-profile" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">My Profile</h3></div>
            <button class="btn primary" onclick="saveProfile()">💾 Save Changes</button>
          </div>
          
          <div id="profile-company-card" class="card p-16 mb-12" style="display:none">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="width:48px;height:48px;border-radius:12px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700" id="profile-company-icon">C</div>
              <div>
                <div style="font-size:18px;font-weight:700;color:var(--ink)" id="profile-company-name"></div>
                <div class="subtitle">Your organisation</div>
              </div>
            </div>
          </div>

          <div class="card p-16">
            <h4>Personal Information</h4>
            <div class="grid2" style="gap:16px;margin-top:16px">
              <div>
                <label>Username (read-only)</label>
                <input type="text" id="profile-username" disabled style="background:#f5f5f5">
              </div>
              <div>
                <label>Role</label>
                <input type="text" id="profile-role" disabled style="background:#f5f5f5">
              </div>
              <div>
                <label>Full Name</label>
                <input type="text" id="profile-fullname" placeholder="Enter your full name">
              </div>
              <div>
                <label>Email</label>
                <input type="email" id="profile-email" placeholder="Enter your email">
              </div>
              <div>
                <label>Phone</label>
                <input type="tel" id="profile-phone" placeholder="Enter your phone number">
              </div>
              <div>
                <label>Department</label>
                <input type="text" id="profile-department" placeholder="Enter your department">
              </div>
            </div>
          </div>

          <div class="card p-16" style="margin-top:16px">
            <h4>Email Preferences</h4>
            <div style="margin-top:16px">
              <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
                <input type="checkbox" id="profile-receive-email-updates" style="width:18px;height:18px">
                <span>
                  <strong>Receive Email Updates</strong>
                  <div class="subtitle" style="margin-top:4px">If disabled, you won't receive email notifications about ticket updates.</div>
                </span>
              </label>
            </div>
          </div>

          <div class="card p-16" style="margin-top:16px">
            <h4>Account Information</h4>
            <div class="grid2" style="gap:16px;margin-top:16px">
              <div>
                <label>Account Created</label>
                <input type="text" id="profile-created" disabled style="background:#f5f5f5">
              </div>
              <div>
                <label>Last Updated</label>
                <input type="text" id="profile-updated" disabled style="background:#f5f5f5">
              </div>
            </div>
          </div>
        </div>

        <!-- Tenant Management -->
        <div id="view-tenants" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Tenant Management</h3></div>
            <button class="btn primary" onclick="showCreateTenantForm()">+ Create New Tenant</button>
          </div>
          
          <div class="card p-16">
            <h4>Registered Tenants</h4>
            <table id="tenants-table">
              <thead>
                <tr>
                  <th>Company Name</th>
                  <th>Tenant ID</th>
                  <th>Status</th>
                  <th>Plan</th>
                  <th>Subscription</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tenant-list-body">
                <tr><td colspan="7" class="subtitle">Loading tenants...</td></tr>
              </tbody>
            </table>
          </div>
          
          <!-- Create Tenant Form -->
          <div id="create-tenant-form" class="card p-16" style="display:none">
            <h4>Create New Tenant</h4>
            <div class="form-group">
              <label>Company Name</label>
              <input type="text" id="new-tenant-company" placeholder="Enter company name">
            </div>
            <div class="form-group">
              <label>Admin Username</label>
              <input type="text" id="new-tenant-admin" placeholder="Enter admin username">
            </div>
            <div class="form-group">
              <label>Admin Email</label>
              <input type="email" id="new-tenant-email" placeholder="Enter admin email">
            </div>
            <div class="row">
              <button class="btn primary" onclick="createTenant()">Create Tenant</button>
              <button class="btn ghost" onclick="hideCreateTenantForm()">Cancel</button>
            </div>
          </div>
          
          <!-- Edit Tenant Form -->
          <div id="edit-tenant-form" class="card p-16" style="display:none">
            <h4>Edit Tenant</h4>
            <input type="hidden" id="edit-tenant-id">
            <div class="form-group">
              <label>Company Name</label>
              <input type="text" id="edit-company-name" placeholder="Enter company name">
            </div>
            <div class="form-group">
              <label>Admin Username</label>
              <input type="text" id="edit-admin-username" placeholder="Enter admin username">
            </div>
            <div class="form-group">
              <label>Admin Email</label>
              <input type="email" id="edit-admin-email" placeholder="Enter admin email">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="edit-tenant-status">
                <option value="active">Active</option>
                <option value="suspended">Suspended</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
            <div class="row">
              <button class="btn primary" onclick="updateTenant()">Update Tenant</button>
              <button class="btn ghost" onclick="hideEditTenantForm()">Cancel</button>
            </div>
          </div>

          <!-- Deactivate Tenant Confirmation Modal -->
          <div id="delete-tenant-modal" class="card p-16" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;max-width:420px;box-shadow:0 4px 20px rgba(0,0,0,0.3)">
            <h4 style="color:var(--danger)">Deactivate Tenant</h4>
            <p class="mb-12">Are you sure you want to deactivate <strong id="delete-tenant-name"></strong> (<code id="delete-tenant-code"></code>)?</p>
            <p class="subtitle mb-16">The tenant will be deactivated but all data is preserved. You can restore it later.</p>
            <div class="row">
              <button class="btn danger" onclick="confirmDeleteTenant()">Yes, Deactivate</button>
              <button class="btn ghost" onclick="cancelDeleteTenant()">Cancel</button>
            </div>
          </div>

          <!-- Permanent Delete Tenant Modal -->
          <div id="permanent-delete-tenant-modal" class="card p-16" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;max-width:420px;box-shadow:0 4px 20px rgba(0,0,0,0.3)">
            <h4 style="color:var(--danger)">PERMANENT DELETION</h4>
            <p class="mb-8">This will permanently destroy ALL data for <strong id="perm-delete-tenant-name"></strong>. This cannot be undone.</p>
            <p class="mb-8">Type <code id="perm-delete-tenant-code-display"></code> to confirm:</p>
            <input id="perm-delete-confirm-input" class="mb-12" oninput="checkPermDeleteInput()" placeholder="Type tenant code..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-family:monospace">
            <div class="row">
              <button id="perm-delete-btn" class="btn danger" onclick="confirmPermanentDelete()" disabled>Permanently Delete</button>
              <button class="btn ghost" onclick="cancelPermanentDelete()">Cancel</button>
            </div>
          </div>

          <!-- Tenant Subscription Modal -->
          <div id="tenant-subscription-modal" class="card p-16" style="display:none">
            <h4>Manage Subscription</h4>
            <input type="hidden" id="sub-tenant-id">
            <div class="subtitle mb-12" id="sub-tenant-name">Tenant Name</div>

            <div class="grid2 mb-12">
              <div class="form-group">
                <label>Current Plan</label>
                <select id="sub-plan-id">
                  <option value="">Loading plans...</option>
                </select>
              </div>
              <div class="form-group">
                <label>Subscription Status</label>
                <select id="sub-status">
                  <option value="trial">Trial</option>
                  <option value="active">Active</option>
                  <option value="past_due">Past Due</option>
                  <option value="cancelled">Cancelled</option>
                  <option value="expired">Expired</option>
                </select>
              </div>
            </div>

            <div class="grid2 mb-12">
              <div class="form-group">
                <label>Billing Cycle</label>
                <select id="sub-billing-cycle">
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
              <div class="form-group">
                <label>Trial End Date</label>
                <input type="date" id="sub-trial-end">
              </div>
            </div>

            <div class="grid2 mb-12">
              <div class="form-group">
                <label>Period Start</label>
                <input type="date" id="sub-period-start">
              </div>
              <div class="form-group">
                <label>Period End</label>
                <input type="date" id="sub-period-end">
              </div>
            </div>

            <!-- Usage Counts (shown based on pricing model) -->
            <div id="sub-usage-section" class="grid2 mb-12">
              <div class="form-group" id="sub-user-count-group">
                <label>Technician Count</label>
                <input type="number" id="sub-user-count" min="0" value="0">
                <small class="subtitle">Current billable technicians</small>
              </div>
              <div class="form-group" id="sub-client-count-group" style="display:none">
                <label>Client Count</label>
                <input type="number" id="sub-client-count" min="0" value="0">
                <small class="subtitle">Current billable clients</small>
              </div>
            </div>

            <div id="sub-current-info" class="p-12 mb-12" style="background:var(--surface);border-radius:8px">
              <div class="subtitle">Current Subscription</div>
              <div id="sub-current-details">No subscription</div>
            </div>

            <div class="row">
              <button class="btn primary" onclick="saveTenantSubscription()">Save Subscription</button>
              <button class="btn danger" onclick="cancelTenantSubscription()" id="btn-cancel-sub" style="display:none">Cancel Subscription</button>
              <button class="btn ghost" onclick="hideTenantSubscriptionModal()">Close</button>
            </div>
          </div>
        </div>

        <!-- Subscription Management -->
        <div id="view-subscriptions" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Subscription Management</h3></div>
            <div class="row">
              <button class="btn primary" onclick="showCreateSubscriptionForm()">+ Create Subscription</button>
              <button class="btn" onclick="exportSubscriptions()">📊 Export Data</button>
            </div>
          </div>
          
          <!-- Subscription Stats -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Revenue</div>
              <div id="total-revenue" style="font-size:28px;font-weight:800">$0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Active Subscriptions</div>
              <div id="active-subscriptions" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Trial Conversions</div>
              <div id="trial-conversions" style="font-size:28px;font-weight:800">0%</div>
            </div>
          </div>
          
          <!-- Subscription List -->
          <div class="card p-16">
            <h4>All Subscriptions</h4>
            <table id="subscriptions-table">
              <thead>
                <tr>
                  <th>Tenant</th>
                  <th>Plan</th>
                  <th>Status</th>
                  <th>Price</th>
                  <th>Next Billing</th>
                  <th>Users</th>
                  <th>Usage</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="subscription-list-body">
                <tr><td colspan="8" class="subtitle">Loading subscriptions...</td></tr>
              </tbody>
            </table>
          </div>
          
          <!-- Create Subscription Form -->
          <div id="create-subscription-form" class="card p-16" style="display:none">
            <h4>Create New Subscription</h4>
            <div class="form-group">
              <label>Select Tenant</label>
              <select id="subscription-tenant" onchange="loadTenantPlans()">
                <option value="">Choose a tenant...</option>
              </select>
            </div>
            <div class="form-group">
              <label>Plan Type</label>
              <select id="subscription-plan">
                <option value="trial">Trial (Free - 14 days)</option>
                <option value="starter">Starter ($29/month)</option>
                <option value="pro">Pro ($99/month)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Billing Cycle</label>
              <select id="subscription-billing">
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly (20% discount)</option>
              </select>
            </div>
            <div class="row">
              <button class="btn primary" onclick="createSubscription()">Create Subscription</button>
              <button class="btn ghost" onclick="hideCreateSubscriptionForm()">Cancel</button>
            </div>
          </div>
        </div>
        
        <!-- Billing Management -->
        <div id="view-billing" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Billing Management</h3></div>
            <div class="row">
              <button class="btn" onclick="generateInvoice()">📄 Generate Invoice</button>
              <button class="btn" onclick="exportBilling()">📊 Export Billing</button>
            </div>
          </div>
          
          <!-- Billing Stats -->
          <div class="grid4 mb-16">
            <div class="card p-16">
              <div class="subtitle">Monthly Recurring Revenue</div>
              <div id="mrr" style="font-size:24px;font-weight:800">$0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Pending Payments</div>
              <div id="pending-payments" style="font-size:24px;font-weight:800">$0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Churn Rate</div>
              <div id="churn-rate" style="font-size:24px;font-weight:800">0%</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Average Revenue Per User</div>
              <div id="arpu" style="font-size:24px;font-weight:800">$0</div>
            </div>
          </div>
          
          <!-- Recent Transactions -->
          <div class="card p-16">
            <h4>Recent Transactions</h4>
            <table id="billing-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Tenant</th>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Invoice</th>
                </tr>
              </thead>
              <tbody id="billing-list-body">
                <tr><td colspan="6" class="subtitle">Loading transactions...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Plan Management -->
        <div id="view-plans" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Plan Management</h3></div>
            <div class="row">
              <button class="btn primary" onclick="showCreatePlanForm()">+ Create New Plan</button>
              <button class="btn" onclick="previewPlansOnMarketing()" title="Opens marketing pricing page">👁 Preview Marketing</button>
            </div>
          </div>

          <!-- Plan Stats -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Plans</div>
              <div id="total-plans" style="font-size:28px;font-weight:800">3</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Active Plans</div>
              <div id="active-plans" style="font-size:28px;font-weight:800">3</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Most Popular</div>
              <div id="popular-plan" style="font-size:28px;font-weight:800">Starter</div>
            </div>
          </div>

          <!-- Plans List -->
          <div class="card p-16 mb-16">
            <h4>Subscription Plans</h4>
            <p class="subtitle mb-8">Plans are displayed on the marketing pricing page. Changes here update the marketing site immediately.</p>
            <table id="plans-table">
              <thead>
                <tr>
                  <th>Order</th>
                  <th>Plan</th>
                  <th>Slug</th>
                  <th>Pricing</th>
                  <th>Features</th>
                  <th>Tenants</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="plans-list-body">
                <tr><td colspan="8" class="subtitle">Loading plans...</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Create/Edit Plan Form -->
          <div id="create-plan-form" class="card p-16" style="display:none">
            <h4 id="plan-form-title">Create New Plan</h4>
            <input type="hidden" id="plan-edit-id">

            <!-- Basic Info -->
            <div style="border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:16px">
              <h5 style="margin:0 0 12px 0">Basic Information</h5>
              <div class="grid3">
                <div class="form-group">
                  <label>Slug (URL-safe ID)</label>
                  <input type="text" id="plan-slug" placeholder="e.g., enterprise">
                  <small class="subtitle">Used in URLs and API. Cannot be changed easily.</small>
                </div>
                <div class="form-group">
                  <label>Internal Name</label>
                  <input type="text" id="plan-name" placeholder="e.g., Enterprise">
                </div>
                <div class="form-group">
                  <label>Display Name (Marketing)</label>
                  <input type="text" id="plan-display-name" placeholder="e.g., Enterprise">
                </div>
              </div>
              <div class="grid2">
                <div class="form-group">
                  <label>Tagline</label>
                  <input type="text" id="plan-tagline" placeholder="e.g., For large teams">
                </div>
                <div class="form-group">
                  <label>Badge Text (optional)</label>
                  <input type="text" id="plan-badge" placeholder="e.g., BEST VALUE">
                </div>
              </div>
              <div class="form-group">
                <label>Description</label>
                <textarea id="plan-description" placeholder="Full plan description for marketing"></textarea>
              </div>
            </div>

            <!-- Pricing -->
            <div style="border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:16px">
              <h5 style="margin:0 0 12px 0">Pricing (AUD)</h5>
              <div class="grid3">
                <div class="form-group">
                  <label>Monthly Price ($)</label>
                  <input type="number" id="plan-price-monthly" placeholder="29" step="0.01">
                </div>
                <div class="form-group">
                  <label>Yearly Price ($)</label>
                  <input type="number" id="plan-price-yearly" placeholder="290" step="0.01">
                  <small class="subtitle">Typically 10x monthly (2 months free)</small>
                </div>
                <div class="form-group">
                  <label>Per User Price ($)</label>
                  <input type="number" id="plan-price-per-user" placeholder="29" step="0.01">
                </div>
              </div>
            </div>

            <!-- Limits -->
            <div style="border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:16px">
              <h5 style="margin:0 0 12px 0">Feature Limits (-1 = unlimited)</h5>
              <div class="grid3">
                <div class="form-group">
                  <label>Max Users</label>
                  <input type="number" id="plan-limit-users" placeholder="-1">
                </div>
                <div class="form-group">
                  <label>Max Tickets/Month</label>
                  <input type="number" id="plan-limit-tickets" placeholder="-1">
                </div>
                <div class="form-group">
                  <label>Max Storage (GB)</label>
                  <input type="number" id="plan-limit-storage" placeholder="10">
                </div>
              </div>
            </div>

            <!-- Features -->
            <div style="border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:16px">
              <h5 style="margin:0 0 12px 0">Included Features</h5>
              <p class="subtitle mb-8">Select features included in this plan. These control feature gating in the app.</p>
              <div id="plan-features-checklist" class="grid3" style="max-height:300px;overflow-y:auto;padding:8px;background:var(--bg-soft);border-radius:8px">
                <div class="subtitle">Loading features...</div>
              </div>
            </div>

            <!-- Display Settings -->
            <div style="margin-bottom:16px">
              <h5 style="margin:0 0 12px 0">Display Settings</h5>
              <div class="grid3">
                <div class="form-group">
                  <label>Display Order</label>
                  <input type="number" id="plan-display-order" placeholder="1">
                  <small class="subtitle">Lower = first on pricing page</small>
                </div>
                <div class="form-group">
                  <label>Status</label>
                  <select id="plan-status">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive (Hidden)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label style="display:flex;align-items:center;gap:8px;margin-top:24px">
                    <input type="checkbox" id="plan-featured" style="width:auto">
                    Featured (highlighted on pricing)
                  </label>
                </div>
              </div>
            </div>

            <div class="row">
              <button class="btn primary" onclick="savePlan()">Save Plan</button>
              <button class="btn ghost" onclick="hideCreatePlanForm()">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Currencies Management (Master Admin) -->
        <div id="view-currencies" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Currency Management</h3></div>
            <button class="btn" onclick="loadCurrenciesAdmin()">🔄 Refresh</button>
          </div>

          <!-- Currency Stats -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Currencies</div>
              <div id="total-currencies" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Active Currencies</div>
              <div id="active-currencies" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Base Currency</div>
              <div id="base-currency" style="font-size:28px;font-weight:800">USD</div>
            </div>
          </div>

          <!-- Currencies List -->
          <div class="card p-16 mb-16">
            <h4>Currency Exchange Rates</h4>
            <p class="subtitle mb-8">Prices are auto-converted from base currency (USD). Set exchange rates and rounding rules for regional pricing.</p>
            <table id="currencies-table">
              <thead>
                <tr>
                  <th>Order</th>
                  <th>Code</th>
                  <th>Currency</th>
                  <th>Symbol</th>
                  <th>Exchange Rate</th>
                  <th>Round To</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="currencies-list-body">
                <tr><td colspan="8" class="subtitle">Loading currencies...</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Regional Pricing Section -->
          <div class="card p-16 mb-16">
            <h4>Regional Pricing</h4>
            <p class="subtitle mb-8">Set prices for each currency. Select a plan, calculate suggested prices, review/edit, then commit to save.</p>
            <div class="row mb-8" style="gap:8px">
              <select id="regional-plan-select" class="input" style="flex:1" onchange="clearRegionalPrices()">
                <option value="">Select a plan to configure regional pricing...</option>
              </select>
              <button class="btn primary" onclick="calculateRegionalPrices()">Calculate Suggested Prices</button>
            </div>
            <div id="regional-prices-container" style="display:none">
              <div class="mb-8" style="padding:12px;background:#f0f9ff;border:1px solid #0ea5e9;border-radius:8px">
                <strong>Workflow:</strong> Review the suggested prices below. Edit any values as needed, then click "Commit All Prices" to save.
              </div>
              <table id="regional-prices-table">
                <thead>
                  <tr>
                    <th>Currency</th>
                    <th>Rate</th>
                    <th>Suggested Monthly</th>
                    <th>Final Monthly</th>
                    <th>Final Yearly</th>
                    <th>Final Per User</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="regional-prices-body">
                </tbody>
              </table>
              <div class="row mt-12" style="gap:8px">
                <button class="btn primary" onclick="commitRegionalPrices()">Commit All Prices</button>
                <button class="btn" onclick="useSuggestedPrices()">Use All Suggested</button>
                <button class="btn ghost" onclick="clearRegionalPrices()">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- System Overview (Master Admin) -->
        <div id="view-system" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">System Overview</h3></div>
            <button class="btn" onclick="loadSystemOverview()">🔄 Refresh</button>
          </div>

          <!-- System Stats -->
          <div class="grid4 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Tenants</div>
              <div id="sys-total-tenants" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Active Tenants</div>
              <div id="sys-active-tenants" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Master Users</div>
              <div id="sys-master-users" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Audit Entries</div>
              <div id="sys-audit-logs" style="font-size:28px;font-weight:800">0</div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="card p-16">
            <h4>Recent System Activity</h4>
            <table id="system-activity-table">
              <thead>
                <tr>
                  <th>Action</th>
                  <th>User</th>
                  <th>Details</th>
                  <th>IP Address</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="system-activity-body">
                <tr><td colspan="5" class="subtitle">Loading activity...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Email Processing Management -->
        <div id="view-email-processing" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Email Processing</h3></div>
            <button class="btn" onclick="refreshEmailSettings()">🔄 Refresh</button>
          </div>
          
          <!-- Email Settings -->
          <div class="card p-16 mb-16">
            <h4>Email Processing Settings</h4>
            <div id="email-settings-info">
              <div class="subtitle">Loading email settings...</div>
            </div>
            <div id="email-configuration-help" style="display:none" class="mt-16">
              <div class="usage-alert warning">
                <h5>📧 Email Processing Not Configured</h5>
                <p>To enable real email processing, you need to configure IMAP credentials:</p>
                <ol>
                  <li>Create a <code>.env</code> file in your project root</li>
                  <li>Add your IMAP settings (see <code>EMAIL_SETUP.md</code> for details)</li>
                  <li>Restart the server</li>
                </ol>
                <p><strong>Example configuration:</strong></p>
                <pre style="background:#f8f9fa;padding:12px;border-radius:4px;font-size:12px;">
IMAP_HOST=imap.gmail.com
IMAP_PORT=993
IMAP_USER=your-support-email@gmail.com
IMAP_PASSWORD=your-app-password
IMAP_REJECT_UNAUTHORIZED=false</pre>
              </div>
            </div>
          </div>
          
          <!-- Test Email Processing -->
          <div class="card p-16 mb-16">
            <h4>Test Email Processing</h4>
            <div class="grid2">
              <div class="form-group">
                <label>Test Email Address</label>
                <input type="email" id="test-email" class="input" placeholder="test@example.com">
              </div>
              <div class="form-group">
                <label>Subject</label>
                <input type="text" id="test-subject" class="input" placeholder="Test Subject">
              </div>
            </div>
            <div class="form-group">
              <label>Message</label>
              <textarea id="test-message" class="input" placeholder="Test message content" rows="3"></textarea>
            </div>
            <button class="btn primary" onclick="testEmailProcessing()">Test Email Processing</button>
          </div>
          
          <!-- Tenant Email Settings -->
          <div class="card p-16">
            <h4>Tenant Email Settings</h4>
            <table id="tenant-email-table">
              <thead>
                <tr>
                  <th>Tenant</th>
                  <th>Domain</th>
                  <th>Email Processing</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tenant-email-list-body">
                <tr><td colspan="4" class="subtitle">Loading tenant email settings...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Customer Plans & Upgrades -->
        <div id="view-customer-plans" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Plans & Upgrades</h3></div>
            <button class="btn" onclick="refreshCustomerPlans()">🔄 Refresh</button>
          </div>
          
          <!-- Current Plan -->
          <div class="card p-16 mb-16">
            <h4>Your Current Plan</h4>
            <div id="current-plan-info">
              <div class="subtitle">Loading current plan...</div>
            </div>
          </div>
          
          <!-- Plan Comparison -->
          <div class="card p-16 mb-16">
            <h4>Available Plans</h4>
            <div id="plan-comparison">
              <div class="subtitle">Loading available plans...</div>
            </div>
          </div>
          
          <!-- Upgrade Form -->
          <div id="upgrade-form" class="card p-16" style="display:none">
            <h4>Upgrade Plan</h4>
            <div id="upgrade-details">
              <!-- Upgrade details will be populated here -->
            </div>
            <div class="row">
              <button class="btn primary" onclick="confirmUpgrade()">Confirm Upgrade</button>
              <button class="btn ghost" onclick="hideUpgradeForm()">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Customer Billing -->
        <div id="view-customer-billing" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Billing & Invoices</h3></div>
            <button class="btn" onclick="refreshCustomerBilling()">🔄 Refresh</button>
          </div>
          
          <!-- Billing Summary -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Current Plan</div>
              <div id="billing-current-plan" style="font-size:28px;font-weight:800">Loading...</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Next Billing Date</div>
              <div id="billing-next-date" style="font-size:28px;font-weight:800">Loading...</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Monthly Cost</div>
              <div id="billing-monthly-cost" style="font-size:28px;font-weight:800">Loading...</div>
            </div>
          </div>
          
          <!-- Payment Method -->
          <div class="card p-16 mb-16">
            <h4>Payment Method</h4>
            <div id="payment-method-info">
              <div class="subtitle">Loading payment information...</div>
            </div>
          </div>
          
          <!-- Invoice History -->
          <div class="card p-16">
            <h4>Invoice History</h4>
            <table id="invoice-table">
              <thead>
                <tr>
                  <th>Invoice #</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="invoice-list-body">
                <tr><td colspan="5" class="subtitle">Loading invoices...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- My Company (Customer View) -->
        <div id="view-my-company" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">My Company</h3></div>
            <button class="btn" onclick="loadMyCompany()">🔄 Refresh</button>
          </div>

          <!-- Company Info -->
          <div class="card p-16 mb-16">
            <h4>Company Information</h4>
            <div class="grid2">
              <div>
                <div class="form-group">
                  <label>Company Name</label>
                  <div id="my-company-name" class="subtitle">Loading...</div>
                </div>
                <div class="form-group">
                  <label>Domain</label>
                  <div id="my-company-domain" class="subtitle">-</div>
                </div>
                <div class="form-group">
                  <label>Phone</label>
                  <div id="my-company-phone" class="subtitle">-</div>
                </div>
              </div>
              <div>
                <div class="form-group">
                  <label>Address</label>
                  <div id="my-company-address" class="subtitle">-</div>
                </div>
                <div class="form-group">
                  <label>Service Level Agreement</label>
                  <div id="my-company-sla" class="subtitle">Default SLA</div>
                </div>
                <div class="form-group">
                  <label>Total Users</label>
                  <div id="my-company-user-count" class="subtitle">0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Company Users List (Read Only) -->
          <div class="card p-16">
            <h4>Users in Your Company</h4>
            <div class="subtitle mb-12">Contact your company admin if you need user changes</div>
            <table id="my-company-users-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="my-company-users-body">
                <tr><td colspan="4" class="subtitle">Loading users...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Company Admin (Company Admin View) -->
        <div id="view-company-admin" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Company Admin</h3></div>
            <div class="row">
              <button class="btn" onclick="loadCompanyAdminUsers()">🔄 Refresh</button>
              <button class="btn primary" onclick="showInviteUserModal()">+ Invite User</button>
            </div>
          </div>

          <!-- Company Admin Stats -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Users</div>
              <div id="company-admin-total-users" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Active Users</div>
              <div id="company-admin-active-users" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Disabled Users</div>
              <div id="company-admin-disabled-users" style="font-size:28px;font-weight:800">0</div>
            </div>
          </div>

          <!-- User Management Table -->
          <div class="card p-16">
            <h4>Manage Company Users</h4>
            <table id="company-admin-users-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Job Title</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Last Login</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="company-admin-users-body">
                <tr><td colspan="7" class="subtitle">Loading users...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Company Reports View (company admin) -->
        <div id="view-company-reports" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Monthly Reports</h3></div>
          </div>

          <!-- Generate Panel -->
          <div class="card p-16 mb-12">
            <h5 class="subtitle" style="font-weight:600;margin:0 0 12px 0">Generate Report</h5>
            <div class="mb-8" style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
              <div>
                <label class="subtitle">Month</label>
                <select id="cr-report-month" class="input" style="font-size:13px;width:140px"></select>
              </div>
              <div>
                <label class="subtitle">Year</label>
                <input id="cr-report-year" class="input" type="number" style="font-size:13px;width:90px"/>
              </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button class="btn" onclick="previewCompanyReport()">Preview Report</button>
              <button class="btn primary" onclick="sendCompanyReport()">Email Report</button>
            </div>
            <div id="cr-report-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
            <div id="cr-report-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
          </div>

          <!-- History -->
          <div class="card p-16">
            <h5 class="subtitle" style="font-weight:600;margin:0 0 12px 0">Report History</h5>
            <table class="table" style="width:100%;font-size:13px">
              <thead>
                <tr><th>Period</th><th>Tickets</th><th>SLA %</th><th>Status</th><th>Date</th></tr>
              </thead>
              <tbody id="cr-report-history-body">
                <tr><td colspan="5" style="text-align:center;color:var(--muted);padding:16px">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Invite User Modal -->
        <div id="invite-user-modal" class="modal" style="display:none">
          <div class="modal-content" style="max-width:500px">
            <h3>Invite New User</h3>
            <div class="form-group">
              <label>Email Address *</label>
              <input type="email" id="invite-user-email" placeholder="user@example.com">
            </div>
            <div class="form-group">
              <label>Full Name</label>
              <input type="text" id="invite-user-name" placeholder="John Smith">
            </div>
            <div class="form-group">
              <label>Job Title</label>
              <input type="text" id="invite-user-title" placeholder="IT Manager">
            </div>
            <div class="row" style="margin-top:16px">
              <button class="btn primary" onclick="inviteCompanyUser()">Send Invite</button>
              <button class="btn ghost" onclick="hideInviteUserModal()">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Analytics Dashboard -->
        <div id="view-analytics" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Analytics Dashboard</h3></div>
            <div class="row">
              <button class="btn" onclick="refreshAnalytics()">🔄 Refresh</button>
              <button class="btn" onclick="exportAnalyticsToCSV()">📊 Export CSV</button>
            </div>
          </div>

          <!-- Analytics Summary -->
          <div class="grid4 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Tickets</div>
              <div id="analytics-total-tickets" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Open Tickets</div>
              <div id="analytics-open-tickets" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Resolved Today</div>
              <div id="analytics-resolved-today" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Avg Response Time</div>
              <div id="analytics-avg-response" style="font-size:28px;font-weight:800">0h</div>
            </div>
          </div>
          
          <!-- Charts Section -->
          <div class="grid2 mb-16">
            <div class="card p-16">
              <h4>Ticket Status Distribution</h4>
              <div id="ticket-status-chart" style="height:300px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;border-radius:8px;">
                <div class="subtitle">Loading chart...</div>
              </div>
            </div>
            <div class="card p-16">
              <h4>Priority Breakdown</h4>
              <div id="priority-chart" style="height:300px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;border-radius:8px;">
                <div class="subtitle">Loading chart...</div>
              </div>
            </div>
          </div>
          
          <!-- Recent Activity -->
          <div class="card p-16">
            <h4>Recent Activity</h4>
            <div id="recent-activity">
              <div class="subtitle">Loading recent activity...</div>
            </div>
          </div>
        </div>

        
<!-- AI Insights Dashboard - INSERT THIS AFTER THE ANALYTICS VIEW (around line 926) -->

        <!-- AI Insights Dashboard -->
        <div id="view-ai-insights" style="display:none">
          <div class="row space mb-12">
            <div class="row">
              <button class="btn ghost" onclick="switchView('dash')">← Back</button>
              <h3 class="title" style="margin:0 0 0 8px">🤖 AI Insights Dashboard</h3>
            </div>
            <div class="row">
              <button class="btn" onclick="refreshAIInsights()">🔄 Refresh</button>
              <button class="btn" onclick="triggerTrendDetection(event)">🔍 Detect Trends</button>
              <select id="ai-period" class="input" style="width:auto" onchange="refreshAIInsights()">
                <option value="1">Last 24 hours</option>
                <option value="7" selected>Last 7 days</option>
                <option value="30">Last 30 days</option>
              </select>
            </div>
          </div>

          <!-- AI Performance Metrics - shown first -->
          <div class="grid4 mb-16">
            <div class="card p-16">
              <div class="subtitle">Tickets Analyzed</div>
              <div id="ai-tickets-analyzed" style="font-size:32px;font-weight:800;color:#667eea">0</div>
              <div class="subtitle" style="margin-top:4px">Total processed</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Avg Confidence</div>
              <div id="ai-avg-confidence" style="font-size:32px;font-weight:800;color:#48bb78">--</div>
              <div class="subtitle" style="margin-top:4px">AI accuracy score</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Processing Speed</div>
              <div id="ai-avg-time" style="font-size:32px;font-weight:800;color:#ed8936">--</div>
              <div class="subtitle" style="margin-top:4px">Average time per ticket</div>
            </div>
            <div class="card p-16" style="cursor:pointer;transition:all 0.2s" onclick="showCMDBSuggestionsModal()" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
              <div class="subtitle">AI CMDB Suggestions</div>
              <div id="ai-cmdb-suggestions-count" style="font-size:32px;font-weight:800;color:#9f7aea">0</div>
              <div class="subtitle" style="margin-top:4px">Pending review →</div>
            </div>
          </div>

          <!-- Active Insights / Alerts -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">🚨 Active Insights & Alerts</h4>
            <div id="ai-insights-list" style="max-height:400px;overflow-y:auto">
              <div class="subtitle">Loading insights...</div>
            </div>
          </div>

          <!-- Charts Row -->
          <div class="grid2 mb-16">
            <!-- Sentiment Distribution -->
            <div class="card p-16">
              <h4 class="mb-12">😊 Sentiment Distribution</h4>
              <div id="sentiment-chart" style="min-height:200px"></div>
            </div>

            <!-- Top Categories -->
            <div class="card p-16">
              <h4 class="mb-12">📁 Top Categories</h4>
              <div id="categories-chart" style="min-height:200px"></div>
            </div>
          </div>

          <!-- Root Causes -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">🔍 Root Cause Analysis</h4>
            <div id="root-causes-chart" style="min-height:180px"></div>
          </div>
        </div>

<!-- END AI Insights Dashboard -->

        <!-- Automated Actions -->
        <div id="view-ticket-rules" style="display:none">
          <div class="row space mb-12">
            <div class="row">
              <button class="btn ghost" onclick="switchView('dash')">← Back</button>
              <h3 class="title" style="margin:0 0 0 8px">⚙️ Automated Actions</h3>
            </div>
            <button class="btn" onclick="showCreateRuleModal()">+ New Action</button>
          </div>

          <!-- Statistics Card -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Actions</div>
              <div id="rules-total" style="font-size:32px;font-weight:800;color:#667eea">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Active Actions</div>
              <div id="rules-enabled" style="font-size:32px;font-weight:800;color:#48bb78">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Executions (24h)</div>
              <div id="rules-executions-24h" style="font-size:32px;font-weight:800;color:#ed8936">0</div>
            </div>
          </div>

          <!-- Rules List -->
          <div class="card p-16">
            <h4 class="mb-12">Actions</h4>
            <div id="rules-list">
              <div class="subtitle">Loading actions...</div>
            </div>
          </div>
        </div>

        <!-- Create/Edit Automated Action Modal -->
        <div id="rule-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;overflow-y:auto;align-items:flex-start;justify-content:center;padding:40px 16px">
          <div class="card" style="max-width:600px;width:100%;padding:24px">
            <div class="row space mb-16">
              <h3 id="rule-modal-title">Create Automated Action</h3>
              <button class="btn ghost" onclick="closeRuleModal()">✕ Close</button>
            </div>

            <form id="rule-form" onsubmit="saveRule(event)">
              <input type="hidden" id="rule-id">
              <input type="hidden" id="rule-ai-interpreted" value="0">
              <input type="hidden" id="rule-ai-confidence" value="">

              <!-- Instruction Section -->
              <div id="instruction-section" class="mb-16" style="padding:16px;background:#eef2ff;border-radius:6px;border:1px solid #c7d2fe">
                <h4 class="mb-8" style="color:#4338ca">Describe what this action should do</h4>
                <div class="mb-8">
                  <textarea id="rule-instruction" class="input" rows="3" placeholder="Examples:&#10;- Assign tickets about database issues to Selami&#10;- Set priority to critical when title contains 'server down'&#10;- Delete spam tickets containing 'crypto' in the body&#10;- Tag monitoring alerts with 'infrastructure'" style="width:100%;font-size:14px"></textarea>
                </div>
                <div class="row" style="gap:8px">
                  <button type="button" class="btn" onclick="interpretInstruction()" id="interpret-btn" style="background:#4338ca">Interpret with AI</button>
                  <button type="button" class="btn ghost" onclick="toggleAdvancedEdit()" id="toggle-advanced-btn" style="font-size:13px">Edit Manually</button>
                </div>
              </div>

              <!-- AI Interpretation Result -->
              <div id="interpretation-result" style="display:none" class="mb-16">
                <div style="padding:16px;background:#f0fdf4;border-radius:6px;border:1px solid #bbf7d0">
                  <div class="row space mb-8">
                    <h4 style="color:#166534;margin:0">AI Interpretation</h4>
                    <span id="interpretation-confidence" style="padding:3px 8px;border-radius:12px;font-size:12px;font-weight:600"></span>
                  </div>
                  <div id="interpretation-details" style="font-size:14px"></div>
                  <div id="interpretation-warnings" style="display:none;margin-top:8px;padding:8px;background:#fef3c7;border-radius:4px;font-size:13px;color:#92400e"></div>
                  <div class="row" style="gap:8px;margin-top:12px">
                    <button type="button" class="btn ghost" onclick="toggleAdvancedEdit()" style="font-size:13px">Review / Edit Fields</button>
                    <button type="button" class="btn ghost" onclick="reinterpret()" style="font-size:13px">Re-interpret</button>
                  </div>
                </div>
              </div>

              <!-- Rule Name (auto-filled by AI or manual) -->
              <div class="mb-12">
                <label style="display:block;margin-bottom:4px;font-weight:600">Action Name *</label>
                <input type="text" id="rule-name" class="input" placeholder="e.g., Auto-assign Infrastructure Alerts" required style="width:100%">
              </div>

              <!-- Description -->
              <div class="mb-12">
                <label style="display:block;margin-bottom:4px;font-weight:600">Description</label>
                <textarea id="rule-description" class="input" rows="2" placeholder="Optional description" style="width:100%"></textarea>
              </div>

              <!-- Enabled -->
              <div class="mb-16">
                <label style="display:flex;align-items:center;cursor:pointer">
                  <input type="checkbox" id="rule-enabled" checked style="margin-right:8px">
                  <span style="font-weight:600">Enable this action</span>
                </label>
              </div>

              <!-- Advanced/Manual Fields (hidden by default for AI flow) -->
              <div id="advanced-fields" style="display:none">
                <!-- Search Criteria Section -->
                <div class="mb-16" style="padding:16px;background:#f7fafc;border-radius:6px">
                  <h4 class="mb-12">Search Criteria</h4>

                  <div class="mb-12">
                    <label style="display:block;margin-bottom:4px;font-weight:600">Search In</label>
                    <select id="rule-search-in" class="input" style="width:100%">
                      <option value="both">Title and Body</option>
                      <option value="title">Title Only</option>
                      <option value="body">Body Only</option>
                    </select>
                  </div>

                  <div class="mb-12">
                    <label style="display:block;margin-bottom:4px;font-weight:600">Search Text</label>
                    <input type="text" id="rule-search-text" class="input" placeholder="e.g., Infrastructure Monitoring" style="width:100%">
                  </div>

                  <div class="mb-12">
                    <label style="display:flex;align-items:center;cursor:pointer">
                      <input type="checkbox" id="rule-case-sensitive" style="margin-right:8px">
                      <span>Case sensitive matching</span>
                    </label>
                  </div>
                </div>

                <!-- Action Section -->
                <div class="mb-16" style="padding:16px;background:#f7fafc;border-radius:6px">
                  <h4 class="mb-12">Action</h4>

                  <div class="mb-12">
                    <label style="display:block;margin-bottom:4px;font-weight:600">Action Type</label>
                    <select id="rule-action-type" class="input" onchange="updateActionParams()" style="width:100%">
                      <option value="">Select an action...</option>
                      <option value="delete">Delete Ticket</option>
                      <option value="assign_to_expert">Assign to Expert</option>
                      <option value="create_for_customer">Create for Customer</option>
                      <option value="set_priority">Set Priority</option>
                      <option value="set_status">Set Status</option>
                      <option value="add_tag">Add Tag</option>
                      <option value="add_to_monitoring">Add to System Monitoring Sources</option>
                      <option value="set_sla_definition">Apply SLA Definition</option>
                      <option value="set_sla_deadlines">Set SLA Deadlines</option>
                    </select>
                  </div>

                  <!-- Dynamic Action Parameters -->
                  <div id="action-params-container"></div>
                </div>
              </div>

              <!-- Buttons -->
              <div class="row" style="gap:8px;justify-content:flex-end">
                <button type="button" class="btn ghost" onclick="closeRuleModal()">Cancel</button>
                <button type="submit" class="btn" id="save-rule-btn">Save Action</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Tickets -->
        <div id="view-tickets" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Tickets</h3></div>
            <button class="btn" onclick="exportTicketsToCSV()">📊 Export CSV</button>
          </div>

          <!-- Compact Filter Bar -->
          <div class="filter-bar" id="ticket-filters-bar">
            <input id="ticket-search" class="input filter-search filter-compact" placeholder="Search tickets..." oninput="onTicketFilterChange()">

            <div class="filter-group filter-collapsible">
              <select id="ticket-filter-status" class="input filter-compact" onchange="onTicketFilterChange()">
                <option value="">All Statuses</option>
                <option value="active" selected>Active</option>
                <option value="Open">Open</option>
                <option value="In Progress">In Progress</option>
                <option value="Pending">Pending</option>
                <option value="Resolved">Resolved</option>
                <option value="Closed">Closed</option>
              </select>

              <select id="ticket-filter-priority" class="input filter-compact" onchange="onTicketFilterChange()">
                <option value="">All Priorities</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
              </select>

              <select id="ticket-filter-assignee" class="input filter-compact" onchange="onTicketFilterChange()">
                <option value="">All Assignees</option>
                <option value="unassigned">Unassigned</option>
              </select>

              <select id="ticket-filter-company" class="input filter-compact" onchange="onCompanyFilterChange(); saveFilterSettings('tickets')">
                <option value="">All Companies</option>
              </select>

              <select id="ticket-filter-customer" class="input filter-compact" onchange="onTicketFilterChange()">
                <option value="">All Members</option>
              </select>

              <select id="ticket-sort" class="input filter-compact" style="min-width:100px" onchange="onTicketFilterChange()">
                <option value="id-desc">Newest</option>
                <option value="id-asc">Oldest</option>
                <option value="date-desc">Date ↓</option>
                <option value="date-asc">Date ↑</option>
                <option value="priority-desc">Priority ↓</option>
                <option value="priority-asc">Priority ↑</option>
                <option value="status">Status</option>
                <option value="assignee">Assignee</option>
                <option value="customer">Customer</option>
                <option value="sla">SLA</option>
              </select>

              <label class="filter-checkbox" title="When checked, shows all tickets including system/monitoring alerts. Uncheck to see only customer tickets.">
                <input type="checkbox" id="ticket-filter-system" onchange="onTicketFilterChange()" checked>
                <span>Include System</span>
              </label>

              <button class="btn-clear" onclick="clearTicketFilters()">Clear</button>
            </div>

            <button class="filter-toggle btn ghost" onclick="toggleFilterBar(this)">+ Filters</button>

            <div style="margin-left:auto;display:flex;align-items:center;gap:6px">
              <span id="ticket-count" class="subtitle" style="margin-right:8px">0 tickets</span>
              <button id="manual-refresh-btn" class="btn ghost" style="padding:4px 8px;font-size:11px" onclick="manualRefresh()">↻</button>
              <select id="refresh-interval-select" class="input filter-compact" style="min-width:55px;max-width:60px" onchange="setRefreshInterval(parseInt(this.value))">
                <option value="15000">15s</option>
                <option value="30000">30s</option>
                <option value="60000">60s</option>
                <option value="120000">2m</option>
                <option value="300000">5m</option>
              </select>
            </div>
          </div>

          <div class="card p-16 mb-16">
            <div id="bulk-actions-bar" class="row" style="display:none;gap:8px;margin-bottom:12px;padding:12px;background:#f0f4f8;border-radius:8px;align-items:center">
              <span id="bulk-selected-count" style="font-weight:600">0 selected</span>
              <button class="btn success" onclick="openBulkActionDialog('close')">Close Selected</button>
              <button class="btn primary" onclick="openBulkActionDialog('assign')">Assign Selected</button>
              <button class="btn" onclick="openBulkActionDialog('resolve')">Resolve Selected</button>
              <button class="btn ghost" onclick="clearBulkSelection()">Clear Selection</button>
            </div>
            <table id="tickets-table"><thead><tr><th style="width:40px"><input type="checkbox" id="select-all-tickets" onchange="toggleSelectAllTickets()" title="Select All"></th><th style="width:120px;cursor:pointer" onclick="sortTicketsBy('id')">ID ⇅</th><th style="cursor:pointer" onclick="sortTicketsBy('title')">Title ⇅</th><th style="width:140px;cursor:pointer" onclick="sortTicketsBy('date')">Date/Time ⇅</th><th style="width:120px;cursor:pointer" onclick="sortTicketsBy('priority')">Priority ⇅</th><th style="width:140px;cursor:pointer" onclick="sortTicketsBy('status')">Status ⇅</th><th style="width:180px;cursor:pointer" onclick="sortTicketsBy('assignee')">Assignee ⇅</th><th style="width:160px;cursor:pointer" onclick="sortTicketsBy('customer')">Customer ⇅</th><th style="width:120px;cursor:pointer" onclick="sortTicketsBy('sla')">SLA ⇅</th></tr></thead><tbody id="list-body"></tbody></table>
            <div id="ticket-pagination" style="margin-top:12px"></div>
          </div>
        </div>

        <!-- Ticket Detail -->
        <!-- Fullscreen Exit Button (outside ticket detail to avoid overflow clipping) -->
        <button class="fullscreen-exit-btn" onclick="exitFullscreen()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="4 14 10 14 10 20"/>
            <polyline points="20 10 14 10 14 4"/>
            <line x1="14" y1="10" x2="21" y2="3"/>
            <line x1="3" y1="21" x2="10" y2="14"/>
          </svg>
          Exit Fullscreen
        </button>
        <div id="view-ticket-detail" style="display:none">
          <!-- Ticket Detail Header -->
          <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:16px;padding:20px 24px 16px;color:#fff;margin-bottom:16px;position:relative;overflow:hidden">
            <div style="position:absolute;top:-30px;right:-30px;width:140px;height:140px;background:rgba(255,255,255,.06);border-radius:50%"></div>
            <div style="position:absolute;bottom:-40px;right:80px;width:100px;height:100px;background:rgba(255,255,255,.04);border-radius:50%"></div>
            <!-- Row 1: Back | Ticket ID | Nav + Admin Toggle -->
            <div class="row mb-8" style="justify-content:space-between;align-items:center">
              <button class="btn ghost" onclick="switchView('tickets')" title="Back to list (Esc)" style="color:#fff;border-color:rgba(255,255,255,.25)">← Back</button>
              <span style="font-size:15px;font-weight:600;opacity:.9">Ticket <span id="td-id"></span></span>
              <div class="row" style="gap:8px;align-items:center">
                <div id="ticket-nav-buttons" class="row" style="gap:4px;display:none">
                  <button id="btn-prev-ticket" class="btn ghost" onclick="navigateToPrevTicket()" title="Previous ticket ([)" disabled style="color:#fff;border-color:rgba(255,255,255,.25);padding:4px 10px;font-size:12px">← Prev</button>
                  <button id="btn-next-ticket" class="btn ghost" onclick="navigateToNextTicket()" title="Next ticket (])" style="color:#fff;border-color:rgba(255,255,255,.25);padding:4px 10px;font-size:12px">Next →</button>
                </div>
                <button class="fullscreen-toggle-btn" onclick="toggleFullscreen()" title="Fullscreen mode (F)" style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.12);cursor:pointer;font-size:12px;font-weight:600;color:#fff;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 3 21 3 21 9"/>
                    <polyline points="9 21 3 21 3 15"/>
                    <line x1="21" y1="3" x2="14" y2="10"/>
                    <line x1="3" y1="21" x2="10" y2="14"/>
                  </svg>
                  Focus
                </button>
                <button id="btn-admin-view-toggle" class="btn ghost" onclick="toggleAdminView()" style="display:none;font-size:11px;padding:4px 10px;color:#fff;border-color:rgba(255,255,255,.25)" title="Toggle admin details">
                  <span id="admin-view-icon">👁</span> Admin
                </button>
              </div>
            </div>
            <!-- Row 2: Title -->
            <h2 id="td-title-display" style="margin:0 0 10px 0;font-size:22px;font-weight:700;color:#fff;line-height:1.3"></h2>
            <!-- Row 3: Metadata badges -->
            <div class="row wrap" style="gap:8px;align-items:center">
              <span id="td-meta-customer" style="font-size:13px;color:rgba(255,255,255,.8)"></span>
              <span id="td-meta-assignee" style="font-size:13px;color:rgba(255,255,255,.8)"></span>
              <span id="td-meta-priority" class="badge" style="border:none"></span>
              <span id="td-meta-status" class="badge" style="border:none"></span>
              <span id="td-meta-sla"></span>
              <span id="td-system-source-badge" class="admin-only-inline" style="display:none"></span>
            </div>
          </div>
          <!-- Actions Row -->
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px;padding:12px 16px;border-radius:12px;background:linear-gradient(135deg,rgba(99,102,241,.06),rgba(139,92,246,.04));border:1px solid rgba(99,102,241,.12);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)">
            <!-- Expert/Admin Actions -->
            <div id="expert-actions" class="row wrap" style="gap:8px;align-items:center">
              <button id="btn-pool-claim" class="btn primary" onclick="claimTicketFromDetail()" style="display:none">Claim</button>
              <button id="btn-pool-accept" class="btn success" onclick="acceptOwnership()" style="display:none">Accept & Own</button>
              <button id="btn-pool-release" class="btn" onclick="releaseClaim()" style="display:none">Release</button>
              <button id="btn-pool-takeover" class="btn primary" onclick="takeOverTicketFromDetail()" style="display:none">Take Over</button>
              <span id="pool-claimed-indicator" style="display:none;font-size:12px;color:var(--muted);padding:4px 8px;background:var(--card-hover);border-radius:4px"></span>
              <span id="pool-action-separator" style="display:none;width:1px;height:24px;background:#e5e7eb;margin:0 4px"></span>
              <button id="btn-self-assign" class="btn success" onclick="selfAssignTicket()" style="display:none">👋 Self Assign</button>
              <button id="btn-next" class="btn primary" onclick="advanceStatus()">Next status</button>
              <button id="btn-reassign" class="btn ghost" onclick="openCompletion('reassign')" style="display:none">Reassign</button>
              <button id="btn-mark-system" class="btn ghost admin-only-btn" onclick="markAsSystemMonitor()" title="Mark this ticket as a system monitoring alert">📡 Mark as System</button>
              <button id="btn-ai-assist" class="btn ai-btn" onclick="loadAISuggestions()">AI Assist</button>
              <span style="width:1px;height:24px;background:#e5e7eb;margin:0 4px"></span>
              <button id="btn-resolve" class="btn danger" onclick="openCompletion('resolve')">Resolve</button>
            </div>
            <!-- Customer Actions -->
            <div id="customer-actions" class="row wrap" style="display:none;gap:8px">
              <button id="btn-add-comment" class="btn primary" onclick="focusCommentBox()">💬 Add Comment</button>
              <button id="btn-accept-resolution" class="btn success" onclick="acceptResolution()" style="display:none">✓ Accept Resolution</button>
              <button id="btn-decline-resolution" class="btn warn" onclick="declineResolution()" style="display:none">✗ Decline Resolution</button>
              <button id="btn-customer-close" class="btn danger" onclick="customerCloseRequest()" style="display:none">Close Request</button>
            </div>
          </div>
          <!-- AI Suggestions Panel -->
          <div id="ai-panel" class="card p-16 mb-16" style="display:none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="row space mb-12">
              <div class="row" style="gap:8px">
                <span style="font-size:20px">AI</span>
                <strong style="font-size:16px">AI Assistant</strong>
              </div>
              <button class="btn ghost" onclick="hideAIPanel()" style="color:white;border-color:rgba(255,255,255,0.3)">Close</button>
            </div>
            <div id="ai-loading" style="text-align:center;padding:20px;">
              <div style="font-size:14px">Analyzing ticket...</div>
            </div>
            <div id="ai-content" style="display:none">
              <!-- Analysis Summary -->
              <div class="ai-section mb-12" style="background:rgba(255,255,255,0.1);border-radius:8px;padding:12px">
                <div style="font-weight:600;margin-bottom:8px">Analysis</div>
                <div id="ai-summary" style="font-size:14px"></div>
                <div class="row wrap" style="gap:8px;margin-top:8px">
                  <span id="ai-urgency" class="badge"></span>
                  <span id="ai-complexity" class="badge" style="background:rgba(255,255,255,0.2)"></span>
                  <span id="ai-time" class="badge" style="background:rgba(255,255,255,0.2)"></span>
                </div>
              </div>
              <!-- One-Click Actions -->
              <div class="ai-section mb-12">
                <div style="font-weight:600;margin-bottom:8px">Suggested Actions</div>
                <div id="ai-actions" class="row wrap" style="gap:8px"></div>
              </div>
              <!-- Draft Response -->
              <div class="ai-section mb-12" id="ai-draft-section" style="display:none">
                <div style="font-weight:600;margin-bottom:8px">Draft Response</div>
                <textarea id="ai-draft" class="input" style="background:rgba(255,255,255,0.9);color:#333;min-height:100px;font-size:13px"></textarea>
                <button class="btn" onclick="useAIDraft()" style="margin-top:8px;background:white;color:#764ba2">Use This Response</button>
              </div>
              <!-- Next Steps -->
              <div class="ai-section" id="ai-steps-section" style="display:none">
                <div style="font-weight:600;margin-bottom:8px">Recommended Next Steps</div>
                <ul id="ai-steps" style="margin:0;padding-left:20px;font-size:13px"></ul>
              </div>
              <!-- Warnings -->
              <div class="ai-section mt-12" id="ai-warnings-section" style="display:none;background:rgba(255,200,0,0.2);border-radius:8px;padding:12px">
                <div style="font-weight:600;margin-bottom:4px">Warnings</div>
                <div id="ai-warnings" style="font-size:13px"></div>
              </div>
            </div>
          </div>
          <div class="grid2">
            <div style="border-radius:14px;padding:20px;background:var(--card);border:1px solid var(--border);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)">
              <div class="mb-12"><div class="subtitle" style="font-weight:600;color:#667eea;font-size:12px;text-transform:uppercase;letter-spacing:.5px">Title</div><textarea id="td-title" class="input" rows="2" style="max-height:80px;overflow-y:auto;resize:vertical;border-radius:10px"></textarea></div>
              <div class="mb-12"><div class="subtitle" style="font-weight:600;color:#667eea;font-size:12px;text-transform:uppercase;letter-spacing:.5px">Description</div><textarea id="td-desc" class="input" placeholder="(Demo text)" rows="6" style="max-height:300px;overflow-y:auto;resize:vertical;border-radius:10px"></textarea></div>
              <div class="row mb-12">
                <div style="flex:1"><div class="subtitle">Priority</div><select id="td-priority" class="input"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div>
                <div style="flex:1"><div class="subtitle">Status</div><select id="td-status" class="input" disabled><option>Open</option><option>In Progress</option><option>Pending</option><option>Resolved</option></select></div>
              </div>
              <!-- Admin-only: Assignment & Customer fields -->
              <div id="admin-section-assignment" class="admin-section">
                <div id="assignee-row" class="row mb-12">
                  <div style="flex:1">
                    <div class="subtitle">Assignee</div>
                    <div style="display: flex; gap: 8px;">
                      <select id="td-assignee" class="input" style="flex: 1;">
                        <option value="">-- Select Expert --</option>
                      </select>
                      <button onclick="assignTicket()" class="btn btn-primary" style="white-space: nowrap;">Assign</button>
                    </div>
                  </div>
                  <div style="flex:1"><div class="subtitle">Due</div><input id="td-due" class="input"/></div>
                </div>
                <div class="row mb-12">
                  <div style="flex:1"><div class="subtitle">Customer</div><input id="td-customer" class="input" disabled/></div>
                  <div style="flex:1"><div class="subtitle">Linked Item</div><input id="td-item" class="input" placeholder="(optional)"/></div>
                </div>
                <div class="mb-12"><div class="subtitle">Linked CI</div><input id="td-ci" class="input" placeholder="(optional)"/></div>
              </div>

              <!-- Admin-only: SLA Details -->
              <div id="ticket-sla-details" class="admin-section">
                <div class="subtitle">SLA Details</div>
                <div id="td-sla-name" style="font-weight:600;margin-bottom:4px"></div>
                <div class="row wrap" style="align-items:center;gap:8px">
                  <span id="td-sla-badge" class="badge sla">—</span>
                  <div class="progress" id="td-sla-progress-container" style="flex:1;min-width:160px"><span id="td-sla-progress" style="width:0%"></span></div>
                </div>
                <div class="subtitle" id="td-sla-text" style="margin-top:6px"></div>
              </div>

              <!-- Classification Section (Admin Only) -->
              <div id="ticket-classification-section" class="admin-section" style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px">
                <div class="row space mb-8">
                  <div class="subtitle" style="margin:0">Classification</div>
                  <button id="btn-edit-classification" class="btn ghost" onclick="toggleClassificationEdit()" style="font-size:11px;padding:2px 8px">Edit</button>
                </div>
                <!-- Display Mode -->
                <div id="classification-display">
                  <div class="row wrap" style="gap:6px;align-items:center">
                    <span id="td-work-type-badge"></span>
                    <span id="td-exec-mode-badge" class="badge" style="background:var(--badge-bg);color:var(--muted);font-size:10px"></span>
                    <span id="td-confidence-badge" class="badge" style="background:var(--badge-bg);color:var(--muted);font-size:10px"></span>
                    <span id="td-classified-by" style="font-size:10px;color:var(--muted)"></span>
                  </div>
                  <div id="td-system-tags-display" style="margin-top:6px"></div>
                </div>
                <!-- Edit Mode -->
                <div id="classification-edit" style="display:none">
                  <div class="row mb-8" style="gap:8px">
                    <div style="flex:1">
                      <div style="font-size:11px;color:var(--muted);margin-bottom:2px">Work Type</div>
                      <select id="td-work-type" class="input" style="font-size:12px;padding:4px 8px">
                        <option value="">-- Select --</option>
                        <option value="request">Request</option>
                        <option value="incident">Incident</option>
                        <option value="problem">Problem</option>
                        <option value="change_request">Change Request</option>
                        <option value="operational_action">Operational Action</option>
                        <option value="question">Question</option>
                        <option value="feedback">Feedback</option>
                        <option value="unknown">Unknown</option>
                      </select>
                    </div>
                    <div style="flex:1">
                      <div style="font-size:11px;color:var(--muted);margin-bottom:2px">Execution Mode</div>
                      <select id="td-exec-mode" class="input" style="font-size:12px;padding:4px 8px">
                        <option value="">-- Select --</option>
                        <option value="automated">Automated</option>
                        <option value="human_review">Human Review</option>
                        <option value="expert_required">Expert Required</option>
                        <option value="escalation_required">Escalation Required</option>
                        <option value="mixed">Mixed</option>
                      </select>
                    </div>
                  </div>
                  <div class="mb-8">
                    <div style="font-size:11px;color:var(--muted);margin-bottom:2px">System Tags</div>
                    <div class="row" style="gap:4px;flex-wrap:wrap">
                      <div id="td-tags-chips" style="display:flex;gap:4px;flex-wrap:wrap"></div>
                      <input type="text" id="td-tag-input" class="input" placeholder="Add tag..." style="width:80px;font-size:11px;padding:2px 6px" onkeypress="if(event.key==='Enter'){addClassificationTag();event.preventDefault()}">
                    </div>
                  </div>
                  <div class="mb-8">
                    <div style="font-size:11px;color:var(--muted);margin-bottom:2px">Reason (optional)</div>
                    <input type="text" id="td-classification-reason" class="input" placeholder="Why are you changing this?" style="font-size:12px;padding:4px 8px">
                  </div>
                  <div class="row" style="gap:8px">
                    <button class="btn primary" onclick="saveClassification()" style="font-size:11px;padding:4px 12px">Save</button>
                    <button class="btn ghost" onclick="cancelClassificationEdit()" style="font-size:11px;padding:4px 12px">Cancel</button>
                  </div>
                </div>
              </div>
            </div>
            <div style="border-radius:14px;padding:20px;background:linear-gradient(180deg,rgba(99,102,241,.04) 0%,var(--card) 100%);border:1px solid var(--border);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)">
              <div class="row space" style="cursor:pointer" onclick="toggleActivityPanel()">
                <div style="font-size:12px;font-weight:700;color:#667eea;text-transform:uppercase;letter-spacing:.5px;margin:0">Activity Timeline</div>
                <span id="activity-toggle-icon" style="color:#9ca3af;font-size:12px">▼ Hide</span>
              </div>
              <div id="td-activity-wrapper" style="display:block">
                <div id="td-activity" class="mb-12 mt-12" style="max-height:400px;overflow-y:auto;word-break:break-word;overflow-wrap:break-word"></div>
              </div>
              <div class="row mt-12" style="gap:8px">
                <input id="td-note" class="input" placeholder="Add a note…" style="border-radius:10px"/>
                <button class="btn primary" onclick="addNote()" style="border-radius:10px;padding:8px 16px">Send</button>
              </div>
            </div>
          </div>

          <!-- Chat Transcript Section (shown when ticket has chat_session_id) -->
          <div id="td-chat-transcript-section" style="display:none;margin-top:16px;border-radius:14px;padding:20px;background:var(--card);border:1px solid var(--border)">
            <div class="row space mb-12" style="cursor:pointer" onclick="toggleChatTranscript()">
              <div style="font-size:12px;font-weight:700;color:#0ea5e9;text-transform:uppercase;letter-spacing:.5px">💬 Chat Transcript</div>
              <span id="chat-transcript-toggle" style="color:#9ca3af;font-size:12px">▼ Show</span>
            </div>
            <div id="td-chat-transcript" style="display:none;max-height:300px;overflow-y:auto;font-size:13px"></div>
          </div>

          <!-- Related CMDB Items Section (Admin Only) -->
          <div class="admin-section-card" id="cmdb-relations-section" style="margin-top:16px;border-radius:14px;padding:20px;background:var(--card);border:1px solid var(--border);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)">
            <div class="row space mb-12">
              <div class="row" style="gap:8px">
                <strong style="color:#667eea">Related CMDB Items</strong>
                <span id="cmdb-count-badge" class="badge" style="display:none">0</span>
              </div>
              <div class="row" style="gap:8px">
                <button class="btn ai-btn" onclick="findCMDBMatches()" title="Use AI to find related CMDB items">
                  AI Match CMDB
                </button>
                <button class="btn" onclick="showManualCMDBLink()">+ Link Manually</button>
              </div>
            </div>

            <!-- AI Matching Results -->
            <div id="cmdb-ai-results" style="display:none" class="mb-16">
              <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:8px;padding:16px;color:white;">
                <div class="row space mb-12">
                  <strong>AI Suggested Matches</strong>
                  <button class="btn ghost" onclick="hideCMDBMatches()" style="color:white;border-color:rgba(255,255,255,0.3);padding:4px 8px;font-size:12px">Close</button>
                </div>
                <div id="cmdb-ai-loading" style="text-align:center;padding:16px;">Analyzing ticket for CMDB matches...</div>
                <div id="cmdb-ai-content" style="display:none">
                  <div id="cmdb-ai-reasoning" class="mb-12" style="font-size:13px;opacity:0.9;"></div>
                  <div id="cmdb-ai-items" class="mb-12"></div>
                  <div id="cmdb-ai-cis"></div>
                  <div class="row" style="gap:8px;margin-top:12px">
                    <button class="btn" onclick="applyAllCMDBMatches()" style="background:white;color:#764ba2">Apply All Selected</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Linked CMDB Items Table -->
            <div id="linked-cmdb-loading" style="text-align:center;padding:16px;color:var(--muted);display:none;">Loading linked items...</div>
            <div id="linked-cmdb-empty" style="text-align:center;padding:24px;color:var(--muted);">
              <div style="font-size:32px;margin-bottom:8px;">📦</div>
              <div>No CMDB items linked to this ticket</div>
              <div style="font-size:12px;margin-top:4px;">Use "AI Match CMDB" to find related infrastructure</div>
            </div>
            <table id="linked-cmdb-table" style="display:none">
              <thead>
                <tr>
                  <th>Asset Name</th>
                  <th>Category</th>
                  <th>Customer</th>
                  <th>Matched By</th>
                  <th style="width:80px"></th>
                </tr>
              </thead>
              <tbody id="linked-cmdb-body"></tbody>
            </table>

            <!-- Linked CIs Section -->
            <div id="linked-cis-section" style="display:none;margin-top:16px;border-top:1px solid var(--border);padding-top:16px;">
              <div class="subtitle mb-8"><strong>Linked Configuration Items</strong></div>
              <table id="linked-cis-table">
                <thead>
                  <tr>
                    <th>Field Name</th>
                    <th>Value</th>
                    <th>Parent Asset</th>
                    <th style="width:80px"></th>
                  </tr>
                </thead>
                <tbody id="linked-cis-body"></tbody>
              </table>
            </div>

            <!-- AI CMDB Suggestions Section -->
            <div id="ai-cmdb-suggestions-section" style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px;">
              <div class="row space mb-12">
                <div class="row" style="gap:8px">
                  <strong style="color:#9f7aea">🤖 AI Suggested CMDB Matches</strong>
                  <span id="ai-cmdb-suggestions-badge" class="badge" style="background:#9f7aea;color:white;display:none">0</span>
                </div>
                <div class="row" style="gap:8px" id="ai-cmdb-bulk-actions" style="display:none">
                  <button class="btn" onclick="acceptAllCMDBSuggestions()" style="font-size:12px;padding:4px 8px;">✓ Accept All</button>
                  <button class="btn ghost" onclick="dismissAllCMDBSuggestions()" style="font-size:12px;padding:4px 8px;">✕ Dismiss All</button>
                </div>
                <button class="btn ghost" onclick="triggerCMDBAnalysis()" id="ai-cmdb-reanalyze-btn" style="font-size:12px;padding:4px 8px;display:none">🔄 Re-analyze</button>
              </div>

              <!-- Analyzing Status -->
              <div id="ai-cmdb-analyzing" style="display:none;padding:16px;background:linear-gradient(135deg,#667eea10,#764ba210);border-radius:8px;text-align:center;">
                <div style="display:flex;align-items:center;justify-content:center;gap:8px;">
                  <span style="width:16px;height:16px;border:2px solid #764ba2;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;"></span>
                  <span style="color:#764ba2;font-weight:500;">Analyzing ticket for CMDB matches...</span>
                </div>
              </div>

              <!-- No Suggestions Message -->
              <div id="ai-cmdb-no-suggestions" style="display:none;padding:16px;text-align:center;color:var(--muted);">
                <div style="font-size:24px;margin-bottom:8px;">✨</div>
                <div>No AI suggestions for this ticket</div>
                <div style="font-size:12px;margin-top:4px;">Click "Re-analyze" to search for CMDB matches</div>
              </div>

              <!-- Suggestions List -->
              <div id="ai-cmdb-suggestions-list"></div>
            </div>
          </div>

          <!-- Knowledge Base Suggestions Section (Admin Only) -->
          <div class="admin-section-card" id="kb-suggestions-section" style="margin-top:16px;border-radius:14px;padding:20px;background:var(--card);border:1px solid var(--border);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)">
            <div class="row space mb-12">
              <div class="row" style="gap:8px">
                <strong>📚 Suggested KB Articles</strong>
                <span id="kb-suggestions-badge" class="badge" style="display:none">0</span>
              </div>
              <button class="btn" onclick="loadKBSuggestions()" title="Find related KB articles">
                🔍 Find Articles
              </button>
            </div>
            <div id="kb-suggestions-loading" style="display:none;text-align:center;padding:16px;color:var(--muted);">
              Searching for relevant articles...
            </div>
            <div id="kb-suggestions-empty" style="text-align:center;padding:24px;color:var(--muted);">
              <div style="font-size:32px;margin-bottom:8px;">📚</div>
              <div>No KB articles suggested yet</div>
              <div style="font-size:12px;margin-top:4px;">Click "Find Articles" to search for relevant knowledge</div>
            </div>
            <div id="kb-suggestions-list" style="display:none;"></div>
          </div>

          <!-- Manual CMDB Link Modal -->
          <div id="modal-cmdb-link" class="modal">
            <div class="sheet" style="max-width:600px">
              <div class="head">Link CMDB Item to Ticket</div>
              <div class="body">
                <div class="mb-12">
                  <div class="subtitle">Search CMDB Items</div>
                  <input id="cmdb-link-search" class="input" placeholder="Search by asset name, customer, category..." oninput="searchCMDBForLink()"/>
                </div>
                <div id="cmdb-link-results" style="max-height:300px;overflow:auto;">
                  <div style="text-align:center;padding:20px;color:var(--muted);">Enter search terms to find CMDB items</div>
                </div>
              </div>
              <div class="foot">
                <button class="btn" onclick="closeModal('modal-cmdb-link')">Cancel</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Experts List -->
        <div id="view-experts" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Manage Experts</h3></div>
            <div class="row" style="gap:8px">
              <button class="btn primary" onclick="showCreateExpertForm()">+ Add Expert</button>
              <button class="btn" onclick="showBulkImportModal()">Import</button>
              <button class="btn" onclick="showInviteExpertModal()">Invite</button>
              <input id="expert-search" class="input filter-search filter-compact" style="min-width:220px" placeholder="Search experts..." oninput="onExpertFilterChange()"/>
            </div>
          </div>
          <!-- Expert tabs -->
          <div class="row mb-16" style="gap:8px">
            <button id="tab-active-experts" class="btn primary" onclick="showActiveExperts()">Active Experts</button>
            <button id="tab-invited-experts" class="btn ghost" onclick="showInvitedExperts()">Invited</button>
            <button id="tab-deleted-experts" class="btn ghost" onclick="showDeletedExperts()">Deleted</button>
          </div>
          <div class="row" style="margin-bottom:12px">
            <div id="expert-count" class="subtitle">Showing 0 experts</div>
          </div>
          <!-- Active experts table (Desktop) -->
          <div id="active-experts-section">
            <div class="card p-16 hide-mobile">
              <table>
                <thead>
                  <tr>
                    <th style="cursor:pointer" onclick="sortExpertsBy('full_name')">Real Name <span id="expert-sort-full_name">▲</span></th>
                    <th style="cursor:pointer" onclick="sortExpertsBy('username')">Username <span id="expert-sort-username"></span></th>
                    <th style="cursor:pointer" onclick="sortExpertsBy('location')">Location <span id="expert-sort-location"></span></th>
                    <th style="cursor:pointer" onclick="sortExpertsBy('email')">Email <span id="expert-sort-email"></span></th>
                    <th style="cursor:pointer" onclick="sortExpertsBy('open_tickets')">Open Tickets <span id="expert-sort-open_tickets"></span></th>
                    <th style="cursor:pointer" onclick="sortExpertsBy('last_login')">Last Login <span id="expert-sort-last_login"></span></th>
                    <th style="width:180px">Actions</th>
                  </tr>
                </thead>
                <tbody id="experts-body"></tbody>
              </table>
              <div id="expert-pagination" style="margin-top:12px"></div>
            </div>
            <!-- Mobile card view -->
            <div id="experts-cards" class="mobile-cards show-mobile"></div>
          </div>
          <!-- Invited experts section -->
          <div id="invited-experts-section" style="display:none">
            <div class="card p-16">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Invited</th>
                    <th>Expires</th>
                    <th>Status</th>
                    <th style="width:180px">Actions</th>
                  </tr>
                </thead>
                <tbody id="invited-experts-body"></tbody>
              </table>
            </div>
          </div>
          <!-- Deleted experts section -->
          <div id="deleted-experts-section" style="display:none">
            <div class="card p-16">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th style="width:180px">Actions</th>
                  </tr>
                </thead>
                <tbody id="deleted-experts-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Expert Detail View -->
        <div id="view-expert-detail" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('experts')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Expert Details</h3></div>
            <div class="row" style="gap:8px">
              <button class="btn primary" onclick="editExpert()">Edit Expert</button>
              <button class="btn danger" onclick="deleteExpertPrompt()">Delete</button>
            </div>
          </div>

          <!-- Account Info Section -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">Account Info</h4>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Expert Type:</div><div id="expert-role" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Username:</div><div id="expert-username" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Account Status:</div><div id="expert-status" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Email Updates:</div><div id="expert-email-updates" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Reference Code:</div><div id="expert-reference" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Open Tickets:</div><div id="expert-open-tickets" style="font-weight:600"></div></div>
          </div>

          <!-- Account Statistics -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">Account Statistics</h4>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Created By:</div><div id="expert-created-by" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Updated By:</div><div id="expert-updated-by" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Created:</div><div id="expert-created-at" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Updated:</div><div id="expert-updated-at" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Last Login:</div><div id="expert-last-login" style="font-weight:600"></div></div>
          </div>

          <!-- System Settings -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">System Settings</h4>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Time Zone:</div><div id="expert-timezone" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Support Language:</div><div id="expert-language" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Interface Language:</div><div id="expert-interface-lang" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Security Level:</div><div id="expert-security-level" style="font-weight:600"></div></div>
          </div>

          <!-- Ticket Permissions -->
          <div class="card p-16 mb-16">
            <div class="row space mb-12">
              <h4 style="margin:0">Ticket Permissions</h4>
              <button class="btn primary small" onclick="showExpertPermissionsModal()">Manage Permissions</button>
            </div>
            <div id="expert-permissions-list">
              <div class="subtitle" style="color:#999">Loading permissions...</div>
            </div>
          </div>

          <!-- User Details -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">User Details</h4>
            <div class="row mb-8"><div class="subtitle" style="width:180px">First Name:</div><div id="expert-first-name" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Middle Name:</div><div id="expert-middle-name" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Last Name:</div><div id="expert-last-name" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Screen Name:</div><div id="expert-screen-name" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Street Address:</div><div id="expert-street" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">City:</div><div id="expert-city" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">State/Province:</div><div id="expert-state" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Postal Code:</div><div id="expert-postcode" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Country:</div><div id="expert-country" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Contact Number:</div><div id="expert-contact" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Location:</div><div id="expert-location" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Department:</div><div id="expert-department" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Email:</div><div id="expert-email" style="font-weight:600"></div></div>
          </div>
        </div>

        <!-- Customers -->
        <div id="view-customers" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Manage Customers</h3></div>
            <div class="row" style="gap:8px">
              <button class="btn ghost" onclick="showManageCompanies()">Manage Companies</button>
              <button class="btn primary" onclick="showCreateCustomerCompanyForm()">+ Add Company</button>
              <button class="btn" onclick="showCreateCustomerForm()">+ Add Team Member</button>
            </div>
          </div>
          <!-- Compact Filter Bar -->
          <div class="filter-bar" id="customer-filters-bar">
            <input id="cust-search" class="input filter-search filter-compact" placeholder="Search customers..." oninput="onCustomerFilterChange()">

            <div class="filter-group filter-collapsible">
              <select id="cust-filter-company" class="input filter-compact" onchange="onCustomerFilterChange()">
                <option value="">All Companies</option>
              </select>

              <select id="cust-filter-sla" class="input filter-compact" onchange="onCustomerFilterChange()">
                <option value="">All SLA</option>
                <option value="basic">Basic</option>
                <option value="premium">Premium</option>
                <option value="enterprise">Enterprise</option>
              </select>

              <select id="cust-filter-status" class="input filter-compact" onchange="onCustomerFilterChange()">
                <option value="">All</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>

              <button class="btn-clear" onclick="clearCustomerFilters()">Clear</button>
            </div>

            <button class="filter-toggle btn ghost" onclick="toggleFilterBar(this)">+ Filters</button>

            <span id="customer-count" class="subtitle" style="margin-left:auto">0 customers</span>
          </div>
          <!-- Desktop table view -->
          <div class="card p-16 hide-mobile">
            <table><thead><tr><th style="cursor:pointer" onclick="sortCustomersBy('name')">Name ⇅</th><th>Email</th><th>Company</th><th>Role</th><th style="width:80px;cursor:pointer" onclick="sortCustomersBy('tickets')"># Tickets ⇅</th><th>SLA</th><th style="width:60px;text-align:center" title="Email Notifications">📧</th><th style="width:180px">Actions</th></tr></thead><tbody id="customers-body"></tbody></table>
            <div id="customer-pagination" style="margin-top:12px"></div>
          </div>
          <!-- Mobile card view -->
          <div id="customers-cards" class="mobile-cards show-mobile"></div>
        </div>

        <!-- Customer Form Modal -->
        <div id="customer-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;align-items:flex-start;justify-content:center;padding:40px 16px">
          <div style="max-width:600px;width:100%;background:white;border-radius:8px;padding:24px">
            <div class="row space mb-16">
              <h3 id="customer-modal-title" class="title" style="margin:0">Add Customer</h3>
              <button class="btn ghost" onclick="closeCustomerModal()">✕</button>
            </div>

            <form id="customer-form" onsubmit="saveCustomer(event); return false;">
              <input type="hidden" id="customer-id"/>

              <h4 class="mb-12">Account Information</h4>

              <div class="mb-12">
                <label class="subtitle">Username *</label>
                <input id="customer-username" class="input" required placeholder="e.g., john_doe" pattern="[a-zA-Z0-9_]+" title="Only letters, numbers, and underscores"/>
                <div class="subtitle" style="color:#6b7280;font-size:12px;margin-top:4px">Used for login. Only letters, numbers, and underscores.</div>
              </div>

              <div class="mb-12">
                <label class="subtitle">Email *</label>
                <input id="customer-email" class="input" type="email" required placeholder="e.g., john@example.com"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Full Name</label>
                <input id="customer-fullname" class="input" placeholder="e.g., John Doe"/>
              </div>

              <h4 class="mb-12 mt-16">Company Information</h4>

              <div class="mb-12">
                <label class="subtitle">Company Name *</label>
                <input id="customer-company" class="input" required placeholder="e.g., Acme Corporation"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Company Domain *</label>
                <input id="customer-domain" class="input" required placeholder="e.g., example.com" pattern="[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?(\.[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?)*\.[a-zA-Z]{2,}" title="Valid domain like example.com"/>
                <div class="subtitle" style="color:#6b7280;font-size:12px;margin-top:4px">Email domain for incoming ticket matching (e.g., if domain is "example.com", emails from user@example.com will create tickets).</div>
              </div>

              <div class="mb-12">
                <label class="subtitle">Contact Phone</label>
                <input id="customer-phone" class="input" type="tel" placeholder="e.g., +1-555-0123"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Address</label>
                <textarea id="customer-address" class="input" rows="3" placeholder="Company address"></textarea>
              </div>

              <div class="mb-12">
                <label class="subtitle">SLA Level</label>
                <select id="customer-sla" class="input">
                  <option value="basic">Basic (48h response)</option>
                  <option value="premium">Premium (24h response)</option>
                  <option value="enterprise">Enterprise (4h response)</option>
                </select>
              </div>

              <div class="mb-12" style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="customer-admin-emails" checked/>
                <label class="subtitle" for="customer-admin-emails" style="margin:0">Admin receives member ticket emails</label>
              </div>

              <div class="mb-12" style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="customer-members-emails" checked/>
                <label class="subtitle" for="customer-members-emails" style="margin:0">Members receive email notifications</label>
              </div>

              <div id="customer-form-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
              <div id="customer-form-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>

              <div class="row" style="gap:8px;margin-top:24px;justify-content:flex-end">
                <button type="button" class="btn ghost" onclick="closeCustomerModal()">Cancel</button>
                <button type="submit" class="btn primary">
                  <span id="customer-save-btn-text">Create Customer</span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Customer Company Form Modal -->
        <div id="company-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;align-items:flex-start;justify-content:center;padding:40px 16px">
          <div style="max-width:600px;width:100%;background:white;border-radius:8px;padding:24px">
            <div class="row space mb-16">
              <h3 id="company-modal-title" class="title" style="margin:0">Add Customer Company</h3>
              <button class="btn ghost" onclick="closeCompanyModal()">✕</button>
            </div>

            <form id="company-form" onsubmit="saveCustomerCompany(event); return false;">
              <input type="hidden" id="company-id"/>

              <p class="subtitle mb-16">Create a new customer company. An admin user will be automatically created with email admin@{domain}.</p>

              <div class="mb-12">
                <label class="subtitle">Company Name *</label>
                <input id="company-name" class="input" required placeholder="e.g., Acme Corporation"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Company Domain *</label>
                <input id="company-domain" class="input" required placeholder="e.g., acme.com" pattern="[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?(\.[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?)*\.[a-zA-Z]{2,}" title="Valid domain like example.com"/>
                <div class="subtitle" style="color:#6b7280;font-size:12px;margin-top:4px">Admin email will be: admin@{domain}</div>
              </div>

              <div class="mb-12">
                <label class="subtitle">Contact Phone</label>
                <input id="company-phone" class="input" type="tel" placeholder="e.g., +1-555-0123"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Address</label>
                <textarea id="company-address" class="input" rows="3" placeholder="Company address"></textarea>
              </div>

              <div class="mb-12">
                <label class="subtitle">SLA Level</label>
                <select id="company-sla" class="input">
                  <option value="basic">Basic (48h response)</option>
                  <option value="premium">Premium (24h response)</option>
                  <option value="enterprise">Enterprise (4h response)</option>
                </select>
              </div>

              <div class="mb-12" style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="company-admin-emails" checked/>
                <label class="subtitle" for="company-admin-emails" style="margin:0">Admin receives member ticket emails</label>
              </div>

              <div class="mb-12" style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="company-members-emails" checked/>
                <label class="subtitle" for="company-members-emails" style="margin:0">Members receive email notifications</label>
              </div>

              <div class="mb-12">
                <label class="subtitle">Notes</label>
                <textarea id="company-notes" class="input" rows="2" placeholder="Internal notes about this company"></textarea>
              </div>

              <div id="company-form-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
              <div id="company-form-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>

              <div class="row" style="gap:8px;margin-top:24px;justify-content:flex-end">
                <button type="button" class="btn ghost" onclick="closeCompanyModal()">Cancel</button>
                <button type="submit" class="btn primary">
                  <span id="company-save-btn-text">Create Company</span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Company Management Modal -->
        <div id="company-list-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;align-items:flex-start;justify-content:center;padding:40px 16px">
          <div style="max-width:800px;width:100%;background:white;border-radius:8px;padding:24px">
            <div class="row space mb-16">
              <h3 class="title" style="margin:0">Manage Companies</h3>
              <button class="btn ghost" onclick="closeCompanyListModal()">✕</button>
            </div>

            <p class="subtitle mb-16">View, edit, and delete customer companies. Companies with active team members cannot be deleted.</p>

            <div id="company-list-content">
              <table>
                <thead>
                  <tr>
                    <th>Company Name</th>
                    <th>Domain</th>
                    <th>SLA Level</th>
                    <th style="text-align:center">Team Members</th>
                    <th style="width:180px">Actions</th>
                  </tr>
                </thead>
                <tbody id="company-list-body">
                  <tr><td colspan="5" style="text-align:center">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Expert Permissions Modal -->
        <div id="expert-permissions-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;align-items:flex-start;justify-content:center;padding:40px 16px">
          <div style="max-width:700px;width:100%;background:white;border-radius:8px;padding:24px">
            <div class="row space mb-16">
              <h3 style="margin:0">Manage Ticket Permissions</h3>
              <button class="btn ghost small" onclick="closeExpertPermissionsModal()">✕</button>
            </div>

            <p class="subtitle mb-16">Configure which tickets this expert can view and self-assign.</p>

            <!-- Current Permissions -->
            <div class="card p-12 mb-16" style="background:#f9fafb">
              <h4 class="mb-12">Current Permissions</h4>
              <div id="current-permissions-list">
                <div class="subtitle" style="color:#999">Loading...</div>
              </div>
            </div>

            <!-- Add New Permission -->
            <div class="card p-16">
              <h4 class="mb-12">Add New Permission</h4>

              <div class="mb-12">
                <label class="subtitle">Permission Type</label>
                <select id="perm-type" class="input" onchange="updatePermissionForm()">
                  <option value="">Select permission type...</option>
                  <option value="all_tickets">All Tickets</option>
                  <option value="specific_customers">Specific Customer</option>
                  <option value="title_patterns">Title Pattern</option>
                </select>
              </div>

              <!-- Customer Selection (shown when specific_customers is selected) -->
              <div id="perm-customer-section" style="display:none" class="mb-12">
                <label class="subtitle">Customer</label>
                <select id="perm-customer" class="input">
                  <option value="">Select customer...</option>
                </select>
              </div>

              <!-- Title Pattern Input (shown when title_patterns is selected) -->
              <div id="perm-pattern-section" style="display:none" class="mb-12">
                <label class="subtitle">Title Pattern</label>
                <input id="perm-pattern" class="input" placeholder="e.g., 'Password Reset' or 'Network'" />
                <div class="subtitle" style="color:#666;margin-top:4px">Expert will see tickets containing this text in the title</div>
              </div>

              <div id="perm-form-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
              <div id="perm-form-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>

              <div class="row" style="gap:8px;margin-top:16px;justify-content:flex-end">
                <button class="btn primary" onclick="addExpertPermission()">Add Permission</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Elevation / Reauth Modal (System Admin Tools) -->
        <div id="reauth-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;align-items:flex-start;justify-content:center;padding:40px 16px">
          <div style="max-width:400px;width:100%;background:var(--card);border-radius:12px;padding:24px;box-shadow:0 20px 40px rgba(0,0,0,0.2)">
            <div class="row space mb-16">
              <h3 style="margin:0">System Admin Authentication</h3>
              <button class="btn ghost small" onclick="closeReauthModal()">&#x2715;</button>
            </div>
            <p class="subtitle mb-16">System Admin Tools contain sensitive configuration. Please re-enter your password to continue.</p>
            <div class="mb-16">
              <label class="subtitle">Password</label>
              <input type="password" id="reauth-password" class="input" placeholder="Enter your password" onkeydown="if(event.key==='Enter')submitReauth()">
            </div>
            <div id="reauth-error" style="display:none;color:var(--error);font-size:13px;margin-bottom:12px"></div>
            <div class="row" style="gap:8px;justify-content:flex-end">
              <button class="btn ghost" onclick="closeReauthModal()">Cancel</button>
              <button class="btn primary" onclick="submitReauth()">Continue</button>
            </div>
          </div>
        </div>

        <!-- Asset Viewer Password Modal -->
        <div id="av-password-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;align-items:flex-start;justify-content:center;padding:40px 16px">
          <div style="max-width:400px;width:100%;background:var(--card);border-radius:12px;padding:24px;box-shadow:0 20px 40px rgba(0,0,0,0.2)">
            <div class="row space mb-16">
              <h3 style="margin:0">Asset Viewer Access</h3>
              <button class="btn ghost small" onclick="closeAvPasswordModal()">&#x2715;</button>
            </div>
            <p class="subtitle mb-16">Asset Viewer requires an elevated access password to continue.</p>
            <div class="mb-16">
              <label class="subtitle">Access Password</label>
              <input type="password" id="av-password-input" class="input" placeholder="Enter access password" onkeydown="if(event.key==='Enter')submitAvPassword()">
            </div>
            <div id="av-password-error" style="display:none;color:var(--error);font-size:13px;margin-bottom:12px"></div>
            <div class="row" style="gap:8px;justify-content:flex-end">
              <button class="btn ghost" onclick="closeAvPasswordModal()">Cancel</button>
              <button class="btn primary" onclick="submitAvPassword()">Continue</button>
            </div>
          </div>
        </div>

        <!-- CMDB Hub (no in-content sub-menu, uses collapsible left nav) -->
        <div id="view-cmdb-hub" style="display:none">
          <div id="cmdb-section-items" class="cmdb-section"></div>
          <div id="cmdb-section-types" class="cmdb-section" style="display:none"></div>
          <div id="cmdb-section-management" class="cmdb-section" style="display:none"></div>
          <!-- Asset Viewer Section -->
          <div id="cmdb-section-assetviewer" class="cmdb-section" style="display:none">
            <!-- Header -->
            <div class="av-header-row">
              <h3 class="title" style="margin:0">Asset Viewer</h3>
              <div class="row" style="align-items:center">
                <button id="av-export-btn" class="av-export-btn" onclick="avExportCSV()">
                  📥 Export to CSV
                </button>
                <span id="av-export-info" class="av-export-info">Exports all assets</span>
              </div>
            </div>

            <!-- Two-Panel Layout -->
            <div class="av-container">
              <!-- Left: Asset Grid -->
              <div class="av-grid-panel">
                <table id="av-table" class="display" style="width:100%">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Asset Name</th>
                      <th>Category</th>
                      <th>Brand</th>
                      <th>Model</th>
                      <th>Customer</th>
                      <th>Location</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <!-- Right: Detail Panel -->
              <div id="av-detail-panel" class="av-detail-panel">
                <div class="av-detail-header">
                  <span id="av-detail-title">Asset Details</span>
                  <div class="av-header-actions">
                    <button id="av-edit-btn" class="av-edit-btn" onclick="avEnterEditMode()">✏️ Edit</button>
                    <span class="av-detail-close" onclick="avCloseDetail()">×</span>
                  </div>
                </div>
                <div id="av-detail-content" class="av-detail-content">
                  <div class="av-loading">Select an asset to view details</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CMDB (original - content will be moved to hub) -->
        <div id="view-cmdb" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">CMDB Items</h3></div>
            <div class="row" style="gap:8px">
              <a href="/public/cmdb-management.html" class="btn primary" target="_blank">Open CMDB Management</a>
              <input id="cmdb-search" class="input" style="min-width:260px" placeholder="Search by Item or Customer" oninput="onCMDBFilterChange()"/>
              <select id="cmdb-customer" class="input" style="max-width:220px" onchange="onCMDBFilterChange()">
                <option value="">All customers</option>
              </select>
            </div>
          </div>
          <div class="row" style="margin-bottom:12px">
            <div id="cmdb-count" class="subtitle">Showing 0 items</div>
          </div>
          <div class="card p-16">
            <div id="cmdb-loading" style="text-align:center;padding:40px;color:var(--muted);">Loading CMDB items...</div>
            <table id="cmdb-table" style="display:none">
              <thead><tr><th style="width:180px;cursor:pointer" onclick="cmdbSort('customer_name')">Customer <span id="cmdb-sort-customer_name"></span></th><th style="cursor:pointer" onclick="cmdbSort('asset_name')">Asset Name <span id="cmdb-sort-asset_name">▲</span></th><th style="cursor:pointer" onclick="cmdbSort('asset_category')">Category <span id="cmdb-sort-asset_category"></span></th><th style="cursor:pointer" onclick="cmdbSort('brand_name')">Brand/Model <span id="cmdb-sort-brand_name"></span></th><th style="width:60px">CIs</th><th style="width:120px"><div style="display:flex;align-items:center;gap:4px;font-size:12px;">Tickets<button class="btn ghost" style="padding:2px 6px;font-size:10px;" id="cmdbTicketToggle" onclick="toggleCMDBTicketMode()">All</button></div></th><th style="width:100px"></th></tr></thead>
              <tbody id="cmdb-body"></tbody>
            </table>
            <div id="cmdb-pagination" style="margin-top:12px"></div>
            <div id="cmdb-empty" style="display:none;text-align:center;padding:40px;color:var(--muted);">
              <div style="font-size:48px;margin-bottom:16px;">🗃️</div>
              <div>No CMDB items found</div>
              <div style="margin-top:8px;font-size:13px;">Use <a href="/public/cmdb-management.html" target="_blank">CMDB Management</a> to import or add items</div>
            </div>
          </div>
        </div>

        <div id="view-cmdb-detail" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="openCmdb('cmdb-section-items')">← Back</button><h3 class="title" style="margin:0 0 0 8px">CMDB Item: <span id="cmdb-name-h"></span></h3></div>
          </div>
          <div class="card p-16 mb-16">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;">
              <div><div class="subtitle">Customer</div><div id="cmdb-customer-h" style="font-weight:600;font-size:15px;"></div></div>
              <div><div class="subtitle">Category</div><div id="cmdb-category-h" style="font-weight:600;font-size:15px;"></div></div>
              <div><div class="subtitle">Brand</div><div id="cmdb-brand-h" style="font-weight:600;font-size:15px;"></div></div>
              <div><div class="subtitle">Model</div><div id="cmdb-model-h" style="font-weight:600;font-size:15px;"></div></div>
              <div><div class="subtitle">Location</div><div id="cmdb-location-h" style="font-weight:600;font-size:15px;"></div></div>
              <div><div class="subtitle">CMDB ID</div><div id="cmdb-id-h" style="font-weight:500;font-size:12px;color:var(--muted);"></div></div>
            </div>
            <div id="cmdb-comment-section" style="margin-top:16px;display:none;">
              <div class="subtitle">Comment</div>
              <div id="cmdb-comment-h" style="font-size:14px;color:var(--text);white-space:pre-wrap;background:var(--bg);padding:12px;border-radius:6px;border:1px solid var(--border);"></div>
            </div>
          </div>

          <!-- CMDB Detail Tabs -->
          <div class="card p-16">
            <div class="row mb-16" style="gap:8px;border-bottom:1px solid var(--border);padding-bottom:12px">
              <button class="btn cmdb-tab active" data-tab="ci" onclick="switchCMDBDetailTab('ci')">Config Items (<span id="ci-count">0</span>)</button>
              <button class="btn cmdb-tab" data-tab="custom-fields" onclick="switchCMDBDetailTab('custom-fields')">Custom Fields</button>
              <button class="btn cmdb-tab" data-tab="relationships" onclick="switchCMDBDetailTab('relationships')">Relationships (<span id="rel-count">0</span>)</button>
              <button class="btn cmdb-tab" data-tab="history" onclick="switchCMDBDetailTab('history')">History</button>
            </div>

            <!-- Configuration Items Tab -->
            <div id="cmdb-tab-ci" class="cmdb-tab-content">
              <div id="ci-loading" style="text-align:center;padding:20px;color:var(--muted);">Loading configuration items...</div>
              <table id="ci-table" style="display:none"><thead id="ci-head"></thead><tbody id="ci-body"></tbody></table>
              <div id="ci-empty" style="display:none;text-align:center;padding:20px;color:var(--muted);">No configuration items for this asset</div>
            </div>

            <!-- Custom Fields Tab -->
            <div id="cmdb-tab-custom-fields" class="cmdb-tab-content" style="display:none">
              <div id="custom-values-loading" style="text-align:center;padding:20px;color:var(--muted);">Loading custom fields...</div>
              <div id="custom-values-form" style="display:none">
                <div id="custom-values-fields"></div>
                <div class="row mt-16" style="gap:8px">
                  <button class="btn primary" onclick="saveCustomFieldValues()">Save Changes</button>
                  <span id="custom-values-message" class="subtitle" style="color:#16a34a;display:none"></span>
                </div>
              </div>
              <div id="custom-values-empty" style="display:none;text-align:center;padding:20px;color:var(--muted);">
                <div>No custom fields defined for this category</div>
                <div style="margin-top:8px;font-size:13px">Go to Admin Settings → CMDB Custom Fields to define fields</div>
              </div>
            </div>

            <!-- Relationships Tab -->
            <div id="cmdb-tab-relationships" class="cmdb-tab-content" style="display:none">
              <div class="row space mb-12">
                <div class="subtitle">Asset Dependencies & Connections</div>
                <div class="row" style="gap:8px">
                  <button class="btn" onclick="showImpactAnalysisModal()">🔍 Impact Analysis</button>
                  <button class="btn primary" onclick="showAddRelationshipModal()">+ Add Relationship</button>
                </div>
              </div>
              <div id="relationships-loading" style="text-align:center;padding:20px;color:var(--muted);">Loading relationships...</div>

              <!-- Outgoing Relationships -->
              <div id="relationships-outgoing" style="display:none">
                <h5 class="subtitle mb-8" style="font-weight:600">Outgoing Relationships (This asset...)</h5>
                <table id="outgoing-rel-table">
                  <thead><tr><th>Type</th><th>Related Asset</th><th>Category</th><th>Status</th><th>Actions</th></tr></thead>
                  <tbody id="outgoing-rel-body"></tbody>
                </table>
                <div id="outgoing-rel-empty" style="display:none;padding:12px;color:var(--muted);font-size:13px">No outgoing relationships</div>
              </div>

              <!-- Incoming Relationships -->
              <div id="relationships-incoming" style="display:none;margin-top:16px">
                <h5 class="subtitle mb-8" style="font-weight:600">Incoming Relationships (Other assets...)</h5>
                <table id="incoming-rel-table">
                  <thead><tr><th>Type</th><th>Related Asset</th><th>Category</th><th>Status</th><th>Actions</th></tr></thead>
                  <tbody id="incoming-rel-body"></tbody>
                </table>
                <div id="incoming-rel-empty" style="display:none;padding:12px;color:var(--muted);font-size:13px">No incoming relationships</div>
              </div>

              <div id="relationships-empty" style="display:none;text-align:center;padding:30px;color:var(--muted);">
                <div style="font-size:32px;margin-bottom:12px">🔗</div>
                <div>No relationships defined</div>
                <div style="margin-top:8px;font-size:13px">Click "Add Relationship" to link this asset to other CMDB items</div>
              </div>
            </div>

            <!-- History Tab -->
            <div id="cmdb-tab-history" class="cmdb-tab-content" style="display:none">
              <div class="row space mb-12">
                <div class="subtitle">Change History</div>
                <div class="row" style="gap:8px">
                  <select id="history-type-filter" class="input" style="max-width:180px" onchange="loadCMDBHistory()">
                    <option value="">All Changes</option>
                    <option value="created">Created</option>
                    <option value="updated">Updated</option>
                    <option value="relationship_added">Relationship Added</option>
                    <option value="relationship_removed">Relationship Removed</option>
                    <option value="custom_field_updated">Custom Field Updated</option>
                  </select>
                  <button class="btn" onclick="loadCMDBHistory()">Refresh</button>
                </div>
              </div>
              <div id="history-loading" style="text-align:center;padding:20px;color:var(--muted);">Loading history...</div>
              <div id="history-timeline" style="display:none"></div>
              <div id="history-empty" style="display:none;text-align:center;padding:30px;color:var(--muted);">
                <div style="font-size:32px;margin-bottom:12px">📜</div>
                <div>No change history</div>
              </div>
              <div id="history-pagination" class="row" style="justify-content:center;gap:8px;margin-top:16px;display:none">
                <button class="btn" id="history-prev-btn" onclick="loadCMDBHistoryPage(-1)">Previous</button>
                <span id="history-page-info" class="subtitle"></span>
                <button class="btn" id="history-next-btn" onclick="loadCMDBHistoryPage(1)">Next</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Manage CMDB Types -->
        <div id="view-manage-cmdb" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Manage CMDB Types</h3></div>
            <button class="btn primary" onclick="showCreateItemTypeForm()">+ Add Item Type</button>
          </div>
          
          <!-- CMDB Item Types List -->
          <div class="card p-16 mb-16">
            <h4>CMDB Item Types</h4>
            <table class="mt-16">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>CI Types</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="item-types-body"></tbody>
            </table>
          </div>

          <!-- CI Types List (shown when item type is selected) -->
          <div class="card p-16" id="ci-types-section" style="display:none">
            <div class="row space mb-12">
              <div class="row">
                <h4>CI Types for: <span id="selected-item-type-name"></span></h4>
              </div>
              <button class="btn primary" onclick="showCreateCITypeForm()">+ Add CI Type</button>
            </div>
            <table class="mt-16">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ci-types-body"></tbody>
            </table>
          </div>
        </div>

        <!-- CMDB Management -->
        <div id="view-cmdb-mgmt" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">CMDB Management</h3></div>
            <div class="row" style="gap:8px">
              <button id="cmdb-mgmt-delete-all-btn" class="btn danger" onclick="cmdbMgmtDeleteAll()" style="background:#e53e3e;">🗑️ Delete All</button>
              <button class="btn success" onclick="cmdbMgmtOpenImport()">📥 Import CSV</button>
              <button class="btn primary" onclick="cmdbMgmtOpenCreate()">➕ Add CMDB Item</button>
            </div>
          </div>
          <div class="card p-16 mb-16">
            <div class="row space mb-12" style="flex-wrap:wrap;gap:8px">
              <input id="cmdb-mgmt-search" class="input" style="min-width:250px" placeholder="Search assets..." oninput="cmdbMgmtApplyFilters()"/>
              <select id="cmdb-mgmt-category" class="input" style="max-width:180px" onchange="cmdbMgmtApplyFilters()">
                <option value="">All Categories</option>
              </select>
              <select id="cmdb-mgmt-customer" class="input" style="max-width:180px" onchange="cmdbMgmtApplyFilters()">
                <option value="">All Customers</option>
              </select>
            </div>
          </div>
          <div class="card p-16">
            <div id="cmdb-mgmt-loading" style="text-align:center;padding:40px;color:var(--muted);">Loading CMDB items...</div>
            <table id="cmdb-mgmt-table" style="display:none">
              <thead><tr>
                <th style="cursor:pointer" onclick="cmdbMgmtSort('asset_name')">Asset Name <span id="cmdb-mgmt-sort-asset_name"></span></th>
                <th style="cursor:pointer" onclick="cmdbMgmtSort('asset_category')">Category <span id="cmdb-mgmt-sort-asset_category"></span></th>
                <th style="cursor:pointer" onclick="cmdbMgmtSort('brand_name')">Brand/Model <span id="cmdb-mgmt-sort-brand_name"></span></th>
                <th style="cursor:pointer" onclick="cmdbMgmtSort('customer_name')">Customer <span id="cmdb-mgmt-sort-customer_name"></span></th>
                <th style="cursor:pointer" onclick="cmdbMgmtSort('asset_location')">Location <span id="cmdb-mgmt-sort-asset_location"></span></th>
                <th style="width:60px">CIs</th>
                <th style="width:120px"><div style="display:flex;align-items:center;gap:4px;font-size:12px;">Tickets<button class="btn ghost" style="padding:2px 6px;font-size:10px;" id="cmdbMgmtTicketToggle" onclick="cmdbMgmtToggleTicketMode()">All</button></div></th>
                <th style="cursor:pointer;width:80px" onclick="cmdbMgmtSort('status')">Status <span id="cmdb-mgmt-sort-status"></span></th>
                <th style="width:180px">Actions</th>
              </tr></thead>
              <tbody id="cmdb-mgmt-body"></tbody>
            </table>
            <div id="cmdb-mgmt-empty" style="display:none;text-align:center;padding:40px;color:var(--muted);">
              <div style="font-size:48px;margin-bottom:16px;">📦</div>
              <div>No CMDB items found</div>
              <div style="margin-top:8px;font-size:13px;">Use Import CSV or Add CMDB Item to get started</div>
            </div>
          </div>
        </div>

        <!-- Usage Dashboard -->
        <div id="view-usage" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Usage & Limits</h3></div>
            <button class="btn" onclick="refreshUsage()">🔄 Refresh</button>
          </div>
          
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Users</div>
              <div id="usage-users-current" style="font-size:28px;font-weight:800">0</div>
              <div class="subtitle">of <span id="usage-users-limit">0</span> allowed</div>
              <div class="progress-bar" style="margin-top:8px">
                <div id="usage-users-progress" class="progress-fill" style="width:0%"></div>
              </div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Tickets</div>
              <div id="usage-tickets-current" style="font-size:28px;font-weight:800">0</div>
              <div class="subtitle">of <span id="usage-tickets-limit">0</span> allowed</div>
              <div class="progress-bar" style="margin-top:8px">
                <div id="usage-tickets-progress" class="progress-fill" style="width:0%"></div>
              </div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Storage</div>
              <div id="usage-storage-current" style="font-size:28px;font-weight:800">0</div>
              <div class="subtitle">of <span id="usage-storage-limit">0</span> GB allowed</div>
              <div class="progress-bar" style="margin-top:8px">
                <div id="usage-storage-progress" class="progress-fill" style="width:0%"></div>
              </div>
            </div>
          </div>
          
          <div class="card p-16 mb-16">
            <h4>Usage Alerts</h4>
            <div id="usage-alerts">
              <div class="subtitle">Loading usage data...</div>
            </div>
          </div>
          
          <div class="card p-16">
            <h4>Test Usage Limits</h4>
            <div class="row" style="gap:16px;margin-bottom:16px">
              <button class="btn" onclick="testUsageLimit('users', 1)">+1 User</button>
              <button class="btn" onclick="testUsageLimit('tickets', 1)">+1 Ticket</button>
              <button class="btn" onclick="testUsageLimit('storage', 1)">+1 GB Storage</button>
            </div>
            <div class="subtitle">Click buttons to test usage limit enforcement</div>
          </div>
        </div>

        <!-- Admin Settings (no in-content sub-menu, uses collapsible left nav) -->
        <div id="view-wizard" style="display:none">
          <!-- Company Profile Section -->
          <div id="admin-section-profile" class="wizard-section card p-16 mb-12">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">Company Profile</h4>
              <button class="btn primary" onclick="saveCompanyProfile()">Save Profile</button>
            </div>

            <div class="mb-12">
              <label class="subtitle">Company Name</label>
              <input id="profile-company-name" class="input" placeholder="e.g., Your Company Name"/>
            </div>

            <div class="mb-12">
              <label class="subtitle">Contact Phone</label>
              <input id="profile-contact-phone" class="input" placeholder="e.g., +1 (555) 123-4567"/>
            </div>

            <div class="mb-12">
              <label class="subtitle">Mail From Email Address</label>
              <input id="profile-mail-from" class="input" type="email" placeholder="e.g., support@company.com"/>
            </div>

            <div class="mb-12">
              <label class="subtitle">Company URL Domain</label>
              <input id="profile-company-url" class="input" placeholder="e.g., https://company.com"/>
            </div>

            <div id="profile-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
            <div id="profile-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
          </div>

          <!-- Email Ingest Rules Section -->
          <div id="admin-section-email-ingest" class="wizard-section card p-16 mb-12" style="display:none">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">Email Ingest Rules</h4>
              <div class="row" style="gap:6px">
                <button class="btn" onclick="testEmailConnection()">Test Connection</button>
                <button class="btn" style="color:#b91c1c;border-color:#fca5a5" onclick="clearEmailIngestSettings()">Clear All</button>
                <button class="btn primary" onclick="saveEmailIngestSettings()">Save Settings</button>
              </div>
            </div>

            <div class="mb-12">
              <label class="subtitle">
                <input type="checkbox" id="email-ingest-enabled" style="margin-right:8px"/>
                Enable Email Ingest
              </label>
            </div>

            <div class="subtitle mb-12" style="background:#eff6ff;padding:12px;border-radius:4px;border-left:4px solid #2563eb">
              <strong>How it works:</strong> Emails from customer domains in your system will automatically create tickets.
              If the sender email exists, a ticket is created for that customer. If the sender is new but their domain matches
              an existing customer domain, a new customer account is created and a ticket is generated. Confirmation emails with
              ticket links are sent automatically.
            </div>

            <!-- Email Provider Selector -->
            <div class="mb-12">
              <label class="subtitle">Email Provider</label>
              <div style="display:flex;gap:0;margin-top:4px">
                <button id="email-provider-imap" class="btn primary" onclick="selectEmailProvider('imap')" style="border-radius:6px 0 0 6px;flex:1">Standard IMAP</button>
                <button id="email-provider-m365" class="btn" onclick="selectEmailProvider('m365')" style="border-radius:0 6px 6px 0;flex:1">Microsoft 365</button>
              </div>
            </div>

            <!-- Standard IMAP fields -->
            <div id="email-imap-fields">
              <div class="mb-12">
                <label class="subtitle">Server Type</label>
                <select id="email-server-type" class="input">
                  <option value="imap">IMAP</option>
                  <option value="pop3">POP3</option>
                </select>
              </div>

              <div class="mb-12">
                <label class="subtitle">IMAP Server Host</label>
                <input id="email-server-host" class="input" placeholder="e.g., imap.gmail.com"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Server Port</label>
                <input id="email-server-port" class="input" type="number" placeholder="e.g., 993"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">
                  <input type="checkbox" id="email-use-ssl" style="margin-right:8px" checked/>
                  Use SSL/TLS
                </label>
              </div>

              <div class="mb-12">
                <label class="subtitle">Email Username</label>
                <input id="email-username" class="input" placeholder="e.g., support@company.com"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Email Password</label>
                <input id="email-password" class="input" type="password" placeholder="Enter password"/>
              </div>
            </div>

            <!-- Microsoft 365 fields (Client Credentials / App-Only) -->
            <div id="email-m365-fields" style="display:none">
              <div class="mb-12">
                <label class="subtitle">Mailbox Email Address</label>
                <input id="email-m365-address" class="input" type="email" placeholder="e.g., support@yourcompany.com"/>
                <div class="subtitle" style="color:#6b7280;font-size:12px;margin-top:4px">The shared mailbox or user mailbox to monitor for incoming tickets.</div>
              </div>

              <div id="email-m365-status" class="mb-12" style="display:none">
                <div style="display:flex;align-items:center;gap:8px;padding:12px;border-radius:6px;background:#f0fdf4;border:1px solid #bbf7d0">
                  <span id="email-m365-status-dot" style="width:10px;height:10px;border-radius:50%;background:#16a34a;flex-shrink:0"></span>
                  <span id="email-m365-status-text" class="subtitle" style="color:#15803d"></span>
                  <button class="btn" onclick="disconnectMicrosoft365()" style="margin-left:auto;font-size:12px;padding:4px 12px">Disconnect</button>
                </div>
              </div>
            </div>

            <div class="mb-12">
              <label class="subtitle">Check Interval (minutes)</label>
              <input id="email-check-interval" class="input" type="number" min="1" max="60" placeholder="e.g., 5"/>
            </div>

            <!-- Outbound Email Section (per-provider) -->
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb">
              <label class="subtitle" style="display:flex;align-items:center;cursor:pointer">
                <input type="checkbox" id="email-use-for-outbound" style="margin-right:8px" onchange="toggleOutboundSmtpFields()"/>
                <span id="email-outbound-label">Also use this IMAP account for outbound notifications</span>
              </label>
              <div class="subtitle" style="color:#6b7280;font-size:12px;margin-top:4px">
                When enabled, ticket notifications and system emails will be sent from this mailbox
                instead of the default system email.
              </div>
            </div>

            <!-- SMTP fields (only for IMAP/basic when outbound enabled) -->
            <div id="email-smtp-outbound-fields" style="display:none;margin-top:12px">
              <div class="mb-12">
                <label class="subtitle">SMTP Server Host</label>
                <input id="email-smtp-host" class="input" placeholder="e.g., smtp.gmail.com"/>
              </div>
              <div class="mb-12">
                <label class="subtitle">SMTP Server Port</label>
                <input id="email-smtp-port" class="input" type="number" placeholder="587" value="587"/>
              </div>
            </div>

            <div id="email-last-checked" class="subtitle" style="color:#666;margin-top:8px"></div>
            <div id="email-ingest-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
            <div id="email-ingest-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>

            <!-- M365 setup note — shown last so it doesn't break the settings flow -->
            <div id="email-m365-setup-note" style="display:none;margin-top:16px">
              <div style="background:#eff6ff;padding:14px;border-radius:6px;border-left:4px solid #3b82f6;font-size:13px">
                <strong>One-time setup required by your M365 admin:</strong>
                <ol style="margin:8px 0 0;padding-left:20px;line-height:1.7">
                  <li>Create a mail-enabled security group in Exchange Admin and add the target mailbox</li>
                  <li>Run in Exchange Online PowerShell:<br>
                    <code style="background:#dbeafe;padding:2px 6px;border-radius:3px;font-size:12px">New-ApplicationAccessPolicy -AppId "05c4ccac-2615-405f-af73-2ede3d344080" -PolicyScopeGroupId "YourGroupName" -AccessRight RestrictAccess</code>
                  </li>
                  <li>Save settings above, then click <strong>Test Connection</strong> to verify</li>
                </ol>
              </div>
            </div>

            <!-- System Senders Section -->
            <div style="margin-top:24px;padding-top:24px;border-top:1px solid #e5e7eb">
              <div class="row space mb-12">
                <h4 class="subtitle" style="margin:0;font-weight:600">System / Monitoring Senders</h4>
                <button class="btn primary" onclick="saveSystemSenders()">Save Senders</button>
              </div>

              <div class="subtitle mb-12" style="background:#fef3c7;padding:12px;border-radius:4px;border-left:4px solid #f59e0b">
                <strong>Purpose:</strong> Emails from these addresses will be treated as system/monitoring sources.
                Tickets will be created under the "System" user instead of auto-creating customer accounts.
              </div>

              <div class="mb-12">
                <label class="subtitle">Add Sender</label>
                <div class="row" style="gap:8px">
                  <input id="system-sender-input" class="input" placeholder="e.g. nagios@company.com" style="flex:1"/>
                  <button class="btn" onclick="addSystemSender()">+ Add</button>
                </div>
              </div>

              <div id="system-senders-list" class="mb-12">
                <label class="subtitle">Current System Senders</label>
                <div id="system-senders-items" style="margin-top:8px">
                  <div class="subtitle" style="color:#666;font-style:italic">No system senders configured</div>
                </div>
              </div>

              <div class="subtitle" style="color:#666;font-size:12px;margin-top:8px">
                <strong>Note:</strong> Built-in detection already handles common monitoring systems (Nagios, Zabbix, Datadog, etc.).
                Use this list for exact sender addresses from your environment.
              </div>

              <div id="system-senders-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
              <div id="system-senders-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
            </div>
          </div>

          <!-- Expert Registration Settings -->
          <div id="admin-section-expert-reg" class="wizard-section card p-16 mb-12" style="display:none">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">Expert Registration via Email</h4>
              <button class="btn primary" onclick="saveExpertRegSettings()">Save Settings</button>
            </div>

            <div class="subtitle mb-12" style="background:#f0fdf4;padding:12px;border-radius:4px;border-left:4px solid #16a34a">
              <strong>How it works:</strong> Staff members can self-register as experts by sending an email with subject
              <code style="background:#dcfce7;padding:2px 6px;border-radius:4px">Register_Expert</code> to your support inbox.
              Their email domain must match the Tenant Domain below. A welcome email with login credentials will be sent automatically.
            </div>

            <div class="mb-12">
              <label class="subtitle">Tenant Domain (your company's email domain)</label>
              <input id="expert-reg-domain" class="input" placeholder="e.g., apoyar.eu or apoyar.com.au"/>
              <div class="subtitle" style="margin-top:4px;color:#666;font-size:12px">
                Only emails from this domain can register as experts. Example: if set to <code>apoyar.eu</code>,
                then <code>john@apoyar.eu</code> can register but <code>john@gmail.com</code> cannot.
              </div>
            </div>

            <div id="expert-reg-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
            <div id="expert-reg-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>

            <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb">
              <div class="row space">
                <div>
                  <div class="subtitle" style="font-weight:600">Test Email Processing</div>
                  <div class="subtitle" style="color:#666;font-size:12px">Manually trigger email processing to check for new emails immediately (normally runs every 5 minutes)</div>
                </div>
                <button class="btn" onclick="triggerEmailProcessing()">Process Emails Now</button>
              </div>
              <div id="email-process-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
            </div>
          </div>

          <!-- Support Settings -->
          <div id="admin-section-support" class="wizard-section card p-16 mb-12" style="display:none">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">Support Settings</h4>
              <button class="btn primary" onclick="saveSupportSettings()">Save Settings</button>
            </div>

            <div class="mb-12">
              <label class="subtitle">
                <input type="checkbox" id="resolution-requires-acceptance" style="margin-right:8px" checked/>
                Resolution Requires Customer Acceptance
              </label>
              <div class="subtitle" style="margin-top:8px;color:#666;font-size:13px">
                When enabled, customers must accept or reject ticket resolutions via email.
                If accepted, they'll be asked to provide a CSAT rating. If rejected, the ticket
                will be reopened and the support team notified.
              </div>
            </div>

            <div id="support-settings-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
            <div id="support-settings-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>

            <!-- Batch Processing Settings -->
            <div style="border-top:1px solid var(--border);margin-top:24px;padding-top:24px">
              <div class="row space mb-12">
                <h4 class="subtitle" style="margin:0;font-weight:600">Bulk Ticket Processing</h4>
                <button class="btn primary" onclick="saveBatchProcessingSettings()">Save Settings</button>
              </div>

              <!-- SLA Monitoring Section -->
              <div style="margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--border)">
                <div class="subtitle" style="font-weight:600;margin-bottom:8px;color:var(--text)">
                  SLA Monitoring
                </div>
                <div class="subtitle" style="margin-bottom:12px;color:#666;font-size:13px">
                  Controls how often the system automatically checks for SLA breaches and generates notifications.
                </div>
                <div style="max-width:300px">
                  <label class="subtitle" style="font-weight:500;margin-bottom:8px;display:block">
                    Check Interval (seconds)
                  </label>
                  <input type="number" id="sla-check-interval" min="60" max="3600" value="300"
                    style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:4px;font-size:14px"/>
                  <div class="subtitle" style="margin-top:4px;color:#666;font-size:12px">
                    Minimum 60 seconds. Default 300 (5 minutes).
                  </div>
                </div>
              </div>

              <!-- Bulk Operations Section -->
              <div>
                <div class="subtitle" style="font-weight:600;margin-bottom:8px;color:var(--text)">
                  Bulk Operations
                </div>
                <div class="subtitle" style="margin-bottom:12px;color:#666;font-size:13px">
                  Controls batch processing for user-triggered bulk actions like running ticket rules.
                  These settings help prevent server overload when processing large numbers of tickets.
                </div>
                <div class="row" style="gap:24px;flex-wrap:wrap">
                  <div style="flex:1;min-width:200px;max-width:300px">
                    <label class="subtitle" style="font-weight:500;margin-bottom:8px;display:block">
                      Batch Delay (seconds)
                    </label>
                    <input type="number" id="batch-delay-seconds" min="3" max="60" value="3"
                      style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:4px;font-size:14px"/>
                    <div class="subtitle" style="margin-top:4px;color:#666;font-size:12px">
                      Minimum 3 seconds. Delay between processing each batch.
                    </div>
                  </div>

                  <div style="flex:1;min-width:200px;max-width:300px">
                    <label class="subtitle" style="font-weight:500;margin-bottom:8px;display:block">
                      Batch Size
                    </label>
                    <input type="number" id="batch-size" min="1" max="10" value="5"
                      style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:4px;font-size:14px"/>
                    <div class="subtitle" style="margin-top:4px;color:#666;font-size:12px">
                      Maximum 10. Number of items to process per batch.
                    </div>
                  </div>
                </div>
              </div>

              <div id="batch-settings-message" class="subtitle" style="color:#16a34a;display:none;margin-top:12px"></div>
              <div id="batch-settings-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:12px"></div>
            </div>
          </div>

          <!-- Integrations Section -->
          <div id="admin-section-integrations" class="wizard-section card p-16 mb-12" style="display:none">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">🔗 Integrations</h4>
            </div>

            <!-- Microsoft Teams Integration -->
            <div id="teams-integration" style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
              <div class="row space mb-12">
                <div class="row" style="gap:12px">
                  <div style="width:48px;height:48px;background:linear-gradient(135deg,#5b5fc7,#7b83eb);border-radius:8px;display:flex;align-items:center;justify-content:center">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M19.5 4.5h-4v-2c0-.6-.4-1-1-1h-5c-.6 0-1 .4-1 1v2h-4c-.6 0-1 .4-1 1v14c0 .6.4 1 1 1h15c.6 0 1-.4 1-1v-14c0-.6-.4-1-1-1zm-9-1h3v1h-3v-1zm8 15h-13v-12h13v12z"/><path d="M8 9h8v2h-8zM8 13h6v2h-6z"/></svg>
                  </div>
                  <div>
                    <div style="font-weight:600;font-size:16px">Microsoft Teams</div>
                    <div class="subtitle" style="color:#666">Manage tickets directly from Teams</div>
                  </div>
                </div>
                <div id="teams-status-badge">
                  <span id="teams-disconnected-badge" class="badge" style="background:#fee2e2;color:#b91c1c">Not Connected</span>
                  <span id="teams-connected-badge" class="badge" style="background:#dcfce7;color:#16a34a;display:none">Connected</span>
                </div>
              </div>

              <!-- Requirements Warning -->
              <div id="teams-requirements" class="subtitle mb-12" style="background:#fef3c7;padding:12px;border-radius:4px;border-left:4px solid #f59e0b">
                <strong>⚠️ Requirements:</strong> Your Microsoft 365 tenant must allow custom Teams apps (sideloading).
                This setting is managed by your IT administrator in the <a href="https://admin.teams.microsoft.com/policies/app-setup" target="_blank" style="color:#2563eb">Teams Admin Center</a>.
                <br><br>
                <strong>What we request:</strong> Only basic permissions to identify your organization (User.Read).
                We don't access your emails, files, or other data.
              </div>

              <!-- Not Connected State -->
              <div id="teams-not-connected">
                <div class="subtitle mb-12">
                  <strong>Features:</strong>
                  <ul style="margin:8px 0 0 20px;padding:0">
                    <li>Create tickets with <code>raise ticket: [description]</code></li>
                    <li>Check status with <code>status #123</code></li>
                    <li>View your assigned tickets with <code>my tickets</code></li>
                    <li>Get AI-powered insights with <code>trends</code></li>
                    <li>Search CMDB items with <code>cmdb [search]</code></li>
                  </ul>
                </div>
                <button class="btn primary" onclick="connectTeams()">
                  <span style="margin-right:8px">🔐</span> Connect to Microsoft Teams
                </button>
              </div>

              <!-- Connected State -->
              <div id="teams-connected" style="display:none">
                <div class="subtitle mb-12" style="background:#f0fdf4;padding:12px;border-radius:4px;border-left:4px solid #16a34a">
                  <strong>✓ Connected to:</strong> <span id="teams-tenant-name">-</span>
                  <br>
                  <span style="color:#666">Connected on: <span id="teams-connected-date">-</span></span>
                </div>

                <div class="mb-12">
                  <strong>Email Domains:</strong>
                  <div id="teams-email-domains" style="margin-top:8px"></div>
                  <div class="row mt-8" style="gap:8px">
                    <input id="teams-new-domain" class="input" placeholder="Add domain (e.g., company.com)" style="max-width:200px"/>
                    <button class="btn" onclick="addTeamsDomain()">Add Domain</button>
                  </div>
                </div>

                <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:16px">
                  <div class="subtitle mb-8"><strong>Step 2: Install the bot in your Teams</strong></div>
                  <div class="subtitle mb-12" style="color:#666">
                    Download the app package and install it in Microsoft Teams:
                    <ol style="margin:8px 0 0 20px;padding:0">
                      <li>Download the ServiFlow Teams app package</li>
                      <li>In Teams, go to <strong>Apps → Manage your apps</strong></li>
                      <li>Click <strong>Upload an app → Upload a custom app</strong></li>
                      <li>Select the downloaded manifest.zip file</li>
                    </ol>
                  </div>
                  <div class="row" style="gap:8px">
                    <button class="btn primary" onclick="downloadTeamsManifest()">
                      <span style="margin-right:8px">📦</span> Download App Package
                    </button>
                    <button class="btn" onclick="disconnectTeams()" style="color:#b91c1c">Disconnect</button>
                  </div>
                </div>
              </div>

              <div id="teams-message" class="subtitle" style="color:#16a34a;display:none;margin-top:12px"></div>
              <div id="teams-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:12px"></div>
            </div>

            <!-- Slack Integration -->
            <div id="slack-integration" style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
              <div class="row space mb-12">
                <div class="row" style="gap:12px">
                  <div style="width:48px;height:48px;background:linear-gradient(135deg,#4a154b,#611f69);border-radius:8px;display:flex;align-items:center;justify-content:center">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/></svg>
                  </div>
                  <div>
                    <div style="font-weight:600;font-size:16px">Slack</div>
                    <div class="subtitle" style="color:#666">Manage tickets directly from Slack</div>
                  </div>
                </div>
                <div id="slack-status-badge">
                  <span id="slack-disconnected-badge" class="badge" style="background:#fee2e2;color:#b91c1c">Not Connected</span>
                  <span id="slack-connected-badge" class="badge" style="background:#dcfce7;color:#16a34a;display:none">Connected</span>
                </div>
              </div>

              <!-- Not Connected State -->
              <div id="slack-not-connected">
                <div class="subtitle mb-12">
                  <strong>Features:</strong>
                  <ul style="margin:8px 0 0 20px;padding:0">
                    <li>Create tickets with <code>/ticket create [description]</code></li>
                    <li>Check status with <code>/ticket status #123</code></li>
                    <li>View your assigned tickets with <code>/ticket list</code></li>
                    <li>Switch modes with <code>/ticket mode</code></li>
                    <li>Get help with <code>/ticket help</code></li>
                  </ul>
                </div>
                <button class="btn primary" onclick="connectSlack()">
                  <span style="margin-right:8px">🔐</span> Connect to Slack
                </button>
              </div>

              <!-- Connected State -->
              <div id="slack-connected" style="display:none">
                <div class="subtitle mb-12" style="background:#f0fdf4;padding:12px;border-radius:4px;border-left:4px solid #16a34a">
                  <strong>✓ Connected to:</strong> <span id="slack-workspace-name">-</span>
                  <br>
                  <span style="color:#666">Connected on: <span id="slack-connected-date">-</span></span>
                </div>

                <div class="mb-12">
                  <strong>Email Domains:</strong>
                  <div id="slack-email-domains" style="margin-top:8px"></div>
                  <div class="row mt-8" style="gap:8px">
                    <input id="slack-new-domain" class="input" placeholder="Add domain (e.g., company.com)" style="max-width:200px"/>
                    <button class="btn" onclick="addSlackDomain()">Add Domain</button>
                  </div>
                </div>

                <div class="row" style="gap:8px">
                  <button class="btn" onclick="disconnectSlack()" style="color:#b91c1c">Disconnect</button>
                </div>
              </div>

              <div id="slack-message" class="subtitle" style="color:#16a34a;display:none;margin-top:12px"></div>
              <div id="slack-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:12px"></div>
            </div>

            <!-- SMS Integration -->
            <div id="sms-integration" style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
              <div class="row space mb-12">
                <div class="row" style="gap:12px">
                  <div style="width:48px;height:48px;background:linear-gradient(135deg,#0ea5e9,#0284c7);border-radius:8px;display:flex;align-items:center;justify-content:center">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zM7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg>
                  </div>
                  <div>
                    <div style="font-weight:600;font-size:16px">SMS (Twilio)</div>
                    <div class="subtitle" style="color:#666">Manage tickets via text message</div>
                  </div>
                </div>
                <div id="sms-status-badge">
                  <span id="sms-disconnected-badge" class="badge" style="background:#fee2e2;color:#b91c1c">Not Connected</span>
                  <span id="sms-connected-badge" class="badge" style="background:#dcfce7;color:#16a34a;display:none">Connected</span>
                </div>
              </div>

              <!-- Not Connected State -->
              <div id="sms-not-connected">
                <div class="subtitle mb-12">
                  <strong>Features:</strong>
                  <ul style="margin:8px 0 0 20px;padding:0">
                    <li>Create tickets: text <code>new: [description]</code></li>
                    <li>View ticket: text <code>#123</code></li>
                    <li>List tickets: text <code>my tickets</code></li>
                    <li>Switch modes: text <code>mode expert</code> or <code>mode customer</code></li>
                    <li>Get help: text <code>help</code></li>
                  </ul>
                </div>
                <div style="margin-bottom:12px">
                  <div class="subtitle mb-8"><strong>Connect your Twilio number:</strong></div>
                  <div class="row" style="gap:8px;flex-wrap:wrap">
                    <input id="sms-phone-number" class="input" placeholder="+14155551234 (E.164)" style="max-width:200px"/>
                    <input id="sms-account-sid" class="input" placeholder="Account SID (optional)" style="max-width:220px"/>
                    <button class="btn primary" onclick="connectSms()">Connect SMS</button>
                  </div>
                </div>
              </div>

              <!-- Connected State -->
              <div id="sms-connected" style="display:none">
                <div class="subtitle mb-12" style="background:#f0fdf4;padding:12px;border-radius:4px;border-left:4px solid #16a34a">
                  <strong>Connected:</strong> <span id="sms-phone-display">-</span>
                  <br>
                  <span style="color:#666">Connected on: <span id="sms-connected-date">-</span></span>
                </div>

                <div class="mb-12">
                  <strong>Test SMS:</strong>
                  <div class="row mt-8" style="gap:8px">
                    <input id="sms-test-phone" class="input" placeholder="Your phone number" style="max-width:200px"/>
                    <button class="btn" onclick="testSms()">Send Test</button>
                  </div>
                </div>

                <div class="row" style="gap:8px">
                  <button class="btn" onclick="disconnectSms()" style="color:#b91c1c">Disconnect</button>
                </div>
              </div>

              <div id="sms-message" class="subtitle" style="color:#16a34a;display:none;margin-top:12px"></div>
              <div id="sms-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:12px"></div>
            </div>

            <!-- Placeholder for future integrations -->
            <div style="border:1px dashed var(--border);border-radius:8px;padding:16px;text-align:center;color:#666">
              <div class="subtitle">More integrations coming soon: Email to Ticket, Webhooks...</div>
            </div>
          </div>

          <!-- SLA Management Section -->
          <div id="admin-section-sla" class="wizard-section card p-16 mb-12" style="display:none">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">⏱️ SLA Management</h4>
            </div>

            <!-- Business Hours Profiles -->
            <div style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
              <div class="row space mb-12">
                <div>
                  <div style="font-weight:600">Business Hours Profiles</div>
                  <div class="subtitle" style="color:#666;font-size:12px">Define working hours for SLA calculations</div>
                </div>
                <button class="btn primary" onclick="openBusinessHoursModal()">+ Add Profile</button>
              </div>
              <table style="width:100%;border-collapse:collapse" id="business-hours-table">
                <thead>
                  <tr style="border-bottom:1px solid var(--border);background:#f9fafb">
                    <th style="text-align:left;padding:8px">Name</th>
                    <th style="text-align:left;padding:8px">Timezone</th>
                    <th style="text-align:left;padding:8px">Hours</th>
                    <th style="text-align:left;padding:8px">Days</th>
                    <th style="text-align:right;padding:8px">Actions</th>
                  </tr>
                </thead>
                <tbody id="business-hours-tbody">
                  <tr><td colspan="5" style="padding:16px;text-align:center;color:#666">Loading...</td></tr>
                </tbody>
              </table>
            </div>

            <!-- SLA Definitions -->
            <div style="border:1px solid var(--border);border-radius:8px;padding:16px">
              <div class="row space mb-12">
                <div>
                  <div style="font-weight:600">SLA Definitions</div>
                  <div class="subtitle" style="color:#666;font-size:12px">Define response and resolution targets</div>
                </div>
                <button class="btn primary" onclick="openSLADefinitionModal()">+ Add SLA</button>
              </div>
              <table style="width:100%;border-collapse:collapse" id="sla-definitions-table">
                <thead>
                  <tr style="border-bottom:1px solid var(--border);background:#f9fafb">
                    <th style="text-align:left;padding:8px">Name</th>
                    <th style="text-align:left;padding:8px">Response</th>
                    <th style="text-align:left;padding:8px">Resolution</th>
                    <th style="text-align:left;padding:8px">Business Hours</th>
                    <th style="text-align:right;padding:8px">Actions</th>
                  </tr>
                </thead>
                <tbody id="sla-definitions-tbody">
                  <tr><td colspan="5" style="padding:16px;text-align:center;color:#666">Loading...</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Category SLA Mappings -->
            <div style="border:1px solid var(--border);border-radius:8px;padding:16px">
              <div class="row space mb-12">
                <div>
                  <div style="font-weight:600">Category SLA Mappings</div>
                  <div class="subtitle" style="color:#666;font-size:12px">Assign SLAs to ticket categories</div>
                </div>
                <button class="btn primary" onclick="openCategoryMappingModal()">+ Add Mapping</button>
              </div>
              <table style="width:100%;border-collapse:collapse" id="category-mappings-table">
                <thead>
                  <tr style="border-bottom:1px solid var(--border);background:#f9fafb">
                    <th style="text-align:left;padding:8px">Category</th>
                    <th style="text-align:left;padding:8px">SLA Definition</th>
                    <th style="text-align:left;padding:8px">Status</th>
                    <th style="text-align:right;padding:8px">Actions</th>
                  </tr>
                </thead>
                <tbody id="category-mappings-tbody">
                  <tr><td colspan="4" style="padding:16px;text-align:center;color:#666">Loading...</td></tr>
                </tbody>
              </table>
            </div>

            <div id="sla-message" class="subtitle" style="color:#16a34a;display:none;margin-top:12px"></div>
            <div id="sla-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:12px"></div>
          </div>

          <!-- CMDB Custom Fields Section -->
          <div id="admin-section-cmdb-fields" class="wizard-section card p-16 mb-12" style="display:none">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">🗃️ CMDB Custom Fields</h4>
              <button class="btn primary" onclick="showAddCustomFieldModal()">+ Add Field</button>
            </div>
            <p class="subtitle" style="margin-bottom:16px">Define custom fields for each asset category. These fields will appear when viewing or editing CMDB items.</p>

            <!-- Category Filter -->
            <div class="row mb-16" style="gap:12px;flex-wrap:wrap">
              <select id="custom-fields-category-filter" class="input" style="max-width:250px" onchange="loadCustomFieldDefinitions()">
                <option value="">All Categories</option>
              </select>
              <button class="btn" onclick="loadCustomFieldDefinitions()">Refresh</button>
            </div>

            <!-- Custom Fields Table -->
            <div id="custom-fields-loading" style="text-align:center;padding:20px;color:var(--muted);">Loading custom fields...</div>
            <table id="custom-fields-table" style="display:none">
              <thead>
                <tr>
                  <th style="width:150px">Category</th>
                  <th style="width:150px">Field Name</th>
                  <th style="width:200px">Label</th>
                  <th style="width:100px">Type</th>
                  <th style="width:80px">Required</th>
                  <th style="width:80px">Order</th>
                  <th style="width:120px">Actions</th>
                </tr>
              </thead>
              <tbody id="custom-fields-body"></tbody>
            </table>
            <div id="custom-fields-empty" style="display:none;text-align:center;padding:30px;color:var(--muted);">
              <div style="font-size:32px;margin-bottom:12px">📝</div>
              <div>No custom fields defined yet</div>
              <div style="margin-top:8px;font-size:13px">Click "Add Field" to create custom fields for your CMDB categories</div>
            </div>
          </div>

          <!-- Billing & Subscription Section -->
          <div id="admin-section-billing" class="wizard-section card p-16 mb-12" style="display:none">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">💳 Billing & Subscription</h4>
            </div>

            <!-- Subscription Status Card -->
            <div id="billing-subscription-card" style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
              <div class="row space mb-12">
                <div class="row" style="gap:12px">
                  <div id="billing-plan-icon" style="width:48px;height:48px;background:linear-gradient(135deg,#10b981,#059669);border-radius:8px;display:flex;align-items:center;justify-content:center">
                    <span style="font-size:24px">📋</span>
                  </div>
                  <div>
                    <div id="billing-plan-name" style="font-weight:600;font-size:16px">Loading...</div>
                    <div id="billing-plan-tagline" class="subtitle" style="color:#666">-</div>
                  </div>
                </div>
                <div>
                  <span id="billing-status-badge" class="badge" style="background:#dcfce7;color:#16a34a">Active</span>
                </div>
              </div>

              <!-- Trial Countdown -->
              <div id="billing-trial-banner" style="background:#fef3c7;padding:12px;border-radius:4px;border-left:4px solid #f59e0b;margin-bottom:16px;display:none">
                <div class="row space">
                  <div>
                    <strong>⏳ Trial Period</strong>
                    <div class="subtitle" style="margin-top:4px">Your trial ends in <strong id="billing-trial-remaining">-</strong></div>
                  </div>
                  <button class="btn primary" onclick="openBillingCheckout()">Upgrade Now</button>
                </div>
              </div>

              <!-- Subscription Details -->
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:16px">
                <div style="background:#f9fafb;padding:12px;border-radius:8px">
                  <div class="subtitle" style="font-size:11px;text-transform:uppercase;color:#666;margin-bottom:4px">Current Plan</div>
                  <div id="billing-plan-display" style="font-weight:600">-</div>
                </div>
                <div style="background:#f9fafb;padding:12px;border-radius:8px">
                  <div class="subtitle" style="font-size:11px;text-transform:uppercase;color:#666;margin-bottom:4px">Billing Cycle</div>
                  <div id="billing-cycle-display" style="font-weight:600">-</div>
                </div>
                <div style="background:#f9fafb;padding:12px;border-radius:8px">
                  <div class="subtitle" style="font-size:11px;text-transform:uppercase;color:#666;margin-bottom:4px">Next Invoice</div>
                  <div id="billing-next-invoice" style="font-weight:600">-</div>
                </div>
                <div style="background:#f9fafb;padding:12px;border-radius:8px">
                  <div class="subtitle" style="font-size:11px;text-transform:uppercase;color:#666;margin-bottom:4px">Amount</div>
                  <div id="billing-amount-display" style="font-weight:600">-</div>
                </div>
              </div>

              <!-- Actions -->
              <div class="row" style="gap:8px">
                <button id="billing-upgrade-btn" class="btn primary" onclick="openBillingCheckout()">Change Plan</button>
                <button id="billing-cancel-btn" class="btn" onclick="cancelSubscription()" style="display:none">Cancel Subscription</button>
              </div>
            </div>

            <!-- Available Plans -->
            <div style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
              <div class="row space mb-12">
                <div>
                  <div style="font-weight:600">Available Plans</div>
                  <div class="subtitle" style="color:#666;font-size:12px">Compare and upgrade your subscription</div>
                </div>
                <div class="row" style="gap:8px">
                  <label class="subtitle" style="display:flex;align-items:center;gap:4px">
                    <input type="radio" name="billing-cycle" value="monthly" checked onchange="updateBillingPlans()"> Monthly
                  </label>
                  <label class="subtitle" style="display:flex;align-items:center;gap:4px">
                    <input type="radio" name="billing-cycle" value="yearly" onchange="updateBillingPlans()"> Yearly <span style="color:#16a34a;font-size:11px">(Save 17%)</span>
                  </label>
                </div>
              </div>
              <div id="billing-plans-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
                <div style="padding:24px;text-align:center;color:#666">Loading plans...</div>
              </div>
            </div>

            <!-- Payment Methods -->
            <div style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
              <div class="row space mb-12">
                <div>
                  <div style="font-weight:600">Payment Methods</div>
                  <div class="subtitle" style="color:#666;font-size:12px">Manage your saved cards</div>
                </div>
                <button class="btn" onclick="addPaymentMethod()">+ Add Card</button>
              </div>
              <div id="billing-payment-methods">
                <div style="padding:24px;text-align:center;color:#666">No payment methods saved</div>
              </div>
            </div>

            <!-- Invoice History -->
            <div style="border:1px solid var(--border);border-radius:8px;padding:16px">
              <div class="row space mb-12">
                <div>
                  <div style="font-weight:600">Invoice History</div>
                  <div class="subtitle" style="color:#666;font-size:12px">View and download past invoices</div>
                </div>
              </div>
              <table style="width:100%;border-collapse:collapse" id="billing-invoices-table">
                <thead>
                  <tr style="border-bottom:1px solid var(--border);background:#f9fafb">
                    <th style="text-align:left;padding:8px">Date</th>
                    <th style="text-align:left;padding:8px">Description</th>
                    <th style="text-align:left;padding:8px">Amount</th>
                    <th style="text-align:left;padding:8px">Status</th>
                    <th style="text-align:right;padding:8px">Invoice</th>
                  </tr>
                </thead>
                <tbody id="billing-invoices-tbody">
                  <tr><td colspan="5" style="padding:16px;text-align:center;color:#666">No invoices yet</td></tr>
                </tbody>
              </table>
            </div>

            <div id="billing-message" class="subtitle" style="color:#16a34a;display:none;margin-top:12px"></div>
            <div id="billing-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:12px"></div>
          </div>

          <!-- Data Retention & Housekeeping Section -->
          <div id="admin-section-housekeeping" class="wizard-section card p-16 mb-12" style="display:none">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">Data Retention & Housekeeping</h4>
              <button class="btn primary" onclick="runHousekeepingNow()" id="hk-run-btn">Run Now</button>
            </div>

            <div id="hk-info" class="card p-16 mb-12" style="background:#f8fafc;border:1px solid #e2e8f0">
              <p class="subtitle" style="margin:0 0 8px 0"><strong>Plan:</strong> <span id="hk-plan-name">—</span></p>
              <p class="subtitle" style="margin:0 0 4px 0"><strong>Log retention:</strong> <span id="hk-log-days">—</span> days</p>
              <p class="subtitle" style="margin:0"><strong>Closed ticket retention:</strong> <span id="hk-ticket-days">—</span> days</p>
            </div>

            <div class="mb-12">
              <label class="subtitle">Custom Log Retention (days) — leave blank to use plan default</label>
              <div class="row" style="gap:8px;align-items:center;margin-top:4px">
                <input id="hk-override-days" class="input" type="number" min="30" max="730" placeholder="e.g., 180" style="width:160px"/>
                <button class="btn secondary" onclick="saveHousekeepingOverride()">Save Override</button>
              </div>
            </div>

            <div id="hk-results" style="display:none" class="mb-12">
              <h5 class="subtitle" style="font-weight:600;margin:0 0 8px 0">Last Run Results</h5>
              <table class="table" style="width:100%">
                <thead><tr><th>Table</th><th>Rows Pruned</th></tr></thead>
                <tbody id="hk-results-body"></tbody>
              </table>
            </div>

            <div id="hk-message" class="subtitle" style="color:#16a34a;display:none;margin-top:12px"></div>
            <div id="hk-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:12px"></div>
          </div>

          <!-- Chat Settings Section -->
          <div id="admin-section-chat" class="wizard-section card p-16 mb-12" style="display:none">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">💬 Live Chat - Canned Responses</h4>
              <button class="btn primary" onclick="addCannedResponse()">+ Add Response</button>
            </div>
            <div id="canned-responses-list" style="font-size:13px">
              <div style="text-align:center;color:var(--muted);padding:20px">Loading...</div>
            </div>
            <div id="canned-response-form" style="display:none;margin-top:16px;padding:16px;border:1px solid var(--border);border-radius:8px;background:var(--table-header)">
              <h5 class="subtitle" style="font-weight:600;margin:0 0 12px 0" id="cr-form-title">Add Canned Response</h5>
              <div class="mb-8">
                <label class="subtitle">Label</label>
                <input id="cr-label" class="input" placeholder="e.g., Log a Ticket" style="font-size:13px">
              </div>
              <div class="mb-8">
                <label class="subtitle">Message</label>
                <textarea id="cr-message" class="input" placeholder="The message text..." rows="2" style="font-size:13px"></textarea>
              </div>
              <div class="mb-8" style="display:flex;gap:12px">
                <div style="flex:1">
                  <label class="subtitle">Action Type</label>
                  <select id="cr-action-type" class="input" style="font-size:13px">
                    <option value="text">Text only</option>
                    <option value="create_ticket">Create Ticket</option>
                    <option value="request_screenshot">Request Screenshot</option>
                  </select>
                </div>
                <div style="flex:1">
                  <label class="subtitle">Sort Order</label>
                  <input id="cr-sort-order" class="input" type="number" value="0" style="font-size:13px">
                </div>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn primary" onclick="saveCannedResponse()">Save</button>
                <button class="btn ghost" onclick="cancelCannedResponse()">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Monthly Reports Section -->
          <div id="admin-section-reports" class="wizard-section card p-16 mb-12" style="display:none">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">📊 Monthly Reports</h4>
            </div>

            <!-- Config Panel -->
            <div class="card p-16 mb-12" style="background:#f8fafc;border:1px solid #e2e8f0">
              <h5 class="subtitle" style="font-weight:600;margin:0 0 12px 0">Auto-Send Configuration</h5>
              <div class="mb-8">
                <label class="subtitle">
                  <input type="checkbox" id="report-cfg-enabled" style="margin-right:8px"/>
                  Enable automatic monthly report emails
                </label>
              </div>
              <div class="mb-8">
                <label class="subtitle">Recipients (comma-separated emails)</label>
                <input id="report-cfg-recipients" class="input" placeholder="admin@company.com, manager@company.com" style="font-size:13px"/>
              </div>
              <div class="mb-8">
                <label class="subtitle">Send Day of Month (1-28)</label>
                <input id="report-cfg-send-day" class="input" type="number" min="1" max="28" value="1" style="font-size:13px;width:100px"/>
              </div>
              <button class="btn primary" onclick="saveReportConfig()">Save Configuration</button>
              <span id="report-cfg-message" class="subtitle" style="color:#16a34a;display:none;margin-left:12px"></span>
              <span id="report-cfg-error" class="subtitle" style="color:#b91c1c;display:none;margin-left:12px"></span>
            </div>

            <!-- Generate Panel -->
            <div class="card p-16 mb-12" style="background:#f8fafc;border:1px solid #e2e8f0">
              <h5 class="subtitle" style="font-weight:600;margin:0 0 12px 0">Generate Report</h5>
              <div class="mb-8" style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
                <div>
                  <label class="subtitle">Month</label>
                  <select id="report-gen-month" class="input" style="font-size:13px;width:140px"></select>
                </div>
                <div>
                  <label class="subtitle">Year</label>
                  <input id="report-gen-year" class="input" type="number" style="font-size:13px;width:90px"/>
                </div>
                <div>
                  <label class="subtitle">Company Filter (optional)</label>
                  <select id="report-gen-company" class="input" style="font-size:13px;width:200px">
                    <option value="">All Companies</option>
                  </select>
                </div>
              </div>
              <div class="mb-8">
                <label class="subtitle">
                  <input type="checkbox" id="report-gen-include-system" style="margin-right:8px"/>
                  Include system-generated tickets
                </label>
              </div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn" onclick="previewMonthlyReport()">Preview Report</button>
                <button class="btn primary" onclick="sendMonthlyReportNow()">Send Now</button>
              </div>
              <span id="report-gen-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px;display:block"></span>
              <span id="report-gen-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px;display:block"></span>
            </div>

            <!-- History Table -->
            <div>
              <h5 class="subtitle" style="font-weight:600;margin:0 0 12px 0">Report History</h5>
              <table class="table" style="width:100%;font-size:13px">
                <thead>
                  <tr>
                    <th>Period</th>
                    <th>Company</th>
                    <th>Tickets</th>
                    <th>SLA %</th>
                    <th>Recipients</th>
                    <th>Status</th>
                    <th>Sent</th>
                  </tr>
                </thead>
                <tbody id="report-history-body">
                  <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:16px">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <!-- Raw Variables Editor -->
        <div id="view-raw-variables" style="display:none">
          <div class="row space mb-12">
            <div class="row" style="gap:12px;align-items:center">
              <button class="btn ghost" onclick="switchView('wizard')">← Back to Settings</button>
              <h3 class="title" style="margin:0">Raw Variables</h3>
              <span style="background:#fef3c7;color:#92400e;font-size:11px;font-weight:600;padding:3px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:0.5px">Developer Mode</span>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn" onclick="addVariable()">+ Add Variable</button>
              <button class="btn" onclick="exportVariablesJSON()">Export JSON</button>
              <button class="btn" onclick="showImportModal()">Import JSON</button>
            </div>
          </div>

          <div style="background:#fef2f2;border:1px solid #fecaca;border-left:4px solid #dc2626;border-radius:8px;padding:12px 16px;margin-bottom:16px">
            <div style="display:flex;align-items:flex-start;gap:10px">
              <span style="font-size:18px">⚠️</span>
              <div>
                <div style="font-weight:600;color:#991b1b;margin-bottom:4px">Caution: Changes apply immediately</div>
                <div style="font-size:13px;color:#7f1d1d">Direct access to system configuration variables. Incorrect values may break functionality. Only modify if you understand the impact.</div>
              </div>
            </div>
          </div>

          <div class="card p-16 mb-12">
            <div class="mb-12">
              <input id="raw-vars-search" class="input" placeholder="Search variables..." oninput="filterRawVariables()"/>
            </div>

            <div id="raw-vars-container">
              <!-- Tenant Settings Section -->
              <div class="mb-16">
                <div class="row space mb-8" style="border-bottom:1px solid var(--border);padding-bottom:8px">
                  <h4 class="subtitle" style="margin:0;font-weight:600">Tenant Settings</h4>
                  <span class="subtitle" style="color:#666;font-size:12px">Custom variables (editable, deletable)</span>
                </div>
                <table style="width:100%;border-collapse:collapse">
                  <thead>
                    <tr style="border-bottom:1px solid var(--border)">
                      <th style="text-align:left;padding:8px;width:35%">Key</th>
                      <th style="text-align:left;padding:8px;width:45%">Value</th>
                      <th style="text-align:right;padding:8px;width:20%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="raw-vars-tenant-settings"></tbody>
                </table>
              </div>

              <!-- Email Ingest Section -->
              <div class="mb-16">
                <div class="row space mb-8" style="border-bottom:1px solid var(--border);padding-bottom:8px">
                  <h4 class="subtitle" style="margin:0;font-weight:600">Email Ingest</h4>
                  <span class="subtitle" style="color:#666;font-size:12px">System settings (editable)</span>
                </div>
                <table style="width:100%;border-collapse:collapse">
                  <thead>
                    <tr style="border-bottom:1px solid var(--border)">
                      <th style="text-align:left;padding:8px;width:35%">Key</th>
                      <th style="text-align:left;padding:8px;width:45%">Value</th>
                      <th style="text-align:right;padding:8px;width:20%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="raw-vars-email-ingest"></tbody>
                </table>
              </div>

              <!-- Company Profile Section -->
              <div class="mb-16">
                <div class="row space mb-8" style="border-bottom:1px solid var(--border);padding-bottom:8px">
                  <h4 class="subtitle" style="margin:0;font-weight:600">Company Profile</h4>
                  <span class="subtitle" style="color:#666;font-size:12px">System settings (editable)</span>
                </div>
                <table style="width:100%;border-collapse:collapse">
                  <thead>
                    <tr style="border-bottom:1px solid var(--border)">
                      <th style="text-align:left;padding:8px;width:35%">Key</th>
                      <th style="text-align:left;padding:8px;width:45%">Value</th>
                      <th style="text-align:right;padding:8px;width:20%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="raw-vars-company-profile"></tbody>
                </table>
              </div>

              <!-- Environment Section -->
              <div class="mb-16">
                <div class="row space mb-8" style="border-bottom:1px solid var(--border);padding-bottom:8px">
                  <h4 class="subtitle" style="margin:0;font-weight:600">Environment</h4>
                  <span class="subtitle" style="color:#666;font-size:12px">Read-only (server configuration)</span>
                </div>
                <table style="width:100%;border-collapse:collapse">
                  <thead>
                    <tr style="border-bottom:1px solid var(--border)">
                      <th style="text-align:left;padding:8px;width:35%">Key</th>
                      <th style="text-align:left;padding:8px;width:45%">Value</th>
                      <th style="text-align:right;padding:8px;width:20%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="raw-vars-environment"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Variable Edit Modal -->
        <div id="variable-edit-modal" class="modal" style="display:none">
          <div class="sheet" style="width:min(500px,calc(100vw - 32px))">
            <div class="head">Edit Variable</div>
            <div class="body">
              <div class="mb-12">
                <label class="subtitle">Key</label>
                <input id="var-edit-key" class="input" readonly style="background:#f3f4f6"/>
              </div>
              <div class="mb-12">
                <label class="subtitle">Value</label>
                <textarea id="var-edit-value" class="input" rows="4"></textarea>
              </div>
              <div id="var-edit-warning" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
            </div>
            <div class="foot">
              <button class="btn ghost" onclick="closeVariableModal()">Cancel</button>
              <button class="btn primary" onclick="saveVariableEdit()">Save</button>
            </div>
          </div>
        </div>

        <!-- Variable Add Modal -->
        <div id="variable-add-modal" class="modal" style="display:none">
          <div class="sheet" style="width:min(500px,calc(100vw - 32px))">
            <div class="head">Add Variable</div>
            <div class="body">
              <div class="mb-12">
                <label class="subtitle">Key</label>
                <input id="var-add-key" class="input" placeholder="e.g., my_custom_setting"/>
                <div class="subtitle" style="color:#666;font-size:12px;margin-top:4px">Must start with letter, only letters, numbers, underscores, dots allowed</div>
              </div>
              <div class="mb-12">
                <label class="subtitle">Value</label>
                <textarea id="var-add-value" class="input" rows="4" placeholder="Enter value..."></textarea>
              </div>
              <div id="var-add-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
            </div>
            <div class="foot">
              <button class="btn ghost" onclick="closeAddVariableModal()">Cancel</button>
              <button class="btn primary" onclick="saveNewVariable()">Add Variable</button>
            </div>
          </div>
        </div>

        <!-- JSON Import Modal -->
        <div id="json-import-modal" class="modal" style="display:none">
          <div class="sheet" style="width:min(600px,calc(100vw - 32px))">
            <div class="head">Import Variables from JSON</div>
            <div class="body">
              <div class="mb-12">
                <label class="subtitle">Paste JSON</label>
                <textarea id="json-import-content" class="input" rows="10" placeholder='{"key1": "value1", "key2": "value2"}'></textarea>
              </div>
              <div class="subtitle" style="background:#fef3c7;padding:12px;border-radius:4px;border-left:4px solid #f59e0b">
                <strong>Warning:</strong> This will update existing variables and create new ones. Environment variables cannot be modified.
              </div>
              <div id="json-import-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
            </div>
            <div class="foot">
              <button class="btn ghost" onclick="closeImportModal()">Cancel</button>
              <button class="btn primary" onclick="importVariablesFromJSON()">Import</button>
            </div>
          </div>
        </div>

        <!-- Invite Expert Modal -->
        <div id="invite-expert-modal" class="modal" style="display:none">
          <div class="sheet" style="width:min(500px,calc(100vw - 32px))">
            <div class="head">Invite Expert</div>
            <div class="body">
              <div class="subtitle mb-12" style="background:#eff6ff;padding:12px;border-radius:4px;border-left:4px solid #2563eb">
                Send an invitation email to a new expert. They will receive a link to set their password and join the team.
              </div>

              <div class="mb-12">
                <label class="subtitle">Salutation (optional)</label>
                <select id="invite-salutation" class="input">
                  <option value="">-- None --</option>
                  <option value="Mr.">Mr.</option>
                  <option value="Mrs.">Mrs.</option>
                  <option value="Ms.">Ms.</option>
                  <option value="Dr.">Dr.</option>
                  <option value="Prof.">Prof.</option>
                </select>
              </div>

              <div class="grid2 mb-12">
                <div>
                  <label class="subtitle">First Name *</label>
                  <input id="invite-first-name" class="input" placeholder="John"/>
                </div>
                <div>
                  <label class="subtitle">Last Name *</label>
                  <input id="invite-last-name" class="input" placeholder="Smith"/>
                </div>
              </div>

              <div class="mb-12">
                <label class="subtitle">Email Address *</label>
                <input id="invite-email" class="input" type="email" placeholder="john.smith@company.com"/>
              </div>

              <div id="invite-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
              <div id="invite-success" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
            </div>
            <div class="foot">
              <button class="btn ghost" onclick="closeInviteExpertModal()">Cancel</button>
              <button id="invite-submit-btn" class="btn primary" onclick="sendExpertInvitation()">Send Invitation</button>
            </div>
          </div>
        </div>

        <!-- Bulk Import Experts Modal -->
        <div id="bulk-import-modal" class="modal" style="display:none">
          <div class="sheet" style="width:min(700px,calc(100vw - 32px))">
            <div class="head">Import Experts</div>
            <div class="body">
              <div class="subtitle mb-12" style="background:#eff6ff;padding:12px;border-radius:4px;border-left:4px solid #2563eb">
                Upload a CSV file to invite multiple experts at once.<br>
                <strong>Format:</strong> email, first_name, last_name, salutation (optional)
              </div>

              <div class="mb-12">
                <label class="subtitle">Select CSV File</label>
                <input type="file" id="bulk-import-file" class="input" accept=".csv" style="padding:8px">
              </div>

              <div id="bulk-import-preview" style="display:none" class="mb-12">
                <label class="subtitle">Preview (<span id="bulk-import-count">0</span> experts)</label>
                <div style="max-height:150px;overflow-y:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:4px;padding:8px;font-size:13px">
                  <table style="width:100%">
                    <thead>
                      <tr style="text-align:left">
                        <th style="padding:4px">Email</th>
                        <th style="padding:4px">First Name</th>
                        <th style="padding:4px">Last Name</th>
                        <th style="padding:4px">Salutation</th>
                      </tr>
                    </thead>
                    <tbody id="bulk-import-preview-body"></tbody>
                  </table>
                </div>
              </div>

              <div id="bulk-import-results" style="display:none">
                <h4 class="mb-8">Import Results</h4>
                <div id="bulk-import-summary" class="subtitle mb-12"></div>
                <div style="max-height:200px;overflow-y:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Message</th>
                      </tr>
                    </thead>
                    <tbody id="bulk-import-results-body"></tbody>
                  </table>
                </div>
              </div>

              <div id="bulk-import-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
            </div>
            <div class="foot">
              <button class="btn ghost" onclick="closeBulkImportModal()">Cancel</button>
              <button id="bulk-import-submit-btn" class="btn primary" onclick="processBulkImport()">Import Experts</button>
            </div>
          </div>
        </div>

        <!-- Raise Request -->
        <div id="view-raise" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Raise a Request</h3></div>
          </div>
          <div class="grid2">
            <div class="card p-16">
              <div id="rq-customer-field" class="mb-12" style="display:none">
                <label class="subtitle">Select Customer (required)</label>
                <select id="rq-customer" class="input" onchange="loadCMDBForCustomer()">
                  <option value="">— Select Customer —</option>
                </select>
              </div>
              <div class="mb-12"><label class="subtitle">Title (required)</label><input id="rq-title" class="input" placeholder="e.g., Cannot connect to VPN"/></div>
              <div class="mb-12"><label class="subtitle">Description (required)</label><textarea id="rq-desc" class="input" placeholder="Describe the issue or request…"></textarea></div>
              <div class="mb-12"><label class="subtitle">Priority (optional)</label>
                <select id="rq-priority" class="input"><option value="">—</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select>
              </div>
              <div class="mb-12 sla-override-field" style="display:none"><label class="subtitle">SLA Override (optional)</label>
                <select id="rq-sla" class="input"><option value="">— Use default SLA —</option></select>
              </div>
              <div class="mb-12"><label class="subtitle">Link to CMDB Item (optional)</label><select id="rq-item" class="input"></select></div>
              <div class="mb-12"><label class="subtitle">Link to CI (optional)</label><select id="rq-ci" class="input"></select></div>
              <div id="rq-assignee-field" class="mb-12" style="display:none">
                <label class="subtitle">Assign to Expert (optional)</label>
                <select id="rq-assignee" class="input"><option value="">— Auto (Ticket Pool) —</option></select>
              </div>
              <div class="mb-12"><label class="subtitle">Attachment (placeholder)</label><input class="input" placeholder="Choose file… (not uploaded in demo)"/></div>
              <div class="row"><button class="btn primary" onclick="submitRequest()">Submit request</button><button class="btn" onclick="startChat('assist')">Chat instead</button></div>
              <div class="subtitle" id="rq-hint" style="margin-top:8px">Optional fields can be blank — the assistant will help fill them.</div>
            </div>
            <div class="card p-16">
              <div class="subtitle"><strong>Tips</strong></div>
              <ul style="margin:0 0 0 16px;padding:0">
                <li>Link a CMDB Item & CI for faster triage.</li>
                <li>Use Priority if impact is high or widespread.</li>
                <li>Attachments help experts diagnose issues.</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Audit Log -->
        <div id="view-audit-log" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Audit Log</h3></div>
            <button class="btn" onclick="loadAuditLog()">Refresh</button>
          </div>

          <div class="card p-16 mb-12">
            <div class="row" style="gap:12px;flex-wrap:wrap;align-items:flex-end">
              <div>
                <label class="subtitle">Action</label>
                <select id="audit-filter-action" class="input" style="min-width:160px" onchange="loadAuditLog()">
                  <option value="">All Actions</option>
                </select>
              </div>
              <div>
                <label class="subtitle">User</label>
                <input id="audit-filter-user" class="input" style="min-width:140px" placeholder="Username..." oninput="debounceAuditFilter()"/>
              </div>
              <div>
                <label class="subtitle">From</label>
                <input id="audit-filter-from" type="date" class="input" onchange="loadAuditLog()"/>
              </div>
              <div>
                <label class="subtitle">To</label>
                <input id="audit-filter-to" type="date" class="input" onchange="loadAuditLog()"/>
              </div>
              <button class="btn ghost" onclick="clearAuditFilters()">Clear</button>
            </div>
          </div>

          <div class="card p-16">
            <div id="audit-loading" style="text-align:center;padding:40px;color:var(--muted)">Loading audit log...</div>
            <table id="audit-table" style="display:none;width:100%">
              <thead>
                <tr style="border-bottom:1px solid var(--border)">
                  <th style="text-align:left;padding:8px">Timestamp</th>
                  <th style="text-align:left;padding:8px">User</th>
                  <th style="text-align:left;padding:8px">Action</th>
                  <th style="text-align:left;padding:8px">Entity</th>
                  <th style="text-align:left;padding:8px">Details</th>
                </tr>
              </thead>
              <tbody id="audit-body"></tbody>
            </table>
            <div id="audit-empty" style="display:none;text-align:center;padding:40px;color:var(--muted)">
              <div style="font-size:48px;margin-bottom:16px">📋</div>
              <div>No audit log entries found</div>
            </div>
            <div id="audit-pagination" style="display:none;margin-top:16px;text-align:center">
              <button class="btn ghost" id="audit-prev" onclick="loadAuditLog(auditCurrentPage - 1)">← Previous</button>
              <span id="audit-page-info" style="margin:0 16px;color:var(--muted)"></span>
              <button class="btn ghost" id="audit-next" onclick="loadAuditLog(auditCurrentPage + 1)">Next →</button>
            </div>
          </div>
        </div>

        <!-- Notifications -->
        <div id="view-notifications" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">Notifications</h3></div>
            <button class="btn" onclick="loadNotifications()">Refresh</button>
          </div>

          <div class="card p-16 mb-12">
            <div class="row" style="gap:12px;flex-wrap:wrap;align-items:flex-end">
              <div>
                <label class="subtitle">Severity</label>
                <select id="notif-filter-severity" class="input" style="min-width:120px" onchange="loadNotifications()">
                  <option value="">All</option>
                  <option value="info">Info</option>
                  <option value="warning">Warning</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
              <div>
                <label class="subtitle">Type</label>
                <select id="notif-filter-type" class="input" style="min-width:180px" onchange="loadNotifications()">
                  <option value="">All Types</option>
                  <option value="SLA_RESPONSE_NEAR">Response Near</option>
                  <option value="SLA_RESPONSE_BREACHED">Response Breached</option>
                  <option value="SLA_RESPONSE_PAST">Response Past</option>
                  <option value="SLA_RESOLVE_NEAR">Resolve Near</option>
                  <option value="SLA_RESOLVE_BREACHED">Resolve Breached</option>
                  <option value="SLA_RESOLVE_PAST">Resolve Past</option>
                </select>
              </div>
              <div>
                <label class="subtitle">Delivered</label>
                <select id="notif-filter-delivered" class="input" style="min-width:120px" onchange="loadNotifications()">
                  <option value="">All</option>
                  <option value="0">Undelivered</option>
                  <option value="1">Delivered</option>
                </select>
              </div>
              <div>
                <label class="subtitle">Time Range</label>
                <select id="notif-filter-range" class="input" style="min-width:120px" onchange="onNotifRangeChange()">
                  <option value="">All Time</option>
                  <option value="24h">Last 24 Hours</option>
                  <option value="7d">Last 7 Days</option>
                  <option value="30d">Last 30 Days</option>
                  <option value="custom">Custom Range</option>
                </select>
              </div>
              <div id="notif-custom-range" style="display:none;display:none;gap:8px;align-items:flex-end">
                <div>
                  <label class="subtitle">From</label>
                  <input type="datetime-local" id="notif-range-from" class="input" style="min-width:160px" onchange="loadNotifications()">
                </div>
                <div>
                  <label class="subtitle">To</label>
                  <input type="datetime-local" id="notif-range-to" class="input" style="min-width:160px" onchange="loadNotifications()">
                </div>
              </div>
              <button class="btn ghost" onclick="clearNotifFilters()">Clear</button>
            </div>
          </div>

          <!-- Bulk action bar -->
          <div id="notif-bulk-bar" class="card p-12 mb-12" style="display:none;background:var(--bg-alt)">
            <div class="row" style="gap:12px;align-items:center">
              <span id="notif-selected-count" style="font-weight:500">0 selected</span>
              <button class="btn primary" onclick="deliverSelectedNotifications()">Mark Selected Delivered</button>
              <button class="btn ghost" onclick="clearNotifSelection()">Clear Selection</button>
            </div>
          </div>

          <div class="card p-0">
            <div id="notif-loading" style="text-align:center;padding:40px;color:var(--muted)">Loading notifications...</div>
            <table id="notif-table" class="table" style="display:none;width:100%">
              <thead>
                <tr style="border-bottom:1px solid var(--border)">
                  <th style="padding:8px;width:40px"><input type="checkbox" id="notif-select-all" onchange="toggleNotifSelectAll(this.checked)"></th>
                  <th style="text-align:left;padding:8px;cursor:pointer;user-select:none" onclick="toggleNotifSort()">Time <span id="notif-sort-icon">↓</span></th>
                  <th style="text-align:left;padding:8px">Severity</th>
                  <th style="text-align:left;padding:8px">Type</th>
                  <th style="text-align:left;padding:8px">Message</th>
                  <th style="text-align:left;padding:8px">Ticket</th>
                  <th style="text-align:left;padding:8px">Delivered</th>
                  <th style="text-align:left;padding:8px">Actions</th>
                </tr>
              </thead>
              <tbody id="notif-body"></tbody>
            </table>
            <div id="notif-empty" style="display:none;text-align:center;padding:40px;color:var(--muted)">
              <div style="font-size:48px;margin-bottom:16px">🔔</div>
              <div>No notifications found</div>
            </div>
          </div>
          <div id="notif-pagination" style="display:none;margin-top:16px;text-align:center">
            <button class="btn ghost" id="notif-prev" onclick="loadNotifications(notifCurrentPage - 1)">← Previous</button>
            <span id="notif-page-info" style="margin:0 16px;color:var(--muted)"></span>
            <button class="btn ghost" id="notif-next" onclick="loadNotifications(notifCurrentPage + 1)">Next →</button>
          </div>
        </div>

        <!-- System Control -->
        <div id="view-system-control" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">← Back</button><h3 class="title" style="margin:0 0 0 8px">System Control</h3></div>
            <button class="btn primary" onclick="loadSystemControlSettings()">Refresh</button>
          </div>
          <div class="card p-16 mb-16" style="background:#fef3c7;border:1px solid #f59e0b">
            <div class="row" style="gap:8px;align-items:center">
              <span style="font-size:24px">⚠️</span>
              <div>
                <strong>Testing Kill Switches</strong>
                <div class="subtitle" style="color:#92400e">These controls disable system functionality for testing purposes. Use with caution in production.</div>
              </div>
            </div>
          </div>
          <div class="grid2">
            <div class="card p-16">
              <h4 class="mb-12">Email Controls</h4>

              <div class="card p-16 mb-12" style="border:2px solid #e2e8f0">
                <div class="row space" style="align-items:center">
                  <div>
                    <div style="font-weight:600;font-size:16px">Send Updates to Experts</div>
                    <div class="subtitle">Enable/disable email notifications to experts (ticket assignments, updates)</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="sc-send-emails-experts" onchange="toggleSystemSetting('send_emails_experts', this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div id="sc-send-emails-experts-status" class="subtitle" style="margin-top:8px;padding:8px;border-radius:4px"></div>
              </div>

              <div class="card p-16 mb-12" style="border:2px solid #e2e8f0">
                <div class="row space" style="align-items:center">
                  <div>
                    <div style="font-weight:600;font-size:16px">Send Updates to Customers</div>
                    <div class="subtitle">Enable/disable email notifications to customers (ticket status updates, responses)</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="sc-send-emails-customers" onchange="toggleSystemSetting('send_emails_customers', this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div id="sc-send-emails-customers-status" class="subtitle" style="margin-top:8px;padding:8px;border-radius:4px"></div>
              </div>

              <div class="card p-16 mb-12" style="border:2px solid #e2e8f0">
                <div class="row space" style="align-items:center">
                  <div>
                    <div style="font-weight:600;font-size:16px">Process Emails</div>
                    <div class="subtitle">Enable/disable inbound email processing (automatic ticket creation)</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="sc-process-emails" onchange="toggleSystemSetting('process_emails', this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div id="sc-process-emails-status" class="subtitle" style="margin-top:8px;padding:8px;border-radius:4px"></div>
              </div>

              <div class="card p-16 mb-12" style="border:2px solid #e2e8f0">
                <div class="row space" style="align-items:center">
                  <div>
                    <div style="font-weight:600;font-size:16px">Process SLA Notifications</div>
                    <div class="subtitle">Enable/disable SLA breach checking and notifications</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="sc-process-sla" onchange="toggleSystemSetting('process_sla', this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div id="sc-process-sla-status" class="subtitle" style="margin-top:8px;padding:8px;border-radius:4px"></div>
              </div>
            </div>

            <div class="card p-16">
              <h4 class="mb-12">System Status</h4>
              <div id="sc-status-log" style="background:#f8fafc;border-radius:8px;padding:12px;max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px">
                Loading system status...
              </div>
              <div class="subtitle" style="margin-top:12px">
                <strong>Last Updated:</strong> <span id="sc-last-updated">—</span>
              </div>
            </div>
          </div>

          <div class="card p-16 mt-16">
            <h4 class="mb-12">Recent Setting Changes</h4>
            <table>
              <thead>
                <tr>
                  <th>Setting</th>
                  <th>Old Value</th>
                  <th>New Value</th>
                  <th>Changed By</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="sc-audit-log">
                <tr><td colspan="5" class="subtitle" style="text-align:center">No recent changes</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Knowledge Base -->
        <div id="view-knowledge-base" style="display:none">
          <div class="row space mb-12">
            <div class="row">
              <button class="btn ghost" onclick="switchView('dash')">← Back</button>
              <h3 class="title" style="margin:0 0 0 8px">📚 Knowledge Base</h3>
            </div>
            <div class="row">
              <button class="btn" onclick="showKBArticleModal()">+ New Article</button>
              <button class="btn" onclick="showKBMergeModal()">🔗 Merge Suggestions</button>
            </div>
          </div>

          <!-- KB Stats -->
          <div class="grid4 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Articles</div>
              <div id="kb-total-articles" style="font-size:32px;font-weight:800;color:#667eea">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Published</div>
              <div id="kb-published-articles" style="font-size:32px;font-weight:800;color:#48bb78">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Drafts</div>
              <div id="kb-draft-articles" style="font-size:32px;font-weight:800;color:#ed8936">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Merge Suggestions</div>
              <div id="kb-merge-suggestions" style="font-size:32px;font-weight:800;color:#9f7aea">0</div>
            </div>
          </div>

          <!-- Search & Filter -->
          <div class="card p-16 mb-16">
            <div class="row wrap" style="gap:12px">
              <input type="text" id="kb-search" class="input" style="flex:1;min-width:200px" placeholder="Search articles..." onkeyup="debounceKBSearch()"/>
              <select id="kb-category-filter" class="input" style="width:auto" onchange="loadKBArticles()">
                <option value="">All Categories</option>
              </select>
              <select id="kb-status-filter" class="input" style="width:auto" onchange="loadKBArticles()">
                <option value="">All Status</option>
                <option value="published">Published</option>
                <option value="draft">Draft</option>
                <option value="archived">Archived</option>
              </select>
            </div>
          </div>

          <!-- Articles List -->
          <div class="card">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Views</th>
                  <th>Helpful</th>
                  <th>Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="kb-articles-list">
                <tr><td colspan="7" class="subtitle" style="text-align:center">Loading articles...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </main>
    </div>
  </section>
</div>

<!-- KB Article Modal -->
<div id="kb-article-modal" class="modal">
  <div class="sheet" style="width:min(800px,calc(100vw - 32px))">
    <div class="head">
      <span id="kb-article-modal-title">New Article</span>
    </div>
    <div class="body" style="max-height:70vh;overflow-y:auto">
      <input type="hidden" id="kb-article-id"/>
      <div class="mb-12">
        <div class="subtitle">Title *</div>
        <input type="text" id="kb-article-title" class="input" placeholder="Article title"/>
      </div>
      <div class="grid2 mb-12">
        <div>
          <div class="subtitle">Category *</div>
          <select id="kb-article-category" class="input">
            <option value="">Select category...</option>
          </select>
        </div>
        <div>
          <div class="subtitle">Status</div>
          <select id="kb-article-status" class="input">
            <option value="draft">Draft</option>
            <option value="published">Published</option>
            <option value="archived">Archived</option>
          </select>
        </div>
      </div>
      <div class="mb-12">
        <div class="subtitle">Content *</div>
        <textarea id="kb-article-content" class="input" style="min-height:300px" placeholder="Article content (Markdown supported)"></textarea>
      </div>
      <div class="mb-12">
        <div class="subtitle">Tags (comma-separated)</div>
        <input type="text" id="kb-article-tags" class="input" placeholder="e.g., password, reset, security"/>
      </div>
      <div id="kb-article-error" class="subtitle" style="color:#b91c1c;display:none"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeKBArticleModal()">Cancel</button>
      <button class="btn" onclick="saveKBArticle(true)">Save as Draft</button>
      <button class="btn primary" onclick="saveKBArticle(false)">Save & Publish</button>
    </div>
  </div>
</div>

<!-- KB Article View Modal -->
<div id="kb-article-view-modal" class="modal">
  <div class="sheet" style="width:min(800px,calc(100vw - 32px))">
    <div class="head">
      <span id="kb-view-title">Article</span>
    </div>
    <div class="body" style="max-height:70vh;overflow-y:auto">
      <div id="kb-view-meta" class="subtitle mb-12"></div>
      <div id="kb-view-content" style="line-height:1.6"></div>
      <div class="mt-16" style="border-top:1px solid var(--border);padding-top:16px">
        <div class="subtitle mb-8">Was this article helpful?</div>
        <div class="row" style="gap:8px">
          <button class="btn" onclick="submitKBFeedback(true)">👍 Yes</button>
          <button class="btn" onclick="submitKBFeedback(false)">👎 No</button>
        </div>
        <div id="kb-feedback-msg" class="subtitle" style="margin-top:8px;display:none"></div>
      </div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeKBViewModal()">Close</button>
      <button class="btn" onclick="editKBArticleFromView()">Edit Article</button>
    </div>
  </div>
</div>

<!-- KB Merge Suggestions Modal -->
<div id="kb-merge-modal" class="modal">
  <div class="sheet" style="width:min(900px,calc(100vw - 32px))">
    <div class="head">🔗 Similar Articles - Merge Suggestions</div>
    <div class="body" style="max-height:70vh;overflow-y:auto">
      <div id="kb-merge-list">
        <div class="subtitle" style="text-align:center">Loading suggestions...</div>
      </div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeKBMergeModal()">Close</button>
    </div>
  </div>
</div>

<!-- Live Chat -->
<button id="chat-toggle" class="btn accent" style="position:relative;display:none">💬 Chat<span id="chat-unread-badge" class="chat-badge" style="display:none">0</span></button>
<div id="chat">
  <div class="chat-header">
    <div>
      <div id="chat-header-title">Live Chat</div>
      <div id="chat-header-status" class="chat-status"></div>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <button id="chat-end-btn" class="btn ghost" style="padding:4px 8px;font-size:11px;color:#fff;border-color:rgba(255,255,255,.3);display:none" onclick="liveChatEnd()">End</button>
      <button class="btn ghost" style="padding:4px 8px;font-size:16px;color:#fff;border:none" onclick="liveChatToggle()">✕</button>
    </div>
  </div>
  <!-- Start screen -->
  <div id="chat-start" class="chat-queue" style="display:flex">
    <div style="font-size:36px">💬</div>
    <div style="font-weight:600;font-size:16px">Need help?</div>
    <div style="color:var(--muted);font-size:13px;margin-bottom:12px">Start a live chat with our support team</div>
    <textarea id="chat-start-desc" class="input" placeholder="Briefly describe your issue..." style="width:100%;max-width:280px;height:60px;resize:none;font-size:13px"></textarea>
    <button class="btn primary" onclick="liveChatStart()" style="margin-top:8px">Start Chat</button>
    <div id="chat-experts-online" style="font-size:11px;color:var(--muted);margin-top:8px"></div>
  </div>
  <!-- Qualification screen -->
  <div id="chat-qualify-screen" class="chat-qualify" style="display:none">
    <div style="font-weight:600;margin-bottom:8px">Quick questions to help us serve you faster:</div>
    <div id="chat-qualify-questions"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn primary" onclick="liveChatSubmitQualification()" style="flex:1">Submit</button>
      <button class="btn ghost" onclick="liveChatSkipQualification()" style="font-size:12px">Skip All</button>
    </div>
    <div id="chat-qualify-penalty" style="font-size:11px;color:var(--muted);margin-top:8px"></div>
  </div>
  <!-- Queue waiting screen -->
  <div id="chat-queue-screen" class="chat-queue" style="display:none">
    <div style="font-size:11px;color:var(--muted)">You are in queue</div>
    <div class="queue-pos" id="chat-queue-pos">1</div>
    <div style="color:var(--muted);font-size:13px">Waiting for an expert...</div>
    <div class="spinner" style="margin-top:12px;width:24px;height:24px;border:3px solid var(--border);border-top:3px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite"></div>
  </div>
  <!-- Active chat screen -->
  <div id="chat-active-screen" style="display:none;flex:1;flex-direction:column;overflow:hidden">
    <div id="chat-messages" class="chat-messages"></div>
    <div id="chat-typing" class="chat-typing"></div>
    <div class="chat-footer">
      <label style="cursor:pointer;font-size:18px;padding:4px" title="Attach file">📎<input type="file" id="chat-file-input" style="display:none" onchange="liveChatUploadFile(this)"></label>
      <input id="chat-msg-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')liveChatSend()">
      <button class="btn primary" style="padding:6px 12px;font-size:13px" onclick="liveChatSend()">Send</button>
    </div>
  </div>
  <!-- Rating screen -->
  <div id="chat-rating-screen" class="chat-rating" style="display:none">
    <div style="font-size:36px">⭐</div>
    <div style="font-weight:600">How was your experience?</div>
    <div class="stars" id="chat-stars">
      <span onclick="liveChatRate(1)">☆</span>
      <span onclick="liveChatRate(2)">☆</span>
      <span onclick="liveChatRate(3)">☆</span>
      <span onclick="liveChatRate(4)">☆</span>
      <span onclick="liveChatRate(5)">☆</span>
    </div>
    <button class="btn ghost" onclick="liveChatClose()" style="margin-top:8px;font-size:12px">Skip</button>
  </div>
</div>

<!-- Completion Modal -->
<div id="dlg" class="modal" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
  <div class="sheet">
    <div class="head"><span id="dlg-title">Complete Action</span></div>
    <div class="body">
      <div class="mb-12"><div class="subtitle">What did you do?</div>
        <textarea id="dlg-note" class="input" placeholder="Add a succinct completion note… (required)"></textarea>
      </div>
      <div id="dlg-assignee-row" class="mb-12" style="display:none">
        <div class="subtitle">New assignee</div>
        <select id="dlg-assignee" class="input">
          <option value="">-- Select Expert --</option>
        </select>
      </div>
      <div id="dlg-error" class="subtitle" style="color:#b91c1c;display:none"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeDlg()">Cancel</button>
      <button class="btn primary" onclick="submitDlg()">Confirm</button>
    </div>
  </div>
</div>

<!-- Bulk Action Modal -->
<div id="bulk-action-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bulk-action-title" style="display:none">
  <div class="sheet" style="max-width:500px">
    <div class="head"><span id="bulk-action-title">Bulk Action</span></div>
    <div class="body">
      <div id="bulk-action-summary" class="mb-12" style="padding:12px;background:#e0f2fe;border-radius:8px;font-weight:600"></div>
      <div id="bulk-action-assignee-row" class="mb-12" style="display:none">
        <div class="subtitle">Assign to Expert *</div>
        <select id="bulk-action-assignee" class="input">
          <option value="">-- Select Expert --</option>
        </select>
      </div>
      <div class="mb-12">
        <div class="subtitle">Action Note (applies to all selected tickets) *</div>
        <textarea id="bulk-action-note" class="input" placeholder="Enter a note that will be added to all selected tickets..." rows="3"></textarea>
      </div>
      <div id="bulk-action-error" class="subtitle" style="color:#b91c1c;display:none"></div>
      <div id="bulk-action-progress" style="display:none">
        <div class="subtitle">Processing...</div>
        <div class="progress"><span id="bulk-action-progress-bar" style="width:0%"></span></div>
        <div id="bulk-action-progress-text" class="subtitle" style="margin-top:4px">0 of 0 completed</div>
      </div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeBulkActionDialog()">Cancel</button>
      <button id="bulk-action-submit-btn" class="btn primary" onclick="submitBulkAction()">Confirm</button>
    </div>
  </div>
</div>

<!-- Mark as System Monitor Modal (APO-48) -->
<div id="mark-system-modal" class="modal" role="dialog" aria-modal="true" style="display:none">
  <div class="sheet" style="max-width:550px">
    <div class="head"><span>📡 Mark as System Monitor</span></div>
    <div class="body">
      <div class="mb-12" style="padding:12px;background:#f3e8ff;border-radius:8px;color:#6b21a8">
        <strong>This will mark the ticket as a system/monitoring alert.</strong><br>
        <span style="font-size:13px">Optionally create a rule to auto-classify similar future tickets.</span>
      </div>

      <!-- Ticket Info -->
      <div class="mb-12" style="padding:10px;background:#f9fafb;border-radius:6px;font-size:13px">
        <div><strong>Ticket:</strong> <span id="mark-system-ticket-title"></span></div>
      </div>

      <!-- Create Rule Checkbox -->
      <div class="mb-12">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="mark-system-create-rule" checked onchange="toggleMarkSystemRuleFields()">
          <span><strong>Create a rule to auto-classify similar tickets</strong></span>
        </label>
      </div>

      <!-- Rule Configuration (shown when checkbox is checked) -->
      <div id="mark-system-rule-fields">
        <div class="mb-12">
          <div class="subtitle">Rule Name *</div>
          <input type="text" id="mark-system-rule-name" class="input" placeholder="e.g., Nagios Alerts">
        </div>

        <div class="mb-12">
          <div class="subtitle">Search Text (pattern to match) *</div>
          <input type="text" id="mark-system-search-text" class="input" placeholder="e.g., NAGIOS or [ALERT]">
          <div class="subtitle" style="margin-top:4px;font-size:11px;color:#6b7280">
            Tip: Use a keyword that appears in similar monitoring emails
          </div>
        </div>

        <div class="mb-12">
          <div class="subtitle">Search In</div>
          <select id="mark-system-search-in" class="input">
            <option value="title">Title only</option>
            <option value="body">Description only</option>
            <option value="both" selected>Both title and description</option>
          </select>
        </div>

        <div class="mb-12">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="mark-system-case-sensitive">
            <span>Case sensitive matching</span>
          </label>
        </div>
      </div>

      <div id="mark-system-error" class="subtitle" style="color:#b91c1c;display:none"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeMarkSystemModal()">Cancel</button>
      <button class="btn primary" onclick="submitMarkAsSystem()" style="background:#7c3aed">📡 Mark as System</button>
    </div>
  </div>
</div>

<!-- Decline Resolution Modal -->
<div id="decline-resolution-modal" class="modal" role="dialog" aria-modal="true" style="display:none">
  <div class="sheet" style="max-width:600px">
    <div class="head"><span>Decline Resolution</span></div>
    <div class="body">
      <div class="mb-12" style="padding:12px;background:#fef3c7;border-radius:8px;color:#92400e">
        We're sorry we didn't get it right. Please tell us what we missed so we can try again.
      </div>
      <div class="mb-12">
        <div class="subtitle">Why are you declining this resolution? *</div>
        <textarea id="decline-reason" class="input" placeholder="Please explain what was wrong or what we missed..." style="min-height:150px;resize:vertical"></textarea>
      </div>
      <div class="mb-12">
        <div class="subtitle">Attachments (optional)</div>
        <input type="file" id="decline-attachments" class="input" multiple accept="image/*,.pdf,.doc,.docx,.txt,.log" style="padding:8px"/>
        <div class="subtitle" style="margin-top:4px;font-size:11px">Supported: Images, PDF, Word, Text, Log files</div>
      </div>
      <div id="decline-error" class="subtitle" style="color:#b91c1c;display:none"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeDeclineModal()">Cancel</button>
      <button class="btn warn" onclick="submitDeclineResolution()">Submit Feedback</button>
    </div>
  </div>
</div>

<!-- Expert Form Modal -->
<div id="expert-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="expert-modal-title" style="display:none">
  <div class="sheet" style="max-width:700px;max-height:90vh;overflow-y:auto">
    <div class="head"><span id="expert-modal-title">Add Expert</span></div>
    <div class="body">
      <h4 class="mb-12">Account Info</h4>
      <div class="mb-12">
        <div class="subtitle">Username *</div>
        <input id="expert-form-username" class="input" placeholder="Username"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Email *</div>
        <input id="expert-form-email" class="input" type="email" placeholder="Email address"/>
      </div>
      <div class="mb-12" id="expert-form-password-row">
        <div class="subtitle">Password *</div>
        <input id="expert-form-password" class="input" type="password" placeholder="Password"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Role *</div>
        <select id="expert-form-role" class="input">
          <option value="expert">Expert</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="mb-12">
        <div class="subtitle">Status</div>
        <select id="expert-form-status" class="input">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
      <div class="mb-12">
        <div class="subtitle">Rating</div>
        <input id="expert-form-rating" class="input" type="number" min="0" max="5" placeholder="0-5"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Reference Code</div>
        <input id="expert-form-reference" class="input" placeholder="Reference code"/>
      </div>
      <div class="mb-12">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input id="expert-form-email-updates" type="checkbox" checked/>
          <span>Send expert email updates</span>
        </label>
      </div>

      <h4 class="mb-12 mt-16">User Details</h4>
      <div class="mb-12">
        <div class="subtitle">Full Name</div>
        <input id="expert-form-fullname" class="input" placeholder="Full name"/>
      </div>
      <div class="row" style="gap:8px">
        <div class="mb-12" style="flex:1">
          <div class="subtitle">First Name</div>
          <input id="expert-form-firstname" class="input" placeholder="First name"/>
        </div>
        <div class="mb-12" style="flex:1">
          <div class="subtitle">Middle Name</div>
          <input id="expert-form-middlename" class="input" placeholder="Middle name"/>
        </div>
        <div class="mb-12" style="flex:1">
          <div class="subtitle">Last Name</div>
          <input id="expert-form-lastname" class="input" placeholder="Last name"/>
        </div>
      </div>
      <div class="mb-12">
        <div class="subtitle">Screen Name</div>
        <input id="expert-form-screenname" class="input" placeholder="Screen name"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Phone</div>
        <input id="expert-form-phone" class="input" placeholder="Phone number"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Department</div>
        <input id="expert-form-department" class="input" placeholder="Department"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Location</div>
        <input id="expert-form-location" class="input" placeholder="Location"/>
      </div>

      <h4 class="mb-12 mt-16">Address</h4>
      <div class="mb-12">
        <div class="subtitle">Street Address</div>
        <input id="expert-form-street" class="input" placeholder="Street address"/>
      </div>
      <div class="row" style="gap:8px">
        <div class="mb-12" style="flex:2">
          <div class="subtitle">City</div>
          <input id="expert-form-city" class="input" placeholder="City"/>
        </div>
        <div class="mb-12" style="flex:1">
          <div class="subtitle">State/Province</div>
          <input id="expert-form-state" class="input" placeholder="State"/>
        </div>
        <div class="mb-12" style="flex:1">
          <div class="subtitle">Postcode</div>
          <input id="expert-form-postcode" class="input" placeholder="Postcode"/>
        </div>
      </div>
      <div class="mb-12">
        <div class="subtitle">Country</div>
        <input id="expert-form-country" class="input" placeholder="Country"/>
      </div>

      <h4 class="mb-12 mt-16">System Settings</h4>
      <div class="mb-12">
        <div class="subtitle">Time Zone</div>
        <input id="expert-form-timezone" class="input" placeholder="e.g., UTC, America/New_York"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Support Language</div>
        <input id="expert-form-language" class="input" placeholder="e.g., English"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Interface Language</div>
        <input id="expert-form-interface-lang" class="input" placeholder="e.g., English"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Security Level</div>
        <input id="expert-form-security-level" class="input" placeholder="e.g., Agent Manager"/>
      </div>

      <div id="expert-form-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:16px"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeExpertModal()">Cancel</button>
      <button class="btn primary" onclick="saveExpert()">Save Expert</button>
    </div>
  </div>
</div>

<!-- CMDB Management Modals -->
<div id="cmdb-mgmt-modal" class="modal" role="dialog" aria-modal="true" style="display:none">
  <div class="sheet" style="max-width:700px;max-height:90vh;overflow-y:auto">
    <div class="head"><span id="cmdb-mgmt-modal-title">Add CMDB Item</span></div>
    <div class="body">
      <input type="hidden" id="cmdb-mgmt-id">
      <div class="row" style="gap:16px">
        <div class="mb-12" style="flex:1"><div class="subtitle">Asset Name *</div><input id="cmdb-mgmt-asset-name" class="input" required/></div>
        <div class="mb-12" style="flex:1"><div class="subtitle">Asset Category *</div><input id="cmdb-mgmt-asset-category" class="input" required/></div>
      </div>
      <div class="row" style="gap:16px">
        <div class="mb-12" style="flex:1"><div class="subtitle">Category Field Value</div><input id="cmdb-mgmt-category-field" class="input"/></div>
        <div class="mb-12" style="flex:1"><div class="subtitle">Status</div>
          <select id="cmdb-mgmt-status" class="input"><option value="active">Active</option><option value="inactive">Inactive</option><option value="maintenance">Maintenance</option></select>
        </div>
      </div>
      <div class="row" style="gap:16px">
        <div class="mb-12" style="flex:1"><div class="subtitle">Brand Name</div><input id="cmdb-mgmt-brand" class="input"/></div>
        <div class="mb-12" style="flex:1"><div class="subtitle">Model Name</div><input id="cmdb-mgmt-model" class="input"/></div>
      </div>
      <div class="row" style="gap:16px">
        <div class="mb-12" style="flex:1"><div class="subtitle">Customer Name</div><input id="cmdb-mgmt-customer-name" class="input"/></div>
        <div class="mb-12" style="flex:1"><div class="subtitle">Employee Of</div><input id="cmdb-mgmt-employee-of" class="input"/></div>
      </div>
      <div class="mb-12"><div class="subtitle">Asset Location</div><input id="cmdb-mgmt-location" class="input"/></div>
      <div class="mb-12"><div class="subtitle">Comment</div><textarea id="cmdb-mgmt-comment" class="input" rows="3"></textarea></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="cmdbMgmtCloseModal()">Cancel</button>
      <button class="btn primary" onclick="cmdbMgmtSave()">Save</button>
    </div>
  </div>
</div>

<div id="cmdb-mgmt-view-modal" class="modal" role="dialog" aria-modal="true" style="display:none">
  <div class="sheet" style="max-width:900px;max-height:90vh;overflow-y:auto">
    <div class="head"><span>CMDB Item Details</span></div>
    <div class="body" id="cmdb-mgmt-view-content"></div>
    <div class="foot"><button class="btn ghost" onclick="cmdbMgmtCloseViewModal()">Close</button></div>
  </div>
</div>

<div id="cmdb-mgmt-import-modal" class="modal" role="dialog" aria-modal="true" style="display:none">
  <div class="sheet" style="max-width:600px">
    <div class="head"><span>Import CMDB Items from CSV</span></div>
    <div class="body">
      <p class="mb-12" style="color:var(--muted)">Download the <a href="#" onclick="cmdbMgmtDownloadTemplate()" style="color:var(--primary);font-weight:600;">CSV template</a> to see the required format.</p>
      <div class="mb-12" style="border:2px dashed var(--border);border-radius:8px;padding:40px;text-align:center;cursor:pointer" onclick="document.getElementById('cmdb-mgmt-csv-file').click()">
        <input type="file" id="cmdb-mgmt-csv-file" accept=".csv" style="display:none" onchange="cmdbMgmtFileSelected(event)">
        <div style="font-size:48px;margin-bottom:16px;">📄</div>
        <div id="cmdb-mgmt-file-name" style="font-weight:600;">Click to select CSV file</div>
      </div>
      <div id="cmdb-mgmt-import-progress" style="display:none;background:var(--bg);padding:16px;border-radius:8px;margin-top:16px;">
        <div id="cmdb-mgmt-import-status"></div>
      </div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="cmdbMgmtCloseImportModal()">Cancel</button>
      <button class="btn success" id="cmdb-mgmt-import-btn" onclick="cmdbMgmtImport()" disabled>Import</button>
    </div>
  </div>
</div>

<!-- Role Switcher Modal -->
<div id="role-switcher-modal" class="modal" role="dialog" aria-modal="true" style="display:none">
  <div class="sheet" style="max-width:400px">
    <div class="head"><span>Switch View Mode</span></div>
    <div class="body">
      <p style="color:var(--muted);margin-bottom:16px;">Select a role to view the system as that user type. Choose a specific user to see only their tickets.</p>

      <div class="mb-12">
        <label class="subtitle">View as Role</label>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
          <label id="role-opt-admin" style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="radio" name="impersonate-role" value="admin" onchange="onImpersonateRoleChange()">
            <span>Admin</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="radio" name="impersonate-role" value="expert" onchange="onImpersonateRoleChange()">
            <span>Expert</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="radio" name="impersonate-role" value="customer" onchange="onImpersonateRoleChange()">
            <span>Customer</span>
          </label>
        </div>
      </div>

      <div id="impersonate-expert-section" class="mb-12" style="display:none;">
        <label class="subtitle">Select Expert</label>
        <select id="impersonate-expert-select" class="input">
          <option value="">-- Select Expert --</option>
        </select>
      </div>

      <div id="impersonate-customer-section" class="mb-12" style="display:none;">
        <label class="subtitle">Select Customer</label>
        <select id="impersonate-customer-select" class="input">
          <option value="">-- Select Customer --</option>
        </select>
      </div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeRoleSwitcherModal()">Cancel</button>
      <button class="btn primary" onclick="applyRoleSwitch()">Apply</button>
    </div>
  </div>
</div>

<!-- Business Hours Modal -->
<div id="business-hours-modal" class="modal" role="dialog" aria-modal="true" style="display:none;align-items:flex-start;padding-top:10vh">
  <div class="sheet" style="max-width:500px;max-height:80vh;overflow:auto">
    <div class="head"><span id="business-hours-modal-title">Add Business Hours Profile</span></div>
    <div class="body">
      <input type="hidden" id="bh-edit-id">
      <div class="mb-12">
        <label class="subtitle">Profile Name *</label>
        <input id="bh-name" class="input" placeholder="e.g., Standard Business Hours"/>
      </div>
      <div class="mb-12">
        <label class="subtitle">Timezone *</label>
        <select id="bh-timezone" class="input">
          <option value="Australia/Sydney">Australia/Sydney</option>
          <option value="Australia/Melbourne">Australia/Melbourne</option>
          <option value="Australia/Brisbane">Australia/Brisbane</option>
          <option value="Australia/Perth">Australia/Perth</option>
          <option value="Europe/London">Europe/London</option>
          <option value="Europe/Madrid">Europe/Madrid</option>
          <option value="America/New_York">America/New_York</option>
          <option value="America/Los_Angeles">America/Los_Angeles</option>
          <option value="Asia/Singapore">Asia/Singapore</option>
          <option value="Asia/Tokyo">Asia/Tokyo</option>
          <option value="UTC">UTC</option>
        </select>
      </div>
      <div class="mb-12">
        <label class="subtitle">
          <input type="checkbox" id="bh-is-24x7" style="margin-right:8px" onchange="toggle24x7()"/>
          24x7 Support (always on)
        </label>
      </div>
      <div id="bh-hours-section">
        <div class="row" style="gap:12px;margin-bottom:12px">
          <div style="flex:1">
            <label class="subtitle">Start Time</label>
            <input id="bh-start-time" class="input" type="time" value="09:00"/>
          </div>
          <div style="flex:1">
            <label class="subtitle">End Time</label>
            <input id="bh-end-time" class="input" type="time" value="17:00"/>
          </div>
        </div>
        <div class="mb-12">
          <label class="subtitle">Working Days</label>
          <div class="row wrap" style="gap:8px;margin-top:8px">
            <label style="display:flex;align-items:center;gap:4px"><input type="checkbox" id="bh-day-1" checked> Mon</label>
            <label style="display:flex;align-items:center;gap:4px"><input type="checkbox" id="bh-day-2" checked> Tue</label>
            <label style="display:flex;align-items:center;gap:4px"><input type="checkbox" id="bh-day-3" checked> Wed</label>
            <label style="display:flex;align-items:center;gap:4px"><input type="checkbox" id="bh-day-4" checked> Thu</label>
            <label style="display:flex;align-items:center;gap:4px"><input type="checkbox" id="bh-day-5" checked> Fri</label>
            <label style="display:flex;align-items:center;gap:4px"><input type="checkbox" id="bh-day-6"> Sat</label>
            <label style="display:flex;align-items:center;gap:4px"><input type="checkbox" id="bh-day-7"> Sun</label>
          </div>
        </div>
      </div>
      <div id="bh-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeBusinessHoursModal()">Cancel</button>
      <button class="btn primary" onclick="saveBusinessHours()">Save</button>
    </div>
  </div>
</div>

<!-- SLA Definition Modal -->
<div id="sla-definition-modal" class="modal" role="dialog" aria-modal="true" style="display:none;align-items:flex-start;padding-top:10vh">
  <div class="sheet" style="max-width:500px;max-height:80vh;overflow:auto">
    <div class="head"><span id="sla-definition-modal-title">Add SLA Definition</span></div>
    <div class="body">
      <input type="hidden" id="sla-edit-id">
      <div class="mb-12">
        <label class="subtitle">SLA Name *</label>
        <input id="sla-name" class="input" placeholder="e.g., Premium SLA"/>
      </div>
      <div class="mb-12 sla-description-row">
        <label class="subtitle">Description</label>
        <input id="sla-description" class="input" placeholder="e.g., Priority support for enterprise clients"/>
      </div>
      <div class="mb-12">
        <label class="subtitle">Business Hours Profile</label>
        <select id="sla-business-hours" class="input">
          <option value="">-- Select Business Hours --</option>
        </select>
      </div>
      <div class="row" style="gap:12px;margin-bottom:12px;align-items:flex-start">
        <div style="flex:1">
          <label class="subtitle">Response Target *</label>
          <div class="row" style="gap:8px">
            <input id="sla-response-value" class="input" type="number" min="1" value="60" style="width:80px"/>
            <select id="sla-response-unit" class="input" style="flex:1">
              <option value="minutes">Minutes</option>
              <option value="hours" selected>Hours</option>
            </select>
          </div>
        </div>
        <div style="flex:1">
          <label class="subtitle">Resolve (after pickup) target *</label>
          <div class="row" style="gap:8px">
            <input id="sla-resolve-value" class="input" type="number" min="1" value="8" style="width:80px"/>
            <select id="sla-resolve-unit" class="input" style="flex:1">
              <option value="minutes">Minutes</option>
              <option value="hours" selected>Hours</option>
            </select>
          </div>
          <div style="font-size:11px;color:#666;margin-top:4px">Resolution clock starts when ticket is first responded to.</div>
        </div>
      </div>
      <div id="sla-def-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeSLADefinitionModal()">Cancel</button>
      <button class="btn primary" onclick="saveSLADefinition()">Save</button>
    </div>
  </div>
</div>

<!-- Category SLA Mapping Modal -->
<div id="category-mapping-modal" class="modal" role="dialog" aria-modal="true" style="display:none;align-items:flex-start;padding-top:10vh">
  <div class="sheet" style="max-width:450px;max-height:80vh;overflow:auto">
    <div class="head"><span id="category-mapping-modal-title">Add Category Mapping</span></div>
    <div class="body">
      <input type="hidden" id="cat-map-edit-id">
      <div class="mb-12">
        <label class="subtitle">Category *</label>
        <input id="cat-map-category" class="input" placeholder="e.g., Network" maxlength="50"/>
        <div style="font-size:11px;color:#666;margin-top:4px">Category name (case-insensitive matching)</div>
      </div>
      <div class="mb-12">
        <label class="subtitle">SLA Definition *</label>
        <select id="cat-map-sla" class="input">
          <option value="">-- Select SLA --</option>
        </select>
      </div>
      <div class="mb-12">
        <label class="row" style="gap:8px;cursor:pointer">
          <input type="checkbox" id="cat-map-active" checked>
          <span class="subtitle" style="margin:0">Active</span>
        </label>
      </div>
      <div id="cat-map-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeCategoryMappingModal()">Cancel</button>
      <button class="btn primary" onclick="saveCategoryMapping()">Save</button>
    </div>
  </div>
</div>

<!-- CMDB Custom Field Modal -->
<div id="custom-field-modal" class="modal" role="dialog" aria-modal="true" style="display:none;align-items:flex-start;padding-top:10vh">
  <div class="sheet" style="max-width:500px;max-height:80vh;overflow:auto">
    <div class="head"><span id="custom-field-modal-title">Add Custom Field</span></div>
    <div class="body">
      <input type="hidden" id="custom-field-edit-id">
      <div class="mb-12">
        <label class="subtitle">Asset Category *</label>
        <select id="custom-field-category" class="input">
          <option value="">-- Select Category --</option>
        </select>
      </div>
      <div class="mb-12">
        <label class="subtitle">Field Name *</label>
        <input id="custom-field-name" class="input" placeholder="e.g., serial_number" maxlength="100"/>
        <div style="font-size:11px;color:#666;margin-top:4px">Internal name (no spaces, use underscores)</div>
      </div>
      <div class="mb-12">
        <label class="subtitle">Field Label *</label>
        <input id="custom-field-label" class="input" placeholder="e.g., Serial Number" maxlength="150"/>
        <div style="font-size:11px;color:#666;margin-top:4px">Display label shown to users</div>
      </div>
      <div class="mb-12">
        <label class="subtitle">Field Type *</label>
        <select id="custom-field-type" class="input" onchange="toggleDropdownOptions()">
          <option value="text">Text</option>
          <option value="number">Number</option>
          <option value="date">Date</option>
          <option value="dropdown">Dropdown</option>
          <option value="boolean">Yes/No</option>
          <option value="url">URL</option>
        </select>
      </div>
      <div id="dropdown-options-section" class="mb-12" style="display:none">
        <label class="subtitle">Dropdown Options *</label>
        <textarea id="custom-field-dropdown-options" class="input" rows="4" placeholder="Enter one option per line"></textarea>
        <div style="font-size:11px;color:#666;margin-top:4px">Enter each option on a new line</div>
      </div>
      <div class="mb-12">
        <label class="subtitle">Display Order</label>
        <input id="custom-field-order" type="number" class="input" value="0" min="0"/>
        <div style="font-size:11px;color:#666;margin-top:4px">Lower numbers appear first</div>
      </div>
      <div class="mb-12">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="custom-field-required"/>
          <span>Required field</span>
        </label>
      </div>
      <div id="custom-field-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeCustomFieldModal()">Cancel</button>
      <button class="btn primary" onclick="saveCustomField()">Save</button>
    </div>
  </div>
</div>

<!-- CMDB Add Relationship Modal -->
<div id="add-relationship-modal" class="modal" role="dialog" aria-modal="true" style="display:none;align-items:flex-start;padding-top:10vh">
  <div class="sheet" style="max-width:500px;max-height:80vh;overflow:auto">
    <div class="head"><span>Add Relationship</span></div>
    <div class="body">
      <div class="mb-12">
        <label class="subtitle">Relationship Type *</label>
        <select id="rel-type" class="input">
          <option value="depends_on">Depends On</option>
          <option value="hosts">Hosts</option>
          <option value="connects_to">Connects To</option>
          <option value="part_of">Part Of</option>
          <option value="uses">Uses</option>
          <option value="provides">Provides</option>
          <option value="backs_up">Backs Up</option>
          <option value="monitors">Monitors</option>
        </select>
        <div style="font-size:11px;color:#666;margin-top:4px">This asset [relationship type] the target asset</div>
      </div>
      <div class="mb-12">
        <label class="subtitle">Target Asset *</label>
        <input id="rel-target-search" class="input" placeholder="Search for asset..." oninput="searchRelTargetAssets()"/>
        <div id="rel-target-results" style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;margin-top:8px;display:none"></div>
        <input type="hidden" id="rel-target-cmdb-id"/>
        <div id="rel-target-selected" style="display:none;margin-top:8px;padding:8px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
          <div class="row space">
            <div>
              <div id="rel-target-name" style="font-weight:600"></div>
              <div id="rel-target-category" class="subtitle"></div>
            </div>
            <button class="btn ghost" onclick="clearRelTarget()" style="padding:4px 8px">✕</button>
          </div>
        </div>
      </div>
      <div class="mb-12">
        <label class="subtitle">Description (optional)</label>
        <textarea id="rel-description" class="input" rows="2" placeholder="Notes about this relationship"></textarea>
      </div>
      <div id="rel-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeAddRelationshipModal()">Cancel</button>
      <button class="btn primary" onclick="saveRelationship()">Add Relationship</button>
    </div>
  </div>
</div>

<!-- CMDB Impact Analysis Modal -->
<div id="impact-analysis-modal" class="modal" role="dialog" aria-modal="true" style="display:none;align-items:flex-start;padding-top:5vh">
  <div class="sheet" style="max-width:700px;max-height:85vh;overflow:auto">
    <div class="head"><span>🔍 Impact Analysis</span></div>
    <div class="body">
      <div id="impact-root-info" class="mb-12" style="padding:12px;background:var(--bg);border-radius:6px">
        <div style="font-weight:600">Analyzing: <span id="impact-root-name"></span></div>
        <div class="subtitle" id="impact-root-category"></div>
      </div>
      <div id="impact-loading" style="text-align:center;padding:20px;color:var(--muted);">Analyzing dependencies...</div>
      <div id="impact-results" style="display:none">
        <div class="row mb-12" style="gap:16px;flex-wrap:wrap">
          <div style="padding:12px;background:var(--bg);border-radius:6px;flex:1;min-width:120px;text-align:center">
            <div id="impact-total-count" style="font-size:24px;font-weight:700;color:#e53e3e">0</div>
            <div class="subtitle">Impacted Items</div>
          </div>
          <div style="padding:12px;background:var(--bg);border-radius:6px;flex:1;min-width:120px;text-align:center">
            <div id="impact-max-depth" style="font-size:24px;font-weight:700;color:#d97706">0</div>
            <div class="subtitle">Max Depth</div>
          </div>
        </div>
        <div class="subtitle mb-8" style="font-weight:600">By Category</div>
        <div id="impact-by-category" class="mb-12"></div>
        <div class="subtitle mb-8" style="font-weight:600">Impacted Items</div>
        <div id="impact-tree" style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;padding:12px"></div>
      </div>
      <div id="impact-empty" style="display:none;text-align:center;padding:30px;color:var(--muted);">
        <div style="font-size:32px;margin-bottom:12px">✅</div>
        <div>No downstream dependencies found</div>
        <div style="margin-top:8px;font-size:13px">This asset has no items that depend on it</div>
      </div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeImpactAnalysisModal()">Close</button>
    </div>
  </div>
</div>

<!-- Global Search Modal (Command Palette) -->
<div id="global-search-modal" class="global-search-modal" onclick="if(event.target===this)closeGlobalSearch()">
  <div class="global-search-container" onclick="event.stopPropagation()">
    <div class="global-search-header">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.3-4.3"></path>
      </svg>
      <input type="text" id="global-search-input" class="global-search-input" placeholder="Search ServiFlow..." autocomplete="off" onkeydown="handleGlobalSearchKeydown(event)" oninput="onGlobalSearchInput(event)">
      <span class="global-search-esc">Esc</span>
    </div>
    <div class="global-search-tabs">
      <button class="global-search-tab active" data-category="all" onclick="setSearchCategory('all')">All</button>
      <button class="global-search-tab" data-category="tickets" onclick="setSearchCategory('tickets')">Tickets</button>
      <button class="global-search-tab" data-category="cmdb" onclick="setSearchCategory('cmdb')">CMDB</button>
      <button class="global-search-tab" data-category="customers" onclick="setSearchCategory('customers')">Customers</button>
      <button class="global-search-tab" data-category="sla" onclick="setSearchCategory('sla')">SLAs</button>
    </div>
    <div id="global-search-results" class="global-search-results">
      <div class="global-search-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
        <div>Start typing to search...</div>
      </div>
    </div>
    <div class="global-search-footer">
      <span><kbd>↑</kbd><kbd>↓</kbd> Navigate</span>
      <span><kbd>Enter</kbd> Open</span>
      <span><kbd>Tab</kbd> Filter</span>
      <span><kbd>Esc</kbd> Close</span>
    </div>
  </div>
</div>

<script>
  // ServiFlow Version: 2026-01-20-v2 - VERIFY THIS IN CONSOLE TO CHECK CACHING
  console.log('[ServiFlow] Loading version 2026-01-23-v1');

  // API Base URL - use current origin for deployed version, localhost for development
  const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? window.location.origin
    : window.location.origin;

  // Error banner
  window.addEventListener('error', function(e) { const el=document.getElementById('err'); el.textContent='JavaScript error: ' + (e.message || e.error); el.style.display='block'; });

  // Check authentication and restore session on page load
  window.addEventListener('DOMContentLoaded', async function() {
    // Capacitor platform detection
    if (window.Capacitor) {
      document.body.classList.add('capacitor-app');
      if (window.Capacitor.getPlatform() === 'ios') {
        document.body.classList.add('capacitor-ios');
      } else if (window.Capacitor.getPlatform() === 'android') {
        document.body.classList.add('capacitor-android');
      }
      // Hide Capacitor splash screen after app loads
      if (window.Capacitor.Plugins && window.Capacitor.Plugins.SplashScreen) {
        window.Capacitor.Plugins.SplashScreen.hide();
      }
    }

    // Move modals to document.body to escape Ionic transform containers
    ['sla-definition-modal', 'business-hours-modal', 'category-mapping-modal', 'global-search-modal'].forEach(id => {
      const modal = document.getElementById(id);
      if (modal && modal.parentNode !== document.body) document.body.appendChild(modal);
    });

    // First ensure login screen is shown by default (with inline styles for extra security)
    document.querySelectorAll('.screen').forEach(s => {
      s.classList.remove('active');
      s.style.display = 'none';
    });
    const loginScreen = document.getElementById('scr-login');
    loginScreen.classList.add('active');
    loginScreen.style.display = 'block';
    document.getElementById('topnav-right').style.display = 'none';

    // Initialize login mode (magic link vs password) based on host
    initLoginMode();

    // Handle /auth/magic?token=XXX callback
    if (window.location.pathname === '/auth/magic') {
      const magicParams = new URLSearchParams(window.location.search);
      const magicToken = magicParams.get('token');
      if (magicToken) {
        handleMagicLinkToken(magicToken);
        return; // Stop here — handleMagicLinkToken will complete the flow
      }
    }

    // Handle /choose-context route — show context chooser for existing session
    if (window.location.pathname === '/choose-context') {
      const existingToken = localStorage.getItem('token');
      if (existingToken) {
        showContextChooser();
      }
      window.history.replaceState({}, '', '/');
    }

    // Check for existing valid session
    const token = localStorage.getItem('token');
    const storedRole = localStorage.getItem('role');
    const storedTenant = localStorage.getItem('tenantCode');

    if (token && storedRole) {
      try {
        // Validate token by making a test API call
        const tenantCode = storedTenant || 'apoyar';
        const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          // Token is valid - restore session
          console.log('Valid session found, restoring...');
          window.role = storedRole;
          window.tenant = storedTenant;
          window.loginRole = localStorage.getItem('loginRole') || storedRole; // Restore original login role
          role = storedRole;
          tenant = storedTenant;

          // Restore user info
          const storedUser = localStorage.getItem('currentUser');
          if (storedUser) {
            try {
              window.currentUser = JSON.parse(storedUser);
            } catch (e) {}
          }

          // Update UI
          document.getElementById('chip-role').textContent = storedRole === 'super_admin' ? 'Master Admin' : storedRole;
          document.getElementById('tenant-chip').style.display = (storedRole === 'customer' || storedRole === 'super_admin') ? 'block' : 'none';
          document.getElementById('chip-tenant').textContent = storedTenant || '—';

          // Configure and show app
          configureRole();
          switchView('dash');
          go('app');
          if (!localStorage.getItem('walkthrough_done')) setTimeout(startWalkthrough, 800);

          // Check for OAuth callbacks
          checkTeamsOAuthCallback();
          checkSlackOAuthCallback();

          // Check demo mode and load personas if applicable
          checkDemoMode();

          // Update mode switcher for multi-role users
          updateModeSwitcher();

          // Load data (skip for master admin - they don't have tenant data)
          const currentRole = window.role || localStorage.getItem('role');
          if (currentRole !== 'super_admin') {
            await fetchTicketsFromAPI();
            loadRaiseFormOptions();
          }
          renderAllDashboards();
        } else {
          // Token invalid - clear and show login
          console.log('Session expired, showing login...');
          localStorage.removeItem('token');
          localStorage.removeItem('role');
          localStorage.removeItem('tenantCode');
          localStorage.removeItem('currentUser');
        }
      } catch (error) {
        console.error('Session validation failed:', error);
        // On error, keep login screen visible
      }
    }

    // Pre-fill login form from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username');
    const urlRole = urlParams.get('role');

    // Pre-fill username if provided
    if (username) {
      const usernameField = document.getElementById('username');
      if (usernameField) {
        usernameField.value = decodeURIComponent(username);
        console.log('Pre-filled username from URL parameter');
      }
    }

    // Pre-fill role if provided
    if (urlRole) {
      const roleField = document.getElementById('role');
      if (roleField) {
        roleField.value = urlRole;
        console.log('Pre-filled role from URL parameter:', urlRole);
      }
    }

    // Pre-fill tenant code if provided
    const urlTenant = urlParams.get('tenant');
    if (urlTenant) {
      const tenantField = document.getElementById('tenantCode');
      if (tenantField) {
        tenantField.value = decodeURIComponent(urlTenant);
        console.log('Pre-filled tenant code from URL parameter');
      }
    }

    // Password field intentionally left empty for security
  });

  // ---- Data ----
  let CMDB_ITEMS = []; // Will be loaded from API
  let CIS_BY_ITEM = {}; // Will be loaded from API

  // Load CMDB items from API
  let cmdbItemsLoaded = false; // Track if we've attempted to load CMDB items

  async function loadCMDBItemsFromAPI() {
    const tenantCode = window.tenant || 'apoyar';
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      cmdbItemsLoaded = true; // Mark as loaded regardless of result
      if (data.success && data.items) {
        CMDB_ITEMS = data.items.map(item => ({
          cmdb_id: item.cmdb_id,
          asset_name: item.asset_name,
          name: item.asset_name,
          customer_name: item.customer_name || '',
          customer: item.customer_name || '',
          asset_category: item.asset_category,
          brand_name: item.brand_name,
          model_name: item.model_name,
          asset_location: item.asset_location,
          status: item.status,
          ci_count: item.ci_count || 0,
          comment: item.comment || ''
        }));
      }
      renderCMDB();
    } catch (err) {
      console.error('Error loading CMDB items:', err);
      cmdbItemsLoaded = true; // Mark as loaded even on error
      renderCMDB(); // Show empty state on error
    }
  }

  // Load CIs for a specific CMDB item from API
  async function loadCIsForItem(cmdbId) {
    if (CIS_BY_ITEM[cmdbId]) return CIS_BY_ITEM[cmdbId];

    const tenantCode = window.tenant || 'apoyar';
    const token = localStorage.getItem('token');
    if (!token) return [];

    try {
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${cmdbId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success && data.item && data.item.configuration_items) {
        CIS_BY_ITEM[cmdbId] = data.item.configuration_items.map(ci => ({
          ci_id: ci.ci_id,
          cmdb_id: cmdbId,
          ci_name: ci.ci_name || '',
          category_field_value: ci.category_field_value || ''
        }));
        return CIS_BY_ITEM[cmdbId];
      }
    } catch (err) {
      console.error('Error loading CIs:', err);
    }
    return [];
  }

  // Tickets will be loaded from API after login
  let tickets = [];
  let cachedExperts = []; // Cache experts for assignment dropdown

  // Function to fetch tickets from API
  async function fetchTicketsFromAPI() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';
      
      console.log('Fetching tickets from API for tenant:', tenantCode);
      
      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        console.error('Failed to fetch tickets:', response.status);
        return;
      }
      
      const data = await response.json();
      console.log('Received tickets from API:', data);
      
      if (data.success && data.tickets) {
        // Transform API tickets to match frontend format
        tickets = data.tickets.map(t => ({
          id: t.id || t.ticket_number,
          title: t.title,
          priority: t.priority || 'Normal',
          status: t.status,
          assignee: t.assignee_name || null,
          customer: window.tenant || 'apoyar',
          due: t.due_date || t.sla_deadline,
          desc: t.description,
          sla_status: t.sla_status || null, // New two-phase SLA status
          sla: {
            paused: false,
            createdAt: t.created_at,
            startedAt: t.created_at
          }
        }));

        console.log('Loaded', tickets.length, 'tickets from API');
      }
    } catch (error) {
      console.error('Error fetching tickets:', error);
    }
  }

  let experts = []; // Will be loaded from API
  let customers = []; // Will be loaded from API

  // ---- Shell & Nav ----
  let role='admin', currentView='dash', currentItemId=null, tenant=null, pending=null, currentTicketId=null;

  // Role change listener - show tenant field for all roles except master_admin
  document.getElementById('role').addEventListener('change', function(){
    const isMasterAdmin = this.value === 'master_admin';
    const tenantField = document.getElementById('tenant-field');
    if(tenantField) tenantField.style.display = isMasterAdmin ? 'none' : 'block';
  });
  function loadTenantChoices(){ 
    const t=document.getElementById('tenant'); 
    // Use actual tenant data instead of CMDB customer data
    const tenants = ['apoyar']; // Only actual tenant that exists in database
    t.innerHTML=''; 
    tenants.forEach(tenantId=>{
      const o=document.createElement('option'); 
      o.value=tenantId; 
      o.textContent=tenantId.charAt(0).toUpperCase() + tenantId.slice(1); 
      t.appendChild(o);
    }); 
    if(tenants.length) t.value=tenants[0]; 
  }
  function go(where){
    document.querySelectorAll('.screen').forEach(s => {
      s.classList.remove('active');
      s.style.display = 'none';
    });
    const targetScreen = document.getElementById(where==='login'?'scr-login':'scr-app');
    targetScreen.classList.add('active');
    targetScreen.style.display = 'block';
    const isLogin = where === 'login';
    // Show/hide top nav elements based on screen
    document.getElementById('topnav-right').style.display = isLogin ? 'none' : 'flex';
    const sidebarBtn = document.getElementById('sidebar-toggle-btn');
    if (sidebarBtn) sidebarBtn.style.display = isLogin ? 'none' : 'flex';
    const menuToggle = document.getElementById('mobile-menu-toggle');
    if (menuToggle) menuToggle.style.display = isLogin ? 'none' : '';
    const searchBtn = document.querySelector('.topnav-search-btn');
    if (searchBtn) searchBtn.style.display = isLogin ? 'none' : '';
    const ionicMenuBtn = document.getElementById('ionic-menu-btn');
    if (ionicMenuBtn) ionicMenuBtn.style.display = isLogin ? 'none' : '';
    // Show/hide chat toggle based on login state
    const chatToggleBtn = document.getElementById('chat-toggle');
    if (chatToggleBtn) chatToggleBtn.style.display = isLogin ? 'none' : '';
    // Close chat panel when logging out
    const chatPanel = document.getElementById('chat');
    if (isLogin && chatPanel) chatPanel.style.display = 'none';
  }

  // Theme Controller
  // localStorage key: 'serviflow.theme' with values: 'light' | 'dark' | 'system'
  const systemDarkQuery = window.matchMedia('(prefers-color-scheme: dark)');

  function getEffectiveTheme(mode) {
    if (mode === 'dark') return 'dark';
    if (mode === 'light') return 'light';
    return systemDarkQuery.matches ? 'dark' : 'light';
  }

  function applyTheme(effectiveTheme) {
    const html = document.documentElement;
    html.classList.remove('theme-light', 'theme-dark');
    html.classList.add('theme-' + effectiveTheme);
    html.style.colorScheme = effectiveTheme;
    updateThemeIcon(effectiveTheme === 'dark');
  }

  function setTheme(mode) {
    localStorage.setItem('serviflow.theme', mode);
    applyTheme(getEffectiveTheme(mode));
    updateThemeMenuSelection(mode);
  }
  window.setTheme = setTheme;

  function toggleThemeMenu(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('theme-dropdown');
    dropdown.classList.toggle('open');
  }

  function selectTheme(mode) {
    setTheme(mode);
    document.getElementById('theme-dropdown').classList.remove('open');
  }

  function updateThemeMenuSelection(mode) {
    document.querySelectorAll('.theme-menu-item').forEach(item => {
      item.classList.toggle('active', item.dataset.theme === mode);
    });
  }

  function updateThemeIcon(isDark) {
    const sun = document.getElementById('theme-icon-sun');
    const moon = document.getElementById('theme-icon-moon');
    if (sun) sun.style.display = isDark ? 'none' : 'block';
    if (moon) moon.style.display = isDark ? 'block' : 'none';
  }

  function initTheme() {
    const saved = localStorage.getItem('serviflow.theme') || 'system';
    applyTheme(getEffectiveTheme(saved));
    updateThemeMenuSelection(saved);
  }

  // Listen for system theme changes (only affects 'system' mode)
  systemDarkQuery.addEventListener('change', () => {
    const mode = localStorage.getItem('serviflow.theme') || 'system';
    if (mode === 'system') applyTheme(getEffectiveTheme('system'));
  });

  // Close theme dropdown when clicking elsewhere
  document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('theme-dropdown');
    if (dropdown && !dropdown.contains(e.target)) {
      dropdown.classList.remove('open');
    }
  });

  initTheme();

  // Mobile menu functions
  function toggleMobileMenu() {
    const toggle = document.getElementById('mobile-menu-toggle');
    const leftnav = document.querySelector('.leftnav');
    const overlay = document.getElementById('sidebar-overlay');
    toggle.classList.toggle('active');
    leftnav.classList.toggle('open');
    overlay.classList.toggle('active');
    document.body.style.overflow = leftnav.classList.contains('open') ? 'hidden' : '';
  }

  function closeMobileMenu() {
    const toggle = document.getElementById('mobile-menu-toggle');
    const leftnav = document.querySelector('.leftnav');
    const overlay = document.getElementById('sidebar-overlay');
    toggle.classList.remove('active');
    leftnav.classList.remove('open');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
  }

  // Sidebar collapse toggle (desktop)
  function toggleSidebar() {
    const container = document.querySelector('.container');
    if (!container) return;
    const isCollapsed = container.classList.toggle('sidebar-collapsed');
    localStorage.setItem('serviflow.sidebarCollapsed', isCollapsed ? '1' : '0');
  }

  function initSidebarState() {
    const saved = localStorage.getItem('serviflow.sidebarCollapsed');
    if (saved === '1') {
      const container = document.querySelector('.container');
      if (container) container.classList.add('sidebar-collapsed');
    }
  }

  // Fullscreen mode for ticket detail
  function toggleFullscreen() {
    const isFullscreen = document.body.classList.toggle('fullscreen-mode');
    localStorage.setItem('serviflow.fullscreenMode', isFullscreen ? '1' : '0');
  }

  function exitFullscreen() {
    document.body.classList.remove('fullscreen-mode');
    localStorage.setItem('serviflow.fullscreenMode', '0');
  }

  // Exit fullscreen when navigating away from ticket detail
  function exitFullscreenIfNotTicketDetail() {
    const ticketDetail = document.getElementById('view-ticket-detail');
    if (!ticketDetail || ticketDetail.style.display === 'none') {
      exitFullscreen();
    }
  }

  // Keyboard shortcuts for sidebar and fullscreen
  document.addEventListener('keydown', function(e) {
    // Ctrl+B or Cmd+B to toggle sidebar
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
      e.preventDefault();
      toggleSidebar();
    }
    // F key to toggle fullscreen (only when ticket detail is visible, not in input, not customer)
    if (e.key === 'f' && !e.ctrlKey && !e.metaKey && !e.altKey && (window.role || role) !== 'customer') {
      const ticketDetail = document.getElementById('view-ticket-detail');
      const activeEl = document.activeElement;
      const isInInput = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);
      if (ticketDetail && ticketDetail.style.display !== 'none' && !isInInput) {
        e.preventDefault();
        toggleFullscreen();
      }
    }
    // Escape to exit fullscreen
    if (e.key === 'Escape' && document.body.classList.contains('fullscreen-mode')) {
      exitFullscreen();
    }
  });

  // Initialize sidebar state on page load
  document.addEventListener('DOMContentLoaded', initSidebarState);

  // Mobile filters toggle
  function toggleMobileFilters() {
    const card = document.getElementById('ticket-filters-card');
    const btn = card.querySelector('.mobile-filter-toggle');
    card.classList.toggle('filters-expanded');
    if (card.classList.contains('filters-expanded')) {
      btn.textContent = 'Hide Filters ▲';
    } else {
      btn.textContent = 'Show Filters ▼';
    }
  }

  // Close mobile menu when nav item clicked
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('navlink')) {
      closeMobileMenu();
    }
  });

  // Close mobile menu on resize to desktop
  window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
      closeMobileMenu();
    }
  });

  async function login(){
    console.log('Login function called');
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    
    console.log('Login attempt:', { username, password, role });
    
    const errorDiv = document.getElementById('login-error');
    errorDiv.style.display = 'none';
    
    try {
      let response;
      
      if (role === 'master_admin') {
        console.log('Attempting master admin login');
        const url = `${API_BASE}/api/auth/master/login`;
        console.log('Fetching URL:', url);
        // Master Admin login
        response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
      } else {
        console.log('Attempting tenant login');
        // Tenant login - get tenant from form
        const tenant = document.getElementById('tenant').value;
        console.log('Using tenant:', tenant);
        console.log('Request body:', { username, password, tenant_code: tenant });

        try {
          response = await fetch(`${API_BASE}/api/auth/tenant/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password, tenant_code: tenant })
          });
          console.log('Fetch completed');
        } catch (fetchError) {
          console.error('Fetch error:', fetchError);
          throw fetchError;
        }
      }

      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);

      const data = await response.json();
      console.log('Response data:', data);
      
      if (data.success) {
        console.log('Login successful');

        // Use shared completeLogin for both password and magic link
        completeLogin(data);
      } else {
        console.log('Login failed:', data.message);
        errorDiv.textContent = data.message || 'Login failed';
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      console.error('Login error:', error);
      errorDiv.textContent = 'Connection error. Please try again.';
      errorDiv.style.display = 'block';
    }
  }

  // Logout function - clear session and return to login
  function logout() {
    // Clear all session data from localStorage
    localStorage.removeItem('token');
    localStorage.removeItem('role');
    localStorage.removeItem('tenantCode');
    localStorage.removeItem('currentUser');
    localStorage.removeItem('username');
    localStorage.removeItem('loginRole');
    localStorage.removeItem('roles');
    localStorage.removeItem('active_role');
    localStorage.removeItem('active_company_id');

    // Clear elevation token and reauth state
    localStorage.removeItem('token_base');
    sessionStorage.removeItem('serviflow.reauthUntil');

    // Clear global variables
    window.currentUser = null;
    window.role = null;
    window.loginRole = null;
    window.tenant = null;
    window.isMasterAdmin = false;
    window.impersonatedUser = null;

    // Stop SLA interval
    if (slaInterval) {
      clearInterval(slaInterval);
      slaInterval = null;
    }

    // Return to login screen
    go('login');
  }


  // ── Magic Link + Multi-Role Auth ────────────────────────────────

  /** Detect if current host supports magic link login */
  function isMagicLinkHost() {
    const h = window.location.hostname;
    return h.includes('demo.serviflow') || h.includes('web-demo');
  }

  /** Toggle between magic-link and password login modes */
  function toggleLoginMode(mode) {
    const magicForm = document.getElementById('magic-link-form');
    const pwdForm = document.getElementById('password-form');
    const errorDiv = document.getElementById('login-error');
    if (errorDiv) errorDiv.style.display = 'none';

    if (mode === 'magic') {
      if (magicForm) magicForm.style.display = 'block';
      if (pwdForm) pwdForm.style.display = 'none';
    } else {
      if (magicForm) magicForm.style.display = 'none';
      if (pwdForm) pwdForm.style.display = 'block';
    }
  }

  /** Initialize login form mode based on host */
  function initLoginMode() {
    const toggle = document.getElementById('magic-link-toggle');
    const params = new URLSearchParams(window.location.search);
    // ?admin forces password mode (for master admin access on demo)
    const forcePassword = params.has('admin') || params.get('mode') === 'password';

    if (isMagicLinkHost() && !forcePassword) {
      toggleLoginMode('magic');
      if (toggle) toggle.style.display = 'inline';
    } else {
      toggleLoginMode('password');
      if (toggle) toggle.style.display = isMagicLinkHost() ? 'inline' : 'none';
      // Pre-select master_admin role if ?admin param
      if (forcePassword && params.has('admin')) {
        const roleSelect = document.getElementById('role');
        if (roleSelect) { roleSelect.value = 'master_admin'; toggleTenantField(); }
      }
    }
  }

  /** Request magic link email */
  async function requestMagicLink() {
    const emailInput = document.getElementById('magic-email');
    const email = emailInput ? emailInput.value.trim() : '';
    const errorDiv = document.getElementById('login-error');
    if (errorDiv) errorDiv.style.display = 'none';

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
    if (!email || !emailRegex.test(email)) {
      if (errorDiv) {
        errorDiv.textContent = 'Please enter a valid email address (e.g. name@company.com)';
        errorDiv.style.display = 'block';
      }
      return;
    }

    try {
      await fetch(`${API_BASE}/api/public/auth/magic/request`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });

      // Always show "check inbox" (anti-enumeration)
      const reqDiv = document.getElementById('magic-link-request');
      const sentDiv = document.getElementById('magic-link-sent');
      const emailDisplay = document.getElementById('magic-link-email-display');
      if (reqDiv) reqDiv.style.display = 'none';
      if (sentDiv) sentDiv.style.display = 'block';
      if (emailDisplay) emailDisplay.textContent = email;
    } catch (err) {
      console.error('Magic link request failed:', err);
      if (errorDiv) {
        errorDiv.textContent = 'Connection error. Please try again.';
        errorDiv.style.display = 'block';
      }
    }
  }

  /** Reset magic link form to request state */
  function resetMagicLinkForm() {
    const reqDiv = document.getElementById('magic-link-request');
    const sentDiv = document.getElementById('magic-link-sent');
    const emailInput = document.getElementById('magic-email');
    if (reqDiv) reqDiv.style.display = 'block';
    if (sentDiv) sentDiv.style.display = 'none';
    if (emailInput) emailInput.value = '';
  }

  /** Handle /auth/magic?token=XXX callback */
  async function handleMagicLinkToken(token) {
    const errorDiv = document.getElementById('login-error');
    if (errorDiv) errorDiv.style.display = 'none';

    try {
      const response = await fetch(`${API_BASE}/api/public/auth/magic/consume`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });

      const data = await response.json();

      if (!data.success) {
        if (errorDiv) {
          errorDiv.textContent = data.message || 'Invalid or expired link';
          errorDiv.style.display = 'block';
        }
        // Clean URL
        window.history.replaceState({}, '', '/');
        return;
      }

      // Clean URL
      window.history.replaceState({}, '', '/');

      // Complete login with the response
      completeLogin(data);

    } catch (err) {
      console.error('Magic link consume failed:', err);
      if (errorDiv) {
        errorDiv.textContent = 'Authentication error. Please try again.';
        errorDiv.style.display = 'block';
      }
      window.history.replaceState({}, '', '/');
    }
  }

  /**
   * Shared login completion — works for both password and magic link login.
   * Handles requires_context by showing the context chooser.
   */
  function completeLogin(data) {
    // Store session data
    localStorage.setItem('token', data.token);
    localStorage.setItem('role', data.user.role);
    localStorage.setItem('tenantCode', data.user.tenantCode || 'apoyar');
    localStorage.setItem('currentUser', JSON.stringify(data.user));
    localStorage.setItem('username', data.user.username);
    localStorage.setItem('loginRole', data.user.role);

    // Store multi-role data
    if (data.user.roles) localStorage.setItem('roles', JSON.stringify(data.user.roles));
    if (data.user.role) localStorage.setItem('active_role', data.user.role);

    // Set global variables
    window.currentUser = data.user;
    window.role = data.user.role;
    window.loginRole = data.user.role;
    window.tenant = data.user.tenantCode || 'apoyar';
    window.isMasterAdmin = data.user.role === 'super_admin';
    tenant = window.tenant;

    // If context selection is required, show chooser
    if (data.requires_context) {
      showContextChooser();
      return;
    }

    // Full app entry
    enterApp();
  }

  /** Enter the app after login + context selection is complete */
  async function enterApp() {
    const currentRole = window.role || localStorage.getItem('role');

    // Update UI
    const chipRole = document.getElementById('chip-role');
    if (chipRole) chipRole.textContent = currentRole === 'super_admin' ? 'Master Admin' : currentRole;
    const tenantChip = document.getElementById('tenant-chip');
    if (tenantChip) tenantChip.style.display = (currentRole === 'customer' || currentRole === 'super_admin') ? 'block' : 'none';
    const chipTenant = document.getElementById('chip-tenant');
    if (chipTenant) chipTenant.textContent = window.tenant || '-';

    // Configure role and show app
    configureRole();
    switchView('dash');
    go('app');
    if (!localStorage.getItem('walkthrough_done')) setTimeout(startWalkthrough, 800);

    // Update mode switcher
    updateModeSwitcher();

    // Check demo mode and load personas if applicable
    checkDemoMode();

    // Load data (skip for master admin)
    if (currentRole !== 'super_admin') {
      await fetchTicketsFromAPI();
      loadRaiseFormOptions();
    }
    renderAllDashboards();
    renderList();
    startSLAInterval();
    updateRefreshIntervalUI();
  }

  /** Show the context chooser modal (role + company picker) */
  async function showContextChooser() {
    const modal = document.getElementById('context-chooser-modal');
    if (!modal) return;

    const token = localStorage.getItem('token');
    if (!token) return;

    // Fetch context from API
    let ctx;
    try {
      const resp = await fetch(`${API_BASE}/api/me/context`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      ctx = await resp.json();
    } catch (err) {
      console.error('Failed to load context:', err);
      // Fall through to app entry
      enterApp();
      return;
    }

    if (!ctx.success) {
      enterApp();
      return;
    }

    const rolePicker = document.getElementById('context-role-picker');
    const companyPicker = document.getElementById('context-company-picker');
    const companyList = document.getElementById('context-company-list');
    const subtitle = document.getElementById('context-chooser-subtitle');

    // Build role tiles
    const roleIcons = { admin: '&#x1F6E0;', expert: '&#x1F527;', customer: '&#x1F464;' };
    const roleLabels = { admin: 'Admin', expert: 'Expert', customer: 'Customer' };
    if (rolePicker) {
      rolePicker.innerHTML = ctx.roles.map(r => `
        <button onclick="selectContextRole('${r}')" style="flex:1;min-width:100px;padding:16px 12px;border-radius:10px;border:2px solid var(--border);background:var(--card-bg);cursor:pointer;text-align:center;transition:border-color .15s,box-shadow .15s;" onmouseenter="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(67,97,238,.15)'" onmouseleave="this.style.borderColor='var(--border)';this.style.boxShadow='none'">
          <div style="font-size:24px;margin-bottom:6px;">${roleIcons[r] || '&#x1F465;'}</div>
          <div style="font-weight:600;font-size:14px;color:var(--ink)">${roleLabels[r] || r}</div>
        </button>
      `).join('');
    }

    // Hide company picker initially
    if (companyPicker) companyPicker.style.display = 'none';
    if (subtitle) subtitle.textContent = 'Select a role to continue';

    // Store context for later use
    window._contextData = ctx;

    // Show modal
    modal.style.display = 'flex';
  }

  /** Handle role selection in context chooser */
  async function selectContextRole(role) {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
      const resp = await fetch(`${API_BASE}/api/me/select-role`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ role })
      });
      const data = await resp.json();

      if (!data.success) {
        alert(data.message || 'Failed to select role');
        return;
      }

      // Update stored token + role
      localStorage.setItem('token', data.token);
      localStorage.setItem('role', data.active_role);
      localStorage.setItem('active_role', data.active_role);
      window.role = data.active_role;

      if (data.active_company_id) {
        localStorage.setItem('active_company_id', String(data.active_company_id));
      }

      // If customer needs to pick company, show company picker
      if (data.requires_context && data.companies && data.companies.length > 0) {
        const companyPicker = document.getElementById('context-company-picker');
        const companyList = document.getElementById('context-company-list');
        const subtitle = document.getElementById('context-chooser-subtitle');
        if (subtitle) subtitle.textContent = 'Now select your company';
        if (companyList) {
          companyList.innerHTML = data.companies.map(c => `
            <button onclick="selectContextCompany(${c.id})" style="padding:12px 16px;border-radius:8px;border:1px solid var(--border);background:var(--card-bg);cursor:pointer;text-align:left;font-size:14px;font-weight:500;color:var(--ink);transition:border-color .15s;" onmouseenter="this.style.borderColor='var(--primary)'" onmouseleave="this.style.borderColor='var(--border)'">${c.company_name}</button>
          `).join('');
        }
        if (companyPicker) companyPicker.style.display = 'block';
        // Hide role picker
        const rolePicker = document.getElementById('context-role-picker');
        if (rolePicker) rolePicker.style.display = 'none';
        return;
      }

      // Done — close modal and enter app
      closeContextChooser();
      enterApp();

    } catch (err) {
      console.error('Error selecting role:', err);
      alert('Failed to select role. Please try again.');
    }
  }

  /** Handle company selection in context chooser */
  async function selectContextCompany(companyId) {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
      const resp = await fetch(`${API_BASE}/api/me/select-company`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ company_id: companyId })
      });
      const data = await resp.json();

      if (!data.success) {
        alert(data.message || 'Failed to select company');
        return;
      }

      localStorage.setItem('token', data.token);
      localStorage.setItem('active_company_id', String(data.active_company_id));

      closeContextChooser();
      enterApp();

    } catch (err) {
      console.error('Error selecting company:', err);
      alert('Failed to select company. Please try again.');
    }
  }

  /** Close context chooser modal */
  function closeContextChooser() {
    const modal = document.getElementById('context-chooser-modal');
    if (modal) modal.style.display = 'none';
  }

  /** Update mode switcher button in top nav */
  function updateModeSwitcher() {
    const switcher = document.getElementById('mode-switcher');
    const label = document.getElementById('mode-switcher-label');
    const storedRoles = localStorage.getItem('roles');

    let roles = [];
    try { roles = storedRoles ? JSON.parse(storedRoles) : []; } catch(e) {}

    // Only show if user has multiple roles
    if (roles.length > 1 && switcher && label) {
      const currentRole = window.role || localStorage.getItem('role') || '';
      const roleLabels = { admin: 'Admin', expert: 'Expert', customer: 'Customer' };
      const companyId = localStorage.getItem('active_company_id');
      let text = roleLabels[currentRole] || currentRole;
      // If customer with company, show company name if available
      if (currentRole === 'customer' && window.currentUser && window._contextData) {
        const company = (window._contextData.companies || []).find(c => c.id == companyId);
        if (company) text += ' / ' + company.company_name;
      }
      label.textContent = text;
      switcher.style.display = 'flex';
    } else if (switcher) {
      switcher.style.display = 'none';
    }
  }

  function toggleTenantField() {
    const role = document.getElementById('role').value;
    const tenantField = document.getElementById('tenant-field');

    if (role === 'master_admin') {
      tenantField.style.display = 'none';
    } else {
      tenantField.style.display = 'block';
      // Load tenant choices when showing the field
      loadTenantChoices();
    }
  }

  function showForgotPassword() {
    document.querySelectorAll('.screen').forEach(s => {
      s.classList.remove('active');
      s.style.display = 'none';
    });
    const forgotScreen = document.getElementById('scr-forgot-password');
    forgotScreen.classList.add('active');
    forgotScreen.style.display = 'block';
    // Clear previous messages
    document.getElementById('forgot-message').style.display = 'none';
  }

  function backToLogin() {
    document.querySelectorAll('.screen').forEach(s => {
      s.classList.remove('active');
      s.style.display = 'none';
    });
    const loginScreen = document.getElementById('scr-login');
    loginScreen.classList.add('active');
    loginScreen.style.display = 'block';
  }

  async function sendPasswordReset() {
    const tenantCode = document.getElementById('forgot-tenant').value.trim();
    const email = document.getElementById('forgot-email').value.trim();
    const messageDiv = document.getElementById('forgot-message');

    // Validation
    if (!tenantCode || !email) {
      messageDiv.textContent = 'Please enter both tenant code and email address.';
      messageDiv.style.color = '#dc2626';
      messageDiv.style.background = '#fef2f2';
      messageDiv.style.borderColor = '#fecaca';
      messageDiv.style.display = 'block';
      return;
    }

    if (!email.includes('@')) {
      messageDiv.textContent = 'Please enter a valid email address.';
      messageDiv.style.color = '#dc2626';
      messageDiv.style.background = '#fef2f2';
      messageDiv.style.borderColor = '#fecaca';
      messageDiv.style.display = 'block';
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/api/auth/tenant/forgot-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ tenant_code: tenantCode, email })
      });

      const data = await response.json();

      if (response.ok && data.success) {
        messageDiv.textContent = data.message;
        messageDiv.style.color = '#059669';
        messageDiv.style.background = '#d1fae5';
        messageDiv.style.borderColor = '#6ee7b7';
        messageDiv.style.display = 'block';

        // Clear form fields
        document.getElementById('forgot-tenant').value = '';
        document.getElementById('forgot-email').value = '';
      } else {
        messageDiv.textContent = data.message || 'Failed to send reset email. Please try again.';
        messageDiv.style.color = '#dc2626';
        messageDiv.style.background = '#fef2f2';
        messageDiv.style.borderColor = '#fecaca';
        messageDiv.style.display = 'block';
      }
    } catch (error) {
      console.error('Password reset error:', error);
      messageDiv.textContent = 'Connection error. Please try again.';
      messageDiv.style.color = '#dc2626';
      messageDiv.style.background = '#fef2f2';
      messageDiv.style.borderColor = '#fecaca';
      messageDiv.style.display = 'block';
    }
  }

  function switchRole(){
    // Role switch permissions based on original login role:
    // - Admin: can switch to all roles (admin, expert, customer)
    // - Expert: can switch between expert and customer only
    // - Customer: no role switch allowed
    const loginRole = window.loginRole || window.role || role;

    if (loginRole === 'customer') {
      // Customer - no switching allowed
      return;
    }

    // Open the role switcher modal instead of cycling
    openRoleSwitcherModal();
  }

  async function openRoleSwitcherModal() {
    const loginRole = window.loginRole || window.role || role;
    const modal = document.getElementById('role-switcher-modal');
    if (!modal) return;

    // Show/hide admin option based on login role
    const adminOption = document.getElementById('role-opt-admin');
    if (adminOption) {
      adminOption.style.display = (loginRole === 'admin') ? 'flex' : 'none';
    }

    // Reset radio buttons - select current role
    const currentRole = window.role || role;
    const radios = document.querySelectorAll('input[name="impersonate-role"]');
    radios.forEach(r => {
      r.checked = (r.value === currentRole);
    });

    // Reset sections visibility
    document.getElementById('impersonate-expert-section').style.display = 'none';
    document.getElementById('impersonate-customer-section').style.display = 'none';

    // If impersonating, pre-select the user
    if (window.impersonatedUser) {
      const impRole = window.impersonatedUser.role;
      radios.forEach(r => r.checked = (r.value === impRole));
      await onImpersonateRoleChange();

      if (impRole === 'expert') {
        document.getElementById('impersonate-expert-select').value = window.impersonatedUser.id;
      } else if (impRole === 'customer') {
        document.getElementById('impersonate-customer-select').value = window.impersonatedUser.id;
      }
    } else {
      // Trigger to show/hide dropdown based on current role
      await onImpersonateRoleChange();
    }

    modal.style.display = 'flex';
  }

  function closeRoleSwitcherModal() {
    const modal = document.getElementById('role-switcher-modal');
    if (modal) modal.style.display = 'none';
  }

  async function onImpersonateRoleChange() {
    const selectedRole = document.querySelector('input[name="impersonate-role"]:checked')?.value;
    const expertSection = document.getElementById('impersonate-expert-section');
    const customerSection = document.getElementById('impersonate-customer-section');

    expertSection.style.display = 'none';
    customerSection.style.display = 'none';

    if (selectedRole === 'expert') {
      await loadImpersonateExpertsDropdown();
      expertSection.style.display = 'block';
    } else if (selectedRole === 'customer') {
      await loadImpersonateCustomersDropdown();
      customerSection.style.display = 'block';
    }
  }

  async function loadImpersonateExpertsDropdown() {
    const select = document.getElementById('impersonate-expert-select');
    if (!select) return;

    // Use cachedExperts if available, otherwise fetch
    if (cachedExperts.length === 0) {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_BASE}/api/auth/experts`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        if (res.ok) {
          const data = await res.json();
          if (data.success && Array.isArray(data.experts)) {
            cachedExperts = data.experts;
          }
        }
      } catch (e) {
        console.error('Error loading experts for impersonation:', e);
      }
    }

    select.innerHTML = '<option value="">-- Select Expert (view all expert tickets) --</option>';
    cachedExperts.forEach(expert => {
      const opt = document.createElement('option');
      opt.value = expert.id;
      opt.textContent = `${expert.full_name || expert.username}`;
      select.appendChild(opt);
    });
  }

  async function loadImpersonateCustomersDropdown() {
    const select = document.getElementById('impersonate-customer-select');
    if (!select) return;

    // Use allCustomers if available, otherwise fetch
    if (allCustomers.length === 0) {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_BASE}/api/customers`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        if (res.ok) {
          const data = await res.json();
          if (data.success && Array.isArray(data.customers)) {
            allCustomers = data.customers;
          }
        }
      } catch (e) {
        console.error('Error loading customers for impersonation:', e);
      }
    }

    select.innerHTML = '<option value="">-- Select Customer (view all customer tickets) --</option>';
    allCustomers.forEach(customer => {
      const opt = document.createElement('option');
      opt.value = customer.id;
      opt.textContent = customer.full_name || customer.company_name || customer.username;
      select.appendChild(opt);
    });
  }

  function applyRoleSwitch() {
    const selectedRole = document.querySelector('input[name="impersonate-role"]:checked')?.value;
    if (!selectedRole) {
      alert('Please select a role');
      return;
    }

    // Clear previous impersonation
    window.impersonatedUser = null;

    // Update role
    role = selectedRole;
    window.role = selectedRole;

    // Handle impersonation for expert/customer
    if (selectedRole === 'expert') {
      const expertSelect = document.getElementById('impersonate-expert-select');
      const expertId = expertSelect?.value;
      if (expertId) {
        const expert = cachedExperts.find(e => e.id == expertId);
        if (expert) {
          window.impersonatedUser = {
            id: expert.id,
            role: 'expert',
            fullName: expert.full_name || expert.username,
            username: expert.username
          };
        }
      }
    } else if (selectedRole === 'customer') {
      const customerSelect = document.getElementById('impersonate-customer-select');
      const customerId = customerSelect?.value;
      if (customerId) {
        const customer = allCustomers.find(c => c.id == customerId);
        if (customer) {
          window.impersonatedUser = {
            id: customer.id,
            role: 'customer',
            fullName: customer.full_name || customer.company_name || customer.username,
            companyName: customer.company_name
          };
        }
      }
    }

    // Update UI
    if (selectedRole === 'customer' && !tenant) {
      tenant = (CMDB_ITEMS.find(i => i.customer) || {}).customer || null;
    }
    document.getElementById('chip-role').textContent = selectedRole;
    document.getElementById('tenant-chip').style.display = selectedRole === 'customer' ? 'block' : 'none';
    document.getElementById('chip-tenant').textContent = tenant || '—';

    // Update impersonation indicator
    updateImpersonationIndicator();

    closeRoleSwitcherModal();
    configureRole();
    switchView('dash');
    renderAllDashboards();
    loadRaiseFormOptions();
    renderList();
  }

  function updateImpersonationIndicator() {
    const indicator = document.getElementById('topnav-impersonation');
    const nameSpan = document.getElementById('topnav-impersonation-name');

    const currentRole = window.role || role;
    if (window.impersonatedUser && currentRole !== 'customer') {
      const roleLabel = window.impersonatedUser.role.charAt(0).toUpperCase() + window.impersonatedUser.role.slice(1);
      const displayText = `${window.impersonatedUser.fullName} (${roleLabel})`;

      if (indicator && nameSpan) {
        nameSpan.textContent = displayText;
        indicator.style.display = 'flex';
      }
    } else {
      if (indicator) indicator.style.display = 'none';
    }
  }

  function clearImpersonation() {
    window.impersonatedUser = null;

    // Reset to login role
    const loginRole = window.loginRole || 'admin';
    role = loginRole;
    window.role = loginRole;

    document.getElementById('chip-role').textContent = loginRole;
    document.getElementById('tenant-chip').style.display = loginRole === 'customer' ? 'block' : 'none';

    updateImpersonationIndicator();
    configureRole();
    switchView('dash');
    renderAllDashboards();
    loadRaiseFormOptions();
    renderList();
  }
  // ---- Filter Persistence ----
  function saveFilterSettings(viewName) {
    const username = localStorage.getItem('username') || 'default';
    const tenant = window.tenant || 'apoyar';
    const key = `filters_${tenant}_${username}_${viewName}`;

    const settings = {};

    if (viewName === 'tickets') {
      settings.search = document.getElementById('ticket-search')?.value || '';
      settings.status = document.getElementById('ticket-filter-status')?.value || '';
      settings.priority = document.getElementById('ticket-filter-priority')?.value || '';
      settings.assignee = document.getElementById('ticket-filter-assignee')?.value || '';
      settings.customer = document.getElementById('ticket-filter-customer')?.value || '';
      settings.sort = document.getElementById('ticket-sort')?.value || '';
      settings.includeSystem = document.getElementById('ticket-filter-system')?.checked !== false;
    } else if (viewName === 'experts') {
      settings.search = document.getElementById('expert-search')?.value || '';
    } else if (viewName === 'customers') {
      settings.search = document.getElementById('cust-search')?.value || '';
    } else if (viewName === 'cmdb') {
      settings.search = document.getElementById('cmdb-search')?.value || '';
      settings.customer = document.getElementById('cmdb-customer')?.value || '';
    }

    localStorage.setItem(key, JSON.stringify(settings));
  }

  function loadFilterSettings(viewName) {
    const username = localStorage.getItem('username') || 'default';
    const tenant = window.tenant || 'apoyar';
    const key = `filters_${tenant}_${username}_${viewName}`;

    const savedSettings = localStorage.getItem(key);
    if (!savedSettings) return;

    try {
      const settings = JSON.parse(savedSettings);

      if (viewName === 'tickets') {
        if (settings.search !== undefined) {
          const elem = document.getElementById('ticket-search');
          if (elem) elem.value = settings.search;
        }
        if (settings.status !== undefined) {
          const elem = document.getElementById('ticket-filter-status');
          if (elem) elem.value = settings.status;
        }
        if (settings.priority !== undefined) {
          const elem = document.getElementById('ticket-filter-priority');
          if (elem) elem.value = settings.priority;
        }
        if (settings.assignee !== undefined) {
          const elem = document.getElementById('ticket-filter-assignee');
          if (elem) elem.value = settings.assignee;
        }
        if (settings.customer !== undefined) {
          const elem = document.getElementById('ticket-filter-customer');
          if (elem) elem.value = settings.customer;
        }
        if (settings.sort !== undefined) {
          const elem = document.getElementById('ticket-sort');
          if (elem) elem.value = settings.sort;
        }
        if (settings.includeSystem !== undefined) {
          const elem = document.getElementById('ticket-filter-system');
          if (elem) elem.checked = settings.includeSystem;
        }
      } else if (viewName === 'experts') {
        if (settings.search !== undefined) {
          const elem = document.getElementById('expert-search');
          if (elem) elem.value = settings.search;
        }
      } else if (viewName === 'customers') {
        if (settings.search !== undefined) {
          const elem = document.getElementById('cust-search');
          if (elem) elem.value = settings.search;
        }
      } else if (viewName === 'cmdb') {
        if (settings.search !== undefined) {
          const elem = document.getElementById('cmdb-search');
          if (elem) elem.value = settings.search;
        }
        if (settings.customer !== undefined) {
          const elem = document.getElementById('cmdb-customer');
          if (elem) elem.value = settings.customer;
        }
      }
    } catch (error) {
      console.error('Error loading filter settings:', error);
    }
  }

  function nav(el){ document.querySelectorAll('.navlink').forEach(n=>n.classList.remove('active')); el.classList.add('active'); switchView(el.getAttribute('data-target')); }
  function navTo(view){ switchView(view); }
  function switchView(view){ currentView=view; if(view!=='ticket-detail' && typeof exitFullscreen === 'function') exitFullscreen(); ['dash','profile','tickets','ticket-detail','experts','expert-detail','customers','cmdb-hub','cmdb','cmdb-detail','manage-cmdb','cmdb-mgmt','wizard','raise','tenants','subscriptions','billing','plans','currencies','system','usage','customer-plans','customer-billing','my-company','company-admin','company-reports','analytics','ai-insights','ticket-rules','email-processing','system-control','knowledge-base','raw-variables','audit-log','notifications'].forEach(n=>{ const el=document.getElementById('view-'+n); if(el) el.style.display=(n===view)?'block':'none'; }); if(view!=='dash') { clearExpertPowerSearch(); } if(view==='dash') { fetchTicketsFromAPI().then(() => renderAllDashboards()); loadAITrends(); } if(view==='tickets') { console.log('[switchView] Switching to tickets view'); window.insightTicketFilter = null; window.insightTitle = null; window.slaAtRiskFilter = false; loadFilterSettings('tickets'); renderList(); } if(view==='experts') { loadFilterSettings('experts'); renderExperts(); } if(view==='expert-detail') renderExpertDetail(); if(view==='customers') { loadFilterSettings('customers'); renderCustomers(); } if(view==='cmdb-hub') initCmdbHub(); if(view==='cmdb') { loadFilterSettings('cmdb'); renderCMDB(); } if(view==='cmdb-detail') renderCMDBDetail(); if(view==='manage-cmdb') loadManageCMDB(); if(view==='cmdb-mgmt') loadCMDBMgmt(); if(view==='raise') loadRaiseFormOptions(); if(view==='ticket-detail') renderTicketDetail(); if(view==='tenants') loadTenants(); if(view==='subscriptions') loadSubscriptions(); if(view==='billing') loadBilling(); if(view==='plans') loadPlans(); if(view==='currencies') loadCurrenciesAdmin(); if(view==='system') loadSystemOverview(); if(view==='usage') loadUsageDashboard(); if(view==='customer-plans') loadCustomerPlans(); if(view==='customer-billing') loadCustomerBilling(); if(view==='my-company') loadMyCompany(); if(view==='company-admin') loadCompanyAdminUsers(); if(view==='company-reports') loadCompanyReports(); if(view==='analytics') loadAnalytics(); if(view==='ai-insights') loadAIInsights(); if(view==='ticket-rules') loadTicketRules(); if(view==='email-processing') loadEmailProcessing(); if(view==='system-control') loadSystemControlSettings(); if(view==='knowledge-base') initKnowledgeBase(); if(view==='raw-variables') loadRawVariables(); if(view==='audit-log') { loadAuditActions(); loadAuditLog(); } if(view==='notifications') loadNotifications(); if(view==='wizard') { initWizardSection(); loadCompanyProfile(); loadEmailIngestSettings(); loadSystemSenders(); loadExpertRegSettings(); loadSupportSettings(); loadTeamsIntegrationStatus(); loadSlackIntegrationStatus(); loadSmsIntegrationStatus(); loadSLAData(); } if(view==='profile') loadProfile(); }
  function configureRole(){
    const currentRole = window.role || role; // Use global role from login, fallback to local
    document.getElementById('nav-admin').style.display = (currentRole==='admin') ? 'block' : 'none';
    document.getElementById('nav-expert').style.display = currentRole==='expert' ? 'block' : 'none';
    document.getElementById('nav-customer').style.display = currentRole==='customer' ? 'block' : 'none';
    document.getElementById('nav-master').style.display = currentRole==='super_admin' ? 'block' : 'none';
    document.getElementById('dash-admin').style.display = (currentRole==='admin') ? 'block' : 'none';
    document.getElementById('dash-expert').style.display = currentRole==='expert' ? 'block' : 'none';
    document.getElementById('dash-customer').style.display = currentRole==='customer' ? 'block' : 'none';
    document.getElementById('dash-master').style.display = currentRole==='super_admin' ? 'block' : 'none';
    document.getElementById('app-title').textContent = currentRole==='customer' ? 'My Dashboard' : (currentRole==='expert' ? 'Expert Dashboard' : (currentRole==='super_admin' ? 'Master Admin Dashboard' : 'Admin Dashboard'));
    document.getElementById('app-subtitle').textContent = currentRole==='customer' ? 'Welcome to your ServiFlow portal' : (currentRole==='expert' ? 'SLA focus & queue' : (currentRole==='super_admin' ? 'System-wide management & tenant oversight' : 'Platform health & governance'));

    // Show/hide Asset Viewer nav items (apoyar tenant only, not demo)
    updateAssetViewerNav();

    // Simplify title bar for customers
    const appSubtitle = document.getElementById('app-subtitle');
    if (appSubtitle) appSubtitle.style.display = (currentRole === 'customer') ? 'none' : '';

    // Update top navigation user info
    const username = (window.currentUser && window.currentUser.username) ? window.currentUser.username : 'User';
    const roleDisplay = currentRole === 'super_admin' ? 'Master Admin' : (currentRole.charAt(0).toUpperCase() + currentRole.slice(1));
    document.getElementById('topnav-username').textContent = username;
    document.getElementById('topnav-role').textContent = (currentRole === 'customer') ? '' : roleDisplay;
    document.getElementById('topnav-avatar').textContent = username.charAt(0).toUpperCase();

    // Hide/show admin-only sections in Admin Settings
    const isAdmin = (currentRole === 'admin');
    const profileSection = document.getElementById('admin-section-profile');
    const emailIngestSection = document.getElementById('admin-section-email-ingest');
    const expertRegSection = document.getElementById('admin-section-expert-reg');
    if (profileSection) profileSection.style.display = isAdmin ? 'block' : 'none';
    if (emailIngestSection) emailIngestSection.style.display = isAdmin ? 'block' : 'none';
    if (expertRegSection) expertRegSection.style.display = isAdmin ? 'block' : 'none';
    const integrationsSection = document.getElementById('admin-section-integrations');
    if (integrationsSection) integrationsSection.style.display = isAdmin ? 'block' : 'none';
    const slaSection = document.getElementById('admin-section-sla');
    if (slaSection) slaSection.style.display = isAdmin ? 'block' : 'none';

    // Hide CMDB Delete All button for experts (admin only)
    const cmdbDeleteAllBtn = document.getElementById('cmdb-mgmt-delete-all-btn');
    if (cmdbDeleteAllBtn) cmdbDeleteAllBtn.style.display = isAdmin ? 'inline-flex' : 'none';

    // Hide fullscreen/focus button for customers
    const isCustomer = (currentRole === 'customer');
    const fsToggle = document.querySelector('.fullscreen-toggle-btn');
    if (fsToggle) fsToggle.style.display = isCustomer ? 'none' : '';
    const fsExit = document.querySelector('.fullscreen-exit-btn');
    if (fsExit) fsExit.style.display = isCustomer ? 'none' : '';

    // Hide impersonation pill for customers (admin can still use Switch to get back)
    const impersonationPill = document.getElementById('topnav-impersonation');
    if (impersonationPill) impersonationPill.style.display = isCustomer ? 'none' : '';

    // Update Ionic menu visibility based on role
    if (typeof updateIonicMenu === 'function') {
      updateIonicMenu(); // eslint-disable-line no-undef -- function defined later, guarded by typeof
    }

    // Show System Admin Tools section for all admins (requires elevation to open)
    const sysAdminTools = document.getElementById('nav-system-admin-tools');
    if (sysAdminTools) sysAdminTools.style.display = isAdmin ? 'block' : 'none';
    const ionicSysAdmin = document.getElementById('ionic-system-admin-tools');
    if (ionicSysAdmin) ionicSysAdmin.style.display = isAdmin ? 'block' : 'none';

    // Update elevation badge visibility
    if (typeof updateElevationBadge === 'function') updateElevationBadge();

    // Initialize collapsible nav groups
    initNavGroups();

    // Load notification badge for admin/expert roles
    if (currentRole === 'admin' || currentRole === 'expert') {
      loadNotificationBadge();
    }

    // Show/hide Switch Role buttons based on login role permissions
    // Admin: can switch, Expert: can switch, Customer: cannot switch
    const loginRole = window.loginRole || currentRole;
    const canSwitchRoles = loginRole === 'admin' || loginRole === 'expert';
    const topnavSwitchBtn = document.getElementById('topnav-switch-btn');
    const ionicSwitchBtn = document.getElementById('ionic-switch-role-btn');
    if (topnavSwitchBtn) topnavSwitchBtn.style.display = canSwitchRoles ? 'inline-flex' : 'none';
    if (ionicSwitchBtn) ionicSwitchBtn.style.display = canSwitchRoles ? 'block' : 'none';

    // Update impersonation indicator
    updateImpersonationIndicator();

    // Configure customer-specific nav items
    if (currentRole === 'customer') {
      // Show Company Admin link only if user is a company admin
      const companyAdminNav = document.getElementById('nav-company-admin');
      const companyReportsNav = document.getElementById('nav-company-reports');
      if (companyAdminNav) {
        const isCompanyAdmin = window.currentUser && window.currentUser.isCompanyAdmin;
        companyAdminNav.style.display = isCompanyAdmin ? 'block' : 'none';
        if (companyReportsNav) companyReportsNav.style.display = isCompanyAdmin ? 'block' : 'none';
      }

      // Load tenant settings for conditional nav display
      loadTenantSettingsForNav();
    }

    // Initialize live chat socket for all roles
    if (typeof initChatOnLogin === 'function') initChatOnLogin();
  }

  // ---- SLA Utilities (centralized, null-safe) ----

  // Parse MySQL datetime string safely → Date or null
  // Handles: null, undefined, empty string, "0000-00-00", Invalid Date
  function parseMysqlDateSafe(str) {
    if (!str || str === '0000-00-00' || str === '0000-00-00 00:00:00') return null;
    const d = new Date(str);
    if (isNaN(d.getTime()) || d.getTime() <= 0) return null;
    return d;
  }

  // Format duration with guards for NaN, Infinity, and absurd values
  // Returns "—" for invalid/absurd values (> 10000 days ≈ 27 years)
  const MAX_REASONABLE_MS = 10000 * 24 * 60 * 60 * 1000; // 10000 days

  function formatSafeDurationMs(ms) {
    if (ms === null || ms === undefined || !isFinite(ms) || isNaN(ms)) return '—';
    if (Math.abs(ms) > MAX_REASONABLE_MS) return '—';
    return formatDurationMs(ms);
  }

  // Internal: format ms to human-readable (assumes valid input)
  function formatDurationMs(ms) {
    const absMs = Math.abs(ms);
    const totalMins = Math.floor(absMs / 60000);
    const days = Math.floor(totalMins / 1440);
    const hours = Math.floor((totalMins % 1440) / 60);
    const mins = totalMins % 60;

    if (days > 0) return `${days}d ${hours}h`;
    if (hours > 0) return `${hours}h ${mins}m`;
    return `${mins}m`;
  }

  // Legacy alias for compatibility
  function formatDuration(ms) {
    return formatSafeDurationMs(ms);
  }

  // Parse old-style due date (YYYY-MM-DD) to end of day
  function parseDueEndOfDay(dueStr) {
    if (!dueStr) return null;
    const a = dueStr.split('-');
    if (a.length !== 3) return null;
    return new Date(Number(a[0]), Number(a[1]) - 1, Number(a[2]), 23, 59, 59, 999);
  }

  // Format date for tooltip (e.g., "11 Jan 18:48")
  function formatDueDate(date) {
    if (!date || isNaN(date.getTime())) return '—';
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return `${date.getDate()} ${months[date.getMonth()]} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
  }

  // Format date as DD/MM/YYYY HH:MM
  function formatDateDDMMYYYY(date) {
    if (!date || isNaN(date.getTime())) return '—';
    const dd = String(date.getDate()).padStart(2, '0');
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const yyyy = date.getFullYear();
    const hh = String(date.getHours()).padStart(2, '0');
    const min = String(date.getMinutes()).padStart(2, '0');
    return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
  }

  // Get next business window (simple: next weekday 09:00)
  function getNextBusinessWindow() {
    const now = new Date();
    const next = new Date(now);
    next.setHours(9, 0, 0, 0);
    if (now.getHours() >= 9) next.setDate(next.getDate() + 1);
    while (next.getDay() === 0 || next.getDay() === 6) next.setDate(next.getDate() + 1);
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    return `${days[next.getDay()]} 09:00`;
  }

  function getSLAState(t) {
    // Resolved tickets get special handling
    if (t.status === 'Resolved' || t.status === 'Closed') {
      return { cls: 'resolved', label: '✓', pct: 100, isResolved: true, tooltip: 'Ticket resolved', sortPriority: 4 };
    }

    // Parse SLA dates using centralized safe parser
    const responseDue = parseMysqlDateSafe(t.response_due_at);
    const resolveDue = parseMysqlDateSafe(t.resolve_due_at);
    const firstResponded = parseMysqlDateSafe(t.first_responded_at);
    const ownershipStarted = parseMysqlDateSafe(t.ownership_started_at);

    // No valid SLA dates at all
    if (!responseDue && !resolveDue) {
      return { cls: '', label: '—', pct: 0, tooltip: 'No SLA deadline set', sortPriority: 5 };
    }

    // Use sla_status if available (enriched by backend)
    if (t.sla_status && (t.sla_status.response || t.sla_status.resolve)) {
      return getSLAStateFromStatus(t, t.sla_status);
    }

    // Fallback: compute SLA state from raw date fields
    // Determine which phase we're in: Response or Resolve
    const now = Date.now();
    let phaseName, phaseCode, dueAt, isLate;

    if (!firstResponded && responseDue) {
      // Response phase: not yet responded, response deadline applies
      phaseName = 'Response';
      phaseCode = 'R';
      dueAt = responseDue;
    } else if (resolveDue) {
      // Resolve phase: already responded (or no response SLA), resolve deadline applies
      phaseName = 'Resolve';
      phaseCode = 'D';
      dueAt = resolveDue;
    } else {
      return { cls: '', label: '—', pct: 0, tooltip: 'No applicable SLA deadline', sortPriority: 5 };
    }

    const remainingMs = dueAt.getTime() - now;
    isLate = remainingMs < 0;

    // Guard: if duration is absurd, show "—"
    const durationStr = formatSafeDurationMs(Math.abs(remainingMs));
    if (durationStr === '—') {
      return { cls: '', label: '—', pct: 0, tooltip: `${phaseName} SLA\nDue: ${formatDateDDMMYYYY(dueAt)}`, sortPriority: 5 };
    }

    // Calculate percentage elapsed (for progress display)
    const createdAt = parseMysqlDateSafe(t.created_at) || new Date(now);
    const totalMs = dueAt.getTime() - createdAt.getTime();
    const elapsedMs = now - createdAt.getTime();
    let pct = totalMs > 0 ? Math.max(0, Math.min(100, Math.round((elapsedMs / totalMs) * 100))) : 0;
    if (!isFinite(pct)) pct = 0;

    let cls = 'ok';
    let sortPriority = 2;
    let label, subtext = '', tooltip;

    if (isLate) {
      cls = 'danger';
      sortPriority = 0;
      label = `${phaseCode} ✖`;
      subtext = `+${durationStr}`;
      tooltip = `${phaseName} SLA (${phaseCode}) — Breached\nDue: ${formatDateDDMMYYYY(dueAt)}\nExceeded by: ${durationStr}`;
    } else {
      // Check if near breach (< 30 mins or > 70% elapsed)
      const isNearBreach = remainingMs < 30 * 60 * 1000 || pct >= 70;
      if (isNearBreach) {
        cls = 'warn';
        sortPriority = 1;
        label = `${phaseCode} !`;
        subtext = `${durationStr} left`;
        tooltip = `${phaseName} SLA (${phaseCode}) — At Risk\nDue: ${formatDateDDMMYYYY(dueAt)}\nRemaining: ${durationStr}`;
      } else {
        label = `${phaseCode} ${durationStr}`;
        tooltip = `${phaseName} SLA (${phaseCode}) — On Track\nDue: ${formatDateDDMMYYYY(dueAt)}\nRemaining: ${durationStr}`;
      }
    }

    return { cls, label, subtext, pct, tooltip, sortPriority };
  }

  // Helper: extract SLA state from backend-enriched sla_status object
  function getSLAStateFromStatus(t, s) {
    const phase = s.sla_phase || s.phase;

    // Determine which phase to show (response or resolve)
    let activePhase = s.response;
    let phaseName = 'Response';
    let phaseCode = 'R';
    if (phase === 'in_progress' || phase === 'resolved' || !s.response) {
      activePhase = s.resolve;
      phaseName = 'Resolve';
      phaseCode = 'D';
    }

    if (!activePhase) {
      return { cls: '', label: '—', pct: 0, tooltip: 'No SLA data', sortPriority: 5 };
    }

    const slaName = s.sla_name || 'SLA';
    const slaSource = s.sla_source || 'default';
    const dueAt = parseMysqlDateSafe(activePhase.due_at);
    const outsideBH = s.outside_business_hours;

    // Outside business hours - special handling
    if (outsideBH && activePhase.state !== 'breached' && activePhase.state !== 'met') {
      const nextWindow = getNextBusinessWindow();
      const tooltip = `${phaseName} SLA paused\nOutside business hours\nResumes: ${nextWindow}\n\n${slaName} (${slaSource})`;
      return { cls: 'paused', label: `⏸ Paused · resumes ${nextWindow}`, pct: activePhase.percent_elapsed || 0, tooltip, outsideBH: true, sortPriority: 3 };
    }

    let cls = 'ok';
    let label = '—';
    let subtext = '';
    let tooltipLines = [];
    let sortPriority = 3;

    if (activePhase.state === 'breached') {
      cls = 'danger';
      label = `${phaseCode} ✖`;
      sortPriority = 0;
      if (dueAt) {
        const exceededMs = Date.now() - dueAt.getTime();
        const exceededStr = formatSafeDurationMs(exceededMs);
        subtext = exceededStr !== '—' ? `+${exceededStr}` : '';
        tooltipLines = [`${phaseName} SLA (${phaseCode}) — Breached`, `Due: ${formatDateDDMMYYYY(dueAt)}`, exceededStr !== '—' ? `Exceeded by: ${exceededStr}` : ''];
      } else {
        tooltipLines = [`${phaseName} SLA (${phaseCode}) — Breached`];
      }
    } else if (activePhase.state === 'near_breach') {
      cls = 'warn';
      label = `${phaseCode} !`;
      sortPriority = 1;
      if (dueAt) {
        const remainingMs = dueAt.getTime() - Date.now();
        const remainingStr = formatSafeDurationMs(remainingMs);
        subtext = remainingStr !== '—' ? `${remainingStr} left` : '';
        tooltipLines = [`${phaseName} SLA (${phaseCode}) — At Risk`, `Due: ${formatDateDDMMYYYY(dueAt)}`, remainingStr !== '—' ? `Remaining: ${remainingStr}` : ''];
      } else {
        tooltipLines = [`${phaseName} SLA (${phaseCode}) — At Risk`];
      }
    } else if (activePhase.state === 'on_track' && dueAt) {
      const remainingMs = dueAt.getTime() - Date.now();
      const remainingStr = formatSafeDurationMs(remainingMs);
      if (remainingStr !== '—' && remainingMs > 0) {
        label = `${phaseCode} ${remainingStr}`;
        tooltipLines = [`${phaseName} SLA (${phaseCode}) — On Track`, `Due: ${formatDateDDMMYYYY(dueAt)}`, `Remaining: ${remainingStr}`];
        sortPriority = 2;
      } else if (remainingMs <= 0) {
        // Just breached
        cls = 'danger';
        label = `${phaseCode} ✖`;
        const exceededStr = formatSafeDurationMs(Math.abs(remainingMs));
        subtext = exceededStr !== '—' ? `+${exceededStr}` : '';
        tooltipLines = [`${phaseName} SLA (${phaseCode}) — Breached`, `Due: ${formatDateDDMMYYYY(dueAt)}`, exceededStr !== '—' ? `Exceeded by: ${exceededStr}` : ''];
        sortPriority = 0;
      } else {
        label = `${phaseCode} —`;
        tooltipLines = [`${phaseName} SLA (${phaseCode})`, `Due: ${formatDateDDMMYYYY(dueAt)}`];
      }
    } else if (activePhase.state === 'met') {
      cls = 'muted';
      label = '✓';
      tooltipLines = [`${phaseName} SLA (${phaseCode}) — Met`];
      sortPriority = 4;
    } else if (activePhase.state === 'pending') {
      label = `${phaseCode} ...`;
      tooltipLines = [`${phaseName} SLA (${phaseCode}) — Pending`];
      sortPriority = 2;
    } else if (activePhase.state === 'no_sla') {
      return { cls: '', label: '—', pct: 0, tooltip: 'No SLA policy applied', sortPriority: 5 };
    }

    // Add SLA info to tooltip
    tooltipLines = tooltipLines.filter(l => l); // Remove empty lines
    tooltipLines.push('', `${slaName} (${slaSource})`);
    const tooltip = tooltipLines.join('\n');

    return { cls, label, subtext, pct: activePhase.percent_elapsed || 0, tooltip, outsideBH: false, sortPriority };
  }

  function slaBadgeHTML(state, clickable = false) {
    const tooltipAttr = (state.tooltip || '').replace(/"/g, '&quot;');
    const clickStyle = clickable ? 'cursor:pointer' : '';
    const clickAttr = clickable ? 'onclick="scrollToSLASection()"' : '';

    // Emphasis styles for urgent states
    const dangerEmphasis = 'font-weight:600;box-shadow:0 0 0 2px rgba(220,38,38,0.3)';
    const warnEmphasis = 'font-weight:600;box-shadow:0 0 0 2px rgba(245,158,11,0.3)';

    // No SLA
    if (!state.cls && state.label === '—') {
      return `<span class="badge sla" style="color:#9ca3af;background:#f9fafb;border-color:#e5e7eb;${clickStyle}" ${clickAttr} title="${tooltipAttr}">—</span>`;
    }

    // Resolved ticket or Met SLA (muted style)
    if (state.isResolved || state.cls === 'muted') {
      return `<span class="badge sla" style="color:#6b7280;background:#f3f4f6;border-color:#d1d5db;${clickStyle}" ${clickAttr} title="${tooltipAttr}">${state.label}</span>`;
    }

    // Build badge with emphasis for danger/warn states
    let badgeStyle = clickStyle;
    if (state.cls === 'danger') badgeStyle += `;${dangerEmphasis}`;
    else if (state.cls === 'warn') badgeStyle += `;${warnEmphasis}`;

    const badge = state.cls === 'paused'
      ? `<span class="badge sla" style="color:#6b7280;background:#f3f4f6;border-color:#d1d5db;${clickStyle}" ${clickAttr}>${state.label}</span>`
      : `<span class="badge sla ${state.cls}" style="${badgeStyle}" ${clickAttr}>${state.label}</span>`;

    // If there's subtext, wrap in flex container (compact layout)
    if (state.subtext) {
      return `<div style="display:flex;flex-direction:column;gap:1px;line-height:1.2;${clickStyle}" ${clickAttr} title="${tooltipAttr}">
        ${badge}
        <span style="font-size:9px;color:#9ca3af;white-space:nowrap">${state.subtext}</span>
      </div>`;
    }

    // No subtext, return badge with tooltip
    return `<span title="${tooltipAttr}">${badge}</span>`;
  }

  function scrollToSLASection() {
    const slaSection = document.querySelector('#td-sla-name')?.parentElement;
    if (slaSection) slaSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function toggleActivityPanel() {
    const wrapper = document.getElementById('td-activity-wrapper');
    const icon = document.getElementById('activity-toggle-icon');
    if (wrapper.style.display === 'none') {
      wrapper.style.display = 'block';
      icon.textContent = '▼ Hide';
    } else {
      wrapper.style.display = 'none';
      icon.textContent = '▶ Show';
    }
  }

  // Admin View toggle for ticket detail
  function toggleAdminView() {
    const isOn = sessionStorage.getItem('adminViewEnabled') === 'true';
    const newState = !isOn;
    sessionStorage.setItem('adminViewEnabled', newState.toString());
    applyAdminViewState(newState);
  }

  function applyAdminViewState(enabled) {
    // Update toggle button appearance
    const toggleBtn = document.getElementById('btn-admin-view-toggle');
    const icon = document.getElementById('admin-view-icon');
    if (toggleBtn) {
      toggleBtn.classList.toggle('primary', enabled);
      toggleBtn.classList.toggle('ghost', !enabled);
      if (icon) icon.textContent = enabled ? '👁' : '👁‍🗨';
    }

    // Toggle admin-section visibility
    document.querySelectorAll('.admin-section').forEach(el => {
      el.classList.toggle('collapsed', !enabled);
    });

    // Toggle admin-section-card visibility
    document.querySelectorAll('.admin-section-card').forEach(el => {
      el.classList.toggle('collapsed', !enabled);
    });

    // Toggle admin-only inline elements
    document.querySelectorAll('.admin-only-inline').forEach(el => {
      el.classList.toggle('hidden', !enabled);
    });

    // Toggle admin-only buttons
    document.querySelectorAll('.admin-only-btn').forEach(el => {
      el.classList.toggle('hidden', !enabled);
    });
  }

  function isUserAdmin() {
    const currentRole = window.role || localStorage.getItem('role') || 'expert';
    return currentRole === 'admin' || currentRole === 'super_admin';
  }

  // System source badge helper
  function systemSourceBadgeHTML(ticket, compact = true) {
    if (!ticket.is_system_source && !ticket.source_metadata) return '';

    const reasonLabels = {
      'system_senders_allowlist': 'system senders list',
      'system_domains_setting': 'system domain list',
      'monitoring_pattern_strong': 'monitoring pattern',
      'monitoring_pattern_weak': 'noreply + alert'
    };

    let reason = '';
    if (ticket.source_metadata && ticket.source_metadata.reason) {
      reason = reasonLabels[ticket.source_metadata.reason] || ticket.source_metadata.reason;
    }

    // Check if ticket is closed/resolved for faded styling
    const isClosed = ticket.status === 'Resolved' || ticket.status === 'Closed';

    if (compact) {
      // Short badge for list view - faded if closed
      const bgColor = isClosed ? '#c4b5fd' : '#7c3aed';
      const textColor = isClosed ? '#6b7280' : 'white';
      const title = isClosed
        ? (reason ? `Monitoring alert (closed) - ${reason}` : 'Monitoring alert (closed)')
        : (reason ? `Source: Monitoring (${reason})` : 'Source: Monitoring');
      return `<span style="background:${bgColor};color:${textColor};padding:1px 6px;border-radius:4px;font-size:10px;margin-left:4px;cursor:help" title="${title}">MON</span>`;
    } else {
      // Detailed badge for detail view - faded if closed
      const bgColor = isClosed ? '#c4b5fd' : '#7c3aed';
      const textColor = isClosed ? '#6b7280' : 'white';
      const reasonText = reason ? ` (${reason})` : '';
      const closedSuffix = isClosed ? ' - Closed' : '';
      return `<span style="background:${bgColor};color:${textColor};padding:2px 10px;border-radius:4px;font-size:11px;margin-left:8px" title="Ticket created from monitoring/system email source${closedSuffix}">Source: Monitoring${reasonText}</span>`;
    }
  }

  // Work type badge helper for ticket classification
  function workTypeBadgeHTML(workType) {
    if (!workType) return '';

    const typeConfig = {
      request:            { label: 'REQ', color: '#3b82f6', title: 'Request' },
      incident:           { label: 'INC', color: '#ef4444', title: 'Incident' },
      problem:            { label: 'PRB', color: '#f59e0b', title: 'Problem' },
      change_request:     { label: 'CHG', color: '#8b5cf6', title: 'Change Request' },
      operational_action: { label: 'OPS', color: '#ec4899', title: 'Operational Action' },
      question:           { label: 'Q',   color: '#0ea5e9', title: 'Question' },
      feedback:           { label: 'FBK', color: '#22c55e', title: 'Feedback' },
      unknown:            { label: '?',   color: '#6b7280', title: 'Unknown' }
    };

    const cfg = typeConfig[workType] || typeConfig.unknown;
    return `<span style="background:${cfg.color};color:white;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:600;margin-left:6px;cursor:help" title="${cfg.title}">${cfg.label}</span>`;
  }

  // System tags chips helper
  function systemTagsHTML(tags, maxTags = 2) {
    if (!tags || !Array.isArray(tags) || tags.length === 0) return '';

    const visibleTags = tags.slice(0, maxTags);
    const remainingCount = tags.length - maxTags;

    let html = visibleTags.map(tag =>
      `<span style="background:#e5e7eb;color:#374151;padding:1px 5px;border-radius:3px;font-size:9px;margin-right:3px">${escapeHtml(tag)}</span>`
    ).join('');

    if (remainingCount > 0) {
      html += `<span style="color:#6b7280;font-size:9px" title="${tags.slice(maxTags).join(', ')}">+${remainingCount}</span>`;
    }

    return html;
  }

  // Classification edit state
  let classificationEditTags = [];

  // Display classification data in ticket detail
  function displayClassification(ticket) {
    // Work type badge
    const workTypeBadgeEl = document.getElementById('td-work-type-badge');
    if (workTypeBadgeEl) {
      workTypeBadgeEl.innerHTML = workTypeBadgeHTML(ticket.work_type) || '<span style="color:var(--muted);font-size:11px">Not classified</span>';
    }

    // Execution mode badge
    const execModeEl = document.getElementById('td-exec-mode-badge');
    if (execModeEl) {
      const modeLabels = {
        automated: 'Auto',
        human_review: 'Review',
        expert_required: 'Expert',
        escalation_required: 'Escalate',
        mixed: 'Mixed'
      };
      const mode = ticket.execution_mode || '';
      execModeEl.textContent = modeLabels[mode] || mode || '';
      execModeEl.style.display = mode ? 'inline-block' : 'none';
    }

    // Confidence badge
    const confEl = document.getElementById('td-confidence-badge');
    if (confEl) {
      const conf = ticket.classification_confidence;
      if (conf !== null && conf !== undefined) {
        const pct = Math.round(conf * 100);
        confEl.textContent = `${pct}% conf`;
        confEl.style.display = 'inline-block';
      } else {
        confEl.style.display = 'none';
      }
    }

    // Classified by
    const byEl = document.getElementById('td-classified-by');
    if (byEl) {
      if (ticket.classified_by) {
        const at = ticket.classified_at ? new Date(ticket.classified_at).toLocaleString() : '';
        byEl.textContent = `by ${ticket.classified_by}${at ? ' • ' + at : ''}`;
        byEl.style.display = 'inline';
      } else {
        byEl.style.display = 'none';
      }
    }

    // System tags display
    const tagsDisplayEl = document.getElementById('td-system-tags-display');
    if (tagsDisplayEl) {
      let tags = ticket.system_tags;
      if (typeof tags === 'string') {
        try { tags = JSON.parse(tags); } catch(e) { tags = []; }
      }
      tagsDisplayEl.innerHTML = systemTagsHTML(tags, 6);
    }

    // Store current values for edit mode
    classificationEditTags = [];
    let tags = ticket.system_tags;
    if (typeof tags === 'string') {
      try { tags = JSON.parse(tags); } catch(e) { tags = []; }
    }
    if (Array.isArray(tags)) classificationEditTags = [...tags];

    // Pre-populate edit form
    const workTypeSelect = document.getElementById('td-work-type');
    const execModeSelect = document.getElementById('td-exec-mode');
    if (workTypeSelect) workTypeSelect.value = ticket.work_type || '';
    if (execModeSelect) execModeSelect.value = ticket.execution_mode || '';
  }

  // Toggle between display and edit mode
  function toggleClassificationEdit() {
    const displayEl = document.getElementById('classification-display');
    const editEl = document.getElementById('classification-edit');
    const btn = document.getElementById('btn-edit-classification');

    if (editEl.style.display === 'none') {
      displayEl.style.display = 'none';
      editEl.style.display = 'block';
      btn.textContent = 'Cancel';
      renderClassificationTagChips();
    } else {
      cancelClassificationEdit();
    }
  }

  // Cancel edit mode
  function cancelClassificationEdit() {
    const displayEl = document.getElementById('classification-display');
    const editEl = document.getElementById('classification-edit');
    const btn = document.getElementById('btn-edit-classification');
    const reasonEl = document.getElementById('td-classification-reason');

    displayEl.style.display = 'block';
    editEl.style.display = 'none';
    btn.textContent = 'Edit';
    if (reasonEl) reasonEl.value = '';
  }

  // Render tag chips in edit mode
  function renderClassificationTagChips() {
    const container = document.getElementById('td-tags-chips');
    if (!container) return;
    container.innerHTML = classificationEditTags.map(tag => `
      <span style="display:inline-flex;align-items:center;gap:2px;padding:2px 6px;background:var(--accent);color:white;border-radius:4px;font-size:10px">
        ${escapeHtml(tag)}
        <button onclick="removeClassificationTag('${escapeHtml(tag)}')" style="background:none;border:none;color:white;cursor:pointer;padding:0;font-size:12px;line-height:1">&times;</button>
      </span>
    `).join('');
  }

  // Add a classification tag
  function addClassificationTag() {
    const input = document.getElementById('td-tag-input');
    const tag = input?.value?.trim().toLowerCase().replace(/\s+/g, '_');
    if (!tag || classificationEditTags.includes(tag)) {
      if (input) input.value = '';
      return;
    }
    if (classificationEditTags.length >= 6) {
      showToast('Maximum 6 tags allowed', 'warn');
      return;
    }
    classificationEditTags.push(tag);
    input.value = '';
    renderClassificationTagChips();
  }

  // Remove a classification tag
  function removeClassificationTag(tag) {
    classificationEditTags = classificationEditTags.filter(t => t !== tag);
    renderClassificationTagChips();
  }

  // Save classification changes
  async function saveClassification() {
    const workType = document.getElementById('td-work-type')?.value;
    const execMode = document.getElementById('td-exec-mode')?.value;
    const reason = document.getElementById('td-classification-reason')?.value?.trim();

    if (!workType || !execMode) {
      showToast('Please select work type and execution mode', 'error');
      return;
    }

    const token = localStorage.getItem('token');
    const tenantCode = window.tenant || 'apoyar';

    try {
      const response = await fetch(`/api/tickets/${tenantCode}/${currentTicketId}/classification`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          work_type: workType,
          execution_mode: execMode,
          system_tags: classificationEditTags,
          reason: reason || undefined
        })
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.message || 'Failed to save classification');
      }

      showToast('Classification updated', 'success');
      cancelClassificationEdit();

      // Refresh ticket detail to show updated classification
      renderTicketDetail();

    } catch (error) {
      console.error('Error saving classification:', error);
      showToast(error.message || 'Failed to save classification', 'error');
    }
  }

  let slaInterval = null;
  const DEFAULT_REFRESH_INTERVAL = 60000; // 60 seconds default
  function getRefreshInterval() {
    try {
      const saved = localStorage.getItem('serviflow.ticketRefreshInterval');
      if (saved) return parseInt(saved, 10);
    } catch(e) {}
    return DEFAULT_REFRESH_INTERVAL;
  }
  function setRefreshInterval(ms) {
    try { localStorage.setItem('serviflow.ticketRefreshInterval', ms); } catch(e) {}
    startSLAInterval();
    updateRefreshIntervalUI();
  }
  function updateRefreshIntervalUI() {
    const sel = document.getElementById('refresh-interval-select');
    if (sel) sel.value = getRefreshInterval();
  }
  function manualRefresh() {
    if(currentView==='tickets') renderList();
    if(currentView==='dash') { renderAdminDash(); renderExpertDash(); }
    // Visual feedback
    const btn = document.getElementById('manual-refresh-btn');
    if (btn) {
      btn.textContent = 'Refreshed!';
      btn.disabled = true;
      setTimeout(() => { btn.textContent = '↻ Refresh'; btn.disabled = false; }, 1000);
    }
  }

  // ====================
  // PAGINATION UTILITIES
  // ====================
  const DEFAULT_PAGE_SIZE = 25;
  let ticketPage = 1, expertPage = 1, customerPage = 1, cmdbPage = 1;

  function getPageSize(key) {
    try { return parseInt(localStorage.getItem(`serviflow.${key}.pageSize`)) || DEFAULT_PAGE_SIZE; }
    catch(e) { return DEFAULT_PAGE_SIZE; }
  }

  function setPageSize(key, size) {
    try { localStorage.setItem(`serviflow.${key}.pageSize`, size); } catch(e) {}
  }

  function paginateArray(arr, page, pageSize) {
    const start = (page - 1) * pageSize;
    return arr.slice(start, start + pageSize);
  }

  function renderPaginationControls(containerId, currentPage, totalItems, pageSize, onPageChange, onPageSizeChange, gridKey) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const totalPages = Math.ceil(totalItems / pageSize);

    // Hide pagination if total items fit on one page
    if (totalItems <= pageSize) {
      container.innerHTML = '';
      return;
    }

    const startItem = (currentPage - 1) * pageSize + 1;
    const endItem = Math.min(currentPage * pageSize, totalItems);

    container.innerHTML = `
      <div class="row" style="gap:12px;align-items:center;flex-wrap:wrap">
        <span style="font-size:13px;color:var(--muted)">Showing ${startItem}-${endItem} of ${totalItems}</span>
        <div class="row" style="gap:4px;align-items:center">
          <button class="btn ghost" style="padding:4px 10px;font-size:12px" onclick="${onPageChange}(1)" ${currentPage === 1 ? 'disabled' : ''}>«</button>
          <button class="btn ghost" style="padding:4px 10px;font-size:12px" onclick="${onPageChange}(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹ Prev</button>
          <span style="font-size:13px;padding:0 8px">Page ${currentPage} of ${totalPages}</span>
          <button class="btn ghost" style="padding:4px 10px;font-size:12px" onclick="${onPageChange}(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>Next ›</button>
          <button class="btn ghost" style="padding:4px 10px;font-size:12px" onclick="${onPageChange}(${totalPages})" ${currentPage >= totalPages ? 'disabled' : ''}>»</button>
        </div>
        <div class="row" style="gap:4px;align-items:center">
          <span style="font-size:12px;color:var(--muted)">Rows:</span>
          <select class="input" style="padding:4px 8px;font-size:12px;min-width:auto;width:auto" onchange="${onPageSizeChange}(parseInt(this.value))">
            <option value="10" ${pageSize === 10 ? 'selected' : ''}>10</option>
            <option value="25" ${pageSize === 25 ? 'selected' : ''}>25</option>
            <option value="50" ${pageSize === 50 ? 'selected' : ''}>50</option>
            <option value="100" ${pageSize === 100 ? 'selected' : ''}>100</option>
          </select>
        </div>
      </div>
    `;
  }

  // Page change handlers for each grid
  function setTicketPage(page) {
    ticketPage = page;
    renderList();
  }
  // Filter change handlers that reset pagination
  function onTicketFilterChange() {
    ticketPage = 1;
    // Clear AI insight filter when user manually changes filters
    window.insightTicketFilter = null;
    window.insightTitle = null;
    window.slaAtRiskFilter = false;
    renderList();
    saveFilterSettings('tickets');
  }
  function onExpertFilterChange() {
    expertPage = 1;
    renderExperts();
    saveFilterSettings('experts');
  }
  function onCustomerFilterChange() {
    customerPage = 1;
    renderCustomers();
    saveFilterSettings('customers');
  }
  function onCMDBFilterChange() {
    cmdbPage = 1;
    renderCMDB();
    saveFilterSettings('cmdb');
  }
  function setTicketPageSize(size) {
    setPageSize('tickets', size);
    ticketPage = 1;
    renderList();
  }
  function setExpertPage(page) {
    expertPage = page;
    renderExperts();
  }
  function setExpertPageSize(size) {
    setPageSize('experts', size);
    expertPage = 1;
    renderExperts();
  }
  function setCustomerPage(page) {
    customerPage = page;
    renderCustomers();
  }
  function setCustomerPageSize(size) {
    setPageSize('customers', size);
    customerPage = 1;
    renderCustomers();
  }
  function setCMDBPage(page) {
    cmdbPage = page;
    renderCMDB();
  }
  function setCMDBPageSize(size) {
    setPageSize('cmdb', size);
    cmdbPage = 1;
    renderCMDB();
  }
  function startSLAInterval(){ if(slaInterval) clearInterval(slaInterval); const interval = getRefreshInterval(); slaInterval = setInterval(()=>{ if(currentView==='tickets') renderList(); if(currentView==='dash') { renderAdminDash(); renderExpertDash(); } if(currentView==='ticket-detail') updateTicketSLA(); }, interval); }

  // ---- Filter Bar Toggle ----
  function toggleFilterBar(btn) {
    const filterBar = btn.closest('.filter-bar');
    if (filterBar.classList.contains('expanded')) {
      filterBar.classList.remove('expanded');
      btn.textContent = '+ Filters';
    } else {
      filterBar.classList.add('expanded');
      btn.textContent = '- Filters';
    }
  }

  // ---- Dashboards ----
  function renderAllDashboards(){ 
    const currentRole = window.role || role;
    if (currentRole === 'super_admin') {
      renderMasterDash();
    } else {
      renderAdminDash(); 
      renderExpertDash(); 
      renderCustomerDash(); 
    }
  }
  function renderAdminDash(){
    const currentRole = window.role || role;
    if(currentRole!=='admin') return;
    const openAll=tickets.filter(t=>t.status!=='Resolved').length;
    const slaRisk=tickets.filter(t=>t.status!=='Resolved' && getSLAState(t).cls!=='ok').length;
    const totalItems=CMDB_ITEMS.length;
    const today = new Date().toDateString();
    const resolvedToday = tickets.filter(t=>t.status==='Resolved' && new Date(t.updated || t.created).toDateString() === today).length;
    document.getElementById('ad-open').textContent=openAll;
    document.getElementById('ad-sla-risk').textContent=slaRisk;
    document.getElementById('ad-items').textContent=totalItems;
    const resolvedEl = document.getElementById('ad-resolved-today');
    if(resolvedEl) resolvedEl.textContent=resolvedToday;
    loadFeedbackScoreboard();
  }

  async function loadFeedbackScoreboard() {
    try {
      const tenantCode = window.tenant || 'apoyar';
      const response = await fetch(`${API_BASE}/api/tickets/public/${tenantCode}/feedback-scoreboard`);

      if (!response.ok) {
        console.error('Failed to load feedback scoreboard');
        return;
      }

      const data = await response.json();

      if (data.success && data.scoreboard) {
        const scoreboard = data.scoreboard;

        // Update average rating
        document.getElementById('feedback-avg-rating').textContent = scoreboard.averageRating || '-';
        const stars = scoreboard.averageRating > 0 ? '⭐'.repeat(Math.round(scoreboard.averageRating)) : '';
        document.getElementById('feedback-avg-stars').textContent = stars;

        // Update total count
        document.getElementById('feedback-total-count').textContent = scoreboard.totalFeedback || 0;

        // Update distribution
        document.getElementById('feedback-5star').textContent = scoreboard.ratingDistribution[5] || 0;
        document.getElementById('feedback-4star').textContent = scoreboard.ratingDistribution[4] || 0;
        document.getElementById('feedback-3star').textContent = scoreboard.ratingDistribution[3] || 0;
        document.getElementById('feedback-2star').textContent = scoreboard.ratingDistribution[2] || 0;
        document.getElementById('feedback-1star').textContent = scoreboard.ratingDistribution[1] || 0;

        // Update recent feedback table
        const tbody = document.getElementById('feedback-recent');
        tbody.innerHTML = '';

        if (scoreboard.recentFeedback && scoreboard.recentFeedback.length > 0) {
          scoreboard.recentFeedback.forEach(feedback => {
            const tr = document.createElement('tr');
            const stars = '⭐'.repeat(feedback.rating);
            const date = new Date(feedback.submittedAt).toLocaleDateString();
            const comment = feedback.comment ? feedback.comment.substring(0, 50) + (feedback.comment.length > 50 ? '...' : '') : '-';

            tr.innerHTML = `
              <td>#${feedback.ticketId}</td>
              <td>${stars} (${feedback.rating}/5)</td>
              <td>${feedback.resolvedByName || '-'}</td>
              <td>${comment}</td>
              <td>${date}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="5" class="subtitle">No feedback received yet</td>';
          tbody.appendChild(tr);
        }
      }
    } catch (error) {
      console.error('Error loading feedback scoreboard:', error);
    }
  }

  // Dashboard stat card click-through functions
  function viewOpenTickets() {
    // Navigate to tickets view
    switchView('tickets');

    // Clear filters first
    clearTicketFilters();

    // Set status filter to show non-resolved tickets
    const statusFilter = document.getElementById('ticket-filter-status');
    if (statusFilter) {
      // Create option for "open" if it doesn't exist
      let hasOpenOption = false;
      for (let option of statusFilter.options) {
        if (option.value.toLowerCase() === 'open') {
          hasOpenOption = true;
          break;
        }
      }
      if (!hasOpenOption) {
        // Just leave it empty to show all non-resolved tickets
        statusFilter.value = '';
      } else {
        statusFilter.value = 'open';
      }
    }

    // Refresh the ticket list
    renderList();
  }

  function viewSLAAtRisk() {
    // Navigate to tickets view
    switchView('tickets');

    // Clear filters first
    clearTicketFilters();

    // Set a flag to filter for SLA at risk
    window.slaAtRiskFilter = true;

    // Refresh the ticket list
    renderList();

    // Clear the flag after a short delay so it doesn't persist
    setTimeout(() => {
      window.slaAtRiskFilter = false;
    }, 100);
  }

  function viewCMDBItems() {
    // Navigate to CMDB view
    switchView('cmdb');
  }

  async function renderExpertDash() {
    const currentRole = window.role || role;
    if (currentRole !== 'expert' && currentRole !== 'admin') return;

    const tb = document.getElementById('ex-list');
    const noTickets = document.getElementById('ex-no-tickets');
    if (!tb) return;

    // Fetch my tickets from server API
    try {
      const token = localStorage.getItem('token');
      const res = await fetch(`/api/tickets/${tenant}/my-tickets`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to load my tickets');
      }

      const my = data.tickets || [];

      // Filter for today (using resolve_due_at from API)
      const today = my.filter(t => {
        if (!t.resolve_due_at) return false;
        const now = new Date();
        const due = new Date(t.resolve_due_at);
        return now.toDateString() === due.toDateString();
      });

      // Filter for SLA risk (using sla_status from API)
      const risk = my.filter(t => {
        const slaStatus = t.sla_status;
        if (!slaStatus || slaStatus.phase === 'no_sla') return false;
        const resolveState = slaStatus.resolve?.state;
        return resolveState === 'breached' || resolveState === 'near_breach';
      });

      // Filter for claimed tickets
      const claimed = my.filter(t => t.pool_status === 'CLAIMED_LOCKED');

      // Update stats
      document.getElementById('ex-open').textContent = my.length;
      document.getElementById('ex-today').textContent = today.length;
      document.getElementById('ex-risk').textContent = risk.length;

      // Determine which tickets to show based on filter
      const filterSelect = document.getElementById('ex-ticket-filter');
      const filterValue = filterSelect ? filterSelect.value : 'all';
      let displayTickets = my;
      if (filterValue === 'claimed') displayTickets = claimed;
      else if (filterValue === 'today') displayTickets = today;
      else if (filterValue === 'risk') displayTickets = risk;

      // Store tickets for sorting and render
      myTicketsData = displayTickets;
      renderMyTicketsTable();

      // Load AI insights and recent assets
      loadExpertAIInsights(my, today, risk);
      loadExpertRecentAssets();

    } catch (error) {
      console.error('Error loading my tickets:', error);
      tb.innerHTML = '<tr><td colspan="5" style="color:#dc2626;text-align:center">Failed to load tickets</td></tr>';
    }
  }

  // Filter expert tickets when clicking stat cards
  function filterExpertTickets(type) {
    const filterSelect = document.getElementById('ex-ticket-filter');
    if (filterSelect) {
      filterSelect.value = type === 'open' ? 'all' : type;

      // Update visual highlighting on stat cards
      const cards = {
        open: document.getElementById('stat-card-open'),
        today: document.getElementById('stat-card-today'),
        risk: document.getElementById('stat-card-risk')
      };
      const colors = {
        open: '#2563eb',
        today: '#d97706',
        risk: '#dc2626'
      };

      // Remove active state from all cards
      Object.values(cards).forEach(card => {
        if (card) {
          card.style.boxShadow = '';
          card.classList.remove('stat-card-active');
        }
      });

      // Add active state to clicked card
      if (cards[type]) {
        cards[type].style.boxShadow = `0 0 0 2px ${colors[type]}`;
        cards[type].classList.add('stat-card-active');
      }

      // Scroll to ticket list for visibility
      const ticketTable = document.getElementById('ex-list')?.closest('.card');
      if (ticketTable) {
        ticketTable.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      renderExpertDash();
    }
  }

  // Sync stat card highlighting when dropdown changes
  function syncStatCardHighlight() {
    const filterSelect = document.getElementById('ex-ticket-filter');
    const filterValue = filterSelect ? filterSelect.value : 'all';

    // Map dropdown value to card type
    const type = filterValue === 'all' ? 'open' : filterValue;

    const cards = {
      open: document.getElementById('stat-card-open'),
      today: document.getElementById('stat-card-today'),
      risk: document.getElementById('stat-card-risk')
    };
    const colors = {
      open: '#2563eb',
      today: '#d97706',
      risk: '#dc2626'
    };

    // Remove active state from all cards
    Object.values(cards).forEach(card => {
      if (card) {
        card.style.boxShadow = '';
        card.classList.remove('stat-card-active');
      }
    });

    // Add active state to matching card
    if (cards[type]) {
      cards[type].style.boxShadow = `0 0 0 2px ${colors[type]}`;
      cards[type].classList.add('stat-card-active');
    }
  }

  // ========== TICKET POOL WORKFLOW ==========
  let expertViewMode = 'my';  // 'pool' or 'my'
  let poolTickets = [];       // Tickets from pool API
  let poolPage = 1;           // Current page
  let poolTotalPages = 1;     // Total pages
  let poolTotal = 0;          // Total ticket count
  let poolLimit = 50;         // Items per page
  let currentClaimedTicket = null;  // Ticket being previewed
  let claimTimer = null;      // Countdown timer for claim expiry

  // Pool sorting state
  let poolSortColumn = 'score';
  let poolSortDirection = 'desc';

  // My Tickets sorting state
  let myTicketsSortColumn = 'id';
  let myTicketsSortDirection = 'desc';
  let myTicketsData = [];  // Store my tickets for sorting

  // Sort Pool view by column
  function sortPoolBy(column) {
    // Toggle direction if same column, otherwise default to desc
    if (poolSortColumn === column) {
      poolSortDirection = poolSortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      poolSortColumn = column;
      poolSortDirection = 'desc';
    }

    // Sort poolTickets array
    poolTickets.sort((a, b) => {
      let aVal, bVal;
      switch (column) {
        case 'score':
          aVal = a.pool_score || 0;
          bVal = b.pool_score || 0;
          break;
        case 'id':
          aVal = a.id || 0;
          bVal = b.id || 0;
          break;
        case 'title':
          aVal = (a.title || '').toLowerCase();
          bVal = (b.title || '').toLowerCase();
          return poolSortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        case 'customer':
          aVal = (a.company_name || a.requester_name || '').toLowerCase();
          bVal = (b.company_name || b.requester_name || '').toLowerCase();
          return poolSortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        case 'sla':
          // Sort by SLA status severity
          const slaOrder = { 'breached': 0, 'at-risk': 1, 'on-track': 2 };
          aVal = slaOrder[a.sla_status?.response?.state] ?? 3;
          bVal = slaOrder[b.sla_status?.response?.state] ?? 3;
          break;
        default:
          aVal = a.id || 0;
          bVal = b.id || 0;
      }
      if (typeof aVal === 'number') {
        return poolSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
      }
      return 0;
    });

    renderPoolTable();
  }

  // Sort My Tickets view by column
  function sortMyTicketsBy(column) {
    // Toggle direction if same column, otherwise default to desc
    if (myTicketsSortColumn === column) {
      myTicketsSortDirection = myTicketsSortDirection === 'desc' ? 'asc' : 'desc';
    } else {
      myTicketsSortColumn = column;
      myTicketsSortDirection = 'desc';
    }

    // Sort myTicketsData array
    myTicketsData.sort((a, b) => {
      let aVal, bVal;
      switch (column) {
        case 'id':
          aVal = a.id || 0;
          bVal = b.id || 0;
          break;
        case 'title':
          aVal = (a.title || '').toLowerCase();
          bVal = (b.title || '').toLowerCase();
          return myTicketsSortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        case 'date':
          aVal = new Date(a.created_at || 0).getTime();
          bVal = new Date(b.created_at || 0).getTime();
          break;
        case 'status':
          aVal = (a.status || '').toLowerCase();
          bVal = (b.status || '').toLowerCase();
          return myTicketsSortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        case 'sla':
          // Sort by SLA status severity (using API sla_status format)
          const slaOrder = { 'breached': 0, 'near_breach': 1, 'on_track': 2 };
          const aState = a.sla_status?.resolve?.state || '';
          const bState = b.sla_status?.resolve?.state || '';
          aVal = slaOrder[aState] ?? 3;
          bVal = slaOrder[bState] ?? 3;
          break;
        default:
          aVal = a.id || 0;
          bVal = b.id || 0;
      }
      if (typeof aVal === 'number') {
        return myTicketsSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
      }
      return 0;
    });

    renderMyTicketsTable();
  }

  // Render My Tickets table (used after sorting)
  function renderMyTicketsTable() {
    const tb = document.getElementById('ex-list');
    const noTicketsEl = document.getElementById('ex-no-tickets');
    const tableEl = tb ? tb.closest('table') : null;
    if (!tb) return;

    tb.innerHTML = '';

    if (myTicketsData.length === 0) {
      if (noTicketsEl) noTicketsEl.style.display = 'block';
      if (tableEl) tableEl.style.display = 'none';
      return;
    }

    if (noTicketsEl) noTicketsEl.style.display = 'none';
    if (tableEl) tableEl.style.display = 'table';

    // Show first 15 items
    myTicketsData.slice(0, 15).forEach(t => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.onclick = () => openTicket(t.id);

      // Build SLA badge from sla_status (API response format)
      const slaStatus = t.sla_status || {};
      const resolveState = slaStatus.resolve?.state || '';
      let slaBadge = '<span class="badge sla">—</span>';
      if (resolveState === 'breached') {
        slaBadge = '<span class="badge sla breach">Breached</span>';
      } else if (resolveState === 'near_breach') {
        slaBadge = '<span class="badge sla warn">At Risk</span>';
      } else if (resolveState === 'on_track') {
        slaBadge = '<span class="badge sla ok">On Track</span>';
      }

      // Show status with claimed badge if applicable
      let statusDisplay = t.status;
      if (t.pool_status === 'CLAIMED_LOCKED') {
        statusDisplay = '<span class="badge" style="background:#fef3c7;color:#92400e;font-size:10px;padding:2px 6px">Claimed</span>';
      } else if (t.pool_status === 'WAITING_CUSTOMER') {
        statusDisplay = '<span class="badge" style="background:#e0e7ff;color:#3730a3;font-size:10px;padding:2px 6px">Waiting</span>';
      }

      const dateTime = formatDateTime(t.created_at);
      tr.innerHTML = `<td>#${t.id}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(t.title)}</td><td>${dateTime}</td><td>${statusDisplay}</td><td>${slaBadge}</td>`;
      tb.appendChild(tr);
    });
  }

  // Switch between pool and my tickets view
  function switchExpertView(mode) {
    expertViewMode = mode;
    const poolBtn = document.getElementById('pool-tab-btn');
    const myBtn = document.getElementById('my-tickets-tab-btn');
    const poolView = document.getElementById('expert-pool-view');
    const myView = document.getElementById('expert-my-view');
    const filterEl = document.getElementById('ex-ticket-filter');

    if (mode === 'pool') {
      poolBtn.classList.add('primary');
      myBtn.classList.remove('primary');
      poolView.style.display = 'block';
      myView.style.display = 'none';
      if (filterEl) filterEl.style.display = 'none';
      refreshPoolView();
    } else {
      poolBtn.classList.remove('primary');
      myBtn.classList.add('primary');
      poolView.style.display = 'none';
      myView.style.display = 'block';
      if (filterEl) filterEl.style.display = 'block';
      renderExpertDash();
    }
  }

  // Pool filter state
  let poolFilterTags = [];

  // Fetch and render ticket pool with optional filters
  async function refreshPoolView() {
    const token = localStorage.getItem('token');
    const tb = document.getElementById('pool-list');
    const noTickets = document.getElementById('pool-no-tickets');
    if (!tb) return;

    tb.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px">Loading pool...</td></tr>';

    try {
      // Build query params from filter controls
      const params = new URLSearchParams();

      // Pagination params
      params.set('page', poolPage.toString());
      params.set('limit', poolLimit.toString());

      const workType = document.getElementById('pool-filter-work-type')?.value;
      if (workType) params.set('work_type', workType);

      const execMode = document.getElementById('pool-filter-exec-mode')?.value;
      if (execMode) params.set('execution_mode', execMode);

      if (poolFilterTags.length > 0) {
        params.set('tags', poolFilterTags.join(','));
      }

      const needsTriage = document.getElementById('pool-filter-needs-triage')?.checked;
      if (needsTriage) {
        params.set('confidence_lt', '0.5');
        params.set('show_unknown', 'true');
      }

      const queryString = params.toString();
      const url = `/api/tickets/${window.tenant}/pool${queryString ? '?' + queryString : ''}`;

      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to load pool');
      }

      poolTickets = data.pool || [];
      poolPage = data.page || 1;
      poolTotalPages = data.totalPages || 1;
      poolTotal = data.total || 0;

      renderPoolTable();
      updatePoolPagination();
    } catch (error) {
      console.error('Error loading pool:', error);
      tb.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--danger)">Error: ${error.message}</td></tr>`;
    }
  }

  // Update pool pagination controls
  function updatePoolPagination() {
    const paginationEl = document.getElementById('pool-pagination');
    const infoEl = document.getElementById('pool-pagination-info');
    const prevBtn = document.getElementById('pool-prev-btn');
    const nextBtn = document.getElementById('pool-next-btn');

    if (!paginationEl) return;

    if (poolTotal === 0) {
      paginationEl.style.display = 'none';
      return;
    }

    paginationEl.style.display = 'flex';

    const startItem = (poolPage - 1) * poolLimit + 1;
    const endItem = Math.min(poolPage * poolLimit, poolTotal);
    infoEl.textContent = `Showing ${startItem}-${endItem} of ${poolTotal} tickets (Page ${poolPage} of ${poolTotalPages})`;

    prevBtn.disabled = poolPage <= 1;
    nextBtn.disabled = poolPage >= poolTotalPages;
  }

  // Pool pagination navigation
  function poolPrevPage() {
    if (poolPage > 1) {
      poolPage--;
      refreshPoolView();
    }
  }

  function poolNextPage() {
    if (poolPage < poolTotalPages) {
      poolPage++;
      refreshPoolView();
    }
  }

  // Apply pool filters - called when any filter control changes
  function applyPoolFilters() {
    poolPage = 1; // Reset to first page when filters change
    refreshPoolView();
  }

  // Add a tag filter chip
  function addPoolTagFilter() {
    const input = document.getElementById('pool-filter-tag');
    const tag = input?.value?.trim().toLowerCase().replace(/\s+/g, '_');
    if (!tag || poolFilterTags.includes(tag)) {
      if (input) input.value = '';
      return;
    }
    poolFilterTags.push(tag);
    input.value = '';
    renderPoolTagChips();
    refreshPoolView();
  }

  // Remove a tag filter chip
  function removePoolTagFilter(tag) {
    poolFilterTags = poolFilterTags.filter(t => t !== tag);
    renderPoolTagChips();
    refreshPoolView();
  }

  // Render tag filter chips
  function renderPoolTagChips() {
    const container = document.getElementById('pool-tag-chips');
    if (!container) return;
    container.innerHTML = poolFilterTags.map(tag => `
      <span style="display:inline-flex;align-items:center;gap:2px;padding:2px 6px;background:var(--accent);color:white;border-radius:4px;font-size:11px">
        ${escapeHtml(tag)}
        <button onclick="removePoolTagFilter('${escapeHtml(tag)}')" style="background:none;border:none;color:white;cursor:pointer;padding:0;font-size:14px;line-height:1">&times;</button>
      </span>
    `).join('');
  }

  // Clear all pool filters
  function clearPoolFilters() {
    const workTypeEl = document.getElementById('pool-filter-work-type');
    const execModeEl = document.getElementById('pool-filter-exec-mode');
    const tagInput = document.getElementById('pool-filter-tag');
    const needsTriageEl = document.getElementById('pool-filter-needs-triage');

    if (workTypeEl) workTypeEl.value = '';
    if (execModeEl) execModeEl.value = '';
    if (tagInput) tagInput.value = '';
    if (needsTriageEl) needsTriageEl.checked = false;

    poolFilterTags = [];
    poolPage = 1; // Reset to first page
    renderPoolTagChips();
    refreshPoolView();
  }

  // Render pool table
  function renderPoolTable() {
    const tb = document.getElementById('pool-list');
    const noTickets = document.getElementById('pool-no-tickets');
    const tableEl = tb ? tb.closest('table') : null;

    if (!tb) return;
    tb.innerHTML = '';

    if (poolTickets.length === 0) {
      if (noTickets) noTickets.style.display = 'block';
      if (tableEl) tableEl.style.display = 'none';
      return;
    }

    if (noTickets) noTickets.style.display = 'none';
    if (tableEl) tableEl.style.display = 'table';

    poolTickets.forEach(t => {
      const tr = document.createElement('tr');
      const score = t.pool_score ? Math.round(t.pool_score) : '—';
      const scoreColor = score >= 80 ? 'var(--danger)' : score >= 60 ? 'var(--warn)' : 'var(--muted)';
      const sla = t.sla_status || {};
      const slaText = sla.phase === 'in_pool' ? 'In Pool' : (sla.response?.state || 'N/A');
      const customer = t.company_name || t.requester_name || 'Unknown';
      // Check if claim is expired (treat as OPEN_POOL if so)
      const claimExpired = t.claimed_until_at && new Date(t.claimed_until_at) < new Date();
      const isClaimed = t.pool_status === 'CLAIMED_LOCKED' && t.claimed_by_expert_id && !claimExpired;

      // Work type badge
      const workTypeBadge = workTypeBadgeHTML(t.work_type);

      // System tags (parse if string)
      let systemTags = t.system_tags;
      if (typeof systemTags === 'string') {
        try { systemTags = JSON.parse(systemTags); } catch(e) { systemTags = []; }
      }
      const tagsHTML = systemTagsHTML(systemTags);

      // Button visibility per docs/workflows/ticket-ownership-state-matrix.md
      // A (OPEN_POOL): View + Claim (or Take Over for automated)
      // B (CLAIMED, mine): View only
      // B (CLAIMED, other): View (no action)
      // D (automated): View + Take Over
      const isAutomated = t.execution_mode === 'automated';
      const myUserId = parseInt(localStorage.getItem('userId'));
      let actionBtn = '';

      if (isClaimed && t.claimed_by_expert_id === myUserId) {
        // State B (mine): View (full detail) + Accept/Release buttons
        actionBtn = `<button class="btn" onclick="viewPoolTicket(${t.id})" style="font-size:11px;padding:4px 8px">View</button>
          <button class="btn success" onclick="acceptFromPool(${t.id})" style="font-size:11px;padding:4px 8px;margin-left:4px">Accept</button>
          <button class="btn" onclick="releaseFromPool(${t.id})" style="font-size:11px;padding:4px 8px;margin-left:4px">Release</button>`;
      } else if (isClaimed) {
        // State B (other): View (no claim action) + claimed indicator
        actionBtn = `<button class="btn" onclick="viewPoolTicket(${t.id})" style="font-size:11px;padding:4px 8px">View</button>
          <span style="font-size:10px;color:var(--muted);margin-left:4px">${t.claimed_by_name || 'Claimed'}</span>`;
      } else if (isAutomated) {
        // State D (automated): View + Take Over (no claim TTL)
        actionBtn = `<button class="btn" onclick="viewPoolTicket(${t.id})" style="font-size:11px;padding:4px 8px">View</button>
          <button class="btn primary" onclick="takeOverTicket(${t.id})" style="font-size:11px;padding:4px 8px;margin-left:4px">Take Over</button>`;
      } else {
        // State A (unclaimed): View + Claim
        actionBtn = `<button class="btn" onclick="viewPoolTicket(${t.id})" style="font-size:11px;padding:4px 8px">View</button>
          <button class="btn primary" onclick="claimTicket(${t.id})" style="font-size:11px;padding:4px 8px;margin-left:4px">Claim</button>`;
      }

      tr.innerHTML = `
        <td style="font-weight:600;color:${scoreColor}">${score}</td>
        <td>#${t.id}</td>
        <td style="max-width:200px">
          <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(t.title)}${workTypeBadge}</div>
          ${tagsHTML ? `<div style="margin-top:2px">${tagsHTML}</div>` : ''}
        </td>
        <td style="max-width:100px;overflow:hidden;text-overflow:ellipsis">${escapeHtml(customer)}</td>
        <td>${slaText}</td>
        <td>${actionBtn}</td>
      `;
      tb.appendChild(tr);
    });
  }

  // Shared handler for race condition responses (409 with CLAIM_RACE_LOST or ACCEPT_RACE_LOST)
  // Returns true if race condition was detected and handled, false otherwise
  async function handleRaceCondition(response, data) {
    if (response.status !== 409) return false;
    if (data.code !== 'CLAIM_RACE_LOST' && data.code !== 'ACCEPT_RACE_LOST') return false;

    // Show warning toast with server message or sensible default
    const message = data.message || 'Another expert got there first';
    showToast(message, 'warning', 4000);

    // Close claim preview modal if open
    closeClaimPreviewModal();

    // Refresh pool list so user sees updated state
    await refreshPoolView();

    // If viewing ticket detail, reload in read-only mode
    if (currentView === 'ticket-detail' && currentTicketId) {
      await renderTicketDetail();
    }

    return true;
  }

  // Claim a ticket for preview
  async function claimTicket(ticketId) {
    const token = localStorage.getItem('token');
    try {
      const res = await fetch(`/api/tickets/${window.tenant}/${ticketId}/claim`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        }
      });
      const data = await res.json();

      // Handle race condition (409) separately - not a generic error
      if (await handleRaceCondition(res, data)) return;

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to claim ticket');
      }

      currentClaimedTicket = data.ticket;
      openClaimPreviewModal(data);
    } catch (error) {
      console.error('Error claiming ticket:', error);
      showToast('Could not claim ticket: ' + error.message, 'error');
    }
  }

  // View a pool ticket without claiming (read-only, no DB writes)
  // Per docs/workflows/ticket-ownership-state-matrix.md: View = no DB writes
  function viewPoolTicket(ticketId) {
    // Just open the ticket detail view - GET endpoint has no DB writes
    // This allows experts to view ticket details before deciding to claim
    openTicket(ticketId);
  }

  // Accept ownership directly from pool row (for tickets user has claimed)
  async function acceptFromPool(ticketId) {
    const token = localStorage.getItem('token');
    try {
      const res = await fetch(`/api/tickets/${window.tenant}/${ticketId}/accept-ownership`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        }
      });
      const data = await res.json();

      // Handle race condition (409) separately
      if (await handleRaceCondition(res, data)) return;

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to accept ownership');
      }

      // Success - switch to My Tickets view and open the ticket
      switchExpertView('my');
      await fetchTicketsFromAPI();
      openTicket(data.ticket.id);
      showToast('Ticket accepted - you now own it', 'success');
    } catch (error) {
      console.error('Error accepting ownership:', error);
      showToast('Could not accept ownership: ' + error.message, 'error');
    }
  }

  // Release claim directly from pool row
  async function releaseFromPool(ticketId) {
    const token = localStorage.getItem('token');
    try {
      const res = await fetch(`/api/tickets/${window.tenant}/${ticketId}/release-claim`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        }
      });
      const data = await res.json();

      // Handle race condition (409) separately
      if (await handleRaceCondition(res, data)) return;

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to release claim');
      }

      // Refresh pool to show updated state
      await refreshPoolView();
      showToast('Claim released - ticket returned to pool', 'info');
    } catch (error) {
      console.error('Error releasing claim:', error);
      showToast('Could not release claim: ' + error.message, 'error');
    }
  }

  // Claim ticket from detail view (redirects to claim flow)
  async function claimTicketFromDetail() {
    if (!currentTicketId) return;
    await claimTicket(currentTicketId);
  }

  // Take over ticket from detail view
  async function takeOverTicketFromDetail() {
    if (!currentTicketId) return;
    await takeOverTicket(currentTicketId);
  }

  // Take over an automated ticket (skip claim TTL, go direct to ownership)
  // Per docs/workflows/ticket-ownership-state-matrix.md: D → C transition
  async function takeOverTicket(ticketId) {
    const token = localStorage.getItem('token');
    try {
      const res = await fetch(`/api/tickets/${window.tenant}/${ticketId}/take-over`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        }
      });
      const data = await res.json();

      // Handle race condition (409) separately - not a generic error
      if (await handleRaceCondition(res, data)) return;

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to take over ticket');
      }

      // Success - switch to My Tickets view and open the ticket
      switchExpertView('my');
      await refreshMyTickets();
      openTicket(ticketId);
    } catch (error) {
      console.error('Error taking over ticket:', error);
      showToast('Could not take over ticket: ' + error.message, 'error');
    }
  }

  // Open the claim preview modal
  function openClaimPreviewModal(claimData) {
    const ticket = claimData.ticket;
    const expiresAt = new Date(claimData.claim_expires_at);

    // Create modal if doesn't exist
    let modal = document.getElementById('claim-preview-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'claim-preview-modal';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:600px">
          <div class="modal-header">
            <h3 id="claim-preview-title">Ticket Preview</h3>
            <span id="claim-countdown" style="background:#fef3c7;color:#b45309;padding:4px 12px;border-radius:999px;font-size:12px;font-weight:600"></span>
          </div>
          <div class="modal-body" id="claim-preview-body"></div>
          <div class="modal-footer">
            <button class="btn" onclick="releaseClaim()">Release</button>
            <button class="btn primary" onclick="acceptOwnership()">Accept & Own</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Populate content
    document.getElementById('claim-preview-title').textContent = `#${ticket.id} - ${ticket.title}`;
    document.getElementById('claim-preview-body').innerHTML = `
      <div style="margin-bottom:16px">
        <label class="label">Customer</label>
        <div>${escapeHtml(ticket.company_name || ticket.requester_name || 'Unknown')}</div>
      </div>
      <div style="margin-bottom:16px">
        <label class="label">Priority</label>
        <div><span class="badge">${ticket.priority}</span></div>
      </div>
      <div style="margin-bottom:16px">
        <label class="label">Description</label>
        <div style="background:var(--badge-bg);padding:12px;border-radius:8px;max-height:200px;overflow-y:auto">${escapeHtml(ticket.description || 'No description')}</div>
      </div>
      ${ticket.sla_status ? `
      <div style="margin-bottom:16px">
        <label class="label">SLA Status</label>
        <div>Response: ${ticket.sla_status.response?.state || 'N/A'} | Resolve: ${ticket.sla_status.resolve?.state || 'N/A'}</div>
      </div>` : ''}
    `;

    // Start countdown timer
    if (claimTimer) clearInterval(claimTimer);
    claimTimer = setInterval(() => {
      const now = new Date();
      const remaining = Math.max(0, Math.floor((expiresAt - now) / 1000));
      document.getElementById('claim-countdown').textContent = `${remaining}s remaining`;
      if (remaining <= 0) {
        clearInterval(claimTimer);
        closeClaimPreviewModal();
        refreshPoolView();
      }
    }, 1000);

    modal.style.display = 'flex';
  }

  function closeClaimPreviewModal() {
    const modal = document.getElementById('claim-preview-modal');
    if (modal) modal.style.display = 'none';
    if (claimTimer) clearInterval(claimTimer);
    currentClaimedTicket = null;
  }

  // Accept ownership of claimed ticket
  async function acceptOwnership() {
    const token = localStorage.getItem('token');
    if (!currentClaimedTicket) return;

    const ticketId = currentClaimedTicket.id;
    try {
      const res = await fetch(`/api/tickets/${window.tenant}/${ticketId}/accept-ownership`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        }
      });
      const data = await res.json();

      // Handle race condition (409) separately - not a generic error
      if (await handleRaceCondition(res, data)) return;

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to accept ownership');
      }

      closeClaimPreviewModal();
      switchExpertView('my');  // Switch to My Tickets view
      await fetchTicketsFromAPI();      // Refresh tickets
      openTicket(data.ticket.id);  // Open the ticket
    } catch (error) {
      console.error('Error accepting ownership:', error);
      showToast('Could not accept ownership: ' + error.message, 'error');
    }
  }

  // Release claim (return to pool)
  async function releaseClaim() {
    const token = localStorage.getItem('token');
    if (!currentClaimedTicket) {
      closeClaimPreviewModal();
      return;
    }

    try {
      const res = await fetch(`/api/tickets/${window.tenant}/${currentClaimedTicket.id}/release-claim`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        }
      });
      const data = await res.json();

      // Handle race condition (409) separately - not a generic error
      if (await handleRaceCondition(res, data)) return;

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to release claim');
      }

      closeClaimPreviewModal();
      refreshPoolView();
    } catch (error) {
      console.error('Error releasing claim:', error);
      showToast('Could not release claim: ' + error.message, 'error');
    }
  }

  // Open claimed ticket preview (when already claimed)
  function openClaimedPreview(ticketId) {
    const ticket = poolTickets.find(t => t.id === ticketId);
    if (ticket) {
      currentClaimedTicket = ticket;
      // Re-claim to extend timer
      claimTicket(ticketId);
    }
  }

  // Set ticket to Waiting on Customer (pause SLA)
  async function setWaitingOnCustomer(ticketId, reason = '') {
    const token = localStorage.getItem('token');
    try {
      const res = await fetch(`/api/tickets/${window.tenant}/${ticketId}/waiting-on-customer`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ reason })
      });
      const data = await res.json();

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to set waiting on customer');
      }

      await fetchTicketsFromAPI();
      if (currentTicketId === ticketId) {
        const t = tickets.find(x => x.id === ticketId);
        if (t) renderTicketDetail(t);
      }
    } catch (error) {
      console.error('Error setting waiting on customer:', error);
      alert('Error: ' + error.message);
    }
  }

  // Resume ticket from Waiting on Customer
  async function resumeTicket(ticketId) {
    const token = localStorage.getItem('token');
    try {
      const res = await fetch(`/api/tickets/${window.tenant}/${ticketId}/resume`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        }
      });
      const data = await res.json();

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to resume ticket');
      }

      await fetchTicketsFromAPI();
      if (currentTicketId === ticketId) {
        const t = tickets.find(x => x.id === ticketId);
        if (t) renderTicketDetail(t);
      }
    } catch (error) {
      console.error('Error resuming ticket:', error);
      alert('Error: ' + error.message);
    }
  }

  // Escalate ticket (return to pool or transfer)
  async function escalateTicket(ticketId, reason, transferToUserId = null) {
    const token = localStorage.getItem('token');
    if (!reason) {
      reason = prompt('Please provide a reason for escalation:');
      if (!reason) return;
    }

    try {
      const res = await fetch(`/api/tickets/${window.tenant}/${ticketId}/escalate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ reason, transfer_to_user_id: transferToUserId })
      });
      const data = await res.json();

      if (!res.ok || !data.success) {
        throw new Error(data.message || 'Failed to escalate ticket');
      }

      await fetchTicketsFromAPI();
      switchView('dash');  // Return to dashboard from ticket-detail view
      switchExpertView('pool');
    } catch (error) {
      console.error('Error escalating ticket:', error);
      alert('Error: ' + error.message);
    }
  }

  // ========== END TICKET POOL WORKFLOW ==========

  // Load AI insights for expert dashboard
  function loadExpertAIInsights(myTickets, todayTickets, riskTickets) {
    const loadingEl = document.getElementById('ex-ai-loading');
    const contentEl = document.getElementById('ex-ai-content');
    const summaryEl = document.getElementById('ex-ai-summary');
    const suggestionsEl = document.getElementById('ex-ai-suggestions');

    if (!loadingEl || !contentEl) return;

    // Generate insights based on current queue
    let summary = '';
    let suggestions = '';

    if (myTickets.length === 0) {
      summary = '🎉 Your queue is clear! Great job staying on top of tickets.';
    } else {
      summary = `You have <strong>${myTickets.length}</strong> open ticket${myTickets.length !== 1 ? 's' : ''}.`;

      if (riskTickets.length > 0) {
        summary += ` <span style="color:#fbbf24">⚠️ ${riskTickets.length} at SLA risk!</span>`;
      }

      if (todayTickets.length > 0) {
        summary += `<br><span style="color:#fcd34d">📅 ${todayTickets.length} due today.</span>`;
      }

      // Prioritization suggestion
      if (riskTickets.length > 0) {
        const urgent = riskTickets[0];
        suggestions = `<div style="background:rgba(255,255,255,0.15);border-radius:6px;padding:8px;margin-top:8px">
          <strong>Suggested action:</strong><br>
          Focus on <a href="#" onclick="openTicket(${urgent.id});return false" style="color:#fcd34d">#${urgent.id}</a> - ${urgent.title.substring(0, 40)}...
        </div>`;
      } else if (todayTickets.length > 0) {
        const next = todayTickets[0];
        suggestions = `<div style="background:rgba(255,255,255,0.15);border-radius:6px;padding:8px;margin-top:8px">
          <strong>Next up:</strong><br>
          <a href="#" onclick="openTicket(${next.id});return false" style="color:#fcd34d">#${next.id}</a> - ${next.title.substring(0, 40)}...
        </div>`;
      }
    }

    loadingEl.style.display = 'none';
    contentEl.style.display = 'block';
    summaryEl.innerHTML = summary;
    suggestionsEl.innerHTML = suggestions;
  }

  // Refresh AI insights
  function refreshExpertAIInsights() {
    const loadingEl = document.getElementById('ex-ai-loading');
    const contentEl = document.getElementById('ex-ai-content');
    if (loadingEl) loadingEl.style.display = 'block';
    if (contentEl) contentEl.style.display = 'none';
    renderExpertDash();
  }

  // Load recent assets for expert dashboard
  async function loadExpertRecentAssets() {
    const assetsEl = document.getElementById('ex-assets-list');
    if (!assetsEl) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`/api/cmdb/${tenantCode}/items?limit=5`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) throw new Error('Failed to load assets');

      const data = await response.json();
      const items = data.items || [];

      if (items.length === 0) {
        assetsEl.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No assets found</div>';
        return;
      }

      assetsEl.innerHTML = items.map(item => `
        <div style="padding:8px;border-bottom:1px solid var(--border);cursor:pointer" onclick="openCMDBDetail(${item.cmdb_id || item.id})">
          <div style="font-weight:500">${item.asset_name || item.name}</div>
          <div style="font-size:11px;color:var(--muted)">${item.customer_name || ''} · ${item.asset_category || item.type || ''}</div>
        </div>
      `).join('');
    } catch (error) {
      console.error('Error loading assets:', error);
      assetsEl.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">Failed to load assets</div>';
    }
  }

  // Clear power search results (called when navigating away)
  function clearExpertPowerSearch() {
    const searchInput = document.getElementById('expert-power-search');
    const resultsEl = document.getElementById('expert-search-results');
    if (searchInput) searchInput.value = '';
    if (resultsEl) {
      resultsEl.style.display = 'none';
      resultsEl.innerHTML = '';
    }
  }

  // Power search for expert dashboard (server-side search)
  async function expertPowerSearch() {
    const searchInput = document.getElementById('expert-power-search');
    const resultsEl = document.getElementById('expert-search-results');
    const query = searchInput ? searchInput.value.trim() : '';

    if (!query || !resultsEl) return;

    resultsEl.style.display = 'block';
    resultsEl.innerHTML = '<div style="padding:12px;color:var(--muted)">Searching...</div>';

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/api/tickets/${tenant}/power-search?q=${encodeURIComponent(query)}&limit=10`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) throw new Error('Search failed');

      const data = await response.json();
      const ticketResults = data.tickets || [];
      const cmdbResults = data.cmdb || [];
      const kbResults = data.kb || [];

      if (ticketResults.length === 0 && cmdbResults.length === 0 && kbResults.length === 0) {
        resultsEl.innerHTML = '<div style="padding:12px;color:var(--muted)">No results found for "' + escapeHtml(query) + '"</div>';
        return;
      }

      let html = '<div style="display:flex;flex-direction:column;gap:8px">';

      if (ticketResults.length > 0) {
        html += '<div style="font-weight:600;font-size:12px;color:#2563eb">📋 Tickets</div>';
        ticketResults.forEach(t => {
          const statusBadge = t.status === 'Open' ? '🟢' : t.status === 'In Progress' ? '🟡' : '⚪';
          html += `<div style="padding:6px 8px;background:white;border-radius:4px;cursor:pointer;border:1px solid #e5e7eb" onclick="openTicket(${t.id})">
            <span style="color:#2563eb;font-weight:500">#${t.id}</span> ${escapeHtml(t.title || '')}
            <span style="font-size:11px;color:#666;margin-left:8px">${statusBadge} ${t.status || ''}</span>
          </div>`;
        });
      }

      if (cmdbResults.length > 0) {
        html += '<div style="font-weight:600;font-size:12px;color:#059669;margin-top:8px">🖥️ Assets</div>';
        cmdbResults.forEach(c => {
          html += `<div style="padding:6px 8px;background:white;border-radius:4px;cursor:pointer;border:1px solid #e5e7eb" onclick="openCMDBDetail(${c.cmdb_id})">
            <span style="color:#059669;font-weight:500">${escapeHtml(c.asset_name || '')}</span> · ${escapeHtml(c.customer_name || '')}
          </div>`;
        });
      }

      if (kbResults.length > 0) {
        html += '<div style="font-weight:600;font-size:12px;color:#8b5cf6;margin-top:8px">📚 Knowledge Base</div>';
        kbResults.forEach(k => {
          html += `<div style="padding:6px 8px;background:white;border-radius:4px;cursor:pointer;border:1px solid #e5e7eb" onclick="showPage('kb');setTimeout(()=>openKBArticle(${k.id}),100)">
            <span style="color:#8b5cf6;font-weight:500">${escapeHtml(k.title || '')}</span>
            <span style="font-size:11px;color:#666;margin-left:8px">${escapeHtml(k.category || '')}</span>
          </div>`;
        });
      }

      html += '<button class="btn ghost" style="margin-top:8px;font-size:12px" onclick="document.getElementById(\'expert-search-results\').style.display=\'none\'">Close results</button>';
      html += '</div>';

      resultsEl.innerHTML = html;

    } catch (error) {
      console.error('Power search error:', error);
      resultsEl.innerHTML = '<div style="padding:12px;color:#dc2626">Search failed. Please try again.</div>';
    }
  }
  function renderCustomerDash(){ const currentRole = window.role || role; if(currentRole!=='customer') return; const items = CMDB_ITEMS.filter(i => !tenant || i.customer===tenant); const ciCount = items.reduce((a,i)=>a+(CIS_BY_ITEM[i.cmdb_id]?.length||0),0); const openTickets = tickets.filter(t => (!tenant || (t.customer===tenant)) && t.status!=='Resolved').length; document.getElementById('cu-open').textContent=openTickets; document.getElementById('cu-items').textContent=items.length + ciCount; renderCustomerTrending(); renderCustomerRequests(); }
  function renderCustomerTrending() {
    const el = document.getElementById('cu-trending-body');
    if (!el) return;
    const companyId = window.currentUser && window.currentUser.customerCompanyId;
    const companyTickets = tickets.filter(t => {
      if (t.is_system_source) return false;
      if (companyId && t.customer_company_id) return t.customer_company_id === companyId;
      return true;
    });
    if (companyTickets.length === 0) {
      el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">No request data yet</div>';
      return;
    }
    // Group by category
    const catFreq = {};
    companyTickets.forEach(t => {
      const cat = t.category || 'Uncategorised';
      catFreq[cat] = (catFreq[cat] || 0) + 1;
    });
    const sorted = Object.entries(catFreq).sort((a, b) => b[1] - a[1]).slice(0, 8);
    if (sorted.length === 0) {
      el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">Not enough data for trends</div>';
      return;
    }
    const maxCount = sorted[0][1];
    const gradients = ['#667eea','#8b5cf6','#a855f7','#d946ef','#ec4899','#f43f5e','#f97316','#eab308'];
    let html = '';
    sorted.forEach(([cat, count], i) => {
      const pct = Math.max(Math.round((count / maxCount) * 100), 12);
      const color = gradients[i % gradients.length];
      html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <div style="flex:1;min-width:0">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px">
            <span style="font-weight:500;font-size:13px">${cat}</span>
            <span style="color:var(--muted);font-size:12px">${count} request${count !== 1 ? 's' : ''}</span>
          </div>
          <div style="height:6px;border-radius:3px;background:var(--border);overflow:hidden">
            <div style="height:100%;width:${pct}%;border-radius:3px;background:linear-gradient(90deg,${color},${color}90);transition:width .4s ease"></div>
          </div>
        </div>
      </div>`;
    });
    el.innerHTML = html;
  }
  function renderCustomerRequests() {
    const tb = document.getElementById('cu-req-body');
    const countEl = document.getElementById('cu-req-count');
    if (!tb) return;
    const userId = window.currentUser && window.currentUser.id;
    // Company admin: real login OR impersonated customer who is company admin OR admin testing as customer
    const isCompanyAdmin = (window.currentUser && window.currentUser.isCompanyAdmin) || (window.impersonatedUser && window.impersonatedUser.role === 'customer') || (window.loginRole && window.loginRole === 'admin' && (window.role || role) === 'customer');
    const mode = window._cuReqMode || 'requests';
    // Show/hide monitoring toggle for company admins
    const sysToggle = document.getElementById('cu-system-toggle');
    if (sysToggle) sysToggle.style.display = isCompanyAdmin ? 'flex' : 'none';
    // Filter: requests = non-monitoring only, monitoring = is_system_source only
    let myTickets = tickets.filter(t => {
      const isMonitoring = !!t.is_system_source;
      return mode === 'monitoring' ? isMonitoring : !isMonitoring;
    });
    // Apply status filter
    const statusF = document.getElementById('cu-req-filter-status')?.value || '';
    if (statusF) myTickets = myTickets.filter(t => t.status === statusF);
    // Apply priority filter
    const prioF = document.getElementById('cu-req-filter-priority')?.value || '';
    if (prioF) myTickets = myTickets.filter(t => (t.priority || '').toLowerCase() === prioF);
    // Sort
    const sortBy = document.getElementById('cu-req-sort')?.value || 'newest';
    if (sortBy === 'newest') myTickets.sort((a, b) => (b.id || 0) - (a.id || 0));
    else if (sortBy === 'oldest') myTickets.sort((a, b) => (a.id || 0) - (b.id || 0));
    else if (sortBy === 'priority') {
      const pOrder = { critical: 0, high: 1, medium: 2, low: 3 };
      myTickets.sort((a, b) => (pOrder[(a.priority||'').toLowerCase()] ?? 4) - (pOrder[(b.priority||'').toLowerCase()] ?? 4));
    } else if (sortBy === 'status') {
      const sOrder = { Open: 0, 'In Progress': 1, Pending: 2, Resolved: 3, Closed: 4 };
      myTickets.sort((a, b) => (sOrder[a.status] ?? 5) - (sOrder[b.status] ?? 5));
    }
    if (countEl) countEl.textContent = myTickets.length + ' request' + (myTickets.length !== 1 ? 's' : '');
    tb.innerHTML = '';
    if (myTickets.length === 0) {
      tb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted)">No requests found</td></tr>';
      return;
    }
    const priorityColors = { critical: '#dc2626', high: '#f59e0b', medium: '#3b82f6', low: '#6b7280' };
    const statusColors = { Open: '#3b82f6', 'In Progress': '#f59e0b', Pending: '#8b5cf6', Resolved: '#10b981', Closed: '#6b7280' };
    myTickets.forEach(t => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.onclick = function() { openTicket(t.id); };
      const pColor = priorityColors[(t.priority || '').toLowerCase()] || '#6b7280';
      const sColor = statusColors[t.status] || '#6b7280';
      const sla = getSLAState(t);
      tr.innerHTML = `<td>#${t.id}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.title || ''}</td><td><span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;color:#fff;background:${pColor}">${(t.priority||'medium').charAt(0).toUpperCase()+(t.priority||'medium').slice(1)}</span></td><td><span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;color:#fff;background:${sColor}">${t.status||'Open'}</span></td><td>${slaBadgeHTML(sla)}</td>`;
      tb.appendChild(tr);
    });
  }
  function clearCustomerReqFilters() {
    const s = document.getElementById('cu-req-filter-status'); if (s) s.value = '';
    const p = document.getElementById('cu-req-filter-priority'); if (p) p.value = '';
    const o = document.getElementById('cu-req-sort'); if (o) o.value = 'newest';
    renderCustomerRequests();
  }
  window._cuReqMode = 'requests';
  function setCuReqMode(mode) {
    window._cuReqMode = mode;
    const reqBtn = document.getElementById('cu-req-mode-requests');
    const monBtn = document.getElementById('cu-req-mode-monitoring');
    if (reqBtn) { reqBtn.style.background = mode === 'requests' ? '#667eea' : 'var(--card)'; reqBtn.style.color = mode === 'requests' ? '#fff' : 'var(--muted)'; reqBtn.style.fontWeight = mode === 'requests' ? '600' : '500'; }
    if (monBtn) { monBtn.style.background = mode === 'monitoring' ? '#667eea' : 'var(--card)'; monBtn.style.color = mode === 'monitoring' ? '#fff' : 'var(--muted)'; monBtn.style.fontWeight = mode === 'monitoring' ? '600' : '500'; }
    renderCustomerRequests();
  }
  function renderMasterDash(){
    const currentRole = window.role || role;
    if (currentRole !== 'super_admin') return;

    // Load tenants from master database
    loadTenants();

    // Load recent tenant activity
    loadMasterDashActivity();

    // Update master dashboard stats
    document.getElementById('ma-tenants').textContent = '...'; // Will be updated by loadTenants
    document.getElementById('ma-active').textContent = '...';
    document.getElementById('ma-health').textContent = '100%';
  }

  async function loadMasterDashActivity() {
    const activityDiv = document.getElementById('ma-activity');
    if (!activityDiv) {
      console.log('ma-activity div not found');
      return;
    }

    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/overview', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      if (!response.ok) {
        activityDiv.innerHTML = '<span class="subtitle">Failed to load activity</span>';
        return;
      }

      const data = await response.json();

      if (data.success && data.overview && data.overview.recent_activity && data.overview.recent_activity.length > 0) {
        const activities = data.overview.recent_activity.slice(0, 5);
        let html = '<ul style="list-style:none;padding:0;margin:0">';
        activities.forEach(activity => {
          const time = new Date(activity.created_at).toLocaleString();
          let details = '';
          try {
            const parsed = JSON.parse(activity.details);
            details = parsed.message || activity.action;
          } catch (e) {
            details = activity.action || 'Activity';
          }
          const user = activity.user_username || 'System';
          html += `<li style="padding:8px 0;border-bottom:1px solid var(--border)">
            <span class="badge" style="font-size:10px">${activity.action || 'event'}</span>
            <span style="margin-left:8px">${user}: ${details}</span>
            <span class="subtitle" style="float:right;font-size:11px">${time}</span>
          </li>`;
        });
        html += '</ul>';
        activityDiv.innerHTML = html;
      } else {
        activityDiv.innerHTML = '<span class="subtitle">No recent activity</span>';
      }
    } catch (error) {
      console.error('Error loading master activity:', error);
      activityDiv.innerHTML = '<span class="subtitle">Failed to load activity</span>';
    }
  }
  
  // Master Admin functions
  async function loadTenants() {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/tenants', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      
      if (data.success) {
        const totalCount = data.tenants.length;
        const activeCount = data.tenants.filter(t => t.status === 'active').length;
        const el1 = document.getElementById('ma-tenants');
        if (el1) el1.textContent = totalCount;
        const el2 = document.getElementById('ma-active');
        if (el2) el2.textContent = activeCount;

        // Update tenant list if on tenants view
        if (currentView === 'tenants') {
          const tbody = document.getElementById('tenant-list-body');
          if (tbody) {
            tbody.innerHTML = '';
            data.tenants.forEach(tenant => {
              const tr = document.createElement('tr');
              const isActive = tenant.status === 'active';
              const statusBadge = isActive ? 'Active' : (tenant.status === 'suspended' ? 'Suspended' : 'Inactive');
              const statusClass = isActive ? 'success' : 'danger';
              const createdDate = new Date(tenant.created_at).toLocaleDateString();

              // Plan and subscription info
              const planName = tenant.plan_name || 'No Plan';
              const subStatus = tenant.subscription_status || 'none';
              const subBadgeClass = {
                'trial': 'warning',
                'active': 'success',
                'past_due': 'danger',
                'cancelled': 'danger',
                'expired': 'danger',
                'none': ''
              }[subStatus] || '';

              let subDisplay = subStatus.charAt(0).toUpperCase() + subStatus.slice(1).replace('_', ' ');
              if (subStatus === 'trial' && tenant.trial_end) {
                const trialEnd = new Date(tenant.trial_end);
                const daysLeft = Math.ceil((trialEnd - new Date()) / (1000*60*60*24));
                subDisplay += ` (${daysLeft}d left)`;
              }

              const escapedName = (tenant.company_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
              const escapedCode = (tenant.tenant_code || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

              let actionBtns = '';
              if (isActive) {
                actionBtns = `
                  <button type="button" class="btn btn-sm" onclick="event.preventDefault();event.stopPropagation();editTenant(${tenant.id})">Edit</button>
                  <button type="button" class="btn btn-sm" onclick="event.preventDefault();event.stopPropagation();manageTenantSubscription(${tenant.id})">Subscription</button>
                  <button type="button" class="btn btn-sm btn-danger" onclick="event.preventDefault();event.stopPropagation();deleteTenant(${tenant.id},'${escapedName}','${escapedCode}')">Deactivate</button>
                `;
              } else {
                actionBtns = `
                  <button type="button" class="btn btn-sm" style="background:var(--success);color:#fff" onclick="event.preventDefault();event.stopPropagation();restoreTenant(${tenant.id})">Restore</button>
                  <button type="button" class="btn btn-sm btn-danger" onclick="event.preventDefault();event.stopPropagation();permanentDeleteTenant(${tenant.id},'${escapedName}','${escapedCode}')">Permanently Delete</button>
                `;
              }

              if (!isActive) tr.style.opacity = '0.7';

              tr.innerHTML = `
                <td>${tenant.company_name}</td>
                <td>${tenant.tenant_code}</td>
                <td><span class="badge ${statusClass}">${statusBadge}</span></td>
                <td>${planName}</td>
                <td><span class="badge ${subBadgeClass}">${subDisplay}</span></td>
                <td>${createdDate}</td>
                <td>${actionBtns}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        }
      }
    } catch (error) {
      console.error('Error loading tenants:', error);
    }
  }

  // Event delegation for tenant action buttons
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('[data-action][data-tenant-id]');
    if (!btn) return;

    const action = btn.getAttribute('data-action');
    const tenantId = parseInt(btn.getAttribute('data-tenant-id'), 10);

    console.log('Tenant action clicked:', action, tenantId);

    if (action === 'edit') {
      editTenant(tenantId);
    } else if (action === 'subscription') {
      manageTenantSubscription(tenantId);
    } else if (action === 'delete') {
      deleteTenant(tenantId);
    }
  });

  function showCreateTenantForm() {
    document.getElementById('create-tenant-form').style.display = 'block';
  }
  
  function hideCreateTenantForm() {
    document.getElementById('create-tenant-form').style.display = 'none';
    document.getElementById('new-tenant-company').value = '';
    document.getElementById('new-tenant-admin').value = '';
    document.getElementById('new-tenant-email').value = '';
  }
  
  function showEditTenantForm(tenant) {
    // Populate the edit form with tenant data
    document.getElementById('edit-tenant-id').value = tenant.id;
    document.getElementById('edit-company-name').value = tenant.company_name;
    document.getElementById('edit-admin-username').value = tenant.tenant_code;
    document.getElementById('edit-admin-email').value = tenant.admin_email || '';
    document.getElementById('edit-tenant-status').value = tenant.is_active ? 'active' : 'inactive';

    // Show the edit form
    document.getElementById('edit-tenant-form').style.display = 'block';
  }
  
  function hideEditTenantForm() {
    document.getElementById('edit-tenant-form').style.display = 'none';
  }
  
  async function createTenant() {
    const companyName = document.getElementById('new-tenant-company').value;
    const adminUsername = document.getElementById('new-tenant-admin').value;
    const adminEmail = document.getElementById('new-tenant-email').value;
    
    if (!companyName || !adminUsername || !adminEmail) {
      alert('Please fill in all fields');
      return;
    }
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/tenants', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          companyName,
          adminUsername,
          adminEmail
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        let credentialsMsg = 'Tenant created successfully!\n\n';
        if (data.adminCredentials) {
          credentialsMsg += 'Admin Login Credentials:\n';
          credentialsMsg += `Username: ${data.adminCredentials.username}\n`;
          credentialsMsg += `Email: ${data.adminCredentials.email}\n`;
          credentialsMsg += `Password: ${data.adminCredentials.password}\n`;
          credentialsMsg += `Tenant Code: ${data.tenantCode}\n\n`;
          credentialsMsg += 'IMPORTANT: Save these credentials! The admin should change their password on first login.';
        }
        alert(credentialsMsg);
        hideCreateTenantForm();
        loadTenants();
      } else {
        alert('Error creating tenant: ' + data.message);
      }
    } catch (error) {
      console.error('Error creating tenant:', error);
      alert('Error creating tenant');
    }
  }
  
  async function updateTenant() {
    const tenantId = document.getElementById('edit-tenant-id').value;
    const companyName = document.getElementById('edit-company-name').value;
    const displayName = document.getElementById('edit-company-name').value; // Use same as company name
    const adminEmail = document.getElementById('edit-admin-email').value;
    const status = document.getElementById('edit-tenant-status').value;

    if (!companyName || !adminEmail) {
      alert('Please fill in all required fields');
      return;
    }

    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/tenants/${tenantId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          company_name: companyName,
          display_name: displayName,
          admin_email: adminEmail,
          is_active: status === 'active'
        })
      });

      const data = await response.json();

      if (data.success) {
        alert('Tenant updated successfully!');
        hideEditTenantForm();
        loadTenants(); // Refresh the tenant list
      } else {
        alert('Error updating tenant: ' + data.message);
      }
    } catch (error) {
      console.error('Error updating tenant:', error);
      alert('Error updating tenant');
    }
  }

  // Tenant subscription management
  let tenantSubPlans = [];

  async function loadPlansForTenantSubscription() {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/plans', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await response.json();
      if (data.success) {
        tenantSubPlans = data.plans;
        const select = document.getElementById('sub-plan-id');
        select.innerHTML = '<option value="">Select a plan</option>';
        data.plans.forEach(plan => {
          const pricingLabel = plan.pricing_model === 'per_client'
            ? `$${plan.price_monthly}/mo (${plan.base_clients_included} clients incl.)`
            : `$${plan.price_monthly}/tech/mo`;
          const modelBadge = plan.pricing_model === 'per_client' ? ' [Per Client]' : '';
          select.innerHTML += `<option value="${plan.id}" data-pricing-model="${plan.pricing_model || 'per_technician'}">${plan.name}${modelBadge} - ${pricingLabel}</option>`;
        });
        // Add change handler
        select.onchange = onPlanChange;
      }
    } catch (error) {
      console.error('Error loading plans:', error);
    }
  }

  function onPlanChange() {
    const select = document.getElementById('sub-plan-id');
    const selectedOption = select.options[select.selectedIndex];
    const pricingModel = selectedOption?.dataset?.pricingModel || 'per_technician';

    // Show/hide appropriate count fields
    const userCountGroup = document.getElementById('sub-user-count-group');
    const clientCountGroup = document.getElementById('sub-client-count-group');

    if (pricingModel === 'per_client') {
      userCountGroup.style.display = 'none';
      clientCountGroup.style.display = 'block';
    } else {
      userCountGroup.style.display = 'block';
      clientCountGroup.style.display = 'none';
    }
  }

  async function manageTenantSubscription(tenantId) {
    // Load plans if not loaded
    if (tenantSubPlans.length === 0) {
      await loadPlansForTenantSubscription();
    }

    // Show modal
    document.getElementById('tenant-subscription-modal').style.display = 'block';
    document.getElementById('sub-tenant-id').value = tenantId;

    // Load current subscription
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/tenants/${tenantId}/subscription`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await response.json();

      // Get tenant name from tenants list
      const tenantsResp = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/tenants/${tenantId}`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const tenantData = await tenantsResp.json();
      document.getElementById('sub-tenant-name').textContent = tenantData.tenant?.company_name || `Tenant #${tenantId}`;

      if (data.success && data.subscription) {
        const sub = data.subscription;
        document.getElementById('sub-plan-id').value = sub.plan_id || '';
        document.getElementById('sub-status').value = sub.status || 'trial';
        document.getElementById('sub-billing-cycle').value = sub.billing_cycle || 'monthly';
        document.getElementById('sub-trial-end').value = sub.trial_end ? sub.trial_end.split('T')[0] : '';
        document.getElementById('sub-period-start').value = sub.current_period_start ? sub.current_period_start.split('T')[0] : '';
        document.getElementById('sub-period-end').value = sub.current_period_end ? sub.current_period_end.split('T')[0] : '';
        document.getElementById('sub-user-count').value = sub.user_count || 0;
        document.getElementById('sub-client-count').value = sub.client_count || 0;

        // Trigger plan change to show correct fields
        onPlanChange();

        // Show current info
        const plan = tenantSubPlans.find(p => p.id == sub.plan_id);
        const planName = plan?.name || 'Unknown';
        const pricingModel = plan?.pricing_model || 'per_technician';
        const usageInfo = pricingModel === 'per_client'
          ? `Clients: ${sub.client_count || 0}`
          : `Technicians: ${sub.user_count || 0}`;
        document.getElementById('sub-current-details').innerHTML = `
          <strong>${planName}</strong> - ${sub.status}<br>
          Billing: ${sub.billing_cycle || 'monthly'} | ${usageInfo}
          ${sub.trial_end ? `<br>Trial ends: ${new Date(sub.trial_end).toLocaleDateString()}` : ''}
        `;

        // Show cancel button if active or trial
        document.getElementById('btn-cancel-sub').style.display =
          (sub.status === 'active' || sub.status === 'trial') ? 'inline-block' : 'none';
      } else {
        // No subscription - set defaults
        document.getElementById('sub-plan-id').value = '';
        document.getElementById('sub-status').value = 'trial';
        document.getElementById('sub-billing-cycle').value = 'monthly';
        document.getElementById('sub-trial-end').value = '';
        document.getElementById('sub-period-start').value = new Date().toISOString().split('T')[0];
        document.getElementById('sub-period-end').value = '';
        document.getElementById('sub-user-count').value = 0;
        document.getElementById('sub-client-count').value = 0;
        document.getElementById('sub-current-details').textContent = 'No subscription assigned';
        document.getElementById('btn-cancel-sub').style.display = 'none';
        // Reset to default view
        document.getElementById('sub-user-count-group').style.display = 'block';
        document.getElementById('sub-client-count-group').style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading subscription:', error);
      document.getElementById('sub-current-details').textContent = 'Error loading subscription';
    }
  }

  function hideTenantSubscriptionModal() {
    document.getElementById('tenant-subscription-modal').style.display = 'none';
  }

  async function saveTenantSubscription() {
    const tenantId = document.getElementById('sub-tenant-id').value;
    const planId = document.getElementById('sub-plan-id').value;
    const status = document.getElementById('sub-status').value;
    const billingCycle = document.getElementById('sub-billing-cycle').value;
    const trialEnd = document.getElementById('sub-trial-end').value;
    const periodStart = document.getElementById('sub-period-start').value;
    const periodEnd = document.getElementById('sub-period-end').value;
    const userCount = parseInt(document.getElementById('sub-user-count').value) || 0;
    const clientCount = parseInt(document.getElementById('sub-client-count').value) || 0;

    // Get pricing model from selected plan
    const select = document.getElementById('sub-plan-id');
    const selectedOption = select.options[select.selectedIndex];
    const pricingModel = selectedOption?.dataset?.pricingModel || 'per_technician';

    if (!planId) {
      alert('Please select a plan');
      return;
    }

    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/tenants/${tenantId}/subscription`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          plan_id: parseInt(planId),
          status,
          billing_cycle: billingCycle,
          pricing_model: pricingModel,
          trial_end: trialEnd || null,
          current_period_start: periodStart || null,
          current_period_end: periodEnd || null,
          user_count: userCount,
          client_count: clientCount
        })
      });

      const data = await response.json();
      if (data.success) {
        alert('Subscription updated successfully!');
        hideTenantSubscriptionModal();
        loadTenants();
      } else {
        alert('Error: ' + data.message);
      }
    } catch (error) {
      console.error('Error saving subscription:', error);
      alert('Error saving subscription');
    }
  }

  async function cancelTenantSubscription() {
    if (!confirm('Are you sure you want to cancel this subscription?')) return;

    const tenantId = document.getElementById('sub-tenant-id').value;

    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/tenants/${tenantId}/subscription`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });

      const data = await response.json();
      if (data.success) {
        alert('Subscription cancelled');
        hideTenantSubscriptionModal();
        loadTenants();
      } else {
        alert('Error: ' + data.message);
      }
    } catch (error) {
      console.error('Error cancelling subscription:', error);
      alert('Error cancelling subscription');
    }
  }

  async function loadSystemOverview() {
    try {
      // Cache-bust to ensure fresh data from master DB
      const url = window.location.protocol + '//' + window.location.host + '/api/master/overview?t=' + Date.now();
      const response = await fetch(url, {
        cache: 'no-store',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();

      if (data.success && data.overview) {
        const { counts, recent_activity } = data.overview;

        // Update stats
        document.getElementById('sys-total-tenants').textContent = counts.total_tenants || 0;
        document.getElementById('sys-active-tenants').textContent = counts.active_tenants || 0;
        document.getElementById('sys-master-users').textContent = counts.master_users || 0;
        document.getElementById('sys-audit-logs').textContent = counts.audit_logs || 0;

        // Update recent activity table
        const tbody = document.getElementById('system-activity-body');
        if (tbody && recent_activity && recent_activity.length > 0) {
          tbody.innerHTML = '';
          recent_activity.forEach(activity => {
            const tr = document.createElement('tr');
            const time = new Date(activity.created_at).toLocaleString();
            let details = '';
            try {
              const parsed = JSON.parse(activity.details);
              details = parsed.message || JSON.stringify(parsed);
            } catch (e) {
              details = activity.details || '';
            }
            tr.innerHTML = `
              <td><span class="badge">${activity.action || 'N/A'}</span></td>
              <td>${activity.user_username || 'System'}</td>
              <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis">${details}</td>
              <td>${activity.ip_address || 'N/A'}</td>
              <td>${time}</td>
            `;
            tbody.appendChild(tr);
          });
        } else if (tbody) {
          tbody.innerHTML = '<tr><td colspan="5" class="subtitle">No recent activity</td></tr>';
        }
      }
    } catch (error) {
      console.error('Error loading system overview:', error);
    }
  }
  

  // =============================================
  // Audit Log Functions
  // =============================================
  let auditCurrentPage = 1;
  const auditPageSize = 25;
  let auditFilterTimeout = null;

  async function loadAuditLog(page = 1) {
    auditCurrentPage = page;
    const loading = document.getElementById('audit-loading');
    const table = document.getElementById('audit-table');
    const empty = document.getElementById('audit-empty');
    const pagination = document.getElementById('audit-pagination');

    loading.style.display = 'block';
    table.style.display = 'none';
    empty.style.display = 'none';
    pagination.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const params = new URLSearchParams({
        limit: auditPageSize,
        offset: (page - 1) * auditPageSize
      });

      const action = document.getElementById('audit-filter-action').value;
      const user = document.getElementById('audit-filter-user').value.trim();
      const dateFrom = document.getElementById('audit-filter-from').value;
      const dateTo = document.getElementById('audit-filter-to').value;

      if (action) params.append('action', action);
      if (user) params.append('user', user);
      if (dateFrom) params.append('dateFrom', dateFrom);
      if (dateTo) params.append('dateTo', dateTo);

      const response = await fetch(`${API_BASE}/api/admin/audit-log?${params}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        renderAuditLog(data.data, data.pagination);
      } else {
        console.error('Failed to load audit log:', data.error);
        empty.style.display = 'block';
      }
    } catch (error) {
      console.error('Error loading audit log:', error);
      empty.style.display = 'block';
    } finally {
      loading.style.display = 'none';
    }
  }

  function renderAuditLog(entries, pagination) {
    const table = document.getElementById('audit-table');
    const body = document.getElementById('audit-body');
    const empty = document.getElementById('audit-empty');
    const paginationEl = document.getElementById('audit-pagination');

    if (!entries || entries.length === 0) {
      empty.style.display = 'block';
      return;
    }

    body.innerHTML = entries.map(entry => `
      <tr style="border-bottom:1px solid var(--border)">
        <td style="padding:8px;font-size:13px;white-space:nowrap">${formatAuditDate(entry.created_at)}</td>
        <td style="padding:8px">${escapeHtml(entry.username || '-')}</td>
        <td style="padding:8px"><span class="badge ${getActionBadgeClass(entry.action)}">${escapeHtml(entry.action)}</span></td>
        <td style="padding:8px;font-size:13px">${escapeHtml(entry.entity_id || entry.entity_type)}</td>
        <td style="padding:8px;font-size:12px;color:var(--muted)">${formatAuditDetails(entry.details_json)}</td>
      </tr>
    `).join('');

    table.style.display = 'table';

    // Update pagination
    const totalPages = Math.ceil(pagination.total / pagination.limit);
    document.getElementById('audit-page-info').textContent = `Page ${auditCurrentPage} of ${totalPages} (${pagination.total} entries)`;
    document.getElementById('audit-prev').disabled = auditCurrentPage <= 1;
    document.getElementById('audit-next').disabled = !pagination.hasMore;
    paginationEl.style.display = totalPages > 1 ? 'block' : 'none';
  }

  function formatAuditDate(dateStr) {
    if (!dateStr) return '-';
    const d = new Date(dateStr);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function getActionBadgeClass(action) {
    if (action?.includes('DELETE')) return 'badge-red';
    if (action?.includes('UPDATE') || action?.includes('IMPORT')) return 'badge-amber';
    if (action?.includes('CREATE')) return 'badge-green';
    return 'badge-gray';
  }

  function formatAuditDetails(details) {
    if (!details) return '-';
    const parts = [];
    if (details.key) parts.push(`key: ${details.key}`);
    if (details.scope) parts.push(`scope: ${details.scope}`);
    if (details.valueChanged) parts.push('value changed');
    if (details.countReturned) parts.push(`${details.countReturned} vars`);
    if (details.countExported) parts.push(`${details.countExported} exported`);
    if (details.keysImportedCount) parts.push(`${details.keysImportedCount} keys`);
    if (details.created) parts.push(`${details.created} created`);
    if (details.updated) parts.push(`${details.updated} updated`);
    return parts.length > 0 ? parts.join(', ') : '-';
  }

  function debounceAuditFilter() {
    clearTimeout(auditFilterTimeout);
    auditFilterTimeout = setTimeout(() => loadAuditLog(), 400);
  }

  function clearAuditFilters() {
    document.getElementById('audit-filter-action').value = '';
    document.getElementById('audit-filter-user').value = '';
    document.getElementById('audit-filter-from').value = '';
    document.getElementById('audit-filter-to').value = '';
    loadAuditLog();
  }

  async function loadAuditActions() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/admin/audit-log/actions`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        const select = document.getElementById('audit-filter-action');
        select.innerHTML = '<option value="">All Actions</option>' +
          data.actions.map(a => `<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }
    } catch (e) {
      console.error('Failed to load audit actions:', e);
    }
  }

  // =============================================
  // Notifications Functions
  // =============================================
  let notifCurrentPage = 1;
  const notifPageSize = 50;
  let notifCache = []; // Cache notifications for in-memory updates
  let notifSelectedIds = new Set(); // Track selected notification IDs
  let notifSortOrder = 'desc'; // 'desc' = newest first, 'asc' = oldest first

  function toggleNotifSort() {
    notifSortOrder = notifSortOrder === 'desc' ? 'asc' : 'desc';
    const icon = document.getElementById('notif-sort-icon');
    if (icon) icon.textContent = notifSortOrder === 'desc' ? '↓' : '↑';
    loadNotifications();
  }

  function onNotifRangeChange() {
    const range = document.getElementById('notif-filter-range').value;
    const customDiv = document.getElementById('notif-custom-range');
    if (customDiv) customDiv.style.display = range === 'custom' ? 'flex' : 'none';
    if (range !== 'custom') loadNotifications();
  }

  // Load unread notification count and update badges
  async function loadNotificationBadge() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';
      const response = await fetch(`${API_BASE}/api/notifications/${tenantCode}?delivered=false&limit=1`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        const count = data.total || 0;
        const badgeAdmin = document.getElementById('notif-badge-admin');
        const badgeExpert = document.getElementById('notif-badge-expert');
        if (count > 0) {
          const text = count > 99 ? '99+' : count;
          if (badgeAdmin) { badgeAdmin.textContent = text; badgeAdmin.style.display = 'inline'; }
          if (badgeExpert) { badgeExpert.textContent = text; badgeExpert.style.display = 'inline'; }
        } else {
          if (badgeAdmin) badgeAdmin.style.display = 'none';
          if (badgeExpert) badgeExpert.style.display = 'none';
        }
      }
    } catch (e) {
      console.error('Error loading notification badge:', e);
    }
  }

  async function loadNotifications(page = 1) {
    // Reset selection on page change
    notifSelectedIds.clear();
    updateNotifBulkBar();
    notifCurrentPage = page;
    const loading = document.getElementById('notif-loading');
    const table = document.getElementById('notif-table');
    const empty = document.getElementById('notif-empty');
    const pagination = document.getElementById('notif-pagination');

    loading.style.display = 'block';
    table.style.display = 'none';
    empty.style.display = 'none';
    pagination.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';
      const params = new URLSearchParams({
        limit: notifPageSize,
        offset: (page - 1) * notifPageSize
      });

      const severity = document.getElementById('notif-filter-severity').value;
      const type = document.getElementById('notif-filter-type').value;
      const delivered = document.getElementById('notif-filter-delivered').value;
      const range = document.getElementById('notif-filter-range').value;

      if (severity) params.append('severity', severity);
      if (type) params.append('type', type);
      if (delivered) params.append('delivered', delivered);

      // Sort order
      params.append('sort', notifSortOrder);

      // Calculate date range
      if (range && range !== 'custom') {
        const now = new Date();
        let from;
        if (range === '24h') {
          from = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        } else if (range === '7d') {
          from = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        } else if (range === '30d') {
          from = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        }
        if (from) params.append('from', from.toISOString());
      } else if (range === 'custom') {
        const fromVal = document.getElementById('notif-range-from').value;
        const toVal = document.getElementById('notif-range-to').value;
        if (fromVal) params.append('from', new Date(fromVal).toISOString());
        if (toVal) params.append('to', new Date(toVal).toISOString());
      }

      const response = await fetch(`${API_BASE}/api/notifications/${tenantCode}?${params}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        renderNotifications(data.notifications, data.total, data.limit, data.offset);
      } else {
        console.error('Failed to load notifications:', data.message);
        empty.style.display = 'block';
      }
    } catch (error) {
      console.error('Error loading notifications:', error);
      empty.style.display = 'block';
    } finally {
      loading.style.display = 'none';
    }
  }

  function renderNotifications(notifications, total, limit, offset) {
    const table = document.getElementById('notif-table');
    const body = document.getElementById('notif-body');
    const empty = document.getElementById('notif-empty');
    const paginationEl = document.getElementById('notif-pagination');

    // Cache notifications for in-memory updates
    notifCache = notifications || [];

    if (!notifications || notifications.length === 0) {
      empty.style.display = 'block';
      document.getElementById('notif-select-all').checked = false;
      return;
    }

    body.innerHTML = notifications.map(n => `
      <tr id="notif-row-${n.id}" style="border-bottom:1px solid var(--border)">
        <td style="padding:8px"><input type="checkbox" class="notif-checkbox" data-id="${n.id}" onchange="toggleNotifSelection(${n.id}, this.checked)" ${notifSelectedIds.has(n.id) ? 'checked' : ''}></td>
        <td style="padding:8px;font-size:13px;white-space:nowrap">${formatNotifDate(n.created_at)}</td>
        <td style="padding:8px">${getSeverityBadge(n.severity)}</td>
        <td style="padding:8px;font-size:13px">${formatNotifType(n.type)}</td>
        <td style="padding:8px;font-size:13px">${escapeHtml(n.message)}</td>
        <td style="padding:8px"><button class="btn btn-sm ghost" onclick="openNotifTicket(${n.ticket_id})">Open #${n.ticket_id}</button></td>
        <td style="padding:8px">${getDeliveredCell(n)}</td>
        <td style="padding:8px">${getNotifActionButton(n)}</td>
      </tr>
    `).join('');

    table.style.display = 'table';
    document.getElementById('notif-select-all').checked = false;

    // Update pagination
    const totalPages = Math.ceil(total / limit);
    const startItem = offset + 1;
    const endItem = Math.min(offset + notifications.length, total);
    document.getElementById('notif-page-info').textContent = `Showing ${startItem}–${endItem} of ${total}`;
    document.getElementById('notif-prev').disabled = notifCurrentPage <= 1;
    document.getElementById('notif-next').disabled = notifCurrentPage >= totalPages;
    paginationEl.style.display = totalPages > 1 ? 'block' : 'none';
  }

  function formatNotifDate(dateStr) {
    if (!dateStr) return '-';
    const d = new Date(dateStr);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function getSeverityBadge(severity) {
    if (severity === 'critical') return '<span class="badge badge-red">Critical</span>';
    if (severity === 'warning') return '<span class="badge badge-amber">Warning</span>';
    if (severity === 'info') return '<span class="badge badge-blue">Info</span>';
    return '<span class="badge badge-gray">' + escapeHtml(severity || '-') + '</span>';
  }

  function formatNotifType(type) {
    if (!type) return '-';
    // Convert SLA_RESPONSE_NEAR to "Response Near"
    return type.replace('SLA_', '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  function clearNotifFilters() {
    document.getElementById('notif-filter-severity').value = '';
    document.getElementById('notif-filter-type').value = '';
    document.getElementById('notif-filter-delivered').value = '';
    document.getElementById('notif-filter-range').value = '';
    const customDiv = document.getElementById('notif-custom-range');
    if (customDiv) customDiv.style.display = 'none';
    const fromInput = document.getElementById('notif-range-from');
    const toInput = document.getElementById('notif-range-to');
    if (fromInput) fromInput.value = '';
    if (toInput) toInput.value = '';
    notifSortOrder = 'desc';
    const icon = document.getElementById('notif-sort-icon');
    if (icon) icon.textContent = '↓';
    loadNotifications();
  }

  function getDeliveredCell(n) {
    if (n.delivered_at) {
      const d = new Date(n.delivered_at);
      const tooltip = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      return `<span class="badge badge-green" title="${tooltip}">Delivered</span>`;
    }
    return '<span class="badge badge-gray">Pending</span>';
  }

  function getNotifActionButton(n) {
    if (n.delivered_at) {
      return `<button class="btn btn-sm ghost" disabled style="opacity:0.5">Delivered</button>`;
    }
    return `<button class="btn btn-sm primary" onclick="deliverNotification(${n.id})">Mark Delivered</button>`;
  }

  function toggleNotifSelection(id, checked) {
    if (checked) {
      notifSelectedIds.add(id);
    } else {
      notifSelectedIds.delete(id);
    }
    updateNotifBulkBar();
  }

  function toggleNotifSelectAll(checked) {
    const checkboxes = document.querySelectorAll('.notif-checkbox');
    checkboxes.forEach(cb => {
      const id = parseInt(cb.dataset.id, 10);
      cb.checked = checked;
      if (checked) {
        notifSelectedIds.add(id);
      } else {
        notifSelectedIds.delete(id);
      }
    });
    updateNotifBulkBar();
  }

  function clearNotifSelection() {
    notifSelectedIds.clear();
    document.getElementById('notif-select-all').checked = false;
    document.querySelectorAll('.notif-checkbox').forEach(cb => cb.checked = false);
    updateNotifBulkBar();
  }

  function updateNotifBulkBar() {
    const bar = document.getElementById('notif-bulk-bar');
    const count = notifSelectedIds.size;
    document.getElementById('notif-selected-count').textContent = count + ' selected';
    bar.style.display = count > 0 ? 'block' : 'none';
  }

  async function deliverNotification(id) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/notifications/${tenantCode}/${id}/deliver`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        // Update in-memory cache
        const notif = notifCache.find(n => n.id === id);
        if (notif) {
          notif.delivered_at = data.delivered_at || new Date().toISOString();
        }
        // Re-render with updated cache
        renderNotifications(notifCache, notifCache.length, notifPageSize, (notifCurrentPage - 1) * notifPageSize);
        showNotifToast('Marked delivered (1)');
      } else {
        alert('Failed to mark delivered: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error marking notification delivered:', error);
      alert('Error marking notification delivered');
    }
  }

  async function deliverSelectedNotifications() {
    const ids = Array.from(notifSelectedIds);
    if (ids.length === 0) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/notifications/${tenantCode}/deliver-bulk`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ids })
      });

      const data = await response.json();

      if (data.success) {
        const now = new Date().toISOString();
        // Update in-memory cache for all selected
        ids.forEach(id => {
          const notif = notifCache.find(n => n.id === id);
          if (notif && !notif.delivered_at) {
            notif.delivered_at = now;
          }
        });
        // Clear selection and re-render
        notifSelectedIds.clear();
        renderNotifications(notifCache, notifCache.length, notifPageSize, (notifCurrentPage - 1) * notifPageSize);
        updateNotifBulkBar();
        showNotifToast(`Marked delivered (${data.updated_count})`);
        // Refresh badge count
        loadNotificationBadge();
      } else {
        alert('Failed to mark delivered: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error marking notifications delivered:', error);
      alert('Error marking notifications delivered');
    }
  }

  function showNotifToast(message) {
    // Create toast element
    let toast = document.getElementById('notif-toast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'notif-toast';
      toast.style.cssText = 'position:fixed;bottom:24px;right:24px;background:#10b981;color:white;padding:12px 20px;border-radius:8px;font-weight:500;z-index:9999;opacity:0;transition:opacity 0.3s';
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.style.opacity = '1';
    setTimeout(() => { toast.style.opacity = '0'; }, 3000);
  }

  function openNotifTicket(ticketId) {
    // Find ticket in local cache or load it
    const ticket = tickets.find(t => t.id === ticketId);
    if (ticket) {
      currentTicketId = ticketId;
      switchView('ticket-detail');
    } else {
      // Load ticket directly by navigating to tickets view with filter
      currentTicketId = ticketId;
      switchView('ticket-detail');
    }
  }

  // Raw Variables Functions
  // =============================================
  let rawVariablesData = null;
  let currentEditingVariable = null;

  async function loadRawVariables() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`${API_BASE}/api/raw-variables/${tenantCode}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        rawVariablesData = data.variables;
        renderRawVariables();
      } else {
        console.error('Failed to load raw variables:', data.message);
      }
    } catch (error) {
      console.error('Error loading raw variables:', error);
    }
  }

  function renderRawVariables() {
    if (!rawVariablesData) return;

    const searchTerm = (document.getElementById('raw-vars-search')?.value || '').toLowerCase();

    // Render each section
    renderVariableSection('raw-vars-tenant-settings', rawVariablesData.tenant_settings, searchTerm);
    renderVariableSection('raw-vars-email-ingest', rawVariablesData.email_ingest, searchTerm);
    renderVariableSection('raw-vars-company-profile', rawVariablesData.company_profile, searchTerm);
    renderVariableSection('raw-vars-environment', rawVariablesData.environment, searchTerm);
  }

  function renderVariableSection(containerId, variables, searchTerm) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const filtered = variables.filter(v =>
      !searchTerm ||
      v.key.toLowerCase().includes(searchTerm) ||
      (v.value && v.value.toLowerCase().includes(searchTerm))
    );

    if (filtered.length === 0) {
      container.innerHTML = '<tr><td colspan="3" class="subtitle" style="text-align:center;padding:16px;color:#666">No variables found</td></tr>';
      return;
    }

    container.innerHTML = filtered.map(v => {
      const displayValue = v.sensitive ? '••••••••' : (v.value || '<em style="color:#999">empty</em>');
      const valueStyle = v.value ? '' : 'color:#999';

      let actions = '';
      if (v.editable) {
        actions += `<button class="btn ghost" style="padding:4px 8px;font-size:12px" onclick="editVariable('${v.key}', '${v.category}')">Edit</button>`;
      }
      if (v.deletable) {
        actions += `<button class="btn ghost" style="padding:4px 8px;font-size:12px;color:#b91c1c;margin-left:4px" onclick="deleteVariable('${v.key}')">Delete</button>`;
      }
      if (!v.editable && !v.deletable) {
        actions = '<span class="subtitle" style="color:#666;font-size:12px">Read-only</span>';
      }

      return `
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:8px;font-family:monospace;font-size:13px">${v.key}</td>
          <td style="padding:8px;font-family:monospace;font-size:13px;${valueStyle}">${displayValue}</td>
          <td style="padding:8px;text-align:right">${actions}</td>
        </tr>
      `;
    }).join('');
  }

  function filterRawVariables() {
    renderRawVariables();
  }

  function editVariable(key, category) {
    // Find the variable
    let variable = null;
    if (rawVariablesData) {
      const allVars = [
        ...rawVariablesData.tenant_settings,
        ...rawVariablesData.email_ingest,
        ...rawVariablesData.company_profile,
        ...rawVariablesData.environment
      ];
      variable = allVars.find(v => v.key === key);
    }

    if (!variable) {
      alert('Variable not found');
      return;
    }

    currentEditingVariable = variable;
    document.getElementById('var-edit-key').value = key;
    document.getElementById('var-edit-value').value = variable.sensitive ? '' : (variable.value || '');

    // Show warning for system variables
    const warningEl = document.getElementById('var-edit-warning');
    if (key.startsWith('email_ingest.') || key.startsWith('company.')) {
      warningEl.textContent = 'This is a system variable. Changes may affect application behavior.';
      warningEl.style.display = 'block';
    } else {
      warningEl.style.display = 'none';
    }

    document.getElementById('variable-edit-modal').style.display = 'flex';
  }

  function closeVariableModal() {
    document.getElementById('variable-edit-modal').style.display = 'none';
    currentEditingVariable = null;
  }

  function saveVariableEdit() {
    if (!currentEditingVariable) return;
    ensureReauthThen(doSaveVariableEdit);
  }

  async function doSaveVariableEdit() {
    const key = document.getElementById('var-edit-key').value;
    const value = document.getElementById('var-edit-value').value;
    const token = localStorage.getItem('token');
    const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

    try {
      const response = await fetch(`${API_BASE}/api/raw-variables/${tenantCode}/${encodeURIComponent(key)}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ value })
      });

      const data = await response.json();

      if (data.success) {
        closeVariableModal();
        await loadRawVariables();
        alert('Variable updated successfully');
      } else {
        alert('Failed to update variable: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error saving variable:', error);
      alert('Error saving variable');
    }
  }

  function addVariable() {
    document.getElementById('var-add-key').value = '';
    document.getElementById('var-add-value').value = '';
    document.getElementById('var-add-error').style.display = 'none';
    document.getElementById('variable-add-modal').style.display = 'flex';
  }

  function closeAddVariableModal() {
    document.getElementById('variable-add-modal').style.display = 'none';
  }

  function saveNewVariable() {
    const key = document.getElementById('var-add-key').value.trim();
    const value = document.getElementById('var-add-value').value;
    const errorEl = document.getElementById('var-add-error');

    // Validate key before reauth
    if (!key) {
      errorEl.textContent = 'Key is required';
      errorEl.style.display = 'block';
      return;
    }

    if (!/^[a-zA-Z][a-zA-Z0-9_\.]*$/.test(key)) {
      errorEl.textContent = 'Key must start with a letter and contain only letters, numbers, underscores, and dots';
      errorEl.style.display = 'block';
      return;
    }

    if (key.startsWith('email_ingest.') || key.startsWith('company.')) {
      errorEl.textContent = 'Cannot create variables in reserved categories (email_ingest, company)';
      errorEl.style.display = 'block';
      return;
    }

    ensureReauthThen(() => doSaveNewVariable(key, value));
  }

  async function doSaveNewVariable(key, value) {
    const errorEl = document.getElementById('var-add-error');
    const token = localStorage.getItem('token');
    const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

    try {
      const response = await fetch(`${API_BASE}/api/raw-variables/${tenantCode}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ key, value })
      });

      const data = await response.json();

      if (data.success) {
        closeAddVariableModal();
        await loadRawVariables();
        alert('Variable created successfully');
      } else {
        errorEl.textContent = data.message || 'Failed to create variable';
        errorEl.style.display = 'block';
      }
    } catch (error) {
      console.error('Error creating variable:', error);
      errorEl.textContent = 'Error creating variable';
      errorEl.style.display = 'block';
    }
  }

  function deleteVariable(key) {
    if (!confirm(`Delete variable "${key}"? This cannot be undone.`)) return;
    ensureReauthThen(() => doDeleteVariable(key));
  }

  async function doDeleteVariable(key) {
    const token = localStorage.getItem('token');
    const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

    try {
      const response = await fetch(`${API_BASE}/api/raw-variables/${tenantCode}/${encodeURIComponent(key)}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        await loadRawVariables();
        alert('Variable deleted');
      } else {
        alert('Failed to delete variable: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error deleting variable:', error);
      alert('Error deleting variable');
    }
  }

  function exportVariablesJSON() {
    if (!rawVariablesData) {
      alert('No variables loaded');
      return;
    }

    // Flatten all variables into a single object
    const exportData = {};

    rawVariablesData.tenant_settings.forEach(v => {
      exportData[v.key] = v.value;
    });
    rawVariablesData.email_ingest.forEach(v => {
      if (!v.sensitive) exportData[v.key] = v.value;
    });
    rawVariablesData.company_profile.forEach(v => {
      exportData[v.key] = v.value;
    });
    // Environment variables are read-only, exclude from export

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `variables-${localStorage.getItem('tenantCode') || 'apoyar'}-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function showImportModal() {
    document.getElementById('json-import-content').value = '';
    document.getElementById('json-import-error').style.display = 'none';
    document.getElementById('json-import-modal').style.display = 'flex';
  }

  function closeImportModal() {
    document.getElementById('json-import-modal').style.display = 'none';
  }

  function importVariablesFromJSON() {
    const content = document.getElementById('json-import-content').value.trim();
    const errorEl = document.getElementById('json-import-error');

    // Validate before reauth
    if (!content) {
      errorEl.textContent = 'Please paste JSON content';
      errorEl.style.display = 'block';
      return;
    }

    let variables;
    try {
      variables = JSON.parse(content);
    } catch (e) {
      errorEl.textContent = 'Invalid JSON format: ' + e.message;
      errorEl.style.display = 'block';
      return;
    }

    if (typeof variables !== 'object' || Array.isArray(variables)) {
      errorEl.textContent = 'JSON must be an object with key-value pairs';
      errorEl.style.display = 'block';
      return;
    }

    ensureReauthThen(() => doImportVariablesFromJSON(variables));
  }

  async function doImportVariablesFromJSON(variables) {
    const errorEl = document.getElementById('json-import-error');
    const token = localStorage.getItem('token');
    const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

    try {
      const response = await fetch(`${API_BASE}/api/raw-variables/${tenantCode}/bulk`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ variables })
      });

      const data = await response.json();

      if (data.success) {
        closeImportModal();
        await loadRawVariables();
        alert(`Import complete: ${data.results.updated} updated, ${data.results.created} created`);
      } else {
        errorEl.textContent = data.message || 'Import failed';
        errorEl.style.display = 'block';
      }
    } catch (error) {
      console.error('Error importing variables:', error);
      errorEl.textContent = 'Error importing variables';
      errorEl.style.display = 'block';
    }
  }

  // Wizard Navigation - panel switching
  function showWizardSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.wizard-section').forEach(s => s.style.display = 'none');
    // Show selected section
    const section = document.getElementById(sectionId);
    if (section) section.style.display = 'block';
    // Update active state on left nav subitems
    document.querySelectorAll('#nav-admin-settings-group .nav-subitem').forEach(item => {
      item.classList.toggle('active', item.dataset.section === sectionId);
    });
    // Persist selection
    localStorage.setItem('wizardSection', sectionId);
    // Load section-specific data
    if (sectionId === 'admin-section-billing') loadBillingData();
    if (sectionId === 'admin-section-support') {
      loadSupportSettings();
      loadBatchProcessingSettings();
    }
    if (sectionId === 'admin-section-cmdb-fields') loadCustomFieldDefinitions();
    if (sectionId === 'admin-section-sla') loadSLAData();
    if (sectionId === 'admin-section-housekeeping') loadHousekeepingInfo();
    if (sectionId === 'admin-section-chat') loadCannedResponsesAdmin();
    if (sectionId === 'admin-section-reports') loadReportSection();
  }

  function initWizardSection() {
    const saved = localStorage.getItem('wizardSection') || 'admin-section-profile';
    showWizardSection(saved);
  }

  // CMDB Hub Functions
  let cmdbHubInitialized = false;

  // Collapsible Nav Group Functions
  function toggleNavGroup(groupId) {
    const group = document.getElementById(groupId);
    if (!group) return;
    const isOpen = group.classList.contains('open');
    group.classList.toggle('open', !isOpen);
    try { localStorage.setItem(`serviflow.nav.${groupId}.open`, isOpen ? '0' : '1'); } catch(e) {}
  }

  function initNavGroups() {
    // Section groups (Operations defaults open, others respect localStorage)
    const sectionGroups = ['nav-section-operations', 'nav-section-insights', 'nav-section-config'];
    sectionGroups.forEach(id => {
      let saved = null;
      try { saved = localStorage.getItem(`serviflow.nav.${id}.open`); } catch(e) {}
      const defaultOpen = (id === 'nav-section-operations') ? '1' : '0';
      const isOpen = (saved !== null) ? saved === '1' : defaultOpen === '1';
      const el = document.getElementById(id);
      if (el) el.classList.toggle('open', isOpen);
    });
    // CMDB groups
    let cmdbOpen = '0';
    try { cmdbOpen = localStorage.getItem('serviflow.nav.nav-cmdb-group.open') || '0'; } catch(e) {}
    ['nav-cmdb-group', 'nav-cmdb-group-expert', 'nav-cmdb-group-customer'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('open', cmdbOpen === '1');
    });
    // Admin Settings group
    let adminOpen = '0';
    try { adminOpen = localStorage.getItem('serviflow.nav.nav-admin-settings-group.open') || '0'; } catch(e) {}
    const adminGroup = document.getElementById('nav-admin-settings-group');
    if (adminGroup) adminGroup.classList.toggle('open', adminOpen === '1');
    // System Admin Tools group (only opened via elevation, never auto-open)
    const sysGroup = document.getElementById('nav-system-tools-group');
    if (sysGroup) sysGroup.classList.remove('open');
  }

  // --- System Admin Elevation ---
  let pendingReauthCallback = null;

  function isElevated() {
    const token = localStorage.getItem('token');
    if (!token) return false;
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.is_elevated_admin === true && payload.exp * 1000 > Date.now();
    } catch { return false; }
  }

  function updateElevationBadge() {
    const badge = document.getElementById('elevation-badge');
    if (badge) badge.style.display = isElevated() ? 'flex' : 'none';
  }

  // Check elevation badge periodically (every 30s)
  setInterval(updateElevationBadge, 30000);

  function openSystemAdminTools() {
    if (isElevated()) {
      toggleNavGroup('nav-system-tools-group');
    } else {
      pendingReauthCallback = () => {
        const grp = document.getElementById('nav-system-tools-group');
        if (grp && !grp.classList.contains('open')) grp.classList.add('open');
      };
      showElevationModal();
    }
  }

  function ensureReauthThen(cb) {
    if (isElevated()) {
      cb();
    } else {
      pendingReauthCallback = cb;
      showElevationModal();
    }
  }

  function showElevationModal() {
    const modal = document.getElementById('reauth-modal');
    if (modal) {
      modal.style.display = 'flex';
      modal.scrollTop = 0;
    }
    const pwd = document.getElementById('reauth-password');
    if (pwd) { pwd.value = ''; pwd.focus(); }
    const err = document.getElementById('reauth-error');
    if (err) err.style.display = 'none';
  }

  function closeReauthModal() {
    const modal = document.getElementById('reauth-modal');
    if (modal) modal.style.display = 'none';
    pendingReauthCallback = null;
  }

  async function submitReauth() {
    const password = document.getElementById('reauth-password').value;
    const errEl = document.getElementById('reauth-error');
    if (!password) {
      errEl.textContent = 'Please enter your password';
      errEl.style.display = 'block';
      return;
    }
    try {
      const tenantCode = window.tenant || 'apoyar';
      const token = localStorage.getItem('token_base') || localStorage.getItem('token');
      const res = await fetch(`/api/auth/${tenantCode}/reauth`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ password })
      });
      const data = await res.json();
      if (data.success) {
        sessionStorage.setItem('serviflow.reauthUntil', data.reauth_until);
        if (data.elevated_token) {
          const currentToken = localStorage.getItem('token');
          if (!localStorage.getItem('token_base')) {
            localStorage.setItem('token_base', currentToken);
          }
          localStorage.setItem('token', data.elevated_token);
        }
        updateElevationBadge();
        closeReauthModal();
        const cb = pendingReauthCallback;
        pendingReauthCallback = null;
        if (cb) cb();
      } else {
        errEl.textContent = data.error || 'Invalid password';
        errEl.style.display = 'block';
      }
    } catch(e) {
      errEl.textContent = 'Network error. Please try again.';
      errEl.style.display = 'block';
    }
  }

  function openCmdb(sectionId) {
    // Asset Viewer requires elevated password and is tenant-specific
    if (sectionId === 'cmdb-section-assetviewer') {
      if (!isAssetViewerAvailable()) return;
      if (!sessionStorage.getItem('serviflow.avAuth')) {
        showAvPasswordModal();
        return;
      }
    }
    // Switch to CMDB hub view
    switchView('cmdb-hub');
    // Show requested section
    showCmdbSection(sectionId);
    // Ensure nav group is expanded
    const groups = ['nav-cmdb-group', 'nav-cmdb-group-expert', 'nav-cmdb-group-customer'];
    groups.forEach(id => {
      const el = document.getElementById(id);
      if (el && !el.classList.contains('open')) el.classList.add('open');
    });
    try { localStorage.setItem('serviflow.nav.nav-cmdb-group.open', '1'); } catch(e) {}
    // Update active state on subitems
    document.querySelectorAll('.nav-subitem').forEach(item => {
      item.classList.toggle('active', item.dataset.section === sectionId);
    });
    // Clear active state from regular navlinks
    document.querySelectorAll('.navlink').forEach(n => n.classList.remove('active'));
  }

  // Asset Viewer: tenant-specific feature (apoyar only, not on demo)
  function isAssetViewerAvailable() {
    const h = window.location.hostname;
    if (h.includes('demo.serviflow') || h.includes('web-demo')) return false;
    const tc = (localStorage.getItem('tenantCode') || '').toLowerCase();
    return tc === 'apoyar';
  }

  function updateAssetViewerNav() {
    const show = isAssetViewerAvailable();
    document.querySelectorAll('.av-nav-item').forEach(el => {
      el.style.display = show ? '' : 'none';
    });
  }

  function showAvPasswordModal() {
    const modal = document.getElementById('av-password-modal');
    if (modal) { modal.style.display = 'flex'; }
    const input = document.getElementById('av-password-input');
    if (input) { input.value = ''; input.focus(); }
    const err = document.getElementById('av-password-error');
    if (err) err.style.display = 'none';
  }

  function closeAvPasswordModal() {
    const modal = document.getElementById('av-password-modal');
    if (modal) modal.style.display = 'none';
  }

  function submitAvPassword() {
    const input = document.getElementById('av-password-input');
    const err = document.getElementById('av-password-error');
    const pw = input ? input.value : '';
    if (pw === 'S3rv1Fl0w') {
      sessionStorage.setItem('serviflow.avAuth', '1');
      closeAvPasswordModal();
      openCmdb('cmdb-section-assetviewer');
    } else {
      if (err) { err.textContent = 'Invalid access password'; err.style.display = 'block'; }
      if (input) input.value = '';
    }
  }

  function openAdminSettings(sectionId) {
    // Switch to wizard view
    switchView('wizard');
    // Show requested section
    showWizardSection(sectionId);
    // Ensure nav group is expanded
    const group = document.getElementById('nav-admin-settings-group');
    if (group && !group.classList.contains('open')) group.classList.add('open');
    try { localStorage.setItem('serviflow.nav.nav-admin-settings-group.open', '1'); } catch(e) {}
    // Update active state on subitems
    document.querySelectorAll('#nav-admin-settings-group .nav-subitem').forEach(item => {
      item.classList.toggle('active', item.dataset.section === sectionId);
    });
    // Clear active state from regular navlinks
    document.querySelectorAll('.navlink').forEach(n => n.classList.remove('active'));
  }

  function showCmdbSection(sectionId) {
    document.querySelectorAll('.cmdb-section').forEach(s => s.style.display = 'none');
    const section = document.getElementById(sectionId);
    if (section) section.style.display = 'block';
    // Update active state on left nav subitems
    document.querySelectorAll('.nav-subitem').forEach(item => {
      item.classList.toggle('active', item.dataset.section === sectionId);
    });
    try { localStorage.setItem('serviflow.cmdb.section', sectionId); } catch(e) {}

    // Load data for the selected section
    if (sectionId === 'cmdb-section-items') { loadFilterSettings('cmdb'); renderCMDB(); }
    if (sectionId === 'cmdb-section-types') loadManageCMDB();
    if (sectionId === 'cmdb-section-management') loadCMDBMgmt();
    if (sectionId === 'cmdb-section-assetviewer') initAssetViewer();
  }

  function initCmdbHub() {
    // Move content from original views into hub sections (only once)
    if (!cmdbHubInitialized) {
      const itemsContent = document.getElementById('view-cmdb');
      const typesContent = document.getElementById('view-manage-cmdb');
      const mgmtContent = document.getElementById('view-cmdb-mgmt');

      if (itemsContent) {
        const itemsSection = document.getElementById('cmdb-section-items');
        while (itemsContent.firstChild) itemsSection.appendChild(itemsContent.firstChild);
      }
      if (typesContent) {
        const typesSection = document.getElementById('cmdb-section-types');
        while (typesContent.firstChild) typesSection.appendChild(typesContent.firstChild);
      }
      if (mgmtContent) {
        const mgmtSection = document.getElementById('cmdb-section-management');
        while (mgmtContent.firstChild) mgmtSection.appendChild(mgmtContent.firstChild);
      }
      cmdbHubInitialized = true;
    }

    // Show saved or default section
    let saved = null;
    try { saved = localStorage.getItem('serviflow.cmdb.section'); } catch(e) {}
    const defaultSection = 'cmdb-section-items';
    const target = (saved && document.getElementById(saved)) ? saved : defaultSection;
    showCmdbSection(target);
  }

  // Company Profile Functions
  async function loadCompanyProfile() {
    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/profile/${tenantCode}/profile`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      // Check for errors before parsing
      if (response.status === 403) {
        const userRole = window.currentUser?.role || 'unknown';
        console.warn(`Permission denied loading company profile. User role: ${userRole}`);
        return; // Silently fail on load - user won't see the section anyway with role-based hiding
      }

      if (response.status === 401) {
        console.warn('Authentication required to load company profile');
        return; // Silently fail on load
      }

      if (!response.ok) {
        console.error(`HTTP ${response.status} error loading company profile`);
        return; // Silently fail on load
      }

      const data = await response.json();

      if (data.success && data.profile) {
        document.getElementById('profile-company-name').value = data.profile.company_name || '';
        document.getElementById('profile-contact-phone').value = data.profile.contact_phone || '';
        document.getElementById('profile-mail-from').value = data.profile.mail_from_email || '';
        document.getElementById('profile-company-url').value = data.profile.company_url_domain || '';
      }
    } catch (error) {
      console.error('Error loading company profile:', error);
      // Silently fail on load errors - non-admins shouldn't see error messages
    }
  }

  async function saveCompanyProfile() {
    const companyName = document.getElementById('profile-company-name').value;
    const contactPhone = document.getElementById('profile-contact-phone').value;
    const mailFrom = document.getElementById('profile-mail-from').value;
    const companyUrl = document.getElementById('profile-company-url').value;

    // Basic validation
    if (mailFrom && !isValidEmail(mailFrom)) {
      showProfileError('Please enter a valid email address');
      return;
    }

    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/profile/${tenantCode}/profile`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          company_name: companyName,
          contact_phone: contactPhone,
          mail_from_email: mailFrom,
          company_url_domain: companyUrl
        })
      });

      const data = await response.json();

      // Check for permission errors
      if (response.status === 403) {
        const userRole = window.currentUser?.role || 'unknown';
        showProfileError(`⚠️ Admin access required. Your current role: "${userRole}". Please log in as an admin user.`);
        return;
      }

      if (response.status === 401) {
        showProfileError('⚠️ Authentication required. Please log in again.');
        return;
      }

      if (!response.ok) {
        showProfileError(`Error (HTTP ${response.status}): ${data.message || 'Error saving profile'}`);
        return;
      }

      if (data.success) {
        showProfileMessage('✅ Company profile saved successfully!');
        setTimeout(() => hideProfileMessages(), 3000);
      } else {
        showProfileError(data.message || 'Error saving company profile');
      }
    } catch (error) {
      console.error('Error saving company profile:', error);
      showProfileError('Error saving company profile');
    }
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function showProfileMessage(message) {
    const messageEl = document.getElementById('profile-message');
    const errorEl = document.getElementById('profile-error');
    errorEl.style.display = 'none';
    messageEl.textContent = message;
    messageEl.style.display = 'block';
  }

  function showProfileError(message) {
    const messageEl = document.getElementById('profile-message');
    const errorEl = document.getElementById('profile-error');
    messageEl.style.display = 'none';
    errorEl.textContent = message;
    errorEl.style.display = 'block';
  }

  function hideProfileMessages() {
    document.getElementById('profile-message').style.display = 'none';
    document.getElementById('profile-error').style.display = 'none';
  }

  // =====================================================
  // Teams Integration Functions
  // =====================================================

  async function loadTeamsIntegrationStatus() {
    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/teams/status`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      if (!response.ok) {
        console.log('Teams integration status check failed or not available');
        return;
      }

      const data = await response.json();

      if (data.connected) {
        // Show connected state
        document.getElementById('teams-not-connected').style.display = 'none';
        document.getElementById('teams-connected').style.display = 'block';
        document.getElementById('teams-disconnected-badge').style.display = 'none';
        document.getElementById('teams-connected-badge').style.display = 'inline';
        document.getElementById('teams-requirements').style.display = 'none';

        document.getElementById('teams-tenant-name').textContent = data.teams_tenant_name || 'Unknown';
        document.getElementById('teams-connected-date').textContent = data.connected_at
          ? new Date(data.connected_at).toLocaleDateString()
          : '-';

        // Show email domains
        renderTeamsEmailDomains(data.email_domains || []);
      } else {
        // Show not connected state
        document.getElementById('teams-not-connected').style.display = 'block';
        document.getElementById('teams-connected').style.display = 'none';
        document.getElementById('teams-disconnected-badge').style.display = 'inline';
        document.getElementById('teams-connected-badge').style.display = 'none';
        document.getElementById('teams-requirements').style.display = 'block';
      }
    } catch (error) {
      console.error('Error loading Teams integration status:', error);
    }
  }

  function renderTeamsEmailDomains(domains) {
    const container = document.getElementById('teams-email-domains');
    if (domains.length === 0) {
      container.innerHTML = '<span class="subtitle" style="color:#666">No additional domains configured</span>';
      return;
    }

    container.innerHTML = domains.map(domain => `
      <span class="badge" style="background:#e0e7ff;color:#3730a3;margin-right:8px;margin-bottom:4px">
        ${domain}
        <button onclick="removeTeamsDomain('${domain}')" style="background:none;border:none;cursor:pointer;margin-left:4px;color:#6366f1">&times;</button>
      </span>
    `).join('');
  }

  async function connectTeams() {
    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/teams/connect`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      const data = await response.json();

      if (data.auth_url) {
        // Redirect to Microsoft OAuth
        window.location.href = data.auth_url;
      } else {
        showTeamsError(data.error || 'Failed to initiate connection');
      }
    } catch (error) {
      console.error('Error connecting to Teams:', error);
      showTeamsError('Failed to connect to Microsoft Teams');
    }
  }

  async function disconnectTeams() {
    if (!confirm('Are you sure you want to disconnect Microsoft Teams integration?')) {
      return;
    }

    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/teams/disconnect`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      const data = await response.json();

      if (data.success) {
        showTeamsMessage('Teams integration disconnected');
        loadTeamsIntegrationStatus();
      } else {
        showTeamsError(data.error || 'Failed to disconnect');
      }
    } catch (error) {
      console.error('Error disconnecting Teams:', error);
      showTeamsError('Failed to disconnect');
    }
  }

  async function addTeamsDomain() {
    const input = document.getElementById('teams-new-domain');
    const domain = input.value.trim().toLowerCase().replace('@', '');

    if (!domain) {
      showTeamsError('Please enter a domain');
      return;
    }

    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/teams/email-domain`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email_domain: domain })
      });

      const data = await response.json();

      if (data.success) {
        input.value = '';
        showTeamsMessage(`Domain "${domain}" added`);
        loadTeamsIntegrationStatus();
      } else {
        showTeamsError(data.error || 'Failed to add domain');
      }
    } catch (error) {
      console.error('Error adding domain:', error);
      showTeamsError('Failed to add domain');
    }
  }

  async function removeTeamsDomain(domain) {
    if (!confirm(`Remove domain "${domain}"?`)) return;

    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/teams/email-domain/${domain}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      const data = await response.json();

      if (data.success) {
        showTeamsMessage(`Domain "${domain}" removed`);
        loadTeamsIntegrationStatus();
      } else {
        showTeamsError(data.error || 'Failed to remove domain');
      }
    } catch (error) {
      console.error('Error removing domain:', error);
      showTeamsError('Failed to remove domain');
    }
  }

  function downloadTeamsManifest() {
    // Download the manifest.zip from the teams-connector or static files
    window.open('/teams-manifest.zip', '_blank');
    showTeamsMessage('Downloading Teams app package...');
  }

  function showTeamsMessage(message) {
    const msgEl = document.getElementById('teams-message');
    const errEl = document.getElementById('teams-error');
    errEl.style.display = 'none';
    msgEl.textContent = message;
    msgEl.style.display = 'block';
    setTimeout(() => { msgEl.style.display = 'none'; }, 4000);
  }

  function showTeamsError(message) {
    const msgEl = document.getElementById('teams-message');
    const errEl = document.getElementById('teams-error');
    msgEl.style.display = 'none';
    errEl.textContent = message;
    errEl.style.display = 'block';
    setTimeout(() => { errEl.style.display = 'none'; }, 5000);
  }

  // Check for Teams OAuth callback parameters on page load
  function checkTeamsOAuthCallback() {
    const params = new URLSearchParams(window.location.search);

    if (params.get('teams_connected') === 'true') {
      const tenantName = params.get('teams_tenant') || 'your organization';
      showTeamsMessage(`Successfully connected to ${decodeURIComponent(tenantName)}!`);
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
      // Navigate to wizard and refresh status
      switchView('wizard');
      loadTeamsIntegrationStatus();
    }

    if (params.get('teams_error')) {
      const error = decodeURIComponent(params.get('teams_error'));
      showTeamsError(`Connection failed: ${error}`);
      window.history.replaceState({}, document.title, window.location.pathname);
      switchView('wizard');
    }
  }

  // =====================================================
  // Slack Integration Functions
  // =====================================================

  async function loadSlackIntegrationStatus() {
    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/slack/status`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      if (!response.ok) {
        console.log('Slack integration status check failed or not available');
        return;
      }

      const data = await response.json();

      if (data.connected) {
        // Show connected state
        document.getElementById('slack-not-connected').style.display = 'none';
        document.getElementById('slack-connected').style.display = 'block';
        document.getElementById('slack-disconnected-badge').style.display = 'none';
        document.getElementById('slack-connected-badge').style.display = 'inline';

        document.getElementById('slack-workspace-name').textContent = data.slack_workspace_name || 'Unknown';
        document.getElementById('slack-connected-date').textContent = data.connected_at
          ? new Date(data.connected_at).toLocaleDateString()
          : '-';

        // Show email domains
        renderSlackEmailDomains(data.email_domains || []);
      } else {
        // Show not connected state
        document.getElementById('slack-not-connected').style.display = 'block';
        document.getElementById('slack-connected').style.display = 'none';
        document.getElementById('slack-disconnected-badge').style.display = 'inline';
        document.getElementById('slack-connected-badge').style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading Slack integration status:', error);
    }
  }

  function renderSlackEmailDomains(domains) {
    const container = document.getElementById('slack-email-domains');
    if (domains.length === 0) {
      container.innerHTML = '<span class="subtitle" style="color:#666">No additional domains configured</span>';
      return;
    }

    container.innerHTML = domains.map(domain => `
      <span class="badge" style="background:#f3e8ff;color:#7c3aed;margin-right:8px;margin-bottom:4px">
        ${domain}
        <button onclick="removeSlackDomain('${domain}')" style="background:none;border:none;cursor:pointer;margin-left:4px;color:#8b5cf6">&times;</button>
      </span>
    `).join('');
  }

  async function connectSlack() {
    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/slack/connect`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      const data = await response.json();

      if (data.auth_url) {
        // Redirect to Slack OAuth
        window.location.href = data.auth_url;
      } else {
        showSlackError(data.error || 'Failed to initiate connection');
      }
    } catch (error) {
      console.error('Error connecting to Slack:', error);
      showSlackError('Failed to connect to Slack');
    }
  }

  async function disconnectSlack() {
    if (!confirm('Are you sure you want to disconnect Slack integration?')) {
      return;
    }

    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/slack/disconnect`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      const data = await response.json();

      if (data.success) {
        showSlackMessage('Slack integration disconnected');
        loadSlackIntegrationStatus();
      } else {
        showSlackError(data.error || 'Failed to disconnect');
      }
    } catch (error) {
      console.error('Error disconnecting Slack:', error);
      showSlackError('Failed to disconnect');
    }
  }

  async function addSlackDomain() {
    const input = document.getElementById('slack-new-domain');
    const domain = input.value.trim().toLowerCase().replace('@', '');

    if (!domain) {
      showSlackError('Please enter a domain');
      return;
    }

    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/slack/email-domain`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email_domain: domain })
      });

      const data = await response.json();

      if (data.success) {
        input.value = '';
        showSlackMessage(`Domain "${domain}" added`);
        loadSlackIntegrationStatus();
      } else {
        showSlackError(data.error || 'Failed to add domain');
      }
    } catch (error) {
      console.error('Error adding domain:', error);
      showSlackError('Failed to add domain');
    }
  }

  async function removeSlackDomain(domain) {
    if (!confirm(`Remove domain "${domain}"?`)) return;

    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/slack/email-domain/${domain}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      const data = await response.json();

      if (data.success) {
        showSlackMessage(`Domain "${domain}" removed`);
        loadSlackIntegrationStatus();
      } else {
        showSlackError(data.error || 'Failed to remove domain');
      }
    } catch (error) {
      console.error('Error removing domain:', error);
      showSlackError('Failed to remove domain');
    }
  }

  function showSlackMessage(message) {
    const msgEl = document.getElementById('slack-message');
    const errEl = document.getElementById('slack-error');
    errEl.style.display = 'none';
    msgEl.textContent = message;
    msgEl.style.display = 'block';
    setTimeout(() => { msgEl.style.display = 'none'; }, 4000);
  }

  function showSlackError(message) {
    const msgEl = document.getElementById('slack-message');
    const errEl = document.getElementById('slack-error');
    msgEl.style.display = 'none';
    errEl.textContent = message;
    errEl.style.display = 'block';
    setTimeout(() => { errEl.style.display = 'none'; }, 5000);
  }

  // Check for Slack OAuth callback parameters on page load
  function checkSlackOAuthCallback() {
    const params = new URLSearchParams(window.location.search);

    if (params.get('slack_connected') === 'true') {
      const workspaceName = params.get('slack_workspace') || 'your workspace';
      showSlackMessage(`Successfully connected to ${decodeURIComponent(workspaceName)}!`);
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
      // Navigate to wizard and refresh status
      switchView('wizard');
      loadSlackIntegrationStatus();
    }

    if (params.get('slack_error')) {
      const error = decodeURIComponent(params.get('slack_error'));
      showSlackError(`Connection failed: ${error}`);
      window.history.replaceState({}, document.title, window.location.pathname);
      switchView('wizard');
    }
  }

  // =====================================================
  // SMS Integration Functions
  // =====================================================

  async function loadSmsIntegrationStatus() {
    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/sms/status`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      if (!response.ok) {
        console.log('SMS integration status check failed or not available');
        return;
      }

      const data = await response.json();

      if (data.connected) {
        const el1 = document.getElementById('sms-not-connected');
        const el2 = document.getElementById('sms-connected');
        const el3 = document.getElementById('sms-disconnected-badge');
        const el4 = document.getElementById('sms-connected-badge');
        const el5 = document.getElementById('sms-phone-display');
        const el6 = document.getElementById('sms-connected-date');
        if (el1) el1.style.display = 'none';
        if (el2) el2.style.display = 'block';
        if (el3) el3.style.display = 'none';
        if (el4) el4.style.display = 'inline';
        if (el5) el5.textContent = data.twilio_phone_number || 'Unknown';
        if (el6) el6.textContent = data.connected_at ? new Date(data.connected_at).toLocaleDateString() : '-';
      } else {
        const el1 = document.getElementById('sms-not-connected');
        const el2 = document.getElementById('sms-connected');
        const el3 = document.getElementById('sms-disconnected-badge');
        const el4 = document.getElementById('sms-connected-badge');
        if (el1) el1.style.display = 'block';
        if (el2) el2.style.display = 'none';
        if (el3) el3.style.display = 'inline';
        if (el4) el4.style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading SMS integration status:', error);
    }
  }

  async function connectSms() {
    const phoneInput = document.getElementById('sms-phone-number');
    const sidInput = document.getElementById('sms-account-sid');
    const phone = (phoneInput ? phoneInput.value : '').trim();
    const sid = (sidInput ? sidInput.value : '').trim();

    if (!phone) {
      showSmsError('Please enter a Twilio phone number in E.164 format (e.g. +14155551234)');
      return;
    }

    if (!/^\+[1-9]\d{1,14}$/.test(phone)) {
      showSmsError('Invalid phone format. Use E.164 (e.g. +14155551234)');
      return;
    }

    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/sms/connect`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          twilio_phone_number: phone,
          twilio_account_sid: sid || undefined
        })
      });

      const data = await response.json();

      if (data.success) {
        if (phoneInput) phoneInput.value = '';
        if (sidInput) sidInput.value = '';
        showSmsMessage('SMS integration connected!');
        loadSmsIntegrationStatus();
      } else {
        showSmsError(data.error || 'Failed to connect');
      }
    } catch (error) {
      console.error('Error connecting SMS:', error);
      showSmsError('Failed to connect SMS integration');
    }
  }

  async function disconnectSms() {
    if (!confirm('Are you sure you want to disconnect SMS integration?')) return;

    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/sms/disconnect`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      const data = await response.json();

      if (data.success) {
        showSmsMessage('SMS integration disconnected');
        loadSmsIntegrationStatus();
      } else {
        showSmsError(data.error || 'Failed to disconnect');
      }
    } catch (error) {
      console.error('Error disconnecting SMS:', error);
      showSmsError('Failed to disconnect');
    }
  }

  async function testSms() {
    const input = document.getElementById('sms-test-phone');
    const phone = (input ? input.value : '').trim();

    if (!phone) {
      showSmsError('Enter a phone number to send the test to');
      return;
    }

    try {
      const tenantCode = window.currentUser?.tenantCode || window.tenant || 'apoyar';
      const response = await fetch(`/api/integrations/${tenantCode}/sms/test`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ to_phone_number: phone })
      });

      const data = await response.json();

      if (data.success) {
        showSmsMessage('Test SMS sent! Check your phone.');
      } else {
        showSmsError(data.error || 'Failed to send test SMS');
      }
    } catch (error) {
      console.error('Error sending test SMS:', error);
      showSmsError('Failed to send test. Is the SMS connector running?');
    }
  }

  function showSmsMessage(message) {
    const msgEl = document.getElementById('sms-message');
    const errEl = document.getElementById('sms-error');
    if (errEl) errEl.style.display = 'none';
    if (msgEl) { msgEl.textContent = message; msgEl.style.display = 'block'; }
    setTimeout(() => { if (msgEl) msgEl.style.display = 'none'; }, 4000);
  }

  function showSmsError(message) {
    const msgEl = document.getElementById('sms-message');
    const errEl = document.getElementById('sms-error');
    if (msgEl) msgEl.style.display = 'none';
    if (errEl) { errEl.textContent = message; errEl.style.display = 'block'; }
    setTimeout(() => { if (errEl) errEl.style.display = 'none'; }, 5000);
  }

  // Expert Registration Settings Functions
  async function loadExpertRegSettings() {
    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`/api/tickets/settings/${tenantCode}`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      if (data.success && data.settings) {
        document.getElementById('expert-reg-domain').value = data.settings.tenant_domain || '';
      }
    } catch (error) {
      console.error('Error loading expert registration settings:', error);
    }
  }

  async function saveExpertRegSettings() {
    const domain = document.getElementById('expert-reg-domain').value.trim().toLowerCase();

    if (!domain) {
      showExpertRegError('Please enter your company email domain');
      return;
    }

    // Basic domain validation
    if (!/^[a-z0-9]+([\-\.][a-z0-9]+)*\.[a-z]{2,}$/.test(domain)) {
      showExpertRegError('Please enter a valid domain (e.g., apoyar.eu)');
      return;
    }

    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`/api/tickets/settings/${tenantCode}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ key: 'tenant_domain', value: domain })
      });

      const data = await response.json();

      if (response.status === 403) {
        showExpertRegError('⚠️ Admin access required.');
        return;
      }

      if (data.success) {
        showExpertRegMessage(`✅ Tenant domain set to "${domain}". Experts can now register via email.`);
        setTimeout(hideExpertRegMessages, 5000);
      } else {
        showExpertRegError(data.message || 'Error saving settings');
      }
    } catch (error) {
      console.error('Error saving expert registration settings:', error);
      showExpertRegError('Error saving settings');
    }
  }

  function showExpertRegMessage(message) {
    document.getElementById('expert-reg-error').style.display = 'none';
    const el = document.getElementById('expert-reg-message');
    el.textContent = message;
    el.style.display = 'block';
  }

  function showExpertRegError(message) {
    document.getElementById('expert-reg-message').style.display = 'none';
    const el = document.getElementById('expert-reg-error');
    el.textContent = message;
    el.style.display = 'block';
  }

  function hideExpertRegMessages() {
    document.getElementById('expert-reg-message').style.display = 'none';
    document.getElementById('expert-reg-error').style.display = 'none';
  }

  async function triggerEmailProcessing() {
    const msgEl = document.getElementById('email-process-message');
    msgEl.style.display = 'none';

    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      msgEl.textContent = 'Processing emails...';
      msgEl.style.color = '#9333ea';
      msgEl.style.display = 'block';

      const response = await fetch(`/api/email-ingest/${tenantCode}/process-now`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      const data = await response.json();

      if (data.success && data.log) {
        const logHtml = data.log
          .filter(l => !l.startsWith('{') && l.trim())
          .map(l => {
            let color = '#374151';
            if (l.includes('ERROR')) color = '#b91c1c';
            else if (l.includes('✅') || l.includes('✓')) color = '#16a34a';
            else if (l.includes('📊')) color = '#9333ea';
            else if (l.includes('📨') || l.includes('📧')) color = '#2563eb';
            else if (l.includes('⏭️')) color = '#9ca3af';
            else if (l.includes('🔒')) color = '#d97706';
            return '<div style="margin-bottom:2px;color:' + color + '">' + l.replace(/</g, '&lt;') + '</div>';
          }).join('');
        msgEl.innerHTML = '<div style="font-family:monospace;font-size:12px;max-height:300px;overflow-y:auto;padding:8px;background:#f9fafb;border-radius:6px;border:1px solid #e5e7eb">' + logHtml + '</div>';
      } else if (data.success) {
        msgEl.textContent = data.message || 'Email processing completed';
        msgEl.style.color = '#16a34a';
      } else {
        msgEl.textContent = data.message || 'Error triggering email processing';
        msgEl.style.color = '#b91c1c';
      }
      msgEl.style.display = 'block';
    } catch (error) {
      console.error('Error triggering email processing:', error);
      msgEl.textContent = 'Error triggering email processing';
      msgEl.style.color = '#b91c1c';
      msgEl.style.display = 'block';
    }
  }

  // Support Settings Functions
  async function loadSupportSettings() {
    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`/api/tickets/settings/${tenantCode}`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      if (data.success && data.settings) {
        const checkbox = document.getElementById('resolution-requires-acceptance');
        if (checkbox) {
          // Default to true if not set
          checkbox.checked = data.settings.resolution_requires_acceptance !== 'false';
        }
      }
    } catch (error) {
      console.error('Error loading support settings:', error);
    }
  }

  async function saveSupportSettings() {
    const checkbox = document.getElementById('resolution-requires-acceptance');
    const requiresAcceptance = checkbox ? checkbox.checked : true;

    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`/api/tickets/settings/${tenantCode}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ key: 'resolution_requires_acceptance', value: String(requiresAcceptance) })
      });

      const data = await response.json();

      if (response.status === 403) {
        showSupportSettingsError('Admin access required.');
        return;
      }

      if (data.success) {
        showSupportSettingsMessage('Settings saved successfully.');
        setTimeout(hideSupportSettingsMessages, 5000);
      } else {
        showSupportSettingsError(data.message || 'Error saving settings');
      }
    } catch (error) {
      console.error('Error saving support settings:', error);
      showSupportSettingsError('Error saving settings');
    }
  }

  function showSupportSettingsMessage(message) {
    document.getElementById('support-settings-error').style.display = 'none';
    const el = document.getElementById('support-settings-message');
    el.textContent = message;
    el.style.display = 'block';
  }

  function showSupportSettingsError(message) {
    document.getElementById('support-settings-message').style.display = 'none';
    const el = document.getElementById('support-settings-error');
    el.textContent = message;
    el.style.display = 'block';
  }

  function hideSupportSettingsMessages() {
    document.getElementById('support-settings-message').style.display = 'none';
    document.getElementById('support-settings-error').style.display = 'none';
  }

  // ============================================
  // Batch Processing Settings Functions
  // ============================================

  async function loadBatchProcessingSettings() {
    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`/api/tenant-settings/${tenantCode}/settings`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      if (data.success && data.settings) {
        // Find batch settings
        const batchDelay = data.settings.find(s => s.setting_key === 'batch_delay_seconds');
        const batchSize = data.settings.find(s => s.setting_key === 'batch_size');
        const slaCheckInterval = data.settings.find(s => s.setting_key === 'sla_check_interval_seconds');

        const delayInput = document.getElementById('batch-delay-seconds');
        const sizeInput = document.getElementById('batch-size');
        const intervalInput = document.getElementById('sla-check-interval');

        if (delayInput && batchDelay) {
          delayInput.value = batchDelay.setting_value || '3';
        }
        if (sizeInput && batchSize) {
          sizeInput.value = batchSize.setting_value || '5';
        }
        if (intervalInput && slaCheckInterval) {
          intervalInput.value = slaCheckInterval.setting_value || '300';
        }
      }
    } catch (error) {
      console.error('Error loading batch processing settings:', error);
    }
  }

  async function saveBatchProcessingSettings() {
    const delayInput = document.getElementById('batch-delay-seconds');
    const sizeInput = document.getElementById('batch-size');
    const intervalInput = document.getElementById('sla-check-interval');

    let batchDelay = parseInt(delayInput?.value || '3', 10);
    let batchSize = parseInt(sizeInput?.value || '5', 10);
    let slaCheckInterval = parseInt(intervalInput?.value || '300', 10);

    // Validate minimum/maximum
    if (slaCheckInterval < 60) {
      showBatchSettingsError('SLA check interval must be at least 60 seconds.');
      intervalInput.value = '60';
      return;
    }
    if (batchDelay < 3) {
      showBatchSettingsError('Batch delay must be at least 3 seconds.');
      delayInput.value = '3';
      return;
    }
    if (batchSize < 1 || batchSize > 10) {
      showBatchSettingsError('Batch size must be between 1 and 10.');
      sizeInput.value = Math.max(1, Math.min(10, batchSize));
      return;
    }

    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';

      // Save sla_check_interval_seconds
      const intervalResponse = await fetch(`/api/tenant-settings/${tenantCode}/settings/sla_check_interval_seconds`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ value: String(slaCheckInterval) })
      });

      if (intervalResponse.status === 403) {
        showBatchSettingsError('Admin access required.');
        return;
      }

      // Save batch_delay_seconds
      const delayResponse = await fetch(`/api/tenant-settings/${tenantCode}/settings/batch_delay_seconds`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ value: String(batchDelay) })
      });

      if (delayResponse.status === 403) {
        showBatchSettingsError('Admin access required.');
        return;
      }

      // Save batch_size
      const sizeResponse = await fetch(`/api/tenant-settings/${tenantCode}/settings/batch_size`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ value: String(batchSize) })
      });

      if (sizeResponse.status === 403) {
        showBatchSettingsError('Admin access required.');
        return;
      }

      const intervalData = await intervalResponse.json();
      const delayData = await delayResponse.json();
      const sizeData = await sizeResponse.json();

      if (intervalData.success && delayData.success && sizeData.success) {
        showBatchSettingsMessage('Batch processing settings saved successfully.');
        setTimeout(hideBatchSettingsMessages, 5000);
      } else {
        showBatchSettingsError(intervalData.message || delayData.message || sizeData.message || 'Error saving settings');
      }
    } catch (error) {
      console.error('Error saving batch processing settings:', error);
      showBatchSettingsError('Error saving settings');
    }
  }

  function showBatchSettingsMessage(message) {
    document.getElementById('batch-settings-error').style.display = 'none';
    const el = document.getElementById('batch-settings-message');
    el.textContent = message;
    el.style.display = 'block';
  }

  function showBatchSettingsError(message) {
    document.getElementById('batch-settings-message').style.display = 'none';
    const el = document.getElementById('batch-settings-error');
    el.textContent = message;
    el.style.display = 'block';
  }

  function hideBatchSettingsMessages() {
    document.getElementById('batch-settings-message').style.display = 'none';
    document.getElementById('batch-settings-error').style.display = 'none';
  }

  // ============================================
  // SLA Management Functions
  // ============================================
  let businessHoursProfiles = [];
  let slaDefinitions = [];

  async function loadSLAData() {
    const tenantCode = window.tenant || window.currentUser?.tenantCode || 'apoyar';
    const token = localStorage.getItem('token');

    try {
      // Load business hours
      const bhRes = await fetch(`${API_BASE}/api/sla/${tenantCode}/business-hours`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (bhRes.ok) {
        const bhData = await bhRes.json();
        businessHoursProfiles = bhData.profiles || [];
        renderBusinessHoursTable();
      }

      // Load SLA definitions
      const slaRes = await fetch(`${API_BASE}/api/sla/${tenantCode}/definitions`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (slaRes.ok) {
        const slaData = await slaRes.json();
        slaDefinitions = slaData.definitions || [];
        renderSLADefinitionsTable();
        populateBusinessHoursDropdown();
      }

      // Load category mappings (after SLA definitions loaded for dropdown)
      await loadCategoryMappings();
    } catch (error) {
      console.error('Error loading SLA data:', error);
    }
  }

  function renderBusinessHoursTable() {
    const tbody = document.getElementById('business-hours-tbody');
    if (!tbody) return;

    if (businessHoursProfiles.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;text-align:center;color:#666">No business hours profiles defined</td></tr>';
      return;
    }

    const dayNames = ['', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    tbody.innerHTML = businessHoursProfiles.map(p => {
      const days = (p.days_of_week || []).map(d => dayNames[d]).join(', ');
      const hours = p.is_24x7 ? '24x7' : `${p.start_time?.slice(0,5)} - ${p.end_time?.slice(0,5)}`;
      return `<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:8px">${p.name}</td>
        <td style="padding:8px">${p.timezone}</td>
        <td style="padding:8px">${hours}</td>
        <td style="padding:8px">${p.is_24x7 ? 'All days' : days}</td>
        <td style="padding:8px;text-align:right">
          <button type="button" class="btn btn-sm" onclick="event.preventDefault();event.stopPropagation();editBusinessHours(${p.id},this)">Edit</button>
          <button type="button" class="btn btn-sm" style="color:#b91c1c" onclick="event.preventDefault();event.stopPropagation();deleteBusinessHours(${p.id})">Delete</button>
        </td>
      </tr>`;
    }).join('');
  }

  function renderSLADefinitionsTable() {
    const tbody = document.getElementById('sla-definitions-tbody');
    if (!tbody) return;

    if (slaDefinitions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;text-align:center;color:#666">No SLA definitions defined</td></tr>';
      return;
    }

    tbody.innerHTML = slaDefinitions.map(s => {
      const response = formatDuration(s.response_target_minutes);
      const resolve = formatDuration(s.resolve_after_response_minutes || s.resolve_target_minutes);
      return `<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:8px"><strong>${s.name}</strong><br><span style="color:#666;font-size:12px">${s.description || ''}</span></td>
        <td style="padding:8px">${response}</td>
        <td style="padding:8px">${resolve}</td>
        <td style="padding:8px">${s.business_hours_name || 'Calendar time'}</td>
        <td style="padding:8px;text-align:right">
          <button type="button" class="btn btn-sm" onclick="event.preventDefault();event.stopPropagation();editSLADefinition(${s.id},this)">Edit</button>
          <button type="button" class="btn btn-sm" style="color:#b91c1c" onclick="event.preventDefault();event.stopPropagation();deleteSLADefinition(${s.id})">Delete</button>
        </td>
      </tr>`;
    }).join('');
  }

  function formatDuration(minutes) {
    if (minutes >= 1440) return (minutes / 1440) + ' days';
    if (minutes >= 60) return (minutes / 60) + ' hours';
    return minutes + ' min';
  }

  function populateBusinessHoursDropdown() {
    const select = document.getElementById('sla-business-hours');
    if (!select) return;
    select.innerHTML = '<option value="">-- Calendar Time (no business hours) --</option>' +
      businessHoursProfiles.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  }

  // Business Hours Modal
  function openBusinessHoursModal(id = null) {
    document.getElementById('bh-edit-id').value = id || '';
    document.getElementById('business-hours-modal-title').textContent = id ? 'Edit Business Hours Profile' : 'Add Business Hours Profile';
    document.getElementById('bh-error').style.display = 'none';

    if (id) {
      const p = businessHoursProfiles.find(x => x.id == id); // Use == for type coercion
      if (p) {
        document.getElementById('bh-name').value = p.name;
        document.getElementById('bh-timezone').value = p.timezone;
        document.getElementById('bh-is-24x7').checked = !!p.is_24x7; // Ensure boolean
        document.getElementById('bh-start-time').value = p.start_time?.slice(0,5) || '09:00';
        document.getElementById('bh-end-time').value = p.end_time?.slice(0,5) || '17:00';
        const days = p.days_of_week || [];
        for (let i = 1; i <= 7; i++) {
          document.getElementById('bh-day-' + i).checked = days.includes(i);
        }
        toggle24x7();
      }
    } else {
      document.getElementById('bh-name').value = '';
      document.getElementById('bh-timezone').value = 'Australia/Sydney';
      document.getElementById('bh-is-24x7').checked = false;
      document.getElementById('bh-start-time').value = '09:00';
      document.getElementById('bh-end-time').value = '17:00';
      for (let i = 1; i <= 5; i++) document.getElementById('bh-day-' + i).checked = true;
      for (let i = 6; i <= 7; i++) document.getElementById('bh-day-' + i).checked = false;
      toggle24x7();
    }

    document.getElementById('business-hours-modal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeBusinessHoursModal() {
    const modal = document.getElementById('business-hours-modal');
    const sheet = modal.querySelector('.sheet');
    sheet.classList.remove('popover', 'compact');
    sheet.style.top = '';
    sheet.style.left = '';
    modal.style.display = 'none';
    modal.style.background = '';
    document.body.style.overflow = '';
    if (modal._popoverCleanup) { modal._popoverCleanup(); modal._popoverCleanup = null; }
  }

  function toggle24x7() {
    const is24x7 = document.getElementById('bh-is-24x7').checked;
    document.getElementById('bh-hours-section').style.display = is24x7 ? 'none' : 'block';
  }

  // Popover helpers for Edit buttons
  function positionPopover(sheetEl, anchorEl) {
    const pad = 12;

    // Anchor to the row, not just the button
    const rowEl = anchorEl.closest('tr') || anchorEl.closest('.row') || anchorEl.parentElement;
    const a = (rowEl || anchorEl).getBoundingClientRect();

    // Setup sheet for measurement
    sheetEl.style.cssText = '';
    sheetEl.style.display = 'block';
    sheetEl.style.position = 'fixed';
    sheetEl.style.zIndex = '2000';
    sheetEl.classList.add('popover');
    sheetEl.style.overflow = 'auto';

    const popW = sheetEl.getBoundingClientRect().width;
    const popH = sheetEl.getBoundingClientRect().height;

    // Horizontal: prefer right of row, flip left if needed
    let left = a.right + pad;
    if (left + popW > window.innerWidth - pad) left = a.left - popW - pad;

    // Vertical: anchor near the row center, allow internal scroll
    const rowMid = a.top + a.height / 2;
    let top = rowMid - Math.min(200, popH / 3); // keeps header near row

    // Set maxHeight so sheet scrolls internally instead of jumping away
    const maxH = Math.max(280, window.innerHeight - pad * 2);
    sheetEl.style.maxHeight = `${maxH}px`;

    // Clamp top to viewport, but stay attached to row area
    top = Math.max(pad, Math.min(top, window.innerHeight - pad - 80));

    sheetEl.style.top = `${top}px`;
    sheetEl.style.left = `${left}px`;
  }

  function bindPopoverClose(modalEl, sheetEl, closeFn) {
    setTimeout(() => {
      function onDown(e) { if (!sheetEl.contains(e.target)) { cleanup(); closeFn(); } }
      function onKey(e) { if (e.key === 'Escape') { cleanup(); closeFn(); } }
      function cleanup() {
        document.removeEventListener('mousedown', onDown, true);
        document.removeEventListener('keydown', onKey, true);
      }
      document.addEventListener('mousedown', onDown, true);
      document.addEventListener('keydown', onKey, true);
      modalEl._popoverCleanup = cleanup;
    }, 0);
  }

  function editBusinessHours(id, anchorEl) {
    // Populate form
    document.getElementById('bh-edit-id').value = id || '';
    document.getElementById('business-hours-modal-title').textContent = 'Edit Business Hours Profile';
    document.getElementById('bh-error').style.display = 'none';
    const p = businessHoursProfiles.find(x => x.id == id);
    if (p) {
      document.getElementById('bh-name').value = p.name;
      document.getElementById('bh-timezone').value = p.timezone;
      document.getElementById('bh-is-24x7').checked = !!p.is_24x7;
      document.getElementById('bh-start-time').value = p.start_time?.slice(0,5) || '09:00';
      document.getElementById('bh-end-time').value = p.end_time?.slice(0,5) || '17:00';
      const days = p.days_of_week || [];
      for (let i = 1; i <= 7; i++) document.getElementById('bh-day-' + i).checked = days.includes(i);
      toggle24x7();
    }

    const modal = document.getElementById('business-hours-modal');
    const sheet = modal.querySelector('.sheet');

    if (anchorEl) {
      // Popover mode (compact Quick Edit)
      modal.style.display = 'flex';
      modal.style.background = 'transparent';
      sheet.classList.add('popover', 'compact');
      positionPopover(sheet, anchorEl);
      bindPopoverClose(modal, sheet, closeBusinessHoursModal);
    } else {
      // Fallback to centered modal
      openBusinessHoursModal(id);
    }
  }

  async function saveBusinessHours() {
    const id = document.getElementById('bh-edit-id').value;
    const name = document.getElementById('bh-name').value.trim();
    const timezone = document.getElementById('bh-timezone').value;
    const is_24x7 = document.getElementById('bh-is-24x7').checked;
    const start_time = document.getElementById('bh-start-time').value;
    const end_time = document.getElementById('bh-end-time').value;

    const days_of_week = [];
    for (let i = 1; i <= 7; i++) {
      if (document.getElementById('bh-day-' + i).checked) days_of_week.push(i);
    }

    if (!name) {
      document.getElementById('bh-error').textContent = 'Name is required';
      document.getElementById('bh-error').style.display = 'block';
      return;
    }

    const tenantCode = window.tenant || window.currentUser?.tenantCode || 'apoyar';
    const token = localStorage.getItem('token');
    const url = id ? `${API_BASE}/api/sla/${tenantCode}/business-hours/${id}` : `${API_BASE}/api/sla/${tenantCode}/business-hours`;
    const method = id ? 'PUT' : 'POST';

    try {
      const res = await fetch(url, {
        method,
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, timezone, days_of_week, start_time, end_time, is_24x7 })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to save');
      closeBusinessHoursModal();
      loadSLAData();
    } catch (error) {
      document.getElementById('bh-error').textContent = error.message;
      document.getElementById('bh-error').style.display = 'block';
    }
  }

  async function deleteBusinessHours(id) {
    if (!confirm('Delete this business hours profile?')) return;
    const tenantCode = window.tenant || window.currentUser?.tenantCode || 'apoyar';
    const token = localStorage.getItem('token');

    try {
      const res = await fetch(`${API_BASE}/api/sla/${tenantCode}/business-hours/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to delete');
      loadSLAData();
    } catch (error) {
      alert(error.message);
    }
  }

  // SLA Definition Modal
  function openSLADefinitionModal(id = null) {
    document.getElementById('sla-edit-id').value = id || '';
    document.getElementById('sla-definition-modal-title').textContent = id ? 'Edit SLA Definition' : 'Add SLA Definition';
    document.getElementById('sla-def-error').style.display = 'none';
    populateBusinessHoursDropdown();

    if (id) {
      const s = slaDefinitions.find(x => x.id == id); // Use == for type coercion
      if (s) {
        document.getElementById('sla-name').value = s.name;
        document.getElementById('sla-description').value = s.description || '';
        document.getElementById('sla-business-hours').value = s.business_hours_profile_id || '';

        // Convert minutes to best unit
        const respMins = s.response_target_minutes;
        if (respMins >= 60 && respMins % 60 === 0) {
          document.getElementById('sla-response-value').value = respMins / 60;
          document.getElementById('sla-response-unit').value = 'hours';
        } else {
          document.getElementById('sla-response-value').value = respMins;
          document.getElementById('sla-response-unit').value = 'minutes';
        }

        // Use resolve_after_response_minutes if available, fallback to resolve_target_minutes
        const resMins = s.resolve_after_response_minutes || s.resolve_target_minutes;
        if (resMins >= 60 && resMins % 60 === 0) {
          document.getElementById('sla-resolve-value').value = resMins / 60;
          document.getElementById('sla-resolve-unit').value = 'hours';
        } else {
          document.getElementById('sla-resolve-value').value = resMins;
          document.getElementById('sla-resolve-unit').value = 'minutes';
        }
      }
    } else {
      document.getElementById('sla-name').value = '';
      document.getElementById('sla-description').value = '';
      document.getElementById('sla-business-hours').value = '';
      document.getElementById('sla-response-value').value = 1;
      document.getElementById('sla-response-unit').value = 'hours';
      document.getElementById('sla-resolve-value').value = 8;
      document.getElementById('sla-resolve-unit').value = 'hours';
    }

    document.getElementById('sla-definition-modal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeSLADefinitionModal() {
    const modal = document.getElementById('sla-definition-modal');
    const sheet = modal.querySelector('.sheet');
    sheet.classList.remove('popover', 'compact');
    sheet.style.top = '';
    sheet.style.left = '';
    modal.style.display = 'none';
    modal.style.background = '';
    document.body.style.overflow = '';
    if (modal._popoverCleanup) { modal._popoverCleanup(); modal._popoverCleanup = null; }
  }

  function editSLADefinition(id, anchorEl) {
    // Populate form
    document.getElementById('sla-edit-id').value = id || '';
    document.getElementById('sla-definition-modal-title').textContent = 'Edit SLA Definition';
    document.getElementById('sla-def-error').style.display = 'none';
    populateBusinessHoursDropdown();

    const s = slaDefinitions.find(x => x.id == id);
    if (s) {
      document.getElementById('sla-name').value = s.name;
      document.getElementById('sla-description').value = s.description || '';
      document.getElementById('sla-business-hours').value = s.business_hours_profile_id || '';
      const respMins = s.response_target_minutes;
      if (respMins >= 60 && respMins % 60 === 0) {
        document.getElementById('sla-response-value').value = respMins / 60;
        document.getElementById('sla-response-unit').value = 'hours';
      } else {
        document.getElementById('sla-response-value').value = respMins;
        document.getElementById('sla-response-unit').value = 'minutes';
      }
      // Use resolve_after_response_minutes if available, fallback to resolve_target_minutes
      const resMins = s.resolve_after_response_minutes || s.resolve_target_minutes;
      if (resMins >= 60 && resMins % 60 === 0) {
        document.getElementById('sla-resolve-value').value = resMins / 60;
        document.getElementById('sla-resolve-unit').value = 'hours';
      } else {
        document.getElementById('sla-resolve-value').value = resMins;
        document.getElementById('sla-resolve-unit').value = 'minutes';
      }
    }

    const modal = document.getElementById('sla-definition-modal');
    const sheet = modal.querySelector('.sheet');

    if (anchorEl) {
      // Popover mode (compact Quick Edit)
      modal.style.display = 'flex';
      modal.style.background = 'transparent';
      sheet.classList.add('popover', 'compact');
      positionPopover(sheet, anchorEl);
      bindPopoverClose(modal, sheet, closeSLADefinitionModal);
    } else {
      // Fallback to centered modal
      openSLADefinitionModal(id);
    }
  }

  async function saveSLADefinition() {
    const id = document.getElementById('sla-edit-id').value;
    const name = document.getElementById('sla-name').value.trim();
    const description = document.getElementById('sla-description').value.trim();
    const business_hours_profile_id = document.getElementById('sla-business-hours').value || null;

    const respValue = parseInt(document.getElementById('sla-response-value').value);
    const respUnit = document.getElementById('sla-response-unit').value;
    const response_target_minutes = respUnit === 'hours' ? respValue * 60 : respValue;

    const resValue = parseInt(document.getElementById('sla-resolve-value').value);
    const resUnit = document.getElementById('sla-resolve-unit').value;
    const resolve_after_response_minutes = resUnit === 'hours' ? resValue * 60 : resValue;

    if (!name) {
      document.getElementById('sla-def-error').textContent = 'Name is required';
      document.getElementById('sla-def-error').style.display = 'block';
      return;
    }

    const tenantCode = window.tenant || window.currentUser?.tenantCode || 'apoyar';
    const token = localStorage.getItem('token');
    const url = id ? `${API_BASE}/api/sla/${tenantCode}/definitions/${id}` : `${API_BASE}/api/sla/${tenantCode}/definitions`;
    const method = id ? 'PUT' : 'POST';

    try {
      const res = await fetch(url, {
        method,
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description, business_hours_profile_id, response_target_minutes, resolve_after_response_minutes })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to save');
      closeSLADefinitionModal();
      loadSLAData();
    } catch (error) {
      document.getElementById('sla-def-error').textContent = error.message;
      document.getElementById('sla-def-error').style.display = 'block';
    }
  }

  async function deleteSLADefinition(id) {
    if (!confirm('Delete this SLA definition?')) return;
    const tenantCode = window.tenant || window.currentUser?.tenantCode || 'apoyar';
    const token = localStorage.getItem('token');

    try {
      const res = await fetch(`${API_BASE}/api/sla/${tenantCode}/definitions/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to delete');
      loadSLAData();
    } catch (error) {
      alert(error.message);
    }
  }

  // ============================================
  // Category SLA Mapping Functions
  // ============================================
  let categoryMappings = [];

  async function loadCategoryMappings() {
    const tenantCode = window.tenant || window.currentUser?.tenantCode || 'apoyar';
    const token = localStorage.getItem('token');

    try {
      const res = await fetch(`${API_BASE}/api/sla/${tenantCode}/category-mappings`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (res.ok) {
        const data = await res.json();
        categoryMappings = data.mappings || [];
        renderCategoryMappingsTable();
      }
    } catch (error) {
      console.error('Error loading category mappings:', error);
    }
  }

  function renderCategoryMappingsTable() {
    const tbody = document.getElementById('category-mappings-tbody');
    if (!tbody) return;

    if (categoryMappings.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="padding:16px;text-align:center;color:#666">No category mappings defined</td></tr>';
      return;
    }

    tbody.innerHTML = categoryMappings.map(m => {
      const statusBadge = m.is_active
        ? '<span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:4px;font-size:11px">Active</span>'
        : '<span style="background:#fee2e2;color:#991b1b;padding:2px 8px;border-radius:4px;font-size:11px">Inactive</span>';
      return `<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:8px"><strong>${m.category}</strong></td>
        <td style="padding:8px">${m.sla_name || 'Unknown SLA'}</td>
        <td style="padding:8px">${statusBadge}</td>
        <td style="padding:8px;text-align:right">
          <button type="button" class="btn btn-sm" onclick="event.preventDefault();event.stopPropagation();editCategoryMapping(${m.id},this)">Edit</button>
          <button type="button" class="btn btn-sm" style="color:#b91c1c" onclick="event.preventDefault();event.stopPropagation();deleteCategoryMapping(${m.id})">Delete</button>
        </td>
      </tr>`;
    }).join('');
  }

  function populateCategoryMappingSLADropdown() {
    const select = document.getElementById('cat-map-sla');
    if (!select) return;
    select.innerHTML = '<option value="">-- Select SLA --</option>' +
      slaDefinitions.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  }

  function openCategoryMappingModal(id = null) {
    document.getElementById('cat-map-edit-id').value = id || '';
    document.getElementById('category-mapping-modal-title').textContent = id ? 'Edit Category Mapping' : 'Add Category Mapping';
    document.getElementById('cat-map-error').style.display = 'none';
    populateCategoryMappingSLADropdown();

    if (id) {
      const m = categoryMappings.find(x => x.id == id);
      if (m) {
        document.getElementById('cat-map-category').value = m.category;
        document.getElementById('cat-map-sla').value = m.sla_definition_id;
        document.getElementById('cat-map-active').checked = m.is_active;
      }
    } else {
      document.getElementById('cat-map-category').value = '';
      document.getElementById('cat-map-sla').value = '';
      document.getElementById('cat-map-active').checked = true;
    }

    document.getElementById('category-mapping-modal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeCategoryMappingModal() {
    const modal = document.getElementById('category-mapping-modal');
    const sheet = modal.querySelector('.sheet');
    sheet.classList.remove('popover', 'compact');
    sheet.style.top = '';
    sheet.style.left = '';
    modal.style.display = 'none';
    modal.style.background = '';
    document.body.style.overflow = '';
    if (modal._popoverCleanup) { modal._popoverCleanup(); modal._popoverCleanup = null; }
  }

  function editCategoryMapping(id, anchorEl) {
    document.getElementById('cat-map-edit-id').value = id || '';
    document.getElementById('category-mapping-modal-title').textContent = 'Edit Category Mapping';
    document.getElementById('cat-map-error').style.display = 'none';
    populateCategoryMappingSLADropdown();

    const m = categoryMappings.find(x => x.id == id);
    if (m) {
      document.getElementById('cat-map-category').value = m.category;
      document.getElementById('cat-map-sla').value = m.sla_definition_id;
      document.getElementById('cat-map-active').checked = m.is_active;
    }

    const modal = document.getElementById('category-mapping-modal');
    const sheet = modal.querySelector('.sheet');

    if (anchorEl) {
      modal.style.display = 'flex';
      modal.style.background = 'transparent';
      sheet.classList.add('popover', 'compact');
      positionPopover(sheet, anchorEl);
      bindPopoverClose(modal, sheet, closeCategoryMappingModal);
    } else {
      openCategoryMappingModal(id);
    }
  }

  async function saveCategoryMapping() {
    const id = document.getElementById('cat-map-edit-id').value;
    const category = document.getElementById('cat-map-category').value.trim();
    const sla_definition_id = document.getElementById('cat-map-sla').value;
    const is_active = document.getElementById('cat-map-active').checked;

    if (!category) {
      document.getElementById('cat-map-error').textContent = 'Category is required';
      document.getElementById('cat-map-error').style.display = 'block';
      return;
    }
    if (!sla_definition_id) {
      document.getElementById('cat-map-error').textContent = 'SLA Definition is required';
      document.getElementById('cat-map-error').style.display = 'block';
      return;
    }

    const tenantCode = window.tenant || window.currentUser?.tenantCode || 'apoyar';
    const token = localStorage.getItem('token');
    const url = id
      ? `${API_BASE}/api/sla/${tenantCode}/category-mappings/${id}`
      : `${API_BASE}/api/sla/${tenantCode}/category-mappings`;
    const method = id ? 'PUT' : 'POST';

    try {
      const res = await fetch(url, {
        method,
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ category, sla_definition_id: parseInt(sla_definition_id), is_active })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to save');
      closeCategoryMappingModal();
      loadCategoryMappings();
    } catch (error) {
      document.getElementById('cat-map-error').textContent = error.message;
      document.getElementById('cat-map-error').style.display = 'block';
    }
  }

  async function deleteCategoryMapping(id) {
    if (!confirm('Delete this category mapping?')) return;
    const tenantCode = window.tenant || window.currentUser?.tenantCode || 'apoyar';
    const token = localStorage.getItem('token');

    try {
      const res = await fetch(`${API_BASE}/api/sla/${tenantCode}/category-mappings/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to delete');
      loadCategoryMappings();
    } catch (error) {
      alert(error.message);
    }
  }

  // ============================================
  // Billing & Subscription Functions
  // ============================================
  let billingData = { subscription: null, plans: [], paymentMethods: [], invoices: [] };

  async function loadBillingData() {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
      // Load subscription
      const subRes = await fetch(`${API_BASE}/api/billing/subscription`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const subData = await subRes.json();
      if (subData.success) {
        billingData.subscription = subData.subscription;
        renderBillingSubscription(subData.subscription);
      }

      // Load available plans
      const plansRes = await fetch(`${API_BASE}/api/plans`);
      const plansData = await plansRes.json();
      if (plansData.success) {
        billingData.plans = plansData.plans;
        updateBillingPlans();
      }

      // Load payment methods
      const pmRes = await fetch(`${API_BASE}/api/billing/payment-methods`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const pmData = await pmRes.json();
      if (pmData.success) {
        billingData.paymentMethods = pmData.payment_methods || [];
        renderPaymentMethods();
      }

      // Load invoices
      const invRes = await fetch(`${API_BASE}/api/billing/invoices`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const invData = await invRes.json();
      if (invData.success) {
        billingData.invoices = invData.invoices || [];
        renderInvoices();
      }
    } catch (error) {
      console.error('[Billing] Error loading data:', error);
    }
  }

  function renderBillingSubscription(sub) {
    if (!sub) {
      document.getElementById('billing-plan-name').textContent = 'No Active Subscription';
      document.getElementById('billing-plan-tagline').textContent = 'Start a trial to get started';
      document.getElementById('billing-status-badge').textContent = 'None';
      document.getElementById('billing-status-badge').style.background = '#f3f4f6';
      document.getElementById('billing-status-badge').style.color = '#666';
      return;
    }

    // Plan info
    document.getElementById('billing-plan-name').textContent = sub.plan_display_name || sub.plan_slug || 'Unknown Plan';
    document.getElementById('billing-plan-tagline').textContent = sub.plan_tagline || '';
    document.getElementById('billing-plan-display').textContent = sub.plan_display_name || sub.plan_slug || '-';
    document.getElementById('billing-cycle-display').textContent = sub.billing_cycle === 'yearly' ? 'Annual' : 'Monthly';

    // Status badge
    const badge = document.getElementById('billing-status-badge');
    const status = sub.status || 'unknown';
    const statusColors = {
      active: { bg: '#dcfce7', color: '#16a34a', text: 'Active' },
      trial: { bg: '#fef3c7', color: '#92400e', text: 'Trial' },
      past_due: { bg: '#fee2e2', color: '#b91c1c', text: 'Past Due' },
      canceled: { bg: '#f3f4f6', color: '#666', text: 'Canceled' },
      expired: { bg: '#fee2e2', color: '#b91c1c', text: 'Expired' }
    };
    const statusStyle = statusColors[status] || statusColors.active;
    badge.style.background = statusStyle.bg;
    badge.style.color = statusStyle.color;
    badge.textContent = statusStyle.text;

    // Trial banner
    const trialBanner = document.getElementById('billing-trial-banner');
    if (status === 'trial' && sub.trial_end) {
      trialBanner.style.display = 'block';
      const trialEnd = new Date(sub.trial_end);
      const now = new Date();
      const diffMs = trialEnd - now;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);

      let remaining;
      if (diffDays > 0) {
        remaining = `${diffDays} day${diffDays > 1 ? 's' : ''}`;
      } else if (diffHours > 0) {
        remaining = `${diffHours} hour${diffHours > 1 ? 's' : ''}`;
      } else if (diffMins > 0) {
        remaining = `${diffMins} minute${diffMins > 1 ? 's' : ''}`;
      } else {
        remaining = 'expiring soon';
      }
      document.getElementById('billing-trial-remaining').textContent = remaining;
    } else {
      trialBanner.style.display = 'none';
    }

    // Next invoice and amount
    const price = sub.billing_cycle === 'yearly' ? sub.plan_price_yearly : sub.plan_price_monthly;
    document.getElementById('billing-amount-display').textContent = price ? `$${parseFloat(price).toFixed(2)}/tech/${sub.billing_cycle === 'yearly' ? 'year' : 'month'}` : '-';

    if (sub.current_period_end) {
      const nextDate = new Date(sub.current_period_end);
      document.getElementById('billing-next-invoice').textContent = nextDate.toLocaleDateString();
    } else {
      document.getElementById('billing-next-invoice').textContent = '-';
    }

    // Show/hide cancel button
    const cancelBtn = document.getElementById('billing-cancel-btn');
    if (status === 'active' && !sub.cancel_at_period_end) {
      cancelBtn.style.display = 'inline-block';
    } else {
      cancelBtn.style.display = 'none';
    }
  }

  function updateBillingPlans() {
    const cycle = document.querySelector('input[name="billing-cycle"]:checked')?.value || 'monthly';
    const grid = document.getElementById('billing-plans-grid');
    const currentSlug = billingData.subscription?.plan_slug;

    if (!billingData.plans || billingData.plans.length === 0) {
      grid.innerHTML = '<div style="padding:24px;text-align:center;color:#666">No plans available</div>';
      return;
    }

    grid.innerHTML = billingData.plans.map(plan => {
      const price = cycle === 'yearly' ? plan.price_yearly : plan.price_monthly;
      const isCurrent = plan.slug === currentSlug;
      const isFeatured = plan.is_featured;

      return `
        <div style="border:${isFeatured ? '2px solid #2563eb' : '1px solid var(--border)'};border-radius:8px;padding:16px;position:relative;${isCurrent ? 'background:#f0fdf4;' : ''}">
          ${isFeatured ? '<div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:#2563eb;color:white;font-size:10px;padding:2px 8px;border-radius:4px;text-transform:uppercase">Popular</div>' : ''}
          ${isCurrent ? '<div style="position:absolute;top:8px;right:8px;background:#16a34a;color:white;font-size:10px;padding:2px 6px;border-radius:4px">Current</div>' : ''}
          <div style="font-weight:600;font-size:16px;margin-bottom:4px">${plan.display_name}</div>
          <div class="subtitle" style="font-size:12px;margin-bottom:12px">${plan.tagline || ''}</div>
          <div style="font-size:24px;font-weight:bold;margin-bottom:12px">
            $${parseFloat(price).toFixed(0)}
            <span style="font-size:12px;font-weight:normal;color:#666">/${cycle === 'yearly' ? 'year' : 'month'}/tech</span>
          </div>
          <button class="btn ${isCurrent ? '' : 'primary'}" style="width:100%" onclick="selectBillingPlan('${plan.slug}')" ${isCurrent ? 'disabled' : ''}>
            ${isCurrent ? 'Current Plan' : 'Select'}
          </button>
        </div>
      `;
    }).join('');
  }

  async function selectBillingPlan(planSlug) {
    const cycle = document.querySelector('input[name="billing-cycle"]:checked')?.value || 'monthly';
    await openBillingCheckout(planSlug, cycle);
  }

  async function openBillingCheckout(planSlug = null, billingCycle = null) {
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Please log in to upgrade your subscription');
      return;
    }

    // Default to current or professional plan
    planSlug = planSlug || billingData.subscription?.plan_slug || 'professional';
    billingCycle = billingCycle || document.querySelector('input[name="billing-cycle"]:checked')?.value || 'monthly';

    try {
      showBillingMessage('Creating checkout session...', false);

      const res = await fetch(`${API_BASE}/api/billing/checkout`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ plan_slug: planSlug, billing_cycle: billingCycle })
      });

      const data = await res.json();

      if (data.success && data.checkout_url) {
        // Redirect to Stripe checkout
        window.location.href = data.checkout_url;
      } else if (data.success && data.message) {
        // No Stripe configured - test mode
        showBillingMessage(data.message, false);
        loadBillingData(); // Refresh
      } else {
        throw new Error(data.message || 'Failed to create checkout session');
      }
    } catch (error) {
      showBillingError(error.message);
    }
  }

  async function cancelSubscription() {
    if (!confirm('Are you sure you want to cancel your subscription? You will retain access until the end of your current billing period.')) {
      return;
    }

    const token = localStorage.getItem('token');

    try {
      showBillingMessage('Canceling subscription...', false);

      const res = await fetch(`${API_BASE}/api/billing/cancel`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      const data = await res.json();

      if (data.success) {
        showBillingMessage('Subscription canceled. You will retain access until ' + new Date(data.access_until).toLocaleDateString(), false);
        loadBillingData();
      } else {
        throw new Error(data.message || 'Failed to cancel subscription');
      }
    } catch (error) {
      showBillingError(error.message);
    }
  }

  function renderPaymentMethods() {
    const container = document.getElementById('billing-payment-methods');
    const methods = billingData.paymentMethods || [];

    if (methods.length === 0) {
      container.innerHTML = '<div style="padding:24px;text-align:center;color:#666">No payment methods saved</div>';
      return;
    }

    container.innerHTML = methods.map(pm => `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:40px;height:28px;background:#f3f4f6;border-radius:4px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:10px">${(pm.card_brand || 'CARD').toUpperCase()}</div>
          <div>
            <div style="font-weight:500">**** **** **** ${pm.card_last_four || '****'}</div>
            <div class="subtitle" style="font-size:12px">Expires ${pm.card_exp_month || '--'}/${pm.card_exp_year || '--'}</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${pm.is_default ? '<span class="badge" style="background:#dcfce7;color:#16a34a;font-size:10px">Default</span>' : ''}
          <button class="btn ghost" style="color:#b91c1c;font-size:12px" onclick="removePaymentMethod('${pm.id}')">Remove</button>
        </div>
      </div>
    `).join('');
  }

  async function addPaymentMethod() {
    const token = localStorage.getItem('token');

    try {
      showBillingMessage('Setting up card form...', false);

      const res = await fetch(`${API_BASE}/api/billing/payment-methods`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      const data = await res.json();

      if (data.success) {
        if (data.setup_url) {
          window.location.href = data.setup_url;
        } else if (data.client_secret) {
          // Would integrate with Stripe.js here for inline card form
          showBillingMessage('Card setup ready. Stripe integration required for inline form.', false);
        } else {
          showBillingMessage('Payment method setup created', false);
        }
      } else {
        throw new Error(data.message || 'Failed to setup payment method');
      }
    } catch (error) {
      showBillingError(error.message);
    }
  }

  async function removePaymentMethod(id) {
    if (!confirm('Remove this payment method?')) return;

    const token = localStorage.getItem('token');

    try {
      const res = await fetch(`${API_BASE}/api/billing/payment-methods/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      });

      const data = await res.json();

      if (data.success) {
        showBillingMessage('Payment method removed', false);
        loadBillingData();
      } else {
        throw new Error(data.message || 'Failed to remove payment method');
      }
    } catch (error) {
      showBillingError(error.message);
    }
  }

  function renderInvoices() {
    const tbody = document.getElementById('billing-invoices-tbody');
    const invoices = billingData.invoices || [];

    if (invoices.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;text-align:center;color:#666">No invoices yet</td></tr>';
      return;
    }

    tbody.innerHTML = invoices.map(inv => {
      const date = new Date(inv.created_at || inv.date);
      const statusColors = {
        succeeded: { bg: '#dcfce7', color: '#16a34a' },
        paid: { bg: '#dcfce7', color: '#16a34a' },
        pending: { bg: '#fef3c7', color: '#92400e' },
        failed: { bg: '#fee2e2', color: '#b91c1c' }
      };
      const statusStyle = statusColors[inv.status] || statusColors.pending;

      return `
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:8px">${date.toLocaleDateString()}</td>
          <td style="padding:8px">${inv.description || 'Subscription'}</td>
          <td style="padding:8px">$${parseFloat(inv.amount || 0).toFixed(2)}</td>
          <td style="padding:8px"><span class="badge" style="background:${statusStyle.bg};color:${statusStyle.color};font-size:11px">${inv.status || 'pending'}</span></td>
          <td style="padding:8px;text-align:right">
            ${inv.invoice_url ? `<a href="${inv.invoice_url}" target="_blank" class="btn ghost" style="font-size:12px">View</a>` : '-'}
          </td>
        </tr>
      `;
    }).join('');
  }

  function showBillingMessage(msg, isError = false) {
    const el = document.getElementById(isError ? 'billing-error' : 'billing-message');
    const other = document.getElementById(isError ? 'billing-message' : 'billing-error');
    el.textContent = msg;
    el.style.display = 'block';
    other.style.display = 'none';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
  }

  function showBillingError(msg) {
    showBillingMessage(msg, true);
  }

  // Housekeeping Functions
  // ---- Chat Canned Responses Admin ----
  let editingCannedId = null;

  async function loadCannedResponsesAdmin() {
    const list = document.getElementById('canned-responses-list');
    if (!list) return;
    try {
      const resp = await fetch(`/api/chat/${tenant}/canned-responses`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await resp.json();
      if (!data.success || !data.responses?.length) {
        list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">No canned responses configured</div>';
        return;
      }
      list.innerHTML = '<table style="width:100%;font-size:13px"><thead><tr><th>Label</th><th>Message</th><th>Action</th><th>Order</th><th></th></tr></thead><tbody>' +
        data.responses.map(cr => `<tr>
          <td style="font-weight:600">${cr.label}</td>
          <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${cr.message}</td>
          <td><span class="badge">${cr.action_type}</span></td>
          <td>${cr.sort_order}</td>
          <td style="white-space:nowrap">
            <button class="btn ghost" onclick="editCannedResponse(${cr.id},'${(cr.label||'').replace(/'/g,"\\'")}','${(cr.message||'').replace(/'/g,"\\'")}','${cr.action_type}',${cr.sort_order})" style="padding:2px 8px;font-size:11px">Edit</button>
            <button class="btn ghost" onclick="deleteCannedResponse(${cr.id})" style="padding:2px 8px;font-size:11px;color:#dc2626">Delete</button>
          </td>
        </tr>`).join('') + '</tbody></table>';
    } catch (e) {
      list.innerHTML = '<div style="color:#dc2626;padding:12px">Failed to load canned responses</div>';
    }
  }

  function addCannedResponse() {
    editingCannedId = null;
    document.getElementById('cr-form-title').textContent = 'Add Canned Response';
    document.getElementById('cr-label').value = '';
    document.getElementById('cr-message').value = '';
    document.getElementById('cr-action-type').value = 'text';
    document.getElementById('cr-sort-order').value = '0';
    document.getElementById('canned-response-form').style.display = 'block';
  }

  function editCannedResponse(id, label, message, actionType, sortOrder) {
    editingCannedId = id;
    document.getElementById('cr-form-title').textContent = 'Edit Canned Response';
    document.getElementById('cr-label').value = label;
    document.getElementById('cr-message').value = message;
    document.getElementById('cr-action-type').value = actionType;
    document.getElementById('cr-sort-order').value = sortOrder;
    document.getElementById('canned-response-form').style.display = 'block';
  }

  function cancelCannedResponse() {
    document.getElementById('canned-response-form').style.display = 'none';
    editingCannedId = null;
  }

  async function saveCannedResponse() {
    const label = document.getElementById('cr-label').value.trim();
    const message = document.getElementById('cr-message').value.trim();
    const action_type = document.getElementById('cr-action-type').value;
    const sort_order = parseInt(document.getElementById('cr-sort-order').value) || 0;
    if (!label || !message) { showToast('Label and message required', 'warn'); return; }

    try {
      const url = editingCannedId
        ? `/api/chat/${tenant}/canned-responses/${editingCannedId}`
        : `/api/chat/${tenant}/canned-responses`;
      const method = editingCannedId ? 'PUT' : 'POST';
      const resp = await fetch(url, {
        method,
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ label, message, action_type, sort_order })
      });
      const data = await resp.json();
      if (data.success) {
        showToast(editingCannedId ? 'Updated' : 'Created', 'success');
        cancelCannedResponse();
        loadCannedResponsesAdmin();
      } else {
        showToast(data.error || 'Failed', 'error');
      }
    } catch (e) {
      showToast('Error saving', 'error');
    }
  }

  async function deleteCannedResponse(id) {
    if (!confirm('Delete this canned response?')) return;
    try {
      const resp = await fetch(`/api/chat/${tenant}/canned-responses/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await resp.json();
      if (data.success) {
        showToast('Deleted', 'success');
        loadCannedResponsesAdmin();
      }
    } catch (e) { showToast('Error deleting', 'error'); }
  }

  async function loadHousekeepingInfo() {
    try {
      const res = await fetch(`${API_BASE}/api/admin/housekeeping/info`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      if (!res.ok) return;
      const data = await res.json();
      if (!data.success) return;
      const el = id => document.getElementById(id);
      if (el('hk-plan-name')) el('hk-plan-name').textContent = data.plan || 'unknown';
      if (el('hk-log-days')) el('hk-log-days').textContent = data.retention?.logDays ?? '—';
      if (el('hk-ticket-days')) el('hk-ticket-days').textContent = data.retention?.ticketDays ?? '—';
      if (el('hk-override-days')) el('hk-override-days').value = data.override || '';
    } catch (e) {
      console.error('Error loading housekeeping info:', e);
    }
  }

  async function saveHousekeepingOverride() {
    const val = document.getElementById('hk-override-days')?.value;
    const msgEl = document.getElementById('hk-message');
    const errEl = document.getElementById('hk-error');
    if (msgEl) { msgEl.style.display = 'none'; }
    if (errEl) { errEl.style.display = 'none'; }
    try {
      const res = await fetch(`${API_BASE}/api/admin/housekeeping/override`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ days: val || null })
      });
      const data = await res.json();
      if (data.success) {
        if (msgEl) { msgEl.textContent = val ? 'Override saved — logs will be retained for ' + val + ' days.' : 'Override removed — using plan default.'; msgEl.style.display = 'block'; }
        loadHousekeepingInfo();
      } else {
        if (errEl) { errEl.textContent = data.error || 'Failed to save override'; errEl.style.display = 'block'; }
      }
    } catch (e) {
      if (errEl) { errEl.textContent = 'Error saving override: ' + e.message; errEl.style.display = 'block'; }
    }
  }

  async function runHousekeepingNow() {
    const btn = document.getElementById('hk-run-btn');
    const msgEl = document.getElementById('hk-message');
    const errEl = document.getElementById('hk-error');
    const resultsDiv = document.getElementById('hk-results');
    if (msgEl) { msgEl.style.display = 'none'; }
    if (errEl) { errEl.style.display = 'none'; }
    if (resultsDiv) { resultsDiv.style.display = 'none'; }
    if (btn) { btn.disabled = true; btn.textContent = 'Running...'; }
    try {
      const res = await fetch(`${API_BASE}/api/admin/housekeeping/run`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await res.json();
      if (btn) { btn.disabled = false; btn.textContent = 'Run Now'; }
      if (data.success && data.logs) {
        const rows = Object.entries(data.logs).map(([table, count]) => ({ table, count }));
        if (data.tickets != null) {
          const t = data.tickets;
          rows.push({ table: 'tickets (closed activity)', count: t.activityDeleted || 0 });
          rows.push({ table: 'tickets (closed)', count: t.ticketsDeleted || 0 });
        }
        const tbody = document.getElementById('hk-results-body');
        if (tbody) {
          tbody.innerHTML = rows.map(r =>
            `<tr><td>${r.table}</td><td>${r.count === 'table_not_found' ? 'n/a' : r.count}</td></tr>`
          ).join('');
        }
        if (resultsDiv) resultsDiv.style.display = 'block';
        const total = rows.reduce((s, r) => s + (typeof r.count === 'number' ? r.count : 0), 0);
        if (msgEl) { msgEl.textContent = 'Housekeeping complete — ' + total + ' total rows pruned.'; msgEl.style.display = 'block'; }
      } else {
        if (errEl) { errEl.textContent = data.error || 'Housekeeping failed'; errEl.style.display = 'block'; }
      }
    } catch (e) {
      if (btn) { btn.disabled = false; btn.textContent = 'Run Now'; }
      if (errEl) { errEl.textContent = 'Error: ' + e.message; errEl.style.display = 'block'; }
    }
  }

  // ---------------------------------------------------------------------------
  // Monthly Reports Functions
  // ---------------------------------------------------------------------------
  function _rptTenant() { return window.tenant || 'apoyar'; }

  function loadReportSection() {
    loadReportConfig();
    loadReportHistory();
    initReportGeneratePanel();
  }

  function initReportGeneratePanel() {
    // Populate month selector
    const monthSel = document.getElementById('report-gen-month');
    if (monthSel && monthSel.options.length === 0) {
      const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      months.forEach((m, i) => {
        const opt = document.createElement('option');
        opt.value = i + 1;
        opt.textContent = m;
        monthSel.appendChild(opt);
      });
      // Default to previous month
      const now = new Date();
      const prevMonth = now.getMonth() === 0 ? 12 : now.getMonth();
      monthSel.value = prevMonth;
    }
    // Populate year
    const yearInput = document.getElementById('report-gen-year');
    if (yearInput && !yearInput.value) {
      const now = new Date();
      yearInput.value = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
    }
    // Populate company dropdown
    loadReportCompanyFilter();
  }

  let _companyFilterLoaded = false;
  async function loadReportCompanyFilter() {
    const sel = document.getElementById('report-gen-company');
    if (!sel || _companyFilterLoaded) return;
    _companyFilterLoaded = true;
    try {
      const res = await fetch(`${API_BASE}/api/customer-companies`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      if (res.ok) {
        const data = await res.json();
        const list = Array.isArray(data) ? data : (data.companies || []);
        // Clear any existing company options (keep "All Companies")
        while (sel.options.length > 1) sel.remove(1);
        list.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.company_name;
          sel.appendChild(opt);
        });
      }
    } catch (e) { _companyFilterLoaded = false; }
  }

  async function loadReportConfig() {
    try {
      const res = await fetch(`${API_BASE}/api/reports/${_rptTenant()}/monthly/config`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      if (!res.ok) return;
      const cfg = await res.json();
      const enabledEl = document.getElementById('report-cfg-enabled');
      const recipEl = document.getElementById('report-cfg-recipients');
      const dayEl = document.getElementById('report-cfg-send-day');
      if (enabledEl) enabledEl.checked = cfg.enabled;
      if (recipEl) recipEl.value = (cfg.recipients || []).join(', ');
      if (dayEl) dayEl.value = cfg.sendDay || 1;
    } catch (e) { console.error('Failed to load report config:', e); }
  }

  async function saveReportConfig() {
    const msgEl = document.getElementById('report-cfg-message');
    const errEl = document.getElementById('report-cfg-error');
    if (msgEl) { msgEl.style.display = 'none'; }
    if (errEl) { errEl.style.display = 'none'; }
    const enabled = document.getElementById('report-cfg-enabled')?.checked || false;
    const recipStr = document.getElementById('report-cfg-recipients')?.value || '';
    const recipients = recipStr.split(',').map(s => s.trim()).filter(Boolean);
    const sendDay = parseInt(document.getElementById('report-cfg-send-day')?.value, 10) || 1;

    // Validate emails
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    for (const email of recipients) {
      if (!emailRegex.test(email)) {
        if (errEl) { errEl.textContent = 'Invalid email: ' + email; errEl.style.display = 'inline'; }
        return;
      }
    }
    if (sendDay < 1 || sendDay > 28) {
      if (errEl) { errEl.textContent = 'Send day must be 1-28'; errEl.style.display = 'inline'; }
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/reports/${_rptTenant()}/monthly/config`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        body: JSON.stringify({ enabled, recipients, sendDay })
      });
      const data = await res.json();
      if (res.ok && data.success) {
        if (msgEl) { msgEl.textContent = 'Configuration saved.'; msgEl.style.display = 'inline'; }
      } else {
        if (errEl) { errEl.textContent = data.error || 'Save failed'; errEl.style.display = 'inline'; }
      }
    } catch (e) {
      if (errEl) { errEl.textContent = 'Error: ' + e.message; errEl.style.display = 'inline'; }
    }
  }

  function previewMonthlyReport() {
    const month = document.getElementById('report-gen-month')?.value;
    const year = document.getElementById('report-gen-year')?.value;
    const company = document.getElementById('report-gen-company')?.value || '';
    const includeSystem = document.getElementById('report-gen-include-system')?.checked ? '1' : '0';
    if (!month || !year) return;
    const url = `${API_BASE}/api/reports/${_rptTenant()}/monthly/preview?month=${year}-${String(month).padStart(2,'0')}&company=${company}&includeSystem=${includeSystem}`;
    // Open preview in a modal iframe
    let modal = document.getElementById('report-preview-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'report-preview-modal';
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center';
      modal.innerHTML = `<div style="background:#fff;border-radius:12px;width:90%;max-width:800px;height:85vh;display:flex;flex-direction:column;overflow:hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e2e8f0">
          <strong>Report Preview</strong>
          <button onclick="document.getElementById('report-preview-modal').style.display='none'" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
        </div>
        <iframe id="report-preview-iframe" style="flex:1;border:none;width:100%"></iframe>
      </div>`;
      document.body.appendChild(modal);
    }
    modal.style.display = 'flex';
    const iframe = document.getElementById('report-preview-iframe');
    // Fetch with auth and inject into iframe
    fetch(url, { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') } })
      .then(r => r.text())
      .then(html => {
        iframe.srcdoc = html;
      })
      .catch(e => {
        iframe.srcdoc = '<p style="padding:20px;color:red">Failed to load preview: ' + e.message + '</p>';
      });
  }

  async function sendMonthlyReportNow() {
    const msgEl = document.getElementById('report-gen-message');
    const errEl = document.getElementById('report-gen-error');
    if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
    if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }

    const month = parseInt(document.getElementById('report-gen-month')?.value, 10);
    const year = parseInt(document.getElementById('report-gen-year')?.value, 10);
    const companyFilter = document.getElementById('report-gen-company')?.value || null;
    const includeSystem = document.getElementById('report-gen-include-system')?.checked || false;
    if (!month || !year) {
      if (errEl) { errEl.textContent = 'Please select month and year.'; errEl.style.display = 'block'; }
      return;
    }

    // Prompt for recipients — pre-fill from config field or current user email
    const defaultRecip = document.getElementById('report-cfg-recipients')?.value || window.currentUser?.email || '';
    const emailInput = prompt('Send report to (comma-separated emails):', defaultRecip);
    if (!emailInput) return;
    const recipients = emailInput.split(',').map(s => s.trim()).filter(Boolean);
    if (recipients.length === 0) {
      if (errEl) { errEl.textContent = 'No recipients entered.'; errEl.style.display = 'block'; }
      return;
    }

    const monthName = document.getElementById('report-gen-month')?.selectedOptions[0]?.textContent;
    if (!confirm(`Send ${monthName} ${year} report to ${recipients.join(', ')}?`)) return;

    try {
      const res = await fetch(`${API_BASE}/api/reports/${_rptTenant()}/monthly/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        body: JSON.stringify({ month, year, recipients, companyFilter, includeSystem })
      });
      const data = await res.json();
      if (res.ok && data.success) {
        if (msgEl) { msgEl.textContent = data.message; msgEl.style.display = 'block'; }
        loadReportHistory();
      } else {
        if (msgEl && data.message) { msgEl.textContent = data.message; msgEl.style.display = 'block'; }
        if (errEl && data.error) { errEl.textContent = data.error; errEl.style.display = 'block'; }
        loadReportHistory();
      }
    } catch (e) {
      if (errEl) { errEl.textContent = 'Error: ' + e.message; errEl.style.display = 'block'; }
    }
  }

  async function loadReportHistory() {
    const tbody = document.getElementById('report-history-body');
    if (!tbody) return;
    try {
      const res = await fetch(`${API_BASE}/api/reports/${_rptTenant()}/monthly/history?limit=20`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      if (!res.ok) throw new Error('Failed');
      const history = await res.json();
      if (!history.length) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:16px">No reports sent yet.</td></tr>';
        return;
      }
      const monthNames = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      tbody.innerHTML = history.map(h => {
        let recipients = '';
        try { recipients = JSON.parse(h.recipients_json || '[]').join(', '); } catch { recipients = h.recipients_json || ''; }
        const statusBadge = h.status === 'sent'
          ? '<span style="background:#dcfce7;color:#16a34a;padding:2px 8px;border-radius:4px;font-size:11px">Sent</span>'
          : '<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;font-size:11px">' + (h.status || 'unknown') + '</span>';
        return `<tr>
          <td>${monthNames[h.period_month] || h.period_month} ${h.period_year}</td>
          <td>${h.company_filter || 'All'}</td>
          <td>${h.ticket_count != null ? h.ticket_count : '—'}</td>
          <td>${h.sla_compliance_pct != null ? h.sla_compliance_pct + '%' : '—'}</td>
          <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${recipients}">${recipients || '—'}</td>
          <td>${statusBadge}</td>
          <td>${h.generated_at ? new Date(h.generated_at).toLocaleDateString() : '—'}</td>
        </tr>`;
      }).join('');
    } catch (e) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:16px">Failed to load history.</td></tr>';
    }
  }

  // ---------------------------------------------------------------------------
  // Company Reports Functions (customer / company admin view)
  // ---------------------------------------------------------------------------
  function loadCompanyReports() {
    initCompanyReportPanel();
    loadCompanyReportHistory();
  }

  function initCompanyReportPanel() {
    const monthSel = document.getElementById('cr-report-month');
    if (monthSel && monthSel.options.length === 0) {
      const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      months.forEach((m, i) => {
        const opt = document.createElement('option');
        opt.value = i + 1;
        opt.textContent = m;
        monthSel.appendChild(opt);
      });
      const now = new Date();
      monthSel.value = now.getMonth() === 0 ? 12 : now.getMonth();
    }
    const yearInput = document.getElementById('cr-report-year');
    if (yearInput && !yearInput.value) {
      const now = new Date();
      yearInput.value = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
    }
  }

  function previewCompanyReport() {
    const month = document.getElementById('cr-report-month')?.value;
    const year = document.getElementById('cr-report-year')?.value;
    if (!month || !year) return;
    const tc = _rptTenant();
    const url = `${API_BASE}/api/reports/${tc}/monthly/preview?month=${year}-${String(month).padStart(2,'0')}`;
    let modal = document.getElementById('report-preview-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'report-preview-modal';
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center';
      modal.innerHTML = `<div style="background:#fff;border-radius:12px;width:90%;max-width:800px;height:85vh;display:flex;flex-direction:column;overflow:hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e2e8f0">
          <strong>Report Preview</strong>
          <button onclick="document.getElementById('report-preview-modal').style.display='none'" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
        </div>
        <iframe id="report-preview-iframe" style="flex:1;border:none;width:100%"></iframe>
      </div>`;
      document.body.appendChild(modal);
    }
    modal.style.display = 'flex';
    const iframe = document.getElementById('report-preview-iframe');
    fetch(url, { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') } })
      .then(r => r.text())
      .then(html => { iframe.srcdoc = html; })
      .catch(e => { iframe.srcdoc = '<p style="padding:20px;color:red">Failed to load preview: ' + e.message + '</p>'; });
  }

  async function sendCompanyReport() {
    const msgEl = document.getElementById('cr-report-message');
    const errEl = document.getElementById('cr-report-error');
    if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
    if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }

    const month = parseInt(document.getElementById('cr-report-month')?.value, 10);
    const year = parseInt(document.getElementById('cr-report-year')?.value, 10);
    if (!month || !year) {
      if (errEl) { errEl.textContent = 'Please select month and year.'; errEl.style.display = 'block'; }
      return;
    }

    // Get current user's email as default recipient
    const userEmail = window.currentUser?.email;
    if (!userEmail) {
      if (errEl) { errEl.textContent = 'Could not determine your email address.'; errEl.style.display = 'block'; }
      return;
    }

    const emailInput = prompt('Send report to (comma-separated emails):', userEmail);
    if (!emailInput) return;
    const recipients = emailInput.split(',').map(s => s.trim()).filter(Boolean);
    if (recipients.length === 0) return;

    const monthName = document.getElementById('cr-report-month')?.selectedOptions[0]?.textContent;
    if (!confirm(`Send ${monthName} ${year} report to ${recipients.join(', ')}?`)) return;

    try {
      const res = await fetch(`${API_BASE}/api/reports/${_rptTenant()}/monthly/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        body: JSON.stringify({ month, year, recipients })
      });
      const data = await res.json();
      if (res.ok && data.success) {
        if (msgEl) { msgEl.textContent = data.message; msgEl.style.display = 'block'; }
        loadCompanyReportHistory();
      } else {
        if (errEl) { errEl.textContent = data.error || data.message || 'Send failed'; errEl.style.display = 'block'; }
      }
    } catch (e) {
      if (errEl) { errEl.textContent = 'Error: ' + e.message; errEl.style.display = 'block'; }
    }
  }

  async function loadCompanyReportHistory() {
    const tbody = document.getElementById('cr-report-history-body');
    if (!tbody) return;
    try {
      const res = await fetch(`${API_BASE}/api/reports/${_rptTenant()}/monthly/history?limit=20`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      if (!res.ok) throw new Error('Failed');
      const history = await res.json();
      if (!history.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:16px">No reports sent yet.</td></tr>';
        return;
      }
      const monthNames = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      tbody.innerHTML = history.map(h => {
        const statusBadge = h.status === 'sent'
          ? '<span style="background:#dcfce7;color:#16a34a;padding:2px 8px;border-radius:4px;font-size:11px">Sent</span>'
          : '<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;font-size:11px">' + (h.status || '?') + '</span>';
        return `<tr>
          <td>${monthNames[h.period_month] || h.period_month} ${h.period_year}</td>
          <td>${h.ticket_count != null ? h.ticket_count : '—'}</td>
          <td>${h.sla_compliance_pct != null ? h.sla_compliance_pct + '%' : '—'}</td>
          <td>${statusBadge}</td>
          <td>${h.generated_at ? new Date(h.generated_at).toLocaleDateString() : '—'}</td>
        </tr>`;
      }).join('');
    } catch (e) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:16px">Failed to load history.</td></tr>';
    }
  }

  // Email Ingest Functions
  let currentEmailProvider = 'imap'; // 'imap' or 'm365'
  // Per-provider toggle state
  let imapEnabled = false, imapOutbound = false;
  let m365Enabled = false, m365Outbound = false;

  function selectEmailProvider(provider, skipSave) {
    const enabledEl = document.getElementById('email-ingest-enabled');
    const outboundEl = document.getElementById('email-use-for-outbound');

    // Save current checkbox values to old provider's state (skip when loading from DB)
    if (!skipSave) {
      if (currentEmailProvider === 'imap') {
        if (enabledEl) imapEnabled = enabledEl.checked;
        if (outboundEl) imapOutbound = outboundEl.checked;
      } else {
        if (enabledEl) m365Enabled = enabledEl.checked;
        if (outboundEl) m365Outbound = outboundEl.checked;
      }
    }

    currentEmailProvider = provider;

    // Restore new provider's values into the checkboxes
    if (provider === 'imap') {
      if (enabledEl) enabledEl.checked = imapEnabled;
      if (outboundEl) outboundEl.checked = imapOutbound;
    } else {
      if (enabledEl) enabledEl.checked = m365Enabled;
      if (outboundEl) outboundEl.checked = m365Outbound;
    }
    const imapBtn = document.getElementById('email-provider-imap');
    const m365Btn = document.getElementById('email-provider-m365');
    const imapFields = document.getElementById('email-imap-fields');
    const m365Fields = document.getElementById('email-m365-fields');
    const m365Note = document.getElementById('email-m365-setup-note');

    // Update outbound label per provider
    const outboundLabel = document.getElementById('email-outbound-label');
    if (provider === 'imap') {
      if (imapBtn) { imapBtn.className = 'btn primary'; }
      if (m365Btn) { m365Btn.className = 'btn'; }
      if (imapFields) { imapFields.style.display = 'block'; }
      if (m365Fields) { m365Fields.style.display = 'none'; }
      if (m365Note) { m365Note.style.display = 'none'; }
      if (outboundLabel) outboundLabel.textContent = 'Also use this IMAP account for outbound notifications';
    } else {
      if (imapBtn) { imapBtn.className = 'btn'; }
      if (m365Btn) { m365Btn.className = 'btn primary'; }
      if (imapFields) { imapFields.style.display = 'none'; }
      if (m365Fields) { m365Fields.style.display = 'block'; }
      if (m365Note) { m365Note.style.display = 'block'; }
      if (outboundLabel) outboundLabel.textContent = 'Also use this Microsoft 365 account for outbound notifications';
      loadOAuth2Status();
    }
    toggleOutboundSmtpFields();
  }

  function toggleOutboundSmtpFields() {
    const outboundChecked = document.getElementById('email-use-for-outbound')?.checked;
    const smtpFields = document.getElementById('email-smtp-outbound-fields');
    if (smtpFields) {
      // Show SMTP fields only when outbound is enabled AND provider is IMAP (not O365)
      smtpFields.style.display = (outboundChecked && currentEmailProvider === 'imap') ? 'block' : 'none';
    }
  }

  async function loadOAuth2Status() {
    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`${API_BASE}/api/email-ingest/${tenantCode}/oauth2/status`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      if (!response.ok) return;
      const data = await response.json();
      const statusDiv = document.getElementById('email-m365-status');
      const statusText = document.getElementById('email-m365-status-text');
      const statusDot = document.getElementById('email-m365-status-dot');
      if (data.success && data.connected) {
        if (statusDiv) statusDiv.style.display = 'block';
        if (statusText) statusText.textContent = 'Configured: ' + (data.email || 'Microsoft 365 account');
        if (statusDot) statusDot.style.background = '#16a34a';
        const emailInput = document.getElementById('email-m365-address');
        if (emailInput && data.email) emailInput.value = data.email;
      } else {
        if (statusDiv) statusDiv.style.display = 'none';
      }
    } catch (e) {
      console.error('Error loading OAuth2 status:', e);
    }
  }

  async function disconnectMicrosoft365() {
    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`${API_BASE}/api/email-ingest/${tenantCode}/oauth2/disconnect`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await response.json();
      if (data.success) {
        const statusDiv = document.getElementById('email-m365-status');
        if (statusDiv) statusDiv.style.display = 'none';
        showEmailIngestMessage('Microsoft 365 disconnected');
        setTimeout(() => hideEmailIngestMessages(), 3000);
      } else {
        showEmailIngestError(data.message || 'Error disconnecting');
      }
    } catch (e) {
      showEmailIngestError('Error disconnecting: ' + e.message);
    }
  }

  async function loadEmailIngestSettings() {
    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`${API_BASE}/api/email-ingest/${tenantCode}/settings`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      if (response.status === 403 || response.status === 401 || !response.ok) {
        return; // Silently fail on load
      }

      const data = await response.json();

      if (data.success && data.settings) {
        const settings = data.settings;

        // Store per-provider state from DB
        imapEnabled = !!settings.enabled;
        imapOutbound = !!settings.use_for_outbound;
        m365Enabled = !!settings.m365_enabled;
        m365Outbound = !!settings.m365_use_for_outbound;

        // Load IMAP-specific fields
        const serverTypeEl = document.getElementById('email-server-type');
        if (serverTypeEl) serverTypeEl.value = settings.server_type;
        const serverHostEl = document.getElementById('email-server-host');
        if (serverHostEl) serverHostEl.value = settings.server_host;
        const serverPortEl = document.getElementById('email-server-port');
        if (serverPortEl) serverPortEl.value = settings.server_port;
        const useSslEl = document.getElementById('email-use-ssl');
        if (useSslEl) useSslEl.checked = settings.use_ssl;
        const usernameEl = document.getElementById('email-username');
        if (usernameEl) usernameEl.value = settings.username;
        const passwordEl = document.getElementById('email-password');
        if (passwordEl) passwordEl.value = settings.password;
        const checkIntervalEl = document.getElementById('email-check-interval');
        if (checkIntervalEl) checkIntervalEl.value = settings.check_interval_minutes;

        if (settings.last_checked_at) {
          const lastChecked = new Date(settings.last_checked_at);
          const el = document.getElementById('email-last-checked');
          if (el) el.textContent = 'Last checked: ' + lastChecked.toLocaleString();
        }

        // Load SMTP outbound fields
        const smtpHostEl = document.getElementById('email-smtp-host');
        if (smtpHostEl && settings.smtp_host) smtpHostEl.value = settings.smtp_host;
        const smtpPortEl = document.getElementById('email-smtp-port');
        if (smtpPortEl && settings.smtp_port) smtpPortEl.value = settings.smtp_port;

        // Select the correct provider tab based on auth_method
        // skipSave=true to avoid overwriting the just-loaded state vars
        if (settings.auth_method === 'oauth2') {
          selectEmailProvider('m365', true);
          const emailInput = document.getElementById('email-m365-address');
          if (emailInput && settings.oauth2_email) emailInput.value = settings.oauth2_email;
        } else {
          selectEmailProvider('imap', true);
        }
        toggleOutboundSmtpFields();
      }
    } catch (error) {
      console.error('Error loading email ingest settings:', error);
    }
  }

  async function saveEmailIngestSettings() {
    const enabled = document.getElementById('email-ingest-enabled')?.checked || false;
    const outbound = document.getElementById('email-use-for-outbound')?.checked ? 1 : 0;
    const checkInterval = parseInt(document.getElementById('email-check-interval')?.value) || 5;

    if (enabled && checkInterval < 1 || checkInterval > 60) {
      showEmailIngestError('Check interval must be between 1 and 60 minutes');
      return;
    }

    const payload = {
      check_interval_minutes: checkInterval
    };

    if (currentEmailProvider === 'imap') {
      const serverHost = document.getElementById('email-server-host')?.value || '';
      const serverPort = parseInt(document.getElementById('email-server-port')?.value) || 993;
      const useSsl = document.getElementById('email-use-ssl')?.checked || false;
      const username = document.getElementById('email-username')?.value || '';
      const password = document.getElementById('email-password')?.value || '';

      if (enabled) {
        if (!serverHost || !serverPort || !username) {
          showEmailIngestError('Please fill in all required fields (Server Host, Port, Username)');
          return;
        }
        if (serverPort < 1 || serverPort > 65535) {
          showEmailIngestError('Server port must be between 1 and 65535');
          return;
        }
      }

      payload.auth_method = 'basic';
      payload.enabled = enabled;
      payload.use_for_outbound = outbound;
      payload.server_type = document.getElementById('email-server-type')?.value || 'imap';
      payload.server_host = serverHost;
      payload.server_port = serverPort;
      payload.use_ssl = useSsl;
      payload.username = username;
      payload.password = password || '';
      if (outbound) {
        payload.smtp_host = document.getElementById('email-smtp-host')?.value || null;
        payload.smtp_port = parseInt(document.getElementById('email-smtp-port')?.value) || 587;
      }
    } else {
      // Microsoft 365 - save email address + auth_method
      const m365Email = document.getElementById('email-m365-address')?.value || '';
      if (enabled && !m365Email) {
        showEmailIngestError('Please enter the Microsoft 365 mailbox email address');
        return;
      }
      payload.auth_method = 'oauth2';
      payload.m365_enabled = enabled;
      payload.m365_use_for_outbound = outbound;
      payload.oauth2_email = m365Email;
    }

    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`${API_BASE}/api/email-ingest/${tenantCode}/settings`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (response.status === 403) {
        showEmailIngestError('Admin access required. Please log in as an admin user.');
        return;
      }
      if (response.status === 401) {
        showEmailIngestError('Authentication required. Please log in again.');
        return;
      }
      if (!response.ok) {
        showEmailIngestError(`Error (HTTP ${response.status}): ${data.message || 'Error saving settings'}`);
        return;
      }

      if (data.success) {
        showEmailIngestMessage('Email ingest settings saved successfully!');
        setTimeout(() => hideEmailIngestMessages(), 3000);
        // Reload settings from DB to ensure UI reflects actual saved state
        await loadEmailIngestSettings();
      } else {
        showEmailIngestError(data.message || 'Error saving email ingest settings');
      }
    } catch (error) {
      console.error('Error saving email ingest settings:', error);
      showEmailIngestError('Error saving email ingest settings');
    }
  }

  async function clearEmailIngestSettings() {
    if (!confirm('Clear all email settings? This will disable email ingest and outbound email. No emails will be sent until new settings are configured.')) return;
    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`${API_BASE}/api/email-ingest/${tenantCode}/settings`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await response.json();
      if (data.success) {
        // Reset all form fields
        const fields = {
          'email-ingest-enabled': false,
          'email-server-host': '', 'email-server-port': '993',
          'email-use-ssl': true, 'email-username': '', 'email-password': '',
          'email-check-interval': '5', 'email-use-for-outbound': false,
          'email-smtp-host': '', 'email-smtp-port': '587',
          'email-m365-address': ''
        };
        for (const [id, val] of Object.entries(fields)) {
          const el = document.getElementById(id);
          if (!el) continue;
          if (el.type === 'checkbox') el.checked = val;
          else el.value = val;
        }
        toggleOutboundSmtpFields();
        showEmailIngestMessage('All email settings cleared. No emails will be sent.');
        setTimeout(() => hideEmailIngestMessages(), 4000);
      } else {
        showEmailIngestError(data.message || 'Error clearing settings');
      }
    } catch (error) {
      console.error('Error clearing email settings:', error);
      showEmailIngestError('Error clearing email settings');
    }
  }

  async function testEmailConnection() {
    try {
      const tenantCode = window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`${API_BASE}/api/email-ingest/${tenantCode}/test-connection`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      const data = await response.json();

      if (response.status === 403) {
        showEmailIngestError('Admin access required. Please log in as an admin user.');
        return;
      }
      if (response.status === 401) {
        showEmailIngestError('Authentication required. Please log in again.');
        return;
      }
      if (!response.ok) {
        showEmailIngestError(`Error (HTTP ${response.status}): ${data.message || 'Connection test failed'}`);
        return;
      }

      if (data.success) {
        showEmailIngestMessage('Connection test successful! ' + (data.details?.email ? 'Account: ' + data.details.email : '') + (data.details?.totalMessages != null ? ' Messages: ' + data.details.totalMessages : ''));
        setTimeout(() => hideEmailIngestMessages(), 5000);
      } else {
        showEmailIngestError(data.message || 'Connection test failed');
      }
    } catch (error) {
      console.error('Error testing email connection:', error);
      showEmailIngestError('Error testing email connection');
    }
  }

  function showEmailIngestMessage(message) {
    const messageEl = document.getElementById('email-ingest-message');
    const errorEl = document.getElementById('email-ingest-error');
    if (errorEl) errorEl.style.display = 'none';
    if (messageEl) { messageEl.textContent = message; messageEl.style.display = 'block'; }
  }

  function showEmailIngestError(message) {
    const messageEl = document.getElementById('email-ingest-message');
    const errorEl = document.getElementById('email-ingest-error');
    if (messageEl) messageEl.style.display = 'none';
    if (errorEl) { errorEl.textContent = message; errorEl.style.display = 'block'; }
  }

  function hideEmailIngestMessages() {
    const m = document.getElementById('email-ingest-message');
    const e = document.getElementById('email-ingest-error');
    if (m) m.style.display = 'none';
    if (e) e.style.display = 'none';
  }

  // ========== System Senders Management ==========
  let systemSenders = [];

  async function loadSystemSenders() {
    try {
      const tenantCode = window.tenant || window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`${window.location.protocol}//${window.location.host}/api/tickets/settings/${tenantCode}`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });

      if (!response.ok) return;

      const data = await response.json();
      if (data.success && data.settings && data.settings.system_senders) {
        try {
          systemSenders = JSON.parse(data.settings.system_senders);
          if (!Array.isArray(systemSenders)) systemSenders = [];
        } catch (e) {
          // If not JSON, try comma-separated
          systemSenders = data.settings.system_senders.split(',').map(s => s.trim()).filter(s => s);
        }
      } else {
        systemSenders = [];
      }
      renderSystemSenders();
    } catch (error) {
      console.error('Error loading system senders:', error);
      systemSenders = [];
      renderSystemSenders();
    }
  }

  function renderSystemSenders() {
    const container = document.getElementById('system-senders-items');
    if (!container) return;

    if (systemSenders.length === 0) {
      container.innerHTML = '<div class="subtitle" style="color:#666;font-style:italic">No system senders configured</div>';
      return;
    }

    container.innerHTML = systemSenders.map((sender, idx) => `
      <div class="row" style="background:#f3f4f6;padding:8px 12px;border-radius:4px;margin-bottom:4px;justify-content:space-between;align-items:center">
        <span style="font-family:monospace">${sender}</span>
        <button class="btn" style="padding:4px 8px;font-size:12px" onclick="removeSystemSender(${idx})">Remove</button>
      </div>
    `).join('');
  }

  function addSystemSender() {
    const input = document.getElementById('system-sender-input');
    const sender = input.value.trim().toLowerCase();

    if (!sender) {
      showSystemSendersError('Please enter an email address');
      return;
    }

    // Basic email validation: must contain '@' and '.' after '@'
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(sender)) {
      showSystemSendersError('Please enter a valid email address (e.g. nagios@company.com)');
      return;
    }

    if (systemSenders.includes(sender)) {
      showSystemSendersError('Address already in list');
      return;
    }

    systemSenders.push(sender);
    input.value = '';
    renderSystemSenders();
    hideSystemSendersMessages();
  }

  function removeSystemSender(idx) {
    systemSenders.splice(idx, 1);
    renderSystemSenders();
  }

  async function saveSystemSenders() {
    try {
      const tenantCode = window.tenant || window.currentUser?.tenantCode || 'apoyar';
      const response = await fetch(`${window.location.protocol}//${window.location.host}/api/tickets/settings/${tenantCode}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          key: 'system_senders',
          value: JSON.stringify(systemSenders)
        })
      });

      const data = await response.json();

      if (response.status === 403) {
        showSystemSendersError('Admin access required to save settings');
        return;
      }

      if (data.success) {
        showSystemSendersMessage('System senders saved successfully');
        setTimeout(hideSystemSendersMessages, 3000);
      } else {
        showSystemSendersError(data.message || 'Error saving system senders');
      }
    } catch (error) {
      console.error('Error saving system senders:', error);
      showSystemSendersError('Error saving system senders');
    }
  }

  function showSystemSendersMessage(message) {
    const msgEl = document.getElementById('system-senders-message');
    const errEl = document.getElementById('system-senders-error');
    if (errEl) errEl.style.display = 'none';
    if (msgEl) { msgEl.textContent = message; msgEl.style.display = 'block'; }
  }

  function showSystemSendersError(message) {
    const msgEl = document.getElementById('system-senders-message');
    const errEl = document.getElementById('system-senders-error');
    if (msgEl) msgEl.style.display = 'none';
    if (errEl) { errEl.textContent = message; errEl.style.display = 'block'; }
  }

  function hideSystemSendersMessages() {
    const msgEl = document.getElementById('system-senders-message');
    const errEl = document.getElementById('system-senders-error');
    if (msgEl) msgEl.style.display = 'none';
    if (errEl) errEl.style.display = 'none';
  }


  // Usage Dashboard Functions
  async function loadUsageDashboard() {
    try {
      const tenantId = window.tenant || 'apoyar'; // Default to apoyar for now
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/usage/${tenantId}`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      const data = await response.json();

      if (data.success) {
        // Transform backend data format to frontend format
        const transformedUsage = {
          users: {
            current: data.usage.users.total,
            limit: data.usage.users.limit,
            percentage: data.usage.users.limit > 0 ? (data.usage.users.total / data.usage.users.limit * 100) : 0
          },
          tickets: {
            current: data.usage.tickets.total,
            limit: data.usage.tickets.limit,
            percentage: data.usage.tickets.limit > 0 ? (data.usage.tickets.total / data.usage.tickets.limit * 100) : 0
          },
          storage: {
            current: data.usage.storage.used,
            limit: data.usage.storage.limit,
            percentage: data.usage.storage.limit > 0 ? (data.usage.storage.used / data.usage.storage.limit * 100) : 0
          }
        };
        updateUsageDisplay(transformedUsage);
        updateUsageAlerts(transformedUsage);
      } else {
        console.error('Error loading usage:', data.message);
        document.getElementById('usage-alerts').innerHTML = '<div class="usage-alert danger">Error loading usage data: ' + (data.message || '') + '</div>';
        // Show empty usage display
        updateUsageDisplay({
          users: { current: 0, limit: 0, percentage: 0 },
          tickets: { current: 0, limit: 0, percentage: 0 },
          storage: { current: 0, limit: 0, percentage: 0 },
          overallPercentage: 0
        });
      }
    } catch (error) {
      console.error('Error loading usage dashboard:', error);
      document.getElementById('usage-alerts').innerHTML = '<div class="usage-alert danger">Error loading usage data</div>';
    }
  }
  
  function updateUsageDisplay(usage) {
    // Update users
    document.getElementById('usage-users-current').textContent = usage.users.current;
    document.getElementById('usage-users-limit').textContent = usage.users.limit === -1 ? '∞' : usage.users.limit;
    document.getElementById('usage-users-progress').style.width = Math.min(usage.users.percentage, 100) + '%';
    
    // Update tickets
    document.getElementById('usage-tickets-current').textContent = usage.tickets.current;
    document.getElementById('usage-tickets-limit').textContent = usage.tickets.limit === -1 ? '∞' : usage.tickets.limit;
    document.getElementById('usage-tickets-progress').style.width = Math.min(usage.tickets.percentage, 100) + '%';
    
    // Update storage
    document.getElementById('usage-storage-current').textContent = usage.storage.current;
    document.getElementById('usage-storage-limit').textContent = usage.storage.limit === -1 ? '∞' : usage.storage.limit;
    document.getElementById('usage-storage-progress').style.width = Math.min(usage.storage.percentage, 100) + '%';
  }
  
  function updateUsageAlerts(usage) {
    const alerts = [];
    
    // Check for usage warnings (80%+ usage)
    if (usage.users.percentage >= 80) {
      alerts.push({
        type: usage.users.percentage >= 100 ? 'danger' : 'warning',
        message: `Users: ${usage.users.current}/${usage.users.limit} (${Math.round(usage.users.percentage)}%)`
      });
    }
    
    if (usage.tickets.percentage >= 80) {
      alerts.push({
        type: usage.tickets.percentage >= 100 ? 'danger' : 'warning',
        message: `Tickets: ${usage.tickets.current}/${usage.tickets.limit} (${Math.round(usage.tickets.percentage)}%)`
      });
    }
    
    if (usage.storage.percentage >= 80) {
      alerts.push({
        type: usage.storage.percentage >= 100 ? 'danger' : 'warning',
        message: `Storage: ${usage.storage.current}GB/${usage.storage.limit}GB (${Math.round(usage.storage.percentage)}%)`
      });
    }
    
    // Display alerts
    const alertsContainer = document.getElementById('usage-alerts');
    if (alerts.length === 0) {
      alertsContainer.innerHTML = '<div class="usage-alert info">✅ All usage within limits</div>';
    } else {
      alertsContainer.innerHTML = alerts.map(alert => 
        `<div class="usage-alert ${alert.type}">⚠️ ${alert.message}</div>`
      ).join('');
    }
  }
  
  async function testUsageLimit(type, amount) {
    try {
      const tenantId = window.tenant || 'apoyar';
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/tenant/${tenantId}/usage/update`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ type, increment: amount })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert(`✅ ${type} usage updated successfully!`);
        loadUsageDashboard(); // Refresh the display
      } else {
        if (data.limitExceeded) {
          alert(`❌ Limit exceeded: ${data.message}`);
        } else {
          alert(`❌ Error: ${data.message}`);
        }
      }
    } catch (error) {
      console.error('Error testing usage limit:', error);
      alert('❌ Error testing usage limit');
    }
  }
  
  function refreshUsage() {
    loadUsageDashboard();
  }
  
  // Customer Portal Functions
  async function loadCustomerPlans() {
    try {
      const tenantId = window.tenant || 'apoyar';
      
      // Load current subscription
      const usageResponse = await fetch(window.location.protocol + '//' + window.location.host + `/api/tenant/${tenantId}/usage`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      const usageData = await usageResponse.json();
      
      if (usageData.success) {
        // Get subscription details
        const masterData = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/subscriptions', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });
        
        const masterResponse = await masterData.json();
        const currentSubscription = masterResponse.subscriptions?.find(s => s.tenantId === tenantId);
        
        if (currentSubscription) {
          displayCurrentPlan(currentSubscription);
        }
      }
      
      // Load available plans
      const plansResponse = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/plans', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      const plansData = await plansResponse.json();
      
      if (plansData.success) {
        displayPlanComparison(plansData.plans, tenantId);
      }
      
    } catch (error) {
      console.error('Error loading customer plans:', error);
      document.getElementById('current-plan-info').innerHTML = '<div class="usage-alert danger">Error loading plan information</div>';
    }
  }
  
  function displayCurrentPlan(subscription) {
    const planInfo = document.getElementById('current-plan-info');
    const planName = subscription.plan.charAt(0).toUpperCase() + subscription.plan.slice(1);
    const maxUsers = subscription.maxUsers === -1 ? '∞' : subscription.maxUsers;
    const maxTickets = subscription.maxTickets === -1 ? '∞' : subscription.maxTickets;
    const maxStorage = subscription.maxStorage === -1 ? '∞' : subscription.maxStorage + 'GB';
    
    planInfo.innerHTML = `
      <div class="card p-16" style="background: #f8f9fa; border-left: 4px solid #007bff;">
        <div class="row space mb-12">
          <div>
            <h4 style="margin:0;color:#007bff;">${planName} Plan</h4>
            <div class="subtitle">$${subscription.monthlyPrice}/month</div>
          </div>
          <div class="badge plan-${subscription.plan}">${subscription.status.toUpperCase()}</div>
        </div>
        <div class="grid3">
          <div>
            <div class="subtitle">Users</div>
            <div style="font-weight:600">${subscription.currentUsers}/${maxUsers}</div>
          </div>
          <div>
            <div class="subtitle">Tickets/Month</div>
            <div style="font-weight:600">${subscription.currentTickets}/${maxTickets}</div>
          </div>
          <div>
            <div class="subtitle">Storage</div>
            <div style="font-weight:600">${subscription.currentStorage}GB/${maxStorage}</div>
          </div>
        </div>
        <div class="mt-12">
          <div class="subtitle">Features:</div>
          <div style="font-size:14px;color:#666;">${subscription.features.join(', ')}</div>
        </div>
      </div>
    `;
  }
  
  function displayPlanComparison(plans, currentTenantId) {
    const comparison = document.getElementById('plan-comparison');
    
    const planCards = plans.map(plan => {
      const isCurrentPlan = plan.id === 'starter' || plan.id === 'trial'; // This would need to be determined from current subscription
      const maxUsers = plan.maxUsers === -1 ? '∞' : plan.maxUsers;
      const maxTickets = plan.maxTickets === -1 ? '∞' : plan.maxTickets;
      const maxStorage = plan.maxStorage === -1 ? '∞' : plan.maxStorage + 'GB';
      
      return `
        <div class="card p-16 ${isCurrentPlan ? 'current-plan' : ''}" style="border: 2px solid ${isCurrentPlan ? '#007bff' : '#e0e0e0'}; ${isCurrentPlan ? 'background: #f8f9fa;' : ''}">
          <div class="row space mb-12">
            <div>
              <h4 style="margin:0;color:${isCurrentPlan ? '#007bff' : '#333'};">${plan.name} Plan</h4>
              <div class="subtitle">$${plan.monthlyPrice}/month</div>
            </div>
            ${isCurrentPlan ? '<div class="badge" style="background:#007bff;color:white;">CURRENT</div>' : ''}
          </div>
          <div class="grid3 mb-12">
            <div>
              <div class="subtitle">Users</div>
              <div style="font-weight:600;font-size:18px;">${maxUsers}</div>
            </div>
            <div>
              <div class="subtitle">Tickets/Month</div>
              <div style="font-weight:600;font-size:18px;">${maxTickets}</div>
            </div>
            <div>
              <div class="subtitle">Storage</div>
              <div style="font-weight:600;font-size:18px;">${maxStorage}</div>
            </div>
          </div>
          <div class="mb-12">
            <div class="subtitle">Features:</div>
            <div style="font-size:14px;color:#666;">${plan.features.join(', ')}</div>
          </div>
          ${!isCurrentPlan ? `<button class="btn primary" onclick="showUpgradeForm('${plan.id}')" style="width:100%;">Upgrade to ${plan.name}</button>` : ''}
        </div>
      `;
    }).join('');
    
    comparison.innerHTML = `<div class="grid3">${planCards}</div>`;
  }
  
  function showUpgradeForm(planId) {
    // This would show upgrade confirmation form
    alert(`Upgrade to ${planId} plan - This would show upgrade confirmation in a real system`);
  }
  
  function hideUpgradeForm() {
    document.getElementById('upgrade-form').style.display = 'none';
  }
  
  function confirmUpgrade() {
    alert('Upgrade confirmed - This would process the upgrade in a real system');
    hideUpgradeForm();
  }
  
  function refreshCustomerPlans() {
    loadCustomerPlans();
  }

  // ---- Tenant Settings & Company Management Functions ----

  // Load tenant settings and configure nav visibility
  async function loadTenantSettingsForNav() {
    try {
      const tenantCode = window.tenant || localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/tenant-settings/${tenantCode}/settings`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });

      if (response.ok) {
        const data = await response.json();
        window.tenantSettings = {};

        // Convert settings array to object
        if (data.settings) {
          data.settings.forEach(s => {
            let value = s.setting_value;
            if (s.setting_type === 'boolean') value = value === 'true';
            else if (s.setting_type === 'number') value = Number(value);
            else if (s.setting_type === 'json') value = JSON.parse(value || '{}');
            window.tenantSettings[s.setting_key] = value;
          });
        }

        // Show/hide billing nav items based on tenant settings
        const billingNav = document.getElementById('nav-customer-billing');
        const plansNav = document.getElementById('nav-customer-plans');
        const billingEnabled = window.tenantSettings.customer_billing_enabled === true;

        if (billingNav) billingNav.style.display = billingEnabled ? 'block' : 'none';
        if (plansNav) plansNav.style.display = billingEnabled ? 'block' : 'none';
      }
    } catch (error) {
      console.error('Error loading tenant settings:', error);
    }
  }

  // ---- My Company View ----
  async function loadMyCompany() {
    try {
      const tenantCode = window.tenant || localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/company-admin/${tenantCode}/my-company`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });

      if (!response.ok) {
        throw new Error('Failed to load company info');
      }

      const data = await response.json();
      const company = data.company;

      // Populate company info
      document.getElementById('my-company-name').textContent = company.name || '-';
      document.getElementById('my-company-domain').textContent = company.domain || '-';
      document.getElementById('my-company-phone').textContent = company.phone || '-';
      document.getElementById('my-company-address').textContent = company.address || '-';
      document.getElementById('my-company-sla').textContent = company.sla || 'Default SLA';
      document.getElementById('my-company-user-count').textContent = company.userCount || 0;

      // If user is a company admin, load full user list
      if (company.isAdmin) {
        loadMyCompanyUsers();
      } else {
        // Show limited user list info
        document.getElementById('my-company-users-body').innerHTML =
          `<tr><td colspan="4" class="subtitle">You have ${company.userCount} users in your company</td></tr>`;
      }

    } catch (error) {
      console.error('Error loading company:', error);
      document.getElementById('my-company-name').textContent = 'Error loading company';
    }
  }

  // Load users for My Company view (read-only list)
  async function loadMyCompanyUsers() {
    try {
      const tenantCode = window.tenant || localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/company-admin/${tenantCode}/my-company/users`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });

      if (!response.ok) {
        throw new Error('Failed to load users');
      }

      const data = await response.json();
      const tbody = document.getElementById('my-company-users-body');

      if (data.users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="subtitle">No users found</td></tr>';
        return;
      }

      tbody.innerHTML = data.users.map(u => `
        <tr>
          <td>${u.fullName || u.username}</td>
          <td>${u.email}</td>
          <td>${u.isCompanyAdmin ? '<span style="color:#16a34a">Admin</span>' : 'User'}</td>
          <td><span class="${u.isActive ? 'badge-sla-ok' : 'badge-sla-breached'}">${u.isActive ? 'Active' : 'Disabled'}</span></td>
        </tr>
      `).join('');

    } catch (error) {
      console.error('Error loading company users:', error);
      document.getElementById('my-company-users-body').innerHTML =
        '<tr><td colspan="4" class="subtitle">Error loading users</td></tr>';
    }
  }

  // ---- Company Admin View ----
  async function loadCompanyAdminUsers() {
    try {
      const tenantCode = window.tenant || localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/company-admin/${tenantCode}/my-company/users`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.message || 'Failed to load users');
      }

      const data = await response.json();
      const users = data.users;

      // Update stats
      const activeCount = users.filter(u => u.isActive).length;
      const disabledCount = users.filter(u => !u.isActive).length;
      document.getElementById('company-admin-total-users').textContent = users.length;
      document.getElementById('company-admin-active-users').textContent = activeCount;
      document.getElementById('company-admin-disabled-users').textContent = disabledCount;

      // Render table
      const tbody = document.getElementById('company-admin-users-body');

      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="subtitle">No users found</td></tr>';
        return;
      }

      const currentUserId = window.currentUser?.id;

      tbody.innerHTML = users.map(u => {
        const isCurrentUser = u.id === currentUserId;
        const lastLogin = u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() : 'Never';
        const canToggle = !isCurrentUser && !u.isCompanyAdmin;

        return `
          <tr>
            <td>${u.fullName || u.username}</td>
            <td>${u.email}</td>
            <td>${u.jobTitle || '-'}</td>
            <td>${u.isCompanyAdmin ? '<span style="color:#16a34a;font-weight:600">Admin</span>' : 'User'}</td>
            <td><span class="${u.isActive ? 'badge-sla-ok' : 'badge-sla-breached'}">${u.isActive ? 'Active' : 'Disabled'}</span></td>
            <td>${lastLogin}</td>
            <td>
              ${canToggle ? `<button class="btn ghost" onclick="toggleCompanyUser(${u.id})">${u.isActive ? 'Disable' : 'Enable'}</button>` : '<span class="subtitle">-</span>'}
            </td>
          </tr>
        `;
      }).join('');

    } catch (error) {
      console.error('Error loading company admin users:', error);
      document.getElementById('company-admin-users-body').innerHTML =
        `<tr><td colspan="7" class="subtitle">Error: ${error.message}</td></tr>`;
    }
  }

  // Toggle user enable/disable
  async function toggleCompanyUser(userId) {
    try {
      const tenantCode = window.tenant || localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/company-admin/${tenantCode}/my-company/users/${userId}/toggle`, {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token'),
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'Failed to toggle user');
      }

      showToast(data.message, 'success');
      loadCompanyAdminUsers(); // Refresh the list

    } catch (error) {
      console.error('Error toggling user:', error);
      showToast(error.message, 'error');
    }
  }

  // Invite user modal controls
  function showInviteUserModal() {
    document.getElementById('invite-user-email').value = '';
    document.getElementById('invite-user-name').value = '';
    document.getElementById('invite-user-title').value = '';
    document.getElementById('invite-user-modal').style.display = 'flex';
  }

  function hideInviteUserModal() {
    document.getElementById('invite-user-modal').style.display = 'none';
  }

  // Send invite to new user
  async function inviteCompanyUser() {
    const email = document.getElementById('invite-user-email').value.trim();
    const fullName = document.getElementById('invite-user-name').value.trim();
    const jobTitle = document.getElementById('invite-user-title').value.trim();

    if (!email) {
      showToast('Email is required', 'error');
      return;
    }

    try {
      const tenantCode = window.tenant || localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/company-admin/${tenantCode}/my-company/invite`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, fullName, jobTitle })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'Failed to invite user');
      }

      hideInviteUserModal();
      showToast(`User invited successfully! Temporary password: ${data.user.tempPassword}`, 'success');
      loadCompanyAdminUsers(); // Refresh the list

    } catch (error) {
      console.error('Error inviting user:', error);
      showToast(error.message, 'error');
    }
  }

  // Customer Billing Functions
  async function loadCustomerBilling() {
    try {
      const tenantId = window.tenant || 'apoyar';
      
      // Load subscription details
      const masterData = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/subscriptions', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      const masterResponse = await masterData.json();
      const currentSubscription = masterResponse.subscriptions?.find(s => s.tenantId === tenantId);
      
      if (currentSubscription) {
        displayBillingSummary(currentSubscription);
        displayPaymentMethod();
        displayInvoiceHistory();
      } else {
        document.getElementById('billing-current-plan').textContent = 'No subscription found';
      }
      
    } catch (error) {
      console.error('Error loading customer billing:', error);
      document.getElementById('billing-current-plan').textContent = 'Error loading billing';
    }
  }
  
  function displayBillingSummary(subscription) {
    const planName = subscription.plan.charAt(0).toUpperCase() + subscription.plan.slice(1);
    const nextBillingDate = new Date(subscription.nextBillingDate).toLocaleDateString();
    
    document.getElementById('billing-current-plan').textContent = planName;
    document.getElementById('billing-next-date').textContent = nextBillingDate;
    document.getElementById('billing-monthly-cost').textContent = '$' + subscription.monthlyPrice;
  }
  
  function displayPaymentMethod() {
    const paymentInfo = document.getElementById('payment-method-info');
    paymentInfo.innerHTML = `
      <div class="row space">
        <div>
          <div class="subtitle">Card ending in 1234</div>
          <div style="font-size:14px;color:#666;">Expires 12/25</div>
        </div>
        <button class="btn">Update Payment Method</button>
      </div>
      <div class="subtitle" style="margin-top:8px;">This is demo data - in a real system, this would show actual payment method details</div>
    `;
  }
  
  function displayInvoiceHistory() {
    const invoiceBody = document.getElementById('invoice-list-body');
    
    // Mock invoice data
    const invoices = [
      { id: 'INV-001', date: '2025-09-01', amount: 29, status: 'Paid' },
      { id: 'INV-002', date: '2025-08-01', amount: 29, status: 'Paid' },
      { id: 'INV-003', date: '2025-07-01', amount: 29, status: 'Paid' }
    ];
    
    invoiceBody.innerHTML = invoices.map(invoice => `
      <tr>
        <td>${invoice.id}</td>
        <td>${new Date(invoice.date).toLocaleDateString()}</td>
        <td>$${invoice.amount}</td>
        <td><span class="badge status-${invoice.status.toLowerCase()}">${invoice.status}</span></td>
        <td>
          <button class="btn btn-sm" onclick="viewInvoice('${invoice.id}')">View</button>
          <button class="btn btn-sm" onclick="downloadInvoice('${invoice.id}')">Download</button>
        </td>
      </tr>
    `).join('');
  }
  
  function viewInvoice(invoiceId) {
    alert(`View invoice ${invoiceId} - This would open the invoice in a new window`);
  }
  
  function downloadInvoice(invoiceId) {
    alert(`Download invoice ${invoiceId} - This would download the PDF invoice`);
  }
  
  function refreshCustomerBilling() {
    loadCustomerBilling();
  }
  
  // Analytics Functions
  async function loadAnalytics() {
    console.log('loadAnalytics() called');

    try {
      const tenantId = window.tenant || 'apoyar';
      const url = window.location.protocol + '//' + window.location.host + `/api/analytics/${tenantId}?period=30`;

      console.log('Fetching analytics from:', url);

      // Load analytics data from new endpoint
      const analyticsResponse = await fetch(url, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      console.log('Analytics response status:', analyticsResponse.status);

      const analyticsData = await analyticsResponse.json();
      console.log('Analytics data received:', analyticsData);

      if (analyticsData.success) {
        console.log('Analytics loaded successfully, calling displayAnalyticsFromAPI');
        displayAnalyticsFromAPI(analyticsData.analytics);
      } else {
        console.error('Analytics API returned success=false:', analyticsData);
        document.getElementById('analytics-total-tickets').textContent = 'Error';
      }

    } catch (error) {
      console.error('Error in loadAnalytics:', error);
      document.getElementById('analytics-total-tickets').textContent = 'Error';
    }
  }

  function displayAnalyticsFromAPI(analytics) {
    console.log('displayAnalyticsFromAPI called with:', analytics);

    try {
      // Update summary cards using analytics data (convert strings to numbers)
      const totalTickets = parseInt(analytics.tickets.total) || 0;
      const openTickets = parseInt(analytics.tickets.byStatus.open) || 0;
      const resolvedCount = parseInt(analytics.tickets.byStatus.resolved) || 0;

      console.log('Setting analytics values:', { totalTickets, openTickets, resolvedCount });

      document.getElementById('analytics-total-tickets').textContent = totalTickets;
      document.getElementById('analytics-open-tickets').textContent = openTickets;
      document.getElementById('analytics-resolved-today').textContent = resolvedCount;

      // Display average response time from performance data
      const avgTime = analytics.performance.avgResolutionTimeHours;
      document.getElementById('analytics-avg-response').textContent = avgTime ? Math.round(avgTime) + 'h' : '0h';

      // Create charts from analytics data with error handling
      if (analytics.tickets.byStatus) {
        createStatusChartFromAnalytics(analytics.tickets.byStatus);
      }
      if (analytics.tickets.byPriority) {
        createPriorityChartFromAnalytics(analytics.tickets.byPriority);
      }
      displayRecentActivity(analytics.recentActivity || []);  // Use recent tickets from API

      console.log('Analytics display completed successfully');
    } catch (error) {
      console.error('Error in displayAnalyticsFromAPI:', error);
      throw error; // Re-throw to be caught by outer try-catch
    }
  }

  function createStatusChartFromAnalytics(byStatus) {
    try {
      const chartContainer = document.getElementById('ticket-status-chart');

      if (!chartContainer) {
        console.error('Status chart container not found');
        return;
      }

      const colors = {
        'open': '#ff9800',
        'in_progress': '#2196f3',
        'resolved': '#4caf50',
        'closed': '#9e9e9e'
      };

      const statusLabels = {
        'open': 'Open',
        'in_progress': 'In Progress',
        'resolved': 'Resolved',
        'closed': 'Closed'
      };

      // Convert string counts to numbers and calculate total
      const total = Object.values(byStatus).reduce((sum, count) => sum + parseInt(count || 0), 0);

      let chartHtml = '<div style="display:flex;flex-direction:column;gap:8px;width:100%;">';
      Object.entries(byStatus).forEach(([status, count]) => {
        const numCount = parseInt(count || 0);
        const percentage = total > 0 ? (numCount / total) * 100 : 0;
        const label = statusLabels[status] || status;
        chartHtml += `
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:12px;height:12px;background:${colors[status] || '#666'};border-radius:2px;"></div>
            <div style="flex:1;font-size:14px;">${label}</div>
            <div style="font-weight:600;">${numCount}</div>
            <div style="font-size:12px;color:#666;">${percentage.toFixed(1)}%</div>
          </div>
        `;
      });
      chartHtml += '</div>';

      chartContainer.innerHTML = chartHtml;
    } catch (error) {
      console.error('Error in createStatusChartFromAnalytics:', error);
    }
  }

  function createPriorityChartFromAnalytics(byPriority) {
    try {
      const chartContainer = document.getElementById('priority-chart');

      if (!chartContainer) {
        console.error('Priority chart container not found');
        return;
      }

      const colors = {
        'critical': '#f44336',
        'high': '#ff9800',
        'medium': '#ffc107',
        'low': '#4caf50'
      };

      const priorityLabels = {
        'critical': 'Critical',
        'high': 'High',
        'medium': 'Medium',
        'low': 'Low'
      };

      // Convert string counts to numbers and calculate total
      const total = Object.values(byPriority).reduce((sum, count) => sum + parseInt(count || 0), 0);

      let chartHtml = '<div style="display:flex;flex-direction:column;gap:8px;width:100%;">';
      Object.entries(byPriority).forEach(([priority, count]) => {
        const numCount = parseInt(count || 0);
        const percentage = total > 0 ? (numCount / total) * 100 : 0;
        const label = priorityLabels[priority] || priority;
        chartHtml += `
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:12px;height:12px;background:${colors[priority] || '#666'};border-radius:2px;"></div>
            <div style="flex:1;font-size:14px;">${label}</div>
            <div style="font-weight:600;">${numCount}</div>
            <div style="font-size:12px;color:#666;">${percentage.toFixed(1)}%</div>
          </div>
        `;
      });
      chartHtml += '</div>';

      chartContainer.innerHTML = chartHtml;
    } catch (error) {
      console.error('Error in createPriorityChartFromAnalytics:', error);
    }
  }
  
  // Old functions removed - now using API-based analytics functions above

  function displayRecentActivity(tickets) {
    const recentTickets = tickets
      .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
      .slice(0, 10);
    
    const activityContainer = document.getElementById('recent-activity');
    
    if (recentTickets.length === 0) {
      activityContainer.innerHTML = '<div class="subtitle">No recent activity</div>';
      return;
    }
    
    let activityHtml = '<div style="display:flex;flex-direction:column;gap:8px;">';
    recentTickets.forEach(ticket => {
      const timeAgo = getTimeAgo(new Date(ticket.updatedAt));
      activityHtml += `
        <div style="display:flex;align-items:center;gap:12px;padding:8px;background:#f8f9fa;border-radius:4px;">
          <div style="width:8px;height:8px;background:#2196f3;border-radius:50%;"></div>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:14px;">Ticket #${ticket.id}</div>
            <div style="font-size:12px;color:#666;">${ticket.title}</div>
          </div>
          <div style="font-size:12px;color:#666;">${timeAgo}</div>
        </div>
      `;
    });
    activityHtml += '</div>';
    
    activityContainer.innerHTML = activityHtml;
  }
  
  function getTimeAgo(date) {
    const now = new Date();
    const diffInMinutes = Math.floor((now - date) / (1000 * 60));
    
    if (diffInMinutes < 1) return 'Just now';
    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) return `${diffInHours}h ago`;
    
    const diffInDays = Math.floor(diffInHours / 24);
    return `${diffInDays}d ago`;
  }
  
  function refreshAnalytics() {
    loadAnalytics();
  }

  // Export Functions
  function exportTicketsToCSV() {
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Please login first');
      return;
    }

    const tenant = window.tenant || localStorage.getItem('tenantCode') || 'apoyar';

    // Create a link and trigger download
    const url = `${API_BASE}/api/tickets/${tenant}/export/csv`;
    const link = document.createElement('a');
    link.href = url;
    link.download = `tickets_${tenant}_${Date.now()}.csv`;

    // Add authorization header via fetch
    fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Export failed');
      return response.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `tickets_${tenant}_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    })
    .catch(error => {
      console.error('Error exporting tickets:', error);
      alert('Failed to export tickets. Please try again.');
    });
  }

  function exportAnalyticsToCSV() {
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Please login first');
      return;
    }

    const tenant = window.tenant || localStorage.getItem('tenantCode') || 'apoyar';
    const period = 30; // Default to 30 days

    // Fetch and download
    fetch(`${API_BASE}/api/analytics/${tenant}/export/csv?period=${period}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Export failed');
      return response.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `analytics_${tenant}_${period}days_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    })
    .catch(error => {
      console.error('Error exporting analytics:', error);
      alert('Failed to export analytics. Please try again.');
    });
  }

  // Email Processing Functions
  async function loadEmailProcessing() {
    try {
      // Load email settings
      const settingsResponse = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/email-settings', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      const settingsData = await settingsResponse.json();
      
      if (settingsData.success) {
        displayEmailSettings(settingsData.settings);
      }
      
      // Load tenant email settings
      const tenantsResponse = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/tenants', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      const tenantsData = await tenantsResponse.json();
      
      if (tenantsData.success) {
        displayTenantEmailSettings(tenantsData.tenants);
      }
      
    } catch (error) {
      console.error('Error loading email processing:', error);
      document.getElementById('email-settings-info').innerHTML = '<div class="usage-alert danger">Error loading email settings</div>';
    }
  }
  
  function displayEmailSettings(settings) {
    const settingsInfo = document.getElementById('email-settings-info');
    const configHelp = document.getElementById('email-configuration-help');
    
    if (settings.needsConfiguration) {
      settingsInfo.innerHTML = `
        <div class="grid3">
          <div>
            <div class="subtitle">IMAP Host</div>
            <div style="font-weight:600;">${settings.imap.host}</div>
          </div>
          <div>
            <div class="subtitle">IMAP Port</div>
            <div style="font-weight:600;">${settings.imap.port}</div>
          </div>
          <div>
            <div class="subtitle">Check Interval</div>
            <div style="font-weight:600;">${settings.checkInterval / 1000}s</div>
          </div>
        </div>
        <div class="mt-12">
          <div class="subtitle">Status</div>
          <div style="font-weight:600;color:#ff9800;">${settings.status} (Demo Mode)</div>
        </div>
      `;
      configHelp.style.display = 'block';
    } else {
      settingsInfo.innerHTML = `
        <div class="grid3">
          <div>
            <div class="subtitle">IMAP Host</div>
            <div style="font-weight:600;">${settings.imap.host}</div>
          </div>
          <div>
            <div class="subtitle">IMAP Port</div>
            <div style="font-weight:600;">${settings.imap.port}</div>
          </div>
          <div>
            <div class="subtitle">Check Interval</div>
            <div style="font-weight:600;">${settings.checkInterval / 1000}s</div>
          </div>
        </div>
        <div class="mt-12">
          <div class="subtitle">Status</div>
          <div style="font-weight:600;color:#4caf50;">${settings.status}</div>
        </div>
        <div class="mt-8">
          <div class="subtitle">Email Account</div>
          <div style="font-weight:600;">${settings.imap.user}</div>
        </div>
      `;
      configHelp.style.display = 'none';
    }
  }
  
  function displayTenantEmailSettings(tenants) {
    const tenantBody = document.getElementById('tenant-email-list-body');
    
    tenantBody.innerHTML = tenants.map(tenant => `
      <tr>
        <td>${tenant.companyName || tenant.tenantId}</td>
        <td>${tenant.domain || 'Not set'}</td>
        <td>
          <span class="badge ${tenant.emailProcessingEnabled ? 'status-active' : 'status-inactive'}">
            ${tenant.emailProcessingEnabled ? 'Enabled' : 'Disabled'}
          </span>
        </td>
        <td>
          <button class="btn btn-sm" onclick="editTenantEmailSettings('${tenant.tenantId}')">Edit</button>
        </td>
      </tr>
    `).join('');
  }
  
  async function testEmailProcessing() {
    try {
      const email = document.getElementById('test-email').value;
      const subject = document.getElementById('test-subject').value;
      const message = document.getElementById('test-message').value;
      
      if (!email) {
        alert('Please enter an email address');
        return;
      }
      
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/email-settings/test', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ email, subject, message })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('Email processing test completed! Check the server logs for details.');
      } else {
        alert('Error testing email processing: ' + data.message);
      }
      
    } catch (error) {
      console.error('Error testing email processing:', error);
      alert('Error testing email processing');
    }
  }
  
  async function editTenantEmailSettings(tenantId) {
    const domain = prompt('Enter email domain for this tenant (e.g., company.com):');
    if (domain === null) return;
    
    const enabled = confirm('Enable email processing for this tenant?');
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/tenants/${tenantId}/email-settings`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ domain, emailProcessingEnabled: enabled })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('Tenant email settings updated successfully!');
        loadEmailProcessing(); // Refresh the view
      } else {
        alert('Error updating tenant email settings: ' + data.message);
      }
      
    } catch (error) {
      console.error('Error updating tenant email settings:', error);
      alert('Error updating tenant email settings');
    }
  }
  
  function refreshEmailSettings() {
    loadEmailProcessing();
  }
  
  async function editTenant(tenantId) {
    try {
      // First, get the current tenant data
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/tenants', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      const data = await response.json();
      if (!data.success) {
        alert('Error loading tenant data');
        return;
      }

      const tenant = data.tenants.find(t => t.id === tenantId);
      if (!tenant) {
        alert('Tenant not found');
        return;
      }

      // Show edit form with current data
      showEditTenantForm(tenant);
    } catch (error) {
      console.error('Error loading tenant:', error);
      alert('Error loading tenant data');
    }
  }
  
  // Store tenant info for delete/restore confirmation
  let pendingDeleteTenantId = null;
  let pendingPermDeleteTenantId = null;
  let pendingPermDeleteTenantCode = null;

  function deleteTenant(tenantId, name, code) {
    console.log('Deactivate tenant clicked:', tenantId);
    pendingDeleteTenantId = tenantId;
    const modal = document.getElementById('delete-tenant-modal');
    const nameEl = document.getElementById('delete-tenant-name');
    const codeEl = document.getElementById('delete-tenant-code');
    if (nameEl) nameEl.textContent = name || 'Unknown';
    if (codeEl) codeEl.textContent = code || '';
    if (modal) modal.style.display = 'block';
  }

  function cancelDeleteTenant() {
    pendingDeleteTenantId = null;
    const modal = document.getElementById('delete-tenant-modal');
    if (modal) modal.style.display = 'none';
  }

  async function confirmDeleteTenant() {
    if (!pendingDeleteTenantId) return;

    const tenantId = pendingDeleteTenantId;
    const deleteModal = document.getElementById('delete-tenant-modal');
    if (deleteModal) deleteModal.style.display = 'none';

    try {
      const response = await fetch(`${window.location.protocol}//${window.location.host}/api/master/tenants/${tenantId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      const data = await response.json();

      if (data.success) {
        alert('Tenant deactivated successfully');
        loadTenants();
      } else {
        alert('Error deactivating tenant: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error deactivating tenant:', error);
      alert('Error deactivating tenant: ' + error.message);
    } finally {
      pendingDeleteTenantId = null;
    }
  }

  async function restoreTenant(tenantId) {
    if (!confirm('Restore this tenant to active status?')) return;
    try {
      const response = await fetch(`${window.location.protocol}//${window.location.host}/api/master/tenants/${tenantId}/restore`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      if (data.success) {
        alert('Tenant restored successfully');
        loadTenants();
      } else {
        alert('Error restoring tenant: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error restoring tenant:', error);
      alert('Error restoring tenant: ' + error.message);
    }
  }

  function permanentDeleteTenant(tenantId, name, code) {
    pendingPermDeleteTenantId = tenantId;
    pendingPermDeleteTenantCode = code;
    const nameEl = document.getElementById('perm-delete-tenant-name');
    const codeEl = document.getElementById('perm-delete-tenant-code-display');
    const input = document.getElementById('perm-delete-confirm-input');
    const btn = document.getElementById('perm-delete-btn');
    if (nameEl) nameEl.textContent = name || 'Unknown';
    if (codeEl) codeEl.textContent = code || '';
    if (input) input.value = '';
    if (btn) btn.disabled = true;
    const modal = document.getElementById('permanent-delete-tenant-modal');
    if (modal) modal.style.display = 'block';
  }

  function checkPermDeleteInput() {
    const input = document.getElementById('perm-delete-confirm-input');
    const btn = document.getElementById('perm-delete-btn');
    if (input && btn) {
      btn.disabled = input.value !== pendingPermDeleteTenantCode;
    }
  }

  function cancelPermanentDelete() {
    pendingPermDeleteTenantId = null;
    pendingPermDeleteTenantCode = null;
    const modal = document.getElementById('permanent-delete-tenant-modal');
    if (modal) modal.style.display = 'none';
  }

  async function confirmPermanentDelete() {
    if (!pendingPermDeleteTenantId || !pendingPermDeleteTenantCode) return;

    const tenantId = pendingPermDeleteTenantId;
    const code = pendingPermDeleteTenantCode;
    const modal = document.getElementById('permanent-delete-tenant-modal');
    if (modal) modal.style.display = 'none';

    try {
      const response = await fetch(`${window.location.protocol}//${window.location.host}/api/master/tenants/${tenantId}/permanent`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ confirm_code: code })
      });
      const data = await response.json();
      if (data.success) {
        alert('Tenant permanently deleted');
        loadTenants();
      } else {
        alert('Error: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error permanently deleting tenant:', error);
      alert('Error: ' + error.message);
    } finally {
      pendingPermDeleteTenantId = null;
      pendingPermDeleteTenantCode = null;
    }
  }
  
  // Expose tenant management functions globally for onclick handlers
  window.editTenant = editTenant;
  window.deleteTenant = deleteTenant;
  window.manageTenantSubscription = manageTenantSubscription;
  window.confirmDeleteTenant = confirmDeleteTenant;
  window.cancelDeleteTenant = cancelDeleteTenant;
  window.restoreTenant = restoreTenant;
  window.permanentDeleteTenant = permanentDeleteTenant;
  window.checkPermDeleteInput = checkPermDeleteInput;
  window.confirmPermanentDelete = confirmPermanentDelete;
  window.cancelPermanentDelete = cancelPermanentDelete;
  window.showEditTenantForm = showEditTenantForm;
  window.hideEditTenantForm = hideEditTenantForm;
  window.updateTenant = updateTenant;
  window.saveTenantSubscription = saveTenantSubscription;
  window.hideTenantSubscriptionModal = hideTenantSubscriptionModal;
  window.cancelTenantSubscription = cancelTenantSubscription;
  window.showCreateTenantForm = showCreateTenantForm;
  window.hideCreateTenantForm = hideCreateTenantForm;
  window.createTenant = createTenant;

  // Subscription Management Functions
  async function loadSubscriptions() {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/subscriptions', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      
      if (data.success) {
        updateSubscriptionStats(data.subscriptions);
        renderSubscriptionList(data.subscriptions);
      }
    } catch (error) {
      console.error('Error loading subscriptions:', error);
    }
  }
  
  function updateSubscriptionStats(subscriptions) {
    if (!subscriptions || subscriptions.length === 0) {
      document.getElementById('active-subscriptions').textContent = '0';
      document.getElementById('total-revenue').textContent = '$0';
      document.getElementById('trial-conversions').textContent = '0%';
      return;
    }
    const activeSubscriptions = subscriptions.filter(s => s.status === 'active').length;
    const totalRevenue = subscriptions.reduce((sum, s) => sum + (parseFloat(s.monthly_price) || 0), 0);
    const trialSubscriptions = subscriptions.filter(s => s.status === 'trial').length;
    const convertedTrials = subscriptions.filter(s => s.status !== 'trial' && s.previous_plan_name === 'Trial').length;
    const conversionRate = trialSubscriptions > 0 ? Math.round((convertedTrials / trialSubscriptions) * 100) : 0;

    document.getElementById('active-subscriptions').textContent = activeSubscriptions;
    document.getElementById('total-revenue').textContent = '$' + totalRevenue.toLocaleString();
    document.getElementById('trial-conversions').textContent = conversionRate + '%';
  }

  function renderSubscriptionList(subscriptions) {
    const tbody = document.getElementById('subscription-list-body');
    if (tbody) {
      if (!subscriptions || subscriptions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="subtitle">No subscriptions</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      subscriptions.forEach(sub => {
        const tr = document.createElement('tr');
        const nextBilling = sub.next_billing_date ? new Date(sub.next_billing_date).toLocaleDateString() : 'N/A';
        const planName = sub.plan_name || 'Unknown';

        // Add trial expiration info
        let trialInfo = '';
        if (sub.status === 'trial' && sub.trial_ends_at) {
          const trialEnd = new Date(sub.trial_ends_at);
          const now = new Date();
          const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));

          if (daysLeft > 0) {
            trialInfo = `<br><small style="color: #ff9800;">Trial expires in ${daysLeft} days</small>`;
          } else {
            trialInfo = `<br><small style="color: #f44336;">Trial expired</small>`;
          }
        }

        tr.innerHTML = `
          <td>${sub.company_name || sub.tenant_code || 'N/A'}${trialInfo}</td>
          <td><span class="badge">${planName}</span></td>
          <td><span class="badge status-${sub.status}">${sub.status || 'N/A'}</span></td>
          <td>$${sub.monthly_price || 0}/month</td>
          <td>${nextBilling}</td>
          <td>${sub.billing_cycle || 'N/A'}</td>
          <td>—</td>
          <td>
            ${sub.status === 'trial' ? `
              <button onclick="extendTrial('${sub.id}')" class="btn btn-sm">Extend</button>
              <button onclick="convertTrial('${sub.id}')" class="btn btn-sm btn-primary">Convert</button>
            ` : `
              <button onclick="editSubscription('${sub.id}')" class="btn btn-sm">Edit</button>
              <button onclick="cancelSubscription('${sub.id}')" class="btn btn-sm btn-danger">Cancel</button>
            `}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  }
  
  function showCreateSubscriptionForm() {
    document.getElementById('create-subscription-form').style.display = 'block';
    loadTenantsForSubscription();
  }
  
  function hideCreateSubscriptionForm() {
    document.getElementById('create-subscription-form').style.display = 'none';
    document.getElementById('subscription-tenant').value = '';
    document.getElementById('subscription-plan').value = 'trial';
    document.getElementById('subscription-billing').value = 'monthly';
  }
  
  async function loadTenantsForSubscription() {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/tenants', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      
      if (data.success) {
        const select = document.getElementById('subscription-tenant');
        select.innerHTML = '<option value="">Choose a tenant...</option>';
        data.tenants.forEach(tenant => {
          const option = document.createElement('option');
          option.value = tenant.tenantId;
          option.textContent = tenant.companyName;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading tenants:', error);
    }
  }
  
  async function createSubscription() {
    const tenantId = document.getElementById('subscription-tenant').value;
    const plan = document.getElementById('subscription-plan').value;
    const billing = document.getElementById('subscription-billing').value;
    
    if (!tenantId || !plan) {
      alert('Please fill in all required fields');
      return;
    }
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/subscriptions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          tenantId,
          plan,
          billing
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('Subscription created successfully!');
        hideCreateSubscriptionForm();
        loadSubscriptions();
      } else {
        alert('Error creating subscription: ' + data.message);
      }
    } catch (error) {
      console.error('Error creating subscription:', error);
      alert('Error creating subscription');
    }
  }
  
  function editSubscription(subscriptionId) {
    alert('Edit subscription functionality not yet implemented for: ' + subscriptionId);
  }
  
  function cancelSubscription(subscriptionId) {
    if (confirm('Are you sure you want to cancel this subscription?')) {
      alert('Cancel subscription functionality not yet implemented for: ' + subscriptionId);
    }
  }
  
  function exportSubscriptions() {
    alert('Export subscriptions functionality not yet implemented');
  }
  
  // Trial Management Functions
  async function extendTrial(subscriptionId) {
    const days = prompt('How many days to extend the trial? (default: 7)', '7');
    if (!days || isNaN(days)) return;
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/subscriptions/${subscriptionId}/extend-trial`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ days: parseInt(days) })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert(`Trial extended by ${days} days!`);
        loadSubscriptions();
      } else {
        alert('Error extending trial: ' + data.message);
      }
    } catch (error) {
      console.error('Error extending trial:', error);
      alert('Error extending trial');
    }
  }
  
  async function convertTrial(subscriptionId) {
    const newPlan = prompt('Convert to which plan? (starter/pro)', 'starter');
    if (!newPlan || !['starter', 'pro'].includes(newPlan)) {
      alert('Please enter a valid plan: starter or pro');
      return;
    }
    
    const billing = prompt('Billing cycle? (monthly/yearly)', 'monthly');
    if (!billing || !['monthly', 'yearly'].includes(billing)) {
      alert('Please enter a valid billing cycle: monthly or yearly');
      return;
    }
    
    if (!confirm(`Convert trial to ${newPlan} plan (${billing} billing)?`)) return;
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/subscriptions/${subscriptionId}/convert-trial`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ newPlan, billing })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert(`Trial converted to ${newPlan} plan!`);
        loadSubscriptions();
      } else {
        alert('Error converting trial: ' + data.message);
      }
    } catch (error) {
      console.error('Error converting trial:', error);
      alert('Error converting trial');
    }
  }
  
  // Billing Management Functions
  async function loadBilling() {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/billing', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      
      if (data.success) {
        updateBillingStats(data.billing);
        renderBillingList(data.billing.transactions || []);
      }
    } catch (error) {
      console.error('Error loading billing:', error);
    }
  }
  
  function updateBillingStats(billing) {
    document.getElementById('mrr').textContent = '$' + billing.mrr.toLocaleString();
    document.getElementById('pending-payments').textContent = '$' + billing.pendingPayments.toLocaleString();
    document.getElementById('churn-rate').textContent = billing.churnRate + '%';
    document.getElementById('arpu').textContent = '$' + billing.arpu.toLocaleString();
  }
  
  function renderBillingList(transactions) {
    const tbody = document.getElementById('billing-list-body');
    if (tbody) {
      if (!transactions || transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="subtitle">No billing transactions</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      transactions.forEach(transaction => {
        const tr = document.createElement('tr');
        const date = transaction.date ? new Date(transaction.date).toLocaleDateString() : 'N/A';
        const statusClass = transaction.status === 'paid' ? 'status-success' :
                           transaction.status === 'pending' ? 'status-warning' : 'status-error';

        tr.innerHTML = `
          <td>${date}</td>
          <td>${transaction.tenant || 'N/A'}</td>
          <td>${transaction.description || transaction.plan || 'N/A'}</td>
          <td>$${transaction.amount || 0}</td>
          <td><span class="badge ${statusClass}">${transaction.status || 'N/A'}</span></td>
          <td><button onclick="viewInvoice('${transaction.id}')" class="btn btn-sm">View</button></td>
        `;
        tbody.appendChild(tr);
      });
    }
  }
  
  function generateInvoice() {
    alert('Generate invoice functionality not yet implemented');
  }
  
  function exportBilling() {
    alert('Export billing functionality not yet implemented');
  }
  
  function viewInvoice(invoiceId) {
    alert('View invoice functionality not yet implemented for: ' + invoiceId);
  }
  
  // Plan Management Functions
  // Plan Management - Enhanced for unified plan system
  let plansData = [];
  let featureCatalog = [];

  async function loadPlans() {
    try {
      const [plansResponse, featuresResponse] = await Promise.all([
        fetch(window.location.protocol + '//' + window.location.host + '/api/master/plans', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        }),
        fetch(window.location.protocol + '//' + window.location.host + '/api/master/plans/features', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        })
      ]);

      const plansResult = await plansResponse.json();
      const featuresResult = await featuresResponse.json();

      if (plansResult.success) {
        plansData = plansResult.plans;
        updatePlanStats(plansData);
        renderPlansList(plansData);
      }

      if (featuresResult.success) {
        featureCatalog = featuresResult.features;
      }
    } catch (error) {
      console.error('Error loading plans:', error);
    }
  }

  function updatePlanStats(plans) {
    if (!plans || plans.length === 0) {
      document.getElementById('total-plans').textContent = '0';
      document.getElementById('active-plans').textContent = '0';
      document.getElementById('popular-plan').textContent = 'N/A';
      return;
    }
    const totalPlans = plans.length;
    const activePlans = plans.filter(p => p.is_active).length;
    const popularPlan = plans.reduce((prev, current) =>
      (prev.tenant_count || 0) > (current.tenant_count || 0) ? prev : current
    );

    document.getElementById('total-plans').textContent = totalPlans;
    document.getElementById('active-plans').textContent = activePlans;
    document.getElementById('popular-plan').textContent = popularPlan.display_name || popularPlan.name || 'N/A';
  }

  function renderPlansList(plans) {
    const tbody = document.getElementById('plans-list-body');
    if (!tbody) return;

    if (!plans || plans.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="subtitle">No plans defined</td></tr>';
      return;
    }

    tbody.innerHTML = '';
    plans.forEach((plan) => {
      const tr = document.createElement('tr');
      const featuresList = Array.isArray(plan.features) ? plan.features : [];
      const featuresDisplay = featuresList.length > 0 ? `${featuresList.length} features` : 'None';
      const pricing = `$${plan.price_monthly || 0}/mo`;
      const status = plan.is_active ? 'active' : 'inactive';
      const featured = plan.is_featured ? ' <span class="badge">Featured</span>' : '';

      tr.innerHTML = `
        <td>${plan.display_order || 0}</td>
        <td><strong>${escapeHtml(plan.display_name || plan.name)}</strong>${featured}<br><small class="subtitle">${escapeHtml(plan.tagline || '')}</small></td>
        <td><code>${escapeHtml(plan.slug)}</code></td>
        <td>${pricing}${plan.badge_text ? '<br><small class="subtitle">'+escapeHtml(plan.badge_text)+'</small>' : ''}</td>
        <td title="${featuresList.join(', ')}">${featuresDisplay}</td>
        <td>${plan.tenant_count || 0}</td>
        <td><span class="badge status-${status}">${status}</span></td>
        <td>
          <button onclick="editPlan(${plan.id})" class="btn btn-sm">Edit</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showCreatePlanForm() {
    document.getElementById('create-plan-form').style.display = 'block';
    document.getElementById('plan-form-title').textContent = 'Create New Plan';
    document.getElementById('plan-edit-id').value = '';
    clearPlanForm();
    renderFeatureChecklist([]);
  }

  function hideCreatePlanForm() {
    document.getElementById('create-plan-form').style.display = 'none';
    clearPlanForm();
  }

  function clearPlanForm() {
    document.getElementById('plan-slug').value = '';
    document.getElementById('plan-name').value = '';
    document.getElementById('plan-display-name').value = '';
    document.getElementById('plan-tagline').value = '';
    document.getElementById('plan-badge').value = '';
    document.getElementById('plan-description').value = '';
    document.getElementById('plan-price-monthly').value = '';
    document.getElementById('plan-price-yearly').value = '';
    document.getElementById('plan-price-per-user').value = '';
    document.getElementById('plan-limit-users').value = '-1';
    document.getElementById('plan-limit-tickets').value = '-1';
    document.getElementById('plan-limit-storage').value = '10';
    document.getElementById('plan-display-order').value = '1';
    document.getElementById('plan-status').value = 'active';
    document.getElementById('plan-featured').checked = false;
  }

  function renderFeatureChecklist(selectedFeatures) {
    const container = document.getElementById('plan-features-checklist');
    if (!featureCatalog || featureCatalog.length === 0) {
      container.innerHTML = '<div class="subtitle">No features defined</div>';
      return;
    }

    // Group by category
    const grouped = {};
    featureCatalog.forEach(f => {
      const cat = f.category || 'other';
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push(f);
    });

    const categoryNames = {
      core: 'Core', customer: 'Customer', ai: 'AI', integrations: 'Integrations',
      sla: 'SLA', msp: 'MSP', api: 'API'
    };

    let html = '';
    Object.keys(grouped).forEach(cat => {
      html += `<div style="margin-bottom:12px"><strong>${categoryNames[cat] || cat}</strong>`;
      grouped[cat].forEach(f => {
        const checked = selectedFeatures.includes(f.feature_key) ? 'checked' : '';
        html += `<label style="display:flex;align-items:center;gap:4px;margin:4px 0;font-size:13px">
          <input type="checkbox" class="plan-feature-cb" value="${f.feature_key}" ${checked} style="width:auto">
          ${escapeHtml(f.marketing_name || f.name)}
        </label>`;
      });
      html += '</div>';
    });

    container.innerHTML = html;
  }

  function getSelectedFeatures() {
    const checkboxes = document.querySelectorAll('.plan-feature-cb:checked');
    return Array.from(checkboxes).map(cb => cb.value);
  }

  async function editPlan(planId) {
    const plan = plansData.find(p => p.id === planId);
    if (!plan) return;

    document.getElementById('create-plan-form').style.display = 'block';
    document.getElementById('plan-form-title').textContent = 'Edit Plan: ' + plan.display_name;
    document.getElementById('plan-edit-id').value = plan.id;

    document.getElementById('plan-slug').value = plan.slug || '';
    document.getElementById('plan-name').value = plan.name || '';
    document.getElementById('plan-display-name').value = plan.display_name || '';
    document.getElementById('plan-tagline').value = plan.tagline || '';
    document.getElementById('plan-badge').value = plan.badge_text || '';
    document.getElementById('plan-description').value = plan.description || '';
    document.getElementById('plan-price-monthly').value = plan.price_monthly || '';
    document.getElementById('plan-price-yearly').value = plan.price_yearly || '';
    document.getElementById('plan-price-per-user').value = plan.price_per_user || '';

    const limits = plan.feature_limits || {};
    document.getElementById('plan-limit-users').value = limits.max_users ?? -1;
    document.getElementById('plan-limit-tickets').value = limits.max_tickets ?? -1;
    document.getElementById('plan-limit-storage').value = limits.max_storage_gb ?? 10;

    document.getElementById('plan-display-order').value = plan.display_order || 0;
    document.getElementById('plan-status').value = plan.is_active ? 'active' : 'inactive';
    document.getElementById('plan-featured').checked = !!plan.is_featured;

    renderFeatureChecklist(plan.features || []);

    // Scroll to form
    document.getElementById('create-plan-form').scrollIntoView({ behavior: 'smooth' });
  }

  async function savePlan() {
    const editId = document.getElementById('plan-edit-id').value;
    const isEdit = !!editId;

    const planData = {
      slug: document.getElementById('plan-slug').value,
      name: document.getElementById('plan-name').value,
      displayName: document.getElementById('plan-display-name').value,
      tagline: document.getElementById('plan-tagline').value,
      badgeText: document.getElementById('plan-badge').value || null,
      description: document.getElementById('plan-description').value,
      priceMonthly: parseFloat(document.getElementById('plan-price-monthly').value) || 0,
      priceYearly: parseFloat(document.getElementById('plan-price-yearly').value) || 0,
      pricePerUser: parseFloat(document.getElementById('plan-price-per-user').value) || 0,
      featureLimits: {
        max_users: parseInt(document.getElementById('plan-limit-users').value) || -1,
        max_tickets: parseInt(document.getElementById('plan-limit-tickets').value) || -1,
        max_storage_gb: parseInt(document.getElementById('plan-limit-storage').value) || 10
      },
      features: getSelectedFeatures(),
      displayOrder: parseInt(document.getElementById('plan-display-order').value) || 0,
      isActive: document.getElementById('plan-status').value === 'active',
      isFeatured: document.getElementById('plan-featured').checked
    };

    if (!planData.slug || !planData.name) {
      alert('Please fill in slug and name');
      return;
    }

    try {
      const url = isEdit
        ? `${window.location.protocol}//${window.location.host}/api/master/plans/${editId}`
        : `${window.location.protocol}//${window.location.host}/api/master/plans`;

      const response = await fetch(url, {
        method: isEdit ? 'PUT' : 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify(planData)
      });

      const data = await response.json();

      if (data.success) {
        alert(isEdit ? 'Plan updated successfully!' : 'Plan created successfully!');
        hideCreatePlanForm();
        loadPlans();
      } else {
        alert('Error saving plan: ' + data.message);
      }
    } catch (error) {
      console.error('Error saving plan:', error);
      alert('Error saving plan');
    }
  }

  function previewPlansOnMarketing() {
    window.open('/marketing/site.html#pricing', '_blank');
  }

  // ---- Currency Management ----
  let currenciesData = [];
  let currencyPlansData = [];

  async function loadCurrenciesAdmin() {
    const token = localStorage.getItem('token');
    if (!token) {
      console.error('No auth token found');
      return;
    }

    try {
      const [currenciesResponse, plansResponse] = await Promise.all([
        fetch(window.location.protocol + '//' + window.location.host + '/api/master/currencies', {
          headers: { 'Authorization': 'Bearer ' + token }
        }),
        fetch(window.location.protocol + '//' + window.location.host + '/api/master/plans', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
      ]);

      const currenciesResult = await currenciesResponse.json();
      const plansResult = await plansResponse.json();

      console.log('Currencies API response:', currenciesResult);
      console.log('Plans API response:', plansResult);

      if (currenciesResult.success) {
        currenciesData = currenciesResult.currencies;
        updateCurrencyStats(currenciesData);
        renderCurrenciesList(currenciesData);
      } else {
        console.error('Failed to load currencies:', currenciesResult.message);
      }

      if (plansResult.success) {
        currencyPlansData = plansResult.plans;
        populatePlanSelect(currencyPlansData);
      } else {
        console.error('Failed to load plans:', plansResult.message);
      }
    } catch (error) {
      console.error('Error loading currencies:', error);
    }
  }

  function updateCurrencyStats(currencies) {
    const totalEl = document.getElementById('total-currencies');
    const activeEl = document.getElementById('active-currencies');
    const baseEl = document.getElementById('base-currency');

    if (!currencies || currencies.length === 0) {
      if (totalEl) totalEl.textContent = '0';
      if (activeEl) activeEl.textContent = '0';
      if (baseEl) baseEl.textContent = 'N/A';
      return;
    }

    const total = currencies.length;
    const active = currencies.filter(c => c.is_active).length;
    const base = currencies.find(c => c.is_base);

    if (totalEl) totalEl.textContent = total;
    if (activeEl) activeEl.textContent = active;
    if (baseEl) baseEl.textContent = base ? base.code : 'USD';
  }

  function renderCurrenciesList(currencies) {
    const tbody = document.getElementById('currencies-list-body');
    if (!tbody) return;

    if (!currencies || currencies.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="subtitle">No currencies defined</td></tr>';
      return;
    }

    tbody.innerHTML = '';
    currencies.forEach((currency) => {
      const tr = document.createElement('tr');
      const status = currency.is_active ? 'active' : 'inactive';
      const isBase = currency.is_base ? ' <span class="badge">Base</span>' : '';

      tr.innerHTML = `
        <td>${currency.display_order || 0}</td>
        <td><strong>${escapeHtml(currency.code)}</strong>${isBase}</td>
        <td>${escapeHtml(currency.name)}</td>
        <td>${escapeHtml(currency.symbol)}</td>
        <td>
          <input type="number" step="0.0001" class="input" style="width:100px"
            value="${currency.exchange_rate}"
            onchange="updateCurrencyRate('${currency.code}', this.value)"
            ${currency.is_base ? 'disabled' : ''}>
        </td>
        <td>
          <input type="number" step="1" class="input" style="width:80px"
            value="${currency.round_to}"
            onchange="updateCurrencyRounding('${currency.code}', this.value)">
        </td>
        <td><span class="badge status-${status}">${status}</span></td>
        <td>
          <button onclick="toggleCurrencyStatus('${currency.code}', ${!currency.is_active})"
            class="btn btn-sm ${currency.is_active ? '' : 'primary'}"
            ${currency.is_base ? 'disabled' : ''}>
            ${currency.is_active ? 'Disable' : 'Enable'}
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function updateCurrencyRate(code, rate) {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/currencies/' + code, {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ exchange_rate: parseFloat(rate) })
      });
      const data = await response.json();
      if (!data.success) {
        alert('Error updating rate: ' + data.message);
        loadCurrenciesAdmin();
      }
    } catch (error) {
      console.error('Error updating currency rate:', error);
      alert('Error updating exchange rate');
    }
  }

  async function updateCurrencyRounding(code, roundTo) {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/currencies/' + code, {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ round_to: parseFloat(roundTo) })
      });
      const data = await response.json();
      if (!data.success) {
        alert('Error updating rounding: ' + data.message);
        loadCurrenciesAdmin();
      }
    } catch (error) {
      console.error('Error updating currency rounding:', error);
      alert('Error updating rounding');
    }
  }

  async function toggleCurrencyStatus(code, newStatus) {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/currencies/' + code, {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_active: newStatus })
      });
      const data = await response.json();
      if (data.success) {
        loadCurrenciesAdmin();
      } else {
        alert('Error updating status: ' + data.message);
      }
    } catch (error) {
      console.error('Error toggling currency status:', error);
      alert('Error updating status');
    }
  }

  function populatePlanSelect(plans) {
    const select = document.getElementById('regional-plan-select');
    if (!select) return;

    select.innerHTML = '<option value="">Select a plan to configure regional pricing...</option>';
    plans.forEach(plan => {
      const option = document.createElement('option');
      option.value = plan.id;
      option.textContent = `${plan.display_name || plan.name} (${plan.slug}) - $${plan.price_monthly}/mo`;
      select.appendChild(option);
    });
  }

  let regionalPricesData = [];
  let selectedPlanId = null;

  function clearRegionalPrices() {
    document.getElementById('regional-prices-container').style.display = 'none';
    regionalPricesData = [];
    selectedPlanId = null;
  }

  async function calculateRegionalPrices() {
    const planId = document.getElementById('regional-plan-select').value;
    if (!planId) {
      alert('Please select a plan first');
      return;
    }

    selectedPlanId = planId;
    const container = document.getElementById('regional-prices-container');
    const tbody = document.getElementById('regional-prices-body');

    container.style.display = 'block';
    tbody.innerHTML = '<tr><td colspan="7" class="subtitle">Calculating suggested prices...</td></tr>';

    const token = localStorage.getItem('token');
    if (!token) {
      tbody.innerHTML = '<tr><td colspan="7" class="subtitle">Error: Not authenticated. Please log in again.</td></tr>';
      return;
    }

    const url = window.location.protocol + '//' + window.location.host + '/api/master/plans/' + planId + '/regional-prices/calculate';
    console.log('Calculating regional prices for plan:', planId, 'URL:', url);

    try {
      const response = await fetch(url, {
        headers: { 'Authorization': 'Bearer ' + token }
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('API error:', response.status, errorText);
        tbody.innerHTML = '<tr><td colspan="7" class="subtitle">Error: ' + response.status + ' - ' + (errorText || 'Server error') + '</td></tr>';
        return;
      }

      const data = await response.json();

      if (data.success) {
        regionalPricesData = data.regional_prices;
        renderRegionalPrices(data.plan, data.regional_prices);
      } else {
        tbody.innerHTML = '<tr><td colspan="7" class="subtitle">Error: ' + (data.message || 'Unknown error') + '</td></tr>';
      }
    } catch (error) {
      console.error('Error calculating regional prices:', error);
      tbody.innerHTML = '<tr><td colspan="7" class="subtitle">Error: ' + error.message + '</td></tr>';
    }
  }

  function renderRegionalPrices(plan, prices) {
    const tbody = document.getElementById('regional-prices-body');
    if (!tbody) return;

    tbody.innerHTML = '';

    // Helper to safely format numbers
    const fmt = (val) => (val !== null && val !== undefined && !isNaN(val)) ? parseFloat(val).toFixed(2) : '0.00';
    const fmtRate = (val) => (val !== null && val !== undefined && !isNaN(val)) ? parseFloat(val).toFixed(4) : '1.0000';

    prices.forEach((price, index) => {
      const tr = document.createElement('tr');
      const isConfigured = price.is_configured;
      const statusBadge = price.is_base
        ? '<span class="badge">Base</span>'
        : (isConfigured ? '<span class="badge status-active">Committed</span>' : '<span class="badge status-inactive">Not Set</span>');

      // Use committed value if exists, otherwise suggested (with null safety)
      const suggestedMonthly = price.suggested_monthly || 0;
      const suggestedYearly = price.suggested_yearly || 0;
      const suggestedPerUser = price.suggested_per_user || 0;

      const monthlyVal = price.committed_monthly !== null ? price.committed_monthly : suggestedMonthly;
      const yearlyVal = price.committed_yearly !== null ? price.committed_yearly : suggestedYearly;
      const perUserVal = price.committed_per_user !== null ? price.committed_per_user : suggestedPerUser;

      tr.innerHTML = `
        <td><strong>${price.currency_code}</strong><br><small>${price.currency_symbol || ''} ${price.currency_name || ''}</small></td>
        <td>${price.is_base ? '1.00' : fmtRate(price.exchange_rate)}</td>
        <td>${price.currency_symbol || ''}${fmt(suggestedMonthly)}</td>
        <td>
          <input type="number" step="0.01" class="input" style="width:100px"
            id="regional-monthly-${index}"
            value="${fmt(monthlyVal)}"
            ${price.is_base ? 'disabled' : ''}>
        </td>
        <td>
          <input type="number" step="0.01" class="input" style="width:100px"
            id="regional-yearly-${index}"
            value="${fmt(yearlyVal)}"
            ${price.is_base ? 'disabled' : ''}>
        </td>
        <td>
          <input type="number" step="0.01" class="input" style="width:100px"
            id="regional-peruser-${index}"
            value="${fmt(perUserVal)}"
            ${price.is_base ? 'disabled' : ''}>
        </td>
        <td>${statusBadge}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function useSuggestedPrices() {
    regionalPricesData.forEach((price, index) => {
      if (price.is_base) return;
      document.getElementById(`regional-monthly-${index}`).value = price.suggested_monthly.toFixed(2);
      document.getElementById(`regional-yearly-${index}`).value = price.suggested_yearly.toFixed(2);
      document.getElementById(`regional-peruser-${index}`).value = price.suggested_per_user.toFixed(2);
    });
  }

  async function commitRegionalPrices() {
    if (!selectedPlanId) {
      alert('No plan selected');
      return;
    }

    // Collect all prices from inputs
    const prices = [];
    regionalPricesData.forEach((price, index) => {
      if (price.is_base) return; // Skip base currency

      const monthly = document.getElementById(`regional-monthly-${index}`).value;
      const yearly = document.getElementById(`regional-yearly-${index}`).value;
      const perUser = document.getElementById(`regional-peruser-${index}`).value;

      prices.push({
        currency_code: price.currency_code,
        price_monthly: parseFloat(monthly) || 0,
        price_yearly: parseFloat(yearly) || 0,
        price_per_user: parseFloat(perUser) || 0
      });
    });

    if (prices.length === 0) {
      alert('No prices to commit');
      return;
    }

    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/plans/' + selectedPlanId + '/regional-prices/commit', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ prices })
      });
      const data = await response.json();

      if (data.success) {
        alert('Regional prices committed successfully!');
        calculateRegionalPrices(); // Refresh to show updated status
      } else {
        alert('Error committing prices: ' + data.message);
      }
    } catch (error) {
      console.error('Error committing regional prices:', error);
      alert('Error committing prices');
    }
  }

  // ---- Tickets ----
  // Build server-side filter query params from UI
  function buildTicketFilterParams() {
    const params = new URLSearchParams();
    const pageSize = getPageSize('tickets');

    // Pagination
    params.set('page', ticketPage);
    params.set('limit', pageSize);

    // Status filter
    const statusFilter = document.getElementById('ticket-filter-status')?.value || '';
    if (statusFilter) {
      params.set('status', statusFilter);
    }

    // Priority filter
    const priorityFilter = document.getElementById('ticket-filter-priority')?.value || '';
    if (priorityFilter) {
      params.set('priority', priorityFilter);
    }

    // Assignee filter
    const assigneeFilter = document.getElementById('ticket-filter-assignee')?.value || '';
    if (assigneeFilter) {
      params.set('assignee_id', assigneeFilter);
    }

    // Company filter
    const companyFilter = document.getElementById('ticket-filter-company')?.value || '';
    if (companyFilter) {
      params.set('company_id', companyFilter);
    }

    // Customer/requester filter
    const customerFilter = document.getElementById('ticket-filter-customer')?.value || '';
    if (customerFilter) {
      params.set('requester_id', customerFilter);
    }

    // Search filter
    const searchTerm = document.getElementById('ticket-search')?.value || '';
    if (searchTerm.trim()) {
      params.set('search', searchTerm.trim());
    }

    // System tickets filter
    const includeSystem = document.getElementById('ticket-filter-system')?.checked !== false;
    params.set('include_system', includeSystem ? 'true' : 'false');

    // Sort
    const sortValue = document.getElementById('ticket-sort')?.value || 'id-desc';
    const [sortBy, sortDir] = sortValue.includes('-') ? sortValue.split('-') : ['created_at', 'desc'];
    params.set('sort_by', sortBy === 'id' ? 'id' : sortBy === 'date' ? 'created_at' : sortBy);
    params.set('sort_dir', sortDir || 'desc');

    // Insight ticket filter (from AI Insights click-through)
    if (window.insightTicketFilter && window.insightTicketFilter.length > 0) {
      params.set('ticket_ids', window.insightTicketFilter.join(','));
    }

    // Impersonation filtering - override assignee/requester filters
    if (window.impersonatedUser) {
      if (window.impersonatedUser.role === 'expert') {
        // When impersonating an expert, show only their assigned tickets
        params.set('assignee_id', window.impersonatedUser.id);
      } else if (window.impersonatedUser.role === 'customer') {
        // When impersonating a customer, show only their requested tickets
        params.set('requester_id', window.impersonatedUser.id);
      }
    }

    return params.toString();
  }

  async function renderList(){
    console.log('[renderList] Called');
    const tb=document.getElementById('list-body');
    if(!tb) { console.log('[renderList] list-body not found!'); return; }
    console.log('[renderList] list-body found, clearing...');
    tb.innerHTML='';
    console.log('[renderList] About to fetch tickets...');

    // Fetch tickets from backend API with server-side filtering
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';
      const filterParams = buildTicketFilterParams();

      const url = `${API_BASE}/api/tickets/${tenantCode}?${filterParams}`;
      console.log('[renderList] Fetching from:', url);
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      console.log('[renderList] Fetch response status:', response.status);

      const data = await response.json();
      console.log('[renderList] Data received, success:', data.success, 'tickets count:', data.tickets?.length, 'total:', data.total);

      if (data.success && data.tickets) {
        // Update local tickets array with fetched data (already filtered by server)
        tickets = data.tickets.map(t => {
          // Parse source_metadata if present
          let sourceMetadata = null;
          if (t.source_metadata) {
            try {
              sourceMetadata = typeof t.source_metadata === 'string'
                ? JSON.parse(t.source_metadata)
                : t.source_metadata;
            } catch (e) { /* ignore parse errors */ }
          }
          return {
            id: t.id,
            title: t.title,
            description: t.description_preview || null, // Preview only; full description fetched on ticket open
            priority: t.priority,
            status: t.status,
            assignee: t.assignee_name || '—',
            assignee_id: t.assignee_id,
            customer: t.requester_name || '—',
            customer_id: t.requester_id,
            customer_company_id: t.customer_company_id,
            company_name: t.company_name || '—',
            company_domain: t.company_domain,
            created: t.created_at,
            sla_deadline: t.response_due_at || t.resolve_due_at, // Use SLA due dates
            sla_status: t.sla_status || null,
            cmdb_item_name: t.cmdb_item_name,
            is_system_source: t.is_system_source ? true : false,
            source_metadata: sourceMetadata
          };
        });

        // Populate filter dropdowns (for options discovery)
        populateAssigneeFilter();
        populateCompanyFilter();
        populateCustomerFilter();

        // Store ticket navigation list for prev/next in detail view
        window.ticketNavList = tickets.map(t => t.id);

        // Use server pagination info
        const serverTotal = data.total || tickets.length;
        const serverPage = data.page || ticketPage;
        const serverLimit = data.limit || getPageSize('tickets');
        const serverTotalPages = data.totalPages || Math.ceil(serverTotal / serverLimit);

        // Update ticket count display
        const countDiv = document.getElementById('ticket-count');
        if (countDiv) {
          const startItem = serverTotal > 0 ? (serverPage - 1) * serverLimit + 1 : 0;
          const endItem = Math.min(serverPage * serverLimit, serverTotal);
          let countText = `Showing ${startItem}-${endItem} of ${serverTotal} tickets`;

          // Add insight filter indicator
          if (window.insightTicketFilter && window.insightTicketFilter.length > 0) {
            countText = `Filtered by AI Insight: "${window.insightTitle}" - ${serverTotal} tickets`;
            countText += ` <button class="btn ghost" style="padding:2px 8px;font-size:11px;margin-left:8px" onclick="clearInsightFilter()">Clear</button>`;
          }

          countDiv.innerHTML = countText;
        }

        // Render pagination controls using server total
        renderPaginationControls('ticket-pagination', serverPage, serverTotal, serverLimit, 'setTicketPage', 'setTicketPageSize', 'tickets');

        // Hide checkboxes, filters, and columns for customer role
        const isCustomerRole = (window.role || role) === 'customer';
        const selectAllTh = document.getElementById('select-all-tickets');
        if (selectAllTh) selectAllTh.closest('th').style.display = isCustomerRole ? 'none' : '';
        // Hide assignee/company/customer filters for customers
        const filterAssignee = document.getElementById('ticket-filter-assignee');
        const filterCompany = document.getElementById('ticket-filter-company');
        const filterCustomer = document.getElementById('ticket-filter-customer');
        const filterSystem = document.getElementById('ticket-filter-system');
        if (filterAssignee) filterAssignee.style.display = isCustomerRole ? 'none' : '';
        if (filterCompany) filterCompany.style.display = isCustomerRole ? 'none' : '';
        if (filterCustomer) filterCustomer.style.display = isCustomerRole ? 'none' : '';
        if (filterSystem && filterSystem.closest('label')) filterSystem.closest('label').style.display = isCustomerRole ? 'none' : '';
        // Hide sort options that don't apply to customers
        const ticketSort = document.getElementById('ticket-sort');
        if (ticketSort) {
          Array.from(ticketSort.options).forEach(opt => {
            if (opt.value === 'customer' || opt.value === 'assignee') opt.style.display = isCustomerRole ? 'none' : '';
          });
        }
        // Hide Customer column header and rename Assignee to Expert for customers
        const ticketTable = document.getElementById('tickets-table');
        if (ticketTable) {
          const ths = ticketTable.querySelectorAll('thead th');
          ths.forEach(th => {
            if (th.textContent.includes('Customer')) th.style.display = isCustomerRole ? 'none' : '';
            if (th.textContent.includes('Assignee') || th.textContent.includes('Expert')) {
              th.innerHTML = isCustomerRole ? 'Expert ⇅' : 'Assignee ⇅';
            }
          });
        }

        // Render tickets (already filtered and paginated by server)
        if (tickets.length === 0) {
          tb.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;">No tickets match your filters</td></tr>';
        } else {
          tickets.forEach(t=>{
            const tr=document.createElement('tr');
            const sla = getSLAState(t);
            const dateTime = formatDateTime(t.created);
            const isSelected = selectedTicketIds.has(t.id);
            const systemBadge = systemSourceBadgeHTML(t, true);
            const checkboxTd = isCustomerRole ? '' : `<td onclick="event.stopPropagation()"><input type="checkbox" class="ticket-checkbox" data-ticket-id="${t.id}" ${isSelected ? 'checked' : ''} onchange="onTicketCheckboxChange(${t.id}, this.checked)"></td>`;
            const customerTd = isCustomerRole ? '' : `<td onclick="openTicket(${t.id})">${t.customer}</td>`;
            tr.innerHTML = `${checkboxTd}<td onclick="openTicket(${t.id})">#${t.id}${systemBadge}</td><td onclick="openTicket(${t.id})">${t.title}</td><td onclick="openTicket(${t.id})">${dateTime}</td><td onclick="openTicket(${t.id})">${t.priority||'—'}</td><td onclick="openTicket(${t.id})">${t.status}</td><td onclick="openTicket(${t.id})">${t.assignee||'—'}</td>${customerTd}<td onclick="openTicket(${t.id})">${slaBadgeHTML(sla)}</td>`;
            if (isSelected) tr.style.backgroundColor = '#e0f2fe';
            tb.appendChild(tr);
          });
        }

        // Update select all checkbox state
        updateSelectAllCheckbox();
      } else {
        console.error('Failed to load tickets:', data.message);
        tb.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">Failed to load tickets</td></tr>';
      }
    } catch (error) {
      console.error('[renderList] CATCH - Error loading tickets:', error);
      console.error('[renderList] Error name:', error.name);
      console.error('[renderList] Error message:', error.message);
      tb.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">Error loading tickets</td></tr>';
    }
  }

  // Populate assignee filter with unique assignees from tickets
  function populateAssigneeFilter() {
    const assigneeFilter = document.getElementById('ticket-filter-assignee');
    if (!assigneeFilter) return;

    // Get current selection
    const currentValue = assigneeFilter.value;

    // Get unique assignees
    const assignees = [...new Set(tickets.map(t => t.assignee).filter(a => a && a !== '—'))].sort();

    // Keep first two options (All Assignees, Unassigned)
    assigneeFilter.innerHTML = '<option value="">All Assignees</option><option value="unassigned">Unassigned</option>';

    // Add assignee options
    assignees.forEach(assignee => {
      const option = document.createElement('option');
      option.value = assignee;
      option.textContent = assignee;
      assigneeFilter.appendChild(option);
    });

    // Restore selection
    assigneeFilter.value = currentValue;
  }

  // Populate company filter from customer_companies API (not just from loaded tickets)
  async function populateCompanyFilter() {
    const companyFilter = document.getElementById('ticket-filter-company');
    if (!companyFilter) return;

    // Get current selection
    const currentValue = companyFilter.value;

    // Use allCustomerCompanies if already loaded, otherwise fetch
    if (allCustomerCompanies.length === 0) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/api/customer-companies`, {
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.success && data.companies) {
          allCustomerCompanies = data.companies;
        }
      } catch (e) {
        console.error('Error loading companies for filter:', e);
      }
    }

    // Sort by company name
    const companies = allCustomerCompanies
      .filter(c => c.company_name)
      .sort((a, b) => a.company_name.localeCompare(b.company_name));

    // Keep first option (All Companies)
    companyFilter.innerHTML = '<option value="">All Companies</option>';

    // Add company options
    companies.forEach(c => {
      const option = document.createElement('option');
      option.value = c.id;
      option.textContent = c.company_name;
      companyFilter.appendChild(option);
    });

    // Restore selection
    companyFilter.value = currentValue;
  }

  // When company filter changes, update team member filter
  function onCompanyFilterChange() {
    ticketPage = 1; // Reset to page 1 when filter changes
    populateCustomerFilter();
    renderList();
  }

  // Populate customer/team member filter with customers from selected company (or all)
  function populateCustomerFilter() {
    const customerFilter = document.getElementById('ticket-filter-customer');
    if (!customerFilter) return;

    // Get current selection
    const currentValue = customerFilter.value;

    // Get selected company filter
    const companyFilter = document.getElementById('ticket-filter-company')?.value || '';

    // Get unique customers, filtered by company if selected
    const customersMap = new Map();
    tickets.forEach(t => {
      if (t.customer && t.customer !== '—') {
        // If company filter is set, only include customers from that company
        if (companyFilter && t.customer_company_id != companyFilter) return;
        customersMap.set(t.customer_id, t.customer);
      }
    });

    // Sort by customer name
    const customers = Array.from(customersMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));

    // Keep first option (All Team Members)
    customerFilter.innerHTML = '<option value="">All Team Members</option>';

    // Add customer options
    customers.forEach(([id, name]) => {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = name;
      customerFilter.appendChild(option);
    });

    // Restore selection if still valid
    if (customersMap.has(parseInt(currentValue))) {
      customerFilter.value = currentValue;
    } else {
      customerFilter.value = '';
    }
  }

  // Apply ticket filters
  function applyTicketFilters(ticketList) {
    const searchTerm = (document.getElementById('ticket-search')?.value || '').toLowerCase();
    const statusFilter = document.getElementById('ticket-filter-status')?.value || '';
    const priorityFilter = document.getElementById('ticket-filter-priority')?.value || '';
    const assigneeFilter = document.getElementById('ticket-filter-assignee')?.value || '';
    const companyFilter = document.getElementById('ticket-filter-company')?.value || '';
    const customerFilter = document.getElementById('ticket-filter-customer')?.value || '';
    const includeSystem = document.getElementById('ticket-filter-system')?.checked !== false;

    // Customers never see system tickets in the ticket list
    const isCustomerRole = (window.role || role) === 'customer';

    const result = ticketList.filter(t => {
      // System ticket filter — always hide for customers
      if (isCustomerRole && t.is_system_source) {
        return false;
      }
      if (!isCustomerRole && !includeSystem && (t.is_system_source || t.source_metadata)) {
        return false;
      }

      // Insight ticket filter now handled server-side via ticket_ids param

      // Search filter
      if (searchTerm) {
        const matchesSearch =
          String(t.id).includes(searchTerm) ||
          (t.title || '').toLowerCase().includes(searchTerm) ||
          (t.description || '').toLowerCase().includes(searchTerm) ||
          (t.customer || '').toLowerCase().includes(searchTerm) ||
          (t.company_name || '').toLowerCase().includes(searchTerm);
        if (!matchesSearch) return false;
      }

      // Status filter (case-insensitive)
      if (statusFilter && (t.status || '').toLowerCase() !== statusFilter.toLowerCase()) return false;

      // Priority filter (case-insensitive)
      if (priorityFilter && (t.priority || '').toLowerCase() !== priorityFilter.toLowerCase()) return false;

      // Assignee filter
      if (assigneeFilter) {
        if (assigneeFilter === 'unassigned') {
          if (t.assignee && t.assignee !== '—') return false;
        } else {
          if (t.assignee !== assigneeFilter) return false;
        }
      }

      // Company filter - if company selected, filter by company
      if (companyFilter) {
        if (t.customer_company_id != companyFilter) return false;
      }

      // Customer/Team Member filter - if specific team member selected
      if (customerFilter) {
        if (t.customer_id != customerFilter) return false;
      }

      // SLA at risk filter (when clicked from dashboard)
      if (window.slaAtRiskFilter) {
        const slaState = getSLAState(t);
        // Only show tickets that are not resolved and have SLA at risk
        if ((t.status || '').toLowerCase() === 'resolved' || (t.status || '').toLowerCase() === 'closed') return false;
        if (slaState.cls === 'ok') return false;
      }

      return true;
    });

    return result;
  }

  // Apply sorting to tickets
  function applySorting(ticketList) {
    const sortBy = document.getElementById('ticket-sort')?.value || 'id-desc';

    const priorityOrder = { 'Critical': 4, 'High': 3, 'Normal': 2, 'Low': 1 };

    return [...ticketList].sort((a, b) => {
      switch(sortBy) {
        case 'id-asc':
          return a.id - b.id;
        case 'id-desc':
          return b.id - a.id;
        case 'title-asc':
          return (a.title || '').localeCompare(b.title || '');
        case 'title-desc':
          return (b.title || '').localeCompare(a.title || '');
        case 'date-asc':
          return new Date(a.created || 0) - new Date(b.created || 0);
        case 'date-desc':
          return new Date(b.created || 0) - new Date(a.created || 0);
        case 'priority-desc':
          return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
        case 'priority-asc':
          return (priorityOrder[a.priority] || 0) - (priorityOrder[b.priority] || 0);
        case 'status':
          return (a.status || '').localeCompare(b.status || '');
        case 'assignee':
          return (a.assignee || '').localeCompare(b.assignee || '');
        case 'customer':
          return (a.customer || '').localeCompare(b.customer || '');
        case 'sla':
          // Sort by SLA urgency using sortPriority (0=breached, 1=at-risk, 2=on-track, 3=paused, 4=met, 5=no-sla)
          const aSLA = getSLAState(a);
          const bSLA = getSLAState(b);
          return (aSLA.sortPriority ?? 5) - (bSLA.sortPriority ?? 5);
        default:
          return b.id - a.id;
      }
    });
  }

  // Clear all ticket filters
  function clearTicketFilters() {
    const searchInput = document.getElementById('ticket-search');
    const statusFilter = document.getElementById('ticket-filter-status');
    const priorityFilter = document.getElementById('ticket-filter-priority');
    const assigneeFilter = document.getElementById('ticket-filter-assignee');
    const companyFilter = document.getElementById('ticket-filter-company');
    const customerFilter = document.getElementById('ticket-filter-customer');
    const sortSelect = document.getElementById('ticket-sort');
    const systemCheckbox = document.getElementById('ticket-filter-system');

    if (searchInput) searchInput.value = '';
    if (statusFilter) statusFilter.value = 'Open';
    if (priorityFilter) priorityFilter.value = '';
    if (assigneeFilter) assigneeFilter.value = '';
    if (companyFilter) companyFilter.value = '';
    if (customerFilter) customerFilter.value = '';
    if (sortSelect) sortSelect.value = 'id-desc';
    if (systemCheckbox) systemCheckbox.checked = true; // Reset System checkbox to checked

    // Also clear insight filters
    clearInsightFilter();

    saveFilterSettings('tickets');
    renderList();
  }

  // Clear AI Insight filter
  function clearInsightFilter() {
    window.insightTicketFilter = null;
    window.insightTitle = null;
    window.slaAtRiskFilter = false;
    renderList();
  }

  // Sort tickets by column (for table header clicks)
  // Tracks current sort direction per column to toggle asc/desc
  let ticketSortDirections = {};

  function sortTicketsBy(column) {
    const sortSelect = document.getElementById('ticket-sort');
    if (!sortSelect) return;

    // Toggle direction for this column
    const currentDir = ticketSortDirections[column] || 'desc';
    const newDir = currentDir === 'desc' ? 'asc' : 'desc';
    ticketSortDirections[column] = newDir;

    // Map columns to sort values
    const sortMap = {
      'id': newDir === 'desc' ? 'id-desc' : 'id-asc',
      'title': newDir === 'desc' ? 'title-desc' : 'title-asc',
      'date': newDir === 'desc' ? 'date-desc' : 'date-asc',
      'priority': newDir === 'desc' ? 'priority-desc' : 'priority-asc',
      'status': 'status',
      'assignee': 'assignee',
      'customer': 'customer',
      'sla': 'sla'
    };

    sortSelect.value = sortMap[column] || 'id-desc';
    renderList();
  }

  // ---- Bulk Selection ----
  let selectedTicketIds = new Set();
  let currentBulkAction = null;

  function onTicketCheckboxChange(ticketId, checked) {
    if (checked) {
      selectedTicketIds.add(ticketId);
    } else {
      selectedTicketIds.delete(ticketId);
    }
    updateBulkActionsBar();
    updateSelectAllCheckbox();
    // Highlight selected rows
    const checkbox = document.querySelector(`input[data-ticket-id="${ticketId}"]`);
    if (checkbox) {
      const row = checkbox.closest('tr');
      if (row) row.style.backgroundColor = checked ? '#e0f2fe' : '';
    }
  }

  function toggleSelectAllTickets() {
    const selectAll = document.getElementById('select-all-tickets');
    const checkboxes = document.querySelectorAll('.ticket-checkbox');

    if (selectAll.checked) {
      checkboxes.forEach(cb => {
        const ticketId = parseInt(cb.dataset.ticketId);
        selectedTicketIds.add(ticketId);
        cb.checked = true;
        const row = cb.closest('tr');
        if (row) row.style.backgroundColor = '#e0f2fe';
      });
    } else {
      checkboxes.forEach(cb => {
        const ticketId = parseInt(cb.dataset.ticketId);
        selectedTicketIds.delete(ticketId);
        cb.checked = false;
        const row = cb.closest('tr');
        if (row) row.style.backgroundColor = '';
      });
    }
    updateBulkActionsBar();
  }

  function updateSelectAllCheckbox() {
    const selectAll = document.getElementById('select-all-tickets');
    const checkboxes = document.querySelectorAll('.ticket-checkbox');
    if (!selectAll || checkboxes.length === 0) return;

    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    const someChecked = Array.from(checkboxes).some(cb => cb.checked);

    selectAll.checked = allChecked;
    selectAll.indeterminate = someChecked && !allChecked;
  }

  function updateBulkActionsBar() {
    const bar = document.getElementById('bulk-actions-bar');
    const countSpan = document.getElementById('bulk-selected-count');
    if (!bar) return;

    // Hide bulk actions for customers
    const currentRole = window.role || role;
    if (currentRole === 'customer') {
      bar.style.display = 'none';
      return;
    }

    if (selectedTicketIds.size > 0) {
      bar.style.display = 'flex';
      countSpan.textContent = `${selectedTicketIds.size} ticket${selectedTicketIds.size > 1 ? 's' : ''} selected`;
    } else {
      bar.style.display = 'none';
    }
  }

  function clearBulkSelection() {
    selectedTicketIds.clear();
    const checkboxes = document.querySelectorAll('.ticket-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = false;
      const row = cb.closest('tr');
      if (row) row.style.backgroundColor = '';
    });
    const selectAll = document.getElementById('select-all-tickets');
    if (selectAll) selectAll.checked = false;
    updateBulkActionsBar();
  }

  function openBulkActionDialog(action) {
    try {
      if (selectedTicketIds.size === 0) {
        alert('Please select at least one ticket');
        return;
      }

      currentBulkAction = action;
      const modal = document.getElementById('bulk-action-modal');
      const title = document.getElementById('bulk-action-title');
      const summary = document.getElementById('bulk-action-summary');
      const assigneeRow = document.getElementById('bulk-action-assignee-row');
      const noteInput = document.getElementById('bulk-action-note');
      const errorDiv = document.getElementById('bulk-action-error');
      const progressDiv = document.getElementById('bulk-action-progress');
      const submitBtn = document.getElementById('bulk-action-submit-btn');

      if (!modal || !title || !summary || !noteInput || !errorDiv || !progressDiv || !submitBtn) {
        console.error('Bulk action modal elements not found');
        alert('Error: Could not open dialog. Please refresh the page.');
        return;
      }

      // Reset state
      noteInput.value = '';
      errorDiv.style.display = 'none';
      progressDiv.style.display = 'none';
      submitBtn.disabled = false;

      // Set title and summary based on action
      const ticketWord = selectedTicketIds.size > 1 ? 'tickets' : 'ticket';
      switch (action) {
        case 'close':
          title.textContent = 'Close Selected Tickets';
          summary.innerHTML = `You are about to <strong>close</strong> ${selectedTicketIds.size} ${ticketWord}.`;
          assigneeRow.style.display = 'none';
          break;
        case 'assign':
          title.textContent = 'Assign Selected Tickets';
          summary.innerHTML = `You are about to <strong>assign</strong> ${selectedTicketIds.size} ${ticketWord} to an expert.`;
          assigneeRow.style.display = 'block';
          loadBulkActionExperts();
          break;
        case 'resolve':
          title.textContent = 'Resolve Selected Tickets';
          summary.innerHTML = `You are about to <strong>resolve</strong> ${selectedTicketIds.size} ${ticketWord}.`;
          assigneeRow.style.display = 'none';
          break;
      }

      // Show modal
      modal.style.display = 'flex';
    } catch (error) {
      console.error('Error opening bulk action dialog:', error);
      alert('Error opening dialog: ' + error.message);
    }
  }

  function closeBulkActionDialog() {
    const modal = document.getElementById('bulk-action-modal');
    modal.style.display = 'none';
    currentBulkAction = null;
  }

  async function loadBulkActionExperts() {
    const select = document.getElementById('bulk-action-assignee');
    select.innerHTML = '<option value="">-- Select Expert --</option>';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();
      if (data.success && data.experts) {
        data.experts.forEach(expert => {
          const option = document.createElement('option');
          option.value = expert.id;
          option.textContent = expert.full_name || expert.username;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading experts:', error);
    }
  }

  async function submitBulkAction() {
    const noteInput = document.getElementById('bulk-action-note');
    const errorDiv = document.getElementById('bulk-action-error');
    const progressDiv = document.getElementById('bulk-action-progress');
    const progressBar = document.getElementById('bulk-action-progress-bar');
    const progressText = document.getElementById('bulk-action-progress-text');
    const submitBtn = document.getElementById('bulk-action-submit-btn');

    const note = noteInput.value.trim();
    if (!note) {
      errorDiv.textContent = 'Please enter an action note';
      errorDiv.style.display = 'block';
      return;
    }

    if (currentBulkAction === 'assign') {
      const assignee = document.getElementById('bulk-action-assignee').value;
      if (!assignee) {
        errorDiv.textContent = 'Please select an expert to assign';
        errorDiv.style.display = 'block';
        return;
      }
    }

    // Hide error and show progress
    errorDiv.style.display = 'none';
    progressDiv.style.display = 'block';
    submitBtn.disabled = true;

    const ticketIds = Array.from(selectedTicketIds);
    const total = ticketIds.length;
    let completed = 0;
    let failed = 0;

    const token = localStorage.getItem('token');
    const tenantCode = window.tenant || 'apoyar';

    // Process tickets using bulk API endpoint
    try {
      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/bulk-action`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: currentBulkAction,
          ticket_ids: ticketIds,
          comment: note,
          assignee_id: currentBulkAction === 'assign' ? document.getElementById('bulk-action-assignee').value : null
        })
      });

      const data = await response.json();

      if (data.success) {
        // Use explicit check for processed count (0 is valid)
        completed = typeof data.processed === 'number' ? data.processed : total;
        failed = data.failed || 0;
        progressBar.style.width = '100%';

        // Handle case where all tickets failed
        if (completed === 0 && failed > 0) {
          errorDiv.textContent = `All ${failed} ticket(s) failed to ${currentBulkAction}. They may not exist or already be in the target state.`;
          errorDiv.style.display = 'block';
          progressDiv.style.display = 'none';
          submitBtn.disabled = false;
          return;
        }

        progressText.textContent = `${completed} of ${total} completed` + (failed > 0 ? `, ${failed} failed` : '');

        // Capture action word before closeBulkActionDialog() clears currentBulkAction
        const actionWord = currentBulkAction === 'close' ? 'closed' : currentBulkAction === 'assign' ? 'assigned' : 'resolved';
        // Close dialog after short delay and refresh
        setTimeout(() => {
          closeBulkActionDialog();
          clearBulkSelection();
          renderList();
          alert(`Bulk action completed: ${completed} ticket${completed !== 1 ? 's' : ''} ${actionWord}` + (failed > 0 ? ` (${failed} failed)` : ''));
        }, 500);
      } else {
        errorDiv.textContent = data.message || 'Bulk action failed';
        errorDiv.style.display = 'block';
        progressDiv.style.display = 'none';
        submitBtn.disabled = false;
      }
    } catch (error) {
      console.error('Bulk action error:', error);
      errorDiv.textContent = 'Error processing bulk action';
      errorDiv.style.display = 'block';
      progressDiv.style.display = 'none';
      submitBtn.disabled = false;
    }
  }

  function openTicket(id){ currentTicketId=id; switchView('ticket-detail'); }

  // Ticket navigation functions
  function updateTicketNavigation() {
    const navButtons = document.getElementById('ticket-nav-buttons');
    const navPlaceholder = document.getElementById('ticket-nav-placeholder');
    const prevBtn = document.getElementById('btn-prev-ticket');
    const nextBtn = document.getElementById('btn-next-ticket');
    const navList = window.ticketNavList || [];

    if (navList.length <= 1) {
      if (navButtons) navButtons.style.display = 'none';
      if (navPlaceholder) navPlaceholder.style.display = 'block';
      return;
    }

    if (navButtons) navButtons.style.display = 'flex';
    if (navPlaceholder) navPlaceholder.style.display = 'none';
    const currentIndex = navList.indexOf(currentTicketId);

    if (prevBtn) prevBtn.disabled = currentIndex <= 0;
    if (nextBtn) nextBtn.disabled = currentIndex >= navList.length - 1 || currentIndex === -1;
  }

  function navigateToPrevTicket() {
    const navList = window.ticketNavList || [];
    const currentIndex = navList.indexOf(currentTicketId);
    if (currentIndex > 0) {
      openTicket(navList[currentIndex - 1]);
    }
  }

  function navigateToNextTicket() {
    const navList = window.ticketNavList || [];
    const currentIndex = navList.indexOf(currentTicketId);
    if (currentIndex >= 0 && currentIndex < navList.length - 1) {
      openTicket(navList[currentIndex + 1]);
    }
  }

  // Keyboard shortcuts for ticket navigation
  document.addEventListener('keydown', (e) => {
    // Only handle shortcuts when ticket detail view is visible
    if (currentView !== 'ticket-detail') return;

    // Don't trigger if user is typing in an input/textarea
    const tag = document.activeElement?.tagName?.toLowerCase();
    if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

    if (e.key === '[') {
      e.preventDefault();
      navigateToPrevTicket();
    } else if (e.key === ']') {
      e.preventDefault();
      navigateToNextTicket();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      switchView('tickets');
    }
  });

  async function renderTicketDetail(){
    let t=tickets.find(x=>x.id===currentTicketId);

    // If ticket not in local array, create a placeholder (will be populated from API)
    if(!t) {
      t = { id: currentTicketId, title: '', status: 'Open', priority: 'medium' };
      tickets.push(t);
    }

    // Load ticket details from backend to get latest data and activities
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${currentTicketId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (!data.success) {
        // API returned an error - throw to trigger fallback
        throw new Error(data.message || 'Failed to load ticket');
      }

      if (data.ticket) {
        const ticket = data.ticket;

        // Update form fields with latest data
        document.getElementById('td-id').innerHTML = '#' + ticket.id + systemSourceBadgeHTML(t, false);
        document.getElementById('td-title').value = ticket.title || '';
        const descEl = document.getElementById('td-desc');
        descEl.value = ticket.description || '';
        // Auto-resize to fit content (cap at 400px)
        descEl.style.height = 'auto';
        descEl.style.height = Math.min(descEl.scrollHeight, 400) + 'px';
        document.getElementById('td-priority').value = ticket.priority || 'medium';
        document.getElementById('td-status').value = ticket.status || 'open';
        document.getElementById('td-due').value = ticket.sla_deadline ? ticket.sla_deadline.split('T')[0] : '';
        document.getElementById('td-customer').value = ticket.requester_name || '';
        document.getElementById('td-item').value = ticket.cmdb_item_name || '';
        document.getElementById('td-ci').value = '';

        // Load experts dropdown and set current assignee
        loadExpertsDropdown(ticket.assignee_id);

        // Update local ticket object (including pool fields for button visibility)
        Object.assign(t, {
          status: ticket.status,
          priority: ticket.priority,
          assignee: ticket.assignee_name,
          sla_status: ticket.sla_status,
          // Pool fields per docs/workflows/ticket-ownership-state-matrix.md
          pool_status: ticket.pool_status,
          claimed_by_expert_id: ticket.claimed_by_expert_id,
          claimed_by_name: ticket.claimed_by_name,
          claimed_until_at: ticket.claimed_until_at,
          owned_by_expert_id: ticket.owned_by_expert_id,
          owner_name: ticket.owner_name,
          execution_mode: ticket.execution_mode
        });

        // Update header metadata
        document.getElementById('td-title-display').textContent = ticket.title || '';
        document.getElementById('td-meta-customer').textContent = ticket.requester_name ? `Customer: ${ticket.requester_name}` : '';
        document.getElementById('td-meta-assignee').textContent = ticket.assignee_name ? `Assigned: ${ticket.assignee_name}` : 'Unassigned';
        const priorityColors = { critical: '#dc2626', high: '#f59e0b', medium: '#3b82f6', low: '#6b7280' };
        const priorityEl = document.getElementById('td-meta-priority');
        priorityEl.textContent = (ticket.priority || 'medium').charAt(0).toUpperCase() + (ticket.priority || 'medium').slice(1);
        priorityEl.style.background = priorityColors[ticket.priority] || priorityColors.medium;
        priorityEl.style.color = 'white';
        const statusColors = { Open: '#3b82f6', 'In Progress': '#f59e0b', Pending: '#8b5cf6', Resolved: '#10b981', Closed: '#6b7280' };
        const statusEl = document.getElementById('td-meta-status');
        statusEl.textContent = ticket.status || 'Open';
        statusEl.style.background = statusColors[ticket.status] || statusColors.Open;
        statusEl.style.color = 'white';
        const slaState = getSLAState(t);
        document.getElementById('td-meta-sla').innerHTML = slaBadgeHTML(slaState, true);

        // Update navigation buttons
        updateTicketNavigation();

        // Admin view toggle - show for admins, apply saved state
        const adminToggleBtn = document.getElementById('btn-admin-view-toggle');
        if (isUserAdmin()) {
          adminToggleBtn.style.display = 'block';
          const adminViewEnabled = sessionStorage.getItem('adminViewEnabled') === 'true';
          applyAdminViewState(adminViewEnabled);
        } else {
          adminToggleBtn.style.display = 'none';
          // Non-admins (experts) see expert view by default - admin sections hidden
          applyAdminViewState(false);
        }

        // Render activities from backend
        const act=document.getElementById('td-activity');
        act.innerHTML='';

        // Icon + label map by event_key (preferred) then activity_type fallback
        const eventIcons = {
          'ticket.created':'&#x1F195;','ticket.assigned':'&#x1F464;','ticket.resolved':'&#x2705;',
          'ticket.closed':'&#x1F512;','ticket.classified':'&#x1F916;','ticket.comment.added':'&#x1F4AC;',
          'ticket.email_reply':'&#x1F4E7;','ticket.auto_reply':'&#x1F916;',
          'ticket.status.changed':'&#x1F504;','ticket.priority.changed':'&#x26A1;',
          'ticket.tag.added':'&#x1F3F7;','ticket.viewed':'&#x1F441;',
          'ticket.cmdb.linked':'&#x1F517;','ticket.cmdb.unlinked':'&#x1F517;',
          'ticket.kb.generated':'&#x1F4DA;','ticket.forwarded':'&#x27A1;',
          'ticket.sla.applied':'&#x23F0;','ticket.sla.deadlines':'&#x23F0;',
          'ticket.monitoring.set':'&#x1F4E1;','ticket.rule.action':'&#x2699;',
          'sla.threshold.hit':'&#x26A0;','sla.breached':'&#x1F6A8;'
        };
        const typeIcons = {
          created:'&#x1F195;',resolved:'&#x2705;',closed:'&#x1F512;',assigned:'&#x1F464;',
          updated:'&#x1F504;',comment:'&#x1F4AC;',classified:'&#x1F916;',
          email_reply:'&#x1F4E7;',auto_reply:'&#x1F916;',sla_notification:'&#x23F0;',
          viewed:'&#x1F441;',system_note:'&#x1F4CB;',marked_as_system:'&#x1F6E0;'
        };
        // Source badge colors
        const sourceBadges = {
          email:{label:'EMAIL',bg:'#7c3aed',fg:'#fff'},
          teams:{label:'TEAMS',bg:'#6264a7',fg:'#fff'},
          slack:{label:'SLACK',bg:'#4a154b',fg:'#fff'},
          chatbot:{label:'CHATBOT',bg:'#0ea5e9',fg:'#fff'},
          chat:{label:'CHAT',bg:'#0ea5e9',fg:'#fff'},
          system:{label:'SYSTEM',bg:'#6b7280',fg:'#fff'},
          web:{label:'WEB',bg:'#e5e7eb',fg:'#374151'}
        };

        if (data.activities && data.activities.length > 0) {
          data.activities.forEach(a => {
            const ek = a.event_key || '';
            const at = a.activity_type || '';
            const isViewed = ek === 'ticket.viewed' || at === 'viewed';
            // Color map per activity type
            const actColors = {
              'ticket.created':'#667eea','ticket.assigned':'#8b5cf6','ticket.resolved':'#10b981',
              'ticket.closed':'#6b7280','ticket.classified':'#f59e0b','ticket.comment.added':'#3b82f6',
              'ticket.email_reply':'#7c3aed','ticket.auto_reply':'#0ea5e9',
              'ticket.status.changed':'#f59e0b','ticket.priority.changed':'#ef4444',
              created:'#667eea',resolved:'#10b981',closed:'#6b7280',assigned:'#8b5cf6',
              updated:'#f59e0b',comment:'#3b82f6',classified:'#f59e0b',
              email_reply:'#7c3aed',auto_reply:'#0ea5e9',sla_notification:'#ef4444',
              viewed:'#d1d5db',system_note:'#6b7280',marked_as_system:'#6b7280'
            };
            const accentColor = actColors[ek] || actColors[at] || '#667eea';

            const div=document.createElement('div');
            div.style.cssText = `padding:8px 12px;margin-bottom:6px;border-radius:10px;font-size:12px;line-height:1.5;border-left:3px solid ${accentColor};background:linear-gradient(90deg,${accentColor}08,transparent);transition:background .15s`;

            const icon = eventIcons[ek] || typeIcons[at] || '&#x25CF;';
            const userName = a.user_full_name || a.user_name || 'System';
            const actDate = new Date(a.created_at).toLocaleString();

            // Source badge (skip for 'web' default to reduce noise)
            const src = (a.source || 'web').toLowerCase();
            let badgeHTML = '';
            if (src !== 'web') {
              const b = sourceBadges[src] || sourceBadges.system;
              badgeHTML = `<span style="display:inline-block;font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;margin-left:4px;background:${b.bg};color:${b.fg};vertical-align:middle;letter-spacing:0.5px">${b.label}</span>`;
            }

            if (isViewed) {
              div.style.opacity = '0.6';
              div.innerHTML = `<span style="font-weight:600">${icon} ${userName}</span> <span style="color:var(--muted);font-size:11px">viewed &middot; ${actDate}</span>`;
            } else {
              div.innerHTML = `${icon} <strong>${userName}</strong>${badgeHTML}: ${a.description || ''}<br><span style="color:var(--muted);font-size:11px">${actDate}</span>`;
            }
            act.appendChild(div);
          });
        } else {
          const div=document.createElement('div');
          div.style.cssText='padding:20px;text-align:center;color:var(--muted);font-size:13px';
          div.textContent = 'No activity recorded yet';
          act.appendChild(div);
        }

        // Auto-expand Activity panel if there are email replies
        if (data.activities && data.activities.some(a => a.activity_type === 'email_reply' || a.event_key === 'ticket.email_reply')) {
          const wrapper = document.getElementById('td-activity-wrapper');
          if (wrapper && wrapper.style.display === 'none') {
            toggleActivityPanel();
          }
        }

        // Display classification data
        displayClassification(ticket);

        // Load chat transcript if ticket has chat_session_id
        const chatTranscriptSection = document.getElementById('td-chat-transcript-section');
        if (chatTranscriptSection) {
          if (ticket.chat_session_id) {
            chatTranscriptSection.style.display = 'block';
            loadChatTranscript(ticket.chat_session_id);
          } else {
            chatTranscriptSection.style.display = 'none';
          }
        }

        // Show source badge for chat-origin tickets
        const srcBadge = document.getElementById('td-system-source-badge');
        if (srcBadge && ticket.source === 'chat') {
          srcBadge.innerHTML = '<span style="display:inline-block;font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;background:#0ea5e9;color:#fff;letter-spacing:0.5px">CHAT</span>';
          srcBadge.style.display = '';
        }
      }
    } catch (error) {
      console.error('Error loading ticket details:', error);
      // Fall back to local data
      document.getElementById('td-id').innerHTML = '#'+t.id + systemSourceBadgeHTML(t, false);
      document.getElementById('td-title').value = t.title || '';
      document.getElementById('td-desc').value = t.desc || '';
      document.getElementById('td-priority').value = t.priority || 'Normal';
      document.getElementById('td-status').value = t.status || 'Open';
      document.getElementById('td-assignee').value = t.assignee || '';
      document.getElementById('td-due').value = t.due || '';
      document.getElementById('td-customer').value = t.customer || '';
      document.getElementById('td-item').value = t.itemId || '';
      document.getElementById('td-ci').value = t.ciId || '';

      // Update header metadata (fallback)
      document.getElementById('td-title-display').textContent = t.title || '';
      document.getElementById('td-meta-customer').textContent = t.customer ? `Customer: ${t.customer}` : '';
      const priorityColors = { critical: '#dc2626', high: '#f59e0b', medium: '#3b82f6', low: '#6b7280' };
      const priorityEl = document.getElementById('td-meta-priority');
      priorityEl.textContent = (t.priority || 'medium').charAt(0).toUpperCase() + (t.priority || 'medium').slice(1);
      priorityEl.style.background = priorityColors[t.priority] || priorityColors.medium;
      priorityEl.style.color = 'white';
      const statusColors = { Open: '#3b82f6', 'In Progress': '#f59e0b', Pending: '#8b5cf6', Resolved: '#10b981', Closed: '#6b7280' };
      const statusEl = document.getElementById('td-meta-status');
      statusEl.textContent = t.status || 'Open';
      statusEl.style.background = statusColors[t.status] || statusColors.Open;
      statusEl.style.color = 'white';
      const slaState = getSLAState(t);
      document.getElementById('td-meta-sla').innerHTML = slaBadgeHTML(slaState, true);

      // Update navigation buttons
      updateTicketNavigation();

      // Admin view toggle (fallback)
      const adminToggleBtn = document.getElementById('btn-admin-view-toggle');
      if (isUserAdmin()) {
        adminToggleBtn.style.display = 'block';
        const adminViewEnabled = sessionStorage.getItem('adminViewEnabled') === 'true';
        applyAdminViewState(adminViewEnabled);
      } else {
        adminToggleBtn.style.display = 'none';
        applyAdminViewState(false);
      }

      const act=document.getElementById('td-activity');
      act.innerHTML='';
      const div=document.createElement('div');
      div.style.cssText='padding:16px;text-align:center;color:var(--muted);font-size:13px';
      div.textContent = 'Error loading ticket activity';
      act.appendChild(div);
    }

    updateTicketSLA();

    // Load linked CMDB items
    loadLinkedCMDBItems();

    // Auto-trigger AI CMDB analysis
    autoAnalyzeCMDB();

    // Role-based button visibility
    updateTicketActionButtons();
  }

  function updateTicketActionButtons() {
    const t = tickets.find(x => x.id === currentTicketId);
    const currentRole = window.role || role;
    const isCustomer = currentRole === 'customer';
    const isResolved = t && t.status === 'Resolved';
    const isSystemSource = t && (t.is_system_source || t.source_metadata);
    const myUserId = parseInt(localStorage.getItem('userId'));

    // Pool status logic per docs/workflows/ticket-ownership-state-matrix.md
    // Treat expired claims as OPEN_POOL
    const claimExpired = t?.claimed_until_at && new Date(t.claimed_until_at) < new Date();
    const rawPoolStatus = t?.pool_status;
    const poolStatus = (rawPoolStatus === 'CLAIMED_LOCKED' && claimExpired) ? 'OPEN_POOL' : rawPoolStatus;
    const isInPool = poolStatus === 'OPEN_POOL' || poolStatus === 'CLAIMED_LOCKED';
    const isClaimed = poolStatus === 'CLAIMED_LOCKED' && !claimExpired;
    const isClaimedByMe = isClaimed && t?.claimed_by_expert_id === myUserId;
    const isClaimedByOther = isClaimed && t?.claimed_by_expert_id && t?.claimed_by_expert_id !== myUserId;
    const isOwned = poolStatus === 'IN_PROGRESS_OWNED' || poolStatus === 'WAITING_CUSTOMER';
    const isOwnedByMe = isOwned && t?.owned_by_expert_id === myUserId;
    const isAutomated = t?.execution_mode === 'automated';

    // Pool action buttons visibility
    const btnClaim = document.getElementById('btn-pool-claim');
    const btnAccept = document.getElementById('btn-pool-accept');
    const btnRelease = document.getElementById('btn-pool-release');
    const btnTakeOver = document.getElementById('btn-pool-takeover');
    const claimedIndicator = document.getElementById('pool-claimed-indicator');
    const poolSeparator = document.getElementById('pool-action-separator');

    // Hide all pool buttons by default
    if (btnClaim) btnClaim.style.display = 'none';
    if (btnAccept) btnAccept.style.display = 'none';
    if (btnRelease) btnRelease.style.display = 'none';
    if (btnTakeOver) btnTakeOver.style.display = 'none';
    if (claimedIndicator) claimedIndicator.style.display = 'none';
    if (poolSeparator) poolSeparator.style.display = 'none';

    // Show pool buttons based on state matrix (experts/admins only)
    if (!isCustomer && t) {
      if (poolStatus === 'OPEN_POOL' && !isAutomated) {
        // State A: Show Claim button
        if (btnClaim) btnClaim.style.display = 'inline-block';
        if (poolSeparator) poolSeparator.style.display = 'inline-block';
      } else if (poolStatus === 'OPEN_POOL' && isAutomated) {
        // State D (automated): Show Take Over button
        if (btnTakeOver) btnTakeOver.style.display = 'inline-block';
        if (poolSeparator) poolSeparator.style.display = 'inline-block';
      } else if (isClaimedByMe) {
        // State B (mine): Show Accept + Release
        if (btnAccept) btnAccept.style.display = 'inline-block';
        if (btnRelease) btnRelease.style.display = 'inline-block';
        if (poolSeparator) poolSeparator.style.display = 'inline-block';
      } else if (isClaimedByOther) {
        // State B (other): Show claimed indicator, no action buttons
        if (claimedIndicator) {
          claimedIndicator.style.display = 'inline-block';
          claimedIndicator.textContent = `Claimed by ${t.claimed_by_name || 'another expert'}`;
        }
        if (poolSeparator) poolSeparator.style.display = 'inline-block';
      }
      // State C (owned): No pool buttons, show normal workflow buttons
    }

    // Hide normal workflow buttons for pool tickets that aren't owned by current user
    const btnNext = document.getElementById('btn-next');
    const btnResolve = document.getElementById('btn-resolve');
    const btnAiAssist = document.getElementById('btn-ai-assist');
    const btnReassign = document.getElementById('btn-reassign');
    const btnSelfAssign = document.getElementById('btn-self-assign');

    // Show workflow buttons only if: not in pool, OR owned by me, OR (owned by someone and I'm admin), OR admin viewing pool ticket
    const canModifyTicket = !isInPool || isOwnedByMe || (isOwned && currentRole === 'admin') || currentRole === 'admin';
    const showWorkflowButtons = canModifyTicket;

    if (btnNext) btnNext.style.display = (isCustomer || !showWorkflowButtons) ? 'none' : 'inline-block';
    if (btnResolve) btnResolve.style.display = (isCustomer || !showWorkflowButtons) ? 'none' : 'inline-block';
    if (btnAiAssist) btnAiAssist.style.display = (isCustomer || !showWorkflowButtons) ? 'none' : 'inline-block';
    if (btnReassign) btnReassign.style.display = (isCustomer || !showWorkflowButtons) ? 'none' : 'inline-block';
    if (btnSelfAssign) btnSelfAssign.style.display = 'none'; // Only shown via specific conditions elsewhere

    // Make form fields read-only for pool tickets claimed by others (view-only mode)
    const isReadOnly = isClaimedByOther || (isInPool && !isClaimedByMe && !isOwnedByMe);
    const titleInput = document.getElementById('td-title');
    const descInput = document.getElementById('td-desc');
    const prioritySelect = document.getElementById('td-priority');

    if (titleInput) {
      titleInput.disabled = isReadOnly || isCustomer;
      titleInput.style.background = (isReadOnly || isCustomer) ? 'var(--card-hover)' : '';
    }
    if (descInput) {
      descInput.disabled = isReadOnly || isCustomer;
      descInput.style.background = (isReadOnly || isCustomer) ? 'var(--card-hover)' : '';
    }
    if (prioritySelect) {
      prioritySelect.disabled = isReadOnly || isCustomer;
      prioritySelect.style.background = (isReadOnly || isCustomer) ? 'var(--card-hover)' : '';
    }

    // Expert/Admin actions - hide for customers
    document.getElementById('expert-actions').style.display = isCustomer ? 'none' : 'flex';

    // Customer actions - show for customers
    document.getElementById('customer-actions').style.display = isCustomer ? 'flex' : 'none';

    // Accept/Decline buttons - only show when ticket is Resolved
    document.getElementById('btn-accept-resolution').style.display = (isCustomer && isResolved) ? 'inline-block' : 'none';
    document.getElementById('btn-decline-resolution').style.display = (isCustomer && isResolved) ? 'inline-block' : 'none';
    // Close Request button - show for customers when ticket is not already Closed/Resolved
    const closeBtn = document.getElementById('btn-customer-close');
    if (closeBtn) {
      const isClosed = ticket.status === 'Closed' || ticket.status === 'Resolved';
      closeBtn.style.display = (isCustomer && !isClosed) ? 'inline-block' : 'none';
    }

    // Mark as System button - hide if already a system source (APO-48)
    const markSystemBtn = document.getElementById('btn-mark-system');
    if (markSystemBtn) {
      markSystemBtn.style.display = isSystemSource ? 'none' : 'inline-block';
    }

    // Customer view - extensive read-only mode
    if (isCustomer) {
      applyCustomerViewRestrictions();
    } else {
      removeCustomerViewRestrictions();
    }
  }

  function applyCustomerViewRestrictions() {
    // Hide admin sections entirely for customers
    document.querySelectorAll('.admin-section').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.admin-section-card').forEach(el => el.style.display = 'none');

    // Hide admin toggle button
    const adminToggleBtn = document.getElementById('btn-admin-view-toggle');
    if (adminToggleBtn) adminToggleBtn.style.display = 'none';

    // Make title read-only
    const titleInput = document.getElementById('td-title');
    if (titleInput) {
      titleInput.disabled = true;
      titleInput.style.background = 'var(--card-hover)';
    }

    // Make description read-only
    const descInput = document.getElementById('td-desc');
    if (descInput) {
      descInput.disabled = true;
      descInput.style.background = 'var(--card-hover)';
    }

    // Make priority read-only
    const prioritySelect = document.getElementById('td-priority');
    if (prioritySelect) {
      prioritySelect.disabled = true;
      prioritySelect.style.background = 'var(--card-hover)';
    }

    // Hide AI panel for customers
    const aiPanel = document.getElementById('ai-panel');
    if (aiPanel) aiPanel.style.display = 'none';

    // Update note input placeholder for customers (public reply)
    const noteInput = document.getElementById('td-note');
    if (noteInput) {
      noteInput.placeholder = 'Add a reply…';
    }

    // Simplify SLA display for customers
    simplifyCustomerSLADisplay();
  }

  function removeCustomerViewRestrictions() {
    // Re-enable title
    const titleInput = document.getElementById('td-title');
    if (titleInput) {
      titleInput.disabled = false;
      titleInput.style.background = '';
    }

    // Re-enable description
    const descInput = document.getElementById('td-desc');
    if (descInput) {
      descInput.disabled = false;
      descInput.style.background = '';
    }

    // Re-enable priority
    const prioritySelect = document.getElementById('td-priority');
    if (prioritySelect) {
      prioritySelect.disabled = false;
      prioritySelect.style.background = '';
    }

    // Restore note input placeholder
    const noteInput = document.getElementById('td-note');
    if (noteInput) {
      noteInput.placeholder = 'Add an internal note…';
    }
  }

  function simplifyCustomerSLADisplay() {
    // For customers, show simplified SLA text
    const slaText = document.getElementById('td-sla-text');
    if (!slaText) return;

    const t = tickets.find(x => x.id === currentTicketId);
    if (!t) return;

    // Build customer-friendly SLA text
    let customerSlaText = '';

    if (t.sla_response_deadline) {
      const respDeadline = new Date(t.sla_response_deadline);
      if (respDeadline > new Date()) {
        customerSlaText += `Response expected by: ${respDeadline.toLocaleDateString()} ${respDeadline.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
      }
    }

    if (t.sla_deadline) {
      const resDeadline = new Date(t.sla_deadline);
      if (customerSlaText) customerSlaText += '<br>';
      customerSlaText += `Target resolution by: ${resDeadline.toLocaleDateString()} ${resDeadline.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
    }

    if (!customerSlaText) {
      customerSlaText = 'We will respond as soon as possible.';
    }

    slaText.innerHTML = customerSlaText;

    // Hide SLA progress bar and technical badge for customers
    const slaProgressContainer = document.getElementById('td-sla-progress-container');
    if (slaProgressContainer) slaProgressContainer.style.display = 'none';

    const slaBadge = document.getElementById('td-sla-badge');
    if (slaBadge) slaBadge.style.display = 'none';

    const slaName = document.getElementById('td-sla-name');
    if (slaName) slaName.style.display = 'none';
  }

  function focusCommentBox() {
    const noteInput = document.getElementById('td-note');
    noteInput.focus();
    noteInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Add note/comment to ticket
  async function addNote() {
    const noteInput = document.getElementById('td-note');
    const comment = noteInput.value.trim();

    if (!comment) {
      alert('Please enter a comment');
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';
      const currentRole = window.role || role;
      const isCustomer = currentRole === 'customer';

      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${currentTicketId}/comment`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          comment: comment,
          is_public: isCustomer ? true : false // Internal notes for staff by default
        })
      });

      const data = await response.json();

      if (data.success) {
        noteInput.value = '';
        // Reload ticket details to show new activity
        await renderTicketDetail();
        // Expand activity panel to show new comment
        const wrapper = document.getElementById('td-activity-wrapper');
        if (wrapper && wrapper.style.display === 'none') {
          toggleActivityPanel();
        }
      } else {
        alert(data.message || 'Failed to add comment');
      }
    } catch (error) {
      console.error('Error adding comment:', error);
      alert('Error adding comment. Please try again.');
    }
  }

  // ---- Assignment functions ----
  async function loadExpertsDropdown(currentAssigneeId = null) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      if (!token || !tenantCode) {
        console.error('Missing authentication credentials');
        return;
      }

      // Fetch experts from API if not cached
      if (cachedExperts.length === 0) {
        const response = await fetch(`${API_BASE}/api/auth/experts`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success && Array.isArray(data.experts)) {
          cachedExperts = data.experts;
        } else {
          console.error('Failed to load experts:', data.error);
          return;
        }
      }

      // Populate the dropdown
      const dropdown = document.getElementById('td-assignee');
      if (!dropdown) return;

      // Clear existing options except the first placeholder
      dropdown.innerHTML = '<option value="">-- Select Expert --</option>';

      // Add expert options
      cachedExperts.forEach(expert => {
        const option = document.createElement('option');
        option.value = expert.id;
        option.textContent = `${expert.full_name} (${expert.username})`;
        dropdown.appendChild(option);
      });

      // Set current assignee if provided
      if (currentAssigneeId) {
        dropdown.value = currentAssigneeId;
      }
    } catch (error) {
      console.error('Error loading experts dropdown:', error);
    }
  }

  async function assignTicket() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      if (!token || !tenantCode) {
        alert('Not authenticated');
        return;
      }

      const dropdown = document.getElementById('td-assignee');
      const selectedExpertId = dropdown.value;

      if (!selectedExpertId) {
        alert('Please select an expert to assign the ticket to');
        return;
      }

      if (!currentTicketId) {
        alert('No ticket selected');
        return;
      }

      // Call the assignment API
      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${currentTicketId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          assignee_id: selectedExpertId,
          comment: 'Assigned via ticket detail page'
        })
      });

      const data = await response.json();

      if (data.success) {
        alert('Ticket assigned successfully! Email notification sent.');
        // Reload the ticket detail to show updated information
        renderTicketDetail();
      } else {
        alert('Failed to assign ticket: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error assigning ticket:', error);
      alert('Error assigning ticket. Please try again.');
    }
  }

  // ---- Completion Modal logic (Admin/Expert) ----
  let dlgAction=null;
  function roleAllowsCompletion(){ return role==='admin' || role==='expert'; }
  function openCompletion(action){
    if(!roleAllowsCompletion()){ alert('This action is available to Admin/Expert in the demo.'); return; }
    dlgAction = action;
    document.getElementById('dlg-title').textContent = action==='resolve' ? 'Resolve ticket' : 'Reassign ticket';
    document.getElementById('dlg-note').value='';
    document.getElementById('dlg-error').style.display='none';
    const assRow = document.getElementById('dlg-assignee-row');
    assRow.style.display = (action==='reassign') ? 'block' : 'none';
    if(action==='reassign'){
      document.getElementById('dlg-assignee').value = '';
      loadReassignExpertsDropdown();
    }
    document.getElementById('dlg').style.display='flex';
    setTimeout(()=>document.getElementById('dlg-note').focus(), 0);
  }
  function closeDlg(){ document.getElementById('dlg').style.display='none'; }

  async function loadReassignExpertsDropdown() {
    const dropdown = document.getElementById('dlg-assignee');
    if (!dropdown) return;

    // Clear and add placeholder
    dropdown.innerHTML = '<option value="">-- Select Expert --</option>';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      // Use cached experts if available, otherwise fetch
      if (cachedExperts.length === 0) {
        const response = await fetch(`${API_BASE}/api/auth/experts`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        if (data.success && Array.isArray(data.experts)) {
          cachedExperts = data.experts;
        }
      }

      // Populate dropdown with experts
      cachedExperts.forEach(expert => {
        const option = document.createElement('option');
        option.value = expert.id;
        option.textContent = `${expert.full_name} (${expert.username})`;
        option.dataset.fullName = expert.full_name;
        dropdown.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading experts for reassign:', error);
    }
  }

  function submitDlg(){
    const note = (document.getElementById('dlg-note').value||'').trim();
    const err = document.getElementById('dlg-error');
    if(!note){ err.textContent='Completion text is required.'; err.style.display='block'; return; }
    const t=tickets.find(x=>x.id===currentTicketId);
    if(!t){ closeDlg(); return; }
    const act=document.getElementById('td-activity');
    const log = document.createElement('div');
    log.className='card p-12 mb-8';
    if(dlgAction==='resolve'){
      log.innerHTML = `<strong>${role==='admin'?'Admin':'Expert'}</strong>: Resolved — ${note}`;
      act.appendChild(log);
      setStatus('Resolved', note, /*silent*/true);
    } else if(dlgAction==='reassign'){
      const dropdown = document.getElementById('dlg-assignee');
      const newAsgId = (dropdown.value||'').trim();
      if(!newAsgId){ err.textContent='Please select an expert.'; err.style.display='block'; return; }

      // Get the expert name from the selected option
      const selectedOption = dropdown.options[dropdown.selectedIndex];
      const expertName = selectedOption.dataset.fullName || selectedOption.textContent;

      // Call API to reassign the ticket
      reassignTicket(currentTicketId, newAsgId, note, expertName, log, act);
      return; // Don't close dialog until API call completes
    }
    closeDlg();
  }

  async function reassignTicket(ticketId, assigneeId, note, expertName, logEl, actContainer) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${ticketId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          assignee_id: assigneeId,
          status: 'In Progress',
          comment: note
        })
      });

      const data = await response.json();

      if (data.success) {
        // Update local ticket data
        const t = tickets.find(x => x.id === ticketId);
        if (t) {
          t.assignee_id = assigneeId;
          t.assignee_name = expertName;
          t.status = 'In Progress';
          t.pool_status = 'IN_PROGRESS_OWNED';
          t.owned_by_expert_id = assigneeId;
        }

        // Update the assignee dropdown in the detail view
        document.getElementById('td-assignee').value = assigneeId;

        // Add activity log entry
        logEl.innerHTML = `<strong>${role==='admin'?'Admin':'Expert'}</strong>: Reassigned to ${expertName} — ${note}`;
        actContainer.appendChild(logEl);

        renderList();
        renderExpertDash();
        closeDlg();
      } else {
        const err = document.getElementById('dlg-error');
        err.textContent = 'Failed to reassign: ' + (data.message || 'Unknown error');
        err.style.display = 'block';
      }
    } catch (error) {
      console.error('Error reassigning ticket:', error);
      const err = document.getElementById('dlg-error');
      err.textContent = 'Error reassigning ticket. Please try again.';
      err.style.display = 'block';
    }
  }

  // ---- SLA updates on detail view ----
  function updateTicketSLA() {
    const t = tickets.find(x => x.id === currentTicketId);
    if (!t) return;

    const slaNameEl = document.getElementById('td-sla-name');
    const badge = document.getElementById('td-sla-badge');
    const progContainer = document.getElementById('td-sla-progress-container');
    const prog = document.getElementById('td-sla-progress');
    const text = document.getElementById('td-sla-text');
    if (!badge || !prog || !text) return;

    const sla = t.sla_status;

    // No SLA applied
    if (!sla || !sla.sla_definition_id) {
      if (slaNameEl) slaNameEl.textContent = '';
      badge.className = 'badge sla';
      badge.textContent = 'No SLA';
      if (progContainer) progContainer.style.display = 'none';
      text.textContent = 'No SLA policy applied to this ticket';
      return;
    }

    // Show SLA name
    if (slaNameEl) slaNameEl.textContent = sla.sla_name || 'SLA Policy';

    // Determine which phase we're in and show appropriate info
    const phase = sla.sla_phase || 'awaiting_response';
    const response = sla.response || {};
    const resolve = sla.resolve || {};

    let badgeClass = '';
    let badgeText = '';
    let statusText = '';
    let showProgress = false;
    let progressPct = 0;

    if (phase === 'resolved') {
      // Ticket is resolved - show final state
      const respState = response.state;
      const resState = resolve.state;
      if (respState === 'met' && resState === 'met') {
        badgeClass = 'ok';
        badgeText = 'SLA Met';
        statusText = 'Response and resolution targets met';
      } else if (respState === 'breached' || resState === 'breached') {
        badgeClass = 'danger';
        badgeText = 'SLA Breached';
        statusText = (respState === 'breached' ? 'Response SLA breached' : '') +
                     (respState === 'breached' && resState === 'breached' ? ' & ' : '') +
                     (resState === 'breached' ? 'Resolution SLA breached' : '');
      } else {
        badgeClass = 'ok';
        badgeText = 'Resolved';
        statusText = 'Ticket resolved within SLA';
      }
      showProgress = false;
    } else if (phase === 'awaiting_response') {
      // Waiting for first response
      const respState = response.state;
      progressPct = response.percent_elapsed || 0;

      if (respState === 'breached') {
        badgeClass = 'danger';
        badgeText = 'Response Overdue';
      } else if (respState === 'near_breach') {
        badgeClass = 'warn';
        badgeText = 'Response Due Soon';
      } else {
        badgeClass = 'ok';
        badgeText = 'Awaiting Response';
      }

      const dueAt = response.due_at ? new Date(response.due_at) : null;
      if (sla.outside_business_hours) {
        statusText = 'SLA clock paused (outside business hours)';
        if (dueAt) statusText += ' - Response due at ' + dueAt.toLocaleString();
      } else if (dueAt) {
        statusText = 'Response due at ' + dueAt.toLocaleString();
      } else {
        statusText = 'Waiting for first response';
      }
      showProgress = true;
    } else if (phase === 'in_progress') {
      // Responded, now tracking resolution
      const resState = resolve.state;
      progressPct = resolve.percent_elapsed || 0;

      if (resState === 'breached') {
        badgeClass = 'danger';
        badgeText = 'Resolution Overdue';
      } else if (resState === 'near_breach') {
        badgeClass = 'warn';
        badgeText = 'Resolution Due Soon';
      } else {
        badgeClass = 'ok';
        badgeText = 'In Progress';
      }

      const dueAt = resolve.due_at ? new Date(resolve.due_at) : null;
      if (sla.outside_business_hours) {
        statusText = 'SLA clock paused (outside business hours)';
        if (dueAt) statusText += ' - Resolution due at ' + dueAt.toLocaleString();
      } else if (dueAt) {
        statusText = 'Resolution due at ' + dueAt.toLocaleString();
      } else {
        statusText = 'Working on resolution';
      }
      showProgress = true;
    }

    // Apply to DOM
    badge.className = 'badge sla ' + badgeClass;
    badge.textContent = badgeText;

    if (progContainer) {
      progContainer.style.display = showProgress ? 'block' : 'none';
    }
    prog.style.width = Math.min(progressPct, 100) + '%';
    text.textContent = statusText;
  }

  // ---- Status transitions ----
  // Ownership workflow: Open tickets must go through claim flow (pool view)
  // In Progress/Pending tickets support standard transitions
  // 'Pending' is used for 'Waiting on Customer' - SLA is paused
  const TRANSITIONS = {
    'Open': [],  // Must use claim flow from pool view - no direct transitions
    'In Progress': ['Pending', 'Resolved'],  // Pending = Waiting on Customer (SLA pause)
    'Pending': ['In Progress', 'Resolved'],  // Resume from waiting
    'Resolved': ['Closed', 'In Progress'],  // Can reopen
    'Closed': []
  };
  function advanceStatus(){ const t=tickets.find(x=>x.id===currentTicketId); if(!t) return; const opts = TRANSITIONS[t.status] || []; if(!opts.length) return alert('No further transitions.'); const next = opts[0]; if(next==='Resolved') { openCompletion('resolve'); } else { setStatus(next); } }
  function setResolved(){ openCompletion('resolve'); }
  async function setStatus(newStatus, comment=null, silent=false){
    const t=tickets.find(x=>x.id===currentTicketId);
    if(!t) return;

    if(!(TRANSITIONS[t.status]||[]).includes(newStatus) && newStatus!=='Resolved') {
      alert(`Invalid transition from ${t.status} to ${newStatus}`);
      return;
    }

    const prev=t.status;

    // Call backend API to persist status change
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const requestBody = { status: newStatus };
      if (comment) {
        requestBody.comment = comment;
      }

      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${currentTicketId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      const data = await response.json();

      if (!data.success) {
        alert('Failed to update ticket status: ' + (data.message || 'Unknown error'));
        return;
      }

      // Update local ticket object
      t.status=newStatus;
      if (document.getElementById('td-status')) document.getElementById('td-status').value=newStatus;

      // Reload ticket details to get updated activities from server
      try {
        await renderTicketDetail();
        renderList();
        renderAdminDash();
        renderExpertDash();
      } catch (renderErr) {
        console.error('Error refreshing UI after status update (update was successful):', renderErr);
      }

    } catch (error) {
      console.error('Error updating ticket status:', error);
      alert('Failed to update ticket status: ' + error.message);
    }
  }

  // ---- Customer Resolution Actions ----
  async function acceptResolution() {
    const t = tickets.find(x => x.id === currentTicketId);
    if (!t || t.status !== 'Resolved') return alert('This ticket is not resolved yet.');

    if (!confirm('Are you satisfied with the resolution? This will close the ticket.')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${currentTicketId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          status: 'Closed',
          activity: 'Customer accepted the resolution and closed the ticket.'
        })
      });

      const data = await response.json();
      if (data.success) {
        t.status = 'Closed';
        alert('Thank you! Ticket has been closed.');
        renderTicketDetail();
      } else {
        alert('Error: ' + (data.error || 'Could not accept resolution'));
      }
    } catch (error) {
      console.error('Error accepting resolution:', error);
      alert('Error accepting resolution: ' + error.message);
    }
  }

  async function customerCloseRequest() {
    const t = tickets.find(x => x.id === currentTicketId);
    if (!t) return;
    if (t.status === 'Closed' || t.status === 'Resolved') return alert('This ticket is already closed.');
    if (!confirm('Are you sure you want to close this request?')) return;
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';
      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${currentTicketId}`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'Closed', activity: 'Customer closed the request.' })
      });
      const data = await response.json();
      if (data.success) {
        t.status = 'Closed';
        alert('Request has been closed.');
        renderTicketDetail();
      } else {
        alert('Error: ' + (data.error || 'Could not close request'));
      }
    } catch (error) {
      console.error('Error closing request:', error);
      alert('Error closing request: ' + error.message);
    }
  }

  function declineResolution() {
    const t = tickets.find(x => x.id === currentTicketId);
    if (!t || t.status !== 'Resolved') return alert('This ticket is not resolved yet.');

    // Reset and show modal
    document.getElementById('decline-reason').value = '';
    document.getElementById('decline-attachments').value = '';
    document.getElementById('decline-error').style.display = 'none';
    document.getElementById('decline-resolution-modal').style.display = 'flex';
  }

  function closeDeclineModal() {
    document.getElementById('decline-resolution-modal').style.display = 'none';
  }

  async function submitDeclineResolution() {
    const reason = document.getElementById('decline-reason').value.trim();
    const fileInput = document.getElementById('decline-attachments');
    const errorDiv = document.getElementById('decline-error');

    if (!reason) {
      errorDiv.textContent = 'Please provide a reason for declining the resolution.';
      errorDiv.style.display = 'block';
      return;
    }

    const t = tickets.find(x => x.id === currentTicketId);
    if (!t) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      // Build activity message with attachment info
      let activityMsg = `Customer declined the resolution. Reason: ${reason}`;
      if (fileInput.files.length > 0) {
        const fileNames = Array.from(fileInput.files).map(f => f.name).join(', ');
        activityMsg += ` [Attachments: ${fileNames}]`;
      }

      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${currentTicketId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          status: 'Open',
          activity: activityMsg
        })
      });

      const data = await response.json();
      if (data.success) {
        t.status = 'Open';
        closeDeclineModal();
        alert('Sorry we didn\'t get it right, we will re-open and try again.');
        renderTicketDetail();
      } else {
        errorDiv.textContent = 'Error: ' + (data.error || 'Could not decline resolution');
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      console.error('Error declining resolution:', error);
      errorDiv.textContent = 'Error: ' + error.message;
      errorDiv.style.display = 'block';
    }
  }

  // ---- Experts & Customers ----
  let allExperts = []; // Store all experts for searching
  let expertSortField = 'full_name'; // Default sort field
  let expertSortAsc = true; // Sort direction
  let currentExpertId = null; // Store current expert for editing
  let currentTicket = null; // Store current ticket for operations
  let currentAISuggestions = null; // Store current AI suggestions

  // ---- AI Assistant Functions ----
  async function loadAISuggestions() {
    if (!currentTicketId) {
      alert('No ticket selected');
      return;
    }

    const panel = document.getElementById('ai-panel');
    const loading = document.getElementById('ai-loading');
    const content = document.getElementById('ai-content');

    // Show panel and loading state
    panel.style.display = 'block';
    loading.style.display = 'block';
    content.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/suggestions`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.suggestions) {
        currentAISuggestions = data.suggestions;
        renderAISuggestions(data.suggestions);
        loading.style.display = 'none';
        content.style.display = 'block';
      } else {
        throw new Error(data.error || 'Failed to get AI suggestions');
      }
    } catch (error) {
      console.error('Error loading AI suggestions:', error);
      loading.innerHTML = '<div style="color:#ffc">Error: ' + error.message + '</div>';
    }
  }

  function renderAISuggestions(suggestions) {
    // Analysis summary
    if (suggestions.analysis) {
      document.getElementById('ai-summary').textContent = suggestions.analysis.summary || '';

      const urgencyBadge = document.getElementById('ai-urgency');
      urgencyBadge.textContent = suggestions.analysis.urgency || 'unknown';
      urgencyBadge.style.background = getUrgencyColor(suggestions.analysis.urgency);

      document.getElementById('ai-complexity').textContent = 'Complexity: ' + (suggestions.analysis.complexity || 'unknown');
      document.getElementById('ai-time').textContent = 'Est: ' + (suggestions.analysis.estimatedTime || 'unknown');
    }

    // One-click actions
    const actionsDiv = document.getElementById('ai-actions');
    actionsDiv.innerHTML = '';
    if (suggestions.suggestedActions && suggestions.suggestedActions.length > 0) {
      suggestions.suggestedActions.forEach(action => {
        const btn = document.createElement('button');
        btn.className = 'btn ai-action';
        btn.innerHTML = action.label + '<span class="ai-action-confidence">' + action.confidence + '%</span>';
        btn.title = action.description;
        btn.onclick = () => executeAIAction(action);
        actionsDiv.appendChild(btn);
      });
    } else {
      actionsDiv.innerHTML = '<span style="opacity:0.7;font-size:13px">No suggested actions</span>';
    }

    // Draft response
    const draftSection = document.getElementById('ai-draft-section');
    if (suggestions.draftResponse) {
      draftSection.style.display = 'block';
      document.getElementById('ai-draft').value = suggestions.draftResponse;
    } else {
      draftSection.style.display = 'none';
    }

    // Next steps
    const stepsSection = document.getElementById('ai-steps-section');
    const stepsList = document.getElementById('ai-steps');
    if (suggestions.nextSteps && suggestions.nextSteps.length > 0) {
      stepsSection.style.display = 'block';
      stepsList.innerHTML = suggestions.nextSteps.map(s => '<li>' + s + '</li>').join('');
    } else {
      stepsSection.style.display = 'none';
    }

    // Warnings
    const warningsSection = document.getElementById('ai-warnings-section');
    if (suggestions.warnings && suggestions.warnings.length > 0) {
      warningsSection.style.display = 'block';
      document.getElementById('ai-warnings').innerHTML = suggestions.warnings.map(w => '<div>- ' + w + '</div>').join('');
    } else {
      warningsSection.style.display = 'none';
    }
  }

  function getUrgencyColor(urgency) {
    switch ((urgency || '').toLowerCase()) {
      case 'critical': return '#ef4444';
      case 'high': return '#f97316';
      case 'medium': return '#eab308';
      case 'low': return '#22c55e';
      default: return 'rgba(255,255,255,0.2)';
    }
  }

  async function executeAIAction(action) {
    if (!confirm('Execute action: ' + action.label + '?')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/execute-action`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action })
      });

      const data = await response.json();

      if (data.success) {
        alert('Action executed successfully: ' + action.label);
        // Refresh ticket detail
        await renderTicketDetail();
        await fetchTicketsFromAPI();
      } else {
        throw new Error(data.error || 'Failed to execute action');
      }
    } catch (error) {
      console.error('Error executing AI action:', error);
      alert('Error: ' + error.message);
    }
  }

  function useAIDraft() {
    const draft = document.getElementById('ai-draft').value;
    const noteInput = document.getElementById('td-note');
    if (noteInput) {
      noteInput.value = draft;
      hideAIPanel();
      noteInput.focus();
    }
  }

  function hideAIPanel() {
    document.getElementById('ai-panel').style.display = 'none';
  }

  // ---- AI CMDB Matching Functions ----
  let currentCMDBMatches = { cmdbItems: [], configItems: [] };

  async function loadLinkedCMDBItems() {
    if (!currentTicketId) return;

    const loading = document.getElementById('linked-cmdb-loading');
    const empty = document.getElementById('linked-cmdb-empty');
    const table = document.getElementById('linked-cmdb-table');
    const cisSection = document.getElementById('linked-cis-section');
    const badge = document.getElementById('cmdb-count-badge');

    loading.style.display = 'block';
    empty.style.display = 'none';
    table.style.display = 'none';
    cisSection.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/cmdb-items`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();
      loading.style.display = 'none';

      if (data.success) {
        const totalItems = (data.cmdbItems?.length || 0) + (data.configItems?.length || 0);

        if (totalItems === 0) {
          empty.style.display = 'block';
          badge.style.display = 'none';
        } else {
          badge.textContent = totalItems;
          badge.style.display = 'inline-flex';

          // Render CMDB items
          if (data.cmdbItems?.length > 0) {
            table.style.display = 'table';
            const tbody = document.getElementById('linked-cmdb-body');
            tbody.innerHTML = data.cmdbItems.map(item => `
              <tr>
                <td><strong>${item.asset_name || '—'}</strong></td>
                <td>${item.asset_category || '—'}</td>
                <td>${item.customer_name || '—'}</td>
                <td><span class="badge">${item.matched_by || 'manual'}</span></td>
                <td><button class="btn danger" onclick="unlinkCMDBItem(${item.cmdb_item_id})" style="padding:4px 8px;font-size:12px">Remove</button></td>
              </tr>
            `).join('');
          }

          // Render CIs
          if (data.configItems?.length > 0) {
            cisSection.style.display = 'block';
            const ciBody = document.getElementById('linked-cis-body');
            ciBody.innerHTML = data.configItems.map(ci => `
              <tr>
                <td>${ci.ci_name || '—'}</td>
                <td>${ci.category_field_value || '—'}</td>
                <td>${ci.parent_asset_name || '—'}</td>
                <td><button class="btn danger" onclick="unlinkCI(${ci.ci_id})" style="padding:4px 8px;font-size:12px">Remove</button></td>
              </tr>
            `).join('');
          }
        }
      }
    } catch (error) {
      console.error('Error loading linked CMDB items:', error);
      loading.style.display = 'none';
      empty.style.display = 'block';
    }
  }

  // ---- Auto CMDB Analysis ----
  let ticketAnalysisCache = {}; // Cache to avoid re-analyzing recently analyzed tickets
  let currentTicketSuggestions = [];

  async function autoAnalyzeCMDB() {
    if (!currentTicketId) return;

    const analyzingDiv = document.getElementById('ai-cmdb-analyzing');
    const noSuggestionsDiv = document.getElementById('ai-cmdb-no-suggestions');
    const suggestionsList = document.getElementById('ai-cmdb-suggestions-list');
    const badge = document.getElementById('ai-cmdb-suggestions-badge');
    const bulkActions = document.getElementById('ai-cmdb-bulk-actions');
    const reanalyzeBtn = document.getElementById('ai-cmdb-reanalyze-btn');

    // Show analyzing, hide others
    analyzingDiv.style.display = 'block';
    noSuggestionsDiv.style.display = 'none';
    suggestionsList.innerHTML = '';
    badge.style.display = 'none';
    if (bulkActions) bulkActions.style.display = 'none';
    if (reanalyzeBtn) reanalyzeBtn.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      // First, check for existing CMDB suggestions for this ticket
      const suggestionsRes = await fetch(`${API_BASE}/api/ai/${tenantCode}/cmdb-suggestions?ticket_id=${currentTicketId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (suggestionsRes.ok) {
        const suggestionsData = await suggestionsRes.json();
        if (suggestionsData.success && suggestionsData.suggestions && suggestionsData.suggestions.length > 0) {
          currentTicketSuggestions = suggestionsData.suggestions;
          analyzingDiv.style.display = 'none';
          renderTicketCMDBSuggestions();
          return;
        }
      }

      // Check if already analyzed recently (in memory cache)
      const cacheKey = `${tenantCode}-${currentTicketId}`;
      const lastAnalyzed = ticketAnalysisCache[cacheKey];
      if (lastAnalyzed && (Date.now() - lastAnalyzed) < 5 * 60 * 1000) {
        // Analyzed within last 5 minutes, show no suggestions
        analyzingDiv.style.display = 'none';
        noSuggestionsDiv.style.display = 'block';
        if (reanalyzeBtn) reanalyzeBtn.style.display = 'inline-block';
        return;
      }

      // Trigger CMDB auto-link analysis
      const analyzeRes = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/auto-link-cmdb`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
      });

      ticketAnalysisCache[cacheKey] = Date.now();

      if (analyzeRes.ok) {
        // After analysis, reload CMDB suggestions for this ticket
        const suggestionsRes2 = await fetch(`${API_BASE}/api/ai/${tenantCode}/cmdb-suggestions?ticket_id=${currentTicketId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (suggestionsRes2.ok) {
          const suggestionsData2 = await suggestionsRes2.json();
          if (suggestionsData2.success && suggestionsData2.suggestions && suggestionsData2.suggestions.length > 0) {
            currentTicketSuggestions = suggestionsData2.suggestions;
            analyzingDiv.style.display = 'none';
            renderTicketCMDBSuggestions();
            // Also reload linked items in case some were auto-approved
            loadLinkedCMDBItems();
            return;
          }
        }
      }

      // No suggestions found
      analyzingDiv.style.display = 'none';
      noSuggestionsDiv.style.display = 'block';
      if (reanalyzeBtn) reanalyzeBtn.style.display = 'inline-block';
      // Still reload linked items in case some were auto-approved
      loadLinkedCMDBItems();

    } catch (error) {
      console.error('Error in auto CMDB analysis:', error);
      analyzingDiv.style.display = 'none';
      noSuggestionsDiv.style.display = 'block';
      if (reanalyzeBtn) reanalyzeBtn.style.display = 'inline-block';
    }
  }

  function triggerCMDBAnalysis() {
    // Clear cache for this ticket to force re-analysis
    const tenantCode = window.tenant || 'apoyar';
    const cacheKey = `${tenantCode}-${currentTicketId}`;
    delete ticketAnalysisCache[cacheKey];
    autoAnalyzeCMDB();
  }

  function renderTicketCMDBSuggestions() {
    const noSuggestionsDiv = document.getElementById('ai-cmdb-no-suggestions');
    const suggestionsList = document.getElementById('ai-cmdb-suggestions-list');
    const badge = document.getElementById('ai-cmdb-suggestions-badge');
    const bulkActions = document.getElementById('ai-cmdb-bulk-actions');
    const reanalyzeBtn = document.getElementById('ai-cmdb-reanalyze-btn');

    if (!currentTicketSuggestions || currentTicketSuggestions.length === 0) {
      noSuggestionsDiv.style.display = 'block';
      suggestionsList.innerHTML = '';
      badge.style.display = 'none';
      if (bulkActions) bulkActions.style.display = 'none';
      if (reanalyzeBtn) reanalyzeBtn.style.display = 'inline-block';
      return;
    }

    noSuggestionsDiv.style.display = 'none';
    badge.textContent = currentTicketSuggestions.length;
    badge.style.display = 'inline-flex';
    if (bulkActions) bulkActions.style.display = 'flex';
    if (reanalyzeBtn) reanalyzeBtn.style.display = 'none';

    suggestionsList.innerHTML = currentTicketSuggestions.map((s, idx) => `
      <div class="card p-12 mb-8" style="border-left:3px solid #9f7aea;" id="suggestion-${s.id || idx}">
        <div class="row space">
          <div>
            <strong>${s.asset_name || 'Unknown Asset'}</strong>
            <div style="font-size:12px;color:var(--muted);">
              ${s.asset_category || ''} ${s.cmdb_customer ? '• ' + s.cmdb_customer : ''}
            </div>
            ${s.match_reason ? `<div style="font-size:11px;color:#9f7aea;margin-top:4px;">💡 ${s.match_reason}</div>` : ''}
            ${s.confidence_score ? `<div style="font-size:11px;color:var(--muted);margin-top:2px;">Confidence: ${s.confidence_score}%</div>` : ''}
          </div>
          <div class="row" style="gap:4px">
            <button class="btn success" onclick="acceptCMDBSuggestion(${s.id}, ${idx})" style="padding:4px 8px;font-size:12px;">✓ Accept</button>
            <button class="btn ghost" onclick="dismissCMDBSuggestion(${s.id}, ${idx})" style="padding:4px 8px;font-size:12px;">✕</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  async function acceptCMDBSuggestion(suggestionId, idx) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const res = await fetch(`${API_BASE}/api/ai/${tenantCode}/cmdb-suggestions/${suggestionId}/approve`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
      });

      if (res.ok) {
        // Remove from local list
        currentTicketSuggestions.splice(idx, 1);
        renderTicketCMDBSuggestions();
        // Reload linked items to show the newly accepted one
        loadLinkedCMDBItems();
        // Update dashboard count
        if (typeof loadCMDBSuggestionsCount === 'function') loadCMDBSuggestionsCount();
      } else {
        alert('Failed to accept suggestion');
      }
    } catch (error) {
      console.error('Error accepting suggestion:', error);
      alert('Error accepting suggestion');
    }
  }

  async function dismissCMDBSuggestion(suggestionId, idx) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const res = await fetch(`${API_BASE}/api/ai/${tenantCode}/cmdb-suggestions/${suggestionId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (res.ok) {
        // Remove from local list
        currentTicketSuggestions.splice(idx, 1);
        renderTicketCMDBSuggestions();
        if (typeof loadCMDBSuggestionsCount === 'function') loadCMDBSuggestionsCount();
      }
    } catch (error) {
      console.error('Error dismissing suggestion:', error);
    }
  }

  async function acceptAllCMDBSuggestions() {
    for (let i = currentTicketSuggestions.length - 1; i >= 0; i--) {
      const s = currentTicketSuggestions[i];
      await acceptCMDBSuggestion(s.id || s.cmdb_item_id, i);
    }
  }

  async function dismissAllCMDBSuggestions() {
    for (let i = currentTicketSuggestions.length - 1; i >= 0; i--) {
      const s = currentTicketSuggestions[i];
      await dismissCMDBSuggestion(s.id || s.cmdb_item_id, i);
    }
  }

  async function findCMDBMatches() {
    if (!currentTicketId) {
      alert('No ticket selected');
      return;
    }

    const resultsPanel = document.getElementById('cmdb-ai-results');
    const loading = document.getElementById('cmdb-ai-loading');
    const content = document.getElementById('cmdb-ai-content');

    resultsPanel.style.display = 'block';
    loading.style.display = 'block';
    content.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/cmdb-matches`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        currentCMDBMatches = {
          cmdbItems: data.cmdbItems || [],
          configItems: data.configItems || []
        };
        renderCMDBMatches(data);
        loading.style.display = 'none';
        content.style.display = 'block';
      } else {
        throw new Error(data.message || 'Failed to find CMDB matches');
      }
    } catch (error) {
      console.error('Error finding CMDB matches:', error);
      loading.innerHTML = '<div style="color:#ffc">Error: ' + error.message + '</div>';
    }
  }

  function renderCMDBMatches(data) {
    // Reasoning
    document.getElementById('cmdb-ai-reasoning').textContent = data.reasoning || '';

    // CMDB Items
    const itemsContainer = document.getElementById('cmdb-ai-items');
    if (data.cmdbItems?.length > 0) {
      itemsContainer.innerHTML = `
        <div style="font-weight:600;margin-bottom:8px">CMDB Items (${data.cmdbItems.length})</div>
        ${data.cmdbItems.map((item, idx) => `
          <div style="background:rgba(255,255,255,0.1);border-radius:6px;padding:10px;margin-bottom:8px;display:flex;align-items:center;gap:12px">
            <input type="checkbox" id="cmdb-match-${idx}" data-id="${item.id}" data-type="cmdb" checked style="width:18px;height:18px"/>
            <div style="flex:1">
              <div style="font-weight:600">${item.asset_name || '—'}</div>
              <div style="font-size:12px;opacity:0.8">${item.asset_category || '—'} | ${item.customer_name || '—'}</div>
              <div style="font-size:11px;opacity:0.7;margin-top:4px">${item.reason || ''}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:24px;font-weight:600">${item.confidence}%</div>
              <div style="font-size:11px;opacity:0.7">${item.relationship || 'affected'}</div>
            </div>
          </div>
        `).join('')}
      `;
    } else {
      itemsContainer.innerHTML = '<div style="opacity:0.7;font-size:13px">No matching CMDB items found</div>';
    }

    // CIs
    const cisContainer = document.getElementById('cmdb-ai-cis');
    if (data.configItems?.length > 0) {
      cisContainer.innerHTML = `
        <div style="font-weight:600;margin-bottom:8px">Configuration Items (${data.configItems.length})</div>
        ${data.configItems.slice(0, 10).map((ci, idx) => `
          <div style="background:rgba(255,255,255,0.1);border-radius:6px;padding:8px 10px;margin-bottom:6px;display:flex;align-items:center;gap:12px">
            <input type="checkbox" id="ci-match-${idx}" data-id="${ci.id}" data-type="ci" checked style="width:16px;height:16px"/>
            <div style="flex:1;font-size:13px">
              <span style="font-weight:500">${ci.ci_name || '—'}:</span> ${ci.category_field_value || '—'}
              <span style="opacity:0.7;font-size:11px;margin-left:8px">(${ci.parent_asset_name || 'Unknown'})</span>
            </div>
            <div style="font-weight:600">${ci.confidence}%</div>
          </div>
        `).join('')}
        ${data.configItems.length > 10 ? `<div style="font-size:12px;opacity:0.7">...and ${data.configItems.length - 10} more</div>` : ''}
      `;
    } else {
      cisContainer.innerHTML = '';
    }
  }

  function hideCMDBMatches() {
    document.getElementById('cmdb-ai-results').style.display = 'none';
  }

  async function applyAllCMDBMatches() {
    const cmdbIds = [];
    const ciIds = [];

    // Get selected CMDB items
    document.querySelectorAll('[id^="cmdb-match-"]:checked').forEach(cb => {
      cmdbIds.push(parseInt(cb.dataset.id));
    });

    // Get selected CIs
    document.querySelectorAll('[id^="ci-match-"]:checked').forEach(cb => {
      ciIds.push(parseInt(cb.dataset.id));
    });

    if (cmdbIds.length === 0 && ciIds.length === 0) {
      alert('No items selected');
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/apply-cmdb-matches`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ cmdbItemIds: cmdbIds, ciIds: ciIds })
      });

      const data = await response.json();

      if (data.success) {
        alert(`Linked ${data.cmdbLinked} CMDB items and ${data.ciLinked} CIs`);
        hideCMDBMatches();
        await loadLinkedCMDBItems();
      } else {
        throw new Error(data.message || 'Failed to apply matches');
      }
    } catch (error) {
      console.error('Error applying CMDB matches:', error);
      alert('Error: ' + error.message);
    }
  }

  async function unlinkCMDBItem(cmdbItemId) {
    if (!confirm('Remove this CMDB item from the ticket?')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/cmdb-items/${cmdbItemId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        await loadLinkedCMDBItems();
      } else {
        throw new Error(data.message || 'Failed to unlink item');
      }
    } catch (error) {
      console.error('Error unlinking CMDB item:', error);
      alert('Error: ' + error.message);
    }
  }

  async function unlinkCI(ciId) {
    if (!confirm('Remove this CI from the ticket?')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/cis/${ciId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        await loadLinkedCMDBItems();
      } else {
        throw new Error(data.message || 'Failed to unlink CI');
      }
    } catch (error) {
      console.error('Error unlinking CI:', error);
      alert('Error: ' + error.message);
    }
  }

  function showManualCMDBLink() {
    document.getElementById('cmdb-link-search').value = '';
    document.getElementById('cmdb-link-results').innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);">Enter search terms to find CMDB items</div>';
    document.getElementById('modal-cmdb-link').style.display = 'flex';
  }

  async function searchCMDBForLink() {
    const query = document.getElementById('cmdb-link-search').value.trim();
    const resultsDiv = document.getElementById('cmdb-link-results');

    if (query.length < 2) {
      resultsDiv.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);">Enter at least 2 characters to search</div>';
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items?search=${encodeURIComponent(query)}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success && data.items?.length > 0) {
        resultsDiv.innerHTML = data.items.map(item => `
          <div style="padding:12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s"
               onmouseover="this.style.background='var(--card-hover)'"
               onmouseout="this.style.background=''"
               onclick="linkCMDBItemManually(${item.id}, '${(item.asset_name || '').replace(/'/g, "\\'")}')">
            <div style="font-weight:600">${item.asset_name || '—'}</div>
            <div style="font-size:12px;color:var(--muted)">${item.asset_category || '—'} | ${item.customer_name || '—'}</div>
          </div>
        `).join('');
      } else {
        resultsDiv.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);">No items found matching "' + query + '"</div>';
      }
    } catch (error) {
      console.error('Error searching CMDB:', error);
      resultsDiv.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger);">Error searching CMDB</div>';
    }
  }

  async function linkCMDBItemManually(cmdbItemId, assetName) {
    if (!confirm(`Link "${assetName}" to this ticket?`)) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/cmdb-items`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ cmdbItemIds: [cmdbItemId], ciIds: [], matchedBy: 'manual' })
      });

      const data = await response.json();

      if (data.success) {
        closeModal('modal-cmdb-link');
        await loadLinkedCMDBItems();
      } else {
        throw new Error(data.message || 'Failed to link item');
      }
    } catch (error) {
      console.error('Error linking CMDB item:', error);
      alert('Error: ' + error.message);
    }
  }

  // Generic modal show function
  function showModal(title, content, buttons = []) {
    // Create or reuse generic modal
    let modal = document.getElementById('generic-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'generic-modal';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:600px">
          <div class="modal-header">
            <h3 id="generic-modal-title"></h3>
            <button class="btn ghost" onclick="closeModal('generic-modal')">&times;</button>
          </div>
          <div class="modal-body" id="generic-modal-body"></div>
          <div class="modal-footer" id="generic-modal-footer"></div>
        </div>`;
      document.body.appendChild(modal);
    }
    document.getElementById('generic-modal-title').textContent = title;
    document.getElementById('generic-modal-body').innerHTML = content;
    const footer = document.getElementById('generic-modal-footer');
    footer.innerHTML = buttons.map(b =>
      `<button class="btn ${b.class || ''}" onclick="${b.action || "closeModal('generic-modal')"}">${b.label}</button>`
    ).join('');
    modal.style.display = 'flex';
  }

  // Generic modal close function
  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
    }
  }

  // ---- AI Trends Dashboard Functions ----
  async function loadAITrends() {
    const loading = document.getElementById('ai-trends-loading');
    const content = document.getElementById('ai-trends-content');
    const period = document.getElementById('ai-trends-period').value;

    loading.style.display = 'block';
    content.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      // Fetch insights data
      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/insights?period=${Math.floor(period/24)}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        renderAITrends(data.data, period);
      } else {
        // If insights API fails, analyze tickets locally
        await analyzeTicketTrends(period);
      }
    } catch (error) {
      console.error('Error loading AI trends:', error);
      // Fallback to local ticket analysis
      await analyzeTicketTrends(period);
    }

    loading.style.display = 'none';
    content.style.display = 'block';
  }

  async function analyzeTicketTrends(hours) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      // Fetch recent tickets
      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const tickets = await response.json();
      if (!Array.isArray(tickets)) return;

      // Filter by time period
      const cutoff = Date.now() - (hours * 60 * 60 * 1000);
      const recentTickets = tickets.filter(t => new Date(t.created_at).getTime() > cutoff);

      // Analyze patterns
      const analysis = analyzeTicketPatterns(recentTickets);
      renderLocalTrends(analysis, recentTickets.length);

    } catch (error) {
      console.error('Error analyzing tickets:', error);
      document.getElementById('ai-trends-list').innerHTML = '<div style="text-align:center;padding:20px;opacity:0.6">Unable to analyze trends</div>';
    }
  }

  function analyzeTicketPatterns(tickets) {
    const patterns = {
      byCategory: {},
      byPriority: { critical: 0, high: 0, medium: 0, low: 0 },
      byStatus: {},
      trends: []
    };

    // Categorize by keywords
    const keywordCategories = {
      'login|password|authentication|access': 'Authentication Issues',
      'slow|performance|timeout|lag': 'Performance Issues',
      'error|crash|bug|broken': 'System Errors',
      'email|mail|outlook': 'Email Problems',
      'network|connection|wifi|vpn': 'Network Issues',
      'sync|integration|api': 'Integration Issues',
      'report|data|export': 'Reporting Issues'
    };

    tickets.forEach(ticket => {
      const text = (ticket.title + ' ' + ticket.description).toLowerCase();

      // Count priorities
      if (ticket.priority) patterns.byPriority[ticket.priority]++;

      // Count statuses
      patterns.byStatus[ticket.status] = (patterns.byStatus[ticket.status] || 0) + 1;

      // Categorize by keywords
      for (const [regex, category] of Object.entries(keywordCategories)) {
        if (new RegExp(regex).test(text)) {
          patterns.byCategory[category] = (patterns.byCategory[category] || 0) + 1;
        }
      }
    });

    // Identify trends (categories with 2+ tickets)
    for (const [category, count] of Object.entries(patterns.byCategory)) {
      if (count >= 2) {
        patterns.trends.push({
          title: category,
          count: count,
          severity: count >= 5 ? 'critical' : count >= 3 ? 'warning' : 'info',
          description: `${count} tickets related to ${category.toLowerCase()}`
        });
      }
    }

    // Add priority-based trends
    if (patterns.byPriority.critical >= 2) {
      patterns.trends.unshift({
        title: 'Critical Priority Spike',
        count: patterns.byPriority.critical,
        severity: 'critical',
        description: `${patterns.byPriority.critical} critical priority tickets need immediate attention`
      });
    }

    return patterns;
  }

  function renderLocalTrends(analysis, totalCount) {
    document.getElementById('ai-trends-count').textContent = analysis.trends.length;
    document.getElementById('ai-critical-count').textContent = analysis.byPriority.critical || 0;
    document.getElementById('ai-warning-count').textContent = analysis.byPriority.high || 0;
    document.getElementById('ai-analyzed-count').textContent = totalCount;

    const listEl = document.getElementById('ai-trends-list');

    if (analysis.trends.length === 0) {
      listEl.innerHTML = '<div style="text-align:center;padding:30px;opacity:0.6"><div style="font-size:18px;margin-bottom:8px">No significant trends detected</div><div style="font-size:13px">Ticket volume is normal with no unusual patterns</div></div>';
      return;
    }

    listEl.innerHTML = analysis.trends.map(trend => `
      <div class="ai-trend-card ${trend.severity}">
        <div class="row space">
          <div>
            <div style="font-weight:600;font-size:15px">${trend.title}</div>
            <div style="font-size:13px;opacity:0.8;margin-top:4px">${trend.description}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:24px;font-weight:800">${trend.count}</div>
            <div style="font-size:11px;opacity:0.7">tickets</div>
          </div>
        </div>
      </div>
    `).join('');

    // Show category breakdown
    const categoryEl = document.getElementById('ai-category-breakdown');
    const categoriesEl = document.getElementById('ai-categories');

    if (Object.keys(analysis.byCategory).length > 0) {
      categoryEl.style.display = 'block';
      categoriesEl.innerHTML = Object.entries(analysis.byCategory)
        .sort((a, b) => b[1] - a[1])
        .map(([cat, count]) => `<span class="ai-category-badge">${cat} <strong>${count}</strong></span>`)
        .join('');
    }
  }

  // Store current AI trends data for click-through (must be declared before use)
  let currentAITrendsData = { insights: [] };

  function renderAITrends(data, period) {
    const { insights = [], ticketStats = {} } = data;

    // Store data for click-through functionality
    currentAITrendsData = data;
    console.log('AI Trends data stored:', currentAITrendsData);
    console.log('Insights with affected_tickets:', insights.filter(i => i.affected_tickets && i.affected_tickets.length > 0));

    document.getElementById('ai-trends-count').textContent = insights.length;

    // Count unique tickets affected by severity (not insight count)
    const allAffectedTickets = new Set();
    const criticalTickets = new Set();
    const warningTickets = new Set();
    insights.forEach(i => {
      if (i.affected_tickets && i.affected_tickets.length > 0) {
        i.affected_tickets.forEach(t => allAffectedTickets.add(t));
        if (i.severity === 'critical') {
          i.affected_tickets.forEach(t => criticalTickets.add(t));
        } else if (i.severity === 'warning') {
          i.affected_tickets.forEach(t => warningTickets.add(t));
        }
      }
    });

    // Update all counts - show tickets affected for Active Trends
    document.getElementById('ai-trends-tickets').textContent = `${allAffectedTickets.size} tickets affected`;
    document.getElementById('ai-critical-count').textContent = criticalTickets.size;
    document.getElementById('ai-warning-count').textContent = warningTickets.size;
    document.getElementById('ai-analyzed-count').textContent = ticketStats.analyzed || 0;

    const listEl = document.getElementById('ai-trends-list');

    if (insights.length === 0) {
      listEl.innerHTML = '<div style="text-align:center;padding:30px;opacity:0.6"><div style="font-size:18px;margin-bottom:8px">No active trends</div><div style="font-size:13px">All systems operating normally</div></div>';
      return;
    }

    listEl.innerHTML = insights.map(insight => {
      const hasTickets = insight.affected_tickets && insight.affected_tickets.length > 0;
      const ticketIds = hasTickets ? insight.affected_tickets.join(',') : '';
      const clickAction = hasTickets ? `onclick="openTicketsFromInsight([${ticketIds}], '${(insight.title || '').replace(/'/g, "\\'")}')"` : '';
      const cursorStyle = hasTickets ? 'cursor:pointer' : '';

      return `
        <div class="ai-trend-card ${insight.severity || 'info'}" ${clickAction} style="${cursorStyle};transition:all 0.2s" ${hasTickets ? 'onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.3)\'" onmouseout="this.style.transform=\'\';this.style.boxShadow=\'\'"' : ''}>
          <div class="row space">
            <div style="flex:1">
              <div style="font-weight:600;font-size:15px">${insight.title}</div>
              <div style="font-size:13px;opacity:0.8;margin-top:4px">${insight.description}</div>
              ${hasTickets ? `
                <div style="margin-top:10px">
                  <span style="background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500">
                    📋 ${insight.affected_tickets.length} ticket${insight.affected_tickets.length > 1 ? 's' : ''} - Click to view
                  </span>
                </div>
              ` : ''}
            </div>
            <div style="text-align:right">
              ${insight.metrics?.count ? `<div style="font-size:24px;font-weight:800">${insight.metrics.count}</div><div style="font-size:11px;opacity:0.7">occurrences</div>` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // View all tickets from all trends
  function viewAllTrendTickets() {
    console.log('viewAllTrendTickets called, currentAITrendsData:', currentAITrendsData);
    const allTicketIds = [];
    (currentAITrendsData.insights || []).forEach(insight => {
      console.log('Insight:', insight.title, 'affected_tickets:', insight.affected_tickets);
      if (insight.affected_tickets && insight.affected_tickets.length > 0) {
        allTicketIds.push(...insight.affected_tickets);
      }
    });

    console.log('All ticket IDs collected:', allTicketIds);

    if (allTicketIds.length === 0) {
      alert('No tickets associated with current trends. The AI insights may not have ticket IDs attached.');
      return;
    }

    // Remove duplicates
    const uniqueIds = [...new Set(allTicketIds)];
    console.log('Unique IDs to filter:', uniqueIds);
    openTicketsFromInsight(uniqueIds, 'All Trend Tickets');
  }

  // View tickets filtered by severity
  function viewTrendTicketsBySeverity(severity) {
    console.log('viewTrendTicketsBySeverity called with:', severity);
    console.log('currentAITrendsData:', currentAITrendsData);
    const ticketIds = [];
    (currentAITrendsData.insights || []).forEach(insight => {
      console.log('Checking insight:', insight.title, 'severity:', insight.severity, 'affected_tickets:', insight.affected_tickets);
      if (insight.severity === severity && insight.affected_tickets && insight.affected_tickets.length > 0) {
        ticketIds.push(...insight.affected_tickets);
      }
    });

    console.log('Ticket IDs for severity', severity, ':', ticketIds);

    if (ticketIds.length === 0) {
      alert(`No tickets with ${severity} severity found in the current trends.`);
      return;
    }

    // Remove duplicates
    const uniqueIds = [...new Set(ticketIds)];
    const title = severity === 'critical' ? 'Critical Issue Tickets' : 'Warning Tickets';
    openTicketsFromInsight(uniqueIds, title);
  }

  async function renderExperts(){
    const body=document.getElementById('experts-body');
    if(!body) return;
    body.innerHTML='<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.experts) {
        allExperts = data.experts;

        // Apply search filter
        const q=(document.getElementById('expert-search').value||'').toLowerCase();
        let filteredExperts = allExperts.filter(e=>
          !q ||
          (e.full_name||'').toLowerCase().includes(q) ||
          (e.username||'').toLowerCase().includes(q) ||
          (e.location||'').toLowerCase().includes(q) ||
          (e.postcode||'').toLowerCase().includes(q) ||
          (e.email||'').toLowerCase().includes(q)
        );

        // Apply sorting
        filteredExperts.sort((a, b) => {
          let valA, valB;
          switch (expertSortField) {
            case 'full_name':
              valA = (a.full_name || a.username || '').toLowerCase();
              valB = (b.full_name || b.username || '').toLowerCase();
              break;
            case 'username':
              valA = (a.username || '').toLowerCase();
              valB = (b.username || '').toLowerCase();
              break;
            case 'location':
              valA = (a.location || '').toLowerCase();
              valB = (b.location || '').toLowerCase();
              break;
            case 'email':
              valA = (a.email || '').toLowerCase();
              valB = (b.email || '').toLowerCase();
              break;
            case 'open_tickets':
              valA = a.open_tickets || 0;
              valB = b.open_tickets || 0;
              break;
            case 'last_login':
              valA = a.last_login ? new Date(a.last_login).getTime() : 0;
              valB = b.last_login ? new Date(b.last_login).getTime() : 0;
              break;
            default:
              valA = (a.full_name || '').toLowerCase();
              valB = (b.full_name || '').toLowerCase();
          }
          if (valA < valB) return expertSortAsc ? -1 : 1;
          if (valA > valB) return expertSortAsc ? 1 : -1;
          return 0;
        });

        // Store total count before pagination
        const totalFiltered = filteredExperts.length;
        const pageSize = getPageSize('experts');

        // Validate current page
        const maxPage = Math.max(1, Math.ceil(totalFiltered / pageSize));
        if (expertPage > maxPage) expertPage = maxPage;

        // Apply pagination
        const paginatedExperts = paginateArray(filteredExperts, expertPage, pageSize);

        // Update expert count
        const countDiv = document.getElementById('expert-count');
        if (countDiv) {
          countDiv.textContent = `Showing ${totalFiltered} of ${allExperts.length} experts`;
        }

        // Render pagination controls
        renderPaginationControls('expert-pagination', expertPage, totalFiltered, pageSize, 'setExpertPage', 'setExpertPageSize', 'experts');

        // Render experts
        body.innerHTML='';
        const cardsContainer = document.getElementById('experts-cards');
        if (cardsContainer) cardsContainer.innerHTML = '';

        if (paginatedExperts.length === 0) {
          body.innerHTML='<tr><td colspan="7" style="text-align:center;">No experts found</td></tr>';
          if (cardsContainer) cardsContainer.innerHTML = '<div class="mobile-card"><div style="text-align:center;color:var(--muted)">No experts found</div></div>';
        } else {
          paginatedExperts.forEach(e=>{
            const lastLogin = formatLastLogin(e.last_login);
            const openTickets = e.open_tickets || 0;
            const ticketBadge = openTickets > 0
              ? `<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:12px;font-weight:600">${openTickets}</span>`
              : '<span style="color:#6b7280">0</span>';

            // Desktop table row
            const tr=document.createElement('tr');
            tr.innerHTML=`
              <td>${e.full_name || e.username}</td>
              <td>${e.username}</td>
              <td>${e.location || '-'}</td>
              <td>${e.email || '-'}</td>
              <td>${ticketBadge}</td>
              <td>${lastLogin}</td>
              <td>
                <button class="btn ghost" style="padding:4px 8px;font-size:12px" onclick="viewExpertDetail(${e.id})">View</button>
                <button class="btn ghost" style="padding:4px 8px;font-size:12px" onclick="showEditExpertForm(${e.id})">Edit</button>
                <button class="btn danger" style="padding:4px 8px;font-size:12px" onclick="deleteExpertPrompt(${e.id})">Delete</button>
              </td>
            `;
            body.appendChild(tr);

            // Mobile card
            if (cardsContainer) {
              const card = document.createElement('div');
              card.className = 'mobile-card';
              card.onclick = () => viewExpertDetail(e.id);
              card.innerHTML = `
                <div class="mobile-card-header">${e.full_name || e.username}</div>
                <div class="mobile-card-meta">
                  @${e.username} ${e.location ? '• ' + e.location : ''}<br>
                  ${e.email || ''}<br>
                  Open tickets: ${ticketBadge}
                </div>
                <div class="mobile-card-actions" onclick="event.stopPropagation()">
                  <button class="btn primary" onclick="viewExpertDetail(${e.id})">View</button>
                  <button class="btn" onclick="showEditExpertForm(${e.id})">Edit</button>
                </div>
              `;
              cardsContainer.appendChild(card);
            }
          });
        }
      } else {
        body.innerHTML='<tr><td colspan="7" style="text-align:center;color:red;">Failed to load experts</td></tr>';
        const cardsContainer = document.getElementById('experts-cards');
        if (cardsContainer) cardsContainer.innerHTML = '<div class="mobile-card"><div style="text-align:center;color:var(--danger)">Failed to load experts</div></div>';
      }
    } catch (error) {
      console.error('Error loading experts:', error);
      body.innerHTML='<tr><td colspan="7" style="text-align:center;color:red;">Error loading experts</td></tr>';
    }
  }

  // Sort experts by field
  function sortExpertsBy(field) {
    if (expertSortField === field) {
      expertSortAsc = !expertSortAsc;
    } else {
      expertSortField = field;
      expertSortAsc = true;
    }
    // Update sort indicators
    ['full_name', 'username', 'location', 'email', 'open_tickets', 'last_login'].forEach(f => {
      const el = document.getElementById('expert-sort-' + f);
      if (el) el.textContent = f === expertSortField ? (expertSortAsc ? '▲' : '▼') : '';
    });
    renderExperts();
  }

  // Format last login with relative time
  function formatLastLogin(lastLogin) {
    if (!lastLogin) return '<span style="color:var(--muted)">Never</span>';

    const date = new Date(lastLogin);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    // Format UTC time for tooltip (absolute reference)
    const utcStr = date.toISOString().replace('T', ' ').substring(0, 16) + ' UTC';

    let display;
    if (diffMins < 1) {
      display = 'Just now';
    } else if (diffMins < 60) {
      display = `${diffMins}m ago`;
    } else if (diffHours < 24) {
      display = `${diffHours}h ago`;
    } else if (diffDays < 7) {
      display = `${diffDays}d ago`;
    } else {
      // For older dates, show date in UTC
      display = date.toLocaleDateString('en-GB', { timeZone: 'UTC', day: 'numeric', month: 'short' }) + ' UTC';
    }

    // Relative times don't need timezone, but tooltip shows UTC for reference
    return `<span style="cursor:help" title="${utcStr}">${display}</span>`;
  }

  let showingDeletedExperts = false;

  async function toggleDeletedExperts() {
    showingDeletedExperts = !showingDeletedExperts;
    const btn = document.getElementById('show-deleted-btn');
    if (showingDeletedExperts) {
      btn.textContent = 'Show Active';
      btn.classList.add('danger');
      await renderDeletedExperts();
    } else {
      btn.textContent = 'Show Deleted';
      btn.classList.remove('danger');
      await renderExperts();
    }
  }

  async function renderDeletedExperts() {
    const body = document.getElementById('experts-body');
    if (!body) return;
    body.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading deleted experts...</td></tr>';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/deleted`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.experts) {
        const cardsContainer = document.getElementById('experts-cards');
        body.innerHTML = '';
        if (cardsContainer) cardsContainer.innerHTML = '';

        if (data.experts.length === 0) {
          body.innerHTML = '<tr><td colspan="7" style="text-align:center;">No deleted experts found</td></tr>';
          if (cardsContainer) cardsContainer.innerHTML = '<div class="mobile-card"><div style="text-align:center;color:var(--muted)">No deleted experts</div></div>';
        } else {
          data.experts.forEach(e => {
            const tr = document.createElement('tr');
            tr.style.opacity = '0.7';
            tr.innerHTML = `
              <td>${e.full_name || e.username}</td>
              <td>${e.username}</td>
              <td>${e.location || '-'}</td>
              <td>${e.email || '-'}</td>
              <td>-</td>
              <td>-</td>
              <td>
                <button class="btn primary" style="padding:4px 8px;font-size:12px" onclick="restoreExpert(${e.id})">Restore</button>
                <button class="btn danger" style="padding:4px 8px;font-size:12px;margin-left:4px" onclick="eraseExpert(${e.id}, '${(e.full_name || e.username).replace(/'/g, "\\'")}')">Erase</button>
              </td>
            `;
            body.appendChild(tr);

            if (cardsContainer) {
              const card = document.createElement('div');
              card.className = 'mobile-card';
              card.style.opacity = '0.7';
              card.innerHTML = `
                <div class="mobile-card-header">${e.full_name || e.username} <span style="color:#b91c1c;font-size:12px">(Deleted)</span></div>
                <div class="mobile-card-meta">
                  @${e.username}<br>
                  ${e.email || ''}
                </div>
                <div class="mobile-card-actions" style="gap:8px">
                  <button class="btn primary" onclick="restoreExpert(${e.id})">Restore</button>
                  <button class="btn danger" onclick="eraseExpert(${e.id}, '${(e.full_name || e.username).replace(/'/g, "\\'")}')">Erase</button>
                </div>
              `;
              cardsContainer.appendChild(card);
            }
          });
        }
      } else {
        body.innerHTML = '<tr><td colspan="7" style="text-align:center;color:red;">Failed to load deleted experts</td></tr>';
      }
    } catch (error) {
      console.error('Error loading deleted experts:', error);
      body.innerHTML = '<tr><td colspan="7" style="text-align:center;color:red;">Error loading deleted experts</td></tr>';
    }
  }

  async function restoreExpert(expertId) {
    if (!confirm('Restore this expert? They will be able to log in again.')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/${expertId}/restore`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        cachedExperts = [];
        alert('Expert restored successfully!');
        await renderDeletedExperts();
      } else {
        alert('Failed to restore expert: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error restoring expert:', error);
      alert('Error restoring expert');
    }
  }

  // Permanently erase expert (hard delete)
  async function eraseExpert(expertId, expertName) {
    if (!confirm(`PERMANENTLY DELETE "${expertName}"?\n\nThis action cannot be undone. All data for this expert will be permanently erased.`)) return;

    // Double confirmation for safety
    if (!confirm(`Are you absolutely sure? Type OK to confirm permanent deletion of "${expertName}".`)) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/${expertId}/erase`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        alert(`Expert "${expertName}" has been permanently erased.`);
        await renderDeletedExperts();
      } else {
        alert('Failed to erase expert: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error erasing expert:', error);
      alert('Error erasing expert');
    }
  }

  // =============================================
  // Invite Expert Functions
  // =============================================

  function showInviteExpertModal() {
    // Clear form
    document.getElementById('invite-salutation').value = '';
    document.getElementById('invite-first-name').value = '';
    document.getElementById('invite-last-name').value = '';
    document.getElementById('invite-email').value = '';
    document.getElementById('invite-error').style.display = 'none';
    document.getElementById('invite-success').style.display = 'none';
    document.getElementById('invite-submit-btn').disabled = false;
    document.getElementById('invite-submit-btn').textContent = 'Send Invitation';

    // Show modal
    document.getElementById('invite-expert-modal').style.display = 'flex';
  }

  function closeInviteExpertModal() {
    document.getElementById('invite-expert-modal').style.display = 'none';
  }

  async function sendExpertInvitation() {
    const salutation = document.getElementById('invite-salutation').value;
    const firstName = document.getElementById('invite-first-name').value.trim();
    const lastName = document.getElementById('invite-last-name').value.trim();
    const email = document.getElementById('invite-email').value.trim();
    const errorEl = document.getElementById('invite-error');
    const successEl = document.getElementById('invite-success');
    const submitBtn = document.getElementById('invite-submit-btn');

    // Hide messages
    errorEl.style.display = 'none';
    successEl.style.display = 'none';

    // Validate
    if (!firstName) {
      errorEl.textContent = 'First name is required';
      errorEl.style.display = 'block';
      return;
    }

    if (!lastName) {
      errorEl.textContent = 'Last name is required';
      errorEl.style.display = 'block';
      return;
    }

    if (!email) {
      errorEl.textContent = 'Email address is required';
      errorEl.style.display = 'block';
      return;
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      errorEl.textContent = 'Please enter a valid email address';
      errorEl.style.display = 'block';
      return;
    }

    // Disable button and show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/invite`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          salutation,
          first_name: firstName,
          last_name: lastName,
          email
        })
      });

      const data = await response.json();

      if (data.success) {
        successEl.innerHTML = data.emailSent
          ? `Invitation sent to <strong>${email}</strong>! They will receive an email with instructions to set their password.`
          : `Expert created but email could not be sent. Please try resending the invitation.`;
        successEl.style.display = 'block';
        submitBtn.textContent = 'Invitation Sent!';

        // Refresh experts list after a delay, then close modal
        setTimeout(() => {
          closeInviteExpertModal();
          renderExperts();
        }, 2000);
      } else {
        errorEl.textContent = data.message || 'Failed to send invitation';
        errorEl.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Invitation';
      }
    } catch (error) {
      console.error('Error sending invitation:', error);
      errorEl.textContent = 'Error sending invitation. Please try again.';
      errorEl.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send Invitation';
    }
  }

  // =============================================
  // Bulk Import Experts Functions
  // =============================================

  let bulkImportExperts = []; // Store parsed experts from CSV

  function showBulkImportModal() {
    document.getElementById('bulk-import-file').value = '';
    document.getElementById('bulk-import-preview').style.display = 'none';
    document.getElementById('bulk-import-results').style.display = 'none';
    document.getElementById('bulk-import-error').style.display = 'none';
    document.getElementById('bulk-import-submit-btn').disabled = true;
    document.getElementById('bulk-import-submit-btn').textContent = 'Import Experts';
    bulkImportExperts = [];
    document.getElementById('bulk-import-modal').style.display = 'flex';
  }

  function closeBulkImportModal() {
    document.getElementById('bulk-import-modal').style.display = 'none';
    // Refresh experts list if any were imported
    renderExperts();
    loadInvitedExperts();
  }

  // Handle CSV file selection
  document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('bulk-import-file');
    if (fileInput) {
      fileInput.addEventListener('change', handleBulkImportFile);
    }
  });

  function handleBulkImportFile(event) {
    const file = event.target.files[0];
    const errorEl = document.getElementById('bulk-import-error');
    const previewEl = document.getElementById('bulk-import-preview');
    const submitBtn = document.getElementById('bulk-import-submit-btn');

    errorEl.style.display = 'none';
    previewEl.style.display = 'none';
    submitBtn.disabled = true;
    bulkImportExperts = [];

    if (!file) return;

    if (!file.name.endsWith('.csv')) {
      errorEl.textContent = 'Please select a CSV file';
      errorEl.style.display = 'block';
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const lines = text.split(/\r?\n/).filter(line => line.trim());

      // Skip header row if it looks like a header
      let startIndex = 0;
      if (lines.length > 0) {
        const firstLine = lines[0].toLowerCase();
        if (firstLine.includes('email') || firstLine.includes('first') || firstLine.includes('name')) {
          startIndex = 1;
        }
      }

      const experts = [];
      const errors = [];

      for (let i = startIndex; i < lines.length; i++) {
        const line = lines[i];
        const parts = line.split(',').map(p => p.trim().replace(/^["']|["']$/g, '')); // Remove quotes
        if (parts.length < 3) {
          errors.push(`Line ${i + 1}: Not enough columns`);
          continue;
        }
        if (!parts[0] || !parts[0].includes('@')) {
          errors.push(`Line ${i + 1}: Invalid email "${parts[0]}"`);
          continue;
        }
        experts.push({
          email: parts[0],
          first_name: parts[1],
          last_name: parts[2],
          salutation: parts[3] || ''
        });
      }

      if (errors.length > 0 && experts.length === 0) {
        errorEl.textContent = errors.join('; ');
        errorEl.style.display = 'block';
        return;
      }

      if (experts.length === 0) {
        errorEl.textContent = 'No valid experts found in CSV file';
        errorEl.style.display = 'block';
        return;
      }

      bulkImportExperts = experts;

      // Show preview
      document.getElementById('bulk-import-count').textContent = experts.length;
      const previewBody = document.getElementById('bulk-import-preview-body');
      previewBody.innerHTML = experts.slice(0, 10).map(e => `
        <tr>
          <td style="padding:4px">${e.email}</td>
          <td style="padding:4px">${e.first_name}</td>
          <td style="padding:4px">${e.last_name}</td>
          <td style="padding:4px">${e.salutation || '-'}</td>
        </tr>
      `).join('') + (experts.length > 10 ? `<tr><td colspan="4" style="padding:4px;color:#6b7280">...and ${experts.length - 10} more</td></tr>` : '');

      previewEl.style.display = 'block';
      submitBtn.disabled = false;

      if (errors.length > 0) {
        errorEl.textContent = `Warning: ${errors.length} invalid rows skipped`;
        errorEl.style.display = 'block';
      }
    };

    reader.onerror = function() {
      errorEl.textContent = 'Error reading file';
      errorEl.style.display = 'block';
    };

    reader.readAsText(file);
  }

  async function processBulkImport() {
    const errorEl = document.getElementById('bulk-import-error');
    const resultsEl = document.getElementById('bulk-import-results');
    const submitBtn = document.getElementById('bulk-import-submit-btn');

    errorEl.style.display = 'none';
    resultsEl.style.display = 'none';

    if (bulkImportExperts.length === 0) {
      errorEl.textContent = 'Please select a CSV file first';
      errorEl.style.display = 'block';
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Importing...';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/bulk-invite`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ experts: bulkImportExperts })
      });

      const data = await response.json();

      if (data.success) {
        // Show results
        document.getElementById('bulk-import-summary').textContent = data.message;
        const resultsBody = document.getElementById('bulk-import-results-body');
        resultsBody.innerHTML = data.results.map(r => {
          const statusClass = r.status === 'invited' ? 'color:#16a34a' : r.status === 'skipped' ? 'color:#ca8a04' : 'color:#b91c1c';
          return `<tr>
            <td>${escapeHtml(r.email)}</td>
            <td style="${statusClass};font-weight:600">${r.status.toUpperCase()}</td>
            <td>${escapeHtml(r.message)}</td>
          </tr>`;
        }).join('');
        resultsEl.style.display = 'block';
        submitBtn.textContent = 'Done';
      } else {
        errorEl.textContent = data.message || 'Import failed';
        errorEl.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Import Experts';
      }
    } catch (error) {
      console.error('Error bulk importing:', error);
      errorEl.textContent = 'Error importing experts. Please try again.';
      errorEl.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Import Experts';
    }
  }

  // =============================================
  // Expert Tab Navigation Functions
  // =============================================

  function showActiveExperts() {
    document.getElementById('tab-active-experts').className = 'btn primary';
    document.getElementById('tab-invited-experts').className = 'btn ghost';
    document.getElementById('tab-deleted-experts').className = 'btn ghost';
    document.getElementById('active-experts-section').style.display = 'block';
    document.getElementById('invited-experts-section').style.display = 'none';
    document.getElementById('deleted-experts-section').style.display = 'none';
    renderExperts();
  }

  function showInvitedExperts() {
    document.getElementById('tab-active-experts').className = 'btn ghost';
    document.getElementById('tab-invited-experts').className = 'btn primary';
    document.getElementById('tab-deleted-experts').className = 'btn ghost';
    document.getElementById('active-experts-section').style.display = 'none';
    document.getElementById('invited-experts-section').style.display = 'block';
    document.getElementById('deleted-experts-section').style.display = 'none';
    loadInvitedExperts();
  }

  function showDeletedExperts() {
    document.getElementById('tab-active-experts').className = 'btn ghost';
    document.getElementById('tab-invited-experts').className = 'btn ghost';
    document.getElementById('tab-deleted-experts').className = 'btn primary';
    document.getElementById('active-experts-section').style.display = 'none';
    document.getElementById('invited-experts-section').style.display = 'none';
    document.getElementById('deleted-experts-section').style.display = 'block';
    loadDeletedExperts();
  }

  async function loadInvitedExperts() {
    const body = document.getElementById('invited-experts-body');
    body.innerHTML = '<tr><td colspan="6" style="text-align:center">Loading...</td></tr>';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/invited`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.experts) {
        if (data.experts.length === 0) {
          body.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#6b7280">No pending invitations</td></tr>';
          return;
        }

        body.innerHTML = data.experts.map(e => {
          const invitedDate = e.invitation_sent_at ? new Date(e.invitation_sent_at).toLocaleDateString() : '-';
          const expiresDate = e.invitation_expires ? new Date(e.invitation_expires).toLocaleDateString() : '-';
          const statusBadge = e.status === 'pending'
            ? '<span class="badge" style="background:#dcfce7;color:#16a34a">Pending</span>'
            : '<span class="badge" style="background:#fef2f2;color:#b91c1c">Expired</span>';

          return `<tr>
            <td>${escapeHtml(e.full_name || '-')}</td>
            <td>${escapeHtml(e.email)}</td>
            <td>${invitedDate}</td>
            <td>${expiresDate}</td>
            <td>${statusBadge}</td>
            <td>
              <div class="row" style="gap:4px">
                <button class="btn ghost small" onclick="reinviteExpert(${e.id}, '${escapeHtml(e.email)}')">Reinvite</button>
                <button class="btn ghost small" onclick="revokeInvite(${e.id}, '${escapeHtml(e.full_name || e.email)}')">Revoke</button>
              </div>
            </td>
          </tr>`;
        }).join('');
      } else {
        body.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#b91c1c">Failed to load invitations</td></tr>';
      }
    } catch (error) {
      console.error('Error loading invited experts:', error);
      body.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#b91c1c">Error loading invitations</td></tr>';
    }
  }

  async function loadDeletedExperts() {
    const body = document.getElementById('deleted-experts-body');
    body.innerHTML = '<tr><td colspan="4" style="text-align:center">Loading...</td></tr>';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/deleted`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.experts) {
        if (data.experts.length === 0) {
          body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280">No deleted experts</td></tr>';
          return;
        }

        body.innerHTML = data.experts.map(e => `<tr>
          <td>${escapeHtml(e.full_name || '-')}</td>
          <td>${escapeHtml(e.username)}</td>
          <td>${escapeHtml(e.email)}</td>
          <td>
            <div class="row" style="gap:4px">
              <button class="btn ghost small" onclick="restoreExpert(${e.id}, '${escapeHtml(e.full_name || e.username)}')">Restore</button>
              <button class="btn ghost small" onclick="eraseExpert(${e.id}, '${escapeHtml(e.full_name || e.username)}')">Erase</button>
            </div>
          </td>
        </tr>`).join('');
      } else {
        body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#b91c1c">Failed to load deleted experts</td></tr>';
      }
    } catch (error) {
      console.error('Error loading deleted experts:', error);
      body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#b91c1c">Error loading deleted experts</td></tr>';
    }
  }

  async function reinviteExpert(expertId, email) {
    if (!confirm(`Resend invitation to ${email}?`)) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/${expertId}/resend-invite`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        alert('Invitation resent successfully');
        loadInvitedExperts();
      } else {
        alert('Failed to resend invitation: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error resending invitation:', error);
      alert('Error resending invitation');
    }
  }

  async function revokeInvite(expertId, name) {
    if (!confirm(`Revoke invitation for "${name}"?\n\nThis will permanently remove the pending invitation.`)) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/${expertId}/revoke-invite`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        alert('Invitation revoked');
        loadInvitedExperts();
      } else {
        alert('Failed to revoke invitation: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error revoking invitation:', error);
      alert('Error revoking invitation');
    }
  }

  // View expert detail
  async function viewExpertDetail(expertId) {
    currentExpertId = expertId;
    switchView('expert-detail');
  }

  // Render expert detail view
  async function renderExpertDetail() {
    if (!currentExpertId) {
      switchView('experts');
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/${currentExpertId}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.expert) {
        const e = data.expert;

        // Account Info
        document.getElementById('expert-role').textContent = (e.role || '').toUpperCase();
        document.getElementById('expert-username').textContent = e.username || '-';
        document.getElementById('expert-status').textContent = e.status || 'active';
        document.getElementById('expert-email-updates').textContent = e.email_updates !== false ? 'Enabled' : 'Disabled';
        document.getElementById('expert-reference').textContent = e.reference_code || '-';
        document.getElementById('expert-open-tickets').textContent = e.open_tickets || '0';

        // Account Statistics
        document.getElementById('expert-created-by').textContent = e.created_by || '-';
        document.getElementById('expert-updated-by').textContent = e.updated_by || '-';
        document.getElementById('expert-created-at').textContent = e.created_at ? new Date(e.created_at).toLocaleString() : '-';
        document.getElementById('expert-updated-at').textContent = e.updated_at ? new Date(e.updated_at).toLocaleString() : '-';
        document.getElementById('expert-last-login').textContent = e.last_login ? new Date(e.last_login).toLocaleString() : 'Never';

        // System Settings
        document.getElementById('expert-timezone').textContent = e.timezone || '-';
        document.getElementById('expert-language').textContent = e.language || '-';
        document.getElementById('expert-interface-lang').textContent = e.interface_language || '-';
        document.getElementById('expert-security-level').textContent = e.security_level || '-';

        // User Details
        document.getElementById('expert-first-name').textContent = e.first_name || '-';
        document.getElementById('expert-middle-name').textContent = e.middle_name || '-';
        document.getElementById('expert-last-name').textContent = e.last_name || '-';
        document.getElementById('expert-screen-name').textContent = e.screen_name || '-';
        document.getElementById('expert-street').textContent = e.street_address || '-';
        document.getElementById('expert-city').textContent = e.city || '-';
        document.getElementById('expert-state').textContent = e.state || '-';
        document.getElementById('expert-postcode').textContent = e.postcode || '-';
        document.getElementById('expert-country').textContent = e.country || '-';
        document.getElementById('expert-contact').textContent = e.contact_number || e.phone || '-';
        document.getElementById('expert-location').textContent = e.location || '-';
        document.getElementById('expert-department').textContent = e.department || '-';
        document.getElementById('expert-email').textContent = e.email || '-';
      } else {

        // Load expert permissions
        await loadExpertPermissions();
        alert('Failed to load expert details');
        switchView('experts');
      }
    } catch (error) {
      console.error('Error loading expert details:', error);
      alert('Error loading expert details');
      switchView('experts');
    }
  }

  // Show create expert form
  function showCreateExpertForm() {
    currentExpertId = null;
    document.getElementById('expert-modal-title').textContent = 'Add Expert';
    document.getElementById('expert-form-password-row').style.display = 'block';
    clearExpertForm();
    document.getElementById('expert-modal').style.display = 'flex';
  }

  // Show edit expert form
  async function showEditExpertForm(expertId) {
    currentExpertId = expertId;
    document.getElementById('expert-modal-title').textContent = 'Edit Expert';
    document.getElementById('expert-form-password-row').style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/${expertId}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.expert) {
        const e = data.expert;
        document.getElementById('expert-form-username').value = e.username || '';
        document.getElementById('expert-form-email').value = e.email || '';
        document.getElementById('expert-form-role').value = e.role || 'expert';
        document.getElementById('expert-form-status').value = e.is_active === false ? 'inactive' : 'active';
        document.getElementById('expert-form-rating').value = e.rating || '';
        document.getElementById('expert-form-reference').value = e.reference_code || '';
        document.getElementById('expert-form-email-updates').checked = e.email_updates !== false;
        document.getElementById('expert-form-fullname').value = e.full_name || '';
        document.getElementById('expert-form-firstname').value = e.first_name || '';
        document.getElementById('expert-form-middlename').value = e.middle_name || '';
        document.getElementById('expert-form-lastname').value = e.last_name || '';
        document.getElementById('expert-form-screenname').value = e.screen_name || '';
        document.getElementById('expert-form-phone').value = e.phone || '';
        document.getElementById('expert-form-department').value = e.department || '';
        document.getElementById('expert-form-location').value = e.location || '';
        document.getElementById('expert-form-street').value = e.street_address || '';
        document.getElementById('expert-form-city').value = e.city || '';
        document.getElementById('expert-form-state').value = e.state || '';
        document.getElementById('expert-form-postcode').value = e.postcode || '';
        document.getElementById('expert-form-country').value = e.country || '';
        document.getElementById('expert-form-timezone').value = e.timezone || '';
        document.getElementById('expert-form-language').value = e.language || '';
        document.getElementById('expert-form-interface-lang').value = e.interface_language || '';
        document.getElementById('expert-form-security-level').value = e.security_level || '';

        document.getElementById('expert-modal').style.display = 'flex';
      } else {
        alert('Failed to load expert data');
      }
    } catch (error) {
      console.error('Error loading expert:', error);
      alert('Error loading expert data');
    }
  }

  // Wrapper for edit from detail view
  function editExpert() {
    if (currentExpertId) {
      showEditExpertForm(currentExpertId);
    }
  }

  // Clear expert form
  function clearExpertForm() {
    document.getElementById('expert-form-username').value = '';
    document.getElementById('expert-form-email').value = '';
    document.getElementById('expert-form-password').value = '';
    document.getElementById('expert-form-role').value = 'expert';
    document.getElementById('expert-form-status').value = 'active';
    document.getElementById('expert-form-rating').value = '';
    document.getElementById('expert-form-reference').value = '';
    document.getElementById('expert-form-email-updates').checked = true;
    document.getElementById('expert-form-fullname').value = '';
    document.getElementById('expert-form-firstname').value = '';
    document.getElementById('expert-form-middlename').value = '';
    document.getElementById('expert-form-lastname').value = '';
    document.getElementById('expert-form-screenname').value = '';
    document.getElementById('expert-form-phone').value = '';
    document.getElementById('expert-form-department').value = '';
    document.getElementById('expert-form-location').value = '';
    document.getElementById('expert-form-street').value = '';
    document.getElementById('expert-form-city').value = '';
    document.getElementById('expert-form-state').value = '';
    document.getElementById('expert-form-postcode').value = '';
    document.getElementById('expert-form-country').value = '';
    document.getElementById('expert-form-timezone').value = '';
    document.getElementById('expert-form-language').value = '';
    document.getElementById('expert-form-interface-lang').value = '';
    document.getElementById('expert-form-security-level').value = '';
    document.getElementById('expert-form-error').style.display = 'none';
    document.getElementById('expert-form-error').textContent = '';
  }

  // Close expert modal
  function closeExpertModal() {
    document.getElementById('expert-modal').style.display = 'none';
    clearExpertForm();
  }

  // Save expert (create or update)
  async function saveExpert() {
    const username = document.getElementById('expert-form-username').value.trim();
    const email = document.getElementById('expert-form-email').value.trim();
    const password = document.getElementById('expert-form-password').value.trim();
    const role = document.getElementById('expert-form-role').value;

    // Validation
    if (!username || !email || !role) {
      document.getElementById('expert-form-error').textContent = 'Username, email, and role are required';
      document.getElementById('expert-form-error').style.display = 'block';
      return;
    }

    if (!currentExpertId && !password) {
      document.getElementById('expert-form-error').textContent = 'Password is required for new experts';
      document.getElementById('expert-form-error').style.display = 'block';
      return;
    }

    const expertData = {
      username,
      email,
      role,
      status: document.getElementById('expert-form-status').value,
      rating: parseInt(document.getElementById('expert-form-rating').value) || 0,
      reference_code: document.getElementById('expert-form-reference').value.trim(),
      email_updates: document.getElementById('expert-form-email-updates').checked,
      full_name: document.getElementById('expert-form-fullname').value.trim(),
      first_name: document.getElementById('expert-form-firstname').value.trim(),
      middle_name: document.getElementById('expert-form-middlename').value.trim(),
      last_name: document.getElementById('expert-form-lastname').value.trim(),
      screen_name: document.getElementById('expert-form-screenname').value.trim(),
      phone: document.getElementById('expert-form-phone').value.trim(),
      department: document.getElementById('expert-form-department').value.trim(),
      location: document.getElementById('expert-form-location').value.trim(),
      street_address: document.getElementById('expert-form-street').value.trim(),
      city: document.getElementById('expert-form-city').value.trim(),
      state: document.getElementById('expert-form-state').value.trim(),
      postcode: document.getElementById('expert-form-postcode').value.trim(),
      country: document.getElementById('expert-form-country').value.trim(),
      timezone: document.getElementById('expert-form-timezone').value.trim(),
      language: document.getElementById('expert-form-language').value.trim(),
      interface_language: document.getElementById('expert-form-interface-lang').value.trim(),
      security_level: document.getElementById('expert-form-security-level').value.trim()
    };

    if (!currentExpertId) {
      expertData.password = password;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const url = currentExpertId
        ? `${API_BASE}/api/experts/${tenantCode}/${currentExpertId}`
        : `${API_BASE}/api/experts/${tenantCode}`;
      const method = currentExpertId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(expertData)
      });

      const data = await response.json();

      if (data.success) {
        cachedExperts = []; // Clear cache so dropdowns reload fresh
        closeExpertModal();
        renderExperts();
        alert(currentExpertId ? 'Expert updated successfully' : 'Expert created successfully');
      } else {
        document.getElementById('expert-form-error').textContent = data.message || 'Failed to save expert';
        document.getElementById('expert-form-error').style.display = 'block';
      }
    } catch (error) {
      console.error('Error saving expert:', error);
      document.getElementById('expert-form-error').textContent = 'Error saving expert';
      document.getElementById('expert-form-error').style.display = 'block';
    }
  }

  // Delete expert prompt
  async function deleteExpertPrompt(expertId) {
    const expert = expertId ? allExperts.find(e => e.id === expertId) : allExperts.find(e => e.id === currentExpertId);
    if (!expert) return;

    if (!confirm(`Are you sure you want to delete expert "${expert.full_name || expert.username}"? This action cannot be undone.`)) {
      return;
    }

    const idToDelete = expertId || currentExpertId;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/${idToDelete}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        cachedExperts = [];
        alert('Expert deleted successfully');
        if (currentView === 'expert-detail') {
          switchView('experts');
        } else {
          renderExperts();
        }
      } else {
        alert('Failed to delete expert: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error deleting expert:', error);
      alert('Error deleting expert');
    }
  }

  // Customer Management Functions

  // ========================================
  // EXPERT TICKET PERMISSIONS FUNCTIONS
  // ========================================


  // Show expert permissions modal
  async function showExpertPermissionsModal() {
    console.log('🚀 showExpertPermissionsModal() called');
    console.log('  → currentExpertId:', currentExpertId);

    if (!currentExpertId) {
      alert('No expert selected');
      return;
    }

    const modal = document.getElementById('expert-permissions-modal');
    modal.style.display = 'flex';
    modal.scrollTop = 0;
    console.log('  → Modal opened');

    console.log('  → Loading expert permissions...');
    await loadExpertPermissions();

    console.log('  → Loading available customers...');
    await loadAvailableCustomers();

    console.log('  ✅ Modal fully initialized');
  }

  // Close expert permissions modal
  function closeExpertPermissionsModal() {
    document.getElementById('expert-permissions-modal').style.display = 'none';
    // Reset form
    document.getElementById('perm-type').value = '';
    document.getElementById('perm-customer').value = '';
    document.getElementById('perm-pattern').value = '';
    updatePermissionForm();
    hideMessage('perm-form-message');
    hideMessage('perm-form-error');
  }

  // Load expert permissions
  async function loadExpertPermissions() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`/api/expert-permissions/${tenantCode}/${currentExpertId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        renderPermissionsList(data.permissions);
        renderPermissionsOnDetailPage(data.permissions);
      } else {
        renderPermissionsList([]);
      }
    } catch (error) {
      console.error('Error loading expert permissions:', error);
      document.getElementById('current-permissions-list').innerHTML =
        '<div class="subtitle" style="color:#b91c1c">Failed to load permissions</div>';
    }
  }

  // Render permissions list in modal
  function renderPermissionsList(permissions) {
    const container = document.getElementById('current-permissions-list');

    if (!permissions || permissions.length === 0) {
      container.innerHTML = '<div class="subtitle" style="color:#999">No permissions configured</div>';
      return;
    }

    let html = '<div style="display:flex;flex-direction:column;gap:8px">';

    permissions.forEach(perm => {
      let permText = '';
      let permIcon = '';

      if (perm.permission_type === 'all_tickets') {
        permIcon = '🌐';
        permText = 'All Tickets';
      } else if (perm.permission_type === 'specific_customers') {
        permIcon = '👤';
        permText = `Customer: ${perm.customer_name || perm.customer_username || 'Unknown'}`;
        if (perm.company_name) {
          permText += ` (${perm.company_name})`;
        }
      } else if (perm.permission_type === 'title_patterns') {
        permIcon = '🔍';
        permText = `Title contains: "${perm.title_pattern}"`;
      }

      html += `
        <div class="row space" style="padding:8px;background:white;border-radius:4px;border:1px solid #e5e7eb">
          <div class="row" style="gap:8px">
            <span style="font-size:18px">${permIcon}</span>
            <span>${permText}</span>
          </div>
          <button class="btn ghost small" onclick="deleteExpertPermission(${perm.id})">Remove</button>
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  // Render permissions on expert detail page
  function renderPermissionsOnDetailPage(permissions) {
    const container = document.getElementById('expert-permissions-list');

    if (!permissions || permissions.length === 0) {
      container.innerHTML = '<div class="subtitle" style="color:#999">No permissions configured. Click "Manage Permissions" to add.</div>';
      return;
    }

    let html = '<div style="display:flex;flex-direction:column;gap:6px">';

    permissions.forEach(perm => {
      let permText = '';
      let permIcon = '';

      if (perm.permission_type === 'all_tickets') {
        permIcon = '🌐';
        permText = '<strong>All Tickets</strong> - Can view and work on all tickets';
      } else if (perm.permission_type === 'specific_customers') {
        permIcon = '👤';
        permText = `Customer: <strong>${perm.customer_name || perm.customer_username}</strong>`;
        if (perm.company_name) {
          permText += ` (${perm.company_name})`;
        }
      } else if (perm.permission_type === 'title_patterns') {
        permIcon = '🔍';
        permText = `Tickets with title containing: <strong>"${perm.title_pattern}"</strong>`;
      }

      html += `
        <div class="row" style="gap:8px;padding:4px 0">
          <span style="font-size:16px">${permIcon}</span>
          <span class="subtitle">${permText}</span>
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  // Load available customers for dropdown
  async function loadAvailableCustomers() {
    console.log('🔍 loadAvailableCustomers() called');
    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      console.log('  → tenantCode:', tenantCode);

      const response = await fetch(`/api/expert-permissions/${tenantCode}/customers/available`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();
      console.log('  → API response:', data);

      if (data.success) {
        const select = document.getElementById('perm-customer');
        console.log('  → Customer dropdown element:', select ? 'FOUND' : 'NOT FOUND');

        select.innerHTML = '<option value="">Select customer...</option>';

        data.customers.forEach(customer => {
          const displayName = customer.full_name || customer.username;
          const companyInfo = customer.company_name ? ` (${customer.company_name})` : '';
          select.innerHTML += `<option value="${customer.id}">${displayName}${companyInfo}</option>`;
        });

        console.log('  ✅ Loaded', data.customers.length, 'customers into dropdown');
        console.log('  → Dropdown now has', select.options.length, 'total options');
      } else {
        console.error('  ❌ API returned success=false:', data);
      }
    } catch (error) {
      console.error('❌ Error loading customers:', error);
    }
  }

  // Update permission form based on selected type
  function updatePermissionForm() {
    console.log('🔄 updatePermissionForm() called');
    const permType = document.getElementById('perm-type').value;
    console.log('  → Permission type selected:', permType);

    const customerSection = document.getElementById('perm-customer-section');
    const patternSection = document.getElementById('perm-pattern-section');

    console.log('  → Customer section element:', customerSection ? 'FOUND' : 'NOT FOUND');
    console.log('  → Pattern section element:', patternSection ? 'FOUND' : 'NOT FOUND');

    customerSection.style.display = permType === 'specific_customers' ? 'block' : 'none';
    patternSection.style.display = permType === 'title_patterns' ? 'block' : 'none';

    console.log('  → Customer section display:', customerSection.style.display);
    console.log('  → Pattern section display:', patternSection.style.display);

    if (permType === 'specific_customers') {
      const select = document.getElementById('perm-customer');
      console.log('  → Customer dropdown has', select ? select.options.length : 0, 'options');
    }

    // Clear validation messages
    hideMessage('perm-form-message');
    hideMessage('perm-form-error');
  }

  // Add expert permission
  async function addExpertPermission() {
    const permType = document.getElementById('perm-type').value;
    const customerId = document.getElementById('perm-customer').value;
    const pattern = document.getElementById('perm-pattern').value;

    // Validation
    if (!permType) {
      showMessage('perm-form-error', 'Please select a permission type');
      return;
    }

    if (permType === 'specific_customers' && !customerId) {
      showMessage('perm-form-error', 'Please select a customer');
      return;
    }

    if (permType === 'title_patterns' && !pattern.trim()) {
      showMessage('perm-form-error', 'Please enter a title pattern');
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`/api/expert-permissions/${tenantCode}/${currentExpertId}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          permission_type: permType,
          customer_id: permType === 'specific_customers' ? parseInt(customerId) : null,
          title_pattern: permType === 'title_patterns' ? pattern.trim() : null
        })
      });

      const data = await response.json();

      if (data.success) {
        showMessage('perm-form-message', 'Permission added successfully');
        // Reset form
        document.getElementById('perm-type').value = '';
        document.getElementById('perm-customer').value = '';
        document.getElementById('perm-pattern').value = '';
        updatePermissionForm();
        // Reload permissions
        await loadExpertPermissions();

        // Hide success message after 2 seconds
        setTimeout(() => hideMessage('perm-form-message'), 2000);
      } else {
        showMessage('perm-form-error', data.error || 'Failed to add permission');
      }
    } catch (error) {
      console.error('Error adding permission:', error);
      showMessage('perm-form-error', 'Error adding permission');
    }
  }

  // Delete expert permission
  async function deleteExpertPermission(permissionId) {
    if (!confirm('Remove this permission?')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`/api/expert-permissions/${tenantCode}/${permissionId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        await loadExpertPermissions();
      } else {
        alert('Failed to remove permission: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error deleting permission:', error);
      alert('Error deleting permission');
    }
  }

  // Self-assign ticket
  async function selfAssignTicket() {
    const ticketId = currentTicket.id;

    if (!confirm('Assign this ticket to yourself?')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`/api/tickets/${tenantCode}/${ticketId}/self-assign`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        alert(data.message);
        await openTicket(ticketId);
        await fetchTicketsFromAPI();
      } else {
        alert('Failed to self-assign: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error self-assigning ticket:', error);
      alert('Error self-assigning ticket');
    }
  }

  // Mark ticket as system monitor (manual action - APO-48)
  // Opens modal to mark ticket and optionally create a rule
  function markAsSystemMonitor() {
    const ticket = currentTicket;
    if (!ticket) return;

    // Populate modal fields
    document.getElementById('mark-system-ticket-title').textContent = `#${ticket.id} - ${ticket.title}`;

    // Suggest a rule name based on ticket title
    const suggestedName = extractSuggestedRuleName(ticket.title);
    document.getElementById('mark-system-rule-name').value = suggestedName ? `Auto: ${suggestedName}` : '';

    // Suggest search text from title keywords
    const suggestedSearch = extractSuggestedSearchText(ticket.title);
    document.getElementById('mark-system-search-text').value = suggestedSearch;

    // Reset other fields
    document.getElementById('mark-system-search-in').value = 'both';
    document.getElementById('mark-system-case-sensitive').checked = false;
    document.getElementById('mark-system-create-rule').checked = true;
    document.getElementById('mark-system-error').style.display = 'none';
    toggleMarkSystemRuleFields();

    // Show modal
    document.getElementById('mark-system-modal').style.display = 'flex';
  }

  // Extract suggested rule name from ticket title
  function extractSuggestedRuleName(title) {
    // Look for common monitoring system names
    const monitoringPatterns = [
      /\b(nagios|zabbix|datadog|prtg|prometheus|grafana|newrelic|dynatrace|splunk|pingdom)\b/i,
      /\b(alert|warning|critical|error|down|offline)\b/i,
      /\[(.*?)\]/  // Text in brackets like [ALERT] or [CRITICAL]
    ];

    for (const pattern of monitoringPatterns) {
      const match = title.match(pattern);
      if (match) {
        return match[1] || match[0];
      }
    }
    return '';
  }

  // Extract suggested search text from ticket title
  function extractSuggestedSearchText(title) {
    // Priority 1: Look for bracketed text like [ALERT], [CRITICAL], [NAGIOS]
    const bracketMatch = title.match(/\[([^\]]+)\]/);
    if (bracketMatch) return bracketMatch[0];

    // Priority 2: Look for monitoring system names
    const systemMatch = title.match(/\b(nagios|zabbix|datadog|prtg|prometheus|grafana|newrelic|dynatrace|splunk|pingdom|icinga|checkmk)\b/i);
    if (systemMatch) return systemMatch[0];

    // Priority 3: Look for alert keywords with context
    const alertMatch = title.match(/\b(alert|warning|critical|error|problem|down|offline|failed|failure)\b/i);
    if (alertMatch) return alertMatch[0];

    // Priority 4: First significant word (skip common words)
    const words = title.split(/\s+/).filter(w => w.length > 3 && !['from', 'the', 'this', 'that', 'with'].includes(w.toLowerCase()));
    return words[0] || '';
  }

  // Toggle rule configuration fields visibility
  function toggleMarkSystemRuleFields() {
    const createRule = document.getElementById('mark-system-create-rule').checked;
    document.getElementById('mark-system-rule-fields').style.display = createRule ? 'block' : 'none';
  }

  // Close the mark as system modal
  function closeMarkSystemModal() {
    document.getElementById('mark-system-modal').style.display = 'none';
  }

  // Submit mark as system action (and optionally create rule)
  async function submitMarkAsSystem() {
    const ticket = currentTicket;
    if (!ticket) return;

    const createRule = document.getElementById('mark-system-create-rule').checked;
    const errorEl = document.getElementById('mark-system-error');
    errorEl.style.display = 'none';

    // Validate rule fields if creating a rule
    if (createRule) {
      const ruleName = document.getElementById('mark-system-rule-name').value.trim();
      const searchText = document.getElementById('mark-system-search-text').value.trim();

      if (!ruleName) {
        errorEl.textContent = 'Please enter a rule name';
        errorEl.style.display = 'block';
        return;
      }
      if (!searchText) {
        errorEl.textContent = 'Please enter search text for the rule';
        errorEl.style.display = 'block';
        return;
      }
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      // Step 1: Mark the ticket as system
      const markResponse = await fetch(`/api/tickets/${tenantCode}/${ticket.id}/mark-as-system`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const markData = await markResponse.json();

      if (!markData.success) {
        errorEl.textContent = 'Failed to mark ticket: ' + (markData.message || 'Unknown error');
        errorEl.style.display = 'block';
        return;
      }

      // Step 2: Create the rule if requested
      if (createRule) {
        const ruleData = {
          rule_name: document.getElementById('mark-system-rule-name').value.trim(),
          search_text: document.getElementById('mark-system-search-text').value.trim(),
          search_in: document.getElementById('mark-system-search-in').value,
          case_sensitive: document.getElementById('mark-system-case-sensitive').checked,
          action_type: 'add_to_monitoring',
          action_params: {},
          enabled: true
        };

        const ruleResponse = await fetch(`/api/ticket-rules/${tenantCode}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(ruleData)
        });

        const ruleResult = await ruleResponse.json();

        if (!ruleResult.success) {
          // Ticket was marked but rule creation failed
          alert(`Ticket marked as System Monitor, but rule creation failed: ${ruleResult.message || 'Unknown error'}`);
          closeMarkSystemModal();
          await openTicket(ticket.id);
          await fetchTicketsFromAPI();
          return;
        }

        alert(`Ticket marked as System Monitor.\n\nRule "${ruleData.rule_name}" created to auto-classify future tickets matching "${ruleData.search_text}".`);
      } else {
        alert('Ticket marked as System Monitor');
      }

      closeMarkSystemModal();
      await openTicket(ticket.id);
      await fetchTicketsFromAPI();

    } catch (error) {
      console.error('Error in mark as system:', error);
      errorEl.textContent = 'An error occurred. Please try again.';
      errorEl.style.display = 'block';
    }
  }

  // Helper functions
  function showMessage(elementId, message) {
    const el = document.getElementById(elementId);
    if (el) {
      el.textContent = message;
      el.style.display = 'block';
    }
  }

  function hideMessage(elementId) {
    const el = document.getElementById(elementId);
    if (el) {
      el.style.display = 'none';
    }
  }

  // Format date and time - returns "DD MMM HH:mm" format
  function formatDateTime(dateString) {
    if (!dateString) return '—';

    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '—';

      const day = date.getDate();
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const month = months[date.getMonth()];
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');

      return `${day} ${month} ${hours}:${minutes}`;
    } catch (error) {
      return '—';
    }
  }

  let allCustomers = [];
  let allCustomerCompanies = [];
  let customerSortField = 'name';
  let customerSortAsc = true;

  // Load customer companies for filter dropdown
  async function loadCustomerCompanies() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customer-companies`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      const data = await response.json();
      if (data.success && data.companies) {
        allCustomerCompanies = data.companies;
        populateCustomerCompanyFilter();
      }
    } catch (error) {
      console.error('Error loading customer companies:', error);
    }
  }

  // Populate customer company filter dropdown
  function populateCustomerCompanyFilter() {
    const companyFilter = document.getElementById('cust-filter-company');
    if (!companyFilter) return;

    const currentValue = companyFilter.value;
    companyFilter.innerHTML = '<option value="">All Companies</option>';

    allCustomerCompanies.forEach(company => {
      const option = document.createElement('option');
      option.value = company.id;
      option.textContent = `${company.company_name} (${company.team_member_count || 0})`;
      companyFilter.appendChild(option);
    });

    companyFilter.value = currentValue;
  }

  // Clear customer filters
  function clearCustomerFilters() {
    const searchEl = document.getElementById('cust-search');
    const companyEl = document.getElementById('cust-filter-company');
    const slaEl = document.getElementById('cust-filter-sla');
    const statusEl = document.getElementById('cust-filter-status');

    if (searchEl) searchEl.value = '';
    if (companyEl) companyEl.value = '';
    if (slaEl) slaEl.value = '';
    if (statusEl) statusEl.value = '';

    saveFilterSettings('customers');
    renderCustomers();
  }

  async function renderCustomers(){
    const body=document.getElementById('customers-body');
    if(!body) return;
    body.innerHTML='<tr><td colspan="8" style="text-align:center;">Loading...</td></tr>';

    // Load companies if not loaded, and always populate the filter dropdown
    if (allCustomerCompanies.length === 0) {
      await loadCustomerCompanies();
    } else {
      populateCustomerCompanyFilter();
    }

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customers`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.customers) {
        // Update local customers array
        allCustomers = data.customers;
        customers = data.customers.map(c => ({
          id: c.id,
          name: c.full_name || c.username,
          contact: c.email,
          company: c.company_name || c.full_name || c.username
        }));

        // Get filter values
        const searchQ = (document.getElementById('cust-search')?.value || '').toLowerCase();
        const companyFilter = document.getElementById('cust-filter-company')?.value || '';
        const slaFilter = document.getElementById('cust-filter-sla')?.value || '';
        const statusFilter = document.getElementById('cust-filter-status')?.value || '';

        // Apply filters
        const filteredCustomers = allCustomers.filter(c => {
          // Search filter
          if (searchQ) {
            const name = (c.full_name || c.username || '').toLowerCase();
            const email = (c.email || '').toLowerCase();
            const company = (c.company_name || '').toLowerCase();
            const domain = (c.company_domain || '').toLowerCase();
            if (!name.includes(searchQ) && !email.includes(searchQ) && !company.includes(searchQ) && !domain.includes(searchQ)) {
              return false;
            }
          }

          // Company filter
          if (companyFilter && c.customer_company_id != companyFilter) {
            return false;
          }

          // SLA filter
          if (slaFilter && c.sla_level !== slaFilter) {
            return false;
          }

          // Status filter
          if (statusFilter === 'active' && c.is_active === false) {
            return false;
          }
          if (statusFilter === 'inactive' && c.is_active !== false) {
            return false;
          }

          return true;
        });

        // Apply sorting
        filteredCustomers.sort((a, b) => {
          let valA, valB;
          if (customerSortField === 'name') {
            valA = (a.full_name || a.username || '').toLowerCase();
            valB = (b.full_name || b.username || '').toLowerCase();
          } else if (customerSortField === 'tickets') {
            valA = a.open_ticket_count || 0;
            valB = b.open_ticket_count || 0;
          }
          if (valA < valB) return customerSortAsc ? -1 : 1;
          if (valA > valB) return customerSortAsc ? 1 : -1;
          return 0;
        });

        // Store total count before pagination
        const totalFiltered = filteredCustomers.length;
        const pageSize = getPageSize('customers');

        // Validate current page
        const maxPage = Math.max(1, Math.ceil(totalFiltered / pageSize));
        if (customerPage > maxPage) customerPage = maxPage;

        // Apply pagination
        const paginatedCustomers = paginateArray(filteredCustomers, customerPage, pageSize);

        // Update count
        const countDiv = document.getElementById('customer-count');
        if (countDiv) {
          countDiv.textContent = `Showing ${totalFiltered} of ${allCustomers.length} customers`;
        }

        // Render pagination controls
        renderPaginationControls('customer-pagination', customerPage, totalFiltered, pageSize, 'setCustomerPage', 'setCustomerPageSize', 'customers');

        // Render customers
        body.innerHTML='';
        const cardsContainer = document.getElementById('customers-cards');
        if (cardsContainer) cardsContainer.innerHTML = '';

        if (paginatedCustomers.length === 0) {
          body.innerHTML='<tr><td colspan="8" style="text-align:center;">No customers found</td></tr>';
          if (cardsContainer) cardsContainer.innerHTML = '<div class="mobile-card"><div style="text-align:center;color:var(--muted)">No customers found</div></div>';
        } else {
          paginatedCustomers.forEach(c=>{
            const slaColor = c.sla_level === 'enterprise' ? '#16a34a' : c.sla_level === 'premium' ? '#2563eb' : '#6b7280';
            const isActive = c.is_active !== false;
            const statusStyle = isActive ? '' : 'opacity:0.5;text-decoration:line-through';
            const roleLabel = c.is_company_admin ? '👑 Admin' : (c.job_title || 'Team Member');
            const ticketCount = c.open_ticket_count || 0;
            const ticketStyle = ticketCount > 0 ? 'color:#2563eb;font-weight:600;cursor:pointer' : 'color:#6b7280';
            const emailEnabled = c.email_notifications_enabled !== 0;

            // Desktop table row
            const tr=document.createElement('tr');
            tr.innerHTML=`
              <td style="${statusStyle}">${c.full_name || c.username}</td>
              <td style="${statusStyle}">${c.email || '-'}</td>
              <td style="${statusStyle}">${c.company_name || '-'}</td>
              <td style="${statusStyle};font-size:13px">${roleLabel}</td>
              <td style="${statusStyle};${ticketStyle}" ${ticketCount > 0 ? `onclick="viewCustomerTickets(${c.id}, '${(c.full_name || c.username).replace(/'/g, "\\'")}')"` : ''}>${ticketCount}</td>
              <td style="${statusStyle};color:${slaColor};font-weight:600;text-transform:capitalize">${c.sla_level || 'basic'}</td>
              <td style="text-align:center">
                <input type="checkbox" ${emailEnabled ? 'checked' : ''} ${!isActive ? 'disabled' : ''}
                  onchange="toggleCustomerEmailNotifications(${c.id}, this.checked)"
                  title="${emailEnabled ? 'Email notifications enabled' : 'Email notifications disabled'}"
                  style="width:18px;height:18px;cursor:${isActive ? 'pointer' : 'not-allowed'}">
              </td>
              <td>
                <button class="btn ghost" onclick="editCustomer(${c.id})" style="padding:4px 8px;font-size:13px" ${!isActive ? 'disabled' : ''}>Edit</button>
                ${isActive
                  ? `<button class="btn ghost" onclick="deleteCustomer(${c.id})" style="padding:4px 8px;font-size:13px;color:#b91c1c">Delete</button>`
                  : `<button class="btn ghost" onclick="reactivateCustomer(${c.id})" style="padding:4px 8px;font-size:13px;color:#16a34a">Reactivate</button>`
                }
              </td>
            `;
            body.appendChild(tr);

            // Mobile card
            if (cardsContainer) {
              const card = document.createElement('div');
              card.className = 'mobile-card';
              card.style.cssText = isActive ? '' : 'opacity:0.6';
              card.onclick = () => editCustomer(c.id);
              card.innerHTML = `
                <div class="mobile-card-header">${c.full_name || c.username}</div>
                <div class="mobile-card-meta">
                  ${c.email || ''}<br>
                  🏢 ${c.company_name || 'No company'} • ${roleLabel}<br>
                  <span style="color:${slaColor};font-weight:600;text-transform:capitalize">${c.sla_level || 'basic'} SLA</span>
                  ${ticketCount > 0 ? ` • <span style="color:#2563eb">${ticketCount} open tickets</span>` : ''}
                </div>
                <div class="mobile-card-actions" onclick="event.stopPropagation()">
                  <button class="btn primary" onclick="editCustomer(${c.id})" ${!isActive ? 'disabled' : ''}>Edit</button>
                  ${isActive
                    ? `<button class="btn danger" onclick="deleteCustomer(${c.id})">Delete</button>`
                    : `<button class="btn" onclick="reactivateCustomer(${c.id})" style="color:#16a34a">Reactivate</button>`
                  }
                </div>
              `;
              cardsContainer.appendChild(card);
            }
          });
        }
      } else {
        body.innerHTML='<tr><td colspan="8" style="text-align:center;color:red;">Failed to load customers</td></tr>';
        const cardsContainer = document.getElementById('customers-cards');
        if (cardsContainer) cardsContainer.innerHTML = '<div class="mobile-card"><div style="text-align:center;color:var(--danger)">Failed to load customers</div></div>';
      }
    } catch (error) {
      console.error('Error loading customers:', error);
      body.innerHTML='<tr><td colspan="8" style="text-align:center;color:red;">Error loading customers</td></tr>';
    }
  }

  // Sort customers by field
  function sortCustomersBy(field) {
    if (customerSortField === field) {
      customerSortAsc = !customerSortAsc;
    } else {
      customerSortField = field;
      customerSortAsc = true;
    }
    renderCustomers();
  }

  // View tickets for a specific customer
  function viewCustomerTickets(customerId, customerName) {
    // Switch to tickets view and set the customer filter
    switchView('tickets');
    // Wait for tickets to load then set filter
    setTimeout(() => {
      const customerFilter = document.getElementById('ticket-filter-customer');
      if (customerFilter) {
        customerFilter.value = customerId;
        renderList();
      }
    }, 500);
  }

  // Toggle email notifications for a customer
  async function toggleCustomerEmailNotifications(customerId, enabled) {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customers/${customerId}/email-notifications`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ enabled: enabled })
      });

      const data = await response.json();

      if (data.success) {
        showToast(data.message, 'success');
        // Update local cache
        const customer = allCustomers.find(c => c.id === customerId);
        if (customer) {
          customer.email_notifications_enabled = enabled ? 1 : 0;
        }
      } else {
        showToast(data.message || 'Failed to update email notifications', 'error');
        // Revert checkbox state on failure
        renderCustomers();
      }
    } catch (error) {
      console.error('Error toggling email notifications:', error);
      showToast('Error updating email notifications', 'error');
      // Revert checkbox state on error
      renderCustomers();
    }
  }

  function showCreateCustomerForm() {
    document.getElementById('customer-modal-title').textContent = 'Add Team Member';
    document.getElementById('customer-save-btn-text').textContent = 'Create Team Member';
    document.getElementById('customer-form').reset();
    document.getElementById('customer-id').value = '';
    document.getElementById('customer-username').disabled = false;
    document.getElementById('customer-form-message').style.display = 'none';
    document.getElementById('customer-form-error').style.display = 'none';
    const modal = document.getElementById('customer-modal');
    modal.style.display = 'flex';
    modal.scrollTop = 0;
  }

  async function editCustomer(customerId) {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customers/${customerId}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.customer) {
        const c = data.customer;
        document.getElementById('customer-modal-title').textContent = 'Edit Customer';
        document.getElementById('customer-save-btn-text').textContent = 'Update Customer';
        document.getElementById('customer-id').value = c.id;
        document.getElementById('customer-username').value = c.username || '';
        document.getElementById('customer-username').disabled = true; // Cannot change username
        document.getElementById('customer-email').value = c.email || '';
        document.getElementById('customer-fullname').value = c.full_name || '';
        document.getElementById('customer-company').value = c.company_name || '';
        document.getElementById('customer-domain').value = c.company_domain || '';
        document.getElementById('customer-phone').value = c.contact_phone || '';
        document.getElementById('customer-address').value = c.address || '';
        document.getElementById('customer-sla').value = c.sla_level || 'basic';
        document.getElementById('customer-admin-emails').checked = c.admin_receive_emails !== 0;
        document.getElementById('customer-members-emails').checked = c.members_receive_emails !== 0;
        document.getElementById('customer-form-message').style.display = 'none';
        document.getElementById('customer-form-error').style.display = 'none';
        const modal = document.getElementById('customer-modal');
        modal.style.display = 'flex';
        modal.scrollTop = 0;
      } else {
        alert('Failed to load customer details');
      }
    } catch (error) {
      console.error('Error loading customer:', error);
      alert('Error loading customer details');
    }
  }

  function closeCustomerModal() {
    document.getElementById('customer-modal').style.display = 'none';
    document.getElementById('customer-form').reset();
  }

  // Customer Company functions
  function showCreateCustomerCompanyForm() {
    document.getElementById('company-modal-title').textContent = 'Add Customer Company';
    document.getElementById('company-save-btn-text').textContent = 'Create Company';
    document.getElementById('company-form').reset();
    document.getElementById('company-id').value = '';
    document.getElementById('company-form-message').style.display = 'none';
    document.getElementById('company-form-error').style.display = 'none';
    const modal = document.getElementById('company-modal');
    modal.style.display = 'flex';
    modal.scrollTop = 0;
  }

  function closeCompanyModal() {
    document.getElementById('company-modal').style.display = 'none';
    document.getElementById('company-form').reset();
  }

  // Company Management Functions
  async function showManageCompanies() {
    const modal = document.getElementById('company-list-modal');
    modal.style.display = 'flex';
    modal.scrollTop = 0;
    await renderCompanyList();
  }

  function closeCompanyListModal() {
    document.getElementById('company-list-modal').style.display = 'none';
  }

  async function renderCompanyList() {
    const body = document.getElementById('company-list-body');
    body.innerHTML = '<tr><td colspan="5" style="text-align:center">Loading...</td></tr>';

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customer-companies`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      const data = await response.json();

      if (data.success && data.companies) {
        if (data.companies.length === 0) {
          body.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6b7280">No companies found</td></tr>';
          return;
        }

        body.innerHTML = data.companies.map(company => {
          const slaLabels = { basic: 'Basic', premium: 'Premium', enterprise: 'Enterprise' };
          const memberCount = company.team_member_count || 0;
          const canDelete = memberCount === 0;

          return `
            <tr>
              <td><strong>${escapeHtml(company.company_name)}</strong></td>
              <td>${escapeHtml(company.company_domain || '-')}</td>
              <td>${slaLabels[company.sla_level] || company.sla_level || 'Basic'}</td>
              <td style="text-align:center">${memberCount}</td>
              <td>
                <div class="row" style="gap:4px">
                  <button class="btn ghost small" onclick="editCompany(${company.id})">Edit</button>
                  <button class="btn ghost small" onclick="deleteCompany(${company.id}, '${escapeHtml(company.company_name)}', ${memberCount})" ${canDelete ? '' : 'disabled'} title="${canDelete ? 'Delete company' : 'Cannot delete - has team members'}">Delete</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      } else {
        body.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#b91c1c">Failed to load companies</td></tr>';
      }
    } catch (error) {
      console.error('Error loading companies:', error);
      body.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#b91c1c">Error loading companies</td></tr>';
    }
  }

  function editCompany(companyId) {
    const company = allCustomerCompanies.find(c => c.id === companyId);
    if (!company) {
      alert('Company not found');
      return;
    }

    document.getElementById('company-modal-title').textContent = 'Edit Company';
    document.getElementById('company-save-btn-text').textContent = 'Save Changes';
    document.getElementById('company-id').value = company.id;
    document.getElementById('company-name').value = company.company_name || '';
    document.getElementById('company-domain').value = company.company_domain || '';
    document.getElementById('company-phone').value = company.contact_phone || '';
    document.getElementById('company-address').value = company.address || '';
    document.getElementById('company-sla').value = company.sla_level || 'basic';
    document.getElementById('company-notes').value = company.notes || '';
    document.getElementById('company-admin-emails').checked = company.admin_receive_emails !== 0;
    document.getElementById('company-members-emails').checked = company.members_receive_emails !== 0;
    document.getElementById('company-form-message').style.display = 'none';
    document.getElementById('company-form-error').style.display = 'none';

    closeCompanyListModal();
    const modal = document.getElementById('company-modal');
    modal.style.display = 'flex';
    modal.scrollTop = 0;
  }

  async function deleteCompany(companyId, companyName, memberCount) {
    if (memberCount > 0) {
      alert(`Cannot delete "${companyName}" - it has ${memberCount} active team member(s). Deactivate all team members first.`);
      return;
    }

    if (!confirm(`Are you sure you want to delete "${companyName}"?\n\nThis will deactivate the company. To permanently delete, you can do so from the database.`)) {
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customer-companies/${companyId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        alert(`Company "${companyName}" has been deleted.`);
        // Reload companies
        allCustomerCompanies = [];
        await loadCustomerCompanies();
        await renderCompanyList();
        renderCustomers();
      } else {
        alert(data.message || 'Failed to delete company');
      }
    } catch (error) {
      console.error('Error deleting company:', error);
      alert('Error deleting company. Please try again.');
    }
  }

  async function saveCustomerCompany(event) {
    event.preventDefault();

    const companyId = document.getElementById('company-id').value;
    const companyData = {
      company_name: document.getElementById('company-name').value,
      company_domain: document.getElementById('company-domain').value,
      contact_phone: document.getElementById('company-phone').value,
      address: document.getElementById('company-address').value,
      sla_level: document.getElementById('company-sla').value,
      notes: document.getElementById('company-notes').value,
      admin_receive_emails: document.getElementById('company-admin-emails').checked,
      members_receive_emails: document.getElementById('company-members-emails').checked
    };

    try {
      const token = localStorage.getItem('token');
      const url = companyId
        ? `${API_BASE}/api/customer-companies/${companyId}`
        : `${API_BASE}/api/customer-companies`;
      const method = companyId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(companyData)
      });

      const data = await response.json();

      if (data.success) {
        const msgEl = document.getElementById('company-form-message');
        const errEl = document.getElementById('company-form-error');
        errEl.style.display = 'none';

        if (data.admin) {
          msgEl.innerHTML = `Company created! Admin credentials:<br><strong>Username:</strong> ${data.admin.username}<br><strong>Email:</strong> ${data.admin.email}<br><strong>Temp Password:</strong> ${data.admin.tempPassword}`;
        } else {
          msgEl.textContent = companyId ? 'Company updated successfully!' : 'Company created successfully!';
        }
        msgEl.style.display = 'block';

        // Reload customer companies list
        allCustomerCompanies = [];
        await loadCustomerCompanies();

        // Close modal after a delay if just updating
        if (companyId) {
          setTimeout(() => {
            closeCompanyModal();
            renderCustomers();
          }, 1500);
        }
      } else {
        const errEl = document.getElementById('company-form-error');
        errEl.textContent = data.message || 'Failed to save company';
        errEl.style.display = 'block';
      }
    } catch (error) {
      console.error('Error saving company:', error);
      const errEl = document.getElementById('company-form-error');
      errEl.textContent = 'Error saving company';
      errEl.style.display = 'block';
    }
  }

  async function saveCustomer(event) {
    event.preventDefault();

    const customerId = document.getElementById('customer-id').value;
    const isEdit = !!customerId;

    const customerData = {
      username: document.getElementById('customer-username').value,
      email: document.getElementById('customer-email').value,
      full_name: document.getElementById('customer-fullname').value,
      company_name: document.getElementById('customer-company').value,
      company_domain: document.getElementById('customer-domain').value.toLowerCase(),
      contact_phone: document.getElementById('customer-phone').value,
      address: document.getElementById('customer-address').value,
      sla_level: document.getElementById('customer-sla').value,
      admin_receive_emails: document.getElementById('customer-admin-emails').checked,
      members_receive_emails: document.getElementById('customer-members-emails').checked
    };

    try {
      const token = localStorage.getItem('token');
      const url = isEdit
        ? `${API_BASE}/api/customers/${customerId}`
        : `${API_BASE}/api/customers`;
      const method = isEdit ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(customerData)
      });

      const data = await response.json();

      if (data.success) {
        const msg = isEdit ? 'Customer updated successfully!' : `Customer created successfully! Temporary password: ${data.tempPassword}`;
        document.getElementById('customer-form-message').textContent = msg;
        document.getElementById('customer-form-message').style.display = 'block';
        document.getElementById('customer-form-error').style.display = 'none';

        // If creating new customer, show temp password for a few seconds
        if (!isEdit) {
          setTimeout(() => {
            closeCustomerModal();
            renderCustomers();
            alert(`Customer created!\n\nUsername: ${customerData.username}\nTemporary Password: ${data.tempPassword}\n\nPlease share this password with the customer.`);
          }, 2000);
        } else {
          setTimeout(() => {
            closeCustomerModal();
            renderCustomers();
          }, 1500);
        }
      } else {
        document.getElementById('customer-form-error').textContent = data.message || 'Failed to save customer';
        document.getElementById('customer-form-error').style.display = 'block';
        document.getElementById('customer-form-message').style.display = 'none';
      }
    } catch (error) {
      console.error('Error saving customer:', error);
      document.getElementById('customer-form-error').textContent = 'Error saving customer';
      document.getElementById('customer-form-error').style.display = 'block';
      document.getElementById('customer-form-message').style.display = 'none';
    }
  }

  async function deleteCustomer(customerId) {
    const customer = allCustomers.find(c => c.id === customerId);
    if (!customer) return;

    const confirmMsg = `Are you sure you want to deactivate customer "${customer.full_name || customer.username}"?\n\nCompany: ${customer.company_name || 'N/A'}\nDomain: ${customer.company_domain || 'N/A'}\n\nThis will prevent them from logging in, but their data will be preserved.`;

    if (!confirm(confirmMsg)) {
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customers/${customerId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        alert('Customer deactivated successfully');
        renderCustomers();
      } else {
        alert(data.message || 'Failed to deactivate customer');
      }
    } catch (error) {
      console.error('Error deleting customer:', error);
      alert('Error deactivating customer');
    }
  }

  async function reactivateCustomer(customerId) {
    const customer = allCustomers.find(c => c.id === customerId);
    if (!customer) return;

    if (!confirm(`Reactivate customer "${customer.full_name || customer.username}"?`)) {
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customers/${customerId}/reactivate`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        alert('Customer reactivated successfully');
        renderCustomers();
      } else {
        alert(data.message || 'Failed to reactivate customer');
      }
    } catch (error) {
      console.error('Error reactivating customer:', error);
      alert('Error reactivating customer');
    }
  }

  // ---- My Profile ----
  async function loadProfile(){ 
    try{ 
      const token=localStorage.getItem('token'); 
      if(!token){ alert('Session expired'); window.location.reload(); return; } 
      const res=await fetch(`${API_BASE}/api/auth/profile`,{headers:{'Authorization':`Bearer ${token}`}}); 
      const data=await res.json(); 
      if(!data.success){ alert('Failed to load profile: '+data.message); return; } 
      const profile=data.profile; 
      document.getElementById('profile-username').value=profile.username||''; 
      document.getElementById('profile-role').value=profile.role||''; 
      document.getElementById('profile-fullname').value=profile.full_name||''; 
      document.getElementById('profile-email').value=profile.email||''; 
      document.getElementById('profile-phone').value=profile.phone||''; 
      document.getElementById('profile-department').value=profile.department||'';
      document.getElementById('profile-receive-email-updates').checked = profile.receive_email_updates == 1;
      document.getElementById('profile-created').value=profile.created_at?new Date(profile.created_at).toLocaleString():'';
      document.getElementById('profile-updated').value=profile.updated_at?new Date(profile.updated_at).toLocaleString():'';
      // Show company name card for customer role
      const companyCard = document.getElementById('profile-company-card');
      const companyName = profile.customer_name || profile.company || '';
      if (companyName && (window.role || role) === 'customer') {
        document.getElementById('profile-company-name').textContent = companyName;
        document.getElementById('profile-company-icon').textContent = companyName.charAt(0).toUpperCase();
        companyCard.style.display = 'block';
      } else {
        companyCard.style.display = 'none';
      }
    }catch(err){ alert('Error loading profile: '+err.message); }
  }
  async function saveProfile(){ 
    try{ 
      const token=localStorage.getItem('token'); 
      if(!token){ alert('Session expired'); window.location.reload(); return; } 
      const profileData={ full_name:document.getElementById('profile-fullname').value, email:document.getElementById('profile-email').value, phone:document.getElementById('profile-phone').value, department:document.getElementById('profile-department').value, receive_email_updates:document.getElementById('profile-receive-email-updates').checked }; 
      const res=await fetch(`${API_BASE}/api/auth/profile`,{method:'PUT',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify(profileData)}); 
      const data=await res.json(); 
      if(!data.success){ alert('Failed to update profile: '+data.message); return; } 
      alert('Profile updated successfully!'); 
      await loadProfile(); 
    }catch(err){ alert('Error updating profile: '+err.message); } 
  }

  // ---- CMDB ----
  window.cmdbTicketMode = window.cmdbTicketMode || 'all';
  let cmdbSortField = 'asset_name';
  let cmdbSortDir = 'asc';

  function cmdbSort(field) {
    if (cmdbSortField === field) {
      cmdbSortDir = cmdbSortDir === 'asc' ? 'desc' : 'asc';
    } else {
      cmdbSortField = field;
      cmdbSortDir = 'asc';
    }
    ['customer_name','asset_name','asset_category','brand_name'].forEach(f => {
      const el = document.getElementById('cmdb-sort-' + f);
      if (el) el.textContent = f === cmdbSortField ? (cmdbSortDir === 'asc' ? '▲' : '▼') : '';
    });
    renderCMDB();
  }

  function toggleCMDBTicketMode() {
    window.cmdbTicketMode = window.cmdbTicketMode === 'all' ? 'open' : 'all';
    const btn = document.getElementById('cmdbTicketToggle');
    if (btn) btn.textContent = window.cmdbTicketMode === 'all' ? 'All' : 'Open';
    renderCMDB();
  }

  function renderCMDB(){
    const loading = document.getElementById('cmdb-loading');
    const table = document.getElementById('cmdb-table');
    const empty = document.getElementById('cmdb-empty');

    if(CMDB_ITEMS.length===0){
      if (!cmdbItemsLoaded) {
        // First load - show loading and fetch from API
        if(loading) loading.style.display='block';
        if(table) table.style.display='none';
        if(empty) empty.style.display='none';
        loadCMDBItemsFromAPI();
        return;
      } else {
        // Already loaded but empty - show empty state
        if(loading) loading.style.display='none';
        if(table) table.style.display='none';
        if(empty) empty.style.display='block';
        return;
      }
    }

    // Populate customer dropdown (hide for customer role — backend already filters)
    const sel=document.getElementById('cmdb-customer');
    const isCustomerRole = (window.role || role) === 'customer';
    if (sel) {
      sel.style.display = isCustomerRole ? 'none' : '';
      if (!isCustomerRole) {
        const current=sel.value;
        sel.innerHTML='<option value="">All customers</option>';
        [...new Set(CMDB_ITEMS.map(i=>i.customer_name||i.customer||''))].filter(c=>c).sort().forEach(c=>{
          const o=document.createElement('option');
          o.value=c;
          o.textContent = c;
          if(c===current) o.selected=true;
          sel.appendChild(o);
        });
      }
    }

    const q=(document.getElementById('cmdb-search').value||'').toLowerCase();
    const custFilter = isCustomerRole ? '' : (sel ? sel.value : '');
    const body=document.getElementById('cmdb-body');
    body.innerHTML='';

    const filtered = CMDB_ITEMS.filter(i=>{
      const customerName = i.customer_name || i.customer || '';
      const assetName = i.asset_name || i.name || '';
      return (!custFilter || customerName===custFilter) &&
             (!q || assetName.toLowerCase().includes(q) || customerName.toLowerCase().includes(q));
    });

    // Apply sorting
    filtered.sort((a, b) => {
      let aVal = a[cmdbSortField] || a.customer || a.name || '';
      let bVal = b[cmdbSortField] || b.customer || b.name || '';
      if (cmdbSortField === 'brand_name') {
        aVal = [a.brand_name, a.model_name].filter(Boolean).join(' ');
        bVal = [b.brand_name, b.model_name].filter(Boolean).join(' ');
      }
      aVal = String(aVal).toLowerCase();
      bVal = String(bVal).toLowerCase();
      if (aVal < bVal) return cmdbSortDir === 'asc' ? -1 : 1;
      if (aVal > bVal) return cmdbSortDir === 'asc' ? 1 : -1;
      return 0;
    });

    // Store total count before pagination
    const totalFiltered = filtered.length;
    const pageSize = getPageSize('cmdb');

    // Validate current page
    const maxPage = Math.max(1, Math.ceil(totalFiltered / pageSize));
    if (cmdbPage > maxPage) cmdbPage = maxPage;

    // Apply pagination
    const paginatedItems = paginateArray(filtered, cmdbPage, pageSize);

    // Update count
    const countDiv = document.getElementById('cmdb-count');
    if (countDiv) {
      countDiv.textContent = `Showing ${totalFiltered} of ${CMDB_ITEMS.length} items`;
    }

    // Render pagination controls
    renderPaginationControls('cmdb-pagination', cmdbPage, totalFiltered, pageSize, 'setCMDBPage', 'setCMDBPageSize', 'cmdb');

    if(loading) loading.style.display='none';

    if(filtered.length === 0){
      if(table) table.style.display='none';
      if(empty) empty.style.display='block';
      return;
    }

    if(table) table.style.display='table';
    if(empty) empty.style.display='none';

    paginatedItems.forEach(i=>{
      const tr=document.createElement('tr');
      const customerName = i.customer_name || i.customer || '—';
      const assetName = i.asset_name || i.name || '—';
      const category = i.asset_category || i.type || '—';
      const brandModel = [i.brand_name, i.model_name].filter(Boolean).join(' / ') || '—';
      const ciCount = i.ci_count || '—';
      const ticketCount = window.cmdbTicketMode === 'open' ? (i.open_ticket_count || 0) : (i.ticket_count || 0);
      tr.innerHTML = `<td>${customerName}</td><td>${assetName}</td><td>${category}</td><td>${brandModel}</td><td style="text-align:center">${ciCount}</td><td style="text-align:center">${ticketCount}</td><td><button class='btn primary' onclick='openItem("${i.cmdb_id}")'>Open</button></td>`;
      body.appendChild(tr);
    });
  }
  function openItem(id){
    currentItemId=id;
    currentCMDBId=id; // For CMDB V2 features
    switchView('cmdb-detail');
  }
  async function renderCMDBDetail(){
    const item = CMDB_ITEMS.find(i=>i.cmdb_id===currentItemId) || {};

    // Set global state for CMDB V2 features
    currentCMDBId = currentItemId;
    currentCMDBCategory = item.asset_category || item.type || null;

    // Reset tabs to first tab
    switchCMDBDetailTab('ci');

    // Populate header info
    document.getElementById('cmdb-name-h').textContent = item.asset_name || item.name || '(Unnamed)';
    document.getElementById('cmdb-customer-h').textContent = item.customer_name || item.customer || '—';
    document.getElementById('cmdb-category-h').textContent = item.asset_category || item.type || '—';
    document.getElementById('cmdb-brand-h').textContent = item.brand_name || '—';
    document.getElementById('cmdb-model-h').textContent = item.model_name || '—';
    document.getElementById('cmdb-location-h').textContent = item.asset_location || '—';
    document.getElementById('cmdb-id-h').textContent = currentItemId || '—';

    // Populate comment if exists
    const commentSection = document.getElementById('cmdb-comment-section');
    const commentEl = document.getElementById('cmdb-comment-h');
    if (item.comment && item.comment.trim()) {
      commentEl.textContent = item.comment;
      commentSection.style.display = 'block';
    } else {
      commentSection.style.display = 'none';
    }

    // Show loading state
    const ciLoading = document.getElementById('ci-loading');
    const ciTable = document.getElementById('ci-table');
    const ciEmpty = document.getElementById('ci-empty');
    const ciCount = document.getElementById('ci-count');

    if(ciLoading) ciLoading.style.display='block';
    if(ciTable) ciTable.style.display='none';
    if(ciEmpty) ciEmpty.style.display='none';

    // Load CIs from API if not cached
    let list = CIS_BY_ITEM[currentItemId];
    if (!list) { list = await loadCIsForItem(currentItemId); }

    if(ciLoading) ciLoading.style.display='none';

    const head = document.getElementById('ci-head');
    const body = document.getElementById('ci-body');
    head.innerHTML='';
    body.innerHTML='';

    if(!list || list.length===0){
      if(ciTable) ciTable.style.display='none';
      if(ciEmpty) ciEmpty.style.display='block';
      if(ciCount) ciCount.textContent='0';
      return;
    }

    if(ciCount) ciCount.textContent = list.length;
    if(ciTable) ciTable.style.display='table';
    if(ciEmpty) ciEmpty.style.display='none';

    // Display CIs as Field Name / Value table
    head.innerHTML = '<tr><th>Field Name</th><th>Value</th></tr>';
    list.forEach(ci=>{
      const tr = document.createElement('tr');
      const fieldName = ci.ci_name || '—';
      const fieldValue = ci.category_field_value || '—';
      tr.innerHTML = `<td>${fieldName}</td><td>${fieldValue}</td>`;
      body.appendChild(tr);
    });
  }
  function showCreateCMDBForm(){ switchView('cmdb-mgmt'); cmdbMgmtOpenCreate(); }
  function showImportCMDBDialog(){ switchView('cmdb-mgmt'); cmdbMgmtOpenImport(); }

  // ---- CMDB Management View ----
  let CMDB_MGMT_ITEMS = [];
  let CMDB_MGMT_CURRENT_ID = null;
  window.cmdbMgmtTicketMode = 'all';
  let cmdbMgmtSortField = 'asset_name';
  let cmdbMgmtSortDir = 'asc';

  function cmdbMgmtSort(field) {
    if (cmdbMgmtSortField === field) {
      cmdbMgmtSortDir = cmdbMgmtSortDir === 'asc' ? 'desc' : 'asc';
    } else {
      cmdbMgmtSortField = field;
      cmdbMgmtSortDir = 'asc';
    }
    // Update sort indicators
    ['asset_name','asset_category','brand_name','customer_name','asset_location','status'].forEach(f => {
      const el = document.getElementById('cmdb-mgmt-sort-' + f);
      if (el) el.textContent = f === cmdbMgmtSortField ? (cmdbMgmtSortDir === 'asc' ? '▲' : '▼') : '';
    });
    cmdbMgmtRender();
  }

  function cmdbMgmtToggleTicketMode() {
    window.cmdbMgmtTicketMode = window.cmdbMgmtTicketMode === 'all' ? 'open' : 'all';
    const btn = document.getElementById('cmdbMgmtTicketToggle');
    if (btn) btn.textContent = window.cmdbMgmtTicketMode === 'all' ? 'All' : 'Open';
    cmdbMgmtRender();
  }

  async function loadCMDBMgmt() {
    const loading = document.getElementById('cmdb-mgmt-loading');
    const table = document.getElementById('cmdb-mgmt-table');
    const empty = document.getElementById('cmdb-mgmt-empty');
    if(loading) loading.style.display='block';
    if(table) table.style.display='none';
    if(empty) empty.style.display='none';
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) {
        if(loading) loading.innerHTML = '<div style="color:#e53e3e;">No tenant selected</div>';
        return;
      }
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items`, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      if (data.success) {
        CMDB_MGMT_ITEMS = data.items;
        cmdbMgmtPopulateFilters();
        cmdbMgmtRender();
      } else {
        if(loading) loading.innerHTML = `<div style="color:#e53e3e;">Error: ${data.message}</div>`;
      }
    } catch (err) {
      if(loading) loading.innerHTML = `<div style="color:#e53e3e;">Error: ${err.message}</div>`;
    }
  }

  function cmdbMgmtPopulateFilters() {
    const cats = [...new Set(CMDB_MGMT_ITEMS.map(i => i.asset_category).filter(Boolean))].sort();
    const custs = [...new Set(CMDB_MGMT_ITEMS.map(i => i.customer_name).filter(Boolean))].sort();
    const catSel = document.getElementById('cmdb-mgmt-category');
    const custSel = document.getElementById('cmdb-mgmt-customer');
    catSel.innerHTML = '<option value="">All Categories</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
    custSel.innerHTML = '<option value="">All Customers</option>' + custs.map(c => `<option value="${c}">${c}</option>`).join('');
  }

  function cmdbMgmtApplyFilters() { cmdbMgmtRender(); }

  function cmdbMgmtRender() {
    const loading = document.getElementById('cmdb-mgmt-loading');
    const table = document.getElementById('cmdb-mgmt-table');
    const empty = document.getElementById('cmdb-mgmt-empty');
    const body = document.getElementById('cmdb-mgmt-body');
    const search = (document.getElementById('cmdb-mgmt-search').value || '').toLowerCase();
    const catFilter = document.getElementById('cmdb-mgmt-category').value;
    const custFilter = document.getElementById('cmdb-mgmt-customer').value;

    const filtered = CMDB_MGMT_ITEMS.filter(i => {
      const matchSearch = !search || i.asset_name.toLowerCase().includes(search) || (i.customer_name||'').toLowerCase().includes(search) || (i.asset_location||'').toLowerCase().includes(search);
      const matchCat = !catFilter || i.asset_category === catFilter;
      const matchCust = !custFilter || i.customer_name === custFilter;
      return matchSearch && matchCat && matchCust;
    });

    // Apply sorting
    filtered.sort((a, b) => {
      let aVal = a[cmdbMgmtSortField] || '';
      let bVal = b[cmdbMgmtSortField] || '';
      if (cmdbMgmtSortField === 'brand_name') {
        aVal = [a.brand_name, a.model_name].filter(Boolean).join(' ');
        bVal = [b.brand_name, b.model_name].filter(Boolean).join(' ');
      }
      aVal = String(aVal).toLowerCase();
      bVal = String(bVal).toLowerCase();
      if (aVal < bVal) return cmdbMgmtSortDir === 'asc' ? -1 : 1;
      if (aVal > bVal) return cmdbMgmtSortDir === 'asc' ? 1 : -1;
      return 0;
    });

    if(loading) loading.style.display = 'none';
    if (filtered.length === 0) {
      if(table) table.style.display = 'none';
      if(empty) empty.style.display = 'block';
      return;
    }
    if(table) table.style.display = 'table';
    if(empty) empty.style.display = 'none';
    body.innerHTML = filtered.map(i => {
      const ticketCount = window.cmdbMgmtTicketMode === 'open' ? (i.open_ticket_count || 0) : (i.ticket_count || 0);
      return `<tr>
        <td><strong>${i.asset_name}</strong></td>
        <td>${i.asset_category || '—'}</td>
        <td>${[i.brand_name, i.model_name].filter(Boolean).join(' / ') || '—'}</td>
        <td>${i.customer_name || '—'}</td>
        <td>${i.asset_location || '—'}</td>
        <td style="text-align:center">${i.ci_count || 0}</td>
        <td style="text-align:center">${ticketCount}</td>
        <td><span class="badge ${i.status === 'active' ? 'success' : 'danger'}">${i.status}</span></td>
        <td>
          <button class="btn" onclick="cmdbMgmtView('${i.cmdb_id}')">View</button>
          <button class="btn" onclick="cmdbMgmtEdit('${i.cmdb_id}')">Edit</button>
          <button class="btn danger" onclick="cmdbMgmtDelete('${i.cmdb_id}')">Delete</button>
        </td>
      </tr>`;
    }).join('');
  }

  function cmdbMgmtOpenCreate() {
    document.getElementById('cmdb-mgmt-modal-title').textContent = 'Add CMDB Item';
    document.getElementById('cmdb-mgmt-id').value = '';
    ['asset-name','asset-category','category-field','brand','model','customer-name','employee-of','location','comment'].forEach(f => {
      const el = document.getElementById('cmdb-mgmt-' + f);
      if (el) el.value = '';
    });
    document.getElementById('cmdb-mgmt-status').value = 'active';
    document.getElementById('cmdb-mgmt-modal').style.display = 'flex';
  }

  async function cmdbMgmtEdit(cmdbId) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) return;
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${cmdbId}`, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      if (data.success) {
        const i = data.item;
        document.getElementById('cmdb-mgmt-modal-title').textContent = 'Edit CMDB Item';
        document.getElementById('cmdb-mgmt-id').value = i.cmdb_id;
        document.getElementById('cmdb-mgmt-asset-name').value = i.asset_name || '';
        document.getElementById('cmdb-mgmt-asset-category').value = i.asset_category || '';
        document.getElementById('cmdb-mgmt-category-field').value = i.category_field_value || '';
        document.getElementById('cmdb-mgmt-brand').value = i.brand_name || '';
        document.getElementById('cmdb-mgmt-model').value = i.model_name || '';
        document.getElementById('cmdb-mgmt-customer-name').value = i.customer_name || '';
        document.getElementById('cmdb-mgmt-employee-of').value = i.employee_of || '';
        document.getElementById('cmdb-mgmt-location').value = i.asset_location || '';
        document.getElementById('cmdb-mgmt-comment').value = i.comment || '';
        document.getElementById('cmdb-mgmt-status').value = i.status || 'active';
        document.getElementById('cmdb-mgmt-modal').style.display = 'flex';
      }
    } catch (err) { alert('Error loading item: ' + err.message); }
  }

  async function cmdbMgmtSave() {
    const cmdbId = document.getElementById('cmdb-mgmt-id').value;
    const itemData = {
      asset_name: document.getElementById('cmdb-mgmt-asset-name').value,
      asset_category: document.getElementById('cmdb-mgmt-asset-category').value,
      category_field_value: document.getElementById('cmdb-mgmt-category-field').value,
      brand_name: document.getElementById('cmdb-mgmt-brand').value,
      model_name: document.getElementById('cmdb-mgmt-model').value,
      customer_name: document.getElementById('cmdb-mgmt-customer-name').value,
      employee_of: document.getElementById('cmdb-mgmt-employee-of').value,
      asset_location: document.getElementById('cmdb-mgmt-location').value,
      comment: document.getElementById('cmdb-mgmt-comment').value,
      status: document.getElementById('cmdb-mgmt-status').value
    };
    if (!itemData.asset_name || !itemData.asset_category) { alert('Asset Name and Category are required'); return; }
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) { alert('No tenant selected'); return; }
      const url = cmdbId ? `${API_BASE}/api/cmdb/${tenantCode}/items/${cmdbId}` : `${API_BASE}/api/cmdb/${tenantCode}/items`;
      const res = await fetch(url, {
        method: cmdbId ? 'PUT' : 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(itemData)
      });
      const data = await res.json();
      if (data.success) { cmdbMgmtCloseModal(); loadCMDBMgmt(); alert(data.message); }
      else { alert('Error: ' + data.message); }
    } catch (err) { alert('Error saving: ' + err.message); }
  }

  function cmdbMgmtCloseModal() { document.getElementById('cmdb-mgmt-modal').style.display = 'none'; }

  async function cmdbMgmtView(cmdbId) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) return;
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${cmdbId}`, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      if (data.success) {
        const i = data.item;
        const cis = i.configuration_items || [];
        document.getElementById('cmdb-mgmt-view-content').innerHTML = `
          <div style="margin-bottom:24px;">
            <h3 style="margin-bottom:16px;">${i.asset_name}</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;background:var(--bg);padding:20px;border-radius:8px;">
              <div><strong>Category:</strong> ${i.asset_category}</div>
              <div><strong>Brand:</strong> ${i.brand_name || '—'}</div>
              <div><strong>Model:</strong> ${i.model_name || '—'}</div>
              <div><strong>Customer:</strong> ${i.customer_name || '—'}</div>
              <div><strong>Location:</strong> ${i.asset_location || '—'}</div>
              <div><strong>Status:</strong> <span class="badge ${i.status === 'active' ? 'success' : 'danger'}">${i.status}</span></div>
            </div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
              <h4>Configuration Items (${cis.length})</h4>
              <button class="btn primary" onclick="cmdbMgmtAddCI('${i.cmdb_id}')">Add CI</button>
            </div>
            ${cis.length === 0 ? '<p style="text-align:center;color:var(--muted);padding:20px;">No Configuration Items yet</p>' :
              cis.map(ci => `<div style="background:var(--bg);padding:12px;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                <div><strong>${ci.ci_name}</strong>${ci.category_field_value ? ` <span style="color:var(--muted)">— ${ci.category_field_value}</span>` : ''}</div>
                <button class="btn danger" onclick="cmdbMgmtDeleteCI('${ci.ci_id}','${i.cmdb_id}')">Delete</button>
              </div>`).join('')}
          </div>`;
        CMDB_MGMT_CURRENT_ID = cmdbId;
        document.getElementById('cmdb-mgmt-view-modal').style.display = 'flex';
      }
    } catch (err) { alert('Error loading item: ' + err.message); }
  }

  function cmdbMgmtCloseViewModal() { document.getElementById('cmdb-mgmt-view-modal').style.display = 'none'; }

  async function cmdbMgmtAddCI(cmdbId) {
    const ciName = prompt('Enter CI Name:');
    if (!ciName) return;
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) return;
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${cmdbId}/cis`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ ci_name: ciName, status: 'active' })
      });
      const data = await res.json();
      if (data.success) { cmdbMgmtView(cmdbId); } else { alert('Error: ' + data.message); }
    } catch (err) { alert('Error: ' + err.message); }
  }

  async function cmdbMgmtDeleteCI(ciId, cmdbId) {
    if (!confirm('Delete this Configuration Item?')) return;
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) return;
      await fetch(`${API_BASE}/api/cmdb/${tenantCode}/cis/${ciId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
      cmdbMgmtView(cmdbId);
    } catch (err) { alert('Error: ' + err.message); }
  }

  async function cmdbMgmtDelete(cmdbId) {
    if (!confirm('Delete this CMDB item and all its CIs?')) return;
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) return;
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${cmdbId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      if (data.success) { loadCMDBMgmt(); alert(data.message); } else { alert('Error: ' + data.message); }
    } catch (err) { alert('Error: ' + err.message); }
  }

  async function cmdbMgmtDeleteAll() {
    const count = CMDB_MGMT_ITEMS.length;
    if (count === 0) { alert('No CMDB items to delete'); return; }
    if (!confirm(`Delete ALL ${count} CMDB items and their CIs? This cannot be undone!`)) return;
    const conf = prompt('Type "DELETE ALL" to confirm:');
    if (conf !== 'DELETE ALL') { alert('Cancelled'); return; }
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) { alert('No tenant selected'); return; }
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/all`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      if (data.success) { loadCMDBMgmt(); alert(`Deleted ${data.deleted_items} items and ${data.deleted_cis} CIs`); }
      else { alert('Error: ' + data.message); }
    } catch (err) { alert('Error: ' + err.message); }
  }

  function cmdbMgmtOpenImport() {
    document.getElementById('cmdb-mgmt-csv-file').value = '';
    document.getElementById('cmdb-mgmt-file-name').textContent = 'Click to select CSV file';
    document.getElementById('cmdb-mgmt-import-btn').disabled = true;
    document.getElementById('cmdb-mgmt-import-progress').style.display = 'none';
    document.getElementById('cmdb-mgmt-import-modal').style.display = 'flex';
  }

  function cmdbMgmtCloseImportModal() { document.getElementById('cmdb-mgmt-import-modal').style.display = 'none'; }

  function cmdbMgmtFileSelected(e) {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('cmdb-mgmt-file-name').textContent = file.name;
      document.getElementById('cmdb-mgmt-import-btn').disabled = false;
    }
  }

  async function cmdbMgmtImport() {
    const file = document.getElementById('cmdb-mgmt-csv-file').files[0];
    if (!file) { alert('Select a file'); return; }
    const formData = new FormData();
    formData.append('file', file);
    document.getElementById('cmdb-mgmt-import-progress').style.display = 'block';
    document.getElementById('cmdb-mgmt-import-status').textContent = 'Importing...';
    document.getElementById('cmdb-mgmt-import-btn').disabled = true;
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) { alert('No tenant selected'); return; }
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/import/items`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById('cmdb-mgmt-import-status').innerHTML = `<div style="color:#38a169;font-weight:600;">Success!</div><div>New: ${data.assets_imported || 0}, Updated: ${data.assets_updated || 0}, CIs: ${data.configuration_items_imported || 0}</div>`;
        setTimeout(() => { cmdbMgmtCloseImportModal(); loadCMDBMgmt(); }, 2000);
      } else {
        document.getElementById('cmdb-mgmt-import-status').innerHTML = `<div style="color:#e53e3e;">Error: ${data.message}</div>`;
        document.getElementById('cmdb-mgmt-import-btn').disabled = false;
      }
    } catch (err) {
      document.getElementById('cmdb-mgmt-import-status').innerHTML = `<div style="color:#e53e3e;">Error: ${err.message}</div>`;
      document.getElementById('cmdb-mgmt-import-btn').disabled = false;
    }
  }

  function cmdbMgmtDownloadTemplate() {
    const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
    if (!tenantCode) { alert('No tenant selected'); return; }
    window.location.href = `${API_BASE}/api/cmdb/${tenantCode}/template/items`;
  }

  // ---- Manage CMDB Types ----
  async function loadManageCMDB(){ 
    try{ 
      const token=localStorage.getItem('token'); 
      if(!token){ alert('Session expired'); window.location.reload(); return; } 
      const tenantCode = window.tenant || 'apoyar';
      const res=await fetch(`${API_BASE}/api/cmdb-types/${tenantCode}/item-types`,{headers:{'Authorization':`Bearer ${token}`}});
      const data=await res.json(); 
      if(!data.success){ alert('Failed to load CMDB types: '+data.message); return; } 
      const body=document.getElementById('item-types-body'); body.innerHTML=''; data.itemTypes.forEach(t=>{ const tr=document.createElement('tr'); const safeName = (t.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;'); tr.innerHTML=`<td>${t.name}</td><td>${t.description||'—'}</td><td>${t.ci_count||0}</td><td><span class="badge ${t.is_active?'success':'danger'}">${t.is_active?'Active':'Inactive'}</span></td><td><button class="btn" onclick="viewCITypes(${t.id},'${safeName}')">View CI Types</button></td>`; body.appendChild(tr); }); 
    }catch(err){ alert('Error loading CMDB types: '+err.message); } 
  }
  async function viewCITypes(itemTypeId, itemTypeName){ 
    document.getElementById('selected-item-type-name').textContent=itemTypeName; 
    document.getElementById('ci-types-section').style.display='block'; 
    try{ 
      const token=localStorage.getItem('token'); 
      const tenantCode = window.tenant || 'apoyar';
      const res=await fetch(`${API_BASE}/api/cmdb-types/${tenantCode}/item-types/${itemTypeId}/ci-types`,{headers:{'Authorization':`Bearer ${token}`}});
      const data=await res.json(); 
      if(!data.success){ alert('Failed to load CI types: '+data.message); return; } 
      const body=document.getElementById('ci-types-body'); body.innerHTML=''; data.ciTypes.forEach(ci=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${ci.name}</td><td>${ci.description||'—'}</td><td><span class="badge ${ci.is_active?'success':'danger'}">${ci.is_active?'Active':'Inactive'}</span></td><td><button class="btn">Edit</button></td>`; body.appendChild(tr); }); 
    }catch(err){ alert('Error loading CI types: '+err.message); } 
  }
  function showCreateItemTypeForm(){ alert('To add a new CMDB Item Type, contact the database administrator or use the API.'); }
  function showCreateCITypeForm(){ alert('To add a new CI Type, select an Item Type first and click "Add CI Type" button.'); }

  // ============================================================================
  // CMDB V2 FEATURES: Custom Fields, Relationships, History
  // ============================================================================

  // --- Global state for CMDB detail ---
  let currentCMDBId = null;
  let currentCMDBCategory = null;
  let cmdbHistoryOffset = 0;
  const cmdbHistoryLimit = 20;

  // --- Tab switching ---
  function switchCMDBDetailTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.cmdb-tab').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    // Show/hide content
    document.querySelectorAll('.cmdb-tab-content').forEach(content => {
      content.style.display = 'none';
    });
    const tabContent = document.getElementById(`cmdb-tab-${tab}`);
    if (tabContent) tabContent.style.display = 'block';

    // Load data for the tab
    if (tab === 'custom-fields') loadCustomFieldValues();
    if (tab === 'relationships') loadRelationships();
    if (tab === 'history') { cmdbHistoryOffset = 0; loadCMDBHistory(); }
  }

  // ============================================================================
  // CUSTOM FIELDS ADMIN (Admin Settings section)
  // ============================================================================

  async function loadCustomFieldDefinitions() {
    const loading = document.getElementById('custom-fields-loading');
    const table = document.getElementById('custom-fields-table');
    const empty = document.getElementById('custom-fields-empty');
    const body = document.getElementById('custom-fields-body');
    const categoryFilter = document.getElementById('custom-fields-category-filter');

    loading.style.display = 'block';
    table.style.display = 'none';
    empty.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) {
        loading.style.display = 'none';
        empty.textContent = 'No tenant selected';
        empty.style.display = 'block';
        return;
      }
      const category = categoryFilter.value;
      const url = category
        ? `${API_BASE}/api/cmdb/${tenantCode}/custom-fields/${encodeURIComponent(category)}`
        : `${API_BASE}/api/cmdb/${tenantCode}/custom-fields`;

      const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();

      loading.style.display = 'none';

      if (!data.success) {
        empty.textContent = 'Error: ' + data.message;
        empty.style.display = 'block';
        return;
      }

      if (data.fields.length === 0) {
        empty.style.display = 'block';
        return;
      }

      table.style.display = 'table';
      body.innerHTML = '';

      data.fields.forEach(field => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(field.asset_category)}</td>
          <td><code>${escapeHtml(field.field_name)}</code></td>
          <td>${escapeHtml(field.field_label)}</td>
          <td><span class="badge">${field.field_type}</span></td>
          <td>${field.is_required ? '<span class="badge success">Yes</span>' : '<span class="badge">No</span>'}</td>
          <td>${field.display_order}</td>
          <td>
            <button class="btn" onclick="editCustomField(${field.id})">Edit</button>
            <button class="btn danger" onclick="deleteCustomField(${field.id})">Delete</button>
          </td>
        `;
        body.appendChild(tr);
      });

      // Populate category filter if needed
      await populateCustomFieldCategoryFilter();
    } catch (err) {
      loading.style.display = 'none';
      empty.textContent = 'Error loading custom fields: ' + err.message;
      empty.style.display = 'block';
    }
  }

  async function populateCustomFieldCategoryFilter() {
    const filter = document.getElementById('custom-fields-category-filter');
    const currentValue = filter.value;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) return;
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items`, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();

      if (data.success && data.items) {
        const categories = [...new Set(data.items.map(i => i.asset_category).filter(Boolean))].sort();
        filter.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          if (cat === currentValue) opt.selected = true;
          filter.appendChild(opt);
        });
      }
    } catch (err) {
      console.error('Error populating category filter:', err);
    }
  }

  function toggleDropdownOptions() {
    const type = document.getElementById('custom-field-type').value;
    document.getElementById('dropdown-options-section').style.display = type === 'dropdown' ? 'block' : 'none';
  }

  async function showAddCustomFieldModal() {
    document.getElementById('custom-field-modal-title').textContent = 'Add Custom Field';
    document.getElementById('custom-field-edit-id').value = '';
    document.getElementById('custom-field-name').value = '';
    document.getElementById('custom-field-name').disabled = false;
    document.getElementById('custom-field-label').value = '';
    document.getElementById('custom-field-type').value = 'text';
    document.getElementById('custom-field-dropdown-options').value = '';
    document.getElementById('custom-field-order').value = '0';
    document.getElementById('custom-field-required').checked = false;
    document.getElementById('custom-field-error').style.display = 'none';
    toggleDropdownOptions();

    // Populate category dropdown
    const catSelect = document.getElementById('custom-field-category');
    catSelect.innerHTML = '<option value="">-- Select Category --</option>';
    catSelect.disabled = false;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) return;
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items`, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();

      if (data.success && data.items) {
        const categories = [...new Set(data.items.map(i => i.asset_category).filter(Boolean))].sort();
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          catSelect.appendChild(opt);
        });
      }
    } catch (err) {
      console.error('Error loading categories:', err);
    }

    document.getElementById('custom-field-modal').style.display = 'flex';
  }

  async function editCustomField(id) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) return;
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/custom-fields`, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();

      if (!data.success) {
        alert('Error loading field: ' + data.message);
        return;
      }

      const field = data.fields.find(f => f.id === id);
      if (!field) {
        alert('Field not found');
        return;
      }

      document.getElementById('custom-field-modal-title').textContent = 'Edit Custom Field';
      document.getElementById('custom-field-edit-id').value = id;
      document.getElementById('custom-field-name').value = field.field_name;
      document.getElementById('custom-field-name').disabled = true; // Can't change field name
      document.getElementById('custom-field-label').value = field.field_label;
      document.getElementById('custom-field-type').value = field.field_type;
      document.getElementById('custom-field-dropdown-options').value = field.dropdown_options ? field.dropdown_options.join('\n') : '';
      document.getElementById('custom-field-order').value = field.display_order;
      document.getElementById('custom-field-required').checked = field.is_required;
      document.getElementById('custom-field-error').style.display = 'none';
      toggleDropdownOptions();

      // Set category (disabled for edit)
      const catSelect = document.getElementById('custom-field-category');
      catSelect.innerHTML = `<option value="${field.asset_category}">${field.asset_category}</option>`;
      catSelect.disabled = true;

      document.getElementById('custom-field-modal').style.display = 'flex';
    } catch (err) {
      alert('Error loading field: ' + err.message);
    }
  }

  async function saveCustomField() {
    const errorEl = document.getElementById('custom-field-error');
    errorEl.style.display = 'none';

    const editId = document.getElementById('custom-field-edit-id').value;
    const category = document.getElementById('custom-field-category').value;
    const fieldName = document.getElementById('custom-field-name').value.trim();
    const fieldLabel = document.getElementById('custom-field-label').value.trim();
    const fieldType = document.getElementById('custom-field-type').value;
    const dropdownText = document.getElementById('custom-field-dropdown-options').value;
    const displayOrder = parseInt(document.getElementById('custom-field-order').value) || 0;
    const isRequired = document.getElementById('custom-field-required').checked;

    if (!category || !fieldName || !fieldLabel) {
      errorEl.textContent = 'Category, field name, and label are required';
      errorEl.style.display = 'block';
      return;
    }

    const dropdownOptions = fieldType === 'dropdown'
      ? dropdownText.split('\n').map(s => s.trim()).filter(Boolean)
      : null;

    if (fieldType === 'dropdown' && (!dropdownOptions || dropdownOptions.length === 0)) {
      errorEl.textContent = 'Dropdown options are required for dropdown fields';
      errorEl.style.display = 'block';
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) {
        errorEl.textContent = 'No tenant selected';
        errorEl.style.display = 'block';
        return;
      }
      const url = editId
        ? `${API_BASE}/api/cmdb/${tenantCode}/custom-fields/${editId}`
        : `${API_BASE}/api/cmdb/${tenantCode}/custom-fields`;
      const method = editId ? 'PUT' : 'POST';

      const body = {
        asset_category: category,
        field_name: fieldName,
        field_label: fieldLabel,
        field_type: fieldType,
        dropdown_options: dropdownOptions,
        display_order: displayOrder,
        is_required: isRequired
      };

      const res = await fetch(url, {
        method,
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const data = await res.json();

      if (!data.success) {
        errorEl.textContent = data.message;
        errorEl.style.display = 'block';
        return;
      }

      closeCustomFieldModal();
      loadCustomFieldDefinitions();
    } catch (err) {
      errorEl.textContent = 'Error saving field: ' + err.message;
      errorEl.style.display = 'block';
    }
  }

  async function deleteCustomField(id) {
    if (!confirm('Delete this custom field? Existing values will be preserved but hidden.')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) return;
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/custom-fields/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await res.json();
      if (!data.success) {
        alert('Error: ' + data.message);
        return;
      }

      loadCustomFieldDefinitions();
    } catch (err) {
      alert('Error deleting field: ' + err.message);
    }
  }

  function closeCustomFieldModal() {
    document.getElementById('custom-field-modal').style.display = 'none';
  }

  // ============================================================================
  // CUSTOM FIELD VALUES (CMDB Item Detail Tab)
  // ============================================================================

  async function loadCustomFieldValues() {
    if (!currentCMDBId) return;

    const loading = document.getElementById('custom-values-loading');
    const form = document.getElementById('custom-values-form');
    const empty = document.getElementById('custom-values-empty');
    const fieldsContainer = document.getElementById('custom-values-fields');

    loading.style.display = 'block';
    form.style.display = 'none';
    empty.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) {
        loading.style.display = 'none';
        empty.textContent = 'No tenant selected';
        empty.style.display = 'block';
        return;
      }
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${currentCMDBId}/custom-values`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();

      loading.style.display = 'none';

      if (!data.success) {
        empty.textContent = 'Error: ' + data.message;
        empty.style.display = 'block';
        return;
      }

      if (data.fields.length === 0) {
        empty.style.display = 'block';
        return;
      }

      form.style.display = 'block';
      fieldsContainer.innerHTML = '';

      data.fields.forEach(field => {
        const div = document.createElement('div');
        div.className = 'mb-12';
        div.innerHTML = `
          <label class="subtitle">${escapeHtml(field.field_label)}${field.is_required ? ' *' : ''}</label>
          ${renderCustomFieldInput(field)}
        `;
        fieldsContainer.appendChild(div);
      });
    } catch (err) {
      loading.style.display = 'none';
      empty.textContent = 'Error loading custom fields: ' + err.message;
      empty.style.display = 'block';
    }
  }

  function renderCustomFieldInput(field) {
    const id = `custom-value-${field.id}`;
    const value = field.value || '';
    const req = field.is_required ? 'required' : '';

    switch (field.field_type) {
      case 'text':
        return `<input id="${id}" class="input" value="${escapeHtml(value)}" data-field-id="${field.id}" ${req}/>`;
      case 'number':
        return `<input id="${id}" type="number" class="input" value="${escapeHtml(value)}" data-field-id="${field.id}" ${req}/>`;
      case 'date':
        return `<input id="${id}" type="date" class="input" value="${escapeHtml(value)}" data-field-id="${field.id}" ${req}/>`;
      case 'url':
        return `<input id="${id}" type="url" class="input" value="${escapeHtml(value)}" placeholder="https://..." data-field-id="${field.id}" ${req}/>`;
      case 'boolean':
        const checked = value === 'true' || value === '1' ? 'checked' : '';
        return `<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input id="${id}" type="checkbox" data-field-id="${field.id}" ${checked}/><span>Yes</span></label>`;
      case 'dropdown':
        let opts = `<option value="">-- Select --</option>`;
        if (field.dropdown_options) {
          field.dropdown_options.forEach(opt => {
            const sel = opt === value ? 'selected' : '';
            opts += `<option value="${escapeHtml(opt)}" ${sel}>${escapeHtml(opt)}</option>`;
          });
        }
        return `<select id="${id}" class="input" data-field-id="${field.id}" ${req}>${opts}</select>`;
      default:
        return `<input id="${id}" class="input" value="${escapeHtml(value)}" data-field-id="${field.id}"/>`;
    }
  }

  async function saveCustomFieldValues() {
    const fieldsContainer = document.getElementById('custom-values-fields');
    const inputs = fieldsContainer.querySelectorAll('[data-field-id]');
    const values = [];

    inputs.forEach(input => {
      const fieldId = parseInt(input.dataset.fieldId);
      let value;
      if (input.type === 'checkbox') {
        value = input.checked ? 'true' : 'false';
      } else {
        value = input.value;
      }
      values.push({ field_definition_id: fieldId, value });
    });

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) {
        alert('No tenant selected');
        return;
      }
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${currentCMDBId}/custom-values`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ values })
      });

      const data = await res.json();
      const msg = document.getElementById('custom-values-message');

      if (data.success) {
        msg.textContent = 'Saved!';
        msg.style.color = '#16a34a';
        msg.style.display = 'inline';
        setTimeout(() => { msg.style.display = 'none'; }, 3000);
      } else {
        msg.textContent = 'Error: ' + data.message;
        msg.style.color = '#b91c1c';
        msg.style.display = 'inline';
      }
    } catch (err) {
      alert('Error saving: ' + err.message);
    }
  }

  // ============================================================================
  // RELATIONSHIPS (CMDB Item Detail Tab)
  // ============================================================================

  async function loadRelationships() {
    if (!currentCMDBId) return;

    const loading = document.getElementById('relationships-loading');
    const outgoingSection = document.getElementById('relationships-outgoing');
    const incomingSection = document.getElementById('relationships-incoming');
    const empty = document.getElementById('relationships-empty');

    loading.style.display = 'block';
    outgoingSection.style.display = 'none';
    incomingSection.style.display = 'none';
    empty.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) {
        loading.style.display = 'none';
        empty.textContent = 'No tenant selected';
        empty.style.display = 'block';
        return;
      }
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${currentCMDBId}/relationships`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();

      loading.style.display = 'none';

      if (!data.success) {
        empty.textContent = 'Error: ' + data.message;
        empty.style.display = 'block';
        return;
      }

      // Update count badge
      document.getElementById('rel-count').textContent = data.total;

      if (data.total === 0) {
        empty.style.display = 'block';
        return;
      }

      // Render outgoing relationships
      if (data.outgoing.length > 0) {
        outgoingSection.style.display = 'block';
        const tbody = document.getElementById('outgoing-rel-body');
        tbody.innerHTML = '';
        data.outgoing.forEach(rel => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><span class="badge">${escapeHtml(rel.relationship_label)}</span></td>
            <td><a href="#" onclick="viewRelatedCMDBItem('${rel.related_item.cmdb_id}'); return false;">${escapeHtml(rel.related_item.asset_name)}</a></td>
            <td>${escapeHtml(rel.related_item.asset_category)}</td>
            <td><span class="badge ${rel.related_item.status === 'active' ? 'success' : ''}">${rel.related_item.status}</span></td>
            <td><button class="btn danger" onclick="deleteRelationship(${rel.id})">Remove</button></td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById('outgoing-rel-empty').style.display = 'none';
      } else {
        outgoingSection.style.display = 'block';
        document.getElementById('outgoing-rel-body').innerHTML = '';
        document.getElementById('outgoing-rel-empty').style.display = 'block';
      }

      // Render incoming relationships
      if (data.incoming.length > 0) {
        incomingSection.style.display = 'block';
        const tbody = document.getElementById('incoming-rel-body');
        tbody.innerHTML = '';
        data.incoming.forEach(rel => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><span class="badge">${escapeHtml(rel.relationship_label)} (from)</span></td>
            <td><a href="#" onclick="viewRelatedCMDBItem('${rel.related_item.cmdb_id}'); return false;">${escapeHtml(rel.related_item.asset_name)}</a></td>
            <td>${escapeHtml(rel.related_item.asset_category)}</td>
            <td><span class="badge ${rel.related_item.status === 'active' ? 'success' : ''}">${rel.related_item.status}</span></td>
            <td><button class="btn danger" onclick="deleteRelationship(${rel.id})">Remove</button></td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById('incoming-rel-empty').style.display = 'none';
      } else {
        incomingSection.style.display = 'block';
        document.getElementById('incoming-rel-body').innerHTML = '';
        document.getElementById('incoming-rel-empty').style.display = 'block';
      }
    } catch (err) {
      loading.style.display = 'none';
      empty.textContent = 'Error loading relationships: ' + err.message;
      empty.style.display = 'block';
    }
  }

  function viewRelatedCMDBItem(cmdbId) {
    openItem(cmdbId);
  }

  function showAddRelationshipModal() {
    document.getElementById('rel-type').value = 'depends_on';
    document.getElementById('rel-target-search').value = '';
    document.getElementById('rel-target-cmdb-id').value = '';
    document.getElementById('rel-target-results').style.display = 'none';
    document.getElementById('rel-target-selected').style.display = 'none';
    document.getElementById('rel-description').value = '';
    document.getElementById('rel-error').style.display = 'none';
    document.getElementById('add-relationship-modal').style.display = 'flex';
  }

  function closeAddRelationshipModal() {
    document.getElementById('add-relationship-modal').style.display = 'none';
  }

  let relSearchTimeout = null;
  async function searchRelTargetAssets() {
    const query = document.getElementById('rel-target-search').value.trim();
    const resultsDiv = document.getElementById('rel-target-results');

    if (query.length < 2) {
      resultsDiv.style.display = 'none';
      return;
    }

    clearTimeout(relSearchTimeout);
    relSearchTimeout = setTimeout(async () => {
      try {
        const token = localStorage.getItem('token');
        const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
        if (!tenantCode) return;
        const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items?search=${encodeURIComponent(query)}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();

        if (data.success && data.items.length > 0) {
          resultsDiv.innerHTML = '';
          data.items.filter(i => i.cmdb_id !== currentCMDBId).slice(0, 10).forEach(item => {
            const div = document.createElement('div');
            div.style.cssText = 'padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--border)';
            div.innerHTML = `<div style="font-weight:500">${escapeHtml(item.asset_name)}</div><div class="subtitle">${escapeHtml(item.asset_category)} • ${escapeHtml(item.customer_name || '-')}</div>`;
            div.onclick = () => selectRelTarget(item);
            resultsDiv.appendChild(div);
          });
          resultsDiv.style.display = 'block';
        } else {
          resultsDiv.innerHTML = '<div style="padding:12px;color:var(--muted)">No matching assets found</div>';
          resultsDiv.style.display = 'block';
        }
      } catch (err) {
        console.error('Error searching assets:', err);
      }
    }, 300);
  }

  function selectRelTarget(item) {
    document.getElementById('rel-target-cmdb-id').value = item.cmdb_id;
    document.getElementById('rel-target-name').textContent = item.asset_name;
    document.getElementById('rel-target-category').textContent = item.asset_category;
    document.getElementById('rel-target-selected').style.display = 'block';
    document.getElementById('rel-target-results').style.display = 'none';
    document.getElementById('rel-target-search').value = '';
  }

  function clearRelTarget() {
    document.getElementById('rel-target-cmdb-id').value = '';
    document.getElementById('rel-target-selected').style.display = 'none';
  }

  async function saveRelationship() {
    const errorEl = document.getElementById('rel-error');
    errorEl.style.display = 'none';

    const relType = document.getElementById('rel-type').value;
    const targetCmdbId = document.getElementById('rel-target-cmdb-id').value;
    const description = document.getElementById('rel-description').value.trim();

    if (!targetCmdbId) {
      errorEl.textContent = 'Please select a target asset';
      errorEl.style.display = 'block';
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) {
        errorEl.textContent = 'No tenant selected';
        errorEl.style.display = 'block';
        return;
      }
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/relationships`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          source_cmdb_id: currentCMDBId,
          target_cmdb_id: targetCmdbId,
          relationship_type: relType,
          description
        })
      });

      const data = await res.json();

      if (!data.success) {
        errorEl.textContent = data.message;
        errorEl.style.display = 'block';
        return;
      }

      closeAddRelationshipModal();
      loadRelationships();
    } catch (err) {
      errorEl.textContent = 'Error: ' + err.message;
      errorEl.style.display = 'block';
    }
  }

  async function deleteRelationship(id) {
    if (!confirm('Remove this relationship?')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) return;
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/relationships/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await res.json();
      if (!data.success) {
        alert('Error: ' + data.message);
        return;
      }

      loadRelationships();
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  // ============================================================================
  // IMPACT ANALYSIS
  // ============================================================================

  async function showImpactAnalysisModal() {
    if (!currentCMDBId) return;

    document.getElementById('impact-root-name').textContent = document.getElementById('cmdb-name-h').textContent;
    document.getElementById('impact-root-category').textContent = currentCMDBCategory || '';
    document.getElementById('impact-loading').style.display = 'block';
    document.getElementById('impact-results').style.display = 'none';
    document.getElementById('impact-empty').style.display = 'none';
    document.getElementById('impact-analysis-modal').style.display = 'flex';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) {
        document.getElementById('impact-loading').style.display = 'none';
        document.getElementById('impact-empty').textContent = 'No tenant selected';
        document.getElementById('impact-empty').style.display = 'block';
        return;
      }
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${currentCMDBId}/impact-analysis?depth=5`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();

      document.getElementById('impact-loading').style.display = 'none';

      if (!data.success) {
        document.getElementById('impact-empty').textContent = 'Error: ' + data.message;
        document.getElementById('impact-empty').style.display = 'block';
        return;
      }

      if (data.summary.total_impacted === 0) {
        document.getElementById('impact-empty').style.display = 'block';
        return;
      }

      document.getElementById('impact-results').style.display = 'block';
      document.getElementById('impact-total-count').textContent = data.summary.total_impacted;
      document.getElementById('impact-max-depth').textContent = data.summary.by_level.length;

      // Render by category
      const catDiv = document.getElementById('impact-by-category');
      catDiv.innerHTML = data.summary.by_category.map(c =>
        `<span class="badge" style="margin-right:8px">${escapeHtml(c.category)}: ${c.count}</span>`
      ).join('');

      // Render impact tree
      const treeDiv = document.getElementById('impact-tree');
      treeDiv.innerHTML = renderImpactTree(data.impact_tree, 0);
    } catch (err) {
      document.getElementById('impact-loading').style.display = 'none';
      document.getElementById('impact-empty').textContent = 'Error: ' + err.message;
      document.getElementById('impact-empty').style.display = 'block';
    }
  }

  function renderImpactTree(node, level) {
    let html = `<div class="impact-node level-${Math.min(level, 3)}">
      <div style="font-weight:${level === 0 ? '600' : '500'}">${escapeHtml(node.asset_name)}</div>
      <div class="subtitle">${escapeHtml(node.asset_category)} • ${node.status}${node.relationship_type ? ' • ' + node.relationship_type : ''}</div>
    </div>`;

    if (node.children && node.children.length > 0) {
      node.children.forEach(child => {
        html += renderImpactTree(child, level + 1);
      });
    }

    return html;
  }

  function closeImpactAnalysisModal() {
    document.getElementById('impact-analysis-modal').style.display = 'none';
  }

  // ============================================================================
  // HISTORY (CMDB Item Detail Tab)
  // ============================================================================

  async function loadCMDBHistory() {
    if (!currentCMDBId) return;

    const loading = document.getElementById('history-loading');
    const timeline = document.getElementById('history-timeline');
    const empty = document.getElementById('history-empty');
    const pagination = document.getElementById('history-pagination');

    loading.style.display = 'block';
    timeline.style.display = 'none';
    empty.style.display = 'none';
    pagination.style.display = 'none';

    const changeType = document.getElementById('history-type-filter').value;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
      if (!tenantCode) {
        loading.style.display = 'none';
        empty.textContent = 'No tenant selected';
        empty.style.display = 'block';
        return;
      }
      let url = `${API_BASE}/api/cmdb/${tenantCode}/items/${currentCMDBId}/history?limit=${cmdbHistoryLimit}&offset=${cmdbHistoryOffset}`;
      if (changeType) url += `&change_type=${changeType}`;

      const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();

      loading.style.display = 'none';

      if (!data.success) {
        empty.textContent = 'Error: ' + data.message;
        empty.style.display = 'block';
        return;
      }

      if (data.history.length === 0) {
        empty.style.display = 'block';
        return;
      }

      timeline.style.display = 'block';
      timeline.innerHTML = '';

      data.history.forEach(entry => {
        const div = document.createElement('div');
        div.className = `history-item ${entry.change_type}`;
        div.innerHTML = `
          <div class="row space">
            <span class="badge">${escapeHtml(entry.change_type_label)}</span>
            <span class="subtitle">${formatDateTime(entry.created_at)}</span>
          </div>
          <div style="margin-top:8px">
            ${entry.field_name ? `<strong>${escapeHtml(entry.field_name)}</strong>: ` : ''}
            ${entry.old_value ? `<span style="text-decoration:line-through;color:#b91c1c">${escapeHtml(truncate(entry.old_value, 100))}</span> → ` : ''}
            ${entry.new_value ? `<span style="color:#16a34a">${escapeHtml(truncate(entry.new_value, 100))}</span>` : ''}
          </div>
          <div class="subtitle" style="margin-top:4px">by ${escapeHtml(entry.changed_by_name)}${entry.ip_address ? ' from ' + entry.ip_address : ''}</div>
        `;
        timeline.appendChild(div);
      });

      // Pagination
      if (data.pagination.total > cmdbHistoryLimit) {
        pagination.style.display = 'flex';
        document.getElementById('history-page-info').textContent =
          `${cmdbHistoryOffset + 1}-${Math.min(cmdbHistoryOffset + cmdbHistoryLimit, data.pagination.total)} of ${data.pagination.total}`;
        document.getElementById('history-prev-btn').disabled = cmdbHistoryOffset === 0;
        document.getElementById('history-next-btn').disabled = !data.pagination.has_more;
      }
    } catch (err) {
      loading.style.display = 'none';
      empty.textContent = 'Error loading history: ' + err.message;
      empty.style.display = 'block';
    }
  }

  function loadCMDBHistoryPage(direction) {
    cmdbHistoryOffset = Math.max(0, cmdbHistoryOffset + (direction * cmdbHistoryLimit));
    loadCMDBHistory();
  }

  function formatDateTime(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function truncate(str, len) {
    if (!str) return '';
    return str.length > len ? str.substring(0, len) + '...' : str;
  }

  // Helper to escape HTML
  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  // ---- Raise Request ----
  async function loadRaiseFormOptions(){
    const sItem=document.getElementById('rq-item');
    const sCI=document.getElementById('rq-ci');
    if(!sItem||!sCI) return;

    // Show customer field for experts/admins ONLY
    const customerField = document.getElementById('rq-customer-field');
    const currentRole = window.role || role;

    if (currentRole === 'expert' || currentRole === 'admin') {
      customerField.style.display = 'block';
      await loadCustomersForRaiseRequest();
      // Show SLA override field for admin/expert
      document.querySelectorAll('.sla-override-field').forEach(el => el.style.display = 'block');
      await loadSLAOptionsForRaiseRequest();
      // Show assignee dropdown for admin/expert
      const assigneeField = document.getElementById('rq-assignee-field');
      if (assigneeField) {
        assigneeField.style.display = 'block';
        await loadAssigneesForRaiseRequest();
      }
    } else {
      // Customer role - hide the customer selector, SLA override, and assignee completely
      customerField.style.display = 'none';
      document.querySelectorAll('.sla-override-field').forEach(el => el.style.display = 'none');
      const assigneeField = document.getElementById('rq-assignee-field');
      if (assigneeField) assigneeField.style.display = 'none';
    }

    const relevant=CMDB_ITEMS.filter(i => currentRole!=='customer' || !tenant || i.customer===tenant);
    sItem.innerHTML = '<option value=\"\">—</option>' + relevant.map(i => `<option value="${i.cmdb_id}">${i.name}</option>`).join('');
    sCI.innerHTML = '<option value=\"\">—</option>';
    sItem.onchange = () => { const id = sItem.value; const cies = CIS_BY_ITEM[id] || []; sCI.innerHTML = '<option value=\"\">—</option>' + cies.map(ci => `<option value="${ci.ci_id}">${ci.name}</option>`).join(''); };
  }

  async function loadAssigneesForRaiseRequest() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || 'apoyar';
      const res = await fetch(`${API_BASE}/api/experts/${tenantCode}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.success || !data.experts) return;

      const select = document.getElementById('rq-assignee');
      if (!select) return;
      select.innerHTML = '<option value="">— Auto (Ticket Pool) —</option>' +
        data.experts.filter(e => e.is_active !== false).map(e =>
          `<option value="${e.id}">${e.full_name || e.username} (${e.role})</option>`
        ).join('');
    } catch (err) {
      console.error('Error loading assignees:', err);
    }
  }

  async function loadSLAOptionsForRaiseRequest() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || tenant || 'apoyar';
      const res = await fetch(`${API_BASE}/api/sla/${tenantCode}/definitions`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.success || !data.definitions) return;

      const select = document.getElementById('rq-sla');
      if (!select) return;
      select.innerHTML = '<option value="">— Use default SLA —</option>' +
        data.definitions.map(sla => `<option value="${sla.id}">${sla.name}</option>`).join('');
    } catch (err) {
      console.error('Error loading SLA options:', err);
    }
  }
  
  async function loadCustomersForRaiseRequest() {
    try {
      const token = localStorage.getItem('token');
      const res = await fetch(`${API_BASE}/api/auth/customers`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.success) return;
      
      const select = document.getElementById('rq-customer');
      select.innerHTML = '<option value="">— Select Customer —</option>';
      data.customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.full_name || customer.username} (${customer.company || ''})`;
        select.appendChild(option);
      });
    } catch (err) {
      console.error('Error loading customers:', err);
    }
  }
  
  async function loadCMDBForCustomer() {
    const customerId = document.getElementById('rq-customer').value;
    if (!customerId) {
      document.getElementById('rq-item').innerHTML = '<option value="">—</option>';
      return;
    }
    
    try {
      const token = localStorage.getItem('token');
      const res = await fetch(`${API_BASE}/api/cmdb/apoyar/items?customer_id=${customerId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.success) return;
      
      const sItem = document.getElementById('rq-item');
      sItem.innerHTML = '<option value="">—</option>';
      data.items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        sItem.appendChild(option);
      });
    } catch (err) {
      console.error('Error loading CMDB items:', err);
    }
  }
  async function submitRequest(){
    const title=document.getElementById('rq-title').value.trim();
    const desc=document.getElementById('rq-desc').value.trim();
    const priority=document.getElementById('rq-priority').value || 'Normal';
    const itemId=document.getElementById('rq-item').value;
    const ciId=document.getElementById('rq-ci').value;
    const slaId=document.getElementById('rq-sla')?.value;
    if (!title || !desc) { startChat('assist', {title, desc, priority, itemId, ciId}); return; }
    
    // Get customer ID - either from selection (expert/admin) or current user (customer)
    const token = localStorage.getItem('token');
    const currentRole = window.role || role;
    let customerId = null;
    
    if (currentRole === 'expert' || currentRole === 'admin') {
      // For experts/admins, get from dropdown selection
      customerId = document.getElementById('rq-customer').value;
      if (!customerId) {
        alert('Please select a customer');
        return;
      }
    } else if (currentRole === 'customer') {
      // For customers, use the logged-in user's ID automatically
      customerId = window.currentUser?.id;
      if (!customerId) {
        alert('Error: Unable to identify customer. Please log in again.');
        console.error('window.currentUser:', window.currentUser);
        return;
      }
    }
    
    // Create ticket via API
    try {
      const tenantCode = tenant || 'apoyar';
      const res = await fetch(`${API_BASE}/api/tickets/${tenantCode}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          description: desc,
          priority: priority || undefined,
          customer_id: customerId,
          ...(slaId && { sla_definition_id: parseInt(slaId) }),
          ...(itemId && { cmdb_item_id: parseInt(itemId) }),
          ...(ciId && { ci_id: parseInt(ciId) }),
          ...(document.getElementById('rq-assignee')?.value && { assignee_id: parseInt(document.getElementById('rq-assignee').value) })
        })
      });
      
      const data = await res.json();
      if (data.success) {
        alert('Request submitted as ticket #' + data.ticket.id);
        switchView('tickets');
        renderList();
        document.getElementById('rq-title').value='';
        document.getElementById('rq-desc').value='';
        document.getElementById('rq-priority').value='';
        document.getElementById('rq-item').value='';
        document.getElementById('rq-ci').value='';
        if (document.getElementById('rq-sla')) document.getElementById('rq-sla').value='';
      } else {
        // Show detailed validation errors if available
        let errorMessage = data.message || 'Failed to submit request';
        if (data.errors && data.errors.length > 0) {
          errorMessage += ':\n' + data.errors.map(e => `- ${e.field}: ${e.message}`).join('\n');
        }
        alert(errorMessage);
      }
    } catch (err) {
      console.error('Error submitting request:', err);
      alert('Error submitting request: ' + err.message);
    }
  }

  // ============================================================================
  // GLOBAL SEARCH (Command Palette)
  // ============================================================================

  let globalSearchResults = [];
  let globalSearchSelectedIndex = -1;
  let globalSearchCategory = 'all';
  let globalSearchDebounceTimer = null;

  // Keyboard shortcut: Cmd+K / Ctrl+K to open search, Escape to close
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openGlobalSearch();
    }
    // Close global search on Escape
    if (e.key === 'Escape') {
      const modal = document.getElementById('global-search-modal');
      if (modal && modal.classList.contains('active')) {
        e.preventDefault();
        closeGlobalSearch();
      }
    }
  });

  async function openGlobalSearch() {
    // Role check - only Admin and Expert can use global search
    const userRole = localStorage.getItem('role') || role;
    if (userRole === 'Customer' || userRole === 'Master Admin') {
      alert('Global search is only available for Admin and Expert users.');
      return;
    }

    const modal = document.getElementById('global-search-modal');
    modal.classList.add('active');

    // Reset state
    globalSearchResults = [];
    globalSearchSelectedIndex = -1;
    globalSearchCategory = 'all';

    // Reset UI
    const input = document.getElementById('global-search-input');
    input.value = '';
    input.focus();

    // Reset tabs
    document.querySelectorAll('.global-search-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.category === 'all');
    });

    // Show loading state while data loads
    document.getElementById('global-search-results').innerHTML = `
      <div class="global-search-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
        <div>Loading data...</div>
      </div>
    `;

    // Ensure all data sources are loaded
    await ensureGlobalSearchDataLoaded();

    // Show ready state
    document.getElementById('global-search-results').innerHTML = `
      <div class="global-search-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
        <div>Start typing to search...</div>
      </div>
    `;
  }

  async function ensureGlobalSearchDataLoaded() {
    const token = localStorage.getItem('token');
    const tenantCode = window.tenant || localStorage.getItem('tenantCode') || 'apoyar';
    if (!token) return;

    const loadPromises = [];

    // Load CMDB items if empty
    if (CMDB_ITEMS.length === 0 && !cmdbItemsLoaded) {
      loadPromises.push(
        fetch(`${API_BASE}/api/cmdb/${tenantCode}/items`, {
          headers: { 'Authorization': `Bearer ${token}` }
        }).then(res => res.json()).then(data => {
          if (data.success && data.items) {
            CMDB_ITEMS = data.items.map(item => ({
              cmdb_id: item.cmdb_id,
              asset_name: item.asset_name,
              name: item.asset_name,
              customer_name: item.customer_name || '',
              customer: item.customer_name || '',
              asset_category: item.asset_category,
              brand_name: item.brand_name,
              model_name: item.model_name,
              asset_location: item.asset_location,
              status: item.status,
              ci_count: item.ci_count || 0,
              comment: item.comment || ''
            }));
            cmdbItemsLoaded = true;
          }
        }).catch(err => console.error('Error loading CMDB for search:', err))
      );
    }

    // Load customers if empty
    if (allCustomers.length === 0) {
      loadPromises.push(
        fetch(`${API_BASE}/api/customers`, {
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        }).then(res => res.json()).then(data => {
          if (data.success && data.customers) {
            allCustomers = data.customers;
            customers = data.customers.map(c => ({
              id: c.id,
              name: c.full_name || c.username,
              contact: c.email,
              company: c.company_name || c.full_name || c.username
            }));
          }
        }).catch(err => console.error('Error loading customers for search:', err))
      );
    }

    // Load SLA definitions if empty
    if (slaDefinitions.length === 0) {
      loadPromises.push(
        fetch(`${API_BASE}/api/sla/${tenantCode}/definitions`, {
          headers: { 'Authorization': 'Bearer ' + token }
        }).then(res => res.json()).then(data => {
          if (data.definitions) {
            slaDefinitions = data.definitions;
          }
        }).catch(err => console.error('Error loading SLA definitions for search:', err))
      );
    }

    // Wait for all data to load
    await Promise.all(loadPromises);
  }

  function closeGlobalSearch() {
    document.getElementById('global-search-modal').classList.remove('active');
  }

  function setSearchCategory(category) {
    globalSearchCategory = category;

    // Update tab UI
    document.querySelectorAll('.global-search-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.category === category);
    });

    // Re-run search with new filter
    const query = document.getElementById('global-search-input').value.trim();
    if (query) {
      performGlobalSearch(query);
    }
  }

  function onGlobalSearchInput(e) {
    const query = e.target.value.trim();

    // Clear existing debounce timer
    if (globalSearchDebounceTimer) {
      clearTimeout(globalSearchDebounceTimer);
    }

    if (!query) {
      // Show empty state
      document.getElementById('global-search-results').innerHTML = `
        <div class="global-search-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
          </svg>
          <div>Start typing to search...</div>
        </div>
      `;
      globalSearchResults = [];
      globalSearchSelectedIndex = -1;
      return;
    }

    // Debounce search by 200ms
    globalSearchDebounceTimer = setTimeout(() => {
      performGlobalSearch(query);
    }, 200);
  }

  async function performGlobalSearch(query) {
    const q = query.toLowerCase();
    const results = [];
    const maxPerCategory = 10;

    // Search Tickets
    if (globalSearchCategory === 'all' || globalSearchCategory === 'tickets') {
      let ticketResults = (tickets || [])
        .filter(t => {
          const searchable = [
            String(t.id || ''),
            t.title || '',
            t.description || '',
            t.customer_name || '',
            t.company || ''
          ].join(' ').toLowerCase();
          return searchable.includes(q);
        })
        .slice(0, maxPerCategory)
        .map(t => ({
          type: 'ticket',
          id: t.id,
          title: `#${t.id} - ${t.title || 'Untitled'}`,
          meta: t.customer_name || t.company || 'No customer',
          badge: t.status || 'Open',
          data: t
        }));

      // Fallback: if no local ticket results, search server-side
      if (ticketResults.length === 0 && q.length >= 1) {
        try {
          const token = localStorage.getItem('token');
          const resp = await fetch(`/api/tickets/${tenant}/power-search?q=${encodeURIComponent(query)}&limit=${maxPerCategory}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (resp.ok) {
            const data = await resp.json();
            ticketResults = (data.tickets || []).map(t => ({
              type: 'ticket',
              id: t.id,
              title: `#${t.id} - ${t.title || 'Untitled'}`,
              meta: t.assignee_name || 'Unassigned',
              badge: t.status || 'Open',
              data: t
            }));
          }
        } catch (e) { /* ignore server search failure */ }
      }
      results.push(...ticketResults);
    }

    // Search CMDB Items
    if (globalSearchCategory === 'all' || globalSearchCategory === 'cmdb') {
      const cmdbResults = (CMDB_ITEMS || [])
        .filter(c => {
          const searchable = [
            String(c.cmdb_id || ''),
            c.asset_name || c.name || '',
            c.asset_category || '',
            c.customer_name || '',
            c.brand_name || '',
            c.model_name || '',
            c.asset_location || ''
          ].join(' ').toLowerCase();
          return searchable.includes(q);
        })
        .slice(0, maxPerCategory)
        .map(c => ({
          type: 'cmdb',
          id: c.cmdb_id,
          title: c.asset_name || c.name || 'Unnamed Asset',
          meta: [c.asset_category, c.customer_name, c.brand_name].filter(Boolean).join(' | '),
          badge: c.status || 'Active',
          data: c
        }));
      results.push(...cmdbResults);
    }

    // Search Customers (use allCustomers which has full data)
    if (globalSearchCategory === 'all' || globalSearchCategory === 'customers') {
      const customerResults = (allCustomers || [])
        .filter(c => {
          const searchable = [
            c.full_name || '',
            c.username || '',
            c.email || '',
            c.company_name || ''
          ].join(' ').toLowerCase();
          return searchable.includes(q);
        })
        .slice(0, maxPerCategory)
        .map(c => ({
          type: 'customer',
          id: c.id,
          title: c.full_name || c.username || 'Unknown',
          meta: [c.company_name, c.email].filter(Boolean).join(' | '),
          badge: c.company_name || 'Customer',
          data: c
        }));
      results.push(...customerResults);
    }

    // Search SLA Definitions
    if (globalSearchCategory === 'all' || globalSearchCategory === 'sla') {
      const slaResults = (slaDefinitions || [])
        .filter(s => {
          const searchable = [
            s.name || '',
            s.description || '',
            s.priority || ''
          ].join(' ').toLowerCase();
          return searchable.includes(q);
        })
        .slice(0, maxPerCategory)
        .map(s => ({
          type: 'sla',
          id: s.id,
          title: s.name || 'Unnamed SLA',
          meta: s.description || `Priority: ${s.priority || 'Any'}`,
          badge: s.priority || 'SLA',
          data: s
        }));
      results.push(...slaResults);
    }

    globalSearchResults = results;
    globalSearchSelectedIndex = results.length > 0 ? 0 : -1;
    renderGlobalSearchResults();
  }

  function renderGlobalSearchResults() {
    const container = document.getElementById('global-search-results');

    if (globalSearchResults.length === 0) {
      container.innerHTML = `
        <div class="global-search-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
          </svg>
          <div>No results found</div>
        </div>
      `;
      return;
    }

    // Group results by type
    const groups = {};
    globalSearchResults.forEach((result, idx) => {
      if (!groups[result.type]) {
        groups[result.type] = [];
      }
      groups[result.type].push({ ...result, globalIndex: idx });
    });

    const typeLabels = {
      ticket: 'Tickets',
      cmdb: 'CMDB Items',
      customer: 'Customers',
      sla: 'SLA Definitions'
    };

    const typeIcons = {
      ticket: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
      cmdb: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
      customer: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
      sla: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>'
    };

    let html = '';
    const typeOrder = ['ticket', 'cmdb', 'customer', 'sla'];

    typeOrder.forEach(type => {
      if (!groups[type]) return;

      html += `<div class="global-search-group">`;
      html += `<div class="global-search-group-title">${typeLabels[type]} (${groups[type].length})</div>`;

      groups[type].forEach(item => {
        const isSelected = item.globalIndex === globalSearchSelectedIndex;
        html += `
          <div class="global-search-item ${isSelected ? 'selected' : ''}"
               onclick="selectGlobalSearchResult(${item.globalIndex})"
               onmouseover="globalSearchSelectedIndex=${item.globalIndex};updateGlobalSearchSelection()">
            <div class="global-search-item-icon ${item.type}">${typeIcons[item.type]}</div>
            <div class="global-search-item-content">
              <div class="global-search-item-title">${escapeHtml(item.title)}</div>
              <div class="global-search-item-meta">${escapeHtml(item.meta)}</div>
            </div>
            <div class="global-search-item-badge">${escapeHtml(item.badge)}</div>
          </div>
        `;
      });

      html += `</div>`;
    });

    container.innerHTML = html;
  }

  function updateGlobalSearchSelection() {
    document.querySelectorAll('.global-search-item').forEach((item, idx) => {
      item.classList.toggle('selected', idx === globalSearchSelectedIndex);
    });

    // Scroll selected item into view
    const selectedItem = document.querySelector('.global-search-item.selected');
    if (selectedItem) {
      selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
  }

  function handleGlobalSearchKeydown(e) {
    const resultsCount = globalSearchResults.length;

    switch (e.key) {
      case 'Escape':
        e.preventDefault();
        closeGlobalSearch();
        break;

      case 'ArrowDown':
        e.preventDefault();
        if (resultsCount > 0) {
          globalSearchSelectedIndex = (globalSearchSelectedIndex + 1) % resultsCount;
          updateGlobalSearchSelection();
        }
        break;

      case 'ArrowUp':
        e.preventDefault();
        if (resultsCount > 0) {
          globalSearchSelectedIndex = globalSearchSelectedIndex <= 0
            ? resultsCount - 1
            : globalSearchSelectedIndex - 1;
          updateGlobalSearchSelection();
        }
        break;

      case 'Enter':
        e.preventDefault();
        if (globalSearchSelectedIndex >= 0 && globalSearchSelectedIndex < resultsCount) {
          selectGlobalSearchResult(globalSearchSelectedIndex);
        }
        break;

      case 'Tab':
        e.preventDefault();
        // Cycle through categories
        const categories = ['all', 'tickets', 'cmdb', 'customers', 'sla'];
        const currentIdx = categories.indexOf(globalSearchCategory);
        const nextIdx = e.shiftKey
          ? (currentIdx - 1 + categories.length) % categories.length
          : (currentIdx + 1) % categories.length;
        setSearchCategory(categories[nextIdx]);
        break;
    }
  }

  function selectGlobalSearchResult(idx) {
    const result = globalSearchResults[idx];
    if (!result) return;

    closeGlobalSearch();

    switch (result.type) {
      case 'ticket':
        if (typeof openTicket === 'function') {
          openTicket(result.id);
        }
        break;

      case 'cmdb':
        if (typeof openItem === 'function') {
          openItem(result.id);
        }
        break;

      case 'customer':
        if (typeof viewCustomerTickets === 'function') {
          viewCustomerTickets(result.id, result.data.full_name || result.data.username);
        }
        break;

      case 'sla':
        // Navigate to wizard section and open SLA modal
        navTo('wizard');
        setTimeout(() => {
          if (typeof openSLADefinitionModal === 'function') {
            openSLADefinitionModal(result.id);
          }
        }, 300);
        break;
    }
  }

  // Helper function to escape HTML (if not already defined)
  if (typeof escapeHtml !== 'function') {
    window.escapeHtml = function(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    };
  }

  // ---- Live Chat System ----
  let chatSocket = null;
  let chatSessionId = null;
  let chatState = 'idle'; // idle, qualifying, queued, active, rating, closed
  let chatTypingTimer = null;
  let chatUnreadCount = 0;

  const chatToggle = document.getElementById('chat-toggle');
  const chatEl = document.getElementById('chat');

  function liveChatToggle() {
    if (chatEl.style.display === 'flex') {
      chatEl.style.display = 'none';
    } else {
      chatEl.style.display = 'flex';
      chatUnreadCount = 0;
      const badge = document.getElementById('chat-unread-badge');
      if (badge) badge.style.display = 'none';
      if (chatState === 'active') {
        const inp = document.getElementById('chat-msg-input');
        if (inp) inp.focus();
      }
    }
  }
  chatToggle.onclick = liveChatToggle;
  document.addEventListener('keydown', (e) => { if (e.key === 'F7') chatToggle.click(); });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (document.getElementById('sla-definition-modal').style.display === 'flex') closeSLADefinitionModal();
      else if (document.getElementById('business-hours-modal').style.display === 'flex') closeBusinessHoursModal();
    }
  });

  function initChatSocket() {
    if (chatSocket && chatSocket.connected) return;
    const token = localStorage.getItem('token');
    if (!token) return;
    chatSocket = io({ auth: { token }, transports: ['websocket', 'polling'] });

    chatSocket.on('connect', () => {
      console.log('[Chat] Socket connected');
      const status = document.getElementById('chat-header-status');
      if (status && status.textContent.includes('Connecting')) status.textContent = '';
    });
    chatSocket.on('connect_error', (err) => {
      console.warn('[Chat] Socket error:', err.message);
      const status = document.getElementById('chat-header-status');
      if (status) status.textContent = 'Connecting...';
    });

    chatSocket.on('chat:message', (msg) => {
      if (msg.sessionId === chatSessionId) {
        appendChatMessage(msg);
        if (chatEl.style.display !== 'flex') {
          chatUnreadCount++;
          const badge = document.getElementById('chat-unread-badge');
          if (badge) { badge.textContent = chatUnreadCount; badge.style.display = 'flex'; }
        }
      }
      // Also update expert chat if open
      if (typeof echActiveSessionId !== 'undefined' && msg.sessionId === echActiveSessionId) {
        appendExpertChatMessage(msg);
      }
    });

    chatSocket.on('chat:expert_joined', (data) => {
      if (data.sessionId === chatSessionId) {
        liveChatShowScreen('active');
        document.getElementById('chat-header-status').textContent = data.expertName + ' joined';
        document.getElementById('chat-end-btn').style.display = '';
      }
    });

    chatSocket.on('chat:queue_update', (data) => {
      if (data.sessionId === chatSessionId) {
        const el = document.getElementById('chat-queue-pos');
        if (el) el.textContent = data.queuePosition;
      }
    });

    chatSocket.on('chat:typing', (data) => {
      if (data.sessionId === chatSessionId && data.userId !== (window.currentUser&&window.currentUser.id)) {
        const el = document.getElementById('chat-typing');
        if (el) el.textContent = data.username + ' is typing...';
        clearTimeout(chatTypingTimer);
        chatTypingTimer = setTimeout(() => { if (el) el.textContent = ''; }, 3000);
      }
      if (typeof echActiveSessionId !== 'undefined' && data.sessionId === echActiveSessionId) {
        const el = document.getElementById('ech-typing');
        if (el) el.textContent = data.username + ' is typing...';
        clearTimeout(chatTypingTimer);
        chatTypingTimer = setTimeout(() => { if (el) el.textContent = ''; }, 3000);
      }
    });

    chatSocket.on('chat:read', (data) => {
      // Could update read receipts UI if desired
    });

    chatSocket.on('chat:closed', (data) => {
      if (data.sessionId === chatSessionId) {
        chatState = 'rating';
        liveChatShowScreen('rating');
        document.getElementById('chat-header-status').textContent = 'Ended';
        document.getElementById('chat-end-btn').style.display = 'none';
      }
      if (typeof echActiveSessionId !== 'undefined' && data.sessionId === echActiveSessionId) {
        refreshExpertChatList();
      }
    });

    chatSocket.on('chat:transferred', (data) => {
      if (data.sessionId === chatSessionId) {
        document.getElementById('chat-header-status').textContent = 'Transferred to ' + data.toExpertName;
      }
    });

    // Expert events
    chatSocket.on('chat:new_request', () => { refreshExpertChatList(); });
    chatSocket.on('chat:request_claimed', () => { refreshExpertChatList(); });
    chatSocket.on('chat:auto_assigned', (data) => {
      chatSocket.emit('chat:join', { sessionId: data.sessionId });
      refreshExpertChatList();
    });
    chatSocket.on('chat:transfer_incoming', (data) => {
      chatSocket.emit('chat:join', { sessionId: data.sessionId });
      refreshExpertChatList();
    });
    chatSocket.on('chat:direct_message', () => { /* could show notification */ });
    chatSocket.on('presence_update', (data) => {
      const el = document.getElementById('chat-experts-online');
      if (el) el.textContent = (data.onlineExperts?.length || 0) + ' expert(s) online';
      const echCount = document.getElementById('ech-waiting-count');
      if (echCount) updateExpertWaitingCount();
    });
  }

  function liveChatShowScreen(screen) {
    ['chat-start', 'chat-qualify-screen', 'chat-queue-screen', 'chat-active-screen', 'chat-rating-screen'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    const map = { idle: 'chat-start', qualifying: 'chat-qualify-screen', queued: 'chat-queue-screen', active: 'chat-active-screen', rating: 'chat-rating-screen' };
    const el = document.getElementById(map[screen] || map.idle);
    if (el) el.style.display = 'flex';
    chatState = screen;
  }

  async function liveChatStart() {
    const desc = (document.getElementById('chat-start-desc')?.value || '').trim();
    if (!desc) { document.getElementById('chat-start-desc').focus(); return; }

    const chatTenant = window.tenant || localStorage.getItem('tenantCode') || 'apoyar';
    initChatSocket();

    // Show qualification questions
    try {
      const resp = await fetch(`/api/chat/${chatTenant}/qualification/questions`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ problemDescription: desc })
      });
      const data = await resp.json();
      if (data.success && data.questions?.length > 0) {
        renderQualificationQuestions(data.questions);
        liveChatShowScreen('qualifying');
        return;
      }
    } catch (e) { console.warn('[Chat] Qualification error:', e); }

    // Fallback: skip qualification
    liveChatStartSession(desc);
  }

  function renderQualificationQuestions(questions) {
    const container = document.getElementById('chat-qualify-questions');
    if (!container) return;
    container.innerHTML = '';
    questions.forEach(q => {
      const div = document.createElement('div');
      div.className = 'q-item';
      let inputHtml = '';
      if (q.type === 'select') {
        inputHtml = `<select id="qq-${q.id}" class="input" style="font-size:13px;padding:6px"><option value="">-- Select --</option>${q.options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
      } else if (q.type === 'asset_search') {
        inputHtml = `<input id="qq-${q.id}" class="input" style="font-size:13px;padding:6px" placeholder="${q.hint || 'Search...'}" oninput="searchQualAssets(this.value)"><div id="qq-asset-results" style="font-size:12px;margin-top:4px"></div>`;
      } else {
        inputHtml = `<input id="qq-${q.id}" class="input" style="font-size:13px;padding:6px" placeholder="Type here...">`;
      }
      div.innerHTML = `<div class="q-label">${q.question}</div>${inputHtml}`;
      container.appendChild(div);
    });
  }

  let qualAssetSelected = null;
  async function searchQualAssets(q) {
    if (q.length < 2) { document.getElementById('qq-asset-results').innerHTML = ''; return; }
    try {
      const resp = await fetch(`/api/chat/${window.tenant || 'apoyar'}/qualification/search-assets?q=${encodeURIComponent(q)}`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await resp.json();
      const container = document.getElementById('qq-asset-results');
      if (data.items?.length > 0) {
        container.innerHTML = data.items.map(it => `<div style="padding:4px 6px;cursor:pointer;border-radius:4px;hover:var(--table-header)" onclick="selectQualAsset(${it.id},'${(it.asset_name||'').replace(/'/g,'\\\'')}')">${it.asset_name} (${it.asset_category||''})</div>`).join('');
      } else {
        container.innerHTML = '<div style="color:var(--muted);padding:4px">No assets found</div>';
      }
    } catch (e) { /* ignore */ }
  }

  function selectQualAsset(id, name) {
    qualAssetSelected = { id, name };
    const inp = document.getElementById('qq-asset');
    if (inp) inp.value = name;
    document.getElementById('qq-asset-results').innerHTML = `<div style="color:green">Selected: ${name}</div>`;
  }

  async function liveChatSubmitQualification() {
    const desc = (document.getElementById('chat-start-desc')?.value || '').trim();
    const answers = {};
    ['category', 'priority', 'details'].forEach(id => {
      const el = document.getElementById('qq-' + id);
      if (el) answers[id] = el.value || 'skip';
    });
    answers.asset = qualAssetSelected || 'skip';

    try {
      const resp = await fetch(`/api/chat/${window.tenant || 'apoyar'}/qualification/process`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers, problemDescription: desc })
      });
      const data = await resp.json();
      window._chatQualData = data;
    } catch (e) { console.warn('[Chat] Qualification process error:', e); }

    liveChatStartSession(desc);
  }

  function liveChatSkipQualification() {
    const desc = (document.getElementById('chat-start-desc')?.value || '').trim();
    window._chatQualData = { skippedCount: 4, penaltyMinutes: 240 };
    liveChatStartSession(desc);
  }

  function liveChatStartSession(desc) {
    if (!chatSocket || !chatSocket.connected) {
      initChatSocket();
      // Wait for connection before emitting
      if (!chatSocket) {
        document.getElementById('chat-header-status').textContent = 'Connection failed';
        liveChatShowScreen('idle');
        return;
      }
    }
    // If socket is connecting, wait up to 5s then emit
    const doEmit = () => {
      chatSocket.emit('chat:start', { problemDescription: desc }, (resp) => {
        if (resp && resp.success) {
          chatSessionId = resp.sessionId;
          document.getElementById('chat-queue-pos').textContent = resp.queuePosition;
          liveChatShowScreen('queued');
          document.getElementById('chat-header-status').textContent = 'In queue #' + resp.queuePosition;
        } else {
          console.error('[Chat] Failed to start session:', resp && resp.error);
          document.getElementById('chat-header-status').textContent = 'Could not start chat — please try again';
          liveChatShowScreen('idle');
        }
      });
    };
    if (chatSocket.connected) {
      doEmit();
    } else {
      // Socket still connecting — wait for it
      const timeout = setTimeout(() => {
        chatSocket.off('connect', onConnect);
        document.getElementById('chat-header-status').textContent = 'Connection timed out — please try again';
        liveChatShowScreen('idle');
      }, 5000);
      const onConnect = () => { clearTimeout(timeout); doEmit(); };
      chatSocket.once('connect', onConnect);
    }
  }

  function liveChatSend() {
    const inp = document.getElementById('chat-msg-input');
    const text = (inp?.value || '').trim();
    if (!text || !chatSessionId) return;
    inp.value = '';
    chatSocket.emit('chat:message', { sessionId: chatSessionId, content: text }, (resp) => {
      if (!resp.success) console.warn('[Chat] Send failed');
    });
    // Typing stop
    chatSocket.emit('chat:typing', { sessionId: chatSessionId });
  }

  function appendChatMessage(msg) {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    const div = document.createElement('div');
    if (msg.senderRole === 'system') {
      div.className = 'chat-msg system';
      div.textContent = msg.content;
    } else {
      const isMe = msg.senderUserId == (window.currentUser&&window.currentUser.id);
      div.className = 'chat-msg ' + (isMe ? 'outgoing' : 'incoming');
      let html = '';
      if (!isMe) html += `<div class="msg-sender">${msg.senderName || msg.senderRole}</div>`;
      if (msg.messageType === 'file' && msg.fileUrl) {
        html += `<a class="msg-file" href="${msg.fileUrl}" target="_blank">📄 ${msg.fileName || 'File'}</a>`;
      } else {
        html += `<div>${(msg.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>`;
      }
      html += `<div class="msg-time">${new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
      div.innerHTML = html;
    }
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  // Typing indicator for customer chat
  (function() {
    let lastTyping = 0;
    const inp = document.getElementById('chat-msg-input');
    if (inp) inp.addEventListener('input', () => {
      if (chatSocket && chatSessionId && Date.now() - lastTyping > 2000) {
        chatSocket.emit('chat:typing', { sessionId: chatSessionId });
        lastTyping = Date.now();
      }
    });
  })();

  async function liveChatUploadFile(input) {
    if (!input.files?.length || !chatSessionId) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    try {
      const resp = await fetch(`/api/chat/${window.tenant || 'apoyar'}/sessions/${chatSessionId}/upload`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        body: formData
      });
      const data = await resp.json();
      if (data.success) {
        chatSocket.emit('chat:message', {
          sessionId: chatSessionId, content: data.message.fileName, messageType: 'file',
          fileUrl: data.message.fileUrl, fileName: data.message.fileName, fileSize: data.message.fileSize
        });
      }
    } catch (e) { console.warn('[Chat] Upload error:', e); }
    input.value = '';
  }

  function liveChatEnd() {
    if (!chatSocket || !chatSessionId) return;
    chatSocket.emit('chat:close', { sessionId: chatSessionId });
  }

  function liveChatRate(stars) {
    if (!chatSocket || !chatSessionId) return;
    const starEls = document.getElementById('chat-stars')?.children;
    if (starEls) for (let i = 0; i < 5; i++) starEls[i].textContent = i < stars ? '★' : '☆';
    chatSocket.emit('chat:rate', { sessionId: chatSessionId, rating: stars }, () => {
      setTimeout(liveChatClose, 1000);
    });
  }

  function liveChatClose() {
    chatSessionId = null;
    chatState = 'idle';
    liveChatShowScreen('idle');
    document.getElementById('chat-header-status').textContent = '';
    document.getElementById('chat-end-btn').style.display = 'none';
    document.getElementById('chat-messages').innerHTML = '';
    document.getElementById('chat-start-desc').value = '';
    chatEl.style.display = 'none';
    qualAssetSelected = null;
    window._chatQualData = null;
  }

  // ---- Expert Chat Functions ----
  let echActiveSessionId = null;
  let echTab = 'waiting';
  let echCannedResponses = [];

  function switchExpertChatTab(tab) {
    echTab = tab;
    ['waiting', 'active', 'history'].forEach(t => {
      const btn = document.getElementById('ech-tab-' + t);
      if (btn) btn.style.borderBottom = t === tab ? '2px solid var(--primary)' : 'none';
    });
    refreshExpertChatList();
  }

  async function refreshExpertChatList() {
    const list = document.getElementById('ech-list');
    if (!list) return;
    try {
      let status = echTab === 'waiting' ? 'waiting' : (echTab === 'active' ? 'active' : 'closed');
      const resp = await fetch(`/api/chat/${tenant}/sessions?status=${status}&limit=20`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await resp.json();
      if (!data.success || !data.sessions?.length) {
        list.innerHTML = '<div class="ech-empty">No ' + echTab + ' chats</div>';
        return;
      }
      list.innerHTML = data.sessions.map(s => {
        const name = s.customer_name || 'Customer #' + s.customer_user_id;
        const preview = (s.last_message || '').substring(0, 40);
        const isActive = s.id === echActiveSessionId;
        return `<div class="ech-item${isActive ? ' active' : ''}" onclick="expertChatOpen(${s.id})">
          <div><div class="ech-name">${name}</div><div class="ech-preview">${preview || 'No messages'}</div></div>
          ${echTab === 'waiting' ? '<button class="btn primary" onclick="event.stopPropagation();expertChatClaim(' + s.id + ')" style="padding:4px 10px;font-size:11px">Claim</button>' : ''}
          ${s.unread_count > 0 ? '<span class="ech-badge">' + s.unread_count + '</span>' : ''}
        </div>`;
      }).join('');

      updateExpertWaitingCount();
    } catch (e) { console.warn('[Chat] Expert list error:', e); }
  }

  async function updateExpertWaitingCount() {
    try {
      const resp = await fetch(`/api/chat/${tenant}/queue`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await resp.json();
      const badge = document.getElementById('ech-waiting-count');
      if (badge && data.success) {
        const cnt = data.queue?.length || 0;
        badge.textContent = cnt;
        badge.style.display = cnt > 0 ? '' : 'none';
      }
    } catch (e) { /* ignore */ }
  }

  function expertChatClaim(sessionId) {
    if (!chatSocket) initChatSocket();
    chatSocket.emit('chat:claim', { sessionId }, (resp) => {
      if (resp.success) {
        chatSocket.emit('chat:join', { sessionId });
        echActiveSessionId = sessionId;
        switchExpertChatTab('active');
        expertChatOpen(sessionId);
      }
    });
  }

  async function expertChatOpen(sessionId) {
    echActiveSessionId = sessionId;
    document.getElementById('ech-window').style.display = 'flex';

    // Join socket room
    if (chatSocket) chatSocket.emit('chat:join', { sessionId });

    // Load session detail
    try {
      const resp = await fetch(`/api/chat/${tenant}/sessions/${sessionId}`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await resp.json();
      if (data.success) {
        document.getElementById('ech-window-name').textContent = data.session.customer_name || 'Customer';
        document.getElementById('ech-window-status').textContent = data.session.status;
        const container = document.getElementById('ech-messages');
        container.innerHTML = '';
        (data.messages || []).forEach(m => appendExpertChatMessage(m));

        // Mark as read
        if (chatSocket) chatSocket.emit('chat:read', { sessionId });
      }
    } catch (e) { console.warn('[Chat] Open session error:', e); }

    // Load canned responses
    loadCannedResponses();
    refreshExpertChatList();
  }

  function appendExpertChatMessage(msg) {
    const container = document.getElementById('ech-messages');
    if (!container) return;
    const div = document.createElement('div');
    if (msg.sender_role === 'system' || msg.senderRole === 'system') {
      div.className = 'chat-msg system';
      div.textContent = msg.content;
    } else {
      const role = msg.sender_role || msg.senderRole;
      const isCustomer = role === 'customer';
      div.className = 'chat-msg ' + (isCustomer ? 'incoming' : 'outgoing');
      let html = `<div class="msg-sender">${msg.sender_name || msg.senderName || role}</div>`;
      if ((msg.message_type || msg.messageType) === 'file' && (msg.file_url || msg.fileUrl)) {
        html += `<a class="msg-file" href="${msg.file_url || msg.fileUrl}" target="_blank">📄 ${msg.file_name || msg.fileName || 'File'}</a>`;
      } else {
        html += `<div>${((msg.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;'))}</div>`;
      }
      const time = msg.created_at || msg.createdAt;
      if (time) html += `<div class="msg-time">${new Date(time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
      div.innerHTML = html;
    }
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  async function loadCannedResponses() {
    try {
      const resp = await fetch(`/api/chat/${tenant}/canned-responses`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await resp.json();
      echCannedResponses = data.responses || [];
      const container = document.getElementById('ech-canned');
      if (container) {
        container.innerHTML = echCannedResponses.map(cr =>
          `<button class="canned-resp-btn" onclick="expertChatUseCanned(${cr.id})">${cr.label}</button>`
        ).join('');
      }
    } catch (e) { /* ignore */ }
  }

  function expertChatUseCanned(id) {
    const cr = echCannedResponses.find(c => c.id === id);
    if (!cr || !echActiveSessionId) return;
    chatSocket.emit('chat:message', { sessionId: echActiveSessionId, content: cr.message });
  }

  function expertChatSend() {
    const inp = document.getElementById('ech-msg-input');
    const text = (inp?.value || '').trim();
    if (!text || !echActiveSessionId) return;
    inp.value = '';
    chatSocket.emit('chat:message', { sessionId: echActiveSessionId, content: text });
  }

  async function expertChatUploadFile(input) {
    if (!input.files?.length || !echActiveSessionId) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    try {
      const resp = await fetch(`/api/chat/${tenant}/sessions/${echActiveSessionId}/upload`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        body: formData
      });
      const data = await resp.json();
      if (data.success) {
        chatSocket.emit('chat:message', {
          sessionId: echActiveSessionId, content: data.message.fileName, messageType: 'file',
          fileUrl: data.message.fileUrl, fileName: data.message.fileName, fileSize: data.message.fileSize
        });
      }
    } catch (e) { console.warn('[Chat] Upload error:', e); }
    input.value = '';
  }

  function expertChatClose() {
    if (!chatSocket || !echActiveSessionId) return;
    chatSocket.emit('chat:close', { sessionId: echActiveSessionId }, () => {
      document.getElementById('ech-window').style.display = 'none';
      echActiveSessionId = null;
      refreshExpertChatList();
    });
  }

  async function expertChatCreateTicket() {
    if (!echActiveSessionId) return;
    const title = prompt('Ticket title:');
    if (!title) return;
    try {
      const resp = await fetch(`/api/chat/${tenant}/sessions/${echActiveSessionId}/create-ticket`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, description: 'Created from live chat session #' + echActiveSessionId, priority: 'medium' })
      });
      const data = await resp.json();
      if (data.success) {
        showToast('Ticket #' + data.ticketId + ' created', 'success');
      }
    } catch (e) { console.warn('[Chat] Create ticket error:', e); }
  }

  async function expertChatTransfer() {
    if (!echActiveSessionId) return;
    // Get online experts
    try {
      const resp = await fetch(`/api/chat/${tenant}/online-experts`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await resp.json();
      const experts = (data.experts || []).filter(e => e.userId != (window.currentUser&&window.currentUser.id));
      if (experts.length === 0) { showToast('No other experts online', 'warn'); return; }
      const name = prompt('Transfer to expert:\n' + experts.map((e, i) => (i + 1) + '. ' + e.username).join('\n') + '\n\nEnter number:');
      const idx = parseInt(name) - 1;
      if (isNaN(idx) || idx < 0 || idx >= experts.length) return;
      const reason = prompt('Reason for transfer (optional):') || '';
      chatSocket.emit('chat:transfer', { sessionId: echActiveSessionId, targetExpertId: experts[idx].userId, reason }, (resp) => {
        if (resp.success) {
          document.getElementById('ech-window').style.display = 'none';
          echActiveSessionId = null;
          refreshExpertChatList();
          showToast('Chat transferred', 'success');
        }
      });
    } catch (e) { /* ignore */ }
  }

  // Initialize chat socket on login
  function toggleChatTranscript() {
    const el = document.getElementById('td-chat-transcript');
    const icon = document.getElementById('chat-transcript-toggle');
    if (el) {
      const show = el.style.display === 'none';
      el.style.display = show ? 'block' : 'none';
      if (icon) icon.textContent = show ? '▲ Hide' : '▼ Show';
    }
  }

  async function loadChatTranscript(sessionId) {
    const container = document.getElementById('td-chat-transcript');
    if (!container) return;
    container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:12px">Loading transcript...</div>';
    try {
      const resp = await fetch(`/api/chat/${tenant}/sessions/${sessionId}/transcript`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await resp.json();
      if (data.success && data.messages?.length > 0) {
        container.innerHTML = data.messages.map(m => {
          const time = new Date(m.created_at).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          const sender = m.sender_name || m.sender_role;
          const role = m.sender_role;
          const colors = { customer: '#3b82f6', expert: '#8b5cf6', system: '#6b7280', ai: '#f59e0b' };
          const color = colors[role] || '#6b7280';
          if (role === 'system') {
            return `<div style="padding:4px 8px;font-size:11px;color:var(--muted);text-align:center">${m.content}</div>`;
          }
          const content = m.message_type === 'file' ? `📄 <a href="${m.file_url}" target="_blank">${m.file_name}</a>` : (m.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return `<div style="padding:6px 10px;margin-bottom:4px;border-left:3px solid ${color};border-radius:6px;background:${color}08">
            <strong style="font-size:11px;color:${color}">${sender}</strong> <span style="font-size:10px;color:var(--muted)">${time}</span>
            <div style="margin-top:2px">${content}</div>
          </div>`;
        }).join('');
      } else {
        container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:12px">No messages in this session</div>';
      }
    } catch (e) {
      container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:12px">Failed to load transcript</div>';
    }
  }

  function initChatOnLogin() {
    setTimeout(() => {
      initChatSocket();
      const r = window.role || role;
      if (r === 'expert' || r === 'admin') {
        refreshExpertChatList();
      }
    }, 1000);
  }


  // ====== System Control Functions ======

  let systemControlAuditLog = [];

  async function loadSystemControlSettings() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      console.log('Loading system control settings for tenant:', tenantCode);

      // Fetch both tenant_settings and email_ingest_settings in parallel
      const [tenantSettingsResponse, emailIngestResponse] = await Promise.all([
        fetch(`${API_BASE}/api/tickets/settings/${tenantCode}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }),
        fetch(`${API_BASE}/api/email-ingest/${tenantCode}/settings`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
      ]);

      const data = await tenantSettingsResponse.json();
      const emailIngestData = await emailIngestResponse.json();
      console.log('Tenant settings response:', data);
      console.log('Email ingest settings response:', emailIngestData);

      if (data.success && data.settings) {
        // Update Send Emails to Experts toggle
        const sendExpertsCheckbox = document.getElementById('sc-send-emails-experts');
        const sendExpertsValue = data.settings.send_emails_experts;
        const sendExpertsEnabled = sendExpertsValue !== 'false';
        console.log('send_emails_experts value:', sendExpertsValue, 'enabled:', sendExpertsEnabled);
        if (sendExpertsCheckbox) {
          sendExpertsCheckbox.checked = sendExpertsEnabled;
        }
        updateSystemSettingStatus('send_emails_experts', sendExpertsEnabled);

        // Update Send Emails to Customers toggle
        const sendCustomersCheckbox = document.getElementById('sc-send-emails-customers');
        const sendCustomersValue = data.settings.send_emails_customers;
        const sendCustomersEnabled = sendCustomersValue !== 'false';
        console.log('send_emails_customers value:', sendCustomersValue, 'enabled:', sendCustomersEnabled);
        if (sendCustomersCheckbox) {
          sendCustomersCheckbox.checked = sendCustomersEnabled;
        }
        updateSystemSettingStatus('send_emails_customers', sendCustomersEnabled);

        // Update Process SLA toggle - check explicitly for 'false' string
        const processSlaCheckbox = document.getElementById('sc-process-sla');
        const processSlaValue = data.settings.process_sla;
        // Only disabled if explicitly set to 'false'
        const processSlaEnabled = processSlaValue !== 'false';
        console.log('process_sla value:', processSlaValue, 'enabled:', processSlaEnabled);
        if (processSlaCheckbox) {
          processSlaCheckbox.checked = processSlaEnabled;
        }
        updateSystemSettingStatus('process_sla', processSlaEnabled);
      } else {
        console.log('No tenant settings found, defaulting to enabled');
        // Default to enabled if no settings found
        const sendExpertsCheckbox = document.getElementById('sc-send-emails-experts');
        const sendCustomersCheckbox = document.getElementById('sc-send-emails-customers');
        const processSlaCheckbox = document.getElementById('sc-process-sla');
        if (sendExpertsCheckbox) sendExpertsCheckbox.checked = true;
        if (sendCustomersCheckbox) sendCustomersCheckbox.checked = true;
        if (processSlaCheckbox) processSlaCheckbox.checked = true;
        updateSystemSettingStatus('send_emails_experts', true);
        updateSystemSettingStatus('send_emails_customers', true);
        updateSystemSettingStatus('process_sla', true);
      }

      // Update Process Emails toggle from email_ingest_settings (either provider enabled)
      const processEmailsCheckbox = document.getElementById('sc-process-emails');
      const eis = emailIngestData.success && emailIngestData.settings ? emailIngestData.settings : {};
      const processEmailsEnabled = !!eis.enabled || !!eis.m365_enabled;
      console.log('process_emails: imap_enabled=', eis.enabled, 'm365_enabled=', eis.m365_enabled, 'any_enabled:', processEmailsEnabled);
      if (processEmailsCheckbox) {
        processEmailsCheckbox.checked = processEmailsEnabled;
      }
      updateSystemSettingStatus('process_emails', processEmailsEnabled);

      // Update status log
      updateSystemStatusLog();

      // Update last updated timestamp
      const lastUpdated = document.getElementById('sc-last-updated');
      if (lastUpdated) lastUpdated.textContent = new Date().toLocaleString();

      // Load audit log
      loadSystemControlAuditLog();

    } catch (error) {
      console.error('Error loading system control settings:', error);
      const statusLog = document.getElementById('sc-status-log');
      if (statusLog) statusLog.innerHTML = '<div style="color:#b91c1c">Error loading system settings</div>';
    }
  }

  function updateSystemSettingStatus(setting, enabled) {
    const statusDiv = document.getElementById(`sc-${setting.replace(/_/g, '-')}-status`);
    if (statusDiv) {
      let enabledMsg = '';
      let disabledMsg = '';

      switch(setting) {
        case 'send_emails_experts':
          enabledMsg = 'Email notifications to experts are enabled';
          disabledMsg = 'Email notifications to experts are disabled';
          break;
        case 'send_emails_customers':
          enabledMsg = 'Email notifications to customers are enabled';
          disabledMsg = 'Email notifications to customers are disabled';
          break;
        case 'process_emails':
          enabledMsg = 'Inbound emails will be processed';
          disabledMsg = 'No inbound emails will be processed';
          break;
        default:
          enabledMsg = 'Setting is enabled';
          disabledMsg = 'Setting is disabled';
      }

      if (enabled) {
        statusDiv.style.background = '#dcfce7';
        statusDiv.style.color = '#166534';
        statusDiv.innerHTML = '✓ <strong>ENABLED</strong> - ' + enabledMsg;
      } else {
        statusDiv.style.background = '#fef2f2';
        statusDiv.style.color = '#b91c1c';
        statusDiv.innerHTML = '✗ <strong>DISABLED</strong> - ' + disabledMsg;
      }
    }
  }

  async function toggleSystemSetting(setting, enabled) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      let response;

      // process_emails uses the email-ingest endpoint (controls mailbox polling kill switch)
      if (setting === 'process_emails') {
        response = await fetch(`${API_BASE}/api/email-ingest/${tenantCode}/settings`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            enabled: enabled ? 1 : 0
          })
        });
      } else {
        // Other settings use the tenant_settings endpoint
        response = await fetch(`${API_BASE}/api/tickets/settings/${tenantCode}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            key: setting,
            value: enabled ? 'true' : 'false'
          })
        });
      }

      const data = await response.json();

      if (data.success) {
        // For process_emails, use the returned enabled state from server
        const actualEnabled = setting === 'process_emails' ? data.enabled : enabled;
        updateSystemSettingStatus(setting, actualEnabled);

        // Add to local audit log
        const username = localStorage.getItem('username') || 'Unknown';
        const settingNames = {
          'send_emails_experts': 'Send to Experts',
          'send_emails_customers': 'Send to Customers',
          'process_emails': 'Process Emails'
        };
        systemControlAuditLog.unshift({
          setting: settingNames[setting] || setting,
          old_value: enabled ? 'OFF' : 'ON',
          new_value: enabled ? 'ON' : 'OFF',
          changed_by: username,
          time: new Date().toLocaleString()
        });

        renderSystemControlAuditLog();
        updateSystemStatusLog();
      } else {
        alert('Failed to update setting: ' + (data.message || 'Unknown error'));
        // Revert the checkbox
        document.getElementById(`sc-${setting.replace(/_/g, '-')}`).checked = !enabled;
      }
    } catch (error) {
      console.error('Error toggling system setting:', error);
      alert('Error updating setting. Please try again.');
      // Revert the checkbox
      document.getElementById(`sc-${setting.replace(/_/g, '-')}`).checked = !enabled;
    }
  }

  function updateSystemStatusLog() {
    const statusLog = document.getElementById('sc-status-log');
    const sendExperts = document.getElementById('sc-send-emails-experts')?.checked;
    const sendCustomers = document.getElementById('sc-send-emails-customers')?.checked;
    const processEmails = document.getElementById('sc-process-emails')?.checked;

    let logHtml = '';
    logHtml += `<div style="margin-bottom:8px">[${new Date().toLocaleTimeString()}] System Control Status Check</div>`;
    logHtml += `<div style="margin-bottom:4px;color:${sendExperts ? '#166534' : '#b91c1c'}">  → send_to_experts: ${sendExperts ? 'ENABLED' : 'DISABLED'}</div>`;
    logHtml += `<div style="margin-bottom:4px;color:${sendCustomers ? '#166534' : '#b91c1c'}">  → send_to_customers: ${sendCustomers ? 'ENABLED' : 'DISABLED'}</div>`;
    logHtml += `<div style="margin-bottom:4px;color:${processEmails ? '#166534' : '#b91c1c'}">  → process_emails: ${processEmails ? 'ENABLED' : 'DISABLED'}</div>`;
    logHtml += `<div style="margin-top:8px;border-top:1px solid #e2e8f0;padding-top:8px">`;

    if (!sendExperts || !sendCustomers || !processEmails) {
      logHtml += `<div style="color:#b45309">⚠️ Warning: Some email functionality is disabled</div>`;
    } else {
      logHtml += `<div style="color:#166534">✓ All email systems operational</div>`;
    }
    logHtml += '</div>';

    statusLog.innerHTML = logHtml;
  }

  async function loadSystemControlAuditLog() {
    // For now, just show the in-memory audit log
    // In a full implementation, this would fetch from the backend
    renderSystemControlAuditLog();
  }

  function renderSystemControlAuditLog() {
    const tbody = document.getElementById('sc-audit-log');

    if (systemControlAuditLog.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="subtitle" style="text-align:center">No recent changes</td></tr>';
      return;
    }

    tbody.innerHTML = systemControlAuditLog.slice(0, 10).map(log => `
      <tr>
        <td>${log.setting}</td>
        <td><span class="badge" style="background:${log.old_value === 'ON' ? '#dcfce7' : '#fef2f2'}">${log.old_value}</span></td>
        <td><span class="badge" style="background:${log.new_value === 'ON' ? '#dcfce7' : '#fef2f2'}">${log.new_value}</span></td>
        <td>${log.changed_by}</td>
        <td>${log.time}</td>
      </tr>
    `).join('');
  }

  // ====== AI Insights Functions ======

let aiInsightsData = null;
let aiInsightsLoading = false;

async function loadAIInsights() {
  // Check if user is a customer - AI Insights is not available for customers
  const currentRole = window.role || role;
  if (currentRole === 'customer') {
    document.getElementById('ai-insights-list').innerHTML =
      '<div class="subtitle" style="text-align:center;padding:40px;color:var(--muted)">AI Insights is not available for customer accounts. Please view your Analytics dashboard for ticket statistics.</div>';
    return;
  }

  // Prevent multiple simultaneous requests
  if (aiInsightsLoading) {
    console.log('AI Insights already loading, skipping duplicate request');
    return;
  }

  aiInsightsLoading = true;
  console.log('loadAIInsights() called');

  const period = document.getElementById('ai-period')?.value || 7;
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/analytics/${tenantCode}/ai-insights?period=${period}`;
    console.log('Fetching AI insights from:', url);

    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      aiInsightsData = data.data;
      displayAIInsights(aiInsightsData);
    } else {
      console.error('AI Insights API error:', data);
      document.getElementById('ai-insights-list').innerHTML =
        '<div class="subtitle" style="color:#f56565">Failed to load AI insights</div>';
    }
  } catch (error) {
    console.error('Error loading AI insights:', error);
    document.getElementById('ai-insights-list').innerHTML =
      '<div class="subtitle" style="color:#f56565">Error loading AI insights. Make sure the server is running.</div>';
  } finally {
    aiInsightsLoading = false;
  }
}

async function displayAIInsights(data) {
  console.log('Displaying AI insights:', data);

  // Display insights/alerts
  const insightsList = document.getElementById('ai-insights-list');
  if (data.insights && data.insights.length > 0) {
    // Fetch ticket details for all insights with affected tickets
    await enrichInsightsWithTicketDetails(data.insights);

    insightsList.innerHTML = data.insights.map(insight => {
      const severityColors = {
        critical: '#f56565',
        warning: '#ed8936',
        info: '#4299e1'
      };
      const severityColor = severityColors[insight.severity] || '#718096';
      const severityIcon = {
        critical: '🔴',
        warning: '⚠️',
        info: 'ℹ️'
      }[insight.severity] || '📊';

      // Generate ticket summary HTML
      const ticketSummaryHTML = generateTicketSummary(insight);

      return `
        <div class="card p-12 mb-8" style="border-left:4px solid ${severityColor};cursor:pointer"
             onclick="event.stopPropagation()">
          <div class="row space">
            <div style="flex:1">
              <div class="row" style="gap:8px;align-items:center;margin-bottom:4px">
                <span style="font-size:18px">${severityIcon}</span>
                <strong>${insight.title}</strong>
                <span class="badge" style="background:${severityColor};color:white;text-transform:uppercase;font-size:10px;padding:2px 6px;border-radius:4px">${insight.severity}</span>
              </div>
              <div class="subtitle">${insight.description}</div>

              ${ticketSummaryHTML}

              ${insight.affected_tickets && insight.affected_tickets.length > 0 ?
                `<div style="margin-top:8px">
                  <button class="btn ghost" style="padding:4px 12px;font-size:12px"
                          onclick="openTicketsFromInsight([${insight.affected_tickets.join(',')}], '${insight.title}')">
                    📋 View ${insight.affected_tickets.length} Ticket${insight.affected_tickets.length > 1 ? 's' : ''}
                  </button>
                </div>` :
                ''
              }
              <div class="subtitle" style="margin-top:4px;font-size:11px;color:#a0aec0">${new Date(insight.created_at).toLocaleString()}</div>
            </div>
            <div class="row" style="gap:4px">
              <button class="btn ghost" style="padding:4px 8px;font-size:12px" onclick="acknowledgeInsight(${insight.id})">✓ Acknowledge</button>
              <button class="btn ghost" style="padding:4px 8px;font-size:12px" onclick="dismissInsight(${insight.id})">✕ Dismiss</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  } else {
    insightsList.innerHTML = '<div class="subtitle">✅ No active insights. Everything looks good!</div>';
  }

  // Display performance metrics
  if (data.performance) {
    document.getElementById('ai-tickets-analyzed').textContent = data.performance.total_analyzed || 0;

    const avgConf = parseFloat(data.performance.avg_confidence);
    document.getElementById('ai-avg-confidence').textContent = !isNaN(avgConf) ? avgConf.toFixed(1) + '%' : '--';

    const avgTime = parseFloat(data.performance.avg_processing_time);
    document.getElementById('ai-avg-time').textContent = !isNaN(avgTime) ? (avgTime / 1000).toFixed(2) + 's' : '--';
  }

  // Load AI CMDB suggestions count
  loadCMDBSuggestionsCount();

  // Display sentiment chart
  if (data.sentiment && data.sentiment.distribution) {
    renderSentimentChart(data.sentiment.distribution);
  }

  // Display categories chart
  if (data.categories && data.categories.length > 0) {
    renderCategoriesChart(data.categories);
  }

  // Display root causes chart
  if (data.rootCauses && data.rootCauses.length > 0) {
    renderRootCausesChart(data.rootCauses);
  }
}

// Enrich insights with ticket details
async function enrichInsightsWithTicketDetails(insights) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  for (const insight of insights) {
    if (insight.affected_tickets && insight.affected_tickets.length > 0) {
      try {
        // Fetch tickets in batches to avoid overwhelming the API
        const ticketIds = insight.affected_tickets.slice(0, 50); // Limit to first 50
        const ticketsPromises = ticketIds.map(async (ticketId) => {
          try {
            const url = window.location.protocol + '//' + window.location.host +
                       `/api/tickets/${tenantCode}/${ticketId}`;
            const response = await fetch(url, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            return data.success ? data.ticket : null;
          } catch (error) {
            console.error(`Error fetching ticket ${ticketId}:`, error);
            return null;
          }
        });

        const tickets = (await Promise.all(ticketsPromises)).filter(t => t !== null);
        insight.ticketDetails = tickets;
      } catch (error) {
        console.error('Error enriching insight with ticket details:', error);
        insight.ticketDetails = [];
      }
    }
  }
}

// Generate ticket summary HTML with grouping
function generateTicketSummary(insight) {
  if (!insight.ticketDetails || insight.ticketDetails.length === 0) {
    return '';
  }

  // Group tickets by title
  const groupedTickets = {};
  const ticketDates = [];

  insight.ticketDetails.forEach(ticket => {
    const title = ticket.title || 'Untitled';
    if (!groupedTickets[title]) {
      groupedTickets[title] = {
        title: title,
        count: 0,
        tickets: [],
        earliestDate: null,
        latestDate: null
      };
    }

    groupedTickets[title].count++;
    groupedTickets[title].tickets.push(ticket);

    const ticketDate = new Date(ticket.created_at);
    ticketDates.push(ticketDate);

    if (!groupedTickets[title].earliestDate || ticketDate < groupedTickets[title].earliestDate) {
      groupedTickets[title].earliestDate = ticketDate;
    }
    if (!groupedTickets[title].latestDate || ticketDate > groupedTickets[title].latestDate) {
      groupedTickets[title].latestDate = ticketDate;
    }
  });

  // Get overall time span
  const earliestDate = ticketDates.length > 0 ? new Date(Math.min(...ticketDates)) : null;
  const latestDate = ticketDates.length > 0 ? new Date(Math.max(...ticketDates)) : null;

  let html = '<div style="margin-top:12px;padding:12px;background:#f7fafc;border-radius:6px">';
  html += '<div style="font-weight:600;margin-bottom:8px;font-size:13px">📊 Ticket Summary</div>';

  // Overall time span
  if (earliestDate && latestDate) {
    const timeSpan = formatTimeSpan(earliestDate, latestDate);
    html += `<div class="subtitle" style="margin-bottom:8px;font-size:12px">
      📅 Time span: ${timeSpan}
    </div>`;
  }

  // Grouped tickets
  const groups = Object.values(groupedTickets).sort((a, b) => b.count - a.count);

  html += '<div style="margin-top:8px">';
  groups.slice(0, 5).forEach(group => {
    const ticketIds = group.tickets.map(t => t.id);
    const timeSpan = formatTimeSpan(group.earliestDate, group.latestDate);

    html += `
      <div style="margin-bottom:6px;padding:6px;background:white;border-radius:4px;cursor:pointer"
           onclick="openTicketsFromInsight([${ticketIds.join(',')}], '${escapeHtml(group.title)}')">
        <div style="font-weight:600;font-size:12px;color:#2d3748">
          ${group.count} × ${escapeHtml(group.title)}
        </div>
        <div class="subtitle" style="font-size:11px;margin-top:2px">
          ${timeSpan} • Click to view tickets
        </div>
      </div>
    `;
  });

  if (groups.length > 5) {
    html += `<div class="subtitle" style="font-size:11px;margin-top:4px">
      ...and ${groups.length - 5} more groups
    </div>`;
  }
  html += '</div>';

  html += '</div>';
  return html;
}

// Format time span
function formatTimeSpan(startDate, endDate) {
  const start = new Date(startDate);
  const end = new Date(endDate);

  if (start.toDateString() === end.toDateString()) {
    return `${start.toLocaleDateString()} ${start.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})} - ${end.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;
  } else {
    const diffMs = end - start;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

    if (diffDays > 0) {
      return `${start.toLocaleDateString()} to ${end.toLocaleDateString()} (${diffDays}d ${diffHours}h)`;
    } else {
      return `${start.toLocaleDateString()} (${diffHours}h)`;
    }
  }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Open tickets from insight
async function openTicketsFromInsight(ticketIds, insightTitle) {
  // Store the filter in window object BEFORE switching view
  window.insightTicketFilter = ticketIds;
  window.insightTitle = insightTitle || 'Insight Tickets';

  // Flag to prevent double-rendering - switchView will call renderList
  // but we need the filter to be set first, which it now is

  // Show the tickets view (this will trigger renderList with our filter)
  currentView = 'tickets';
  ['dash','profile','tickets','ticket-detail','experts','expert-detail','customers','cmdb','cmdb-detail','manage-cmdb','wizard','raise','tenants','subscriptions','billing','plans','system','usage','customer-plans','customer-billing','analytics','ai-insights','ticket-rules','email-processing','system-control'].forEach(n=>{
    const el=document.getElementById('view-'+n);
    if(el) el.style.display=(n==='tickets')?'block':'none';
  });

  // Load filter settings (but our insight filter takes precedence)
  loadFilterSettings('tickets');

  // Now render with the insight filter applied
  await renderList();
}

function renderSentimentChart(distribution) {
  const container = document.getElementById('sentiment-chart');
  const total = Object.values(distribution).reduce((sum, val) => sum + val, 0);

  if (total === 0) {
    container.innerHTML = '<div class="subtitle">No data available</div>';
    return;
  }

  const sentimentColors = {
    urgent: '#f56565',
    negative: '#ed8936',
    neutral: '#a0aec0',
    positive: '#48bb78'
  };

  const sentimentIcons = {
    urgent: '🔴',
    negative: '😐',
    neutral: '😶',
    positive: '😊'
  };

  container.innerHTML = Object.entries(distribution).map(([sentiment, count]) => {
    const percent = ((count / total) * 100).toFixed(1);
    const color = sentimentColors[sentiment] || '#a0aec0';
    const icon = sentimentIcons[sentiment] || '📊';

    return `
      <div style="margin-bottom:12px">
        <div class="row space" style="margin-bottom:4px">
          <span class="subtitle">${icon} ${sentiment.charAt(0).toUpperCase() + sentiment.slice(1)}</span>
          <span class="subtitle"><strong>${count}</strong> (${percent}%)</span>
        </div>
        <div style="width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden">
          <div style="width:${percent}%;height:100%;background:${color};border-radius:4px"></div>
        </div>
      </div>
    `;
  }).join('');
}

function renderCategoriesChart(categories) {
  const container = document.getElementById('categories-chart');
  const maxCount = Math.max(...categories.map(c => c.count));

  container.innerHTML = categories.slice(0, 5).map(cat => {
    const percent = ((cat.count / maxCount) * 100).toFixed(1);
    const conf = parseFloat(cat.avg_confidence);
    const confStr = !isNaN(conf) ? ` (${conf.toFixed(0)}% confidence)` : '';

    return `
      <div style="margin-bottom:12px">
        <div class="row space" style="margin-bottom:4px">
          <span class="subtitle">${cat.ai_category}</span>
          <span class="subtitle"><strong>${cat.count}</strong>${confStr}</span>
        </div>
        <div style="width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden">
          <div style="width:${percent}%;height:100%;background:#667eea;border-radius:4px"></div>
        </div>
      </div>
    `;
  }).join('');
}

function renderRootCausesChart(rootCauses) {
  const container = document.getElementById('root-causes-chart');
  const total = rootCauses.reduce((sum, rc) => sum + rc.count, 0);

  const rootCauseColors = {
    system: '#667eea',
    hardware: '#ed8936',
    software: '#4299e1',
    network: '#48bb78',
    database: '#9f7aea',
    resource: '#f56565',
    unknown: '#a0aec0'
  };

  container.innerHTML = `
    <div class="row" style="gap:8px;flex-wrap:wrap">
      ${rootCauses.map(rc => {
        const percent = ((rc.count / total) * 100).toFixed(1);
        const color = rootCauseColors[rc.root_cause_type] || '#a0aec0';

        return `
          <div class="card p-12" style="flex:1;min-width:120px;border-left:4px solid ${color}">
            <div class="subtitle" style="margin-bottom:4px">${rc.root_cause_type || 'unknown'}</div>
            <div style="font-size:24px;font-weight:800;color:${color}">${rc.count}</div>
            <div class="subtitle" style="font-size:11px">${percent}% of total</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

async function refreshAIInsights() {
  // Show loading indicator
  const insightsList = document.getElementById('ai-insights-list');
  if (insightsList) {
    insightsList.innerHTML = '<div class="subtitle">🔄 Loading insights...</div>';
  }

  await loadAIInsights();
}

async function triggerTrendDetection(evt) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  // Get the button element
  const btn = evt?.target || document.querySelector('button[onclick*="triggerTrendDetection"]');

  try {
    if (btn) {
      btn.disabled = true;
      btn.textContent = '⏳ Detecting...';
    }

    const url = window.location.protocol + '//' + window.location.host + `/api/analytics/${tenantCode}/detect-trends`;
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ timeRangeHours: 24 })
    });

    const data = await response.json();

    if (data.success) {
      alert(`✅ Trend detection complete!\n\n${data.message}\n\nRefreshing dashboard...`);
      await refreshAIInsights();
    } else {
      alert('❌ Failed to detect trends. Check console for details.');
    }
  } catch (error) {
    console.error('Error triggering trend detection:', error);
    alert('❌ Error detecting trends: ' + error.message);
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = '🔍 Detect Trends';
    }
  }
}

async function acknowledgeInsight(insightId) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/analytics/${tenantCode}/insights/${insightId}/acknowledge`;
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      await refreshAIInsights();
    } else {
      alert('Failed to acknowledge insight');
    }
  } catch (error) {
    console.error('Error acknowledging insight:', error);
    alert('Error acknowledging insight: ' + error.message);
  }
}

async function dismissInsight(insightId) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/analytics/${tenantCode}/insights/${insightId}/dismiss`;
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      await refreshAIInsights();
    } else {
      alert('Failed to dismiss insight');
    }
  } catch (error) {
    console.error('Error dismissing insight:', error);
    alert('Error dismissing insight: ' + error.message);
  }
}

// ADD TO THE nav() FUNCTION SWITCH STATEMENT:
// case 'ai-insights': loadAIInsights(); break;
// case 'ticket-rules': loadTicketRules(); break;

// ============================================
// AI CMDB SUGGESTIONS FUNCTIONS
// ============================================

let cmdbSuggestionsData = [];

async function loadCMDBSuggestionsCount() {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ai/${tenantCode}/cmdb-suggestions`;
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      const data = await response.json();
      if (data.success) {
        const countEl = document.getElementById('ai-cmdb-suggestions-count');
        if (countEl) {
          countEl.textContent = data.count || 0;
          // Add visual indicator if there are pending suggestions
          if (data.count > 0) {
            countEl.style.color = '#9f7aea';
          } else {
            countEl.style.color = '#a0aec0';
          }
        }
        cmdbSuggestionsData = data.suggestions || [];
      }
    }
  } catch (error) {
    console.error('Error loading CMDB suggestions count:', error);
  }
}

async function showCMDBSuggestionsModal() {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  // Load latest suggestions
  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ai/${tenantCode}/cmdb-suggestions?limit=50`;
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (response.ok) {
      const data = await response.json();
      cmdbSuggestionsData = data.suggestions || [];
    }
  } catch (error) {
    console.error('Error loading CMDB suggestions:', error);
  }

  // Build modal content
  let content = `
    <div style="max-height:70vh;overflow-y:auto">
      <p class="subtitle mb-16">AI has suggested these CMDB item links based on ticket content analysis. Review and approve or reject each suggestion.</p>
  `;

  if (cmdbSuggestionsData.length === 0) {
    content += `
      <div style="text-align:center;padding:40px;color:#a0aec0">
        <div style="font-size:48px;margin-bottom:16px">✅</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">No Pending Suggestions</div>
        <div class="subtitle">All AI-suggested CMDB links have been reviewed.</div>
      </div>
    `;
  } else {
    content += `<div class="suggestions-list">`;
    for (const suggestion of cmdbSuggestionsData) {
      const confidenceColor = suggestion.confidence_score >= 90 ? '#48bb78' :
                             suggestion.confidence_score >= 70 ? '#ed8936' : '#e53e3e';
      content += `
        <div class="card p-12 mb-12" id="suggestion-${suggestion.id}" style="border-left:4px solid ${confidenceColor}">
          <div class="row space mb-8">
            <div>
              <div style="font-weight:600;color:var(--ink)">${escapeHtml(suggestion.asset_name)}</div>
              <div class="subtitle" style="font-size:12px">${escapeHtml(suggestion.asset_category || 'N/A')} • ${escapeHtml(suggestion.cmdb_customer || 'No customer')}</div>
            </div>
            <div style="text-align:right">
              <span class="badge" style="background:${confidenceColor};color:white">${suggestion.confidence_score}%</span>
              <span class="badge" style="background:var(--bg);margin-left:4px">${suggestion.relationship_type}</span>
            </div>
          </div>
          <div class="subtitle mb-8" style="font-size:12px">
            <strong>Ticket #${suggestion.ticket_id}:</strong> ${escapeHtml((suggestion.ticket_title || '').substring(0, 60))}${suggestion.ticket_title && suggestion.ticket_title.length > 60 ? '...' : ''}
          </div>
          <div class="subtitle mb-12" style="font-size:11px;font-style:italic;color:#718096">
            ${escapeHtml(suggestion.match_reason || 'AI-matched based on content analysis')}
          </div>
          <div class="row" style="gap:8px">
            <button class="btn sm" style="background:#48bb78;color:white;border:none" onclick="approveCMDBSuggestion(${suggestion.id})">✓ Approve</button>
            <button class="btn sm ghost" style="color:#e53e3e" onclick="rejectCMDBSuggestion(${suggestion.id})">✗ Reject</button>
            <button class="btn sm ghost" onclick="viewTicket(${suggestion.ticket_id})">View Ticket</button>
          </div>
        </div>
      `;
    }
    content += `</div>`;
  }

  content += `</div>`;

  // Show modal
  showModal('AI-Suggested CMDB Links', content, [
    { label: 'Close', class: 'ghost', action: "closeModal('generic-modal')" }
  ]);
}

async function approveCMDBSuggestion(suggestionId) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ai/${tenantCode}/cmdb-suggestions/${suggestionId}/approve`;
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      // Animate removal
      const el = document.getElementById(`suggestion-${suggestionId}`);
      if (el) {
        el.style.transition = 'all 0.3s ease';
        el.style.opacity = '0';
        el.style.transform = 'translateX(20px)';
        setTimeout(() => {
          el.remove();
          // Update count
          loadCMDBSuggestionsCount();
          // Check if list is now empty
          const remainingCards = document.querySelectorAll('.suggestions-list .card');
          if (remainingCards.length === 0) {
            showCMDBSuggestionsModal(); // Refresh to show empty state
          }
        }, 300);
      }
    } else {
      alert('Failed to approve suggestion: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error approving suggestion:', error);
    alert('Error approving suggestion: ' + error.message);
  }
}

async function rejectCMDBSuggestion(suggestionId) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ai/${tenantCode}/cmdb-suggestions/${suggestionId}`;
    const response = await fetch(url, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      // Animate removal
      const el = document.getElementById(`suggestion-${suggestionId}`);
      if (el) {
        el.style.transition = 'all 0.3s ease';
        el.style.opacity = '0';
        el.style.transform = 'translateX(-20px)';
        setTimeout(() => {
          el.remove();
          // Update count
          loadCMDBSuggestionsCount();
          // Check if list is now empty
          const remainingCards = document.querySelectorAll('.suggestions-list .card');
          if (remainingCards.length === 0) {
            showCMDBSuggestionsModal(); // Refresh to show empty state
          }
        }, 300);
      }
    } else {
      alert('Failed to reject suggestion: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error rejecting suggestion:', error);
    alert('Error rejecting suggestion: ' + error.message);
  }
}

// ============================================
// AUTOMATED ACTIONS FUNCTIONS
// ============================================

let currentRuleId = null;
let ruleExperts = [];
let ruleCustomers = [];
let ruleAdvancedVisible = false;

// Load all rules for the current tenant
async function loadTicketRules() {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    // Load rules
    const rulesUrl = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}`;
    const rulesResponse = await fetch(rulesUrl, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const rulesData = await rulesResponse.json();

    // Load statistics
    const statsUrl = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/statistics`;
    const statsResponse = await fetch(statsUrl, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const statsData = await statsResponse.json();

    // Update statistics display
    if (statsData.success) {
      document.getElementById('rules-total').textContent = statsData.statistics.total_rules || 0;
      document.getElementById('rules-enabled').textContent = statsData.statistics.enabled_rules || 0;
      document.getElementById('rules-executions-24h').textContent = statsData.statistics.executions_last_24h || 0;
    }

    // Display rules
    if (rulesData.success && rulesData.rules.length > 0) {
      displayRules(rulesData.rules);
    } else {
      document.getElementById('rules-list').innerHTML = '<div class="subtitle">No actions found. Create your first automated action to get started.</div>';
    }

    // Load experts and customers for dropdowns
    await loadExpertsAndCustomers();
  } catch (error) {
    console.error('Error loading ticket rules:', error);
    document.getElementById('rules-list').innerHTML = '<div class="subtitle" style="color:#f56565">Error loading rules</div>';
  }
}

// Display rules in the list
function displayRules(rules) {
  const rulesList = document.getElementById('rules-list');

  const actionIcons = {
    delete: '🗑️',
    assign_to_expert: '👤',
    create_for_customer: '📋',
    set_priority: '⚡',
    set_status: '📊',
    add_tag: '🏷️',
    add_to_monitoring: '📡'
  };

  const actionLabels = {
    delete: 'Delete Ticket',
    assign_to_expert: 'Assign to Expert',
    create_for_customer: 'Create for Customer',
    set_priority: 'Set Priority',
    set_status: 'Set Status',
    add_tag: 'Add Tag',
    add_to_monitoring: 'Add to Monitoring'
  };

  rulesList.innerHTML = rules.map(rule => {
    const actionIcon = actionIcons[rule.action_type] || '⚙️';
    const actionLabel = actionLabels[rule.action_type] || rule.action_type;
    const enabledBadge = rule.enabled
      ? '<span style="padding:4px 8px;background:#48bb78;color:white;border-radius:4px;font-size:11px;font-weight:600">ACTIVE</span>'
      : '<span style="padding:4px 8px;background:#a0aec0;color:white;border-radius:4px;font-size:11px;font-weight:600">DISABLED</span>';
    const aiBadge = rule.ai_interpreted
      ? '<span style="padding:3px 8px;background:#eef2ff;color:#4338ca;border-radius:4px;font-size:11px;font-weight:600;border:1px solid #c7d2fe">AI</span>'
      : '';

    return `
      <div class="card p-12 mb-8" style="border-left:4px solid ${rule.enabled ? '#48bb78' : '#a0aec0'}">
        <div class="row space mb-8">
          <div>
            <div class="row" style="gap:8px;align-items:center;margin-bottom:4px">
              <h4 style="margin:0">${escapeHtml(rule.rule_name)}</h4>
              ${enabledBadge}
              ${aiBadge}
            </div>
            ${rule.instruction_text ? `<div style="font-size:13px;color:#4338ca;margin-bottom:2px;font-style:italic">"${escapeHtml(rule.instruction_text)}"</div>` : ''}
            ${rule.description ? `<div class="subtitle">${escapeHtml(rule.description)}</div>` : ''}
          </div>
          <div class="row" style="gap:4px">
            <button class="btn ghost" onclick="testRule(${rule.id})" title="Test this action">🧪 Test</button>
            <button class="btn primary" onclick="runRule(${rule.id})" title="Run on all matching tickets">▶️ Run</button>
            <button class="btn ghost" onclick="editRule(${rule.id})">✏️ Edit</button>
            <button class="btn ghost" onclick="deleteRule(${rule.id})" title="Delete this action">🗑️</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px">
          <div>
            <div class="subtitle" style="margin-bottom:4px">Condition</div>
            <div><strong>Search in:</strong> ${rule.search_in}</div>
            <div><strong>Text:</strong> "${escapeHtml(rule.search_text || '')}"</div>
            <div><strong>Case sensitive:</strong> ${rule.case_sensitive ? 'Yes' : 'No'}</div>
          </div>
          <div>
            <div class="subtitle" style="margin-bottom:4px">${actionIcon} Action</div>
            <div><strong>${actionLabel}</strong></div>
            ${formatActionParams(rule.action_type, rule.action_params)}
          </div>
        </div>

        ${rule.times_triggered > 0 ? `
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;font-size:12px;color:#718096">
            Triggered ${rule.times_triggered} time(s)
            ${rule.last_triggered_at ? ` • Last: ${new Date(rule.last_triggered_at).toLocaleString()}` : ''}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

// Format action parameters for display
function formatActionParams(actionType, params) {
  if (!params) return '';

  switch (actionType) {
    case 'assign_to_expert':
      return `<div>Expert ID: ${params.expert_id}</div>`;
    case 'create_for_customer':
      return `<div>Customer ID: ${params.customer_id}</div>`;
    case 'set_priority':
      return `<div>Priority: ${params.priority}</div>`;
    case 'set_status':
      return `<div>Status: ${params.status}</div>`;
    case 'add_tag':
      return `<div>Tag: ${params.tag}</div>`;
    default:
      return '';
  }
}

// Load experts and customers for dropdowns
async function loadExpertsAndCustomers() {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    // Load experts
    const expertsUrl = window.location.protocol + '//' + window.location.host + `/api/experts/${tenantCode}`;
    const expertsResponse = await fetch(expertsUrl, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const expertsData = await expertsResponse.json();
    if (expertsData.success) {
      ruleExperts = expertsData.experts;
    }

    // Load customers
    const customersUrl = window.location.protocol + '//' + window.location.host + `/api/customers`;
    const customersResponse = await fetch(customersUrl, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const customersData = await customersResponse.json();
    if (customersData.success) {
      ruleCustomers = customersData.customers;
    }
  } catch (error) {
    console.error('Error loading experts/customers:', error);
  }
}

// Show create rule modal
function showCreateRuleModal() {
  currentRuleId = null;
  ruleAdvancedVisible = false;
  document.getElementById('rule-modal-title').textContent = 'Create Automated Action';
  document.getElementById('rule-form').reset();
  document.getElementById('rule-id').value = '';
  document.getElementById('rule-ai-interpreted').value = '0';
  document.getElementById('rule-ai-confidence').value = '';
  document.getElementById('rule-enabled').checked = true;
  document.getElementById('rule-instruction').value = '';
  document.getElementById('rule-action-type').value = '';
  document.getElementById('interpretation-result').style.display = 'none';
  document.getElementById('instruction-section').style.display = '';
  document.getElementById('advanced-fields').style.display = 'none';
  document.getElementById('toggle-advanced-btn').textContent = 'Edit Manually';
  document.getElementById('action-params-container').innerHTML = '';
  const modal = document.getElementById('rule-modal');
  modal.style.display = 'flex';
  modal.scrollTop = 0;
}

// Close rule modal
function closeRuleModal() {
  document.getElementById('rule-modal').style.display = 'none';
}

// Update action parameters based on selected action type
function updateActionParams() {
  const actionType = document.getElementById('rule-action-type').value;
  const container = document.getElementById('action-params-container');

  if (!actionType) {
    container.innerHTML = '';
    return;
  }

  let html = '';

  switch (actionType) {
    case 'delete':
      html = '<div class="subtitle" style="margin-top:8px">⚠️ This will permanently delete matching tickets</div>';
      break;

    case 'assign_to_expert':
      html = `
        <div class="mb-12">
          <label style="display:block;margin-bottom:4px;font-weight:600">Select Expert *</label>
          <select id="param-expert-id" class="input" required style="width:100%">
            <option value="">Choose an expert...</option>
            ${ruleExperts.map(expert => `<option value="${expert.id}">${expert.full_name || expert.username} (${expert.email})</option>`).join('')}
          </select>
        </div>
      `;
      break;

    case 'create_for_customer':
      html = `
        <div class="mb-12">
          <label style="display:block;margin-bottom:4px;font-weight:600">Select Customer *</label>
          <select id="param-customer-id" class="input" required style="width:100%">
            <option value="">Choose a customer...</option>
            ${ruleCustomers.map(customer => `<option value="${customer.id}">${customer.company_name || customer.full_name || customer.username} (${customer.email})</option>`).join('')}
          </select>
        </div>
      `;
      break;

    case 'set_priority':
      html = `
        <div class="mb-12">
          <label style="display:block;margin-bottom:4px;font-weight:600">Priority *</label>
          <select id="param-priority" class="input" required style="width:100%">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
      `;
      break;

    case 'set_status':
      html = `
        <div class="mb-12">
          <label style="display:block;margin-bottom:4px;font-weight:600">Status *</label>
          <select id="param-status" class="input" required style="width:100%">
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Pending">Pending</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>
        </div>
      `;
      break;

    case 'add_tag':
      html = `
        <div class="mb-12">
          <label style="display:block;margin-bottom:4px;font-weight:600">Tag *</label>
          <input type="text" id="param-tag" class="input" placeholder="e.g., auto-processed" required style="width:100%">
        </div>
      `;
      break;

    case 'add_to_monitoring':
      html = `
        <div class="subtitle" style="margin-top:8px">
          📊 This will classify the ticket as a system alert and mark it as a monitoring source.<br>
          <span style="color:#666;font-size:12px">The ticket will be tagged with source metadata indicating it came from a monitoring system.</span>
        </div>
      `;
      break;
  }

  container.innerHTML = html;
}

// Save rule (create or update)
async function saveRule(event) {
  event.preventDefault();

  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');
  const ruleId = document.getElementById('rule-id').value;

  const instructionText = document.getElementById('rule-instruction').value.trim();
  const searchText = document.getElementById('rule-search-text').value.trim();
  const actionType = document.getElementById('rule-action-type').value;

  // Validate: need either instruction or structured fields
  if (!instructionText && (!searchText || !actionType)) {
    alert('Please either describe the action using AI, or fill in the search text and action type manually.');
    return;
  }

  // Validate action_type is set (AI may have returned a value the select couldn't match)
  if (!actionType) {
    alert('Action type is missing. Please use "Review / Edit Fields" to set the action type before saving.');
    return;
  }

  // Gather form data
  const enabledCheckbox = document.getElementById('rule-enabled');
  const ruleData = {
    rule_name: document.getElementById('rule-name').value,
    description: document.getElementById('rule-description').value || null,
    instruction_text: instructionText || null,
    enabled: enabledCheckbox.checked,
    search_in: document.getElementById('rule-search-in').value,
    search_text: searchText || null,
    case_sensitive: document.getElementById('rule-case-sensitive').checked,
    action_type: actionType,
    action_params: getActionParams(),
    ai_interpreted: document.getElementById('rule-ai-interpreted').value === '1',
    ai_confidence: parseFloat(document.getElementById('rule-ai-confidence').value) || null
  };

  try {
    let url, method;
    if (ruleId) {
      url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/${ruleId}`;
      method = 'PUT';
    } else {
      url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}`;
      method = 'POST';
    }

    const response = await fetch(url, {
      method: method,
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(ruleData)
    });

    const data = await response.json();

    if (data.success) {
      closeRuleModal();
      await loadTicketRules();
      showToast(ruleId ? 'Action updated successfully!' : 'Action created successfully!', 'success');
    } else {
      alert('Failed to save action: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error saving rule:', error);
    alert('Error saving action: ' + error.message);
  }
}

// Get action parameters from form
function getActionParams() {
  const actionType = document.getElementById('rule-action-type').value;
  const params = {};

  switch (actionType) {
    case 'assign_to_expert':
      const expertId = document.getElementById('param-expert-id').value;
      params.expert_id = parseInt(expertId);
      const expert = ruleExperts.find(e => e.id === parseInt(expertId));
      if (expert) {
        params.expert_name = expert.full_name || expert.username;
      }
      break;

    case 'create_for_customer':
      params.customer_id = parseInt(document.getElementById('param-customer-id').value);
      break;

    case 'set_priority':
      params.priority = document.getElementById('param-priority').value;
      break;

    case 'set_status':
      params.status = document.getElementById('param-status').value;
      break;

    case 'add_tag':
      params.tag = document.getElementById('param-tag').value;
      break;
  }

  return params;
}

// Interpret instruction using AI
async function interpretInstruction() {
  const instruction = document.getElementById('rule-instruction').value.trim();
  if (!instruction) {
    alert('Please describe what this action should do.');
    return;
  }

  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');
  const btn = document.getElementById('interpret-btn');
  const origText = btn.textContent;

  btn.disabled = true;
  btn.textContent = 'Interpreting...';

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/interpret`;
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ instruction_text: instruction })
    });

    const data = await response.json();

    if (data.success && data.interpretation) {
      displayInterpretation(data.interpretation);
      populateStructuredFields(data.interpretation);
    } else {
      alert('Failed to interpret instruction: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error interpreting instruction:', error);
    alert('Error interpreting instruction: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = origText;
  }
}

// Display the AI interpretation result
function displayInterpretation(interp) {
  const resultDiv = document.getElementById('interpretation-result');
  const detailsDiv = document.getElementById('interpretation-details');
  const warningsDiv = document.getElementById('interpretation-warnings');
  const confidenceSpan = document.getElementById('interpretation-confidence');

  // Confidence badge
  const conf = Math.round((interp.confidence || 0) * 100);
  let confColor, confBg;
  if (conf >= 80) { confColor = '#166534'; confBg = '#dcfce7'; }
  else if (conf >= 50) { confColor = '#92400e'; confBg = '#fef3c7'; }
  else { confColor = '#991b1b'; confBg = '#fee2e2'; }
  confidenceSpan.textContent = `${conf}% confidence`;
  confidenceSpan.style.cssText = `padding:3px 8px;border-radius:12px;font-size:12px;font-weight:600;color:${confColor};background:${confBg}`;

  // Build readable summary
  const searchInLabel = {both: 'title or body', title: 'title', body: 'body'}[interp.search_in] || 'title or body';
  const actionLabels = {
    delete: 'Delete the ticket',
    assign_to_expert: 'Assign to expert' + (interp.action_params?.expert_name ? ` (${interp.action_params.expert_name})` : interp.action_params?.expert_id ? ` (ID: ${interp.action_params.expert_id})` : ''),
    create_for_customer: 'Create for customer',
    set_priority: `Set priority to ${interp.action_params?.priority || '?'}`,
    set_status: `Set status to ${interp.action_params?.status || '?'}`,
    add_tag: `Add tag "${interp.action_params?.tag || '?'}"`,
    add_to_monitoring: 'Add to system monitoring',
    set_sla_definition: 'Apply SLA definition'
  };

  detailsDiv.innerHTML = `
    <div style="margin-bottom:6px"><strong>Condition:</strong> When ${searchInLabel} contains "<em>${escapeHtml(interp.search_text || '')}</em>"${interp.case_sensitive ? ' (case sensitive)' : ''}</div>
    <div style="margin-bottom:6px"><strong>Action:</strong> ${actionLabels[interp.action_type] || interp.action_type}</div>
    ${interp.reasoning ? `<div style="margin-bottom:6px;color:#6b7280"><strong>Reasoning:</strong> ${escapeHtml(interp.reasoning)}</div>` : ''}
  `;

  // Warnings
  if (interp.warnings && interp.warnings.length > 0) {
    warningsDiv.style.display = '';
    warningsDiv.innerHTML = interp.warnings.map(w => `<div>⚠️ ${escapeHtml(w)}</div>`).join('');
  } else {
    warningsDiv.style.display = 'none';
  }

  resultDiv.style.display = '';
}

// Populate hidden structured fields from AI interpretation
function populateStructuredFields(interp) {
  document.getElementById('rule-ai-interpreted').value = '1';
  document.getElementById('rule-ai-confidence').value = interp.confidence || '';

  // Auto-fill name and description if empty
  if (!document.getElementById('rule-name').value && interp.rule_name) {
    document.getElementById('rule-name').value = interp.rule_name;
  }
  if (!document.getElementById('rule-description').value && interp.description) {
    document.getElementById('rule-description').value = interp.description;
  }

  // Fill structured fields
  document.getElementById('rule-search-in').value = interp.search_in || 'both';
  document.getElementById('rule-search-text').value = interp.search_text || '';
  document.getElementById('rule-case-sensitive').checked = !!interp.case_sensitive;

  // Set action type — add option dynamically if AI returned a value not in the select
  const actionSelect = document.getElementById('rule-action-type');
  const aiActionType = interp.action_type || '';
  if (aiActionType && !Array.from(actionSelect.options).some(o => o.value === aiActionType)) {
    const opt = document.createElement('option');
    opt.value = aiActionType;
    opt.textContent = aiActionType.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    actionSelect.appendChild(opt);
  }
  actionSelect.value = aiActionType;
  updateActionParams();

  // Populate action params after DOM update
  setTimeout(() => {
    if (interp.action_params) {
      switch (interp.action_type) {
        case 'assign_to_expert':
          if (interp.action_params.expert_id) {
            const el = document.getElementById('param-expert-id');
            if (el) el.value = interp.action_params.expert_id;
          }
          break;
        case 'create_for_customer':
          if (interp.action_params.customer_id) {
            const el = document.getElementById('param-customer-id');
            if (el) el.value = interp.action_params.customer_id;
          }
          break;
        case 'set_priority':
          if (interp.action_params.priority) {
            const el = document.getElementById('param-priority');
            if (el) el.value = interp.action_params.priority;
          }
          break;
        case 'set_status':
          if (interp.action_params.status) {
            const el = document.getElementById('param-status');
            if (el) el.value = interp.action_params.status;
          }
          break;
        case 'add_tag':
          if (interp.action_params.tag) {
            const el = document.getElementById('param-tag');
            if (el) el.value = interp.action_params.tag;
          }
          break;
      }
    }
  }, 100);
}

// Toggle advanced/manual edit fields
function toggleAdvancedEdit() {
  ruleAdvancedVisible = !ruleAdvancedVisible;
  document.getElementById('advanced-fields').style.display = ruleAdvancedVisible ? '' : 'none';
  document.getElementById('toggle-advanced-btn').textContent = ruleAdvancedVisible ? 'Hide Fields' : 'Edit Manually';
}

// Re-interpret instruction
function reinterpret() {
  document.getElementById('interpretation-result').style.display = 'none';
  interpretInstruction();
}

// Edit rule
async function editRule(ruleId) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/${ruleId}`;
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      const rule = data.rule;
      currentRuleId = ruleId;

      // Populate form
      document.getElementById('rule-modal-title').textContent = 'Edit Automated Action';
      document.getElementById('rule-id').value = rule.id;
      document.getElementById('rule-name').value = rule.rule_name;
      document.getElementById('rule-description').value = rule.description || '';
      document.getElementById('rule-enabled').checked = rule.enabled;
      document.getElementById('rule-search-in').value = rule.search_in || 'both';
      document.getElementById('rule-search-text').value = rule.search_text || '';
      document.getElementById('rule-case-sensitive').checked = rule.case_sensitive;
      document.getElementById('rule-action-type').value = rule.action_type;
      document.getElementById('rule-ai-interpreted').value = rule.ai_interpreted ? '1' : '0';
      document.getElementById('rule-ai-confidence').value = rule.ai_confidence || '';

      // Populate instruction text
      document.getElementById('rule-instruction').value = rule.instruction_text || '';
      document.getElementById('instruction-section').style.display = '';
      document.getElementById('interpretation-result').style.display = 'none';

      // For AI-interpreted rules or rules with data, show advanced fields
      ruleAdvancedVisible = true;
      document.getElementById('advanced-fields').style.display = '';
      document.getElementById('toggle-advanced-btn').textContent = 'Hide Fields';

      // Update action params
      updateActionParams();

      // Populate action params
      setTimeout(() => {
        if (rule.action_params) {
          switch (rule.action_type) {
            case 'assign_to_expert':
              if (rule.action_params.expert_id) {
                const el = document.getElementById('param-expert-id');
                if (el) el.value = rule.action_params.expert_id;
              }
              break;
            case 'create_for_customer':
              if (rule.action_params.customer_id) {
                const el = document.getElementById('param-customer-id');
                if (el) el.value = rule.action_params.customer_id;
              }
              break;
            case 'set_priority':
              if (rule.action_params.priority) {
                const el = document.getElementById('param-priority');
                if (el) el.value = rule.action_params.priority;
              }
              break;
            case 'set_status':
              if (rule.action_params.status) {
                const el = document.getElementById('param-status');
                if (el) el.value = rule.action_params.status;
              }
              break;
            case 'add_tag':
              if (rule.action_params.tag) {
                const el = document.getElementById('param-tag');
                if (el) el.value = rule.action_params.tag;
              }
              break;
          }
        }
      }, 100);

      // Show modal
      const modal = document.getElementById('rule-modal');
      modal.style.display = 'flex';
      modal.scrollTop = 0;
    } else {
      alert('Failed to load action details');
    }
  } catch (error) {
    console.error('Error loading rule:', error);
    alert('Error loading action: ' + error.message);
  }
}

// Delete rule
async function deleteRule(ruleId) {
  if (!confirm('Are you sure you want to delete this automated action? This cannot be undone.')) {
    return;
  }

  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/${ruleId}`;
    const response = await fetch(url, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      await loadTicketRules();
      alert('✅ Rule deleted successfully!');
    } else {
      alert('❌ Failed to delete rule: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error deleting rule:', error);
    alert('❌ Error deleting rule: ' + error.message);
  }
}

// Test rule
async function testRule(ruleId) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/${ruleId}/test`;
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      const matchingTickets = data.matching_tickets;
      const count = matchingTickets.length;

      if (count === 0) {
        alert('🔍 Test Results\n\nNo tickets match this rule.');
      } else {
        const ticketList = matchingTickets.slice(0, 10).map(t => `#${t.id}: ${t.title}`).join('\n');
        const more = count > 10 ? `\n... and ${count - 10} more` : '';
        alert(`🔍 Test Results\n\nThis rule would affect ${count} ticket(s):\n\n${ticketList}${more}`);
      }
    } else {
      alert('❌ Test failed: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error testing rule:', error);
    alert('❌ Error testing rule: ' + error.message);
  }
}

// Run rule on all matching tickets (background execution)
async function runRule(ruleId) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    // First test to get matching tickets count for confirmation
    const testUrl = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/${ruleId}/test`;
    const testResponse = await fetch(testUrl, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const testData = await testResponse.json();

    if (!testData.success) {
      alert('❌ Failed to test rule: ' + (testData.message || 'Unknown error'));
      return;
    }

    const matchingTickets = testData.matching_tickets;
    const count = matchingTickets.length;

    if (count === 0) {
      alert('ℹ️ No tickets match this rule. Nothing to execute.');
      return;
    }

    // Confirm execution
    const ticketPreview = matchingTickets.slice(0, 5).map(t => `#${t.id}: ${t.title}`).join('\n');
    const more = count > 5 ? `\n... and ${count - 5} more` : '';

    if (!confirm(`▶️ Run Rule\n\nThis will execute the rule on ${count} ticket(s):\n\n${ticketPreview}${more}\n\nThe rule will run in the background. You'll be notified when complete.\n\nProceed?`)) {
      return;
    }

    // Call background execution endpoint
    const runUrl = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/${ruleId}/run`;
    const runResponse = await fetch(runUrl, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const runData = await runResponse.json();

    if (runData.success && runData.started) {
      // Show toast notification
      showToast(`✅ Rule "${runData.rule_name}" started processing ${runData.ticket_count} tickets in background. Check notifications when complete.`, 'success', 5000);
    } else if (runData.success && !runData.started) {
      alert('ℹ️ No matching tickets found.');
    } else {
      alert('❌ Failed to start rule: ' + (runData.message || 'Unknown error'));
    }

  } catch (error) {
    console.error('Error running rule:', error);
    alert('❌ Error running rule: ' + error.message);
  }
}

// Show toast notification
function showToast(message, type = 'info', duration = 3000) {
  // Remove existing toast if any
  const existingToast = document.getElementById('toast-notification');
  if (existingToast) existingToast.remove();

  const bgColor = type === 'success' ? '#38a169' : type === 'error' ? '#e53e3e' : type === 'warning' ? '#d97706' : '#667eea';

  const toast = document.createElement('div');
  toast.id = 'toast-notification';
  toast.style.cssText = `
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: ${bgColor};
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 10001;
    max-width: 400px;
    font-size: 14px;
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;

  // Add animation keyframes if not exists
  if (!document.getElementById('toast-styles')) {
    const style = document.createElement('style');
    style.id = 'toast-styles';
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }

  document.body.appendChild(toast);

  // Auto remove after duration
  setTimeout(() => {
    toast.style.animation = 'slideIn 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// ============================================
// DEMO MODE FUNCTIONS
// ============================================
window.isDemoMode = false;
window.demoPersonas = [];

async function checkDemoMode() {
  try {
    const token = localStorage.getItem('token');
    if (!token) return;
    const resp = await fetch(API_BASE + '/api/demo/status', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!resp.ok) { window.isDemoMode = false; return; }
    const data = await resp.json();
    window.isDemoMode = data.demo === true;
    if (window.isDemoMode) {
      var banner = document.getElementById('demo-banner');
      if (banner) banner.style.display = 'block';
      await loadPersonas();
      if (data.personaKey) {
        var p = window.demoPersonas.find(function(x) { return x.persona_key === data.personaKey; });
        if (p) {
          var label = document.getElementById('demo-persona-label');
          if (label) label.textContent = 'Viewing as: ' + p.display_name;
        }
      }
    }
  } catch (e) { window.isDemoMode = false; }
}

async function loadPersonas() {
  try {
    var token = localStorage.getItem('token');
    var resp = await fetch(API_BASE + '/api/demo/personas', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!resp.ok) return;
    var data = await resp.json();
    if (!data.success || !data.personas) return;
    window.demoPersonas = data.personas;
    var sel = document.getElementById('persona-select');
    if (!sel) return;
    sel.innerHTML = '<option value="">Switch Persona...</option>';
    data.personas.forEach(function(p) {
      var opt = document.createElement('option');
      opt.value = p.persona_key;
      opt.textContent = p.display_name;
      if (p.description) opt.title = p.description;
      sel.appendChild(opt);
    });
    var switcher = document.getElementById('persona-switcher');
    if (switcher) switcher.style.display = 'block';
  } catch (e) { console.warn('Failed to load personas:', e); }
}

async function switchPersona(personaKey) {
  if (!personaKey) return;
  try {
    var token = localStorage.getItem('token');
    var resp = await fetch(API_BASE + '/api/demo/switch-persona', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ persona_key: personaKey })
    });
    var data = await resp.json();
    if (!data.success) { showToast(data.message || 'Failed to switch persona', 'error'); return; }
    localStorage.setItem('token', data.token);
    var persona = data.persona;
    localStorage.setItem('role', persona.role);
    localStorage.setItem('currentUser', JSON.stringify({
      username: persona.username, email: persona.email,
      fullName: persona.full_name, role: persona.role, tenantCode: 'demo'
    }));
    localStorage.setItem('username', persona.username);
    localStorage.setItem('loginRole', persona.role);
    var label = document.getElementById('demo-persona-label');
    if (label) label.textContent = 'Viewing as: ' + persona.display_name;
    showToast('Switched to ' + persona.display_name, 'success', 2000);
    setTimeout(function() { location.reload(); }, 500);
  } catch (e) { showToast('Failed to switch persona', 'error'); }
}

// Intercept fetch for demo simulated write toasts
(function() {
  var origFetch = window.fetch;
  window.fetch = function() {
    return origFetch.apply(this, arguments).then(function(response) {
      if (window.isDemoMode) {
        var cloned = response.clone();
        cloned.json().then(function(body) {
          if (body && body.demo_simulated === true) {
            showToast('DEMO MODE: Changes simulated. Updates will not take place.', 'warning', 4000);
          }
          if (body && body.demo_limit_reached === true) {
            showToast(body.message || 'DEMO MODE: Limit reached.', 'warning', 4000);
          }
        }).catch(function() {});
      }
      return response;
    });
  };
})();

// ============================================
// KNOWLEDGE BASE FUNCTIONS
// ============================================

let kbCategories = [];
let kbSearchTimeout = null;
let currentKBArticleId = null;

// Debounce KB search
function debounceKBSearch() {
  if (kbSearchTimeout) clearTimeout(kbSearchTimeout);
  kbSearchTimeout = setTimeout(() => loadKBArticles(), 300);
}

// Load KB categories
async function loadKBCategories() {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = `${API_BASE}/api/kb/${tenantCode}/categories`;
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();

    if (data.success) {
      kbCategories = data.categories;

      // Populate filter dropdown
      const filterSelect = document.getElementById('kb-category-filter');
      filterSelect.innerHTML = '<option value="">All Categories</option>' +
        kbCategories.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');

      // Populate modal dropdown
      const modalSelect = document.getElementById('kb-article-category');
      modalSelect.innerHTML = '<option value="">Select category...</option>' +
        kbCategories.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
    }
  } catch (error) {
    console.error('Error loading KB categories:', error);
  }
}

// Load KB stats
async function loadKBStats() {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = `${API_BASE}/api/kb/${tenantCode}/stats`;
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();

    if (data.success) {
      document.getElementById('kb-total-articles').textContent = data.stats.total_articles || 0;
      document.getElementById('kb-published-articles').textContent = data.stats.published_articles || 0;
      document.getElementById('kb-draft-articles').textContent = data.stats.draft_articles || 0;
      document.getElementById('kb-merge-suggestions').textContent = data.stats.merge_suggestions || 0;
    }
  } catch (error) {
    console.error('Error loading KB stats:', error);
  }
}

// Load KB articles
async function loadKBArticles() {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  const search = document.getElementById('kb-search').value;
  const category = document.getElementById('kb-category-filter').value;
  const status = document.getElementById('kb-status-filter').value;

  try {
    let url = `${API_BASE}/api/kb/${tenantCode}/articles?`;
    if (search) url += `search=${encodeURIComponent(search)}&`;
    if (category) url += `category_id=${category}&`;
    if (status) url += `status=${status}&`;

    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();

    if (data.success) {
      renderKBArticles(data.articles);
    } else {
      document.getElementById('kb-articles-list').innerHTML =
        '<tr><td colspan="7" class="subtitle" style="text-align:center">Error loading articles</td></tr>';
    }
  } catch (error) {
    console.error('Error loading KB articles:', error);
    document.getElementById('kb-articles-list').innerHTML =
      '<tr><td colspan="7" class="subtitle" style="text-align:center;color:#dc2626">Error loading articles</td></tr>';
  }
}

// Render KB articles table
function renderKBArticles(articles) {
  const tbody = document.getElementById('kb-articles-list');

  if (!articles || articles.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="subtitle" style="text-align:center">No articles found</td></tr>';
    return;
  }

  tbody.innerHTML = articles.map(article => {
    const statusBadge = {
      published: '<span class="badge status-active">Published</span>',
      draft: '<span class="badge status-warning">Draft</span>',
      archived: '<span class="badge status-cancelled">Archived</span>'
    }[article.status] || article.status;

    const helpfulRate = article.helpful_count + article.not_helpful_count > 0
      ? Math.round((article.helpful_count / (article.helpful_count + article.not_helpful_count)) * 100) + '%'
      : '--';

    return `
      <tr onclick="viewKBArticle(${article.id})" style="cursor:pointer">
        <td>
          <div style="font-weight:500">${escapeHtml(article.title)}</div>
          ${article.tags ? `<div class="subtitle" style="font-size:11px">${escapeHtml(article.tags)}</div>` : ''}
        </td>
        <td>${escapeHtml(article.category_name || 'Uncategorized')}</td>
        <td>${statusBadge}</td>
        <td>${article.view_count || 0}</td>
        <td>${helpfulRate}</td>
        <td>${formatDateTime(article.updated_at)}</td>
        <td>
          <button class="btn ghost" style="padding:4px 8px" onclick="event.stopPropagation(); editKBArticle(${article.id})">Edit</button>
          <button class="btn ghost" style="padding:4px 8px;color:#dc2626" onclick="event.stopPropagation(); deleteKBArticle(${article.id})">Delete</button>
        </td>
      </tr>
    `;
  }).join('');
}

// Show KB article modal for creating
function showKBArticleModal() {
  currentKBArticleId = null;
  document.getElementById('kb-article-modal-title').textContent = 'New Article';
  document.getElementById('kb-article-id').value = '';
  document.getElementById('kb-article-title').value = '';
  document.getElementById('kb-article-content').value = '';
  document.getElementById('kb-article-tags').value = '';
  document.getElementById('kb-article-category').value = '';
  document.getElementById('kb-article-status').value = 'draft';
  document.getElementById('kb-article-error').style.display = 'none';
  document.getElementById('kb-article-modal').style.display = 'flex';
}

// Close KB article modal
function closeKBArticleModal() {
  document.getElementById('kb-article-modal').style.display = 'none';
}

// Edit KB article
async function editKBArticle(articleId) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = `${API_BASE}/api/kb/${tenantCode}/articles/${articleId}`;
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();

    if (data.success) {
      const article = data.article;
      currentKBArticleId = article.id;
      document.getElementById('kb-article-modal-title').textContent = 'Edit Article';
      document.getElementById('kb-article-id').value = article.id;
      document.getElementById('kb-article-title').value = article.title;
      document.getElementById('kb-article-content').value = article.content;
      document.getElementById('kb-article-tags').value = article.tags || '';
      document.getElementById('kb-article-category').value = article.category_id || '';
      document.getElementById('kb-article-status').value = article.status;
      document.getElementById('kb-article-error').style.display = 'none';
      document.getElementById('kb-article-modal').style.display = 'flex';
    } else {
      alert('Error loading article: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error loading KB article:', error);
    alert('Error loading article');
  }
}

// Save KB article
async function saveKBArticle(asDraft = false) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');
  const errorEl = document.getElementById('kb-article-error');

  const articleId = document.getElementById('kb-article-id').value;
  const title = document.getElementById('kb-article-title').value.trim();
  const content = document.getElementById('kb-article-content').value.trim();
  const tags = document.getElementById('kb-article-tags').value.trim();
  const categoryId = document.getElementById('kb-article-category').value;
  let status = document.getElementById('kb-article-status').value;

  if (asDraft) status = 'draft';
  else if (status === 'draft') status = 'published';

  if (!title || !content) {
    errorEl.textContent = 'Title and content are required';
    errorEl.style.display = 'block';
    return;
  }

  try {
    const method = articleId ? 'PUT' : 'POST';
    const url = articleId
      ? `${API_BASE}/api/kb/${tenantCode}/articles/${articleId}`
      : `${API_BASE}/api/kb/${tenantCode}/articles`;

    const response = await fetch(url, {
      method,
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title,
        content,
        tags,
        category_id: categoryId || null,
        status
      })
    });

    const data = await response.json();

    if (data.success) {
      closeKBArticleModal();
      loadKBArticles();
      loadKBStats();
    } else {
      errorEl.textContent = data.error || 'Error saving article';
      errorEl.style.display = 'block';
    }
  } catch (error) {
    console.error('Error saving KB article:', error);
    errorEl.textContent = 'Error saving article';
    errorEl.style.display = 'block';
  }
}

// Delete KB article
async function deleteKBArticle(articleId) {
  if (!confirm('Are you sure you want to delete this article?')) return;

  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = `${API_BASE}/api/kb/${tenantCode}/articles/${articleId}`;
    const response = await fetch(url, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      loadKBArticles();
      loadKBStats();
    } else {
      alert('Error deleting article: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error deleting KB article:', error);
    alert('Error deleting article');
  }
}

// View KB article
async function viewKBArticle(articleId) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = `${API_BASE}/api/kb/${tenantCode}/articles/${articleId}`;
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();

    if (data.success) {
      const article = data.article;
      currentKBArticleId = article.id;
      document.getElementById('kb-view-title').textContent = article.title;
      document.getElementById('kb-view-meta').innerHTML = `
        <span class="badge">${escapeHtml(article.category_name || 'Uncategorized')}</span>
        <span style="margin-left:8px">👁️ ${article.view_count || 0} views</span>
        <span style="margin-left:8px">👍 ${article.helpful_count || 0}</span>
        <span style="margin-left:8px">👎 ${article.not_helpful_count || 0}</span>
      `;
      // Simple markdown rendering
      document.getElementById('kb-view-content').innerHTML = renderSimpleMarkdown(article.content);
      document.getElementById('kb-feedback-msg').style.display = 'none';
      document.getElementById('kb-article-view-modal').style.display = 'flex';
    } else {
      alert('Error loading article');
    }
  } catch (error) {
    console.error('Error viewing KB article:', error);
    alert('Error loading article');
  }
}

// Simple markdown renderer
function renderSimpleMarkdown(text) {
  if (!text) return '';
  return escapeHtml(text)
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code style="background:#f0f0f0;padding:2px 4px;border-radius:3px">$1</code>')
    .replace(/\n/g, '<br>');
}

// Close KB view modal
function closeKBViewModal() {
  document.getElementById('kb-article-view-modal').style.display = 'none';
}

// Edit from view modal
function editKBArticleFromView() {
  closeKBViewModal();
  if (currentKBArticleId) {
    editKBArticle(currentKBArticleId);
  }
}

// Submit KB feedback
async function submitKBFeedback(helpful) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  if (!currentKBArticleId) return;

  try {
    const url = `${API_BASE}/api/kb/${tenantCode}/articles/${currentKBArticleId}/feedback`;
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ helpful })
    });

    const data = await response.json();
    const msgEl = document.getElementById('kb-feedback-msg');

    if (data.success) {
      msgEl.textContent = 'Thank you for your feedback!';
      msgEl.style.color = '#16a34a';
    } else {
      msgEl.textContent = data.error || 'Error submitting feedback';
      msgEl.style.color = '#dc2626';
    }
    msgEl.style.display = 'block';
  } catch (error) {
    console.error('Error submitting KB feedback:', error);
  }
}

// Show KB merge modal
async function showKBMergeModal() {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  document.getElementById('kb-merge-modal').style.display = 'flex';
  document.getElementById('kb-merge-list').innerHTML = '<div class="subtitle" style="text-align:center">Loading suggestions...</div>';

  try {
    const url = `${API_BASE}/api/kb/${tenantCode}/merge-suggestions`;
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();

    if (data.success && data.suggestions.length > 0) {
      renderKBMergeSuggestions(data.suggestions);
    } else {
      document.getElementById('kb-merge-list').innerHTML =
        '<div class="subtitle" style="text-align:center">No merge suggestions found. Articles are sufficiently distinct.</div>';
    }
  } catch (error) {
    console.error('Error loading merge suggestions:', error);
    document.getElementById('kb-merge-list').innerHTML =
      '<div class="subtitle" style="text-align:center;color:#dc2626">Error loading suggestions</div>';
  }
}

// Render merge suggestions
function renderKBMergeSuggestions(suggestions) {
  const container = document.getElementById('kb-merge-list');

  container.innerHTML = suggestions.map(s => `
    <div class="card p-12 mb-12" style="border-left:4px solid #9f7aea">
      <div class="row space mb-8">
        <div>
          <div style="font-weight:600">${Math.round(s.similarity_score * 100)}% Similar</div>
          <div class="subtitle">Suggested for merge</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" onclick="mergeKBArticles(${s.article_id}, ${s.similar_article_id})">Merge</button>
          <button class="btn ghost" onclick="dismissMergeSuggestion(${s.id})">Dismiss</button>
        </div>
      </div>
      <div class="grid2">
        <div style="background:var(--bg);padding:12px;border-radius:8px">
          <div style="font-weight:500;margin-bottom:4px">${escapeHtml(s.article_title || 'Article #' + s.article_id)}</div>
          <div class="subtitle" style="font-size:11px">${escapeHtml((s.article_content || '').substring(0, 150))}...</div>
        </div>
        <div style="background:var(--bg);padding:12px;border-radius:8px">
          <div style="font-weight:500;margin-bottom:4px">${escapeHtml(s.similar_title || 'Article #' + s.similar_article_id)}</div>
          <div class="subtitle" style="font-size:11px">${escapeHtml((s.similar_content || '').substring(0, 150))}...</div>
        </div>
      </div>
    </div>
  `).join('');
}

// Close KB merge modal
function closeKBMergeModal() {
  document.getElementById('kb-merge-modal').style.display = 'none';
}

// Merge KB articles
async function mergeKBArticles(primaryId, secondaryId) {
  if (!confirm('Merge these articles? The secondary article will be archived.')) return;

  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = `${API_BASE}/api/kb/${tenantCode}/articles/${primaryId}/merge`;
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ secondary_article_id: secondaryId })
    });

    const data = await response.json();

    if (data.success) {
      showKBMergeModal(); // Refresh
      loadKBArticles();
      loadKBStats();
    } else {
      alert('Error merging articles: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error merging KB articles:', error);
    alert('Error merging articles');
  }
}

// Dismiss merge suggestion
async function dismissMergeSuggestion(suggestionId) {
  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = `${API_BASE}/api/kb/${tenantCode}/merge-suggestions/${suggestionId}`;
    const response = await fetch(url, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      showKBMergeModal(); // Refresh
      loadKBStats();
    } else {
      alert('Error dismissing suggestion');
    }
  } catch (error) {
    console.error('Error dismissing suggestion:', error);
  }
}

// Initialize KB view
function initKnowledgeBase() {
  loadKBCategories();
  loadKBStats();
  loadKBArticles();
}

// Load KB suggestions for current ticket
async function loadKBSuggestions() {
  const ticketId = window.currentTicketId;
  if (!ticketId) return;

  const tenantCode = window.tenant || 'apoyar';
  const token = localStorage.getItem('token');

  // Show loading state
  document.getElementById('kb-suggestions-loading').style.display = 'block';
  document.getElementById('kb-suggestions-empty').style.display = 'none';
  document.getElementById('kb-suggestions-list').style.display = 'none';

  try {
    const url = `${API_BASE}/api/kb/${tenantCode}/suggest-for-ticket/${ticketId}`;
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();

    document.getElementById('kb-suggestions-loading').style.display = 'none';

    if (data.success && data.suggestions && data.suggestions.length > 0) {
      renderKBSuggestions(data.suggestions);
      document.getElementById('kb-suggestions-badge').textContent = data.suggestions.length;
      document.getElementById('kb-suggestions-badge').style.display = 'inline-flex';
    } else {
      document.getElementById('kb-suggestions-empty').innerHTML = `
        <div style="font-size:32px;margin-bottom:8px;">📚</div>
        <div>No relevant KB articles found</div>
        <div style="font-size:12px;margin-top:4px;">Try creating a KB article for this topic</div>
      `;
      document.getElementById('kb-suggestions-empty').style.display = 'block';
      document.getElementById('kb-suggestions-badge').style.display = 'none';
    }
  } catch (error) {
    console.error('Error loading KB suggestions:', error);
    document.getElementById('kb-suggestions-loading').style.display = 'none';
    document.getElementById('kb-suggestions-empty').innerHTML = `
      <div style="color:#dc2626">Error loading suggestions</div>
    `;
    document.getElementById('kb-suggestions-empty').style.display = 'block';
  }
}

// Render KB suggestion cards
function renderKBSuggestions(suggestions) {
  const container = document.getElementById('kb-suggestions-list');

  container.innerHTML = suggestions.map(s => `
    <div class="card p-12 mb-8" style="border-left:4px solid #667eea;cursor:pointer" onclick="viewKBArticle(${s.id})">
      <div class="row space">
        <div>
          <div style="font-weight:500">${escapeHtml(s.title)}</div>
          <div class="subtitle" style="font-size:12px;margin-top:4px">${escapeHtml(s.summary || s.content?.substring(0, 100) + '...')}</div>
          <div class="row" style="gap:8px;margin-top:8px">
            <span class="badge">${escapeHtml(s.category || 'General')}</span>
            <span class="subtitle">👁️ ${s.view_count || 0} views</span>
            <span class="subtitle">👍 ${s.helpful_count || 0}</span>
          </div>
        </div>
        <div style="text-align:right">
          <div class="badge" style="background:#667eea;color:white">${Math.round((s.score || 0) * 100)}% match</div>
        </div>
      </div>
    </div>
  `).join('');

  container.style.display = 'block';
  document.getElementById('kb-suggestions-empty').style.display = 'none';
}

// ============================================================================
// ASSET VIEWER
// ============================================================================

let avDataTable = null;
let avSelectedAssetId = null;
let avCurrentAsset = null;
let avCurrentCustomFields = [];
let avEditMode = false;

async function initAssetViewer() {
  // Destroy existing DataTable if reinitializing
  if ($.fn.DataTable.isDataTable('#av-table')) {
    $('#av-table').DataTable().destroy();
    avDataTable = null;
  }

  const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
  if (!tenantCode) {
    document.querySelector('#av-table tbody').innerHTML =
      '<tr><td colspan="8" class="av-loading">No tenant selected</td></tr>';
    return;
  }

  const token = localStorage.getItem('token');

  // Initialize DataTable with AJAX
  avDataTable = $('#av-table').DataTable({
    ajax: {
      url: `${API_BASE}/api/cmdb/${tenantCode}/items`,
      dataSrc: function(json) {
        return json.success ? json.items : [];
      },
      beforeSend: function(xhr) {
        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
      }
    },
    columns: [
      { data: 'cmdb_id' },
      { data: 'asset_name' },
      { data: 'asset_category' },
      { data: 'brand_name', defaultContent: '' },
      { data: 'model_name', defaultContent: '' },
      { data: 'customer_name', defaultContent: '' },
      { data: 'asset_location', defaultContent: '' },
      {
        data: 'status',
        render: function(data) {
          const cls = data === 'active' ? 'success' : '';
          return `<span class="badge ${cls}">${data || ''}</span>`;
        }
      }
    ],
    pageLength: 25,
    order: [[1, 'asc']],
    language: {
      search: "Search:",
      lengthMenu: "Show _MENU_ assets",
      info: "Showing _START_ to _END_ of _TOTAL_ assets",
      infoEmpty: "No assets found",
      infoFiltered: "(filtered from _MAX_ total assets)",
      loadingRecords: "Loading assets...",
      zeroRecords: "No matching assets found"
    }
  });

  // Row click handler
  $('#av-table tbody').off('click', 'tr').on('click', 'tr', function() {
    if (!avDataTable) return;
    $('#av-table tbody tr').removeClass('selected');
    $(this).addClass('selected');
    const data = avDataTable.row(this).data();
    if (data) {
      avLoadDetail(data.cmdb_id);
    }
  });

  // Search event - update export info
  avDataTable.on('search.dt', function() {
    if (!avDataTable) return;
    const count = avDataTable.rows({ search: 'applied' }).count();
    const total = avDataTable.rows().count();
    document.getElementById('av-export-info').textContent =
      count === total ? 'Exports all assets' : `Exports ${count} filtered assets`;
  });
}

async function avLoadDetail(cmdbId) {
  avSelectedAssetId = cmdbId;
  document.getElementById('av-detail-panel').classList.add('active');
  document.getElementById('av-detail-content').innerHTML = '<div class="av-loading">Loading...</div>';

  const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
  const token = localStorage.getItem('token');

  try {
    // Fetch asset details and custom field values in parallel
    const [itemRes, customRes] = await Promise.all([
      fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${cmdbId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      }),
      fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${cmdbId}/custom-values`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
    ]);

    const itemData = await itemRes.json();
    const customData = await customRes.json();

    if (!itemData.success) {
      document.getElementById('av-detail-content').innerHTML =
        '<div class="av-loading">Error loading asset details</div>';
      return;
    }

    // Store current data for edit mode
    avCurrentAsset = itemData.item;
    avCurrentCustomFields = customData.success ? customData.fields : [];
    avEditMode = false;

    avRenderDetail(avCurrentAsset, avCurrentCustomFields);
  } catch (err) {
    document.getElementById('av-detail-content').innerHTML =
      '<div class="av-loading">Error loading asset details</div>';
  }
}

function avRenderDetail(asset, customFields) {
  let html = '';

  // Asset Information Section
  html += '<div class="av-section-header">Asset Information</div>';
  html += '<table class="av-detail-table">';

  const infoFields = [
    ['Asset Name', asset.asset_name],
    ['CMDB ID', asset.cmdb_id],
    ['Category', asset.asset_category],
    ['Brand', asset.brand_name],
    ['Model', asset.model_name],
    ['Customer', asset.customer_name],
    ['Employee Of', asset.employee_of],
    ['Location', asset.asset_location],
    ['Status', asset.status],
    ['Created', asset.created_at ? new Date(asset.created_at).toLocaleString() : ''],
    ['Updated', asset.updated_at ? new Date(asset.updated_at).toLocaleString() : '']
  ];

  for (const [label, value] of infoFields) {
    if (value) {
      html += `<tr><td>${label}:</td><td>${avEscapeHtml(value)}</td></tr>`;
    }
  }

  // Comment field with scrollable container
  if (asset.comment) {
    html += `<tr><td>Comment:</td><td><div class="av-comment-field">${avEscapeHtml(asset.comment)}</div></td></tr>`;
  }

  html += '</table>';

  // Custom Fields Section
  const nonEmptyFields = customFields.filter(f => f.value);
  if (nonEmptyFields.length > 0) {
    html += '<div class="av-section-header">Additional Asset Information</div>';
    html += '<table class="av-detail-table">';

    // Sort alphabetically by field label
    nonEmptyFields.sort((a, b) => (a.field_label || '').localeCompare(b.field_label || ''));

    for (const field of nonEmptyFields) {
      html += `<tr><td>${avEscapeHtml(field.field_label)}:</td><td>${avEscapeHtml(field.value)}</td></tr>`;
    }

    html += '</table>';
  }

  // Configuration Items Section
  if (asset.configuration_items && asset.configuration_items.length > 0) {
    html += `<div class="av-section-header">Configuration Items (${asset.configuration_items.length})</div>`;
    html += '<div class="av-ci-list">';

    for (const ci of asset.configuration_items) {
      html += `<div class="av-ci-item" onclick="avShowCIDetail(${ci.id})">
        <div class="av-ci-name">${avEscapeHtml(ci.ci_name || ci.ci_id)}</div>
        <div class="av-ci-meta">
          ${ci.brand_name ? `<span class="av-ci-type">${avEscapeHtml(ci.brand_name)}</span>` : ''}
          ${ci.model_name ? `<span class="av-ci-type">${avEscapeHtml(ci.model_name)}</span>` : ''}
          <span class="badge ${ci.status === 'active' ? 'success' : ''}">${avEscapeHtml(ci.status || '')}</span>
        </div>
      </div>`;
    }

    html += '</div>';
  }

  document.getElementById('av-detail-title').textContent = asset.asset_name || 'Asset Details';
  document.getElementById('av-detail-content').innerHTML = html;
}

function avEscapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML.replace(/\n/g, '<br>');
}

function avEnterEditMode() {
  if (!avCurrentAsset) return;
  avEditMode = true;
  document.getElementById('av-edit-btn').style.display = 'none';
  avRenderEditForm(avCurrentAsset);
}

function avRenderEditForm(asset) {
  let html = '<div class="av-edit-form">';
  html += '<div class="av-section-header">Edit Asset</div>';

  // Asset Name
  html += `<div class="av-form-group">
    <label>Asset Name *</label>
    <input type="text" id="av-edit-asset_name" value="${avEscapeAttr(asset.asset_name || '')}" required>
  </div>`;

  // Category
  html += `<div class="av-form-group">
    <label>Category</label>
    <input type="text" id="av-edit-asset_category" value="${avEscapeAttr(asset.asset_category || '')}">
  </div>`;

  // Brand
  html += `<div class="av-form-group">
    <label>Brand</label>
    <input type="text" id="av-edit-brand_name" value="${avEscapeAttr(asset.brand_name || '')}">
  </div>`;

  // Model
  html += `<div class="av-form-group">
    <label>Model</label>
    <input type="text" id="av-edit-model_name" value="${avEscapeAttr(asset.model_name || '')}">
  </div>`;

  // Customer
  html += `<div class="av-form-group">
    <label>Customer</label>
    <input type="text" id="av-edit-customer_name" value="${avEscapeAttr(asset.customer_name || '')}">
  </div>`;

  // Employee Of
  html += `<div class="av-form-group">
    <label>Employee Of</label>
    <input type="text" id="av-edit-employee_of" value="${avEscapeAttr(asset.employee_of || '')}">
  </div>`;

  // Location
  html += `<div class="av-form-group">
    <label>Location</label>
    <input type="text" id="av-edit-asset_location" value="${avEscapeAttr(asset.asset_location || '')}">
  </div>`;

  // Status
  html += `<div class="av-form-group">
    <label>Status</label>
    <select id="av-edit-status">
      <option value="active" ${asset.status === 'active' ? 'selected' : ''}>Active</option>
      <option value="inactive" ${asset.status === 'inactive' ? 'selected' : ''}>Inactive</option>
      <option value="retired" ${asset.status === 'retired' ? 'selected' : ''}>Retired</option>
      <option value="maintenance" ${asset.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
    </select>
  </div>`;

  // Comment
  html += `<div class="av-form-group">
    <label>Comment</label>
    <textarea id="av-edit-comment">${avEscapeAttr(asset.comment || '')}</textarea>
  </div>`;

  // Action buttons
  html += `<div class="av-form-actions">
    <button class="av-cancel-btn" onclick="avCancelEdit()">Cancel</button>
    <button class="av-save-btn" id="av-save-btn" onclick="avSaveAsset()">💾 Save Changes</button>
  </div>`;

  html += '</div>';

  document.getElementById('av-detail-title').textContent = 'Edit: ' + (asset.asset_name || 'Asset');
  document.getElementById('av-detail-content').innerHTML = html;
}

function avEscapeAttr(text) {
  if (!text) return '';
  return String(text).replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function avCancelEdit() {
  avEditMode = false;
  document.getElementById('av-edit-btn').style.display = '';
  if (avCurrentAsset) {
    avRenderDetail(avCurrentAsset, avCurrentCustomFields);
  }
}

function avShowCIDetail(ciId) {
  if (!avCurrentAsset || !avCurrentAsset.configuration_items) return;

  const ci = avCurrentAsset.configuration_items.find(c => c.id === ciId);
  if (!ci) return;

  let html = '';

  // Back button and CI name
  html += `<div class="av-ci-detail">
    <div class="av-ci-detail-header">
      <span class="av-ci-detail-title">${avEscapeHtml(ci.ci_name || ci.ci_id)}</span>
      <button class="av-ci-back-btn" onclick="avRenderDetail(avCurrentAsset, avCurrentCustomFields)">← Back to Asset</button>
    </div>
  </div>`;

  // CI Information Section
  html += '<div class="av-section-header">Configuration Item Details</div>';
  html += '<table class="av-detail-table">';

  const ciFields = [
    ['CI ID', ci.ci_id],
    ['CI Name', ci.ci_name],
    ['Category', ci.asset_category],
    ['Category Value', ci.category_field_value],
    ['Brand', ci.brand_name],
    ['Model', ci.model_name],
    ['Serial Number', ci.serial_number],
    ['Location', ci.asset_location],
    ['Employee Of', ci.employee_of],
    ['Status', ci.status],
    ['Created', ci.created_at ? new Date(ci.created_at).toLocaleString() : ''],
    ['Updated', ci.updated_at ? new Date(ci.updated_at).toLocaleString() : '']
  ];

  for (const [label, value] of ciFields) {
    if (value) {
      html += `<tr><td>${label}:</td><td>${avEscapeHtml(value)}</td></tr>`;
    }
  }

  // Comment
  if (ci.comment) {
    html += `<tr><td>Comment:</td><td><div class="av-comment-field">${avEscapeHtml(ci.comment)}</div></td></tr>`;
  }

  html += '</table>';

  document.getElementById('av-detail-title').textContent = ci.ci_name || ci.ci_id || 'CI Details';
  document.getElementById('av-detail-content').innerHTML = html;
  document.getElementById('av-edit-btn').style.display = 'none'; // Hide edit for CI view
}

async function avSaveAsset() {
  const btn = document.getElementById('av-save-btn');
  btn.disabled = true;
  btn.textContent = '⏳ Saving...';

  const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
  const token = localStorage.getItem('token');

  const payload = {
    asset_name: document.getElementById('av-edit-asset_name').value.trim(),
    asset_category: document.getElementById('av-edit-asset_category').value.trim(),
    brand_name: document.getElementById('av-edit-brand_name').value.trim(),
    model_name: document.getElementById('av-edit-model_name').value.trim(),
    customer_name: document.getElementById('av-edit-customer_name').value.trim(),
    employee_of: document.getElementById('av-edit-employee_of').value.trim(),
    asset_location: document.getElementById('av-edit-asset_location').value.trim(),
    status: document.getElementById('av-edit-status').value,
    comment: document.getElementById('av-edit-comment').value.trim()
  };

  if (!payload.asset_name) {
    alert('Asset Name is required');
    btn.disabled = false;
    btn.textContent = '💾 Save Changes';
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${avSelectedAssetId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {
      // Update stored data
      avCurrentAsset = data.item;
      avEditMode = false;
      document.getElementById('av-edit-btn').style.display = '';

      // Refresh the detail view
      avRenderDetail(avCurrentAsset, avCurrentCustomFields);

      // Refresh the DataTable to show updated data
      if (avDataTable) {
        avDataTable.ajax.reload(null, false);
      }
    } else {
      alert('Error saving: ' + (data.message || 'Unknown error'));
      btn.disabled = false;
      btn.textContent = '💾 Save Changes';
    }
  } catch (err) {
    console.error('Save error:', err);
    alert('Error saving asset. Please try again.');
    btn.disabled = false;
    btn.textContent = '💾 Save Changes';
  }
}

function avCloseDetail() {
  document.getElementById('av-detail-panel').classList.remove('active');
  $('#av-table tbody tr').removeClass('selected');
  avSelectedAssetId = null;
  avCurrentAsset = null;
  avCurrentCustomFields = [];
  avEditMode = false;
  document.getElementById('av-edit-btn').style.display = '';
}

async function avExportCSV() {
  if (!avDataTable) {
    alert('Please wait for assets to load');
    return;
  }
  const filteredData = avDataTable.rows({ search: 'applied' }).data().toArray();

  if (filteredData.length === 0) {
    alert('No assets to export');
    return;
  }

  const btn = document.getElementById('av-export-btn');
  const info = document.getElementById('av-export-info');
  btn.disabled = true;
  btn.innerHTML = '⏳ Exporting...';
  info.textContent = `Exporting ${filteredData.length} assets...`;

  const tenantCode = window.tenant || tenant || localStorage.getItem('tenantCode');
  const token = localStorage.getItem('token');

  try {
    // Build CSV from filtered data
    const headers = ['CMDB ID', 'Asset Name', 'Category', 'Brand', 'Model', 'Customer', 'Employee Of', 'Location', 'Status', 'Comment'];
    let csv = headers.join(',') + '\n';

    for (const asset of filteredData) {
      const row = [
        asset.cmdb_id || '',
        asset.asset_name || '',
        asset.asset_category || '',
        asset.brand_name || '',
        asset.model_name || '',
        asset.customer_name || '',
        asset.employee_of || '',
        asset.asset_location || '',
        asset.status || '',
        (asset.comment || '').replace(/"/g, '""').replace(/\n/g, ' ')
      ].map(v => `"${v}"`);
      csv += row.join(',') + '\n';
    }

    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cmdb_export_${tenantCode}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    a.remove();

    btn.disabled = false;
    btn.innerHTML = '📥 Export to CSV';
    info.textContent = `Exported ${filteredData.length} assets successfully`;
  } catch (err) {
    console.error('Export error:', err);
    btn.disabled = false;
    btn.innerHTML = '📥 Export to CSV';
    info.textContent = 'Export failed. Please try again.';
  }
}


  </script>
<script>
// Register Service Worker for PWA - TEMPORARILY DISABLED FOR DEBUGGING
// if ("serviceWorker" in navigator) {
//   window.addEventListener("load", function() {
//     navigator.serviceWorker.register("/sw.js")
//       .then(function(registration) {
//         console.log("[PWA] ServiceWorker registered:", registration.scope);
//       })
//       .catch(function(error) {
//         console.log("[PWA] ServiceWorker registration failed:", error);
//       });
//   });
// }
// Unregister any existing service workers AND clear all caches
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.getRegistrations().then(function(registrations) {
    for (let registration of registrations) {
      registration.unregister();
      console.log("[PWA] ServiceWorker unregistered for debugging");
    }
  });
}
// Clear all browser caches
if ('caches' in window) {
  caches.keys().then(function(cacheNames) {
    cacheNames.forEach(function(cacheName) {
      caches.delete(cacheName);
      console.log("[Cache] Cleared cache:", cacheName);
    });
  });
}

// Ionic Menu Functions
function openIonicMenu() {
  const menu = document.querySelector('ion-menu');
  if (menu) menu.open();
}

function closeIonicMenu() {
  const menu = document.querySelector('ion-menu');
  if (menu) menu.close();
}

function toggleIonicCmdb() {
  const subs = document.getElementById('ionic-cmdb-subitems');
  const chev = document.getElementById('ionic-cmdb-chev');
  if (!subs) return;
  const isOpen = subs.style.display !== 'none';
  subs.style.display = isOpen ? 'none' : 'block';
  if (chev) chev.style.transform = isOpen ? '' : 'rotate(90deg)';
}

function toggleIonicAdminSettings() {
  const subs = document.getElementById('ionic-admin-settings-subitems');
  const chev = document.getElementById('ionic-admin-settings-chev');
  if (!subs) return;
  const isOpen = subs.style.display !== 'none';
  subs.style.display = isOpen ? 'none' : 'block';
  if (chev) chev.style.transform = isOpen ? '' : 'rotate(90deg)';
}

function ionicNav(view) {
  // Use the existing switchView function for navigation
  if (typeof switchView === 'function') {
    switchView(view);
    // Render dashboards when navigating to dash
    if (view === 'dash' && typeof renderAllDashboards === 'function') {
      renderAllDashboards();
    }
  }
}

// Update Ionic menu based on user role
function updateIonicMenu() {
  const role = window.role || window.currentRole;
  const menuItems = document.querySelectorAll('#ionic-menu-list ion-item');

  menuItems.forEach(item => {
    const label = item.querySelector('ion-label');
    if (!label) return;

    const text = label.textContent;

    // Hide admin-only items for non-admin users
    if (role === 'customer') {
      if (['Manage Experts', 'Manage Customers', 'CMDB', 'Settings'].includes(text)) {
        item.style.display = 'none';
      } else {
        item.style.display = '';
      }
    } else if (role === 'expert') {
      if (['Manage Experts', 'Manage Customers', 'Settings'].includes(text)) {
        item.style.display = 'none';
      } else {
        item.style.display = '';
      }
    } else {
      item.style.display = '';
    }
  });
}
</script>
<!-- Ionicons for Ionic menu icons -->
<script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@7/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://cdn.jsdelivr.net/npm/ionicons@7/dist/ionicons/ionicons.js"></script>
</div><!-- End main-content -->
</ion-app>
<script>
// Fix Ionic's body styles that break scrolling
function fixBodyScroll() {
  const b = document.body;
  const h = document.documentElement;
  const ionApp = document.querySelector('ion-app');
  const mainContent = document.getElementById('main-content');

  // Force html to be scrollable container
  h.style.setProperty('height', '100%', 'important');
  h.style.setProperty('overflow-y', 'scroll', 'important');

  // Force body to fill and allow content to determine height
  b.style.setProperty('position', 'relative', 'important');
  b.style.setProperty('min-height', '100%', 'important');
  b.style.setProperty('height', 'auto', 'important');
  b.style.setProperty('max-height', 'none', 'important');
  b.style.setProperty('overflow', 'visible', 'important');
  b.style.setProperty('width', 'auto', 'important');
  b.style.setProperty('max-width', 'none', 'important');

  // Force ion-app to be in flow and sized by content
  if (ionApp) {
    ionApp.style.setProperty('position', 'relative', 'important');
    ionApp.style.setProperty('display', 'block', 'important');
    ionApp.style.setProperty('overflow', 'visible', 'important');
    ionApp.style.setProperty('height', 'auto', 'important');
    ionApp.style.setProperty('min-height', '100vh', 'important');
    ionApp.style.setProperty('contain', 'none', 'important');
  }

  // Force main-content to show content
  if (mainContent) {
    mainContent.style.setProperty('overflow', 'visible', 'important');
    mainContent.style.setProperty('height', 'auto', 'important');
  }
}
fixBodyScroll();
window.addEventListener('load', fixBodyScroll);
setTimeout(fixBodyScroll, 100);
setTimeout(fixBodyScroll, 500);
setTimeout(fixBodyScroll, 1000);
// Watch for style changes
const observer = new MutationObserver(fixBodyScroll);
observer.observe(document.body, { attributes: true, attributeFilter: ['style'] });
if (document.querySelector('ion-app')) {
  observer.observe(document.querySelector('ion-app'), { attributes: true, attributeFilter: ['style'] });
}

/* ── Walkthrough Tour ── */
const wtSteps = [
  // Section 1: Welcome + Sidebar
  { sel:null, pos:'center', title:'Welcome to ServiFlow', body:'This is your Dashboard — a real-time overview of tickets, SLA health, and key metrics. Let\'s take a quick tour of the main areas.' },
  { sel:'.leftnav', pos:'right', title:'Sidebar Navigation', body:'Use the sidebar to move between sections. The menu adapts to your role — admins, experts, and customers each see relevant options.' },

  // Section 2: Dashboard deep-dive
  { sel:'#dash-admin > .card', pos:'bottom', title:'Quick Admin', body:'Shortcut buttons for the most common admin tasks — manage experts and customers, open the CMDB, view all tickets, adjust settings, or launch Power Search.' },
  { sel:'#dash-admin .grid4', pos:'bottom', title:'Dashboard Stats', body:'Live KPIs at a glance: <b>Open Tickets</b>, <b>SLA at Risk</b>, <b>CMDB Items</b>, and <b>Resolved Today</b>. Click any card to jump straight to a filtered view.' },
  { sel:'#ai-trends-panel', pos:'bottom', title:'AI Insights & Trends', body:'Claude AI analyses recent tickets for patterns, critical issues, and emerging trends. Use the <b>period selector</b> to change the time window and hit <b>Refresh</b> to get the latest analysis.' },
  { sel:'#feedback-avg-rating', pos:'bottom', title:'Customer Satisfaction', body:'Track your support quality — average rating, total feedback count, star-rating distribution, and recent comments from resolved tickets.' },

  // Section 3: Sidebar features
  { sel:'[data-target="tickets"]', pos:'right', title:'Tickets', body:'View, filter, and manage all support tickets here. Track status, SLA timers, and assignment at a glance.' },
  { sel:'[data-target="raise"]', pos:'right', title:'Raise a Request', body:'Create a new support request with priority, category, and attachments. Tickets are automatically routed based on your processing rules.' },
  { sel:'[data-target="knowledge-base"]', pos:'right', title:'Knowledge Base', body:'Browse and search help articles. Admins can create and organise content so customers and experts find answers fast.' },
  { sel:'[data-target="analytics"]', pos:'right', title:'Analytics', body:'Charts and tables that show ticket volumes, SLA compliance, resolution times, and trends over time.' },

  // Section 4: Ticket processing workflow (centered)
  { sel:null, pos:'center', title:'Ticket List', body:'The ticket list gives you a <b>filter bar</b> (status, priority, assignee, company), <b>search</b>, <b>sort</b>, and <b>bulk actions</b>. The list auto-refreshes so you always see the latest state. Click any ticket to open its detail view.' },
  { sel:null, pos:'center', title:'Ticket Detail', body:'The detail view shows the full ticket — title, description, priority, <b>SLA timer</b>, and a complete <b>activity feed</b>. Action buttons let you progress the ticket through its lifecycle.' },
  { sel:null, pos:'center', title:'AI Assist', body:'One-click <b>AI analysis</b> generates a summary, urgency &amp; complexity scores, a draft response, suggested next steps, and automatic <b>CMDB matches</b> — so you can resolve tickets faster.' },
  { sel:null, pos:'center', title:'Ticket Lifecycle', body:'Tickets flow through <b>Open → In Progress → Resolved → Closed</b>. Self-assign, reassign, add internal notes, or reply directly to customers. SLA timers track both <b>response</b> and <b>resolution</b> targets.' },

  // Section 5: Wrap-up
  { sel:null, pos:'center', title:'You\'re All Set!', body:'That covers the essentials. Click the <b>? Help</b> button in the top bar any time to replay this tour. For detailed documentation, visit <a href="/docs.html" target="_blank" style="color:var(--primary)">the Documentation page</a>.' }
];
let wtIdx = 0;

function wtFindVisible(sel) {
  if (!sel) return null;
  const els = document.querySelectorAll(sel);
  for (const el of els) { if (el.offsetParent !== null) return el; }
  return null;
}

function wtGetOffset() {
  // Canvas & tooltip are position:fixed inside ion-app which creates a new
  // containing block (contain/transform). getBoundingClientRect() returns
  // viewport coords, but style.left/top and canvas drawing use containing-
  // block coords. Subtract the canvas origin to convert.
  const c = document.getElementById('wt-overlay');
  const r = c.getBoundingClientRect();
  return { x: r.left, y: r.top, w: r.width, h: r.height };
}

function wtDrawSpotlight(rect) {
  const c = document.getElementById('wt-overlay');
  const o = wtGetOffset();
  c.width = o.w;
  c.height = o.h;
  const ctx = c.getContext('2d');
  ctx.clearRect(0, 0, c.width, c.height);
  ctx.fillStyle = 'rgba(0,0,0,.55)';
  ctx.fillRect(0, 0, c.width, c.height);
  if (rect) {
    const p = 6, r = 8;
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    // Convert viewport coords to canvas coords
    const x = rect.left - o.x - p, y = rect.top - o.y - p, w = rect.width + p * 2, h = rect.height + p * 2;
    ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r); ctx.arcTo(x, y, x + w, y, r); ctx.closePath();
    ctx.fill();
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = 'rgba(255,255,255,.35)'; ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r); ctx.arcTo(x, y, x + w, y, r); ctx.closePath();
    ctx.stroke();
  }
}

function wtPosition(rect, pos) {
  const tt = document.getElementById('wt-tooltip');
  tt.style.display = 'block';
  const o = wtGetOffset();
  const tw = tt.offsetWidth, th = tt.offsetHeight;
  let left, top; // viewport coords
  if (!rect || pos === 'center') {
    left = o.x + (o.w - tw) / 2;
    top = o.y + (o.h - th) / 2;
  } else if (pos === 'right') {
    left = rect.right + 14;
    top = rect.top + (rect.height - th) / 2;
    // If tooltip goes off right edge, try left side
    if (left + tw > o.x + o.w - 8) left = rect.left - tw - 14;
  } else {
    left = rect.left;
    top = rect.bottom + 14;
    // If tooltip goes off bottom, try above
    if (top + th > o.y + o.h - 8) top = rect.top - th - 14;
  }
  left = Math.max(o.x + 8, Math.min(left, o.x + o.w - tw - 8));
  top = Math.max(o.y + 8, Math.min(top, o.y + o.h - th - 8));
  // Convert viewport coords to containing-block coords for style
  tt.style.left = (left - o.x) + 'px';
  tt.style.top = (top - o.y) + 'px';
}

function wtShowStep() {
  const s = wtSteps[wtIdx];
  document.getElementById('wt-title').textContent = s.title;
  document.getElementById('wt-body').innerHTML = s.body;
  document.getElementById('wt-counter').textContent = 'Step ' + (wtIdx + 1) + ' of ' + wtSteps.length;
  document.getElementById('wt-back').style.display = wtIdx === 0 ? 'none' : '';
  document.getElementById('wt-next').textContent = wtIdx === wtSteps.length - 1 ? 'Done' : 'Next';
  const el = wtFindVisible(s.sel);
  // Scroll sidebar target into view before measuring
  if (el) {
    el.scrollIntoView({ block: 'nearest', behavior: 'instant' });
  }
  const rect = el ? el.getBoundingClientRect() : null;
  // If element is off-screen (below or above viewport), skip spotlight
  const offScreen = rect && (rect.bottom < 0 || rect.top > window.innerHeight);
  wtDrawSpotlight(offScreen ? null : rect);
  wtPosition(offScreen ? null : rect, offScreen ? 'center' : s.pos);
}

function wtNext() { if (wtIdx < wtSteps.length - 1) { wtIdx++; wtShowStep(); } else { endWalkthrough(); } }
function wtBack() { if (wtIdx > 0) { wtIdx--; wtShowStep(); } }

/* ── Help menu ── */
function toggleHelpMenu(e) {
  e.stopPropagation();
  const m = document.getElementById('help-menu');
  if (!m) return;
  const show = m.style.display === 'none';
  m.style.display = show ? 'block' : 'none';
  if (show) {
    // Close on outside click
    setTimeout(() => document.addEventListener('click', closeHelpMenu, { once: true }), 0);
  }
}
function closeHelpMenu() {
  const m = document.getElementById('help-menu');
  if (m) m.style.display = 'none';
}
function helpMenuAction(action) {
  closeHelpMenu();
  if (action === 'tour') startWalkthrough();
  else if (action === 'manual') window.open('/docs.html', '_blank');
}

function startWalkthrough() {
  wtIdx = 0;
  // Ensure sidebar is visible so walkthrough targets are reachable
  const container = document.querySelector('.container');
  if (container && container.classList.contains('sidebar-collapsed')) {
    container.classList.remove('sidebar-collapsed');
    localStorage.setItem('serviflow.sidebarCollapsed', '0');
  }
  if (document.body.classList.contains('fullscreen-mode')) {
    exitFullscreen();
  }
  // Make sidebar scrollable during walkthrough so items can scroll into view
  const leftnav = document.querySelector('.leftnav');
  if (leftnav) {
    leftnav.style.maxHeight = 'calc(100vh - 80px)';
    leftnav.style.overflowY = 'auto';
  }
  // Scroll to top of page
  window.scrollTo({ top: 0, behavior: 'instant' });
  document.getElementById('wt-overlay').style.display = 'block';
  document.getElementById('wt-tooltip').style.display = 'block';
  wtShowStep();
}

function endWalkthrough() {
  document.getElementById('wt-overlay').style.display = 'none';
  document.getElementById('wt-tooltip').style.display = 'none';
  localStorage.setItem('walkthrough_done', '1');
  // Restore sidebar styles
  const leftnav = document.querySelector('.leftnav');
  if (leftnav) {
    leftnav.style.maxHeight = '';
    leftnav.style.overflowY = '';
  }
}

window.addEventListener('resize', function() {
  if (document.getElementById('wt-overlay').style.display === 'block') wtShowStep();
});
</script>
</body>
</html>
