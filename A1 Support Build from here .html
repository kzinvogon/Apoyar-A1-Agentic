<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ServiFlow â€” Support Platform</title>
<!-- PWA Meta Tags -->
<meta name="description" content="ServiFlow - Full-featured support ticket management platform with AI-powered insights"/>
<meta name="theme-color" content="#003366"/>
<meta name="mobile-web-app-capable" content="yes"/>
<!-- iOS PWA Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="ServiFlow"/>
<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json"/>
<!-- Icons -->
<link rel="icon" type="image/svg+xml" href="/icons/icon.svg"/>
<link rel="apple-touch-icon" href="/icons/icon-180x180.png"/>
<link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png"/>
<link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png"/>
<link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-167x167.png"/>
<!-- iOS Splash Screens -->
<link rel="apple-touch-startup-image" href="/icons/splash-1170x2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1284x2778.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1290x2796.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1179x2556.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)"/>
<link rel="apple-touch-startup-image" href="/icons/splash-1620x2160.png" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2)"/>
<!-- Changelog:
vNext-FULL-ActionsSLA: 
- ADDED mandatory completion text modal for Admin/Expert when resolving or reassigning.
- KEPT status transitions, live SLA timers, 3 role dashboards, CMDB, Raise, Experts, Customers, Wizard, Chat.
- NONâ€‘DESTRUCTIVE: prior flows preserved.
-->
<style>
  :root{--bg:#fafafa;--card:#ffffff;--ink:#1a1a1a;--muted:#717171;--primary:#1a1a1a;--primary-dark:#000000;--accent:#1a1a1a;--danger:#dc2626;--warn:#ca8a04;--ok:#16a34a;--radius:8px;--shadow:0 1px 2px rgba(0,0,0,.04);--shadow-lg:0 2px 8px rgba(0,0,0,.08);--border:#e5e5e5;--card-hover:#f5f5f5;--table-header:#fafafa;--input-bg:#ffffff;--topnav-bg:#ffffff;--logo-bg:#1a1a1a;--logo-text:#ffffff;--avatar-bg:#1a1a1a;--badge-bg:#fafafa}

  /* Dark Mode */
  body.dark-mode{--bg:#0a0a0a;--card:#141414;--ink:#f5f5f5;--muted:#a3a3a3;--primary:#ffffff;--primary-dark:#e5e5e5;--accent:#ffffff;--border:#262626;--card-hover:#1f1f1f;--table-header:#141414;--input-bg:#1a1a1a;--topnav-bg:#0a0a0a;--logo-bg:#ffffff;--logo-text:#0a0a0a;--avatar-bg:#ffffff;--badge-bg:#1a1a1a}

  *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--ink);padding-top:56px;transition:background .2s,color .2s}

  /* Clean Top Navigation */
  .topnav{position:fixed;top:0;left:0;right:0;height:56px;background:var(--topnav-bg);border-bottom:1px solid var(--border);z-index:100;display:flex;align-items:center;padding:0 24px;transition:background .2s,border-color .2s}
  .topnav-inner{max-width:1200px;width:100%;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
  .topnav-brand{display:flex;align-items:center;gap:10px;text-decoration:none}
  .topnav-brand .logo-icon{width:32px;height:32px;flex-shrink:0}
  .topnav-brand .logo-icon svg{width:100%;height:100%;display:block}
  .topnav-brand .logo-icon svg rect{fill:var(--logo-bg);transition:fill .2s}
  .topnav-brand .logo-icon svg text{fill:var(--logo-text);transition:fill .2s}
  .topnav-brand span{font-weight:600;font-size:16px;color:var(--ink);letter-spacing:-.3px}
  .topnav-right{display:flex;align-items:center;gap:12px}
  .topnav-user{display:flex;align-items:center;gap:8px;padding:4px 10px 4px 4px;border:1px solid var(--border);border-radius:999px;cursor:pointer;transition:all .15s}
  .topnav-user:hover{background:var(--card-hover)}
  .topnav-avatar{width:28px;height:28px;border-radius:999px;background:var(--avatar-bg);display:flex;align-items:center;justify-content:center;color:var(--logo-text);font-weight:500;font-size:12px;transition:background .2s}
  .topnav-name{font-weight:500;font-size:13px;color:var(--ink)}
  .topnav-role{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
  .topnav-actions{display:flex;gap:6px}
  .topnav-btn{padding:6px 12px;border-radius:6px;font-size:13px;font-weight:500;border:1px solid var(--border);cursor:pointer;transition:all .15s;background:var(--card)}
  .topnav-btn.ghost{background:transparent;color:var(--muted);border-color:transparent}
  .topnav-btn.ghost:hover{background:var(--card-hover);color:var(--ink)}
  .topnav-btn.primary{background:var(--primary);color:var(--bg);border-color:var(--primary)}
  .topnav-btn.primary:hover{background:var(--primary-dark)}

  /* Theme Toggle */
  .theme-toggle{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
  .theme-toggle:hover{background:var(--card-hover)}
  .theme-toggle svg{width:18px;height:18px;color:var(--ink)}

  .container{max-width:1200px;margin:0 auto;padding:20px}

  /* Hide old brandbar - replaced by topnav */
  .brandbar{display:none}
  .screen{display:none;animation:fade .2s ease-in} .screen.active{display:block}
  @keyframes fade{from{opacity:.7;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
  .card{background:var(--card);border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--border);transition:background .2s,border-color .2s}
  .p-12{padding:12px} .p-16{padding:16px} .p-20{padding:20px} .p-24{padding:24px}
  .mb-8{margin-bottom:8px} .mb-12{margin-bottom:12px} .mb-16{margin-bottom:16px} .mb-24{margin-bottom:24px}
  .title{font-size:20px;font-weight:600;margin:0 0 6px;letter-spacing:-.3px} .subtitle{font-size:13px;color:var(--muted);margin:0 0 12px}
  .row{display:flex;gap:12px;align-items:center} .space{justify-content:space-between} .wrap{flex-wrap:wrap}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px} .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px} .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.ai-trend-card{background:rgba(255,255,255,0.08);border-radius:8px;padding:16px;border-left:4px solid #667eea}
.ai-trend-card.critical{border-left-color:#ff6b6b;background:rgba(255,107,107,0.1)}
.ai-trend-card.warning{border-left-color:#ffc107;background:rgba(255,193,7,0.1)}
.ai-trend-card.info{border-left-color:#48bb78;background:rgba(72,187,120,0.1)}
.ai-category-badge{background:rgba(255,255,255,0.15);padding:6px 12px;border-radius:20px;font-size:12px;display:inline-flex;align-items:center;gap:6px}
  /* Clean Sidebar Layout */
  .two-col{display:grid;grid-template-columns:220px 1fr;gap:24px}
  .leftnav{position:sticky;top:76px;height:fit-content}
  .leftnav .subtitle{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin:0 0 8px 12px;font-weight:500}
  .navlink{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;margin-bottom:2px;cursor:pointer;font-size:14px;font-weight:400;color:var(--muted);transition:all .15s ease}
  .navlink:hover{background:var(--card-hover);color:var(--ink)}
  .navlink.active{background:var(--primary);color:var(--bg)}
  .btn{appearance:none;border:1px solid var(--border);border-radius:8px;padding:8px 14px;font-weight:500;font-size:13px;cursor:pointer;background:var(--card);color:var(--ink);transition:all .15s ease}
  .btn:hover{background:var(--card-hover)}
  .btn.primary{background:var(--primary);color:var(--bg);border-color:var(--primary)}
  .btn.primary:hover{opacity:.9}
  .btn.ghost{background:transparent;border-color:transparent;color:var(--muted)}
  .btn.ghost:hover{background:var(--card-hover);color:var(--ink)}
  .btn.accent{background:var(--primary);color:var(--bg);border-color:var(--primary)}
  .btn.warn{background:#fefce8;border-color:#fde047;color:#a16207} .btn.danger{background:#fef2f2;border-color:#fecaca;color:#dc2626}
  .btn.ai-btn{background:var(--primary);color:var(--bg);border:1px solid var(--primary);font-weight:500}
  .btn.ai-btn:hover{opacity:.9} .btn.ai-action{background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);font-size:12px;padding:6px 10px}
  .btn.ai-action:hover{background:rgba(255,255,255,0.2)} .ai-action-confidence{font-size:10px;opacity:0.7;margin-left:4px}
  .input, select, textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:var(--input-bg);color:var(--ink);font-size:14px;transition:all .15s}
  .input:focus, select:focus, textarea:focus{outline:none;border-color:var(--primary)}
  textarea{min-height:100px;resize:vertical}
  table{width:100%;border-collapse:collapse} th{text-align:left;padding:10px 12px;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);font-weight:500;border-bottom:1px solid var(--border);background:var(--table-header)}
  td{text-align:left;padding:12px;border-bottom:1px solid var(--border);font-size:13px} tr:hover{background:var(--card-hover);cursor:pointer}
  .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:500;border:1px solid var(--border);background:#fafafa;color:var(--ink)}
  .badge.plan-trial{background:#f3e8ff;color:#7c3aed;border-color:#e9d5ff}
  .badge.plan-starter{background:#dbeafe;color:#2563eb;border-color:#bfdbfe}
  .badge.plan-pro{background:#fef3c7;color:#d97706;border-color:#fde68a}
  .badge.status-active{background:#dcfce7;color:#16a34a;border-color:#bbf7d0}
  .badge.status-pending{background:#fef3c7;color:#d97706;border-color:#fde68a}
  .badge.status-cancelled{background:#fef2f2;color:#dc2626;border-color:#fecaca}
  .badge.status-success{background:#dcfce7;color:#16a34a;border-color:#bbf7d0}
  .badge.status-warning{background:#fef3c7;color:#d97706;border-color:#fde68a}
  .badge.status-error{background:#fef2f2;color:#dc2626;border-color:#fecaca}
  
  .progress-bar{width:100%;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#4caf50 0%,#ff9800 70%,#f44336 100%);transition:width 0.3s ease}
  .usage-alert{padding:12px;margin:8px 0;border-radius:4px;border-left:4px solid}
  .usage-alert.warning{background:#fff3cd;border-color:#ff9800;color:#856404}
  .usage-alert.danger{background:#f8d7da;border-color:#f44336;color:#721c24}
  .usage-alert.info{background:#d1ecf1;border-color:#17a2b8;color:#0c5460}
  .sla.ok{color:var(--ok);border-color:#bbf7d0;background:#f0fdf4}
  .sla.warn{color:var(--warn);border-color:#fed7aa;background:#fffbeb}
  .sla.danger{color:var(--danger);border-color:#fecaca;background:#fef2f2}
  .progress{height:6px;border-radius:999px;background:var(--border);overflow:hidden}
  .progress>span{display:block;height:100%;background:var(--primary)}
  #chat-toggle{position:fixed;right:20px;bottom:20px;border-radius:999px;padding:12px 16px;box-shadow:var(--shadow-lg);background:var(--primary);color:var(--bg);border:none;cursor:pointer;font-weight:500;font-size:13px;transition:all .2s}
  #chat-toggle:hover{opacity:.9}
  #chat{position:fixed;right:20px;bottom:72px;width:360px;max-height:70vh;display:none;flex-direction:column;gap:8px;z-index:90}
  #chat .panel{background:var(--card);border-radius:12px;box-shadow:var(--shadow-lg);overflow:hidden;display:flex;flex-direction:column;max-height:70vh;border:1px solid var(--border)}
  #chat .header{padding:14px 16px;background:var(--primary);color:var(--bg);font-weight:500;font-size:14px}
  #chat .body{padding:14px;overflow-y:auto;background:var(--bg)} #chat .msg{padding:10px 12px;border-radius:10px;margin-bottom:8px;max-width:85%;font-size:13px;line-height:1.5} #chat .ai{background:var(--card);border:1px solid var(--border)} #chat .me{background:var(--primary);color:var(--bg);align-self:flex-end}
  #err{display:none;position:fixed;left:0;right:0;bottom:0;background:#fef2f2;color:#dc2626;padding:10px 16px;font-size:13px;border-top:1px solid #fecaca;z-index:200}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:150}
  .modal .sheet{width:min(560px,calc(100vw - 32px));background:var(--card);border-radius:12px;box-shadow:var(--shadow-lg);overflow:hidden;border:1px solid var(--border)}
  .modal .head{padding:16px 20px;background:var(--primary);color:var(--bg);font-weight:500;font-size:15px}
  .modal .body{padding:20px}
  .modal .foot{padding:12px 20px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border);background:var(--table-header)}

  /* Toggle Switch */
  .toggle-switch{position:relative;display:inline-block;width:60px;height:32px}
  .toggle-switch input{opacity:0;width:0;height:0}
  .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#e2e8f0;transition:.3s;border-radius:32px}
  .toggle-slider:before{position:absolute;content:"";height:24px;width:24px;left:4px;bottom:4px;background-color:white;transition:.3s;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
  .toggle-switch input:checked+.toggle-slider{background-color:#22c55e}
  .toggle-switch input:checked+.toggle-slider:before{transform:translateX(28px)}
  .toggle-switch input:focus+.toggle-slider{box-shadow:0 0 0 2px rgba(34,197,94,0.3)}
  .mt-16{margin-top:16px}
  .btn.success{background:#22c55e;color:#fff}
</style>
</head>
<body>
<!-- Modern Top Navigation -->
<nav class="topnav" id="topnav">
  <div class="topnav-inner">
    <a href="#" class="topnav-brand" onclick="go('login'); return false;">
      <div class="logo-icon">
        <svg viewBox="0 0 100 100">
          <rect width="100" height="100" rx="16"/>
          <text x="50" y="66" text-anchor="middle" font-family="system-ui, sans-serif" font-size="44" font-weight="600">SF</text>
        </svg>
      </div>
      <span>ServiFlow</span>
    </a>
    <div style="display:flex;align-items:center;gap:12px">
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode" id="theme-toggle-btn">
        <svg id="theme-icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg id="theme-icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
      <div class="topnav-right" id="topnav-right" style="display:none">
      <div class="topnav-user" onclick="go('login')">
        <div class="topnav-avatar" id="topnav-avatar">A</div>
        <div>
          <div class="topnav-name" id="topnav-username">Admin</div>
          <div class="topnav-role" id="topnav-role">Admin</div>
        </div>
      </div>
      <div class="topnav-actions">
        <button class="topnav-btn ghost" onclick="switchRole()">Switch</button>
        <button class="topnav-btn ghost" onclick="go('login')">Sign out</button>
      </div>
    </div>
    </div>
  </div>
</nav>

<div id="err"></div>
<div class="container">
  <div class="brandbar">
    <div class="logo-icon">
        <svg viewBox="0 0 100 100">
            <defs><linearGradient id="navGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#2563eb"/><stop offset="100%" style="stop-color:#8b5cf6"/></linearGradient></defs>
            <rect width="100" height="100" rx="20" fill="url(#navGrad)"/>
            <text x="50" y="68" text-anchor="middle" font-family="system-ui, sans-serif" font-size="48" font-weight="700" fill="white">SF</text>
            <circle cx="82" cy="24" r="8" fill="#10b981"/>
        </svg>
    </div>
    <div style="font-weight:800;color:#003366">ServiFlow â€¢ Support Platform</div>
  </div>

  <!-- LOGIN -->
  <section id="scr-login" class="screen active">
    <div class="card p-24" style="max-width:380px;margin:40px auto">
      <div style="text-align:center;margin-bottom:24px">
        <div style="width:48px;height:48px;margin:0 auto 14px;border-radius:12px;background:var(--logo-bg);display:flex;align-items:center;justify-content:center;transition:background .2s">
          <span style="color:var(--logo-text);font-weight:600;font-size:18px;transition:color .2s">SF</span>
        </div>
        <h1 class="title" style="margin-bottom:4px">Sign in</h1>
        <p class="subtitle" style="margin:0">Welcome back to ServiFlow</p>
      </div>
      
      <div class="mb-16">
        <label for="username" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;color:var(--ink)">Username</label>
        <input type="text" id="username" class="input" placeholder="Enter your username" value="master">
      </div>
      
      <div class="mb-16">
        <label for="password" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;color:var(--ink)">Password</label>
        <input type="password" id="password" class="input" placeholder="Enter your password" value="master123">
      </div>
      
      <div class="mb-16">
        <label for="role" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;color:var(--ink)">Role</label>
        <select id="role" class="input" onchange="toggleTenantField()" style="cursor:pointer">
          <option value="master_admin">Master Admin</option>
            <option value="admin">Admin</option>
            <option value="expert">Expert</option>
            <option value="customer">Customer</option>
          </select>
        </div>
      
      <div class="mb-16" id="tenant-field" style="display:none">
        <label for="tenant" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;color:var(--ink)">Tenant</label>
        <select id="tenant" class="input" style="cursor:pointer">
          <option value="apoyar">Apoyar</option>
          <option value="testcompany">TestCompany</option>
        </select>
        </div>
      
      <div style="margin-bottom:16px">
        <button class="btn primary" onclick="login()" style="width:100%;padding:10px;font-size:14px">Sign in</button>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <a href="#" onclick="showForgotPassword(); return false;" style="color:var(--ink);text-decoration:none;font-size:12px;font-weight:500">Forgot password?</a>
        <a href="#" onclick="showDemoCredentials(); return false;" style="color:var(--muted);text-decoration:none;font-size:12px">Demo credentials</a>
      </div>

      <div id="login-error" style="display:none;color:#dc2626;background:#fef2f2;padding:10px;border-radius:8px;margin-bottom:12px;border:1px solid #fecaca;font-size:13px"></div>

      <div style="text-align:center;padding-top:14px;border-top:1px solid var(--border)">
        <span style="font-size:11px;color:var(--muted)">Enterprise-grade security</span>
      </div>
    </div>
  </section>

  <!-- FORGOT PASSWORD -->
  <section id="scr-forgot-password" class="screen">
    <div class="card p-24" style="max-width:760px;margin:20px auto;">
      <h1 class="title">Forgot Password</h1>
      <p class="subtitle">Enter your email address and tenant code to receive a password reset link.</p>

      <div class="mb-16">
        <label for="forgot-tenant" style="display:block;margin-bottom:8px;font-weight:600;">Tenant Code:</label>
        <input type="text" id="forgot-tenant" class="input" placeholder="Enter tenant code (e.g., apoyar)">
      </div>

      <div class="mb-16">
        <label for="forgot-email" style="display:block;margin-bottom:8px;font-weight:600;">Email Address:</label>
        <input type="email" id="forgot-email" class="input" placeholder="Enter your email address">
      </div>

      <div class="row mb-12">
        <button class="btn primary" onclick="sendPasswordReset()">Send Reset Link</button>
        <button class="btn ghost" onclick="backToLogin()">Back to Login</button>
      </div>

      <div id="forgot-message" style="display:none;padding:12px;border-radius:8px;margin-top:12px;border:1px solid;"></div>
    </div>
  </section>

  <!-- APP -->
  <section id="scr-app" class="screen">
    <div class="row space mb-20 wrap" style="padding-bottom:16px;border-bottom:1px solid var(--border)">
      <div>
        <h2 class="title" id="app-title">Dashboard</h2>
        <div class="subtitle" id="app-subtitle">ServiFlow â€“ role-based workspace</div>
      </div>
      <div class="row wrap" style="gap:8px">
        <span id="chip-role" style="display:none">admin</span>
        <div id="tenant-chip" style="display:none;padding:4px 12px;border-radius:999px;background:var(--primary);color:var(--bg);font-size:12px;font-weight:500">
          <span id="chip-tenant">â€”</span>
        </div>
      </div>
    </div>

    <div class="two-col">
      <!-- Left Nav -->
      <aside class="leftnav">
        <div id="nav-master" style="display:none">
          <div class="subtitle">Master Admin Navigation</div>
          <div class="navlink" data-target="dash" onclick="nav(this)">ğŸ  Master Dashboard</div>
          <div class="navlink" data-target="tenants" onclick="nav(this)">ğŸ¢ Tenant Management</div>
          <div class="navlink" data-target="subscriptions" onclick="nav(this)">ğŸ’³ Subscriptions</div>
          <div class="navlink" data-target="billing" onclick="nav(this)">ğŸ’° Billing</div>
          <div class="navlink" data-target="plans" onclick="nav(this)">ğŸ“‹ Plan Management</div>
          <div class="navlink" data-target="ai-insights" onclick="nav(this)">ğŸ¤– AI Insights</div>
          <div class="navlink" data-target="ticket-rules" onclick="nav(this)">âš™ï¸ Ticket Rules</div>
          <div class="navlink" data-target="email-processing" onclick="nav(this)">ğŸ“§ Email Processing</div>
          <div class="navlink" data-target="system" onclick="nav(this)">âš™ï¸ System Overview</div>
        </div>
        
        <div id="nav-admin">
          <div class="subtitle">Admin Navigation</div>
          <div class="navlink" data-target="dash" onclick="nav(this)">ğŸ  Dashboard</div>
          <div class="navlink" data-target="tickets" onclick="nav(this)">ğŸ« Tickets</div>
          <div class="navlink" data-target="experts" onclick="nav(this)">ğŸ‘©â€ğŸ”§ Manage Experts</div>
          <div class="navlink" data-target="customers" onclick="nav(this)">ğŸ§‘â€ğŸ’¼ Manage Customers</div>
          <div class="navlink" data-target="cmdb" onclick="nav(this)">ğŸ—ƒï¸ CMDB</div>
          <div class="navlink" data-target="manage-cmdb" onclick="nav(this)">âš™ï¸ Manage CMDB Types</div>
          <div class="navlink" data-target="analytics" onclick="nav(this)">ğŸ“ˆ Analytics</div>
          <div class="navlink" data-target="ai-insights" onclick="nav(this)">ğŸ¤– AI Insights</div>
          <div class="navlink" data-target="ticket-rules" onclick="nav(this)">âš™ï¸ Ticket Rules</div>
          <div class="navlink" data-target="usage" onclick="nav(this)">ğŸ“Š Usage & Limits</div>
          <div class="navlink" data-target="raise" onclick="nav(this)">ğŸ“ Raise Request</div>
          <div class="navlink" data-target="wizard" onclick="nav(this)">ğŸª„ Admin Settings Wizard</div>
          <div class="navlink" data-target="system-control" onclick="nav(this)">ğŸ”§ System Control</div>
        </div>
        <div id="nav-expert" style="display:none">
          <div class="subtitle">Expert Navigation</div>
          <div class="navlink" data-target="dash" onclick="nav(this)">ğŸ  My Dashboard</div>
          <div class="navlink" data-target="profile" onclick="nav(this)">ğŸ‘¤ My Profile</div>
          <div class="navlink" data-target="tickets" onclick="nav(this)">ğŸ« Tickets</div>
          <div class="navlink" data-target="cmdb" onclick="nav(this)">ğŸ—ƒï¸ CMDB</div>
          <div class="navlink" data-target="manage-cmdb" onclick="nav(this)">âš™ï¸ Manage CMDB Types</div>
          <div class="navlink" data-target="analytics" onclick="nav(this)">ğŸ“ˆ Analytics</div>
          <div class="navlink" data-target="ai-insights" onclick="nav(this)">ğŸ¤– AI Insights</div>
          <div class="navlink" data-target="raise" onclick="nav(this)">ğŸ“ Raise Request</div>
        </div>
        <div id="nav-customer" style="display:none">
          <div class="subtitle">Customer Portal</div>
          <div class="navlink" data-target="dash" onclick="nav(this)">ğŸ  My Dashboard</div>
          <div class="navlink" data-target="profile" onclick="nav(this)">ğŸ‘¤ My Profile</div>
          <div class="navlink" data-target="tickets" onclick="nav(this)">ğŸ« My Requests</div>
          <div class="navlink" data-target="usage" onclick="nav(this)">ğŸ“Š Usage & Limits</div>
          <div class="navlink" data-target="customer-billing" onclick="nav(this)">ğŸ’° Billing</div>
          <div class="navlink" data-target="customer-plans" onclick="nav(this)">ğŸ“‹ Plans & Upgrades</div>
          <div class="navlink" data-target="analytics" onclick="nav(this)">ğŸ“ˆ Analytics</div>
          <div class="navlink" data-target="ai-insights" onclick="nav(this)">ğŸ¤– AI Insights</div>
          <div class="navlink" data-target="cmdb" onclick="nav(this)">ğŸ—ƒï¸ My CMDB</div>
          <div class="navlink" data-target="raise" onclick="nav(this)">ğŸ“ Raise Request</div>
        </div>
      </aside>

      <!-- Main -->
      <main>
        <!-- ---- Role Dashboards ---- -->
        <div id="view-dash">
          <!-- Master Admin -->
          <div id="dash-master" class="card p-16 mb-16" style="display:none">
            <h3 class="title">Master Admin Dashboard</h3>
            <div class="subtitle">System-wide management & tenant oversight</div>
            <div class="grid3 mb-16">
              <div class="card p-16"><div class="subtitle">Total Tenants</div><div id="ma-tenants" style="font-size:28px;font-weight:800">0</div></div>
              <div class="card p-16"><div class="subtitle">Active Tenants</div><div id="ma-active" style="font-size:28px;font-weight:800">0</div></div>
              <div class="card p-16"><div class="subtitle">System Health</div><div id="ma-health" style="font-size:28px;font-weight:800">100%</div></div>
            </div>
            <div class="card p-16">
              <h4>Recent Tenant Activity</h4>
              <div id="ma-activity" class="subtitle">Loading tenant activity...</div>
            </div>
          </div>
          
          <!-- Admin -->
          <div id="dash-admin" class="card p-16 mb-16">
            <h3 class="title">Admin Dashboard</h3>
            <div class="subtitle">Health & governance at a glance</div>
            <div class="grid3 mb-16">
              <div class="card p-16 stat-card" onclick="viewOpenTickets()" style="cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                <div class="subtitle">Open tickets (all)</div>
                <div id="ad-open" style="font-size:28px;font-weight:800">0</div>
                <div class="subtitle" style="margin-top:8px;color:#667eea;font-size:12px">Click to view â†’</div>
              </div>
              <div class="card p-16 stat-card" onclick="viewSLAAtRisk()" style="cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                <div class="subtitle">SLA at risk</div>
                <div id="ad-sla-risk" style="font-size:28px;font-weight:800">0</div>
                <div class="subtitle" style="margin-top:8px;color:#f56565;font-size:12px">Click to view â†’</div>
              </div>
              <div class="card p-16 stat-card" onclick="viewCMDBItems()" style="cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
                <div class="subtitle">CMDB items</div>
                <div id="ad-items" style="font-size:28px;font-weight:800">0</div>
                <div class="subtitle" style="margin-top:8px;color:#48bb78;font-size:12px">Click to view â†’</div>
              </div>
            </div>
            <div class="grid2">
              <div class="card p-16">
                <div class="row space"><strong>Recent tickets</strong><button class="btn ghost" onclick="navTo('tickets')">View all</button></div>
                <table><thead><tr><th>ID</th><th>Title</th><th>Date/Time</th><th>Customer</th><th>Status</th></tr></thead><tbody id="ad-recent"></tbody></table>
              </div>
              <div class="card p-16">
                <div class="row space"><strong>Quick admin</strong><span class="subtitle">Common tasks</span></div>
                <div class="row wrap">
                  <button class="btn primary" onclick="navTo('experts')">Manage experts</button>
                  <button class="btn primary" onclick="navTo('customers')">Manage customers</button>
                  <button class="btn primary" onclick="navTo('cmdb')">Open CMDB</button>
                  <button class="btn" onclick="navTo('wizard')">Settings wizard</button>
                </div>
              </div>
            </div>

            <!-- Feedback Scoreboard -->
            <div class="card p-16 mb-16" style="margin-top:16px">
              <div class="row space"><strong>Customer Satisfaction Feedback</strong><button class="btn ghost" onclick="loadFeedbackScoreboard()">ğŸ”„ Refresh</button></div>
              <div class="grid3 mb-16">
                <div class="card p-16">
                  <div class="subtitle">Average Rating</div>
                  <div id="feedback-avg-rating" style="font-size:28px;font-weight:800">-</div>
                  <div id="feedback-avg-stars" style="font-size:20px;margin-top:4px"></div>
                </div>
                <div class="card p-16">
                  <div class="subtitle">Total Feedback</div>
                  <div id="feedback-total-count" style="font-size:28px;font-weight:800">0</div>
                </div>
                <div class="card p-16">
                  <div class="subtitle">Rating Distribution</div>
                  <div id="feedback-distribution" style="font-size:14px;margin-top:8px">
                    <div class="row space"><span>5â­</span><span id="feedback-5star">0</span></div>
                    <div class="row space"><span>4â­</span><span id="feedback-4star">0</span></div>
                    <div class="row space"><span>3â­</span><span id="feedback-3star">0</span></div>
                    <div class="row space"><span>2â­</span><span id="feedback-2star">0</span></div>
                    <div class="row space"><span>1â­</span><span id="feedback-1star">0</span></div>
                  </div>
                </div>
              </div>
              <div class="card p-16">
                <strong>Recent Feedback</strong>
                <table><thead><tr><th>Ticket</th><th>Rating</th><th>Resolved By</th><th>Comment</th><th>Date</th></tr></thead><tbody id="feedback-recent"></tbody></table>
              </div>
            </div>

            <!-- AI Trending Conditions Panel -->
            <div id="ai-trends-panel" class="card p-16 mb-16" style="margin-top:16px;background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);color:white;border:none;">
              <div class="row space">
                <div class="row" style="gap:12px;align-items:center">
                  <span style="font-size:24px">AI</span>
                  <div>
                    <strong style="font-size:16px">AI Insights & Trends</strong>
                    <div style="font-size:12px;opacity:0.7">Powered by Claude AI - analyzing ticket patterns</div>
                  </div>
                </div>
                <div class="row" style="gap:8px">
                  <select id="ai-trends-period" class="input" onchange="loadAITrends()" style="background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);min-width:120px">
                    <option value="24">Last 24 hours</option>
                    <option value="72">Last 3 days</option>
                    <option value="168" selected>Last 7 days</option>
                    <option value="720">Last 30 days</option>
                  </select>
                  <button class="btn" onclick="loadAITrends()" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.2)">Refresh</button>
                </div>
              </div>

              <!-- Loading State -->
              <div id="ai-trends-loading" style="text-align:center;padding:40px;display:none">
                <div style="font-size:14px;opacity:0.7">Analyzing ticket patterns...</div>
              </div>

              <!-- Summary Stats -->
              <div id="ai-trends-content" style="margin-top:20px">
                <div class="grid4" style="gap:12px;margin-bottom:20px">
                  <div class="card p-12" style="background:rgba(255,255,255,0.1);border:none;text-align:center">
                    <div style="font-size:11px;opacity:0.7;text-transform:uppercase">Active Trends</div>
                    <div id="ai-trends-count" style="font-size:28px;font-weight:800">0</div>
                  </div>
                  <div class="card p-12" style="background:rgba(255,99,71,0.2);border:none;text-align:center">
                    <div style="font-size:11px;opacity:0.7;text-transform:uppercase">Critical Issues</div>
                    <div id="ai-critical-count" style="font-size:28px;font-weight:800;color:#ff6b6b">0</div>
                  </div>
                  <div class="card p-12" style="background:rgba(255,193,7,0.2);border:none;text-align:center">
                    <div style="font-size:11px;opacity:0.7;text-transform:uppercase">Warnings</div>
                    <div id="ai-warning-count" style="font-size:28px;font-weight:800;color:#ffc107">0</div>
                  </div>
                  <div class="card p-12" style="background:rgba(72,187,120,0.2);border:none;text-align:center">
                    <div style="font-size:11px;opacity:0.7;text-transform:uppercase">Tickets Analyzed</div>
                    <div id="ai-analyzed-count" style="font-size:28px;font-weight:800;color:#48bb78">0</div>
                  </div>
                </div>

                <!-- Trending Issues List -->
                <div id="ai-trends-list" style="display:flex;flex-direction:column;gap:12px">
                  <div style="text-align:center;padding:30px;opacity:0.6">
                    <div style="font-size:14px">Click "Refresh" to analyze recent tickets and detect trends</div>
                  </div>
                </div>

                <!-- Category Breakdown -->
                <div id="ai-category-breakdown" style="margin-top:20px;display:none">
                  <div style="font-weight:600;margin-bottom:12px">Issue Categories</div>
                  <div id="ai-categories" class="row wrap" style="gap:8px"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Expert -->
          <div id="dash-expert" class="card p-16 mb-16" style="display:none">
            <h3 class="title">Expert Dashboard</h3>
            <div class="subtitle">Your queue & SLA focus</div>
            <div class="grid3 mb-16">
              <div class="card p-16"><div class="subtitle">My open</div><div id="ex-open" style="font-size:28px;font-weight:800">0</div></div>
              <div class="card p-16"><div class="subtitle">Due today</div><div id="ex-today" style="font-size:28px;font-weight:800">0</div></div>
              <div class="card p-16"><div class="subtitle">SLA at risk</div><div id="ex-risk" style="font-size:28px;font-weight:800">0</div></div>
            </div>
            <div class="grid2">
              <div class="card p-16">
                <div class="row space"><strong>My tickets</strong><button class="btn ghost" onclick="navTo('tickets')">View all</button></div>
                <table><thead><tr><th>ID</th><th>Title</th><th>Date/Time</th><th>Status</th><th>SLA</th></tr></thead><tbody id="ex-list"></tbody></table>
              </div>
              <div class="card p-16">
                <div class="row space"><strong>Quick actions</strong><span class="subtitle">Work faster</span></div>
                <div class="row wrap">
                  <button class="btn primary" onclick="navTo('tickets')">Open queue</button>
                  <button class="btn" onclick="navTo('cmdb')">Search CMDB</button>
                  <button class="btn" onclick="navTo('raise')">Log request</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Customer -->
          <div id="dash-customer" class="card p-16" style="display:none">
            <h3 class="title">Customer Dashboard</h3>
            <div class="subtitle">Your estate & requests</div>
            <div class="grid3 mb-16">
              <div class="card p-16"><div class="subtitle">Open requests</div><div id="cu-open" style="font-size:28px;font-weight:800">0</div></div>
              <div class="card p-16"><div class="subtitle">CMDB items</div><div id="cu-items" style="font-size:28px;font-weight:800">0</div></div>
              <div class="card p-16"><div class="subtitle">Configurable items</div><div id="cu-cis" style="font-size:28px;font-weight:800">0</div></div>
            </div>
            <div class="grid2">
              <div class="card p-16">
                <div class="row space"><strong>Recently updated CIs</strong><button class="btn ghost" onclick="navTo('cmdb')">Open CMDB</button></div>
                <table><thead><tr><th>CMDB Item</th><th>CI Name</th><th>Model</th><th>Location</th><th>Lifecycle</th></tr></thead><tbody id="cu-ci-body"></tbody></table>
              </div>
              <div class="card p-16">
                <div class="row space"><strong>Quick actions</strong><span class="subtitle">Self-service</span></div>
                <div class="row wrap">
                  <button class="btn primary" onclick="navTo('raise')">New request</button>
                  <button class="btn" onclick="navTo('tickets')">My requests</button>
                  <button class="btn" onclick="navTo('cmdb')">My CMDB</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- My Profile -->
        <div id="view-profile" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">My Profile</h3></div>
            <button class="btn primary" onclick="saveProfile()">ğŸ’¾ Save Changes</button>
          </div>
          
          <div class="card p-16">
            <h4>Personal Information</h4>
            <div class="grid2" style="gap:16px;margin-top:16px">
              <div>
                <label>Username (read-only)</label>
                <input type="text" id="profile-username" disabled style="background:#f5f5f5">
              </div>
              <div>
                <label>Role</label>
                <input type="text" id="profile-role" disabled style="background:#f5f5f5">
              </div>
              <div>
                <label>Full Name</label>
                <input type="text" id="profile-fullname" placeholder="Enter your full name">
              </div>
              <div>
                <label>Email</label>
                <input type="email" id="profile-email" placeholder="Enter your email">
              </div>
              <div>
                <label>Phone</label>
                <input type="tel" id="profile-phone" placeholder="Enter your phone number">
              </div>
              <div>
                <label>Department</label>
                <input type="text" id="profile-department" placeholder="Enter your department">
              </div>
            </div>
          </div>
          
          <div class="card p-16" style="margin-top:16px">
            <h4>Account Information</h4>
            <div class="grid2" style="gap:16px;margin-top:16px">
              <div>
                <label>Account Created</label>
                <input type="text" id="profile-created" disabled style="background:#f5f5f5">
              </div>
              <div>
                <label>Last Updated</label>
                <input type="text" id="profile-updated" disabled style="background:#f5f5f5">
              </div>
            </div>
          </div>
        </div>

        <!-- Tenant Management -->
        <div id="view-tenants" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Tenant Management</h3></div>
            <button class="btn primary" onclick="showCreateTenantForm()">+ Create New Tenant</button>
          </div>
          
          <div class="card p-16">
            <h4>Registered Tenants</h4>
            <table id="tenants-table">
              <thead>
                <tr>
                  <th>Company Name</th>
                  <th>Tenant ID</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tenant-list-body">
                <tr><td colspan="5" class="subtitle">Loading tenants...</td></tr>
              </tbody>
            </table>
          </div>
          
          <!-- Create Tenant Form -->
          <div id="create-tenant-form" class="card p-16" style="display:none">
            <h4>Create New Tenant</h4>
            <div class="form-group">
              <label>Company Name</label>
              <input type="text" id="new-tenant-company" placeholder="Enter company name">
            </div>
            <div class="form-group">
              <label>Admin Username</label>
              <input type="text" id="new-tenant-admin" placeholder="Enter admin username">
            </div>
            <div class="form-group">
              <label>Admin Email</label>
              <input type="email" id="new-tenant-email" placeholder="Enter admin email">
            </div>
            <div class="row">
              <button class="btn primary" onclick="createTenant()">Create Tenant</button>
              <button class="btn ghost" onclick="hideCreateTenantForm()">Cancel</button>
            </div>
          </div>
          
          <!-- Edit Tenant Form -->
          <div id="edit-tenant-form" class="card p-16" style="display:none">
            <h4>Edit Tenant</h4>
            <input type="hidden" id="edit-tenant-id">
            <div class="form-group">
              <label>Company Name</label>
              <input type="text" id="edit-company-name" placeholder="Enter company name">
            </div>
            <div class="form-group">
              <label>Admin Username</label>
              <input type="text" id="edit-admin-username" placeholder="Enter admin username">
            </div>
            <div class="form-group">
              <label>Admin Email</label>
              <input type="email" id="edit-admin-email" placeholder="Enter admin email">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="edit-tenant-status">
                <option value="active">Active</option>
                <option value="suspended">Suspended</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
            <div class="row">
              <button class="btn primary" onclick="updateTenant()">Update Tenant</button>
              <button class="btn ghost" onclick="hideEditTenantForm()">Cancel</button>
            </div>
          </div>
        </div>
        
        <!-- Subscription Management -->
        <div id="view-subscriptions" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Subscription Management</h3></div>
            <div class="row">
              <button class="btn primary" onclick="showCreateSubscriptionForm()">+ Create Subscription</button>
              <button class="btn" onclick="exportSubscriptions()">ğŸ“Š Export Data</button>
            </div>
          </div>
          
          <!-- Subscription Stats -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Revenue</div>
              <div id="total-revenue" style="font-size:28px;font-weight:800">$0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Active Subscriptions</div>
              <div id="active-subscriptions" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Trial Conversions</div>
              <div id="trial-conversions" style="font-size:28px;font-weight:800">0%</div>
            </div>
          </div>
          
          <!-- Subscription List -->
          <div class="card p-16">
            <h4>All Subscriptions</h4>
            <table id="subscriptions-table">
              <thead>
                <tr>
                  <th>Tenant</th>
                  <th>Plan</th>
                  <th>Status</th>
                  <th>Price</th>
                  <th>Next Billing</th>
                  <th>Users</th>
                  <th>Usage</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="subscription-list-body">
                <tr><td colspan="8" class="subtitle">Loading subscriptions...</td></tr>
              </tbody>
            </table>
          </div>
          
          <!-- Create Subscription Form -->
          <div id="create-subscription-form" class="card p-16" style="display:none">
            <h4>Create New Subscription</h4>
            <div class="form-group">
              <label>Select Tenant</label>
              <select id="subscription-tenant" onchange="loadTenantPlans()">
                <option value="">Choose a tenant...</option>
              </select>
            </div>
            <div class="form-group">
              <label>Plan Type</label>
              <select id="subscription-plan">
                <option value="trial">Trial (Free - 14 days)</option>
                <option value="starter">Starter ($29/month)</option>
                <option value="pro">Pro ($99/month)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Billing Cycle</label>
              <select id="subscription-billing">
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly (20% discount)</option>
              </select>
            </div>
            <div class="row">
              <button class="btn primary" onclick="createSubscription()">Create Subscription</button>
              <button class="btn ghost" onclick="hideCreateSubscriptionForm()">Cancel</button>
            </div>
          </div>
        </div>
        
        <!-- Billing Management -->
        <div id="view-billing" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Billing Management</h3></div>
            <div class="row">
              <button class="btn" onclick="generateInvoice()">ğŸ“„ Generate Invoice</button>
              <button class="btn" onclick="exportBilling()">ğŸ“Š Export Billing</button>
            </div>
          </div>
          
          <!-- Billing Stats -->
          <div class="grid4 mb-16">
            <div class="card p-16">
              <div class="subtitle">Monthly Recurring Revenue</div>
              <div id="mrr" style="font-size:24px;font-weight:800">$0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Pending Payments</div>
              <div id="pending-payments" style="font-size:24px;font-weight:800">$0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Churn Rate</div>
              <div id="churn-rate" style="font-size:24px;font-weight:800">0%</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Average Revenue Per User</div>
              <div id="arpu" style="font-size:24px;font-weight:800">$0</div>
            </div>
          </div>
          
          <!-- Recent Transactions -->
          <div class="card p-16">
            <h4>Recent Transactions</h4>
            <table id="billing-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Tenant</th>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Invoice</th>
                </tr>
              </thead>
              <tbody id="billing-list-body">
                <tr><td colspan="6" class="subtitle">Loading transactions...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Plan Management -->
        <div id="view-plans" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Plan Management</h3></div>
            <div class="row">
              <button class="btn primary" onclick="showCreatePlanForm()">+ Create New Plan</button>
              <button class="btn" onclick="exportPlans()">ğŸ“Š Export Plans</button>
            </div>
          </div>
          
          <!-- Plan Stats -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Plans</div>
              <div id="total-plans" style="font-size:28px;font-weight:800">3</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Active Plans</div>
              <div id="active-plans" style="font-size:28px;font-weight:800">3</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Most Popular</div>
              <div id="popular-plan" style="font-size:28px;font-weight:800">Starter</div>
            </div>
          </div>
          
          <!-- Plans List -->
          <div class="card p-16">
            <h4>Subscription Plans</h4>
            <table id="plans-table">
              <thead>
                <tr>
                  <th>Plan Name</th>
                  <th>Price</th>
                  <th>Users</th>
                  <th>Tickets</th>
                  <th>Storage</th>
                  <th>Features</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="plans-list-body">
                <tr><td colspan="8" class="subtitle">Loading plans...</td></tr>
              </tbody>
            </table>
          </div>
          
          <!-- Create/Edit Plan Form -->
          <div id="create-plan-form" class="card p-16" style="display:none">
            <h4 id="plan-form-title">Create New Plan</h4>
            <div class="grid2">
              <div class="form-group">
                <label>Plan Name</label>
                <input type="text" id="plan-name" placeholder="e.g., Enterprise">
              </div>
              <div class="form-group">
                <label>Plan ID</label>
                <input type="text" id="plan-id" placeholder="e.g., enterprise">
              </div>
            </div>
            <div class="grid3">
              <div class="form-group">
                <label>Monthly Price ($)</label>
                <input type="number" id="plan-price" placeholder="0">
              </div>
              <div class="form-group">
                <label>Max Users (-1 = unlimited)</label>
                <input type="number" id="plan-users" placeholder="10">
              </div>
              <div class="form-group">
                <label>Max Tickets/Month (-1 = unlimited)</label>
                <input type="number" id="plan-tickets" placeholder="500">
              </div>
            </div>
            <div class="grid2">
              <div class="form-group">
                <label>Storage (GB, -1 = unlimited)</label>
                <input type="number" id="plan-storage" placeholder="10">
              </div>
              <div class="form-group">
                <label>Status</label>
                <select id="plan-status">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                  <option value="beta">Beta</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Features (comma-separated)</label>
              <textarea id="plan-features" placeholder="basic_sla, email_support, analytics"></textarea>
            </div>
            <div class="row">
              <button class="btn primary" onclick="savePlan()">Save Plan</button>
              <button class="btn ghost" onclick="hideCreatePlanForm()">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Email Processing Management -->
        <div id="view-email-processing" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Email Processing</h3></div>
            <button class="btn" onclick="refreshEmailSettings()">ğŸ”„ Refresh</button>
          </div>
          
          <!-- Email Settings -->
          <div class="card p-16 mb-16">
            <h4>Email Processing Settings</h4>
            <div id="email-settings-info">
              <div class="subtitle">Loading email settings...</div>
            </div>
            <div id="email-configuration-help" style="display:none" class="mt-16">
              <div class="usage-alert warning">
                <h5>ğŸ“§ Email Processing Not Configured</h5>
                <p>To enable real email processing, you need to configure IMAP credentials:</p>
                <ol>
                  <li>Create a <code>.env</code> file in your project root</li>
                  <li>Add your IMAP settings (see <code>EMAIL_SETUP.md</code> for details)</li>
                  <li>Restart the server</li>
                </ol>
                <p><strong>Example configuration:</strong></p>
                <pre style="background:#f8f9fa;padding:12px;border-radius:4px;font-size:12px;">
IMAP_HOST=imap.gmail.com
IMAP_PORT=993
IMAP_USER=your-support-email@gmail.com
IMAP_PASSWORD=your-app-password
IMAP_REJECT_UNAUTHORIZED=false</pre>
              </div>
            </div>
          </div>
          
          <!-- Test Email Processing -->
          <div class="card p-16 mb-16">
            <h4>Test Email Processing</h4>
            <div class="grid2">
              <div class="form-group">
                <label>Test Email Address</label>
                <input type="email" id="test-email" class="input" placeholder="test@example.com">
              </div>
              <div class="form-group">
                <label>Subject</label>
                <input type="text" id="test-subject" class="input" placeholder="Test Subject">
              </div>
            </div>
            <div class="form-group">
              <label>Message</label>
              <textarea id="test-message" class="input" placeholder="Test message content" rows="3"></textarea>
            </div>
            <button class="btn primary" onclick="testEmailProcessing()">Test Email Processing</button>
          </div>
          
          <!-- Tenant Email Settings -->
          <div class="card p-16">
            <h4>Tenant Email Settings</h4>
            <table id="tenant-email-table">
              <thead>
                <tr>
                  <th>Tenant</th>
                  <th>Domain</th>
                  <th>Email Processing</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tenant-email-list-body">
                <tr><td colspan="4" class="subtitle">Loading tenant email settings...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Customer Plans & Upgrades -->
        <div id="view-customer-plans" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Plans & Upgrades</h3></div>
            <button class="btn" onclick="refreshCustomerPlans()">ğŸ”„ Refresh</button>
          </div>
          
          <!-- Current Plan -->
          <div class="card p-16 mb-16">
            <h4>Your Current Plan</h4>
            <div id="current-plan-info">
              <div class="subtitle">Loading current plan...</div>
            </div>
          </div>
          
          <!-- Plan Comparison -->
          <div class="card p-16 mb-16">
            <h4>Available Plans</h4>
            <div id="plan-comparison">
              <div class="subtitle">Loading available plans...</div>
            </div>
          </div>
          
          <!-- Upgrade Form -->
          <div id="upgrade-form" class="card p-16" style="display:none">
            <h4>Upgrade Plan</h4>
            <div id="upgrade-details">
              <!-- Upgrade details will be populated here -->
            </div>
            <div class="row">
              <button class="btn primary" onclick="confirmUpgrade()">Confirm Upgrade</button>
              <button class="btn ghost" onclick="hideUpgradeForm()">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Customer Billing -->
        <div id="view-customer-billing" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Billing & Invoices</h3></div>
            <button class="btn" onclick="refreshCustomerBilling()">ğŸ”„ Refresh</button>
          </div>
          
          <!-- Billing Summary -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Current Plan</div>
              <div id="billing-current-plan" style="font-size:28px;font-weight:800">Loading...</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Next Billing Date</div>
              <div id="billing-next-date" style="font-size:28px;font-weight:800">Loading...</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Monthly Cost</div>
              <div id="billing-monthly-cost" style="font-size:28px;font-weight:800">Loading...</div>
            </div>
          </div>
          
          <!-- Payment Method -->
          <div class="card p-16 mb-16">
            <h4>Payment Method</h4>
            <div id="payment-method-info">
              <div class="subtitle">Loading payment information...</div>
            </div>
          </div>
          
          <!-- Invoice History -->
          <div class="card p-16">
            <h4>Invoice History</h4>
            <table id="invoice-table">
              <thead>
                <tr>
                  <th>Invoice #</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="invoice-list-body">
                <tr><td colspan="5" class="subtitle">Loading invoices...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Analytics Dashboard -->
        <div id="view-analytics" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Analytics Dashboard</h3></div>
            <div class="row">
              <button class="btn" onclick="refreshAnalytics()">ğŸ”„ Refresh</button>
              <button class="btn" onclick="exportAnalyticsToCSV()">ğŸ“Š Export CSV</button>
            </div>
          </div>
          
          <!-- Analytics Summary -->
          <div class="grid4 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Tickets</div>
              <div id="analytics-total-tickets" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Open Tickets</div>
              <div id="analytics-open-tickets" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Resolved Today</div>
              <div id="analytics-resolved-today" style="font-size:28px;font-weight:800">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Avg Response Time</div>
              <div id="analytics-avg-response" style="font-size:28px;font-weight:800">0h</div>
            </div>
          </div>
          
          <!-- Charts Section -->
          <div class="grid2 mb-16">
            <div class="card p-16">
              <h4>Ticket Status Distribution</h4>
              <div id="ticket-status-chart" style="height:300px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;border-radius:8px;">
                <div class="subtitle">Loading chart...</div>
              </div>
            </div>
            <div class="card p-16">
              <h4>Priority Breakdown</h4>
              <div id="priority-chart" style="height:300px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;border-radius:8px;">
                <div class="subtitle">Loading chart...</div>
              </div>
            </div>
          </div>
          
          <!-- Recent Activity -->
          <div class="card p-16">
            <h4>Recent Activity</h4>
            <div id="recent-activity">
              <div class="subtitle">Loading recent activity...</div>
            </div>
          </div>
        </div>

        
<!-- AI Insights Dashboard - INSERT THIS AFTER THE ANALYTICS VIEW (around line 926) -->

        <!-- AI Insights Dashboard -->
        <div id="view-ai-insights" style="display:none">
          <div class="row space mb-12">
            <div class="row">
              <button class="btn ghost" onclick="switchView('dash')">â† Back</button>
              <h3 class="title" style="margin:0 0 0 8px">ğŸ¤– AI Insights Dashboard</h3>
            </div>
            <div class="row">
              <button class="btn" onclick="refreshAIInsights()">ğŸ”„ Refresh</button>
              <button class="btn" onclick="triggerTrendDetection(event)">ğŸ” Detect Trends</button>
              <select id="ai-period" class="input" style="width:auto" onchange="refreshAIInsights()">
                <option value="1">Last 24 hours</option>
                <option value="7" selected>Last 7 days</option>
                <option value="30">Last 30 days</option>
              </select>
            </div>
          </div>

          <!-- Active Insights / Alerts -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">ğŸš¨ Active Insights & Alerts</h4>
            <div id="ai-insights-list">
              <div class="subtitle">Loading insights...</div>
            </div>
          </div>

          <!-- AI Performance Metrics -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Tickets Analyzed</div>
              <div id="ai-tickets-analyzed" style="font-size:32px;font-weight:800;color:#667eea">0</div>
              <div class="subtitle" style="margin-top:4px">Total processed</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Avg Confidence</div>
              <div id="ai-avg-confidence" style="font-size:32px;font-weight:800;color:#48bb78">--</div>
              <div class="subtitle" style="margin-top:4px">AI accuracy score</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Processing Speed</div>
              <div id="ai-avg-time" style="font-size:32px;font-weight:800;color:#ed8936">--</div>
              <div class="subtitle" style="margin-top:4px">Average time per ticket</div>
            </div>
          </div>

          <!-- Charts Row -->
          <div class="grid2 mb-16">
            <!-- Sentiment Distribution -->
            <div class="card p-16">
              <h4 class="mb-12">ğŸ˜Š Sentiment Distribution</h4>
              <div id="sentiment-chart" style="min-height:200px"></div>
            </div>

            <!-- Top Categories -->
            <div class="card p-16">
              <h4 class="mb-12">ğŸ“ Top Categories</h4>
              <div id="categories-chart" style="min-height:200px"></div>
            </div>
          </div>

          <!-- Root Causes -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">ğŸ” Root Cause Analysis</h4>
            <div id="root-causes-chart" style="min-height:180px"></div>
          </div>
        </div>

<!-- END AI Insights Dashboard -->

        <!-- Ticket Processing Rules -->
        <div id="view-ticket-rules" style="display:none">
          <div class="row space mb-12">
            <div class="row">
              <button class="btn ghost" onclick="switchView('dash')">â† Back</button>
              <h3 class="title" style="margin:0 0 0 8px">âš™ï¸ Ticket Processing Rules</h3>
            </div>
            <button class="btn" onclick="showCreateRuleModal()">+ Create Rule</button>
          </div>

          <!-- Statistics Card -->
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Total Rules</div>
              <div id="rules-total" style="font-size:32px;font-weight:800;color:#667eea">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Enabled Rules</div>
              <div id="rules-enabled" style="font-size:32px;font-weight:800;color:#48bb78">0</div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Executions (24h)</div>
              <div id="rules-executions-24h" style="font-size:32px;font-weight:800;color:#ed8936">0</div>
            </div>
          </div>

          <!-- Rules List -->
          <div class="card p-16">
            <h4 class="mb-12">Rules</h4>
            <div id="rules-list">
              <div class="subtitle">Loading rules...</div>
            </div>
          </div>
        </div>

        <!-- Create/Edit Rule Modal -->
        <div id="rule-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;padding:20px;overflow-y:auto">
          <div class="card" style="max-width:600px;margin:40px auto;padding:24px">
            <div class="row space mb-16">
              <h3 id="rule-modal-title">Create Rule</h3>
              <button class="btn ghost" onclick="closeRuleModal()">âœ• Close</button>
            </div>

            <form id="rule-form" onsubmit="saveRule(event)">
              <input type="hidden" id="rule-id">

              <!-- Rule Name -->
              <div class="mb-12">
                <label style="display:block;margin-bottom:4px;font-weight:600">Rule Name *</label>
                <input type="text" id="rule-name" class="input" placeholder="e.g., Auto-assign Infrastructure Alerts" required style="width:100%">
              </div>

              <!-- Description -->
              <div class="mb-12">
                <label style="display:block;margin-bottom:4px;font-weight:600">Description</label>
                <textarea id="rule-description" class="input" rows="2" placeholder="Optional description" style="width:100%"></textarea>
              </div>

              <!-- Enabled -->
              <div class="mb-16">
                <label style="display:flex;align-items:center;cursor:pointer">
                  <input type="checkbox" id="rule-enabled" checked style="margin-right:8px">
                  <span style="font-weight:600">Enable this rule</span>
                </label>
              </div>

              <!-- Search Criteria Section -->
              <div class="mb-16" style="padding:16px;background:#f7fafc;border-radius:6px">
                <h4 class="mb-12">ğŸ” Search Criteria</h4>

                <div class="mb-12">
                  <label style="display:block;margin-bottom:4px;font-weight:600">Search In *</label>
                  <select id="rule-search-in" class="input" style="width:100%">
                    <option value="both">Title and Body</option>
                    <option value="title">Title Only</option>
                    <option value="body">Body Only</option>
                  </select>
                </div>

                <div class="mb-12">
                  <label style="display:block;margin-bottom:4px;font-weight:600">Search Text *</label>
                  <input type="text" id="rule-search-text" class="input" placeholder="e.g., Infrastructure Monitoring" required style="width:100%">
                </div>

                <div class="mb-12">
                  <label style="display:flex;align-items:center;cursor:pointer">
                    <input type="checkbox" id="rule-case-sensitive" style="margin-right:8px">
                    <span>Case sensitive matching</span>
                  </label>
                </div>
              </div>

              <!-- Action Section -->
              <div class="mb-16" style="padding:16px;background:#f7fafc;border-radius:6px">
                <h4 class="mb-12">âš¡ Action</h4>

                <div class="mb-12">
                  <label style="display:block;margin-bottom:4px;font-weight:600">Action Type *</label>
                  <select id="rule-action-type" class="input" onchange="updateActionParams()" style="width:100%" required>
                    <option value="">Select an action...</option>
                    <option value="delete">Delete Ticket</option>
                    <option value="assign_to_expert">Assign to Expert</option>
                    <option value="create_for_customer">Create for Customer</option>
                    <option value="set_priority">Set Priority</option>
                    <option value="set_status">Set Status</option>
                    <option value="add_tag">Add Tag</option>
                  </select>
                </div>

                <!-- Dynamic Action Parameters -->
                <div id="action-params-container"></div>
              </div>

              <!-- Buttons -->
              <div class="row" style="gap:8px;justify-content:flex-end">
                <button type="button" class="btn ghost" onclick="closeRuleModal()">Cancel</button>
                <button type="submit" class="btn">Save Rule</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Tickets -->
        <div id="view-tickets" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Tickets</h3></div>
            <button class="btn" onclick="exportTicketsToCSV()">ğŸ“Š Export CSV</button>
          </div>

          <!-- Filters -->
          <div class="card p-16 mb-16">
            <div class="row space mb-12">
              <h4 style="margin:0">Filters & Search</h4>
              <button class="btn ghost" onclick="clearTicketFilters()">Clear Filters</button>
            </div>
            <div class="row wrap" style="gap:12px">
              <div style="min-width:200px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Search</label>
                <input id="ticket-search" class="input" placeholder="Search by ID, title..." oninput="renderList(); saveFilterSettings('tickets')" style="width:100%">
              </div>
              <div style="min-width:150px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Status</label>
                <select id="ticket-filter-status" class="input" onchange="renderList(); saveFilterSettings('tickets')" style="width:100%">
                  <option value="">All Statuses</option>
                  <option value="Open">Open</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Pending">Pending</option>
                  <option value="Resolved">Resolved</option>
                  <option value="Closed">Closed</option>
                </select>
              </div>
              <div style="min-width:150px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Priority</label>
                <select id="ticket-filter-priority" class="input" onchange="renderList(); saveFilterSettings('tickets')" style="width:100%">
                  <option value="">All Priorities</option>
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
              <div style="min-width:150px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Assignee</label>
                <select id="ticket-filter-assignee" class="input" onchange="renderList(); saveFilterSettings('tickets')" style="width:100%">
                  <option value="">All Assignees</option>
                  <option value="unassigned">Unassigned</option>
                </select>
              </div>
              <div style="min-width:180px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Company</label>
                <select id="ticket-filter-company" class="input" onchange="onCompanyFilterChange(); saveFilterSettings('tickets')" style="width:100%">
                  <option value="">All Companies</option>
                </select>
              </div>
              <div style="min-width:180px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Team Member</label>
                <select id="ticket-filter-customer" class="input" onchange="renderList(); saveFilterSettings('tickets')" style="width:100%">
                  <option value="">All Team Members</option>
                </select>
              </div>
              <div style="min-width:150px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Sort By</label>
                <select id="ticket-sort" class="input" onchange="renderList(); saveFilterSettings('tickets')" style="width:100%">
                  <option value="id-desc">ID (Newest First)</option>
                  <option value="id-asc">ID (Oldest First)</option>
                  <option value="priority-desc">Priority (High to Low)</option>
                  <option value="priority-asc">Priority (Low to High)</option>
                  <option value="status">Status</option>
                  <option value="sla">SLA (Urgent First)</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top:12px">
              <div id="ticket-count" class="subtitle">Showing 0 tickets</div>
            </div>
          </div>

          <div class="card p-16 mb-16">
            <div id="bulk-actions-bar" class="row" style="display:none;gap:8px;margin-bottom:12px;padding:12px;background:#f0f4f8;border-radius:8px;align-items:center">
              <span id="bulk-selected-count" style="font-weight:600">0 selected</span>
              <button class="btn success" onclick="openBulkActionDialog('close')">Close Selected</button>
              <button class="btn primary" onclick="openBulkActionDialog('assign')">Assign Selected</button>
              <button class="btn" onclick="openBulkActionDialog('resolve')">Resolve Selected</button>
              <button class="btn ghost" onclick="clearBulkSelection()">Clear Selection</button>
            </div>
            <table id="tickets-table"><thead><tr><th style="width:40px"><input type="checkbox" id="select-all-tickets" onchange="toggleSelectAllTickets()" title="Select All"></th><th style="width:120px;cursor:pointer" onclick="sortTicketsBy('id')">ID â‡…</th><th style="cursor:pointer" onclick="sortTicketsBy('title')">Title â‡…</th><th style="width:140px">Date/Time</th><th style="width:120px;cursor:pointer" onclick="sortTicketsBy('priority')">Priority â‡…</th><th style="width:140px;cursor:pointer" onclick="sortTicketsBy('status')">Status â‡…</th><th style="width:180px">Assignee</th><th style="width:160px">Customer</th><th style="width:220px;cursor:pointer" onclick="sortTicketsBy('sla')">SLA â‡…</th></tr></thead><tbody id="list-body"></tbody></table>
          </div>
        </div>

        <!-- Ticket Detail -->
        <div id="view-ticket-detail" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('tickets')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Ticket <span id="td-id"></span></h3></div>
            <div class="row wrap">
              <button id="btn-self-assign" class="btn success" onclick="selfAssignTicket()" style="display:none">ğŸ‘‹ Self Assign</button>
              <button id="btn-next" class="btn primary" onclick="advanceStatus()">Next status</button>
              <button id="btn-resolve" class="btn" onclick="openCompletion('resolve')">Resolve</button>
              <button id="btn-reassign" class="btn" onclick="openCompletion('reassign')">Reassign</button>
              <button class="btn warn" onclick="pauseSLA()">Pause SLA</button>
              <button class="btn" onclick="resumeSLA()">Resume SLA</button>
              <button id="btn-ai-assist" class="btn ai-btn" onclick="loadAISuggestions()">AI Assist</button>
            </div>
          </div>
          <!-- AI Suggestions Panel -->
          <div id="ai-panel" class="card p-16 mb-16" style="display:none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="row space mb-12">
              <div class="row" style="gap:8px">
                <span style="font-size:20px">AI</span>
                <strong style="font-size:16px">AI Assistant</strong>
              </div>
              <button class="btn ghost" onclick="hideAIPanel()" style="color:white;border-color:rgba(255,255,255,0.3)">Close</button>
            </div>
            <div id="ai-loading" style="text-align:center;padding:20px;">
              <div style="font-size:14px">Analyzing ticket...</div>
            </div>
            <div id="ai-content" style="display:none">
              <!-- Analysis Summary -->
              <div class="ai-section mb-12" style="background:rgba(255,255,255,0.1);border-radius:8px;padding:12px">
                <div style="font-weight:600;margin-bottom:8px">Analysis</div>
                <div id="ai-summary" style="font-size:14px"></div>
                <div class="row wrap" style="gap:8px;margin-top:8px">
                  <span id="ai-urgency" class="badge"></span>
                  <span id="ai-complexity" class="badge" style="background:rgba(255,255,255,0.2)"></span>
                  <span id="ai-time" class="badge" style="background:rgba(255,255,255,0.2)"></span>
                </div>
              </div>
              <!-- One-Click Actions -->
              <div class="ai-section mb-12">
                <div style="font-weight:600;margin-bottom:8px">Suggested Actions</div>
                <div id="ai-actions" class="row wrap" style="gap:8px"></div>
              </div>
              <!-- Draft Response -->
              <div class="ai-section mb-12" id="ai-draft-section" style="display:none">
                <div style="font-weight:600;margin-bottom:8px">Draft Response</div>
                <textarea id="ai-draft" class="input" style="background:rgba(255,255,255,0.9);color:#333;min-height:100px;font-size:13px"></textarea>
                <button class="btn" onclick="useAIDraft()" style="margin-top:8px;background:white;color:#764ba2">Use This Response</button>
              </div>
              <!-- Next Steps -->
              <div class="ai-section" id="ai-steps-section" style="display:none">
                <div style="font-weight:600;margin-bottom:8px">Recommended Next Steps</div>
                <ul id="ai-steps" style="margin:0;padding-left:20px;font-size:13px"></ul>
              </div>
              <!-- Warnings -->
              <div class="ai-section mt-12" id="ai-warnings-section" style="display:none;background:rgba(255,200,0,0.2);border-radius:8px;padding:12px">
                <div style="font-weight:600;margin-bottom:4px">Warnings</div>
                <div id="ai-warnings" style="font-size:13px"></div>
              </div>
            </div>
          </div>
          <div class="grid2">
            <div class="card p-16">
              <div class="mb-12"><div class="subtitle">Title</div><input id="td-title" class="input"/></div>
              <div class="mb-12"><div class="subtitle">Description</div><textarea id="td-desc" class="input" placeholder="(Demo text)"></textarea></div>
              <div class="row mb-12">
                <div style="flex:1"><div class="subtitle">Priority</div><select id="td-priority" class="input"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div>
                <div style="flex:1"><div class="subtitle">Status</div><select id="td-status" class="input" disabled><option>Open</option><option>In Progress</option><option>Pending</option><option>Resolved</option></select></div>
              </div>
              <div class="row mb-12">
                <div style="flex:1">
                  <div class="subtitle">Assignee</div>
                  <div style="display: flex; gap: 8px;">
                    <select id="td-assignee" class="input" style="flex: 1;">
                      <option value="">-- Select Expert --</option>
                    </select>
                    <button onclick="assignTicket()" class="btn btn-primary" style="white-space: nowrap;">Assign</button>
                  </div>
                </div>
                <div style="flex:1"><div class="subtitle">Due</div><input id="td-due" class="input"/></div>
              </div>
              <div class="row mb-12">
                <div style="flex:1"><div class="subtitle">Customer</div><input id="td-customer" class="input" disabled/></div>
                <div style="flex:1"><div class="subtitle">Linked Item</div><input id="td-item" class="input" placeholder="(optional)"/></div>
              </div>
              <div class="mb-12"><div class="subtitle">Linked CI</div><input id="td-ci" class="input" placeholder="(optional)"/></div>

              <div class="mb-12">
                <div class="subtitle">SLA</div>
                <div class="row wrap">
                  <span id="td-sla-badge" class="badge sla">â€”</span>
                  <div class="progress" style="flex:1;min-width:160px"><span id="td-sla-progress" style="width:0%"></span></div>
                </div>
                <div class="subtitle" id="td-sla-text" style="margin-top:6px"></div>
              </div>
            </div>
            <div class="card p-16">
              <div class="subtitle"><strong>Activity</strong></div>
              <div id="td-activity" class="mb-12" style="max-height:240px;overflow:auto"></div>
              <div class="row">
                <input id="td-note" class="input" placeholder="Add an internal noteâ€¦"/>
                <button class="btn" onclick="addNote()">Add</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Experts List -->
        <div id="view-experts" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Manage Experts</h3></div>
            <div class="row" style="gap:8px">
              <button class="btn primary" onclick="showCreateExpertForm()">+ Add Expert</button>
              <input id="expert-search" class="input" style="min-width:260px" placeholder="Search experts by name, username, location..." oninput="renderExperts(); saveFilterSettings('experts')"/>
            </div>
          </div>
          <div class="card p-16">
            <table>
              <thead>
                <tr>
                  <th>Real Name</th>
                  <th>Username</th>
                  <th>Location</th>
                  <th>Email</th>
                  <th>Open Tickets</th>
                  <th>Last Login</th>
                  <th style="width:180px">Actions</th>
                </tr>
              </thead>
              <tbody id="experts-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Expert Detail View -->
        <div id="view-expert-detail" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('experts')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Expert Details</h3></div>
            <div class="row" style="gap:8px">
              <button class="btn primary" onclick="editExpert()">Edit Expert</button>
              <button class="btn danger" onclick="deleteExpertPrompt()">Delete</button>
            </div>
          </div>

          <!-- Account Info Section -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">Account Info</h4>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Expert Type:</div><div id="expert-role" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Username:</div><div id="expert-username" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Account Status:</div><div id="expert-status" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Email Updates:</div><div id="expert-email-updates" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Reference Code:</div><div id="expert-reference" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Open Tickets:</div><div id="expert-open-tickets" style="font-weight:600"></div></div>
          </div>

          <!-- Account Statistics -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">Account Statistics</h4>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Created By:</div><div id="expert-created-by" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Updated By:</div><div id="expert-updated-by" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Created:</div><div id="expert-created-at" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Updated:</div><div id="expert-updated-at" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Last Login:</div><div id="expert-last-login" style="font-weight:600"></div></div>
          </div>

          <!-- System Settings -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">System Settings</h4>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Time Zone:</div><div id="expert-timezone" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Support Language:</div><div id="expert-language" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Interface Language:</div><div id="expert-interface-lang" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Security Level:</div><div id="expert-security-level" style="font-weight:600"></div></div>
          </div>

          <!-- Ticket Permissions -->
          <div class="card p-16 mb-16">
            <div class="row space mb-12">
              <h4 style="margin:0">Ticket Permissions</h4>
              <button class="btn primary small" onclick="showExpertPermissionsModal()">Manage Permissions</button>
            </div>
            <div id="expert-permissions-list">
              <div class="subtitle" style="color:#999">Loading permissions...</div>
            </div>
          </div>

          <!-- User Details -->
          <div class="card p-16 mb-16">
            <h4 class="mb-12">User Details</h4>
            <div class="row mb-8"><div class="subtitle" style="width:180px">First Name:</div><div id="expert-first-name" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Middle Name:</div><div id="expert-middle-name" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Last Name:</div><div id="expert-last-name" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Screen Name:</div><div id="expert-screen-name" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Street Address:</div><div id="expert-street" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">City:</div><div id="expert-city" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">State/Province:</div><div id="expert-state" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Postal Code:</div><div id="expert-postcode" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Country:</div><div id="expert-country" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Contact Number:</div><div id="expert-contact" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Location:</div><div id="expert-location" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Department:</div><div id="expert-department" style="font-weight:600"></div></div>
            <div class="row mb-8"><div class="subtitle" style="width:180px">Email:</div><div id="expert-email" style="font-weight:600"></div></div>
          </div>
        </div>

        <!-- Customers -->
        <div id="view-customers" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Manage Customers</h3></div>
            <div class="row" style="gap:8px">
              <button class="btn primary" onclick="showCreateCustomerCompanyForm()">+ Add Company</button>
              <button class="btn" onclick="showCreateCustomerForm()">+ Add Team Member</button>
            </div>
          </div>
          <!-- Filters -->
          <div class="card p-16 mb-16">
            <div class="row space mb-12">
              <h4 style="margin:0">Filters</h4>
              <button class="btn ghost" onclick="clearCustomerFilters()">Clear Filters</button>
            </div>
            <div class="row wrap" style="gap:12px">
              <div style="min-width:200px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Search</label>
                <input id="cust-search" class="input" placeholder="Search by name, email..." oninput="renderCustomers(); saveFilterSettings('customers')" style="width:100%">
              </div>
              <div style="min-width:200px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Company</label>
                <select id="cust-filter-company" class="input" onchange="renderCustomers(); saveFilterSettings('customers')" style="width:100%">
                  <option value="">All Companies</option>
                </select>
              </div>
              <div style="min-width:150px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">SLA Level</label>
                <select id="cust-filter-sla" class="input" onchange="renderCustomers(); saveFilterSettings('customers')" style="width:100%">
                  <option value="">All SLA Levels</option>
                  <option value="basic">Basic</option>
                  <option value="premium">Premium</option>
                  <option value="enterprise">Enterprise</option>
                </select>
              </div>
              <div style="min-width:150px">
                <label style="display:block;margin-bottom:4px;font-size:13px;font-weight:600">Status</label>
                <select id="cust-filter-status" class="input" onchange="renderCustomers(); saveFilterSettings('customers')" style="width:100%">
                  <option value="">All</option>
                  <option value="active">Active Only</option>
                  <option value="inactive">Inactive Only</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top:12px">
              <div id="customer-count" class="subtitle">Showing 0 customers</div>
            </div>
          </div>
          <div class="card p-16"><table><thead><tr><th style="cursor:pointer" onclick="sortCustomersBy('name')">Name â‡…</th><th>Email</th><th>Company</th><th>Role</th><th style="width:80px;cursor:pointer" onclick="sortCustomersBy('tickets')"># Tickets â‡…</th><th>SLA</th><th style="width:180px">Actions</th></tr></thead><tbody id="customers-body"></tbody></table></div>
        </div>

        <!-- Customer Form Modal -->
        <div id="customer-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto">
          <div style="max-width:600px;margin:40px auto;background:white;border-radius:8px;padding:24px">
            <div class="row space mb-16">
              <h3 id="customer-modal-title" class="title" style="margin:0">Add Customer</h3>
              <button class="btn ghost" onclick="closeCustomerModal()">âœ•</button>
            </div>

            <form id="customer-form" onsubmit="saveCustomer(event); return false;">
              <input type="hidden" id="customer-id"/>

              <h4 class="mb-12">Account Information</h4>

              <div class="mb-12">
                <label class="subtitle">Username *</label>
                <input id="customer-username" class="input" required placeholder="e.g., john_doe" pattern="[a-zA-Z0-9_]+" title="Only letters, numbers, and underscores"/>
                <div class="subtitle" style="color:#6b7280;font-size:12px;margin-top:4px">Used for login. Only letters, numbers, and underscores.</div>
              </div>

              <div class="mb-12">
                <label class="subtitle">Email *</label>
                <input id="customer-email" class="input" type="email" required placeholder="e.g., john@example.com"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Full Name</label>
                <input id="customer-fullname" class="input" placeholder="e.g., John Doe"/>
              </div>

              <h4 class="mb-12 mt-16">Company Information</h4>

              <div class="mb-12">
                <label class="subtitle">Company Name *</label>
                <input id="customer-company" class="input" required placeholder="e.g., Acme Corporation"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Company Domain *</label>
                <input id="customer-domain" class="input" required placeholder="e.g., example.com" pattern="[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?(\.[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?)*\.[a-zA-Z]{2,}" title="Valid domain like example.com"/>
                <div class="subtitle" style="color:#6b7280;font-size:12px;margin-top:4px">Email domain for incoming ticket matching (e.g., if domain is "example.com", emails from user@example.com will create tickets).</div>
              </div>

              <div class="mb-12">
                <label class="subtitle">Contact Phone</label>
                <input id="customer-phone" class="input" type="tel" placeholder="e.g., +1-555-0123"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Address</label>
                <textarea id="customer-address" class="input" rows="3" placeholder="Company address"></textarea>
              </div>

              <div class="mb-12">
                <label class="subtitle">SLA Level</label>
                <select id="customer-sla" class="input">
                  <option value="basic">Basic (48h response)</option>
                  <option value="premium">Premium (24h response)</option>
                  <option value="enterprise">Enterprise (4h response)</option>
                </select>
              </div>

              <div id="customer-form-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
              <div id="customer-form-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>

              <div class="row" style="gap:8px;margin-top:24px;justify-content:flex-end">
                <button type="button" class="btn ghost" onclick="closeCustomerModal()">Cancel</button>
                <button type="submit" class="btn primary">
                  <span id="customer-save-btn-text">Create Customer</span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Customer Company Form Modal -->
        <div id="company-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto">
          <div style="max-width:600px;margin:40px auto;background:white;border-radius:8px;padding:24px">
            <div class="row space mb-16">
              <h3 id="company-modal-title" class="title" style="margin:0">Add Customer Company</h3>
              <button class="btn ghost" onclick="closeCompanyModal()">âœ•</button>
            </div>

            <form id="company-form" onsubmit="saveCustomerCompany(event); return false;">
              <input type="hidden" id="company-id"/>

              <p class="subtitle mb-16">Create a new customer company. An admin user will be automatically created with email admin@{domain}.</p>

              <div class="mb-12">
                <label class="subtitle">Company Name *</label>
                <input id="company-name" class="input" required placeholder="e.g., Acme Corporation"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Company Domain *</label>
                <input id="company-domain" class="input" required placeholder="e.g., acme.com" pattern="[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?(\.[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?)*\.[a-zA-Z]{2,}" title="Valid domain like example.com"/>
                <div class="subtitle" style="color:#6b7280;font-size:12px;margin-top:4px">Admin email will be: admin@{domain}</div>
              </div>

              <div class="mb-12">
                <label class="subtitle">Contact Phone</label>
                <input id="company-phone" class="input" type="tel" placeholder="e.g., +1-555-0123"/>
              </div>

              <div class="mb-12">
                <label class="subtitle">Address</label>
                <textarea id="company-address" class="input" rows="3" placeholder="Company address"></textarea>
              </div>

              <div class="mb-12">
                <label class="subtitle">SLA Level</label>
                <select id="company-sla" class="input">
                  <option value="basic">Basic (48h response)</option>
                  <option value="premium">Premium (24h response)</option>
                  <option value="enterprise">Enterprise (4h response)</option>
                </select>
              </div>

              <div class="mb-12">
                <label class="subtitle">Notes</label>
                <textarea id="company-notes" class="input" rows="2" placeholder="Internal notes about this company"></textarea>
              </div>

              <div id="company-form-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
              <div id="company-form-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>

              <div class="row" style="gap:8px;margin-top:24px;justify-content:flex-end">
                <button type="button" class="btn ghost" onclick="closeCompanyModal()">Cancel</button>
                <button type="submit" class="btn primary">
                  <span id="company-save-btn-text">Create Company</span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Expert Permissions Modal -->
        <div id="expert-permissions-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto">
          <div style="max-width:700px;margin:40px auto;background:white;border-radius:8px;padding:24px">
            <div class="row space mb-16">
              <h3 style="margin:0">Manage Ticket Permissions</h3>
              <button class="btn ghost small" onclick="closeExpertPermissionsModal()">âœ•</button>
            </div>

            <p class="subtitle mb-16">Configure which tickets this expert can view and self-assign.</p>

            <!-- Current Permissions -->
            <div class="card p-12 mb-16" style="background:#f9fafb">
              <h4 class="mb-12">Current Permissions</h4>
              <div id="current-permissions-list">
                <div class="subtitle" style="color:#999">Loading...</div>
              </div>
            </div>

            <!-- Add New Permission -->
            <div class="card p-16">
              <h4 class="mb-12">Add New Permission</h4>

              <div class="mb-12">
                <label class="subtitle">Permission Type</label>
                <select id="perm-type" class="input" onchange="updatePermissionForm()">
                  <option value="">Select permission type...</option>
                  <option value="all_tickets">All Tickets</option>
                  <option value="specific_customers">Specific Customer</option>
                  <option value="title_patterns">Title Pattern</option>
                </select>
              </div>

              <!-- Customer Selection (shown when specific_customers is selected) -->
              <div id="perm-customer-section" style="display:none" class="mb-12">
                <label class="subtitle">Customer</label>
                <select id="perm-customer" class="input">
                  <option value="">Select customer...</option>
                </select>
              </div>

              <!-- Title Pattern Input (shown when title_patterns is selected) -->
              <div id="perm-pattern-section" style="display:none" class="mb-12">
                <label class="subtitle">Title Pattern</label>
                <input id="perm-pattern" class="input" placeholder="e.g., 'Password Reset' or 'Network'" />
                <div class="subtitle" style="color:#666;margin-top:4px">Expert will see tickets containing this text in the title</div>
              </div>

              <div id="perm-form-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
              <div id="perm-form-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>

              <div class="row" style="gap:8px;margin-top:16px;justify-content:flex-end">
                <button class="btn primary" onclick="addExpertPermission()">Add Permission</button>
              </div>
            </div>
          </div>
        </div>

        <!-- CMDB -->
        <div id="view-cmdb" style="display:none">
          <div class="row space mb-12">
            <div class="row"><h3 class="title" style="margin:0">CMDB Items</h3></div>
            <div class="row" style="gap:8px">
              <button class="btn primary" onclick="showCreateCMDBForm()">+ Add CMDB Item</button>
              <button class="btn" onclick="showImportCMDBDialog()">ğŸ“¥ Import CMDB Items</button>
              <input id="cmdb-search" class="input" style="min-width:260px" placeholder="Search by Item or Customer" oninput="renderCMDB(); saveFilterSettings('cmdb')"/>
              <select id="cmdb-customer" class="input" style="max-width:220px" onchange="renderCMDB(); saveFilterSettings('cmdb')">
                <option value="">All customers</option>
              </select>
            </div>
          </div>
          <div class="card p-16">
            <table>
              <thead><tr><th style="width:200px">Customer</th><th>CMDB Item</th><th style="width:160px"></th></tr></thead>
              <tbody id="cmdb-body"></tbody>
            </table>
          </div>
        </div>

        <div id="view-cmdb-detail" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('cmdb')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">CMDB Item: <span id="cmdb-name-h"></span></h3></div>
          </div>
          <div class="card p-16 mb-16">
            <div class="row"><div class="subtitle">Customer:</div><div id="cmdb-customer-h" style="font-weight:600"></div></div>
            <div class="row"><div class="subtitle">CMDB ID:</div><div id="cmdb-id-h" style="font-weight:600"></div></div>
          </div>
          <div class="card p-16">
            <h4 class="mb-12">Configurable Items (CIs)</h4>
            <table><thead id="ci-head"></thead><tbody id="ci-body"></tbody></table>
          </div>
        </div>

        <!-- Manage CMDB Types -->
        <div id="view-manage-cmdb" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Manage CMDB Types</h3></div>
            <button class="btn primary" onclick="showCreateItemTypeForm()">+ Add Item Type</button>
          </div>
          
          <!-- CMDB Item Types List -->
          <div class="card p-16 mb-16">
            <h4>CMDB Item Types</h4>
            <table class="mt-16">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>CI Types</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="item-types-body"></tbody>
            </table>
          </div>

          <!-- CI Types List (shown when item type is selected) -->
          <div class="card p-16" id="ci-types-section" style="display:none">
            <div class="row space mb-12">
              <div class="row">
                <h4>CI Types for: <span id="selected-item-type-name"></span></h4>
              </div>
              <button class="btn primary" onclick="showCreateCITypeForm()">+ Add CI Type</button>
            </div>
            <table class="mt-16">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ci-types-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Usage Dashboard -->
        <div id="view-usage" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Usage & Limits</h3></div>
            <button class="btn" onclick="refreshUsage()">ğŸ”„ Refresh</button>
          </div>
          
          <div class="grid3 mb-16">
            <div class="card p-16">
              <div class="subtitle">Users</div>
              <div id="usage-users-current" style="font-size:28px;font-weight:800">0</div>
              <div class="subtitle">of <span id="usage-users-limit">0</span> allowed</div>
              <div class="progress-bar" style="margin-top:8px">
                <div id="usage-users-progress" class="progress-fill" style="width:0%"></div>
              </div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Tickets</div>
              <div id="usage-tickets-current" style="font-size:28px;font-weight:800">0</div>
              <div class="subtitle">of <span id="usage-tickets-limit">0</span> allowed</div>
              <div class="progress-bar" style="margin-top:8px">
                <div id="usage-tickets-progress" class="progress-fill" style="width:0%"></div>
              </div>
            </div>
            <div class="card p-16">
              <div class="subtitle">Storage</div>
              <div id="usage-storage-current" style="font-size:28px;font-weight:800">0</div>
              <div class="subtitle">of <span id="usage-storage-limit">0</span> GB allowed</div>
              <div class="progress-bar" style="margin-top:8px">
                <div id="usage-storage-progress" class="progress-fill" style="width:0%"></div>
              </div>
            </div>
          </div>
          
          <div class="card p-16 mb-16">
            <h4>Usage Alerts</h4>
            <div id="usage-alerts">
              <div class="subtitle">Loading usage data...</div>
            </div>
          </div>
          
          <div class="card p-16">
            <h4>Test Usage Limits</h4>
            <div class="row" style="gap:16px;margin-bottom:16px">
              <button class="btn" onclick="testUsageLimit('users', 1)">+1 User</button>
              <button class="btn" onclick="testUsageLimit('tickets', 1)">+1 Ticket</button>
              <button class="btn" onclick="testUsageLimit('storage', 1)">+1 GB Storage</button>
            </div>
            <div class="subtitle">Click buttons to test usage limit enforcement</div>
          </div>
        </div>

        <!-- Admin Settings Wizard -->
        <div id="view-wizard" style="display:none">
          <div class="row space mb-12">
            <h3 class="title" style="margin:0">Admin Settings Wizard</h3>
          </div>

          <!-- Company Profile Section -->
          <div id="admin-section-profile" class="card p-16 mb-12">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">Company Profile</h4>
              <button class="btn primary" onclick="saveCompanyProfile()">Save Profile</button>
            </div>

            <div class="mb-12">
              <label class="subtitle">Company Name</label>
              <input id="profile-company-name" class="input" placeholder="e.g., Your Company Name"/>
            </div>

            <div class="mb-12">
              <label class="subtitle">Contact Phone</label>
              <input id="profile-contact-phone" class="input" placeholder="e.g., +1 (555) 123-4567"/>
            </div>

            <div class="mb-12">
              <label class="subtitle">Mail From Email Address</label>
              <input id="profile-mail-from" class="input" type="email" placeholder="e.g., support@company.com"/>
            </div>

            <div class="mb-12">
              <label class="subtitle">Company URL Domain</label>
              <input id="profile-company-url" class="input" placeholder="e.g., https://company.com"/>
            </div>

            <div id="profile-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
            <div id="profile-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
          </div>

          <!-- Email Ingest Rules Section -->
          <div id="admin-section-email-ingest" class="card p-16 mb-12">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">Email Ingest Rules</h4>
              <div class="row">
                <button class="btn" onclick="testEmailConnection()">Test Connection</button>
                <button class="btn primary" onclick="saveEmailIngestSettings()">Save Settings</button>
              </div>
            </div>

            <div class="mb-12">
              <label class="subtitle">
                <input type="checkbox" id="email-ingest-enabled" style="margin-right:8px"/>
                Enable Email Ingest
              </label>
            </div>

            <div class="subtitle mb-12" style="background:#eff6ff;padding:12px;border-radius:4px;border-left:4px solid #2563eb">
              <strong>How it works:</strong> Emails from customer domains in your system will automatically create tickets. 
              If the sender email exists, a ticket is created for that customer. If the sender is new but their domain matches 
              an existing customer domain, a new customer account is created and a ticket is generated. Confirmation emails with 
              ticket links are sent automatically.
            </div>

            <div class="mb-12">
              <label class="subtitle">Server Type</label>
              <select id="email-server-type" class="input">
                <option value="imap">IMAP</option>
                <option value="pop3">POP3</option>
              </select>
            </div>

            <div class="mb-12">
              <label class="subtitle">Server Host</label>
              <input id="email-server-host" class="input" placeholder="e.g., imap.gmail.com"/>
            </div>

            <div class="mb-12">
              <label class="subtitle">Server Port</label>
              <input id="email-server-port" class="input" type="number" placeholder="e.g., 993"/>
            </div>

            <div class="mb-12">
              <label class="subtitle">
                <input type="checkbox" id="email-use-ssl" style="margin-right:8px" checked/>
                Use SSL/TLS
              </label>
            </div>

            <div class="mb-12">
              <label class="subtitle">Email Username</label>
              <input id="email-username" class="input" placeholder="e.g., support@company.com"/>
            </div>

            <div class="mb-12">
              <label class="subtitle">Email Password</label>
              <input id="email-password" class="input" type="password" placeholder="Enter password"/>
            </div>

            <div class="mb-12">
              <label class="subtitle">Check Interval (minutes)</label>
              <input id="email-check-interval" class="input" type="number" min="1" max="60" placeholder="e.g., 5"/>
            </div>

            <div id="email-last-checked" class="subtitle" style="color:#666;margin-top:8px"></div>
            <div id="email-ingest-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
            <div id="email-ingest-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
          </div>

          <!-- Support Settings -->
          <div class="card p-16 mb-12">
            <div class="row space mb-12">
              <h4 class="subtitle" style="margin:0;font-weight:600">Support Settings</h4>
              <button class="btn primary" onclick="saveSupportSettings()">Save Settings</button>
            </div>

            <div class="mb-12">
              <label class="subtitle">
                <input type="checkbox" id="resolution-requires-acceptance" style="margin-right:8px" checked/>
                Resolution Requires Customer Acceptance
              </label>
              <div class="subtitle" style="margin-top:8px;color:#666;font-size:13px">
                When enabled, customers must accept or reject ticket resolutions via email.
                If accepted, they'll be asked to provide a CSAT rating. If rejected, the ticket
                will be reopened and the support team notified.
              </div>
            </div>

            <div id="support-settings-message" class="subtitle" style="color:#16a34a;display:none;margin-top:8px"></div>
            <div id="support-settings-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:8px"></div>
          </div>

          <!-- Future Settings Placeholder -->
          <div class="card p-16">
            <div class="subtitle">Future settings: SLA configuration, ticket categories, user rolesâ€¦</div>
          </div>
        </div>

        <!-- Raise Request -->
        <div id="view-raise" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">Raise a Request</h3></div>
          </div>
          <div class="grid2">
            <div class="card p-16">
              <div id="rq-customer-field" class="mb-12" style="display:none">
                <label class="subtitle">Select Customer (required)</label>
                <select id="rq-customer" class="input" onchange="loadCMDBForCustomer()">
                  <option value="">â€” Select Customer â€”</option>
                </select>
              </div>
              <div class="mb-12"><label class="subtitle">Title (required)</label><input id="rq-title" class="input" placeholder="e.g., Cannot connect to VPN"/></div>
              <div class="mb-12"><label class="subtitle">Description (required)</label><textarea id="rq-desc" class="input" placeholder="Describe the issue or requestâ€¦"></textarea></div>
              <div class="mb-12"><label class="subtitle">Priority (optional)</label>
                <select id="rq-priority" class="input"><option value="">â€”</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select>
              </div>
              <div class="mb-12"><label class="subtitle">Link to CMDB Item (optional)</label><select id="rq-item" class="input"></select></div>
              <div class="mb-12"><label class="subtitle">Link to CI (optional)</label><select id="rq-ci" class="input"></select></div>
              <div class="mb-12"><label class="subtitle">Attachment (placeholder)</label><input class="input" placeholder="Choose fileâ€¦ (not uploaded in demo)"/></div>
              <div class="row"><button class="btn primary" onclick="submitRequest()">Submit request</button><button class="btn" onclick="startChat('assist')">Chat instead</button></div>
              <div class="subtitle" id="rq-hint" style="margin-top:8px">Optional fields can be blank â€” the assistant will help fill them.</div>
            </div>
            <div class="card p-16">
              <div class="subtitle"><strong>Tips</strong></div>
              <ul style="margin:0 0 0 16px;padding:0">
                <li>Link a CMDB Item & CI for faster triage.</li>
                <li>Use Priority if impact is high or widespread.</li>
                <li>Attachments help experts diagnose issues.</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- System Control -->
        <div id="view-system-control" style="display:none">
          <div class="row space mb-12">
            <div class="row"><button class="btn ghost" onclick="switchView('dash')">â† Back</button><h3 class="title" style="margin:0 0 0 8px">System Control</h3></div>
            <button class="btn primary" onclick="loadSystemControlSettings()">Refresh</button>
          </div>
          <div class="card p-16 mb-16" style="background:#fef3c7;border:1px solid #f59e0b">
            <div class="row" style="gap:8px;align-items:center">
              <span style="font-size:24px">âš ï¸</span>
              <div>
                <strong>Testing Kill Switches</strong>
                <div class="subtitle" style="color:#92400e">These controls disable system functionality for testing purposes. Use with caution in production.</div>
              </div>
            </div>
          </div>
          <div class="grid2">
            <div class="card p-16">
              <h4 class="mb-12">Email Controls</h4>

              <div class="card p-16 mb-12" style="border:2px solid #e2e8f0">
                <div class="row space" style="align-items:center">
                  <div>
                    <div style="font-weight:600;font-size:16px">Send Updates to Experts</div>
                    <div class="subtitle">Enable/disable email notifications to experts (ticket assignments, updates)</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="sc-send-emails-experts" onchange="toggleSystemSetting('send_emails_experts', this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div id="sc-send-emails-experts-status" class="subtitle" style="margin-top:8px;padding:8px;border-radius:4px"></div>
              </div>

              <div class="card p-16 mb-12" style="border:2px solid #e2e8f0">
                <div class="row space" style="align-items:center">
                  <div>
                    <div style="font-weight:600;font-size:16px">Send Updates to Customers</div>
                    <div class="subtitle">Enable/disable email notifications to customers (ticket status updates, responses)</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="sc-send-emails-customers" onchange="toggleSystemSetting('send_emails_customers', this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div id="sc-send-emails-customers-status" class="subtitle" style="margin-top:8px;padding:8px;border-radius:4px"></div>
              </div>

              <div class="card p-16 mb-12" style="border:2px solid #e2e8f0">
                <div class="row space" style="align-items:center">
                  <div>
                    <div style="font-weight:600;font-size:16px">Process Emails</div>
                    <div class="subtitle">Enable/disable inbound email processing (automatic ticket creation)</div>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="sc-process-emails" onchange="toggleSystemSetting('process_emails', this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div id="sc-process-emails-status" class="subtitle" style="margin-top:8px;padding:8px;border-radius:4px"></div>
              </div>
            </div>

            <div class="card p-16">
              <h4 class="mb-12">System Status</h4>
              <div id="sc-status-log" style="background:#f8fafc;border-radius:8px;padding:12px;max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px">
                Loading system status...
              </div>
              <div class="subtitle" style="margin-top:12px">
                <strong>Last Updated:</strong> <span id="sc-last-updated">â€”</span>
              </div>
            </div>
          </div>

          <div class="card p-16 mt-16">
            <h4 class="mb-12">Recent Setting Changes</h4>
            <table>
              <thead>
                <tr>
                  <th>Setting</th>
                  <th>Old Value</th>
                  <th>New Value</th>
                  <th>Changed By</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="sc-audit-log">
                <tr><td colspan="5" class="subtitle" style="text-align:center">No recent changes</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </main>
    </div>
  </section>
</div>

<!-- Chatbot -->
<button id="chat-toggle" class="btn accent">ğŸ’¬ Chat</button>
<div id="chat">
  <div class="panel">
    <div class="header">ServiFlow Assistant</div>
    <div id="chat-body" class="body"></div>
    <div class="footer" style="padding:12px">
      <input id="chat-input" class="input" placeholder="Type a messageâ€¦" onkeydown="if(event.key==='Enter') sendChat()"/>
      <button class="btn primary" onclick="sendChat()">Send</button>
    </div>
  </div>
</div>

<!-- Completion Modal -->
<div id="dlg" class="modal" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
  <div class="sheet">
    <div class="head"><span id="dlg-title">Complete Action</span></div>
    <div class="body">
      <div class="mb-12"><div class="subtitle">What did you do?</div>
        <textarea id="dlg-note" class="input" placeholder="Add a succinct completion noteâ€¦ (required)"></textarea>
      </div>
      <div id="dlg-assignee-row" class="mb-12" style="display:none">
        <div class="subtitle">New assignee</div>
        <select id="dlg-assignee" class="input">
          <option value="">-- Select Expert --</option>
        </select>
      </div>
      <div id="dlg-error" class="subtitle" style="color:#b91c1c;display:none"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeDlg()">Cancel</button>
      <button class="btn primary" onclick="submitDlg()">Confirm</button>
    </div>
  </div>
</div>

<!-- Bulk Action Modal -->
<div id="bulk-action-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bulk-action-title" style="display:none">
  <div class="sheet" style="max-width:500px">
    <div class="head"><span id="bulk-action-title">Bulk Action</span></div>
    <div class="body">
      <div id="bulk-action-summary" class="mb-12" style="padding:12px;background:#e0f2fe;border-radius:8px;font-weight:600"></div>
      <div id="bulk-action-assignee-row" class="mb-12" style="display:none">
        <div class="subtitle">Assign to Expert *</div>
        <select id="bulk-action-assignee" class="input">
          <option value="">-- Select Expert --</option>
        </select>
      </div>
      <div class="mb-12">
        <div class="subtitle">Action Note (applies to all selected tickets) *</div>
        <textarea id="bulk-action-note" class="input" placeholder="Enter a note that will be added to all selected tickets..." rows="3"></textarea>
      </div>
      <div id="bulk-action-error" class="subtitle" style="color:#b91c1c;display:none"></div>
      <div id="bulk-action-progress" style="display:none">
        <div class="subtitle">Processing...</div>
        <div class="progress"><span id="bulk-action-progress-bar" style="width:0%"></span></div>
        <div id="bulk-action-progress-text" class="subtitle" style="margin-top:4px">0 of 0 completed</div>
      </div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeBulkActionDialog()">Cancel</button>
      <button id="bulk-action-submit-btn" class="btn primary" onclick="submitBulkAction()">Confirm</button>
    </div>
  </div>
</div>

<!-- Expert Form Modal -->
<div id="expert-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="expert-modal-title" style="display:none">
  <div class="sheet" style="max-width:700px;max-height:90vh;overflow-y:auto">
    <div class="head"><span id="expert-modal-title">Add Expert</span></div>
    <div class="body">
      <h4 class="mb-12">Account Info</h4>
      <div class="mb-12">
        <div class="subtitle">Username *</div>
        <input id="expert-form-username" class="input" placeholder="Username"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Email *</div>
        <input id="expert-form-email" class="input" type="email" placeholder="Email address"/>
      </div>
      <div class="mb-12" id="expert-form-password-row">
        <div class="subtitle">Password *</div>
        <input id="expert-form-password" class="input" type="password" placeholder="Password"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Role *</div>
        <select id="expert-form-role" class="input">
          <option value="expert">Expert</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="mb-12">
        <div class="subtitle">Status</div>
        <select id="expert-form-status" class="input">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
      <div class="mb-12">
        <div class="subtitle">Rating</div>
        <input id="expert-form-rating" class="input" type="number" min="0" max="5" placeholder="0-5"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Reference Code</div>
        <input id="expert-form-reference" class="input" placeholder="Reference code"/>
      </div>
      <div class="mb-12">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input id="expert-form-email-updates" type="checkbox" checked/>
          <span>Send expert email updates</span>
        </label>
      </div>

      <h4 class="mb-12 mt-16">User Details</h4>
      <div class="mb-12">
        <div class="subtitle">Full Name</div>
        <input id="expert-form-fullname" class="input" placeholder="Full name"/>
      </div>
      <div class="row" style="gap:8px">
        <div class="mb-12" style="flex:1">
          <div class="subtitle">First Name</div>
          <input id="expert-form-firstname" class="input" placeholder="First name"/>
        </div>
        <div class="mb-12" style="flex:1">
          <div class="subtitle">Middle Name</div>
          <input id="expert-form-middlename" class="input" placeholder="Middle name"/>
        </div>
        <div class="mb-12" style="flex:1">
          <div class="subtitle">Last Name</div>
          <input id="expert-form-lastname" class="input" placeholder="Last name"/>
        </div>
      </div>
      <div class="mb-12">
        <div class="subtitle">Screen Name</div>
        <input id="expert-form-screenname" class="input" placeholder="Screen name"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Phone</div>
        <input id="expert-form-phone" class="input" placeholder="Phone number"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Department</div>
        <input id="expert-form-department" class="input" placeholder="Department"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Location</div>
        <input id="expert-form-location" class="input" placeholder="Location"/>
      </div>

      <h4 class="mb-12 mt-16">Address</h4>
      <div class="mb-12">
        <div class="subtitle">Street Address</div>
        <input id="expert-form-street" class="input" placeholder="Street address"/>
      </div>
      <div class="row" style="gap:8px">
        <div class="mb-12" style="flex:2">
          <div class="subtitle">City</div>
          <input id="expert-form-city" class="input" placeholder="City"/>
        </div>
        <div class="mb-12" style="flex:1">
          <div class="subtitle">State/Province</div>
          <input id="expert-form-state" class="input" placeholder="State"/>
        </div>
        <div class="mb-12" style="flex:1">
          <div class="subtitle">Postcode</div>
          <input id="expert-form-postcode" class="input" placeholder="Postcode"/>
        </div>
      </div>
      <div class="mb-12">
        <div class="subtitle">Country</div>
        <input id="expert-form-country" class="input" placeholder="Country"/>
      </div>

      <h4 class="mb-12 mt-16">System Settings</h4>
      <div class="mb-12">
        <div class="subtitle">Time Zone</div>
        <input id="expert-form-timezone" class="input" placeholder="e.g., UTC, America/New_York"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Support Language</div>
        <input id="expert-form-language" class="input" placeholder="e.g., English"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Interface Language</div>
        <input id="expert-form-interface-lang" class="input" placeholder="e.g., English"/>
      </div>
      <div class="mb-12">
        <div class="subtitle">Security Level</div>
        <input id="expert-form-security-level" class="input" placeholder="e.g., Agent Manager"/>
      </div>

      <div id="expert-form-error" class="subtitle" style="color:#b91c1c;display:none;margin-top:16px"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" onclick="closeExpertModal()">Cancel</button>
      <button class="btn primary" onclick="saveExpert()">Save Expert</button>
    </div>
  </div>
</div>

<script>
  // API Base URL - use current origin for deployed version, localhost for development
  const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:3000'
    : window.location.origin;

  // Error banner
  window.addEventListener('error', function(e) { const el=document.getElementById('err'); el.textContent='JavaScript error: ' + (e.message || e.error); el.style.display='block'; });

  // Pre-fill login form from URL parameters
  window.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username');
    const role = urlParams.get('role');

    // Pre-fill username if provided
    if (username) {
      const usernameField = document.getElementById('username');
      if (usernameField) {
        usernameField.value = decodeURIComponent(username);
        console.log('Pre-filled username from URL parameter');
      }
    }

    // Pre-fill role if provided
    if (role) {
      const roleField = document.getElementById('role');
      if (roleField) {
        roleField.value = role;
        console.log('Pre-filled role from URL parameter:', role);
      }
    }

    // Password field intentionally left empty for security
  });

  // ---- Data ----
  let CMDB_ITEMS = []; // Will be loaded from API
  let CIS_BY_ITEM = {}; // Will be loaded from API

  // Load CMDB items from API
  async function loadCMDBItemsFromAPI() {
    const tenantCode = window.tenant || 'apoyar';
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success && data.items) {
        CMDB_ITEMS = data.items.map(item => ({
          cmdb_id: item.cmdb_id,
          name: item.asset_name,
          customer: item.customer_name || '',
          category: item.asset_category,
          brand: item.brand_name,
          model: item.model_name,
          location: item.asset_location,
          status: item.status,
          ci_count: item.ci_count || 0
        }));
        renderCMDB();
      }
    } catch (err) {
      console.error('Error loading CMDB items:', err);
    }
  }

  // Load CIs for a specific CMDB item from API
  async function loadCIsForItem(cmdbId) {
    if (CIS_BY_ITEM[cmdbId]) return CIS_BY_ITEM[cmdbId];

    const tenantCode = window.tenant || 'apoyar';
    const token = localStorage.getItem('token');
    if (!token) return [];

    try {
      const res = await fetch(`${API_BASE}/api/cmdb/${tenantCode}/items/${cmdbId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success && data.item && data.item.configuration_items) {
        CIS_BY_ITEM[cmdbId] = data.item.configuration_items.map(ci => ({
          ci_id: ci.ci_id,
          cmdb_id: cmdbId,
          name: ci.ci_name,
          'Field Value': ci.category_field_value || '',
          'Asset Category*': ci.asset_category,
          status: ci.status
        }));
        return CIS_BY_ITEM[cmdbId];
      }
    } catch (err) {
      console.error('Error loading CIs:', err);
    }
    return [];
  }

  // Tickets will be loaded from API after login
  let tickets = [];
  let cachedExperts = []; // Cache experts for assignment dropdown

  // Function to fetch tickets from API
  async function fetchTicketsFromAPI() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';
      
      console.log('Fetching tickets from API for tenant:', tenantCode);
      
      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        console.error('Failed to fetch tickets:', response.status);
        return;
      }
      
      const data = await response.json();
      console.log('Received tickets from API:', data);
      
      if (data.success && data.tickets) {
        // Transform API tickets to match frontend format
        tickets = data.tickets.map(t => ({
          id: t.id || t.ticket_number,
          title: t.title,
          priority: t.priority || 'Normal',
          status: t.status,
          assignee: t.assignee_name || null,
          customer: window.tenant || 'apoyar',
          due: t.due_date || t.sla_deadline,
          desc: t.description,
          sla: {
            paused: false,
            createdAt: t.created_at,
            startedAt: t.created_at
          }
        }));
        
        console.log('Loaded', tickets.length, 'tickets from API');
      }
    } catch (error) {
      console.error('Error fetching tickets:', error);
    }
  }

  let experts = []; // Will be loaded from API
  let customers = []; // Will be loaded from API

  // ---- Shell & Nav ----
  let role='admin', currentView='dash', currentItemId=null, tenant=null, pending=null, currentTicketId=null;

  document.getElementById('role').addEventListener('change', function(){ const isCustomer=this.value==='customer'; const tenantField = document.getElementById('tenant-field'); if(tenantField) tenantField.style.display=isCustomer?'block':'none'; if(isCustomer) loadTenantChoices(); });
  function loadTenantChoices(){ 
    const t=document.getElementById('tenant'); 
    // Use actual tenant data instead of CMDB customer data
    const tenants = ['apoyar']; // Only actual tenant that exists in database
    t.innerHTML=''; 
    tenants.forEach(tenantId=>{
      const o=document.createElement('option'); 
      o.value=tenantId; 
      o.textContent=tenantId.charAt(0).toUpperCase() + tenantId.slice(1); 
      t.appendChild(o);
    }); 
    if(tenants.length) t.value=tenants[0]; 
  }
  function go(where){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(where==='login'?'scr-login':'scr-app').classList.add('active');
    // Show/hide top nav user section based on screen
    document.getElementById('topnav-right').style.display = (where==='login') ? 'none' : 'flex';
  }

  // Theme toggle functionality
  function toggleTheme() {
    const body = document.body;
    const isDark = body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    updateThemeIcon(isDark);
  }

  function updateThemeIcon(isDark) {
    document.getElementById('theme-icon-sun').style.display = isDark ? 'none' : 'block';
    document.getElementById('theme-icon-moon').style.display = isDark ? 'block' : 'none';
  }

  // Initialize theme from localStorage
  function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const isDark = savedTheme === 'dark' || (savedTheme === null && prefersDark);
    if (isDark) {
      document.body.classList.add('dark-mode');
    }
    updateThemeIcon(isDark);
  }
  initTheme();
  async function login(){
    console.log('Login function called');
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    
    console.log('Login attempt:', { username, password, role });
    
    const errorDiv = document.getElementById('login-error');
    errorDiv.style.display = 'none';
    
    try {
      let response;
      
      if (role === 'master_admin') {
        console.log('Attempting master admin login');
        const url = `${API_BASE}/api/auth/master/login`;
        console.log('Fetching URL:', url);
        // Master Admin login
        response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
      } else {
        console.log('Attempting tenant login');
        // Tenant login - get tenant from form
        const tenant = document.getElementById('tenant').value;
        console.log('Using tenant:', tenant);
        console.log('Request body:', { username, password, tenant_code: tenant });

        try {
          response = await fetch(`${API_BASE}/api/auth/tenant/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password, tenant_code: tenant })
          });
          console.log('Fetch completed');
        } catch (fetchError) {
          console.error('Fetch error:', fetchError);
          throw fetchError;
        }
      }

      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);

      const data = await response.json();
      console.log('Response data:', data);
      
      if (data.success) {
        console.log('Login successful');
        // Store token in localStorage for API calls
        localStorage.setItem('token', data.token);
        // Set global variables
        window.currentUser = data.user;
        window.role = data.user.role;
        window.tenant = data.user.tenant || (role === 'customer' ? 'apoyar' : null);
        window.isMasterAdmin = data.user.role === 'super_admin';
        
        // Update UI
        document.getElementById('chip-role').textContent = data.user.role === 'super_admin' ? 'Master Admin' : data.user.role;
        document.getElementById('tenant-chip').style.display = (role === 'customer' || role === 'super_admin') ? 'block' : 'none';
        document.getElementById('chip-tenant').textContent = window.tenant || 'â€”';
        
        // Configure role and show app
        configureRole();
        switchView('dash');
        go('app');
        
        // Load tickets from API before rendering
        await fetchTicketsFromAPI();
        
        renderAllDashboards();
        loadRaiseFormOptions();
        renderList();
        startSLAInterval();
      } else {
        console.log('Login failed:', data.message);
        errorDiv.textContent = data.message || 'Login failed';
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      console.error('Login error:', error);
      errorDiv.textContent = 'Connection error. Please try again.';
      errorDiv.style.display = 'block';
    }
  }
  
  function showDemoCredentials() {
    const credentials = [
      'Demo Tenant:',
      '  Admin: admin / password123 (tenant: apoyar)',
      '  Expert: expert / password123 (tenant: apoyar)',
      '  Customer: customer / password123 (tenant: apoyar)'
    ].join('\n');

    alert('Demo Credentials:\n\n' + credentials);
  }
  
  function toggleTenantField() {
    const role = document.getElementById('role').value;
    const tenantField = document.getElementById('tenant-field');

    if (role === 'master_admin') {
      tenantField.style.display = 'none';
    } else {
      tenantField.style.display = 'block';
      // Load tenant choices when showing the field
      loadTenantChoices();
    }
  }

  function showForgotPassword() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('scr-forgot-password').classList.add('active');
    // Clear previous messages
    document.getElementById('forgot-message').style.display = 'none';
  }

  function backToLogin() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('scr-login').classList.add('active');
  }

  async function sendPasswordReset() {
    const tenantCode = document.getElementById('forgot-tenant').value.trim();
    const email = document.getElementById('forgot-email').value.trim();
    const messageDiv = document.getElementById('forgot-message');

    // Validation
    if (!tenantCode || !email) {
      messageDiv.textContent = 'Please enter both tenant code and email address.';
      messageDiv.style.color = '#dc2626';
      messageDiv.style.background = '#fef2f2';
      messageDiv.style.borderColor = '#fecaca';
      messageDiv.style.display = 'block';
      return;
    }

    if (!email.includes('@')) {
      messageDiv.textContent = 'Please enter a valid email address.';
      messageDiv.style.color = '#dc2626';
      messageDiv.style.background = '#fef2f2';
      messageDiv.style.borderColor = '#fecaca';
      messageDiv.style.display = 'block';
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/api/auth/tenant/forgot-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ tenant_code: tenantCode, email })
      });

      const data = await response.json();

      if (response.ok && data.success) {
        messageDiv.textContent = data.message;
        messageDiv.style.color = '#059669';
        messageDiv.style.background = '#d1fae5';
        messageDiv.style.borderColor = '#6ee7b7';
        messageDiv.style.display = 'block';

        // Clear form fields
        document.getElementById('forgot-tenant').value = '';
        document.getElementById('forgot-email').value = '';
      } else {
        messageDiv.textContent = data.message || 'Failed to send reset email. Please try again.';
        messageDiv.style.color = '#dc2626';
        messageDiv.style.background = '#fef2f2';
        messageDiv.style.borderColor = '#fecaca';
        messageDiv.style.display = 'block';
      }
    } catch (error) {
      console.error('Password reset error:', error);
      messageDiv.textContent = 'Connection error. Please try again.';
      messageDiv.style.color = '#dc2626';
      messageDiv.style.background = '#fef2f2';
      messageDiv.style.borderColor = '#fecaca';
      messageDiv.style.display = 'block';
    }
  }

  function switchRole(){ 
    // For demo purposes, cycle through roles (but this won't actually change authentication)
    const roles = ['admin', 'expert', 'customer'];
    const currentIndex = roles.indexOf(window.role || role);
    const nextIndex = (currentIndex + 1) % roles.length;
    const newRole = roles[nextIndex];
    
    // Update UI for demo
    role = newRole;
    window.role = newRole;
    
    if (role==='customer' && !tenant) tenant=(CMDB_ITEMS.find(i=>i.customer)||{}).customer||null; 
    document.getElementById('chip-role').textContent=role; 
    document.getElementById('tenant-chip').style.display = role==='customer' ? 'block' : 'none'; 
    document.getElementById('chip-tenant').textContent = tenant || 'â€”'; 
    configureRole(); 
    switchView('dash'); 
    renderAllDashboards(); 
    loadRaiseFormOptions(); 
    renderList(); 
  }
  // ---- Filter Persistence ----
  function saveFilterSettings(viewName) {
    const username = localStorage.getItem('username') || 'default';
    const tenant = window.tenant || 'apoyar';
    const key = `filters_${tenant}_${username}_${viewName}`;

    const settings = {};

    if (viewName === 'tickets') {
      settings.search = document.getElementById('ticket-search')?.value || '';
      settings.status = document.getElementById('ticket-filter-status')?.value || '';
      settings.priority = document.getElementById('ticket-filter-priority')?.value || '';
      settings.assignee = document.getElementById('ticket-filter-assignee')?.value || '';
      settings.customer = document.getElementById('ticket-filter-customer')?.value || '';
      settings.sort = document.getElementById('ticket-sort')?.value || '';
    } else if (viewName === 'experts') {
      settings.search = document.getElementById('expert-search')?.value || '';
    } else if (viewName === 'customers') {
      settings.search = document.getElementById('cust-search')?.value || '';
    } else if (viewName === 'cmdb') {
      settings.search = document.getElementById('cmdb-search')?.value || '';
      settings.customer = document.getElementById('cmdb-customer')?.value || '';
    }

    localStorage.setItem(key, JSON.stringify(settings));
  }

  function loadFilterSettings(viewName) {
    const username = localStorage.getItem('username') || 'default';
    const tenant = window.tenant || 'apoyar';
    const key = `filters_${tenant}_${username}_${viewName}`;

    const savedSettings = localStorage.getItem(key);
    if (!savedSettings) return;

    try {
      const settings = JSON.parse(savedSettings);

      if (viewName === 'tickets') {
        if (settings.search !== undefined) {
          const elem = document.getElementById('ticket-search');
          if (elem) elem.value = settings.search;
        }
        if (settings.status !== undefined) {
          const elem = document.getElementById('ticket-filter-status');
          if (elem) elem.value = settings.status;
        }
        if (settings.priority !== undefined) {
          const elem = document.getElementById('ticket-filter-priority');
          if (elem) elem.value = settings.priority;
        }
        if (settings.assignee !== undefined) {
          const elem = document.getElementById('ticket-filter-assignee');
          if (elem) elem.value = settings.assignee;
        }
        if (settings.customer !== undefined) {
          const elem = document.getElementById('ticket-filter-customer');
          if (elem) elem.value = settings.customer;
        }
        if (settings.sort !== undefined) {
          const elem = document.getElementById('ticket-sort');
          if (elem) elem.value = settings.sort;
        }
      } else if (viewName === 'experts') {
        if (settings.search !== undefined) {
          const elem = document.getElementById('expert-search');
          if (elem) elem.value = settings.search;
        }
      } else if (viewName === 'customers') {
        if (settings.search !== undefined) {
          const elem = document.getElementById('cust-search');
          if (elem) elem.value = settings.search;
        }
      } else if (viewName === 'cmdb') {
        if (settings.search !== undefined) {
          const elem = document.getElementById('cmdb-search');
          if (elem) elem.value = settings.search;
        }
        if (settings.customer !== undefined) {
          const elem = document.getElementById('cmdb-customer');
          if (elem) elem.value = settings.customer;
        }
      }
    } catch (error) {
      console.error('Error loading filter settings:', error);
    }
  }

  function nav(el){ document.querySelectorAll('.navlink').forEach(n=>n.classList.remove('active')); el.classList.add('active'); switchView(el.getAttribute('data-target')); if(el.getAttribute('data-target')==='dash') renderAllDashboards(); }
  function navTo(view){ switchView(view); }
  function switchView(view){ currentView=view; ['dash','profile','tickets','ticket-detail','experts','expert-detail','customers','cmdb','cmdb-detail','manage-cmdb','wizard','raise','tenants','subscriptions','billing','plans','system','usage','customer-plans','customer-billing','analytics','ai-insights','ticket-rules','email-processing','system-control'].forEach(n=>{ const el=document.getElementById('view-'+n); if(el) el.style.display=(n===view)?'block':'none'; }); if(view==='tickets') { loadFilterSettings('tickets'); renderList(); } if(view==='experts') { loadFilterSettings('experts'); renderExperts(); } if(view==='expert-detail') renderExpertDetail(); if(view==='customers') { loadFilterSettings('customers'); renderCustomers(); } if(view==='cmdb') { loadFilterSettings('cmdb'); renderCMDB(); } if(view==='cmdb-detail') renderCMDBDetail(); if(view==='manage-cmdb') loadManageCMDB(); if(view==='raise') loadRaiseFormOptions(); if(view==='ticket-detail') renderTicketDetail(); if(view==='tenants') loadTenants(); if(view==='subscriptions') loadSubscriptions(); if(view==='billing') loadBilling(); if(view==='plans') loadPlans(); if(view==='system') loadSystemOverview(); if(view==='usage') loadUsageDashboard(); if(view==='customer-plans') loadCustomerPlans(); if(view==='customer-billing') loadCustomerBilling(); if(view==='analytics') loadAnalytics(); if(view==='ai-insights') loadAIInsights(); if(view==='ticket-rules') loadTicketRules(); if(view==='email-processing') loadEmailProcessing(); if(view==='system-control') loadSystemControlSettings(); if(view==='wizard') { loadCompanyProfile(); loadEmailIngestSettings(); } if(view==='profile') loadProfile(); }
  function configureRole(){
    const currentRole = window.role || role; // Use global role from login, fallback to local
    document.getElementById('nav-admin').style.display = (currentRole==='admin') ? 'block' : 'none';
    document.getElementById('nav-expert').style.display = currentRole==='expert' ? 'block' : 'none';
    document.getElementById('nav-customer').style.display = currentRole==='customer' ? 'block' : 'none';
    document.getElementById('nav-master').style.display = currentRole==='super_admin' ? 'block' : 'none';
    document.getElementById('dash-admin').style.display = (currentRole==='admin') ? 'block' : 'none';
    document.getElementById('dash-expert').style.display = currentRole==='expert' ? 'block' : 'none';
    document.getElementById('dash-customer').style.display = currentRole==='customer' ? 'block' : 'none';
    document.getElementById('dash-master').style.display = currentRole==='super_admin' ? 'block' : 'none';
    document.getElementById('app-title').textContent = currentRole==='customer' ? 'My Dashboard' : (currentRole==='expert' ? 'Expert Dashboard' : (currentRole==='super_admin' ? 'Master Admin Dashboard' : 'Admin Dashboard'));
    document.getElementById('app-subtitle').textContent = currentRole==='customer' ? 'Welcome to your ServiFlow portal' : (currentRole==='expert' ? 'SLA focus & queue' : (currentRole==='super_admin' ? 'System-wide management & tenant oversight' : 'Platform health & governance'));

    // Update top navigation user info
    const username = (window.currentUser && window.currentUser.username) ? window.currentUser.username : 'User';
    const roleDisplay = currentRole === 'super_admin' ? 'Master Admin' : (currentRole.charAt(0).toUpperCase() + currentRole.slice(1));
    document.getElementById('topnav-username').textContent = username;
    document.getElementById('topnav-role').textContent = roleDisplay;
    document.getElementById('topnav-avatar').textContent = username.charAt(0).toUpperCase();

    // Hide/show admin-only sections in Admin Settings Wizard
    const isAdmin = (currentRole === 'admin');
    const profileSection = document.getElementById('admin-section-profile');
    const emailIngestSection = document.getElementById('admin-section-email-ingest');
    if (profileSection) profileSection.style.display = isAdmin ? 'block' : 'none';
    if (emailIngestSection) emailIngestSection.style.display = isAdmin ? 'block' : 'none';
  }

  // ---- SLA Utilities ----
  function parseDueEndOfDay(dueStr) { if(!dueStr) return null; const a=dueStr.split('-'); if(a.length!==3) return null; return new Date(Number(a[0]), Number(a[1])-1, Number(a[2]), 23,59,59,999); }
  function getSLAState(t) {
    const now = new Date();
    const due = parseDueEndOfDay(t.due);
    if(!due) return {cls:'', label:'â€”', pct:0};
    const base = new Date(t.sla.startedAt || t.sla.createdAt || now);
    const totalMs = due - base;
    let elapsedMs = now - base;
    if (t.sla.paused && t.sla.pausedAt) { elapsedMs = new Date(t.sla.pausedAt) - base; }
    const pct = Math.max(0, Math.min(100, Math.round((elapsedMs/totalMs)*100)));
    const remainingMs = due - now;
    const late = remainingMs < 0;
    const hours = Math.floor(Math.abs(remainingMs) / 3.6e6);
    const mins = Math.floor((Math.abs(remainingMs) % 3.6e6) / 6e4);
    const label = late ? `Overdue by ${hours}h ${mins}m` : `Due in ${hours}h ${mins}m`;
    let cls = 'ok'; if (late || pct >= 100) cls = 'danger'; else if (pct >= 70) cls = 'warn';
    return {cls, label, pct: isFinite(pct) ? pct : 0};
  }
  function slaBadgeHTML(state){ return `<span class="badge sla ${state.cls}">${state.label}</span>`; }
  let slaInterval = null;
  function startSLAInterval(){ if(slaInterval) clearInterval(slaInterval); slaInterval = setInterval(()=>{ if(currentView==='tickets') renderList(); if(currentView==='dash') { renderAdminDash(); renderExpertDash(); } if(currentView==='ticket-detail') updateTicketSLA(); }, 30000); }

  // ---- Dashboards ----
  function renderAllDashboards(){ 
    const currentRole = window.role || role;
    if (currentRole === 'super_admin') {
      renderMasterDash();
    } else {
      renderAdminDash(); 
      renderExpertDash(); 
      renderCustomerDash(); 
    }
  }
  function renderAdminDash(){ const currentRole = window.role || role; if(currentRole!=='admin') return; const openAll=tickets.filter(t=>t.status!=='Resolved').length; const slaRisk=tickets.filter(t=>t.status!=='Resolved' && getSLAState(t).cls!=='ok').length; const totalItems=CMDB_ITEMS.length; document.getElementById('ad-open').textContent=openAll; document.getElementById('ad-sla-risk').textContent=slaRisk; document.getElementById('ad-items').textContent=totalItems; const tb=document.getElementById('ad-recent'); tb.innerHTML=''; tickets.slice(0,5).forEach(t=>{ const tr=document.createElement('tr'); tr.onclick=()=>openTicket(t.id); const sla=getSLAState(t); const dateTime=formatDateTime(t.created); tr.innerHTML=`<td>#${t.id}</td><td>${t.title}</td><td>${dateTime}</td><td>${t.customer}</td><td>${t.status} ${slaBadgeHTML(sla)}</td>`; tb.appendChild(tr); }); loadFeedbackScoreboard(); }

  async function loadFeedbackScoreboard() {
    try {
      const tenantCode = window.tenant || 'apoyar';
      const response = await fetch(`${API_BASE}/api/tickets/public/${tenantCode}/feedback-scoreboard`);

      if (!response.ok) {
        console.error('Failed to load feedback scoreboard');
        return;
      }

      const data = await response.json();

      if (data.success && data.scoreboard) {
        const scoreboard = data.scoreboard;

        // Update average rating
        document.getElementById('feedback-avg-rating').textContent = scoreboard.averageRating || '-';
        const stars = scoreboard.averageRating > 0 ? 'â­'.repeat(Math.round(scoreboard.averageRating)) : '';
        document.getElementById('feedback-avg-stars').textContent = stars;

        // Update total count
        document.getElementById('feedback-total-count').textContent = scoreboard.totalFeedback || 0;

        // Update distribution
        document.getElementById('feedback-5star').textContent = scoreboard.ratingDistribution[5] || 0;
        document.getElementById('feedback-4star').textContent = scoreboard.ratingDistribution[4] || 0;
        document.getElementById('feedback-3star').textContent = scoreboard.ratingDistribution[3] || 0;
        document.getElementById('feedback-2star').textContent = scoreboard.ratingDistribution[2] || 0;
        document.getElementById('feedback-1star').textContent = scoreboard.ratingDistribution[1] || 0;

        // Update recent feedback table
        const tbody = document.getElementById('feedback-recent');
        tbody.innerHTML = '';

        if (scoreboard.recentFeedback && scoreboard.recentFeedback.length > 0) {
          scoreboard.recentFeedback.forEach(feedback => {
            const tr = document.createElement('tr');
            const stars = 'â­'.repeat(feedback.rating);
            const date = new Date(feedback.submittedAt).toLocaleDateString();
            const comment = feedback.comment ? feedback.comment.substring(0, 50) + (feedback.comment.length > 50 ? '...' : '') : '-';

            tr.innerHTML = `
              <td>#${feedback.ticketId}</td>
              <td>${stars} (${feedback.rating}/5)</td>
              <td>${feedback.resolvedByName || '-'}</td>
              <td>${comment}</td>
              <td>${date}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="5" class="subtitle">No feedback received yet</td>';
          tbody.appendChild(tr);
        }
      }
    } catch (error) {
      console.error('Error loading feedback scoreboard:', error);
    }
  }

  // Dashboard stat card click-through functions
  function viewOpenTickets() {
    // Navigate to tickets view
    switchView('tickets');

    // Clear filters first
    clearTicketFilters();

    // Set status filter to show non-resolved tickets
    const statusFilter = document.getElementById('ticket-filter-status');
    if (statusFilter) {
      // Create option for "open" if it doesn't exist
      let hasOpenOption = false;
      for (let option of statusFilter.options) {
        if (option.value.toLowerCase() === 'open') {
          hasOpenOption = true;
          break;
        }
      }
      if (!hasOpenOption) {
        // Just leave it empty to show all non-resolved tickets
        statusFilter.value = '';
      } else {
        statusFilter.value = 'open';
      }
    }

    // Refresh the ticket list
    renderList();
  }

  function viewSLAAtRisk() {
    // Navigate to tickets view
    switchView('tickets');

    // Clear filters first
    clearTicketFilters();

    // Set a flag to filter for SLA at risk
    window.slaAtRiskFilter = true;

    // Refresh the ticket list
    renderList();

    // Clear the flag after a short delay so it doesn't persist
    setTimeout(() => {
      window.slaAtRiskFilter = false;
    }, 100);
  }

  function viewCMDBItems() {
    // Navigate to CMDB view
    switchView('cmdb');
  }

  function renderExpertDash(){ const currentRole = window.role || role; if(currentRole!=='expert') return; const me='Jane Doe'; const my=tickets.filter(t=>t.assignee===me && t.status!=='Resolved'); const today=my.filter(t=>{ const now=new Date(); const due=parseDueEndOfDay(t.due); return due && now.toDateString()===due.toDateString(); }); const risk=my.filter(t=>getSLAState(t).cls!=='ok'); document.getElementById('ex-open').textContent=my.length; document.getElementById('ex-today').textContent=today.length; document.getElementById('ex-risk').textContent=risk.length; const tb=document.getElementById('ex-list'); tb.innerHTML=''; my.slice(0,6).forEach(t=>{ const tr=document.createElement('tr'); const sla=getSLAState(t); const dateTime=formatDateTime(t.created); tr.onclick=()=>openTicket(t.id); tr.innerHTML = `<td>#${t.id}</td><td>${t.title}</td><td>${dateTime}</td><td>${t.status}</td><td>${slaBadgeHTML(sla)}</td>`; tb.appendChild(tr); }); }
  function renderCustomerDash(){ const currentRole = window.role || role; if(currentRole!=='customer') return; const items = CMDB_ITEMS.filter(i => !tenant || i.customer===tenant); const ciCount = items.reduce((a,i)=>a+(CIS_BY_ITEM[i.cmdb_id]?.length||0),0); const openTickets = tickets.filter(t => (!tenant || (t.customer===tenant)) && t.status!=='Resolved').length; document.getElementById('cu-open').textContent=openTickets; document.getElementById('cu-items').textContent=items.length; document.getElementById('cu-cis').textContent=ciCount; const tbody=document.getElementById('cu-ci-body'); tbody.innerHTML=''; const all=[]; items.forEach(i => (CIS_BY_ITEM[i.cmdb_id]||[]).forEach(ci => all.push({item:i, ci}))); all.slice(0,8).forEach(r => { const tr=document.createElement('tr'); const m=r.ci.Model||r.ci.model||''; const loc=r.ci.Location||r.ci.location||''; const life=r.ci.Lifecycle||r.ci.lifecycle||r.ci.life||''; tr.innerHTML = `<td>${r.item.name}</td><td>${r.ci.name}</td><td>${m}</td><td>${loc}</td><td>${life}</td>`; tbody.appendChild(tr); }); }
  function renderMasterDash(){ 
    const currentRole = window.role || role;
    if (currentRole !== 'master_admin') return; 
    
    // Load tenants from master database
    loadTenants();
    
    // Update master dashboard stats
    document.getElementById('ma-tenants').textContent = '1'; // Will be updated by loadTenants
    document.getElementById('ma-active').textContent = '1';
    document.getElementById('ma-health').textContent = '100%';
  }
  
  // Master Admin functions
  async function loadTenants() {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/tenants', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      
      if (data.success) {
        const tenantCount = data.tenants.length;
        document.getElementById('ma-tenants').textContent = tenantCount;
        document.getElementById('ma-active').textContent = tenantCount;
        
        // Update tenant list if on tenants view
        if (currentView === 'tenants') {
          const tbody = document.getElementById('tenant-list-body');
          if (tbody) {
            tbody.innerHTML = '';
            data.tenants.forEach(tenant => {
              const tr = document.createElement('tr');
              const statusBadge = tenant.is_active ? 'Active' : 'Inactive';
              const createdDate = new Date(tenant.created_at).toLocaleDateString();
              tr.innerHTML = `
                <td>${tenant.company_name}</td>
                <td>${tenant.tenant_code}</td>
                <td><span class="badge ${tenant.is_active ? 'success' : 'danger'}">${statusBadge}</span></td>
                <td>${createdDate}</td>
                <td>
                  <button onclick="editTenant(${tenant.id})" class="btn btn-sm">Edit</button>
                  <button onclick="deleteTenant(${tenant.id})" class="btn btn-sm btn-danger">Delete</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          }
        }
      }
    } catch (error) {
      console.error('Error loading tenants:', error);
    }
  }
  
  function showCreateTenantForm() {
    document.getElementById('create-tenant-form').style.display = 'block';
  }
  
  function hideCreateTenantForm() {
    document.getElementById('create-tenant-form').style.display = 'none';
    document.getElementById('new-tenant-company').value = '';
    document.getElementById('new-tenant-admin').value = '';
    document.getElementById('new-tenant-email').value = '';
  }
  
  function showEditTenantForm(tenant) {
    // Populate the edit form with tenant data
    document.getElementById('edit-tenant-id').value = tenant.id;
    document.getElementById('edit-company-name').value = tenant.company_name;
    document.getElementById('edit-admin-username').value = tenant.tenant_code;
    document.getElementById('edit-admin-email').value = tenant.admin_email || '';
    document.getElementById('edit-tenant-status').value = tenant.is_active ? 'active' : 'inactive';

    // Show the edit form
    document.getElementById('edit-tenant-form').style.display = 'block';
  }
  
  function hideEditTenantForm() {
    document.getElementById('edit-tenant-form').style.display = 'none';
  }
  
  async function createTenant() {
    const companyName = document.getElementById('new-tenant-company').value;
    const adminUsername = document.getElementById('new-tenant-admin').value;
    const adminEmail = document.getElementById('new-tenant-email').value;
    
    if (!companyName || !adminUsername || !adminEmail) {
      alert('Please fill in all fields');
      return;
    }
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/tenants', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          companyName,
          adminUsername,
          adminEmail
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('Tenant created successfully!');
        hideCreateTenantForm();
        loadTenants();
      } else {
        alert('Error creating tenant: ' + data.message);
      }
    } catch (error) {
      console.error('Error creating tenant:', error);
      alert('Error creating tenant');
    }
  }
  
  async function updateTenant() {
    const tenantId = document.getElementById('edit-tenant-id').value;
    const companyName = document.getElementById('edit-company-name').value;
    const displayName = document.getElementById('edit-company-name').value; // Use same as company name
    const adminEmail = document.getElementById('edit-admin-email').value;
    const status = document.getElementById('edit-tenant-status').value;

    if (!companyName || !adminEmail) {
      alert('Please fill in all required fields');
      return;
    }

    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/tenants/${tenantId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          company_name: companyName,
          display_name: displayName,
          admin_email: adminEmail,
          is_active: status === 'active'
        })
      });

      const data = await response.json();

      if (data.success) {
        alert('Tenant updated successfully!');
        hideEditTenantForm();
        loadTenants(); // Refresh the tenant list
      } else {
        alert('Error updating tenant: ' + data.message);
      }
    } catch (error) {
      console.error('Error updating tenant:', error);
      alert('Error updating tenant');
    }
  }
  
  function loadSystemOverview() {
    // Placeholder for system overview functionality
    console.log('Loading system overview...');
  }
  

  // Company Profile Functions
  async function loadCompanyProfile() {
    try {
      const tenantCode = currentUser.tenantCode || 'apoyar';
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/profile/${tenantCode}/profile`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      // Check for errors before parsing
      if (response.status === 403) {
        const userRole = window.currentUser?.role || 'unknown';
        console.warn(`Permission denied loading company profile. User role: ${userRole}`);
        return; // Silently fail on load - user won't see the section anyway with role-based hiding
      }

      if (response.status === 401) {
        console.warn('Authentication required to load company profile');
        return; // Silently fail on load
      }

      if (!response.ok) {
        console.error(`HTTP ${response.status} error loading company profile`);
        return; // Silently fail on load
      }

      const data = await response.json();

      if (data.success && data.profile) {
        document.getElementById('profile-company-name').value = data.profile.company_name || '';
        document.getElementById('profile-contact-phone').value = data.profile.contact_phone || '';
        document.getElementById('profile-mail-from').value = data.profile.mail_from_email || '';
        document.getElementById('profile-company-url').value = data.profile.company_url_domain || '';
      }
    } catch (error) {
      console.error('Error loading company profile:', error);
      // Silently fail on load errors - non-admins shouldn't see error messages
    }
  }

  async function saveCompanyProfile() {
    const companyName = document.getElementById('profile-company-name').value;
    const contactPhone = document.getElementById('profile-contact-phone').value;
    const mailFrom = document.getElementById('profile-mail-from').value;
    const companyUrl = document.getElementById('profile-company-url').value;

    // Basic validation
    if (mailFrom && !isValidEmail(mailFrom)) {
      showProfileError('Please enter a valid email address');
      return;
    }

    try {
      const tenantCode = currentUser.tenantCode || 'apoyar';
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/profile/${tenantCode}/profile`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          company_name: companyName,
          contact_phone: contactPhone,
          mail_from_email: mailFrom,
          company_url_domain: companyUrl
        })
      });

      const data = await response.json();

      // Check for permission errors
      if (response.status === 403) {
        const userRole = window.currentUser?.role || 'unknown';
        showProfileError(`âš ï¸ Admin access required. Your current role: "${userRole}". Please log in as an admin user.`);
        return;
      }

      if (response.status === 401) {
        showProfileError('âš ï¸ Authentication required. Please log in again.');
        return;
      }

      if (!response.ok) {
        showProfileError(`Error (HTTP ${response.status}): ${data.message || 'Error saving profile'}`);
        return;
      }

      if (data.success) {
        showProfileMessage('âœ… Company profile saved successfully!');
        setTimeout(() => hideProfileMessages(), 3000);
      } else {
        showProfileError(data.message || 'Error saving company profile');
      }
    } catch (error) {
      console.error('Error saving company profile:', error);
      showProfileError('Error saving company profile');
    }
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function showProfileMessage(message) {
    const messageEl = document.getElementById('profile-message');
    const errorEl = document.getElementById('profile-error');
    errorEl.style.display = 'none';
    messageEl.textContent = message;
    messageEl.style.display = 'block';
  }

  function showProfileError(message) {
    const messageEl = document.getElementById('profile-message');
    const errorEl = document.getElementById('profile-error');
    messageEl.style.display = 'none';
    errorEl.textContent = message;
    errorEl.style.display = 'block';
  }

  function hideProfileMessages() {
    document.getElementById('profile-message').style.display = 'none';
    document.getElementById('profile-error').style.display = 'none';
  }

  // Email Ingest Functions
  async function loadEmailIngestSettings() {
    try {
      const tenantCode = currentUser.tenantCode || 'apoyar';
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/email-ingest/${tenantCode}/settings`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      // Check for errors before parsing
      if (response.status === 403) {
        const userRole = window.currentUser?.role || 'unknown';
        console.warn(`Permission denied loading email ingest settings. User role: ${userRole}`);
        return; // Silently fail on load - user won't see the section anyway with role-based hiding
      }

      if (response.status === 401) {
        console.warn('Authentication required to load email ingest settings');
        return; // Silently fail on load
      }

      if (!response.ok) {
        console.error(`HTTP ${response.status} error loading email ingest settings`);
        return; // Silently fail on load
      }

      const data = await response.json();

      if (data.success && data.settings) {
        const settings = data.settings;
        document.getElementById('email-ingest-enabled').checked = settings.enabled;
        document.getElementById('email-server-type').value = settings.server_type;
        document.getElementById('email-server-host').value = settings.server_host;
        document.getElementById('email-server-port').value = settings.server_port;
        document.getElementById('email-use-ssl').checked = settings.use_ssl;
        document.getElementById('email-username').value = settings.username;
        document.getElementById('email-password').value = settings.password;
        document.getElementById('email-check-interval').value = settings.check_interval_minutes;

        if (settings.last_checked_at) {
          const lastChecked = new Date(settings.last_checked_at);
          document.getElementById('email-last-checked').textContent =
            'Last checked: ' + lastChecked.toLocaleString();
        }
      }
    } catch (error) {
      console.error('Error loading email ingest settings:', error);
      // Silently fail on load errors - non-admins shouldn't see error messages
    }
  }

  async function saveEmailIngestSettings() {
    const enabled = document.getElementById('email-ingest-enabled').checked;
    const serverType = document.getElementById('email-server-type').value;
    const serverHost = document.getElementById('email-server-host').value;
    const serverPort = parseInt(document.getElementById('email-server-port').value);
    const useSsl = document.getElementById('email-use-ssl').checked;
    const username = document.getElementById('email-username').value;
    const password = document.getElementById('email-password').value;
    const checkInterval = parseInt(document.getElementById('email-check-interval').value);

    // Basic validation
    if (enabled) {
      if (!serverHost || !serverPort || !username) {
        showEmailIngestError('Please fill in all required fields (Server Host, Port, Username)');
        return;
      }
      if (serverPort < 1 || serverPort > 65535) {
        showEmailIngestError('Server port must be between 1 and 65535');
        return;
      }
      if (checkInterval < 1 || checkInterval > 60) {
        showEmailIngestError('Check interval must be between 1 and 60 minutes');
        return;
      }
    }

    try {
      const tenantCode = currentUser.tenantCode || 'apoyar';
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/email-ingest/${tenantCode}/settings`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          enabled,
          server_type: serverType,
          server_host: serverHost,
          server_port: serverPort,
          use_ssl: useSsl,
          username,
          password: password || undefined,
          check_interval_minutes: checkInterval
        })
      });

      const data = await response.json();

      // Check for permission errors
      if (response.status === 403) {
        const userRole = window.currentUser?.role || 'unknown';
        showEmailIngestError(`âš ï¸ Admin access required. Your current role: "${userRole}". Please log in as an admin user.`);
        return;
      }

      if (response.status === 401) {
        showEmailIngestError('âš ï¸ Authentication required. Please log in again.');
        return;
      }

      if (!response.ok) {
        showEmailIngestError(`Error (HTTP ${response.status}): ${data.message || 'Error saving settings'}`);
        return;
      }

      if (data.success) {
        showEmailIngestMessage('âœ… Email ingest settings saved successfully!');
        setTimeout(() => hideEmailIngestMessages(), 3000);
      } else {
        showEmailIngestError(data.message || 'Error saving email ingest settings');
      }
    } catch (error) {
      console.error('Error saving email ingest settings:', error);
      showEmailIngestError('Error saving email ingest settings');
    }
  }

  async function testEmailConnection() {
    try {
      const tenantCode = currentUser.tenantCode || 'apoyar';
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/email-ingest/${tenantCode}/test-connection`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      const data = await response.json();

      // Check for permission errors
      if (response.status === 403) {
        const userRole = window.currentUser?.role || 'unknown';
        showEmailIngestError(`âš ï¸ Admin access required. Your current role: "${userRole}". Please log in as an admin user.`);
        return;
      }

      if (response.status === 401) {
        showEmailIngestError('âš ï¸ Authentication required. Please log in again.');
        return;
      }

      if (!response.ok) {
        showEmailIngestError(`Error (HTTP ${response.status}): ${data.message || 'Connection test failed'}`);
        return;
      }

      if (data.success) {
        showEmailIngestMessage('âœ… Connection test successful! ' + (data.message || ''));
        setTimeout(() => hideEmailIngestMessages(), 5000);
      } else {
        showEmailIngestError(data.message || 'Connection test failed');
      }
    } catch (error) {
      console.error('Error testing email connection:', error);
      showEmailIngestError('Error testing email connection');
    }
  }

  function showEmailIngestMessage(message) {
    const messageEl = document.getElementById('email-ingest-message');
    const errorEl = document.getElementById('email-ingest-error');
    errorEl.style.display = 'none';
    messageEl.textContent = message;
    messageEl.style.display = 'block';
  }

  function showEmailIngestError(message) {
    const messageEl = document.getElementById('email-ingest-message');
    const errorEl = document.getElementById('email-ingest-error');
    messageEl.style.display = 'none';
    errorEl.textContent = message;
    errorEl.style.display = 'block';
  }

  function hideEmailIngestMessages() {
    document.getElementById('email-ingest-message').style.display = 'none';
    document.getElementById('email-ingest-error').style.display = 'none';
  }


  // Usage Dashboard Functions
  async function loadUsageDashboard() {
    try {
      const tenantId = window.currentTenant || 'apoyar'; // Default to apoyar for now
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/usage/${tenantId}`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      const data = await response.json();

      if (data.success) {
        // Transform backend data format to frontend format
        const transformedUsage = {
          users: {
            current: data.usage.users.total,
            limit: data.usage.users.limit,
            percentage: data.usage.users.limit > 0 ? (data.usage.users.total / data.usage.users.limit * 100) : 0
          },
          tickets: {
            current: data.usage.tickets.total,
            limit: data.usage.tickets.limit,
            percentage: data.usage.tickets.limit > 0 ? (data.usage.tickets.total / data.usage.tickets.limit * 100) : 0
          },
          storage: {
            current: data.usage.storage.used,
            limit: data.usage.storage.limit,
            percentage: data.usage.storage.limit > 0 ? (data.usage.storage.used / data.usage.storage.limit * 100) : 0
          }
        };
        updateUsageDisplay(transformedUsage);
        updateUsageAlerts(transformedUsage);
      } else {
        console.error('Error loading usage:', data.message);
        document.getElementById('usage-alerts').innerHTML = '<div class="usage-alert danger">Error loading usage data: ' + (data.message || '') + '</div>';
        // Show empty usage display
        updateUsageDisplay({
          users: { current: 0, limit: 0, percentage: 0 },
          tickets: { current: 0, limit: 0, percentage: 0 },
          storage: { current: 0, limit: 0, percentage: 0 },
          overallPercentage: 0
        });
      }
    } catch (error) {
      console.error('Error loading usage dashboard:', error);
      document.getElementById('usage-alerts').innerHTML = '<div class="usage-alert danger">Error loading usage data</div>';
    }
  }
  
  function updateUsageDisplay(usage) {
    // Update users
    document.getElementById('usage-users-current').textContent = usage.users.current;
    document.getElementById('usage-users-limit').textContent = usage.users.limit === -1 ? 'âˆ' : usage.users.limit;
    document.getElementById('usage-users-progress').style.width = Math.min(usage.users.percentage, 100) + '%';
    
    // Update tickets
    document.getElementById('usage-tickets-current').textContent = usage.tickets.current;
    document.getElementById('usage-tickets-limit').textContent = usage.tickets.limit === -1 ? 'âˆ' : usage.tickets.limit;
    document.getElementById('usage-tickets-progress').style.width = Math.min(usage.tickets.percentage, 100) + '%';
    
    // Update storage
    document.getElementById('usage-storage-current').textContent = usage.storage.current;
    document.getElementById('usage-storage-limit').textContent = usage.storage.limit === -1 ? 'âˆ' : usage.storage.limit;
    document.getElementById('usage-storage-progress').style.width = Math.min(usage.storage.percentage, 100) + '%';
  }
  
  function updateUsageAlerts(usage) {
    const alerts = [];
    
    // Check for usage warnings (80%+ usage)
    if (usage.users.percentage >= 80) {
      alerts.push({
        type: usage.users.percentage >= 100 ? 'danger' : 'warning',
        message: `Users: ${usage.users.current}/${usage.users.limit} (${Math.round(usage.users.percentage)}%)`
      });
    }
    
    if (usage.tickets.percentage >= 80) {
      alerts.push({
        type: usage.tickets.percentage >= 100 ? 'danger' : 'warning',
        message: `Tickets: ${usage.tickets.current}/${usage.tickets.limit} (${Math.round(usage.tickets.percentage)}%)`
      });
    }
    
    if (usage.storage.percentage >= 80) {
      alerts.push({
        type: usage.storage.percentage >= 100 ? 'danger' : 'warning',
        message: `Storage: ${usage.storage.current}GB/${usage.storage.limit}GB (${Math.round(usage.storage.percentage)}%)`
      });
    }
    
    // Display alerts
    const alertsContainer = document.getElementById('usage-alerts');
    if (alerts.length === 0) {
      alertsContainer.innerHTML = '<div class="usage-alert info">âœ… All usage within limits</div>';
    } else {
      alertsContainer.innerHTML = alerts.map(alert => 
        `<div class="usage-alert ${alert.type}">âš ï¸ ${alert.message}</div>`
      ).join('');
    }
  }
  
  async function testUsageLimit(type, amount) {
    try {
      const tenantId = window.currentTenant || 'apoyar';
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/tenant/${tenantId}/usage/update`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ type, increment: amount })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert(`âœ… ${type} usage updated successfully!`);
        loadUsageDashboard(); // Refresh the display
      } else {
        if (data.limitExceeded) {
          alert(`âŒ Limit exceeded: ${data.message}`);
        } else {
          alert(`âŒ Error: ${data.message}`);
        }
      }
    } catch (error) {
      console.error('Error testing usage limit:', error);
      alert('âŒ Error testing usage limit');
    }
  }
  
  function refreshUsage() {
    loadUsageDashboard();
  }
  
  // Customer Portal Functions
  async function loadCustomerPlans() {
    try {
      const tenantId = window.currentTenant || 'apoyar';
      
      // Load current subscription
      const usageResponse = await fetch(window.location.protocol + '//' + window.location.host + `/api/tenant/${tenantId}/usage`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      const usageData = await usageResponse.json();
      
      if (usageData.success) {
        // Get subscription details
        const masterData = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/subscriptions', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });
        
        const masterResponse = await masterData.json();
        const currentSubscription = masterResponse.subscriptions?.find(s => s.tenantId === tenantId);
        
        if (currentSubscription) {
          displayCurrentPlan(currentSubscription);
        }
      }
      
      // Load available plans
      const plansResponse = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/plans', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      const plansData = await plansResponse.json();
      
      if (plansData.success) {
        displayPlanComparison(plansData.plans, tenantId);
      }
      
    } catch (error) {
      console.error('Error loading customer plans:', error);
      document.getElementById('current-plan-info').innerHTML = '<div class="usage-alert danger">Error loading plan information</div>';
    }
  }
  
  function displayCurrentPlan(subscription) {
    const planInfo = document.getElementById('current-plan-info');
    const planName = subscription.plan.charAt(0).toUpperCase() + subscription.plan.slice(1);
    const maxUsers = subscription.maxUsers === -1 ? 'âˆ' : subscription.maxUsers;
    const maxTickets = subscription.maxTickets === -1 ? 'âˆ' : subscription.maxTickets;
    const maxStorage = subscription.maxStorage === -1 ? 'âˆ' : subscription.maxStorage + 'GB';
    
    planInfo.innerHTML = `
      <div class="card p-16" style="background: #f8f9fa; border-left: 4px solid #007bff;">
        <div class="row space mb-12">
          <div>
            <h4 style="margin:0;color:#007bff;">${planName} Plan</h4>
            <div class="subtitle">$${subscription.monthlyPrice}/month</div>
          </div>
          <div class="badge plan-${subscription.plan}">${subscription.status.toUpperCase()}</div>
        </div>
        <div class="grid3">
          <div>
            <div class="subtitle">Users</div>
            <div style="font-weight:600">${subscription.currentUsers}/${maxUsers}</div>
          </div>
          <div>
            <div class="subtitle">Tickets/Month</div>
            <div style="font-weight:600">${subscription.currentTickets}/${maxTickets}</div>
          </div>
          <div>
            <div class="subtitle">Storage</div>
            <div style="font-weight:600">${subscription.currentStorage}GB/${maxStorage}</div>
          </div>
        </div>
        <div class="mt-12">
          <div class="subtitle">Features:</div>
          <div style="font-size:14px;color:#666;">${subscription.features.join(', ')}</div>
        </div>
      </div>
    `;
  }
  
  function displayPlanComparison(plans, currentTenantId) {
    const comparison = document.getElementById('plan-comparison');
    
    const planCards = plans.map(plan => {
      const isCurrentPlan = plan.id === 'starter' || plan.id === 'trial'; // This would need to be determined from current subscription
      const maxUsers = plan.maxUsers === -1 ? 'âˆ' : plan.maxUsers;
      const maxTickets = plan.maxTickets === -1 ? 'âˆ' : plan.maxTickets;
      const maxStorage = plan.maxStorage === -1 ? 'âˆ' : plan.maxStorage + 'GB';
      
      return `
        <div class="card p-16 ${isCurrentPlan ? 'current-plan' : ''}" style="border: 2px solid ${isCurrentPlan ? '#007bff' : '#e0e0e0'}; ${isCurrentPlan ? 'background: #f8f9fa;' : ''}">
          <div class="row space mb-12">
            <div>
              <h4 style="margin:0;color:${isCurrentPlan ? '#007bff' : '#333'};">${plan.name} Plan</h4>
              <div class="subtitle">$${plan.monthlyPrice}/month</div>
            </div>
            ${isCurrentPlan ? '<div class="badge" style="background:#007bff;color:white;">CURRENT</div>' : ''}
          </div>
          <div class="grid3 mb-12">
            <div>
              <div class="subtitle">Users</div>
              <div style="font-weight:600;font-size:18px;">${maxUsers}</div>
            </div>
            <div>
              <div class="subtitle">Tickets/Month</div>
              <div style="font-weight:600;font-size:18px;">${maxTickets}</div>
            </div>
            <div>
              <div class="subtitle">Storage</div>
              <div style="font-weight:600;font-size:18px;">${maxStorage}</div>
            </div>
          </div>
          <div class="mb-12">
            <div class="subtitle">Features:</div>
            <div style="font-size:14px;color:#666;">${plan.features.join(', ')}</div>
          </div>
          ${!isCurrentPlan ? `<button class="btn primary" onclick="showUpgradeForm('${plan.id}')" style="width:100%;">Upgrade to ${plan.name}</button>` : ''}
        </div>
      `;
    }).join('');
    
    comparison.innerHTML = `<div class="grid3">${planCards}</div>`;
  }
  
  function showUpgradeForm(planId) {
    // This would show upgrade confirmation form
    alert(`Upgrade to ${planId} plan - This would show upgrade confirmation in a real system`);
  }
  
  function hideUpgradeForm() {
    document.getElementById('upgrade-form').style.display = 'none';
  }
  
  function confirmUpgrade() {
    alert('Upgrade confirmed - This would process the upgrade in a real system');
    hideUpgradeForm();
  }
  
  function refreshCustomerPlans() {
    loadCustomerPlans();
  }
  
  // Customer Billing Functions
  async function loadCustomerBilling() {
    try {
      const tenantId = window.currentTenant || 'apoyar';
      
      // Load subscription details
      const masterData = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/subscriptions', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      const masterResponse = await masterData.json();
      const currentSubscription = masterResponse.subscriptions?.find(s => s.tenantId === tenantId);
      
      if (currentSubscription) {
        displayBillingSummary(currentSubscription);
        displayPaymentMethod();
        displayInvoiceHistory();
      } else {
        document.getElementById('billing-current-plan').textContent = 'No subscription found';
      }
      
    } catch (error) {
      console.error('Error loading customer billing:', error);
      document.getElementById('billing-current-plan').textContent = 'Error loading billing';
    }
  }
  
  function displayBillingSummary(subscription) {
    const planName = subscription.plan.charAt(0).toUpperCase() + subscription.plan.slice(1);
    const nextBillingDate = new Date(subscription.nextBillingDate).toLocaleDateString();
    
    document.getElementById('billing-current-plan').textContent = planName;
    document.getElementById('billing-next-date').textContent = nextBillingDate;
    document.getElementById('billing-monthly-cost').textContent = '$' + subscription.monthlyPrice;
  }
  
  function displayPaymentMethod() {
    const paymentInfo = document.getElementById('payment-method-info');
    paymentInfo.innerHTML = `
      <div class="row space">
        <div>
          <div class="subtitle">Card ending in 1234</div>
          <div style="font-size:14px;color:#666;">Expires 12/25</div>
        </div>
        <button class="btn">Update Payment Method</button>
      </div>
      <div class="subtitle" style="margin-top:8px;">This is demo data - in a real system, this would show actual payment method details</div>
    `;
  }
  
  function displayInvoiceHistory() {
    const invoiceBody = document.getElementById('invoice-list-body');
    
    // Mock invoice data
    const invoices = [
      { id: 'INV-001', date: '2025-09-01', amount: 29, status: 'Paid' },
      { id: 'INV-002', date: '2025-08-01', amount: 29, status: 'Paid' },
      { id: 'INV-003', date: '2025-07-01', amount: 29, status: 'Paid' }
    ];
    
    invoiceBody.innerHTML = invoices.map(invoice => `
      <tr>
        <td>${invoice.id}</td>
        <td>${new Date(invoice.date).toLocaleDateString()}</td>
        <td>$${invoice.amount}</td>
        <td><span class="badge status-${invoice.status.toLowerCase()}">${invoice.status}</span></td>
        <td>
          <button class="btn btn-sm" onclick="viewInvoice('${invoice.id}')">View</button>
          <button class="btn btn-sm" onclick="downloadInvoice('${invoice.id}')">Download</button>
        </td>
      </tr>
    `).join('');
  }
  
  function viewInvoice(invoiceId) {
    alert(`View invoice ${invoiceId} - This would open the invoice in a new window`);
  }
  
  function downloadInvoice(invoiceId) {
    alert(`Download invoice ${invoiceId} - This would download the PDF invoice`);
  }
  
  function refreshCustomerBilling() {
    loadCustomerBilling();
  }
  
  // Analytics Functions
  async function loadAnalytics() {
    console.log('loadAnalytics() called');

    try {
      const tenantId = window.currentTenant || 'apoyar';
      const url = window.location.protocol + '//' + window.location.host + `/api/analytics/${tenantId}?period=30`;

      console.log('Fetching analytics from:', url);

      // Load analytics data from new endpoint
      const analyticsResponse = await fetch(url, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      console.log('Analytics response status:', analyticsResponse.status);

      const analyticsData = await analyticsResponse.json();
      console.log('Analytics data received:', analyticsData);

      if (analyticsData.success) {
        console.log('Analytics loaded successfully, calling displayAnalyticsFromAPI');
        displayAnalyticsFromAPI(analyticsData.analytics);
      } else {
        console.error('Analytics API returned success=false:', analyticsData);
        document.getElementById('analytics-total-tickets').textContent = 'Error';
      }

    } catch (error) {
      console.error('Error in loadAnalytics:', error);
      document.getElementById('analytics-total-tickets').textContent = 'Error';
    }
  }

  function displayAnalyticsFromAPI(analytics) {
    console.log('displayAnalyticsFromAPI called with:', analytics);

    try {
      // Update summary cards using analytics data (convert strings to numbers)
      const totalTickets = parseInt(analytics.tickets.total) || 0;
      const openTickets = parseInt(analytics.tickets.byStatus.open) || 0;
      const resolvedCount = parseInt(analytics.tickets.byStatus.resolved) || 0;

      console.log('Setting analytics values:', { totalTickets, openTickets, resolvedCount });

      document.getElementById('analytics-total-tickets').textContent = totalTickets;
      document.getElementById('analytics-open-tickets').textContent = openTickets;
      document.getElementById('analytics-resolved-today').textContent = resolvedCount;

      // Display average response time from performance data
      const avgTime = analytics.performance.avgResolutionTimeHours;
      document.getElementById('analytics-avg-response').textContent = avgTime ? Math.round(avgTime) + 'h' : '0h';

      // Create charts from analytics data with error handling
      if (analytics.tickets.byStatus) {
        createStatusChartFromAnalytics(analytics.tickets.byStatus);
      }
      if (analytics.tickets.byPriority) {
        createPriorityChartFromAnalytics(analytics.tickets.byPriority);
      }
      displayRecentActivity([]);  // Empty for now - could use trends data later

      console.log('Analytics display completed successfully');
    } catch (error) {
      console.error('Error in displayAnalyticsFromAPI:', error);
      throw error; // Re-throw to be caught by outer try-catch
    }
  }

  function createStatusChartFromAnalytics(byStatus) {
    try {
      const chartContainer = document.getElementById('ticket-status-chart');

      if (!chartContainer) {
        console.error('Status chart container not found');
        return;
      }

      const colors = {
        'open': '#ff9800',
        'in_progress': '#2196f3',
        'resolved': '#4caf50',
        'closed': '#9e9e9e'
      };

      const statusLabels = {
        'open': 'Open',
        'in_progress': 'In Progress',
        'resolved': 'Resolved',
        'closed': 'Closed'
      };

      // Convert string counts to numbers and calculate total
      const total = Object.values(byStatus).reduce((sum, count) => sum + parseInt(count || 0), 0);

      let chartHtml = '<div style="display:flex;flex-direction:column;gap:8px;width:100%;">';
      Object.entries(byStatus).forEach(([status, count]) => {
        const numCount = parseInt(count || 0);
        const percentage = total > 0 ? (numCount / total) * 100 : 0;
        const label = statusLabels[status] || status;
        chartHtml += `
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:12px;height:12px;background:${colors[status] || '#666'};border-radius:2px;"></div>
            <div style="flex:1;font-size:14px;">${label}</div>
            <div style="font-weight:600;">${numCount}</div>
            <div style="font-size:12px;color:#666;">${percentage.toFixed(1)}%</div>
          </div>
        `;
      });
      chartHtml += '</div>';

      chartContainer.innerHTML = chartHtml;
    } catch (error) {
      console.error('Error in createStatusChartFromAnalytics:', error);
    }
  }

  function createPriorityChartFromAnalytics(byPriority) {
    try {
      const chartContainer = document.getElementById('priority-chart');

      if (!chartContainer) {
        console.error('Priority chart container not found');
        return;
      }

      const colors = {
        'critical': '#f44336',
        'high': '#ff9800',
        'medium': '#ffc107',
        'low': '#4caf50'
      };

      const priorityLabels = {
        'critical': 'Critical',
        'high': 'High',
        'medium': 'Medium',
        'low': 'Low'
      };

      // Convert string counts to numbers and calculate total
      const total = Object.values(byPriority).reduce((sum, count) => sum + parseInt(count || 0), 0);

      let chartHtml = '<div style="display:flex;flex-direction:column;gap:8px;width:100%;">';
      Object.entries(byPriority).forEach(([priority, count]) => {
        const numCount = parseInt(count || 0);
        const percentage = total > 0 ? (numCount / total) * 100 : 0;
        const label = priorityLabels[priority] || priority;
        chartHtml += `
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:12px;height:12px;background:${colors[priority] || '#666'};border-radius:2px;"></div>
            <div style="flex:1;font-size:14px;">${label}</div>
            <div style="font-weight:600;">${numCount}</div>
            <div style="font-size:12px;color:#666;">${percentage.toFixed(1)}%</div>
          </div>
        `;
      });
      chartHtml += '</div>';

      chartContainer.innerHTML = chartHtml;
    } catch (error) {
      console.error('Error in createPriorityChartFromAnalytics:', error);
    }
  }
  
  // Old functions removed - now using API-based analytics functions above

  function displayRecentActivity(tickets) {
    const recentTickets = tickets
      .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
      .slice(0, 10);
    
    const activityContainer = document.getElementById('recent-activity');
    
    if (recentTickets.length === 0) {
      activityContainer.innerHTML = '<div class="subtitle">No recent activity</div>';
      return;
    }
    
    let activityHtml = '<div style="display:flex;flex-direction:column;gap:8px;">';
    recentTickets.forEach(ticket => {
      const timeAgo = getTimeAgo(new Date(ticket.updatedAt));
      activityHtml += `
        <div style="display:flex;align-items:center;gap:12px;padding:8px;background:#f8f9fa;border-radius:4px;">
          <div style="width:8px;height:8px;background:#2196f3;border-radius:50%;"></div>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:14px;">Ticket #${ticket.id}</div>
            <div style="font-size:12px;color:#666;">${ticket.title}</div>
          </div>
          <div style="font-size:12px;color:#666;">${timeAgo}</div>
        </div>
      `;
    });
    activityHtml += '</div>';
    
    activityContainer.innerHTML = activityHtml;
  }
  
  function getTimeAgo(date) {
    const now = new Date();
    const diffInMinutes = Math.floor((now - date) / (1000 * 60));
    
    if (diffInMinutes < 1) return 'Just now';
    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) return `${diffInHours}h ago`;
    
    const diffInDays = Math.floor(diffInHours / 24);
    return `${diffInDays}d ago`;
  }
  
  function refreshAnalytics() {
    loadAnalytics();
  }

  // Export Functions
  function exportTicketsToCSV() {
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Please login first');
      return;
    }

    const tenant = currentUser.role === 'master' ? currentTenant : currentUser.tenant;

    // Create a link and trigger download
    const url = `${API_BASE_URL}/api/tickets/${tenant}/export/csv`;
    const link = document.createElement('a');
    link.href = url;
    link.download = `tickets_${tenant}_${Date.now()}.csv`;

    // Add authorization header via fetch
    fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Export failed');
      return response.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `tickets_${tenant}_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    })
    .catch(error => {
      console.error('Error exporting tickets:', error);
      alert('Failed to export tickets. Please try again.');
    });
  }

  function exportAnalyticsToCSV() {
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Please login first');
      return;
    }

    const tenant = currentUser.role === 'master' ? currentTenant : currentUser.tenant;
    const period = 30; // Default to 30 days

    // Fetch and download
    fetch(`${API_BASE_URL}/api/analytics/${tenant}/export/csv?period=${period}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Export failed');
      return response.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `analytics_${tenant}_${period}days_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    })
    .catch(error => {
      console.error('Error exporting analytics:', error);
      alert('Failed to export analytics. Please try again.');
    });
  }

  // Email Processing Functions
  async function loadEmailProcessing() {
    try {
      // Load email settings
      const settingsResponse = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/email-settings', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      const settingsData = await settingsResponse.json();
      
      if (settingsData.success) {
        displayEmailSettings(settingsData.settings);
      }
      
      // Load tenant email settings
      const tenantsResponse = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/tenants', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      
      const tenantsData = await tenantsResponse.json();
      
      if (tenantsData.success) {
        displayTenantEmailSettings(tenantsData.tenants);
      }
      
    } catch (error) {
      console.error('Error loading email processing:', error);
      document.getElementById('email-settings-info').innerHTML = '<div class="usage-alert danger">Error loading email settings</div>';
    }
  }
  
  function displayEmailSettings(settings) {
    const settingsInfo = document.getElementById('email-settings-info');
    const configHelp = document.getElementById('email-configuration-help');
    
    if (settings.needsConfiguration) {
      settingsInfo.innerHTML = `
        <div class="grid3">
          <div>
            <div class="subtitle">IMAP Host</div>
            <div style="font-weight:600;">${settings.imap.host}</div>
          </div>
          <div>
            <div class="subtitle">IMAP Port</div>
            <div style="font-weight:600;">${settings.imap.port}</div>
          </div>
          <div>
            <div class="subtitle">Check Interval</div>
            <div style="font-weight:600;">${settings.checkInterval / 1000}s</div>
          </div>
        </div>
        <div class="mt-12">
          <div class="subtitle">Status</div>
          <div style="font-weight:600;color:#ff9800;">${settings.status} (Demo Mode)</div>
        </div>
      `;
      configHelp.style.display = 'block';
    } else {
      settingsInfo.innerHTML = `
        <div class="grid3">
          <div>
            <div class="subtitle">IMAP Host</div>
            <div style="font-weight:600;">${settings.imap.host}</div>
          </div>
          <div>
            <div class="subtitle">IMAP Port</div>
            <div style="font-weight:600;">${settings.imap.port}</div>
          </div>
          <div>
            <div class="subtitle">Check Interval</div>
            <div style="font-weight:600;">${settings.checkInterval / 1000}s</div>
          </div>
        </div>
        <div class="mt-12">
          <div class="subtitle">Status</div>
          <div style="font-weight:600;color:#4caf50;">${settings.status}</div>
        </div>
        <div class="mt-8">
          <div class="subtitle">Email Account</div>
          <div style="font-weight:600;">${settings.imap.user}</div>
        </div>
      `;
      configHelp.style.display = 'none';
    }
  }
  
  function displayTenantEmailSettings(tenants) {
    const tenantBody = document.getElementById('tenant-email-list-body');
    
    tenantBody.innerHTML = tenants.map(tenant => `
      <tr>
        <td>${tenant.companyName || tenant.tenantId}</td>
        <td>${tenant.domain || 'Not set'}</td>
        <td>
          <span class="badge ${tenant.emailProcessingEnabled ? 'status-active' : 'status-inactive'}">
            ${tenant.emailProcessingEnabled ? 'Enabled' : 'Disabled'}
          </span>
        </td>
        <td>
          <button class="btn btn-sm" onclick="editTenantEmailSettings('${tenant.tenantId}')">Edit</button>
        </td>
      </tr>
    `).join('');
  }
  
  async function testEmailProcessing() {
    try {
      const email = document.getElementById('test-email').value;
      const subject = document.getElementById('test-subject').value;
      const message = document.getElementById('test-message').value;
      
      if (!email) {
        alert('Please enter an email address');
        return;
      }
      
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/email-settings/test', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ email, subject, message })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('Email processing test completed! Check the server logs for details.');
      } else {
        alert('Error testing email processing: ' + data.message);
      }
      
    } catch (error) {
      console.error('Error testing email processing:', error);
      alert('Error testing email processing');
    }
  }
  
  async function editTenantEmailSettings(tenantId) {
    const domain = prompt('Enter email domain for this tenant (e.g., company.com):');
    if (domain === null) return;
    
    const enabled = confirm('Enable email processing for this tenant?');
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/tenants/${tenantId}/email-settings`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ domain, emailProcessingEnabled: enabled })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('Tenant email settings updated successfully!');
        loadEmailProcessing(); // Refresh the view
      } else {
        alert('Error updating tenant email settings: ' + data.message);
      }
      
    } catch (error) {
      console.error('Error updating tenant email settings:', error);
      alert('Error updating tenant email settings');
    }
  }
  
  function refreshEmailSettings() {
    loadEmailProcessing();
  }
  
  async function editTenant(tenantId) {
    try {
      // First, get the current tenant data
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/tenants', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });

      const data = await response.json();
      if (!data.success) {
        alert('Error loading tenant data');
        return;
      }

      const tenant = data.tenants.find(t => t.id === tenantId);
      if (!tenant) {
        alert('Tenant not found');
        return;
      }

      // Show edit form with current data
      showEditTenantForm(tenant);
    } catch (error) {
      console.error('Error loading tenant:', error);
      alert('Error loading tenant data');
    }
  }
  
  function deleteTenant(tenantId) {
    if (confirm('Are you sure you want to delete tenant: ' + tenantId + '?')) {
      // Placeholder for delete tenant functionality
      alert('Delete tenant functionality not yet implemented for: ' + tenantId);
    }
  }
  
  // Subscription Management Functions
  async function loadSubscriptions() {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/subscriptions', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      
      if (data.success) {
        updateSubscriptionStats(data.subscriptions);
        renderSubscriptionList(data.subscriptions);
      }
    } catch (error) {
      console.error('Error loading subscriptions:', error);
    }
  }
  
  function updateSubscriptionStats(subscriptions) {
    const activeSubscriptions = subscriptions.filter(s => s.status === 'active').length;
    const totalRevenue = subscriptions.reduce((sum, s) => sum + (s.monthlyPrice || 0), 0);
    const trialSubscriptions = subscriptions.filter(s => s.plan === 'trial').length;
    const convertedTrials = subscriptions.filter(s => s.plan !== 'trial' && s.previousPlan === 'trial').length;
    const conversionRate = trialSubscriptions > 0 ? Math.round((convertedTrials / trialSubscriptions) * 100) : 0;
    
    document.getElementById('active-subscriptions').textContent = activeSubscriptions;
    document.getElementById('total-revenue').textContent = '$' + totalRevenue.toLocaleString();
    document.getElementById('trial-conversions').textContent = conversionRate + '%';
  }
  
  function renderSubscriptionList(subscriptions) {
    const tbody = document.getElementById('subscription-list-body');
    if (tbody) {
      tbody.innerHTML = '';
      subscriptions.forEach(sub => {
        const tr = document.createElement('tr');
        const usage = sub.maxUsers === -1 ? sub.currentUsers + '/âˆ' : sub.currentUsers + '/' + sub.maxUsers;
        const nextBilling = sub.nextBillingDate ? new Date(sub.nextBillingDate).toLocaleDateString() : 'N/A';
        
        // Add trial expiration info
        let trialInfo = '';
        if (sub.plan === 'trial' && sub.trialEndDate) {
          const trialEnd = new Date(sub.trialEndDate);
          const now = new Date();
          const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
          
          if (daysLeft > 0) {
            trialInfo = `<br><small style="color: #ff9800;">Trial expires in ${daysLeft} days</small>`;
          } else {
            trialInfo = `<br><small style="color: #f44336;">Trial expired</small>`;
          }
        }
        
        tr.innerHTML = `
          <td>${sub.tenantName}${trialInfo}</td>
          <td><span class="badge plan-${sub.plan}">${sub.plan.toUpperCase()}</span></td>
          <td><span class="badge status-${sub.status}">${sub.status}</span></td>
          <td>$${sub.monthlyPrice}/month</td>
          <td>${nextBilling}</td>
          <td>${usage}</td>
          <td>${sub.usagePercentage}%</td>
          <td>
            ${sub.plan === 'trial' ? `
              <button onclick="extendTrial('${sub.id}')" class="btn btn-sm">Extend</button>
              <button onclick="convertTrial('${sub.id}')" class="btn btn-sm btn-primary">Convert</button>
            ` : `
              <button onclick="editSubscription('${sub.id}')" class="btn btn-sm">Edit</button>
              <button onclick="cancelSubscription('${sub.id}')" class="btn btn-sm btn-danger">Cancel</button>
            `}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  }
  
  function showCreateSubscriptionForm() {
    document.getElementById('create-subscription-form').style.display = 'block';
    loadTenantsForSubscription();
  }
  
  function hideCreateSubscriptionForm() {
    document.getElementById('create-subscription-form').style.display = 'none';
    document.getElementById('subscription-tenant').value = '';
    document.getElementById('subscription-plan').value = 'trial';
    document.getElementById('subscription-billing').value = 'monthly';
  }
  
  async function loadTenantsForSubscription() {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/tenants', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      
      if (data.success) {
        const select = document.getElementById('subscription-tenant');
        select.innerHTML = '<option value="">Choose a tenant...</option>';
        data.tenants.forEach(tenant => {
          const option = document.createElement('option');
          option.value = tenant.tenantId;
          option.textContent = tenant.companyName;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading tenants:', error);
    }
  }
  
  async function createSubscription() {
    const tenantId = document.getElementById('subscription-tenant').value;
    const plan = document.getElementById('subscription-plan').value;
    const billing = document.getElementById('subscription-billing').value;
    
    if (!tenantId || !plan) {
      alert('Please fill in all required fields');
      return;
    }
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/subscriptions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          tenantId,
          plan,
          billing
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('Subscription created successfully!');
        hideCreateSubscriptionForm();
        loadSubscriptions();
      } else {
        alert('Error creating subscription: ' + data.message);
      }
    } catch (error) {
      console.error('Error creating subscription:', error);
      alert('Error creating subscription');
    }
  }
  
  function editSubscription(subscriptionId) {
    alert('Edit subscription functionality not yet implemented for: ' + subscriptionId);
  }
  
  function cancelSubscription(subscriptionId) {
    if (confirm('Are you sure you want to cancel this subscription?')) {
      alert('Cancel subscription functionality not yet implemented for: ' + subscriptionId);
    }
  }
  
  function exportSubscriptions() {
    alert('Export subscriptions functionality not yet implemented');
  }
  
  // Trial Management Functions
  async function extendTrial(subscriptionId) {
    const days = prompt('How many days to extend the trial? (default: 7)', '7');
    if (!days || isNaN(days)) return;
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/subscriptions/${subscriptionId}/extend-trial`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ days: parseInt(days) })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert(`Trial extended by ${days} days!`);
        loadSubscriptions();
      } else {
        alert('Error extending trial: ' + data.message);
      }
    } catch (error) {
      console.error('Error extending trial:', error);
      alert('Error extending trial');
    }
  }
  
  async function convertTrial(subscriptionId) {
    const newPlan = prompt('Convert to which plan? (starter/pro)', 'starter');
    if (!newPlan || !['starter', 'pro'].includes(newPlan)) {
      alert('Please enter a valid plan: starter or pro');
      return;
    }
    
    const billing = prompt('Billing cycle? (monthly/yearly)', 'monthly');
    if (!billing || !['monthly', 'yearly'].includes(billing)) {
      alert('Please enter a valid billing cycle: monthly or yearly');
      return;
    }
    
    if (!confirm(`Convert trial to ${newPlan} plan (${billing} billing)?`)) return;
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + `/api/master/subscriptions/${subscriptionId}/convert-trial`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ newPlan, billing })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert(`Trial converted to ${newPlan} plan!`);
        loadSubscriptions();
      } else {
        alert('Error converting trial: ' + data.message);
      }
    } catch (error) {
      console.error('Error converting trial:', error);
      alert('Error converting trial');
    }
  }
  
  // Billing Management Functions
  async function loadBilling() {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/billing', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      
      if (data.success) {
        updateBillingStats(data.billing);
        renderBillingList(data.transactions);
      }
    } catch (error) {
      console.error('Error loading billing:', error);
    }
  }
  
  function updateBillingStats(billing) {
    document.getElementById('mrr').textContent = '$' + billing.mrr.toLocaleString();
    document.getElementById('pending-payments').textContent = '$' + billing.pendingPayments.toLocaleString();
    document.getElementById('churn-rate').textContent = billing.churnRate + '%';
    document.getElementById('arpu').textContent = '$' + billing.arpu.toLocaleString();
  }
  
  function renderBillingList(transactions) {
    const tbody = document.getElementById('billing-list-body');
    if (tbody) {
      tbody.innerHTML = '';
      transactions.forEach(transaction => {
        const tr = document.createElement('tr');
        const date = new Date(transaction.date).toLocaleDateString();
        const statusClass = transaction.status === 'paid' ? 'status-success' : 
                           transaction.status === 'pending' ? 'status-warning' : 'status-error';
        
        tr.innerHTML = `
          <td>${date}</td>
          <td>${transaction.tenantName}</td>
          <td>${transaction.description}</td>
          <td>$${transaction.amount}</td>
          <td><span class="badge ${statusClass}">${transaction.status}</span></td>
          <td><button onclick="viewInvoice('${transaction.invoiceId}')" class="btn btn-sm">View</button></td>
        `;
        tbody.appendChild(tr);
      });
    }
  }
  
  function generateInvoice() {
    alert('Generate invoice functionality not yet implemented');
  }
  
  function exportBilling() {
    alert('Export billing functionality not yet implemented');
  }
  
  function viewInvoice(invoiceId) {
    alert('View invoice functionality not yet implemented for: ' + invoiceId);
  }
  
  // Plan Management Functions
  async function loadPlans() {
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/plans', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      });
      const data = await response.json();
      
      if (data.success) {
        updatePlanStats(data.plans);
        renderPlansList(data.plans);
      }
    } catch (error) {
      console.error('Error loading plans:', error);
    }
  }
  
  function updatePlanStats(plans) {
    const totalPlans = plans.length;
    const activePlans = plans.filter(p => p.status === 'active').length;
    const popularPlan = plans.reduce((prev, current) => 
      (prev.subscriberCount || 0) > (current.subscriberCount || 0) ? prev : current
    );
    
    document.getElementById('total-plans').textContent = totalPlans;
    document.getElementById('active-plans').textContent = activePlans;
    document.getElementById('popular-plan').textContent = popularPlan.name || 'N/A';
  }
  
  function renderPlansList(plans) {
    const tbody = document.getElementById('plans-list-body');
    if (tbody) {
      tbody.innerHTML = '';
      plans.forEach(plan => {
        const tr = document.createElement('tr');
        const users = plan.maxUsers === -1 ? 'Unlimited' : plan.maxUsers;
        const tickets = plan.maxTickets === -1 ? 'Unlimited' : plan.maxTickets;
        const storage = plan.maxStorage === -1 ? 'Unlimited' : plan.maxStorage + 'GB';
        const features = plan.features.slice(0, 3).join(', ') + (plan.features.length > 3 ? '...' : '');
        
        tr.innerHTML = `
          <td><strong>${plan.name}</strong></td>
          <td>$${plan.monthlyPrice}/month</td>
          <td>${users}</td>
          <td>${tickets}</td>
          <td>${storage}</td>
          <td title="${plan.features.join(', ')}">${features}</td>
          <td><span class="badge status-${plan.status}">${plan.status}</span></td>
          <td>
            <button onclick="editPlan('${plan.id}')" class="btn btn-sm">Edit</button>
            <button onclick="duplicatePlan('${plan.id}')" class="btn btn-sm">Copy</button>
            <button onclick="deletePlan('${plan.id}')" class="btn btn-sm btn-danger">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  }
  
  function showCreatePlanForm() {
    document.getElementById('create-plan-form').style.display = 'block';
    document.getElementById('plan-form-title').textContent = 'Create New Plan';
    clearPlanForm();
  }
  
  function hideCreatePlanForm() {
    document.getElementById('create-plan-form').style.display = 'none';
    clearPlanForm();
  }
  
  function clearPlanForm() {
    document.getElementById('plan-name').value = '';
    document.getElementById('plan-id').value = '';
    document.getElementById('plan-price').value = '';
    document.getElementById('plan-users').value = '';
    document.getElementById('plan-tickets').value = '';
    document.getElementById('plan-storage').value = '';
    document.getElementById('plan-status').value = 'active';
    document.getElementById('plan-features').value = '';
  }
  
  async function savePlan() {
    const planData = {
      name: document.getElementById('plan-name').value,
      id: document.getElementById('plan-id').value,
      monthlyPrice: parseInt(document.getElementById('plan-price').value) || 0,
      maxUsers: parseInt(document.getElementById('plan-users').value) || 0,
      maxTickets: parseInt(document.getElementById('plan-tickets').value) || 0,
      maxStorage: parseInt(document.getElementById('plan-storage').value) || 0,
      status: document.getElementById('plan-status').value,
      features: document.getElementById('plan-features').value.split(',').map(f => f.trim()).filter(f => f)
    };
    
    if (!planData.name || !planData.id) {
      alert('Please fill in plan name and ID');
      return;
    }
    
    try {
      const response = await fetch(window.location.protocol + '//' + window.location.host + '/api/master/plans', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify(planData)
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('Plan saved successfully!');
        hideCreatePlanForm();
        loadPlans();
      } else {
        alert('Error saving plan: ' + data.message);
      }
    } catch (error) {
      console.error('Error saving plan:', error);
      alert('Error saving plan');
    }
  }
  
  function editPlan(planId) {
    alert('Edit plan functionality not yet implemented for: ' + planId);
  }
  
  function duplicatePlan(planId) {
    alert('Duplicate plan functionality not yet implemented for: ' + planId);
  }
  
  function deletePlan(planId) {
    if (confirm('Are you sure you want to delete this plan?')) {
      alert('Delete plan functionality not yet implemented for: ' + planId);
    }
  }
  
  function exportPlans() {
    alert('Export plans functionality not yet implemented');
  }

  // ---- Tickets ----
  async function renderList(){
    const tb=document.getElementById('list-body');
    if(!tb) return;
    tb.innerHTML='';

    // Fetch tickets from backend API
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.tickets) {
        // Update local tickets array with fetched data
        tickets = data.tickets.map(t => ({
          id: t.id,
          title: t.title,
          description: t.description,
          priority: t.priority,
          status: t.status,
          assignee: t.assignee_name || 'â€”',
          assignee_id: t.assignee_id,
          customer: t.requester_name || 'â€”',
          customer_id: t.requester_id,
          customer_company_id: t.customer_company_id,
          company_name: t.company_name || 'â€”',
          company_domain: t.company_domain,
          created: t.created_at,
          sla_deadline: t.sla_deadline,
          cmdb_item_name: t.cmdb_item_name
        }));

        // Populate assignee filter dropdown
        populateAssigneeFilter();

        // Populate company filter dropdown
        populateCompanyFilter();

        // Populate customer/team member filter dropdown
        populateCustomerFilter();

        // Apply filters
        let filteredTickets = applyTicketFilters(tickets);

        // Apply sorting
        filteredTickets = applySorting(filteredTickets);

        // Update ticket count
        const countDiv = document.getElementById('ticket-count');
        if (countDiv) {
          let countText = `Showing ${filteredTickets.length} of ${tickets.length} tickets`;

          // Add insight filter indicator
          if (window.insightTicketFilter && window.insightTicketFilter.length > 0) {
            countText = `ğŸ” Filtered by AI Insight: "${window.insightTitle}" - ${filteredTickets.length} tickets`;
            countText += ` <button class="btn ghost" style="padding:2px 8px;font-size:11px;margin-left:8px" onclick="clearInsightFilter()">âœ• Clear Filter</button>`;
          }

          countDiv.innerHTML = countText;
        }

        // Render tickets
        if (filteredTickets.length === 0) {
          tb.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;">No tickets match your filters</td></tr>';
        } else {
          filteredTickets.forEach(t=>{
            const tr=document.createElement('tr');
            const sla = getSLAState(t);
            const dateTime = formatDateTime(t.created);
            const isSelected = selectedTicketIds.has(t.id);
            tr.innerHTML = `<td onclick="event.stopPropagation()"><input type="checkbox" class="ticket-checkbox" data-ticket-id="${t.id}" ${isSelected ? 'checked' : ''} onchange="onTicketCheckboxChange(${t.id}, this.checked)"></td><td onclick="openTicket(${t.id})">#${t.id}</td><td onclick="openTicket(${t.id})">${t.title}</td><td onclick="openTicket(${t.id})">${dateTime}</td><td onclick="openTicket(${t.id})">${t.priority||'â€”'}</td><td onclick="openTicket(${t.id})">${t.status}</td><td onclick="openTicket(${t.id})">${t.assignee||'â€”'}</td><td onclick="openTicket(${t.id})">${t.customer}</td><td onclick="openTicket(${t.id})">${slaBadgeHTML(sla)}</td>`;
            if (isSelected) tr.style.backgroundColor = '#e0f2fe';
            tb.appendChild(tr);
          });
        }

        // Update select all checkbox state
        updateSelectAllCheckbox();
      } else {
        console.error('Failed to load tickets:', data.message);
        tb.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">Failed to load tickets</td></tr>';
      }
    } catch (error) {
      console.error('Error loading tickets:', error);
      tb.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;">Error loading tickets</td></tr>';
    }
  }

  // Populate assignee filter with unique assignees from tickets
  function populateAssigneeFilter() {
    const assigneeFilter = document.getElementById('ticket-filter-assignee');
    if (!assigneeFilter) return;

    // Get current selection
    const currentValue = assigneeFilter.value;

    // Get unique assignees
    const assignees = [...new Set(tickets.map(t => t.assignee).filter(a => a && a !== 'â€”'))].sort();

    // Keep first two options (All Assignees, Unassigned)
    assigneeFilter.innerHTML = '<option value="">All Assignees</option><option value="unassigned">Unassigned</option>';

    // Add assignee options
    assignees.forEach(assignee => {
      const option = document.createElement('option');
      option.value = assignee;
      option.textContent = assignee;
      assigneeFilter.appendChild(option);
    });

    // Restore selection
    assigneeFilter.value = currentValue;
  }

  // Populate company filter with unique companies from tickets
  function populateCompanyFilter() {
    const companyFilter = document.getElementById('ticket-filter-company');
    if (!companyFilter) return;

    // Get current selection
    const currentValue = companyFilter.value;

    // Get unique companies (by company_company_id to avoid duplicates)
    const companiesMap = new Map();
    tickets.forEach(t => {
      if (t.customer_company_id && t.company_name && t.company_name !== 'â€”') {
        companiesMap.set(t.customer_company_id, t.company_name);
      }
    });

    // Sort by company name
    const companies = Array.from(companiesMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));

    // Keep first option (All Companies)
    companyFilter.innerHTML = '<option value="">All Companies</option>';

    // Add company options
    companies.forEach(([id, name]) => {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = name;
      companyFilter.appendChild(option);
    });

    // Restore selection
    companyFilter.value = currentValue;
  }

  // When company filter changes, update team member filter
  function onCompanyFilterChange() {
    populateCustomerFilter();
    renderList();
  }

  // Populate customer/team member filter with customers from selected company (or all)
  function populateCustomerFilter() {
    const customerFilter = document.getElementById('ticket-filter-customer');
    if (!customerFilter) return;

    // Get current selection
    const currentValue = customerFilter.value;

    // Get selected company filter
    const companyFilter = document.getElementById('ticket-filter-company')?.value || '';

    // Get unique customers, filtered by company if selected
    const customersMap = new Map();
    tickets.forEach(t => {
      if (t.customer && t.customer !== 'â€”') {
        // If company filter is set, only include customers from that company
        if (companyFilter && t.customer_company_id != companyFilter) return;
        customersMap.set(t.customer_id, t.customer);
      }
    });

    // Sort by customer name
    const customers = Array.from(customersMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));

    // Keep first option (All Team Members)
    customerFilter.innerHTML = '<option value="">All Team Members</option>';

    // Add customer options
    customers.forEach(([id, name]) => {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = name;
      customerFilter.appendChild(option);
    });

    // Restore selection if still valid
    if (customersMap.has(parseInt(currentValue))) {
      customerFilter.value = currentValue;
    } else {
      customerFilter.value = '';
    }
  }

  // Apply ticket filters
  function applyTicketFilters(ticketList) {
    const searchTerm = (document.getElementById('ticket-search')?.value || '').toLowerCase();
    const statusFilter = document.getElementById('ticket-filter-status')?.value || '';
    const priorityFilter = document.getElementById('ticket-filter-priority')?.value || '';
    const assigneeFilter = document.getElementById('ticket-filter-assignee')?.value || '';
    const companyFilter = document.getElementById('ticket-filter-company')?.value || '';
    const customerFilter = document.getElementById('ticket-filter-customer')?.value || '';

    return ticketList.filter(t => {
      // Insight ticket filter (from AI Insights dashboard)
      if (window.insightTicketFilter && window.insightTicketFilter.length > 0) {
        if (!window.insightTicketFilter.includes(t.id)) return false;
      }

      // Search filter
      if (searchTerm) {
        const matchesSearch =
          String(t.id).includes(searchTerm) ||
          (t.title || '').toLowerCase().includes(searchTerm) ||
          (t.description || '').toLowerCase().includes(searchTerm) ||
          (t.customer || '').toLowerCase().includes(searchTerm) ||
          (t.company_name || '').toLowerCase().includes(searchTerm);
        if (!matchesSearch) return false;
      }

      // Status filter (case-insensitive)
      if (statusFilter && (t.status || '').toLowerCase() !== statusFilter.toLowerCase()) return false;

      // Priority filter (case-insensitive)
      if (priorityFilter && (t.priority || '').toLowerCase() !== priorityFilter.toLowerCase()) return false;

      // Assignee filter
      if (assigneeFilter) {
        if (assigneeFilter === 'unassigned') {
          if (t.assignee && t.assignee !== 'â€”') return false;
        } else {
          if (t.assignee !== assigneeFilter) return false;
        }
      }

      // Company filter - if company selected, filter by company
      if (companyFilter) {
        if (t.customer_company_id != companyFilter) return false;
      }

      // Customer/Team Member filter - if specific team member selected
      if (customerFilter) {
        if (t.customer_id != customerFilter) return false;
      }

      // SLA at risk filter (when clicked from dashboard)
      if (window.slaAtRiskFilter) {
        const slaState = getSLAState(t);
        // Only show tickets that are not resolved and have SLA at risk
        if ((t.status || '').toLowerCase() === 'resolved' || (t.status || '').toLowerCase() === 'closed') return false;
        if (slaState.cls === 'ok') return false;
      }

      return true;
    });
  }

  // Apply sorting to tickets
  function applySorting(ticketList) {
    const sortBy = document.getElementById('ticket-sort')?.value || 'id-desc';

    const priorityOrder = { 'Critical': 4, 'High': 3, 'Normal': 2, 'Low': 1 };

    return [...ticketList].sort((a, b) => {
      switch(sortBy) {
        case 'id-asc':
          return a.id - b.id;
        case 'id-desc':
          return b.id - a.id;
        case 'priority-desc':
          return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
        case 'priority-asc':
          return (priorityOrder[a.priority] || 0) - (priorityOrder[b.priority] || 0);
        case 'status':
          return (a.status || '').localeCompare(b.status || '');
        case 'sla':
          // Sort by SLA urgency - tickets with closer deadlines first
          const aSLA = getSLAState(a);
          const bSLA = getSLAState(b);
          const slaOrder = { 'breached': 0, 'critical': 1, 'warning': 2, 'ok': 3, 'none': 4 };
          return (slaOrder[aSLA] || 5) - (slaOrder[bSLA] || 5);
        default:
          return b.id - a.id;
      }
    });
  }

  // Clear all ticket filters
  function clearTicketFilters() {
    const searchInput = document.getElementById('ticket-search');
    const statusFilter = document.getElementById('ticket-filter-status');
    const priorityFilter = document.getElementById('ticket-filter-priority');
    const assigneeFilter = document.getElementById('ticket-filter-assignee');
    const companyFilter = document.getElementById('ticket-filter-company');
    const customerFilter = document.getElementById('ticket-filter-customer');
    const sortSelect = document.getElementById('ticket-sort');

    if (searchInput) searchInput.value = '';
    if (statusFilter) statusFilter.value = '';
    if (priorityFilter) priorityFilter.value = '';
    if (assigneeFilter) assigneeFilter.value = '';
    if (companyFilter) companyFilter.value = '';
    if (customerFilter) customerFilter.value = '';
    if (sortSelect) sortSelect.value = 'id-desc';

    // Also clear insight filters
    clearInsightFilter();

    saveFilterSettings('tickets');
    renderList();
  }

  // Clear AI Insight filter
  function clearInsightFilter() {
    window.insightTicketFilter = null;
    window.insightTitle = null;
    window.slaAtRiskFilter = false;
    renderList();
  }

  // Sort tickets by column (for table header clicks)
  function sortTicketsBy(column) {
    const sortSelect = document.getElementById('ticket-sort');
    if (!sortSelect) return;

    const sortMap = {
      'id': 'id-desc',
      'title': 'id-desc', // Default to ID for now
      'priority': 'priority-desc',
      'status': 'status',
      'sla': 'sla'
    };

    sortSelect.value = sortMap[column] || 'id-desc';
    renderList();
  }

  // ---- Bulk Selection ----
  let selectedTicketIds = new Set();
  let currentBulkAction = null;

  function onTicketCheckboxChange(ticketId, checked) {
    if (checked) {
      selectedTicketIds.add(ticketId);
    } else {
      selectedTicketIds.delete(ticketId);
    }
    updateBulkActionsBar();
    updateSelectAllCheckbox();
    // Highlight selected rows
    const checkbox = document.querySelector(`input[data-ticket-id="${ticketId}"]`);
    if (checkbox) {
      const row = checkbox.closest('tr');
      if (row) row.style.backgroundColor = checked ? '#e0f2fe' : '';
    }
  }

  function toggleSelectAllTickets() {
    const selectAll = document.getElementById('select-all-tickets');
    const checkboxes = document.querySelectorAll('.ticket-checkbox');

    if (selectAll.checked) {
      checkboxes.forEach(cb => {
        const ticketId = parseInt(cb.dataset.ticketId);
        selectedTicketIds.add(ticketId);
        cb.checked = true;
        const row = cb.closest('tr');
        if (row) row.style.backgroundColor = '#e0f2fe';
      });
    } else {
      checkboxes.forEach(cb => {
        const ticketId = parseInt(cb.dataset.ticketId);
        selectedTicketIds.delete(ticketId);
        cb.checked = false;
        const row = cb.closest('tr');
        if (row) row.style.backgroundColor = '';
      });
    }
    updateBulkActionsBar();
  }

  function updateSelectAllCheckbox() {
    const selectAll = document.getElementById('select-all-tickets');
    const checkboxes = document.querySelectorAll('.ticket-checkbox');
    if (!selectAll || checkboxes.length === 0) return;

    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    const someChecked = Array.from(checkboxes).some(cb => cb.checked);

    selectAll.checked = allChecked;
    selectAll.indeterminate = someChecked && !allChecked;
  }

  function updateBulkActionsBar() {
    const bar = document.getElementById('bulk-actions-bar');
    const countSpan = document.getElementById('bulk-selected-count');
    if (!bar) return;

    if (selectedTicketIds.size > 0) {
      bar.style.display = 'flex';
      countSpan.textContent = `${selectedTicketIds.size} ticket${selectedTicketIds.size > 1 ? 's' : ''} selected`;
    } else {
      bar.style.display = 'none';
    }
  }

  function clearBulkSelection() {
    selectedTicketIds.clear();
    const checkboxes = document.querySelectorAll('.ticket-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = false;
      const row = cb.closest('tr');
      if (row) row.style.backgroundColor = '';
    });
    const selectAll = document.getElementById('select-all-tickets');
    if (selectAll) selectAll.checked = false;
    updateBulkActionsBar();
  }

  async function openBulkActionDialog(action) {
    if (selectedTicketIds.size === 0) {
      alert('Please select at least one ticket');
      return;
    }

    currentBulkAction = action;
    const modal = document.getElementById('bulk-action-modal');
    const title = document.getElementById('bulk-action-title');
    const summary = document.getElementById('bulk-action-summary');
    const assigneeRow = document.getElementById('bulk-action-assignee-row');
    const noteInput = document.getElementById('bulk-action-note');
    const errorDiv = document.getElementById('bulk-action-error');
    const progressDiv = document.getElementById('bulk-action-progress');
    const submitBtn = document.getElementById('bulk-action-submit-btn');

    // Reset state
    noteInput.value = '';
    errorDiv.style.display = 'none';
    progressDiv.style.display = 'none';
    submitBtn.disabled = false;

    // Set title and summary based on action
    const ticketWord = selectedTicketIds.size > 1 ? 'tickets' : 'ticket';
    switch (action) {
      case 'close':
        title.textContent = 'Close Selected Tickets';
        summary.innerHTML = `You are about to <strong>close</strong> ${selectedTicketIds.size} ${ticketWord}.`;
        assigneeRow.style.display = 'none';
        break;
      case 'assign':
        title.textContent = 'Assign Selected Tickets';
        summary.innerHTML = `You are about to <strong>assign</strong> ${selectedTicketIds.size} ${ticketWord} to an expert.`;
        assigneeRow.style.display = 'block';
        await loadBulkActionExperts();
        break;
      case 'resolve':
        title.textContent = 'Resolve Selected Tickets';
        summary.innerHTML = `You are about to <strong>resolve</strong> ${selectedTicketIds.size} ${ticketWord}.`;
        assigneeRow.style.display = 'none';
        break;
    }

    modal.style.display = 'flex';
  }

  function closeBulkActionDialog() {
    const modal = document.getElementById('bulk-action-modal');
    modal.style.display = 'none';
    currentBulkAction = null;
  }

  async function loadBulkActionExperts() {
    const select = document.getElementById('bulk-action-assignee');
    select.innerHTML = '<option value="">-- Select Expert --</option>';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();
      if (data.success && data.experts) {
        data.experts.forEach(expert => {
          const option = document.createElement('option');
          option.value = expert.id;
          option.textContent = expert.full_name || expert.username;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading experts:', error);
    }
  }

  async function submitBulkAction() {
    const noteInput = document.getElementById('bulk-action-note');
    const errorDiv = document.getElementById('bulk-action-error');
    const progressDiv = document.getElementById('bulk-action-progress');
    const progressBar = document.getElementById('bulk-action-progress-bar');
    const progressText = document.getElementById('bulk-action-progress-text');
    const submitBtn = document.getElementById('bulk-action-submit-btn');

    const note = noteInput.value.trim();
    if (!note) {
      errorDiv.textContent = 'Please enter an action note';
      errorDiv.style.display = 'block';
      return;
    }

    if (currentBulkAction === 'assign') {
      const assignee = document.getElementById('bulk-action-assignee').value;
      if (!assignee) {
        errorDiv.textContent = 'Please select an expert to assign';
        errorDiv.style.display = 'block';
        return;
      }
    }

    // Hide error and show progress
    errorDiv.style.display = 'none';
    progressDiv.style.display = 'block';
    submitBtn.disabled = true;

    const ticketIds = Array.from(selectedTicketIds);
    const total = ticketIds.length;
    let completed = 0;
    let failed = 0;

    const token = localStorage.getItem('token');
    const tenantCode = window.tenant || 'apoyar';

    // Process tickets using bulk API endpoint
    try {
      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/bulk-action`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: currentBulkAction,
          ticket_ids: ticketIds,
          comment: note,
          assignee_id: currentBulkAction === 'assign' ? document.getElementById('bulk-action-assignee').value : null
        })
      });

      const data = await response.json();

      if (data.success) {
        completed = data.processed || total;
        failed = data.failed || 0;
        progressBar.style.width = '100%';
        progressText.textContent = `${completed} of ${total} completed` + (failed > 0 ? `, ${failed} failed` : '');

        // Close dialog after short delay and refresh
        setTimeout(() => {
          closeBulkActionDialog();
          clearBulkSelection();
          renderList();
          alert(`Bulk action completed: ${completed} ticket${completed > 1 ? 's' : ''} ${currentBulkAction === 'close' ? 'closed' : currentBulkAction === 'assign' ? 'assigned' : 'resolved'}`);
        }, 500);
      } else {
        errorDiv.textContent = data.message || 'Bulk action failed';
        errorDiv.style.display = 'block';
        progressDiv.style.display = 'none';
        submitBtn.disabled = false;
      }
    } catch (error) {
      console.error('Bulk action error:', error);
      errorDiv.textContent = 'Error processing bulk action';
      errorDiv.style.display = 'block';
      progressDiv.style.display = 'none';
      submitBtn.disabled = false;
    }
  }

  function openTicket(id){ currentTicketId=id; switchView('ticket-detail'); }
  async function renderTicketDetail(){
    const t=tickets.find(x=>x.id===currentTicketId);
    if(!t) return;

    // Load ticket details from backend to get latest data and activities
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${currentTicketId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.ticket) {
        const ticket = data.ticket;

        // Update form fields with latest data
        document.getElementById('td-id').textContent = '#' + ticket.id;
        document.getElementById('td-title').value = ticket.title || '';
        document.getElementById('td-desc').value = ticket.description || '';
        document.getElementById('td-priority').value = ticket.priority || 'medium';
        document.getElementById('td-status').value = ticket.status || 'open';
        document.getElementById('td-due').value = ticket.sla_deadline ? ticket.sla_deadline.split('T')[0] : '';
        document.getElementById('td-customer').value = ticket.requester_name || '';
        document.getElementById('td-item').value = ticket.cmdb_item_name || '';
        document.getElementById('td-ci').value = '';

        // Load experts dropdown and set current assignee
        loadExpertsDropdown(ticket.assignee_id);

        // Update local ticket object
        Object.assign(t, {
          status: ticket.status,
          priority: ticket.priority,
          assignee: ticket.assignee_name
        });

        // Render activities from backend
        const act=document.getElementById('td-activity');
        act.innerHTML='';

        if (data.activities && data.activities.length > 0) {
          data.activities.forEach(a => {
            const div=document.createElement('div');
            div.className='card p-12 mb-8';
            const userName = a.user_full_name || a.user_name || 'System';
            const actDate = new Date(a.created_at).toLocaleString();
            div.innerHTML = `<strong>${userName}</strong>: ${a.description}<br><small class="subtitle">${actDate}</small>`;
            act.appendChild(div);
          });
        } else {
          // No activities yet
          const div=document.createElement('div');
          div.className='card p-12 mb-8 subtitle';
          div.textContent = 'No activity recorded yet';
          act.appendChild(div);
        }
      }
    } catch (error) {
      console.error('Error loading ticket details:', error);
      // Fall back to local data
      document.getElementById('td-id').textContent = '#'+t.id;
      document.getElementById('td-title').value = t.title || '';
      document.getElementById('td-desc').value = t.desc || '';
      document.getElementById('td-priority').value = t.priority || 'Normal';
      document.getElementById('td-status').value = t.status || 'Open';
      document.getElementById('td-assignee').value = t.assignee || '';
      document.getElementById('td-due').value = t.due || '';
      document.getElementById('td-customer').value = t.customer || '';
      document.getElementById('td-item').value = t.itemId || '';
      document.getElementById('td-ci').value = t.ciId || '';

      const act=document.getElementById('td-activity');
      act.innerHTML='';
      const div=document.createElement('div');
      div.className='card p-12 mb-8 subtitle';
      div.textContent = 'Error loading ticket activity';
      act.appendChild(div);
    }

    updateTicketSLA();
  }

  // ---- Assignment functions ----
  async function loadExpertsDropdown(currentAssigneeId = null) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      if (!token || !tenantCode) {
        console.error('Missing authentication credentials');
        return;
      }

      // Fetch experts from API if not cached
      if (cachedExperts.length === 0) {
        const response = await fetch(`${API_BASE}/api/auth/experts`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success && Array.isArray(data.experts)) {
          cachedExperts = data.experts;
        } else {
          console.error('Failed to load experts:', data.error);
          return;
        }
      }

      // Populate the dropdown
      const dropdown = document.getElementById('td-assignee');
      if (!dropdown) return;

      // Clear existing options except the first placeholder
      dropdown.innerHTML = '<option value="">-- Select Expert --</option>';

      // Add expert options
      cachedExperts.forEach(expert => {
        const option = document.createElement('option');
        option.value = expert.id;
        option.textContent = `${expert.full_name} (${expert.username})`;
        dropdown.appendChild(option);
      });

      // Set current assignee if provided
      if (currentAssigneeId) {
        dropdown.value = currentAssigneeId;
      }
    } catch (error) {
      console.error('Error loading experts dropdown:', error);
    }
  }

  async function assignTicket() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      if (!token || !tenantCode) {
        alert('Not authenticated');
        return;
      }

      const dropdown = document.getElementById('td-assignee');
      const selectedExpertId = dropdown.value;

      if (!selectedExpertId) {
        alert('Please select an expert to assign the ticket to');
        return;
      }

      if (!currentTicketId) {
        alert('No ticket selected');
        return;
      }

      // Call the assignment API
      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${currentTicketId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          assignee_id: selectedExpertId,
          comment: 'Assigned via ticket detail page'
        })
      });

      const data = await response.json();

      if (data.success) {
        alert('Ticket assigned successfully! Email notification sent.');
        // Reload the ticket detail to show updated information
        renderTicketDetail();
      } else {
        alert('Failed to assign ticket: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error assigning ticket:', error);
      alert('Error assigning ticket. Please try again.');
    }
  }

  // ---- Completion Modal logic (Admin/Expert) ----
  let dlgAction=null;
  function roleAllowsCompletion(){ return role==='admin' || role==='expert'; }
  function openCompletion(action){
    if(!roleAllowsCompletion()){ alert('This action is available to Admin/Expert in the demo.'); return; }
    dlgAction = action;
    document.getElementById('dlg-title').textContent = action==='resolve' ? 'Resolve ticket' : 'Reassign ticket';
    document.getElementById('dlg-note').value='';
    document.getElementById('dlg-error').style.display='none';
    const assRow = document.getElementById('dlg-assignee-row');
    assRow.style.display = (action==='reassign') ? 'block' : 'none';
    if(action==='reassign'){
      document.getElementById('dlg-assignee').value = '';
      loadReassignExpertsDropdown();
    }
    document.getElementById('dlg').style.display='flex';
    setTimeout(()=>document.getElementById('dlg-note').focus(), 0);
  }
  function closeDlg(){ document.getElementById('dlg').style.display='none'; }

  async function loadReassignExpertsDropdown() {
    const dropdown = document.getElementById('dlg-assignee');
    if (!dropdown) return;

    // Clear and add placeholder
    dropdown.innerHTML = '<option value="">-- Select Expert --</option>';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      // Use cached experts if available, otherwise fetch
      if (cachedExperts.length === 0) {
        const response = await fetch(`${API_BASE}/api/auth/experts`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        if (data.success && Array.isArray(data.experts)) {
          cachedExperts = data.experts;
        }
      }

      // Populate dropdown with experts
      cachedExperts.forEach(expert => {
        const option = document.createElement('option');
        option.value = expert.id;
        option.textContent = `${expert.full_name} (${expert.username})`;
        option.dataset.fullName = expert.full_name;
        dropdown.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading experts for reassign:', error);
    }
  }

  function submitDlg(){
    const note = (document.getElementById('dlg-note').value||'').trim();
    const err = document.getElementById('dlg-error');
    if(!note){ err.textContent='Completion text is required.'; err.style.display='block'; return; }
    const t=tickets.find(x=>x.id===currentTicketId);
    if(!t){ closeDlg(); return; }
    const act=document.getElementById('td-activity');
    const log = document.createElement('div');
    log.className='card p-12 mb-8';
    if(dlgAction==='resolve'){
      log.innerHTML = `<strong>${role==='admin'?'Admin':'Expert'}</strong>: Resolved â€” ${note}`;
      act.appendChild(log);
      setStatus('Resolved', note, /*silent*/true);
    } else if(dlgAction==='reassign'){
      const dropdown = document.getElementById('dlg-assignee');
      const newAsgId = (dropdown.value||'').trim();
      if(!newAsgId){ err.textContent='Please select an expert.'; err.style.display='block'; return; }

      // Get the expert name from the selected option
      const selectedOption = dropdown.options[dropdown.selectedIndex];
      const expertName = selectedOption.dataset.fullName || selectedOption.textContent;

      // Call API to reassign the ticket
      reassignTicket(currentTicketId, newAsgId, note, expertName, log, act);
      return; // Don't close dialog until API call completes
    }
    closeDlg();
  }

  async function reassignTicket(ticketId, assigneeId, note, expertName, logEl, actContainer) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${ticketId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          assignee_id: assigneeId,
          status: 'In Progress',
          comment: note
        })
      });

      const data = await response.json();

      if (data.success) {
        // Update local ticket data
        const t = tickets.find(x => x.id === ticketId);
        if (t) {
          t.assignee_id = assigneeId;
          t.assignee_name = expertName;
          t.status = 'In Progress';
        }

        // Update the assignee dropdown in the detail view
        document.getElementById('td-assignee').value = assigneeId;

        // Add activity log entry
        logEl.innerHTML = `<strong>${role==='admin'?'Admin':'Expert'}</strong>: Reassigned to ${expertName} â€” ${note}`;
        actContainer.appendChild(logEl);

        renderList();
        renderExpertDash();
        closeDlg();
      } else {
        const err = document.getElementById('dlg-error');
        err.textContent = 'Failed to reassign: ' + (data.message || 'Unknown error');
        err.style.display = 'block';
      }
    } catch (error) {
      console.error('Error reassigning ticket:', error);
      const err = document.getElementById('dlg-error');
      err.textContent = 'Error reassigning ticket. Please try again.';
      err.style.display = 'block';
    }
  }

  // ---- SLA updates on detail view ----
  function updateTicketSLA(){ const t=tickets.find(x=>x.id===currentTicketId); if(!t) return; const st=getSLAState(t); const badge=document.getElementById('td-sla-badge'); const prog=document.getElementById('td-sla-progress'); const text=document.getElementById('td-sla-text'); if(!badge || !prog || !text) return; badge.className='badge sla '+st.cls; badge.textContent=st.label; prog.style.width = st.pct + '%'; text.textContent = (t.sla && t.sla.paused?'Paused â€¢ ':'') + `Consumed ${st.pct}% of time to due date`; }

  // ---- Status transitions ----
  const TRANSITIONS = { 'Open': ['In Progress','Pending','Resolved'], 'In Progress': ['Pending','Resolved'], 'Pending': ['In Progress','Resolved'], 'Resolved': [] };
  function advanceStatus(){ const t=tickets.find(x=>x.id===currentTicketId); if(!t) return; const opts = TRANSITIONS[t.status] || []; if(!opts.length) return alert('No further transitions.'); const next = opts[0]; if(next==='Resolved') { openCompletion('resolve'); } else { setStatus(next); } }
  function setResolved(){ openCompletion('resolve'); }
  async function setStatus(newStatus, comment=null, silent=false){
    const t=tickets.find(x=>x.id===currentTicketId);
    if(!t) return;

    if(!(TRANSITIONS[t.status]||[]).includes(newStatus) && newStatus!=='Resolved') {
      alert(`Invalid transition from ${t.status} to ${newStatus}`);
      return;
    }

    const prev=t.status;

    // Call backend API to persist status change
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const requestBody = { status: newStatus };
      if (comment) {
        requestBody.comment = comment;
      }

      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}/${currentTicketId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      const data = await response.json();

      if (!data.success) {
        alert('Failed to update ticket status: ' + (data.message || 'Unknown error'));
        return;
      }

      // Update local ticket object
      t.status=newStatus;
      document.getElementById('td-status').value=newStatus;

      // Reload ticket details to get updated activities from server
      await renderTicketDetail();

      renderList();
      renderAdminDash();
      renderExpertDash();

    } catch (error) {
      console.error('Error updating ticket status:', error);
      alert('Failed to update ticket status. Please try again.');
    }
  }

  // SLA pause/resume
  function pauseSLA(){ const t=tickets.find(x=>x.id===currentTicketId); if(!t) return; if(t.sla.paused) return; t.sla.paused=true; t.sla.pausedAt=new Date().toISOString(); const act=document.getElementById('td-activity'); const div=document.createElement('div'); div.className='card p-12 mb-8'; div.innerHTML=`<strong>SLA Bot</strong>: SLA paused`; act.appendChild(div); updateTicketSLA(); }
  function resumeSLA(){ const t=tickets.find(x=>x.id===currentTicketId); if(!t) return; if(!t.sla.paused) return; const pausedDur = new Date().getTime() - new Date(t.sla.pausedAt).getTime(); const newStart = new Date(new Date(t.sla.startedAt).getTime() + pausedDur); t.sla.startedAt = newStart.toISOString(); t.sla.paused=false; t.sla.pausedAt=null; const act=document.getElementById('td-activity'); const div=document.createElement('div'); div.className='card p-12 mb-8'; div.innerHTML=`<strong>SLA Bot</strong>: SLA resumed`; act.appendChild(div); updateTicketSLA(); }

  // ---- Experts & Customers ----
  let allExperts = []; // Store all experts for searching
  let currentExpertId = null; // Store current expert for editing
  let currentTicket = null; // Store current ticket for operations
  let currentAISuggestions = null; // Store current AI suggestions

  // ---- AI Assistant Functions ----
  async function loadAISuggestions() {
    if (!currentTicketId) {
      alert('No ticket selected');
      return;
    }

    const panel = document.getElementById('ai-panel');
    const loading = document.getElementById('ai-loading');
    const content = document.getElementById('ai-content');

    // Show panel and loading state
    panel.style.display = 'block';
    loading.style.display = 'block';
    content.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/suggestions`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.suggestions) {
        currentAISuggestions = data.suggestions;
        renderAISuggestions(data.suggestions);
        loading.style.display = 'none';
        content.style.display = 'block';
      } else {
        throw new Error(data.error || 'Failed to get AI suggestions');
      }
    } catch (error) {
      console.error('Error loading AI suggestions:', error);
      loading.innerHTML = '<div style="color:#ffc">Error: ' + error.message + '</div>';
    }
  }

  function renderAISuggestions(suggestions) {
    // Analysis summary
    if (suggestions.analysis) {
      document.getElementById('ai-summary').textContent = suggestions.analysis.summary || '';

      const urgencyBadge = document.getElementById('ai-urgency');
      urgencyBadge.textContent = suggestions.analysis.urgency || 'unknown';
      urgencyBadge.style.background = getUrgencyColor(suggestions.analysis.urgency);

      document.getElementById('ai-complexity').textContent = 'Complexity: ' + (suggestions.analysis.complexity || 'unknown');
      document.getElementById('ai-time').textContent = 'Est: ' + (suggestions.analysis.estimatedTime || 'unknown');
    }

    // One-click actions
    const actionsDiv = document.getElementById('ai-actions');
    actionsDiv.innerHTML = '';
    if (suggestions.suggestedActions && suggestions.suggestedActions.length > 0) {
      suggestions.suggestedActions.forEach(action => {
        const btn = document.createElement('button');
        btn.className = 'btn ai-action';
        btn.innerHTML = action.label + '<span class="ai-action-confidence">' + action.confidence + '%</span>';
        btn.title = action.description;
        btn.onclick = () => executeAIAction(action);
        actionsDiv.appendChild(btn);
      });
    } else {
      actionsDiv.innerHTML = '<span style="opacity:0.7;font-size:13px">No suggested actions</span>';
    }

    // Draft response
    const draftSection = document.getElementById('ai-draft-section');
    if (suggestions.draftResponse) {
      draftSection.style.display = 'block';
      document.getElementById('ai-draft').value = suggestions.draftResponse;
    } else {
      draftSection.style.display = 'none';
    }

    // Next steps
    const stepsSection = document.getElementById('ai-steps-section');
    const stepsList = document.getElementById('ai-steps');
    if (suggestions.nextSteps && suggestions.nextSteps.length > 0) {
      stepsSection.style.display = 'block';
      stepsList.innerHTML = suggestions.nextSteps.map(s => '<li>' + s + '</li>').join('');
    } else {
      stepsSection.style.display = 'none';
    }

    // Warnings
    const warningsSection = document.getElementById('ai-warnings-section');
    if (suggestions.warnings && suggestions.warnings.length > 0) {
      warningsSection.style.display = 'block';
      document.getElementById('ai-warnings').innerHTML = suggestions.warnings.map(w => '<div>- ' + w + '</div>').join('');
    } else {
      warningsSection.style.display = 'none';
    }
  }

  function getUrgencyColor(urgency) {
    switch ((urgency || '').toLowerCase()) {
      case 'critical': return '#ef4444';
      case 'high': return '#f97316';
      case 'medium': return '#eab308';
      case 'low': return '#22c55e';
      default: return 'rgba(255,255,255,0.2)';
    }
  }

  async function executeAIAction(action) {
    if (!confirm('Execute action: ' + action.label + '?')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/tickets/${currentTicketId}/execute-action`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action })
      });

      const data = await response.json();

      if (data.success) {
        alert('Action executed successfully: ' + action.label);
        // Refresh ticket detail
        await renderTicketDetail();
        await loadTickets();
      } else {
        throw new Error(data.error || 'Failed to execute action');
      }
    } catch (error) {
      console.error('Error executing AI action:', error);
      alert('Error: ' + error.message);
    }
  }

  function useAIDraft() {
    const draft = document.getElementById('ai-draft').value;
    const noteInput = document.getElementById('td-note');
    if (noteInput) {
      noteInput.value = draft;
      hideAIPanel();
      noteInput.focus();
    }
  }

  function hideAIPanel() {
    document.getElementById('ai-panel').style.display = 'none';
  }

  // ---- AI Trends Dashboard Functions ----
  async function loadAITrends() {
    const loading = document.getElementById('ai-trends-loading');
    const content = document.getElementById('ai-trends-content');
    const period = document.getElementById('ai-trends-period').value;

    loading.style.display = 'block';
    content.style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      // Fetch insights data
      const response = await fetch(`${API_BASE}/api/ai/${tenantCode}/insights?period=${Math.floor(period/24)}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        renderAITrends(data.data, period);
      } else {
        // If insights API fails, analyze tickets locally
        await analyzeTicketTrends(period);
      }
    } catch (error) {
      console.error('Error loading AI trends:', error);
      // Fallback to local ticket analysis
      await analyzeTicketTrends(period);
    }

    loading.style.display = 'none';
    content.style.display = 'block';
  }

  async function analyzeTicketTrends(hours) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      // Fetch recent tickets
      const response = await fetch(`${API_BASE}/api/tickets/${tenantCode}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const tickets = await response.json();
      if (!Array.isArray(tickets)) return;

      // Filter by time period
      const cutoff = Date.now() - (hours * 60 * 60 * 1000);
      const recentTickets = tickets.filter(t => new Date(t.created_at).getTime() > cutoff);

      // Analyze patterns
      const analysis = analyzeTicketPatterns(recentTickets);
      renderLocalTrends(analysis, recentTickets.length);

    } catch (error) {
      console.error('Error analyzing tickets:', error);
      document.getElementById('ai-trends-list').innerHTML = '<div style="text-align:center;padding:20px;opacity:0.6">Unable to analyze trends</div>';
    }
  }

  function analyzeTicketPatterns(tickets) {
    const patterns = {
      byCategory: {},
      byPriority: { critical: 0, high: 0, medium: 0, low: 0 },
      byStatus: {},
      trends: []
    };

    // Categorize by keywords
    const keywordCategories = {
      'login|password|authentication|access': 'Authentication Issues',
      'slow|performance|timeout|lag': 'Performance Issues',
      'error|crash|bug|broken': 'System Errors',
      'email|mail|outlook': 'Email Problems',
      'network|connection|wifi|vpn': 'Network Issues',
      'sync|integration|api': 'Integration Issues',
      'report|data|export': 'Reporting Issues'
    };

    tickets.forEach(ticket => {
      const text = (ticket.title + ' ' + ticket.description).toLowerCase();

      // Count priorities
      if (ticket.priority) patterns.byPriority[ticket.priority]++;

      // Count statuses
      patterns.byStatus[ticket.status] = (patterns.byStatus[ticket.status] || 0) + 1;

      // Categorize by keywords
      for (const [regex, category] of Object.entries(keywordCategories)) {
        if (new RegExp(regex).test(text)) {
          patterns.byCategory[category] = (patterns.byCategory[category] || 0) + 1;
        }
      }
    });

    // Identify trends (categories with 2+ tickets)
    for (const [category, count] of Object.entries(patterns.byCategory)) {
      if (count >= 2) {
        patterns.trends.push({
          title: category,
          count: count,
          severity: count >= 5 ? 'critical' : count >= 3 ? 'warning' : 'info',
          description: `${count} tickets related to ${category.toLowerCase()}`
        });
      }
    }

    // Add priority-based trends
    if (patterns.byPriority.critical >= 2) {
      patterns.trends.unshift({
        title: 'Critical Priority Spike',
        count: patterns.byPriority.critical,
        severity: 'critical',
        description: `${patterns.byPriority.critical} critical priority tickets need immediate attention`
      });
    }

    return patterns;
  }

  function renderLocalTrends(analysis, totalCount) {
    document.getElementById('ai-trends-count').textContent = analysis.trends.length;
    document.getElementById('ai-critical-count').textContent = analysis.byPriority.critical || 0;
    document.getElementById('ai-warning-count').textContent = analysis.byPriority.high || 0;
    document.getElementById('ai-analyzed-count').textContent = totalCount;

    const listEl = document.getElementById('ai-trends-list');

    if (analysis.trends.length === 0) {
      listEl.innerHTML = '<div style="text-align:center;padding:30px;opacity:0.6"><div style="font-size:18px;margin-bottom:8px">No significant trends detected</div><div style="font-size:13px">Ticket volume is normal with no unusual patterns</div></div>';
      return;
    }

    listEl.innerHTML = analysis.trends.map(trend => `
      <div class="ai-trend-card ${trend.severity}">
        <div class="row space">
          <div>
            <div style="font-weight:600;font-size:15px">${trend.title}</div>
            <div style="font-size:13px;opacity:0.8;margin-top:4px">${trend.description}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:24px;font-weight:800">${trend.count}</div>
            <div style="font-size:11px;opacity:0.7">tickets</div>
          </div>
        </div>
      </div>
    `).join('');

    // Show category breakdown
    const categoryEl = document.getElementById('ai-category-breakdown');
    const categoriesEl = document.getElementById('ai-categories');

    if (Object.keys(analysis.byCategory).length > 0) {
      categoryEl.style.display = 'block';
      categoriesEl.innerHTML = Object.entries(analysis.byCategory)
        .sort((a, b) => b[1] - a[1])
        .map(([cat, count]) => `<span class="ai-category-badge">${cat} <strong>${count}</strong></span>`)
        .join('');
    }
  }

  function renderAITrends(data, period) {
    const { insights = [], ticketStats = {} } = data;

    document.getElementById('ai-trends-count').textContent = insights.length;
    document.getElementById('ai-critical-count').textContent = insights.filter(i => i.severity === 'critical').length;
    document.getElementById('ai-warning-count').textContent = insights.filter(i => i.severity === 'warning').length;
    document.getElementById('ai-analyzed-count').textContent = ticketStats.total || 0;

    const listEl = document.getElementById('ai-trends-list');

    if (insights.length === 0) {
      listEl.innerHTML = '<div style="text-align:center;padding:30px;opacity:0.6"><div style="font-size:18px;margin-bottom:8px">No active trends</div><div style="font-size:13px">All systems operating normally</div></div>';
      return;
    }

    listEl.innerHTML = insights.map(insight => `
      <div class="ai-trend-card ${insight.severity || 'info'}">
        <div class="row space">
          <div>
            <div style="font-weight:600;font-size:15px">${insight.title}</div>
            <div style="font-size:13px;opacity:0.8;margin-top:4px">${insight.description}</div>
            ${insight.affected_tickets ? `<div style="font-size:11px;margin-top:8px;opacity:0.6">${insight.affected_tickets.length} affected tickets</div>` : ''}
          </div>
          <div style="text-align:right">
            ${insight.metrics?.count ? `<div style="font-size:24px;font-weight:800">${insight.metrics.count}</div><div style="font-size:11px;opacity:0.7">occurrences</div>` : ''}
          </div>
        </div>
      </div>
    `).join('');
  }

  async function renderExperts(){
    const body=document.getElementById('experts-body');
    if(!body) return;
    body.innerHTML='<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.experts) {
        allExperts = data.experts;

        // Apply search filter
        const q=(document.getElementById('expert-search').value||'').toLowerCase();
        const filteredExperts = allExperts.filter(e=>
          !q ||
          (e.full_name||'').toLowerCase().includes(q) ||
          (e.username||'').toLowerCase().includes(q) ||
          (e.location||'').toLowerCase().includes(q) ||
          (e.postcode||'').toLowerCase().includes(q) ||
          (e.email||'').toLowerCase().includes(q)
        );

        // Render experts
        body.innerHTML='';
        if (filteredExperts.length === 0) {
          body.innerHTML='<tr><td colspan="7" style="text-align:center;">No experts found</td></tr>';
        } else {
          filteredExperts.forEach(e=>{
            const tr=document.createElement('tr');
            const lastLogin = e.last_login ? new Date(e.last_login).toLocaleString() : 'Never';
            const openTickets = e.open_tickets || 0;
            const ticketBadge = openTickets > 0
              ? `<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:12px;font-weight:600">${openTickets}</span>`
              : '<span style="color:#6b7280">0</span>';
            tr.innerHTML=`
              <td>${e.full_name || e.username}</td>
              <td>${e.username}</td>
              <td>${e.location || '-'}</td>
              <td>${e.email || '-'}</td>
              <td>${ticketBadge}</td>
              <td>${lastLogin}</td>
              <td>
                <button class="btn ghost" style="padding:4px 8px;font-size:12px" onclick="viewExpertDetail(${e.id})">View</button>
                <button class="btn ghost" style="padding:4px 8px;font-size:12px" onclick="showEditExpertForm(${e.id})">Edit</button>
                <button class="btn danger" style="padding:4px 8px;font-size:12px" onclick="deleteExpertPrompt(${e.id})">Delete</button>
              </td>
            `;
            body.appendChild(tr);
          });
        }
      } else {
        body.innerHTML='<tr><td colspan="7" style="text-align:center;color:red;">Failed to load experts</td></tr>';
      }
    } catch (error) {
      console.error('Error loading experts:', error);
      body.innerHTML='<tr><td colspan="7" style="text-align:center;color:red;">Error loading experts</td></tr>';
    }
  }

  // View expert detail
  async function viewExpertDetail(expertId) {
    currentExpertId = expertId;
    switchView('expert-detail');
  }

  // Render expert detail view
  async function renderExpertDetail() {
    if (!currentExpertId) {
      switchView('experts');
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/${currentExpertId}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.expert) {
        const e = data.expert;

        // Account Info
        document.getElementById('expert-role').textContent = (e.role || '').toUpperCase();
        document.getElementById('expert-username').textContent = e.username || '-';
        document.getElementById('expert-status').textContent = e.status || 'active';
        document.getElementById('expert-email-updates').textContent = e.email_updates !== false ? 'Enabled' : 'Disabled';
        document.getElementById('expert-reference').textContent = e.reference_code || '-';
        document.getElementById('expert-open-tickets').textContent = e.open_tickets || '0';

        // Account Statistics
        document.getElementById('expert-created-by').textContent = e.created_by || '-';
        document.getElementById('expert-updated-by').textContent = e.updated_by || '-';
        document.getElementById('expert-created-at').textContent = e.created_at ? new Date(e.created_at).toLocaleString() : '-';
        document.getElementById('expert-updated-at').textContent = e.updated_at ? new Date(e.updated_at).toLocaleString() : '-';
        document.getElementById('expert-last-login').textContent = e.last_login ? new Date(e.last_login).toLocaleString() : 'Never';

        // System Settings
        document.getElementById('expert-timezone').textContent = e.timezone || '-';
        document.getElementById('expert-language').textContent = e.language || '-';
        document.getElementById('expert-interface-lang').textContent = e.interface_language || '-';
        document.getElementById('expert-security-level').textContent = e.security_level || '-';

        // User Details
        document.getElementById('expert-first-name').textContent = e.first_name || '-';
        document.getElementById('expert-middle-name').textContent = e.middle_name || '-';
        document.getElementById('expert-last-name').textContent = e.last_name || '-';
        document.getElementById('expert-screen-name').textContent = e.screen_name || '-';
        document.getElementById('expert-street').textContent = e.street_address || '-';
        document.getElementById('expert-city').textContent = e.city || '-';
        document.getElementById('expert-state').textContent = e.state || '-';
        document.getElementById('expert-postcode').textContent = e.postcode || '-';
        document.getElementById('expert-country').textContent = e.country || '-';
        document.getElementById('expert-contact').textContent = e.contact_number || e.phone || '-';
        document.getElementById('expert-location').textContent = e.location || '-';
        document.getElementById('expert-department').textContent = e.department || '-';
        document.getElementById('expert-email').textContent = e.email || '-';
      } else {

        // Load expert permissions
        await loadExpertPermissions();
        alert('Failed to load expert details');
        switchView('experts');
      }
    } catch (error) {
      console.error('Error loading expert details:', error);
      alert('Error loading expert details');
      switchView('experts');
    }
  }

  // Show create expert form
  function showCreateExpertForm() {
    currentExpertId = null;
    document.getElementById('expert-modal-title').textContent = 'Add Expert';
    document.getElementById('expert-form-password-row').style.display = 'block';
    clearExpertForm();
    document.getElementById('expert-modal').style.display = 'flex';
  }

  // Show edit expert form
  async function showEditExpertForm(expertId) {
    currentExpertId = expertId;
    document.getElementById('expert-modal-title').textContent = 'Edit Expert';
    document.getElementById('expert-form-password-row').style.display = 'none';

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/${expertId}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.expert) {
        const e = data.expert;
        document.getElementById('expert-form-username').value = e.username || '';
        document.getElementById('expert-form-email').value = e.email || '';
        document.getElementById('expert-form-role').value = e.role || 'expert';
        document.getElementById('expert-form-status').value = e.is_active === false ? 'inactive' : 'active';
        document.getElementById('expert-form-rating').value = e.rating || '';
        document.getElementById('expert-form-reference').value = e.reference_code || '';
        document.getElementById('expert-form-email-updates').checked = e.email_updates !== false;
        document.getElementById('expert-form-fullname').value = e.full_name || '';
        document.getElementById('expert-form-firstname').value = e.first_name || '';
        document.getElementById('expert-form-middlename').value = e.middle_name || '';
        document.getElementById('expert-form-lastname').value = e.last_name || '';
        document.getElementById('expert-form-screenname').value = e.screen_name || '';
        document.getElementById('expert-form-phone').value = e.phone || '';
        document.getElementById('expert-form-department').value = e.department || '';
        document.getElementById('expert-form-location').value = e.location || '';
        document.getElementById('expert-form-street').value = e.street_address || '';
        document.getElementById('expert-form-city').value = e.city || '';
        document.getElementById('expert-form-state').value = e.state || '';
        document.getElementById('expert-form-postcode').value = e.postcode || '';
        document.getElementById('expert-form-country').value = e.country || '';
        document.getElementById('expert-form-timezone').value = e.timezone || '';
        document.getElementById('expert-form-language').value = e.language || '';
        document.getElementById('expert-form-interface-lang').value = e.interface_language || '';
        document.getElementById('expert-form-security-level').value = e.security_level || '';

        document.getElementById('expert-modal').style.display = 'flex';
      } else {
        alert('Failed to load expert data');
      }
    } catch (error) {
      console.error('Error loading expert:', error);
      alert('Error loading expert data');
    }
  }

  // Wrapper for edit from detail view
  function editExpert() {
    if (currentExpertId) {
      showEditExpertForm(currentExpertId);
    }
  }

  // Clear expert form
  function clearExpertForm() {
    document.getElementById('expert-form-username').value = '';
    document.getElementById('expert-form-email').value = '';
    document.getElementById('expert-form-password').value = '';
    document.getElementById('expert-form-role').value = 'expert';
    document.getElementById('expert-form-status').value = 'active';
    document.getElementById('expert-form-rating').value = '';
    document.getElementById('expert-form-reference').value = '';
    document.getElementById('expert-form-email-updates').checked = true;
    document.getElementById('expert-form-fullname').value = '';
    document.getElementById('expert-form-firstname').value = '';
    document.getElementById('expert-form-middlename').value = '';
    document.getElementById('expert-form-lastname').value = '';
    document.getElementById('expert-form-screenname').value = '';
    document.getElementById('expert-form-phone').value = '';
    document.getElementById('expert-form-department').value = '';
    document.getElementById('expert-form-location').value = '';
    document.getElementById('expert-form-street').value = '';
    document.getElementById('expert-form-city').value = '';
    document.getElementById('expert-form-state').value = '';
    document.getElementById('expert-form-postcode').value = '';
    document.getElementById('expert-form-country').value = '';
    document.getElementById('expert-form-timezone').value = '';
    document.getElementById('expert-form-language').value = '';
    document.getElementById('expert-form-interface-lang').value = '';
    document.getElementById('expert-form-security-level').value = '';
    document.getElementById('expert-form-error').style.display = 'none';
    document.getElementById('expert-form-error').textContent = '';
  }

  // Close expert modal
  function closeExpertModal() {
    document.getElementById('expert-modal').style.display = 'none';
    clearExpertForm();
  }

  // Save expert (create or update)
  async function saveExpert() {
    const username = document.getElementById('expert-form-username').value.trim();
    const email = document.getElementById('expert-form-email').value.trim();
    const password = document.getElementById('expert-form-password').value.trim();
    const role = document.getElementById('expert-form-role').value;

    // Validation
    if (!username || !email || !role) {
      document.getElementById('expert-form-error').textContent = 'Username, email, and role are required';
      document.getElementById('expert-form-error').style.display = 'block';
      return;
    }

    if (!currentExpertId && !password) {
      document.getElementById('expert-form-error').textContent = 'Password is required for new experts';
      document.getElementById('expert-form-error').style.display = 'block';
      return;
    }

    const expertData = {
      username,
      email,
      role,
      status: document.getElementById('expert-form-status').value,
      rating: parseInt(document.getElementById('expert-form-rating').value) || 0,
      reference_code: document.getElementById('expert-form-reference').value.trim(),
      email_updates: document.getElementById('expert-form-email-updates').checked,
      full_name: document.getElementById('expert-form-fullname').value.trim(),
      first_name: document.getElementById('expert-form-firstname').value.trim(),
      middle_name: document.getElementById('expert-form-middlename').value.trim(),
      last_name: document.getElementById('expert-form-lastname').value.trim(),
      screen_name: document.getElementById('expert-form-screenname').value.trim(),
      phone: document.getElementById('expert-form-phone').value.trim(),
      department: document.getElementById('expert-form-department').value.trim(),
      location: document.getElementById('expert-form-location').value.trim(),
      street_address: document.getElementById('expert-form-street').value.trim(),
      city: document.getElementById('expert-form-city').value.trim(),
      state: document.getElementById('expert-form-state').value.trim(),
      postcode: document.getElementById('expert-form-postcode').value.trim(),
      country: document.getElementById('expert-form-country').value.trim(),
      timezone: document.getElementById('expert-form-timezone').value.trim(),
      language: document.getElementById('expert-form-language').value.trim(),
      interface_language: document.getElementById('expert-form-interface-lang').value.trim(),
      security_level: document.getElementById('expert-form-security-level').value.trim()
    };

    if (!currentExpertId) {
      expertData.password = password;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const url = currentExpertId
        ? `${API_BASE}/api/experts/${tenantCode}/${currentExpertId}`
        : `${API_BASE}/api/experts/${tenantCode}`;
      const method = currentExpertId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(expertData)
      });

      const data = await response.json();

      if (data.success) {
        closeExpertModal();
        renderExperts();
        alert(currentExpertId ? 'Expert updated successfully' : 'Expert created successfully');
      } else {
        document.getElementById('expert-form-error').textContent = data.message || 'Failed to save expert';
        document.getElementById('expert-form-error').style.display = 'block';
      }
    } catch (error) {
      console.error('Error saving expert:', error);
      document.getElementById('expert-form-error').textContent = 'Error saving expert';
      document.getElementById('expert-form-error').style.display = 'block';
    }
  }

  // Delete expert prompt
  async function deleteExpertPrompt(expertId) {
    const expert = expertId ? allExperts.find(e => e.id === expertId) : allExperts.find(e => e.id === currentExpertId);
    if (!expert) return;

    if (!confirm(`Are you sure you want to delete expert "${expert.full_name || expert.username}"? This action cannot be undone.`)) {
      return;
    }

    const idToDelete = expertId || currentExpertId;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      const response = await fetch(`${API_BASE}/api/experts/${tenantCode}/${idToDelete}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        alert('Expert deleted successfully');
        if (currentView === 'expert-detail') {
          switchView('experts');
        } else {
          renderExperts();
        }
      } else {
        alert('Failed to delete expert: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error deleting expert:', error);
      alert('Error deleting expert');
    }
  }

  // Customer Management Functions

  // ========================================
  // EXPERT TICKET PERMISSIONS FUNCTIONS
  // ========================================


  // Show expert permissions modal
  async function showExpertPermissionsModal() {
    console.log('ğŸš€ showExpertPermissionsModal() called');
    console.log('  â†’ currentExpertId:', currentExpertId);

    if (!currentExpertId) {
      alert('No expert selected');
      return;
    }

    document.getElementById('expert-permissions-modal').style.display = 'block';
    console.log('  â†’ Modal opened');

    console.log('  â†’ Loading expert permissions...');
    await loadExpertPermissions();

    console.log('  â†’ Loading available customers...');
    await loadAvailableCustomers();

    console.log('  âœ… Modal fully initialized');
  }

  // Close expert permissions modal
  function closeExpertPermissionsModal() {
    document.getElementById('expert-permissions-modal').style.display = 'none';
    // Reset form
    document.getElementById('perm-type').value = '';
    document.getElementById('perm-customer').value = '';
    document.getElementById('perm-pattern').value = '';
    updatePermissionForm();
    hideMessage('perm-form-message');
    hideMessage('perm-form-error');
  }

  // Load expert permissions
  async function loadExpertPermissions() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`/api/expert-permissions/${tenantCode}/${currentExpertId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        renderPermissionsList(data.permissions);
        renderPermissionsOnDetailPage(data.permissions);
      } else {
        renderPermissionsList([]);
      }
    } catch (error) {
      console.error('Error loading expert permissions:', error);
      document.getElementById('current-permissions-list').innerHTML =
        '<div class="subtitle" style="color:#b91c1c">Failed to load permissions</div>';
    }
  }

  // Render permissions list in modal
  function renderPermissionsList(permissions) {
    const container = document.getElementById('current-permissions-list');

    if (!permissions || permissions.length === 0) {
      container.innerHTML = '<div class="subtitle" style="color:#999">No permissions configured</div>';
      return;
    }

    let html = '<div style="display:flex;flex-direction:column;gap:8px">';

    permissions.forEach(perm => {
      let permText = '';
      let permIcon = '';

      if (perm.permission_type === 'all_tickets') {
        permIcon = 'ğŸŒ';
        permText = 'All Tickets';
      } else if (perm.permission_type === 'specific_customers') {
        permIcon = 'ğŸ‘¤';
        permText = `Customer: ${perm.customer_name || perm.customer_username || 'Unknown'}`;
        if (perm.company_name) {
          permText += ` (${perm.company_name})`;
        }
      } else if (perm.permission_type === 'title_patterns') {
        permIcon = 'ğŸ”';
        permText = `Title contains: "${perm.title_pattern}"`;
      }

      html += `
        <div class="row space" style="padding:8px;background:white;border-radius:4px;border:1px solid #e5e7eb">
          <div class="row" style="gap:8px">
            <span style="font-size:18px">${permIcon}</span>
            <span>${permText}</span>
          </div>
          <button class="btn ghost small" onclick="deleteExpertPermission(${perm.id})">Remove</button>
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  // Render permissions on expert detail page
  function renderPermissionsOnDetailPage(permissions) {
    const container = document.getElementById('expert-permissions-list');

    if (!permissions || permissions.length === 0) {
      container.innerHTML = '<div class="subtitle" style="color:#999">No permissions configured. Click "Manage Permissions" to add.</div>';
      return;
    }

    let html = '<div style="display:flex;flex-direction:column;gap:6px">';

    permissions.forEach(perm => {
      let permText = '';
      let permIcon = '';

      if (perm.permission_type === 'all_tickets') {
        permIcon = 'ğŸŒ';
        permText = '<strong>All Tickets</strong> - Can view and work on all tickets';
      } else if (perm.permission_type === 'specific_customers') {
        permIcon = 'ğŸ‘¤';
        permText = `Customer: <strong>${perm.customer_name || perm.customer_username}</strong>`;
        if (perm.company_name) {
          permText += ` (${perm.company_name})`;
        }
      } else if (perm.permission_type === 'title_patterns') {
        permIcon = 'ğŸ”';
        permText = `Tickets with title containing: <strong>"${perm.title_pattern}"</strong>`;
      }

      html += `
        <div class="row" style="gap:8px;padding:4px 0">
          <span style="font-size:16px">${permIcon}</span>
          <span class="subtitle">${permText}</span>
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  // Load available customers for dropdown
  async function loadAvailableCustomers() {
    console.log('ğŸ” loadAvailableCustomers() called');
    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';
      console.log('  â†’ tenantCode:', tenantCode);

      const response = await fetch(`/api/expert-permissions/${tenantCode}/customers/available`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();
      console.log('  â†’ API response:', data);

      if (data.success) {
        const select = document.getElementById('perm-customer');
        console.log('  â†’ Customer dropdown element:', select ? 'FOUND' : 'NOT FOUND');

        select.innerHTML = '<option value="">Select customer...</option>';

        data.customers.forEach(customer => {
          const displayName = customer.full_name || customer.username;
          const companyInfo = customer.company_name ? ` (${customer.company_name})` : '';
          select.innerHTML += `<option value="${customer.id}">${displayName}${companyInfo}</option>`;
        });

        console.log('  âœ… Loaded', data.customers.length, 'customers into dropdown');
        console.log('  â†’ Dropdown now has', select.options.length, 'total options');
      } else {
        console.error('  âŒ API returned success=false:', data);
      }
    } catch (error) {
      console.error('âŒ Error loading customers:', error);
    }
  }

  // Update permission form based on selected type
  function updatePermissionForm() {
    console.log('ğŸ”„ updatePermissionForm() called');
    const permType = document.getElementById('perm-type').value;
    console.log('  â†’ Permission type selected:', permType);

    const customerSection = document.getElementById('perm-customer-section');
    const patternSection = document.getElementById('perm-pattern-section');

    console.log('  â†’ Customer section element:', customerSection ? 'FOUND' : 'NOT FOUND');
    console.log('  â†’ Pattern section element:', patternSection ? 'FOUND' : 'NOT FOUND');

    customerSection.style.display = permType === 'specific_customers' ? 'block' : 'none';
    patternSection.style.display = permType === 'title_patterns' ? 'block' : 'none';

    console.log('  â†’ Customer section display:', customerSection.style.display);
    console.log('  â†’ Pattern section display:', patternSection.style.display);

    if (permType === 'specific_customers') {
      const select = document.getElementById('perm-customer');
      console.log('  â†’ Customer dropdown has', select ? select.options.length : 0, 'options');
    }

    // Clear validation messages
    hideMessage('perm-form-message');
    hideMessage('perm-form-error');
  }

  // Add expert permission
  async function addExpertPermission() {
    const permType = document.getElementById('perm-type').value;
    const customerId = document.getElementById('perm-customer').value;
    const pattern = document.getElementById('perm-pattern').value;

    // Validation
    if (!permType) {
      showMessage('perm-form-error', 'Please select a permission type');
      return;
    }

    if (permType === 'specific_customers' && !customerId) {
      showMessage('perm-form-error', 'Please select a customer');
      return;
    }

    if (permType === 'title_patterns' && !pattern.trim()) {
      showMessage('perm-form-error', 'Please enter a title pattern');
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`/api/expert-permissions/${tenantCode}/${currentExpertId}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          permission_type: permType,
          customer_id: permType === 'specific_customers' ? parseInt(customerId) : null,
          title_pattern: permType === 'title_patterns' ? pattern.trim() : null
        })
      });

      const data = await response.json();

      if (data.success) {
        showMessage('perm-form-message', 'Permission added successfully');
        // Reset form
        document.getElementById('perm-type').value = '';
        document.getElementById('perm-customer').value = '';
        document.getElementById('perm-pattern').value = '';
        updatePermissionForm();
        // Reload permissions
        await loadExpertPermissions();

        // Hide success message after 2 seconds
        setTimeout(() => hideMessage('perm-form-message'), 2000);
      } else {
        showMessage('perm-form-error', data.error || 'Failed to add permission');
      }
    } catch (error) {
      console.error('Error adding permission:', error);
      showMessage('perm-form-error', 'Error adding permission');
    }
  }

  // Delete expert permission
  async function deleteExpertPermission(permissionId) {
    if (!confirm('Remove this permission?')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`/api/expert-permissions/${tenantCode}/${permissionId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        await loadExpertPermissions();
      } else {
        alert('Failed to remove permission: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error deleting permission:', error);
      alert('Error deleting permission');
    }
  }

  // Self-assign ticket
  async function selfAssignTicket() {
    const ticketId = currentTicket.id;

    if (!confirm('Assign this ticket to yourself?')) return;

    try {
      const token = localStorage.getItem('token');
      const tenantCode = localStorage.getItem('tenantCode') || 'apoyar';

      const response = await fetch(`/api/tickets/${tenantCode}/${ticketId}/self-assign`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await response.json();

      if (data.success) {
        alert(data.message);
        await showTicketDetail(ticketId);
        await loadTickets();
      } else {
        alert('Failed to self-assign: ' + (data.message || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error self-assigning ticket:', error);
      alert('Error self-assigning ticket');
    }
  }

  // Helper functions
  function showMessage(elementId, message) {
    const el = document.getElementById(elementId);
    if (el) {
      el.textContent = message;
      el.style.display = 'block';
    }
  }

  function hideMessage(elementId) {
    const el = document.getElementById(elementId);
    if (el) {
      el.style.display = 'none';
    }
  }

  // Format date and time - returns "DD MMM HH:mm" format
  function formatDateTime(dateString) {
    if (!dateString) return 'â€”';

    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'â€”';

      const day = date.getDate();
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const month = months[date.getMonth()];
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');

      return `${day} ${month} ${hours}:${minutes}`;
    } catch (error) {
      return 'â€”';
    }
  }

  let allCustomers = [];
  let allCustomerCompanies = [];
  let customerSortField = 'name';
  let customerSortAsc = true;

  // Load customer companies for filter dropdown
  async function loadCustomerCompanies() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customer-companies`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      const data = await response.json();
      if (data.success && data.companies) {
        allCustomerCompanies = data.companies;
        populateCustomerCompanyFilter();
      }
    } catch (error) {
      console.error('Error loading customer companies:', error);
    }
  }

  // Populate customer company filter dropdown
  function populateCustomerCompanyFilter() {
    const companyFilter = document.getElementById('cust-filter-company');
    if (!companyFilter) return;

    const currentValue = companyFilter.value;
    companyFilter.innerHTML = '<option value="">All Companies</option>';

    allCustomerCompanies.forEach(company => {
      const option = document.createElement('option');
      option.value = company.id;
      option.textContent = `${company.company_name} (${company.team_member_count || 0})`;
      companyFilter.appendChild(option);
    });

    companyFilter.value = currentValue;
  }

  // Clear customer filters
  function clearCustomerFilters() {
    const searchEl = document.getElementById('cust-search');
    const companyEl = document.getElementById('cust-filter-company');
    const slaEl = document.getElementById('cust-filter-sla');
    const statusEl = document.getElementById('cust-filter-status');

    if (searchEl) searchEl.value = '';
    if (companyEl) companyEl.value = '';
    if (slaEl) slaEl.value = '';
    if (statusEl) statusEl.value = '';

    saveFilterSettings('customers');
    renderCustomers();
  }

  async function renderCustomers(){
    const body=document.getElementById('customers-body');
    if(!body) return;
    body.innerHTML='<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>';

    // Load companies if not loaded
    if (allCustomerCompanies.length === 0) {
      await loadCustomerCompanies();
    }

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customers`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.customers) {
        // Update local customers array
        allCustomers = data.customers;
        customers = data.customers.map(c => ({
          id: c.id,
          name: c.full_name || c.username,
          contact: c.email,
          company: c.company_name || c.full_name || c.username
        }));

        // Get filter values
        const searchQ = (document.getElementById('cust-search')?.value || '').toLowerCase();
        const companyFilter = document.getElementById('cust-filter-company')?.value || '';
        const slaFilter = document.getElementById('cust-filter-sla')?.value || '';
        const statusFilter = document.getElementById('cust-filter-status')?.value || '';

        // Apply filters
        const filteredCustomers = allCustomers.filter(c => {
          // Search filter
          if (searchQ) {
            const name = (c.full_name || c.username || '').toLowerCase();
            const email = (c.email || '').toLowerCase();
            const company = (c.company_name || '').toLowerCase();
            const domain = (c.company_domain || '').toLowerCase();
            if (!name.includes(searchQ) && !email.includes(searchQ) && !company.includes(searchQ) && !domain.includes(searchQ)) {
              return false;
            }
          }

          // Company filter
          if (companyFilter && c.customer_company_id != companyFilter) {
            return false;
          }

          // SLA filter
          if (slaFilter && c.sla_level !== slaFilter) {
            return false;
          }

          // Status filter
          if (statusFilter === 'active' && c.is_active === false) {
            return false;
          }
          if (statusFilter === 'inactive' && c.is_active !== false) {
            return false;
          }

          return true;
        });

        // Apply sorting
        filteredCustomers.sort((a, b) => {
          let valA, valB;
          if (customerSortField === 'name') {
            valA = (a.full_name || a.username || '').toLowerCase();
            valB = (b.full_name || b.username || '').toLowerCase();
          } else if (customerSortField === 'tickets') {
            valA = a.open_ticket_count || 0;
            valB = b.open_ticket_count || 0;
          }
          if (valA < valB) return customerSortAsc ? -1 : 1;
          if (valA > valB) return customerSortAsc ? 1 : -1;
          return 0;
        });

        // Update count
        const countDiv = document.getElementById('customer-count');
        if (countDiv) {
          countDiv.textContent = `Showing ${filteredCustomers.length} of ${allCustomers.length} customers`;
        }

        // Render customers
        body.innerHTML='';
        if (filteredCustomers.length === 0) {
          body.innerHTML='<tr><td colspan="7" style="text-align:center;">No customers found</td></tr>';
        } else {
          filteredCustomers.forEach(c=>{
            const tr=document.createElement('tr');
            const slaColor = c.sla_level === 'enterprise' ? '#16a34a' : c.sla_level === 'premium' ? '#2563eb' : '#6b7280';
            const isActive = c.is_active !== false;
            const statusStyle = isActive ? '' : 'opacity:0.5;text-decoration:line-through';
            const roleLabel = c.is_company_admin ? 'ğŸ‘‘ Admin' : (c.job_title || 'Team Member');
            const ticketCount = c.open_ticket_count || 0;
            const ticketStyle = ticketCount > 0 ? 'color:#2563eb;font-weight:600;cursor:pointer' : 'color:#6b7280';
            tr.innerHTML=`
              <td style="${statusStyle}">${c.full_name || c.username}</td>
              <td style="${statusStyle}">${c.email || '-'}</td>
              <td style="${statusStyle}">${c.company_name || '-'}</td>
              <td style="${statusStyle};font-size:13px">${roleLabel}</td>
              <td style="${statusStyle};${ticketStyle}" ${ticketCount > 0 ? `onclick="viewCustomerTickets(${c.id}, '${(c.full_name || c.username).replace(/'/g, "\\'")}')"` : ''}>${ticketCount}</td>
              <td style="${statusStyle};color:${slaColor};font-weight:600;text-transform:capitalize">${c.sla_level || 'basic'}</td>
              <td>
                <button class="btn ghost" onclick="editCustomer(${c.id})" style="padding:4px 8px;font-size:13px" ${!isActive ? 'disabled' : ''}>Edit</button>
                ${isActive
                  ? `<button class="btn ghost" onclick="deleteCustomer(${c.id})" style="padding:4px 8px;font-size:13px;color:#b91c1c">Delete</button>`
                  : `<button class="btn ghost" onclick="reactivateCustomer(${c.id})" style="padding:4px 8px;font-size:13px;color:#16a34a">Reactivate</button>`
                }
              </td>
            `;
            body.appendChild(tr);
          });
        }
      } else {
        body.innerHTML='<tr><td colspan="7" style="text-align:center;color:red;">Failed to load customers</td></tr>';
      }
    } catch (error) {
      console.error('Error loading customers:', error);
      body.innerHTML='<tr><td colspan="7" style="text-align:center;color:red;">Error loading customers</td></tr>';
    }
  }

  // Sort customers by field
  function sortCustomersBy(field) {
    if (customerSortField === field) {
      customerSortAsc = !customerSortAsc;
    } else {
      customerSortField = field;
      customerSortAsc = true;
    }
    renderCustomers();
  }

  // View tickets for a specific customer
  function viewCustomerTickets(customerId, customerName) {
    // Switch to tickets view and set the customer filter
    switchView('tickets');
    // Wait for tickets to load then set filter
    setTimeout(() => {
      const customerFilter = document.getElementById('ticket-filter-customer');
      if (customerFilter) {
        customerFilter.value = customerId;
        renderList();
      }
    }, 500);
  }

  function showCreateCustomerForm() {
    document.getElementById('customer-modal-title').textContent = 'Add Team Member';
    document.getElementById('customer-save-btn-text').textContent = 'Create Team Member';
    document.getElementById('customer-form').reset();
    document.getElementById('customer-id').value = '';
    document.getElementById('customer-username').disabled = false;
    document.getElementById('customer-form-message').style.display = 'none';
    document.getElementById('customer-form-error').style.display = 'none';
    document.getElementById('customer-modal').style.display = 'block';
  }

  async function editCustomer(customerId) {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customers/${customerId}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success && data.customer) {
        const c = data.customer;
        document.getElementById('customer-modal-title').textContent = 'Edit Customer';
        document.getElementById('customer-save-btn-text').textContent = 'Update Customer';
        document.getElementById('customer-id').value = c.id;
        document.getElementById('customer-username').value = c.username || '';
        document.getElementById('customer-username').disabled = true; // Cannot change username
        document.getElementById('customer-email').value = c.email || '';
        document.getElementById('customer-fullname').value = c.full_name || '';
        document.getElementById('customer-company').value = c.company_name || '';
        document.getElementById('customer-domain').value = c.company_domain || '';
        document.getElementById('customer-phone').value = c.contact_phone || '';
        document.getElementById('customer-address').value = c.address || '';
        document.getElementById('customer-sla').value = c.sla_level || 'basic';
        document.getElementById('customer-form-message').style.display = 'none';
        document.getElementById('customer-form-error').style.display = 'none';
        document.getElementById('customer-modal').style.display = 'block';
      } else {
        alert('Failed to load customer details');
      }
    } catch (error) {
      console.error('Error loading customer:', error);
      alert('Error loading customer details');
    }
  }

  function closeCustomerModal() {
    document.getElementById('customer-modal').style.display = 'none';
    document.getElementById('customer-form').reset();
  }

  // Customer Company functions
  function showCreateCustomerCompanyForm() {
    document.getElementById('company-modal-title').textContent = 'Add Customer Company';
    document.getElementById('company-save-btn-text').textContent = 'Create Company';
    document.getElementById('company-form').reset();
    document.getElementById('company-id').value = '';
    document.getElementById('company-form-message').style.display = 'none';
    document.getElementById('company-form-error').style.display = 'none';
    document.getElementById('company-modal').style.display = 'block';
  }

  function closeCompanyModal() {
    document.getElementById('company-modal').style.display = 'none';
    document.getElementById('company-form').reset();
  }

  async function saveCustomerCompany(event) {
    event.preventDefault();

    const companyId = document.getElementById('company-id').value;
    const companyData = {
      company_name: document.getElementById('company-name').value,
      company_domain: document.getElementById('company-domain').value,
      contact_phone: document.getElementById('company-phone').value,
      address: document.getElementById('company-address').value,
      sla_level: document.getElementById('company-sla').value,
      notes: document.getElementById('company-notes').value
    };

    try {
      const token = localStorage.getItem('token');
      const url = companyId
        ? `${API_BASE}/api/customer-companies/${companyId}`
        : `${API_BASE}/api/customer-companies`;
      const method = companyId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(companyData)
      });

      const data = await response.json();

      if (data.success) {
        const msgEl = document.getElementById('company-form-message');
        const errEl = document.getElementById('company-form-error');
        errEl.style.display = 'none';

        if (data.admin) {
          msgEl.innerHTML = `Company created! Admin credentials:<br><strong>Username:</strong> ${data.admin.username}<br><strong>Email:</strong> ${data.admin.email}<br><strong>Temp Password:</strong> ${data.admin.tempPassword}`;
        } else {
          msgEl.textContent = companyId ? 'Company updated successfully!' : 'Company created successfully!';
        }
        msgEl.style.display = 'block';

        // Reload customer companies list
        allCustomerCompanies = [];
        await loadCustomerCompanies();

        // Close modal after a delay if just updating
        if (companyId) {
          setTimeout(() => {
            closeCompanyModal();
            renderCustomers();
          }, 1500);
        }
      } else {
        const errEl = document.getElementById('company-form-error');
        errEl.textContent = data.message || 'Failed to save company';
        errEl.style.display = 'block';
      }
    } catch (error) {
      console.error('Error saving company:', error);
      const errEl = document.getElementById('company-form-error');
      errEl.textContent = 'Error saving company';
      errEl.style.display = 'block';
    }
  }

  async function saveCustomer(event) {
    event.preventDefault();

    const customerId = document.getElementById('customer-id').value;
    const isEdit = !!customerId;

    const customerData = {
      username: document.getElementById('customer-username').value,
      email: document.getElementById('customer-email').value,
      full_name: document.getElementById('customer-fullname').value,
      company_name: document.getElementById('customer-company').value,
      company_domain: document.getElementById('customer-domain').value.toLowerCase(),
      contact_phone: document.getElementById('customer-phone').value,
      address: document.getElementById('customer-address').value,
      sla_level: document.getElementById('customer-sla').value
    };

    try {
      const token = localStorage.getItem('token');
      const url = isEdit
        ? `${API_BASE}/api/customers/${customerId}`
        : `${API_BASE}/api/customers`;
      const method = isEdit ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(customerData)
      });

      const data = await response.json();

      if (data.success) {
        const msg = isEdit ? 'Customer updated successfully!' : `Customer created successfully! Temporary password: ${data.tempPassword}`;
        document.getElementById('customer-form-message').textContent = msg;
        document.getElementById('customer-form-message').style.display = 'block';
        document.getElementById('customer-form-error').style.display = 'none';

        // If creating new customer, show temp password for a few seconds
        if (!isEdit) {
          setTimeout(() => {
            closeCustomerModal();
            renderCustomers();
            alert(`Customer created!\n\nUsername: ${customerData.username}\nTemporary Password: ${data.tempPassword}\n\nPlease share this password with the customer.`);
          }, 2000);
        } else {
          setTimeout(() => {
            closeCustomerModal();
            renderCustomers();
          }, 1500);
        }
      } else {
        document.getElementById('customer-form-error').textContent = data.message || 'Failed to save customer';
        document.getElementById('customer-form-error').style.display = 'block';
        document.getElementById('customer-form-message').style.display = 'none';
      }
    } catch (error) {
      console.error('Error saving customer:', error);
      document.getElementById('customer-form-error').textContent = 'Error saving customer';
      document.getElementById('customer-form-error').style.display = 'block';
      document.getElementById('customer-form-message').style.display = 'none';
    }
  }

  async function deleteCustomer(customerId) {
    const customer = allCustomers.find(c => c.id === customerId);
    if (!customer) return;

    const confirmMsg = `Are you sure you want to deactivate customer "${customer.full_name || customer.username}"?\n\nCompany: ${customer.company_name || 'N/A'}\nDomain: ${customer.company_domain || 'N/A'}\n\nThis will prevent them from logging in, but their data will be preserved.`;

    if (!confirm(confirmMsg)) {
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customers/${customerId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        alert('Customer deactivated successfully');
        renderCustomers();
      } else {
        alert(data.message || 'Failed to deactivate customer');
      }
    } catch (error) {
      console.error('Error deleting customer:', error);
      alert('Error deactivating customer');
    }
  }

  async function reactivateCustomer(customerId) {
    const customer = allCustomers.find(c => c.id === customerId);
    if (!customer) return;

    if (!confirm(`Reactivate customer "${customer.full_name || customer.username}"?`)) {
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_BASE}/api/customers/${customerId}/reactivate`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        alert('Customer reactivated successfully');
        renderCustomers();
      } else {
        alert(data.message || 'Failed to reactivate customer');
      }
    } catch (error) {
      console.error('Error reactivating customer:', error);
      alert('Error reactivating customer');
    }
  }

  // ---- My Profile ----
  async function loadProfile(){ 
    try{ 
      const token=localStorage.getItem('token'); 
      if(!token){ alert('Session expired'); window.location.reload(); return; } 
      const res=await fetch(`${API_BASE}/api/auth/profile`,{headers:{'Authorization':`Bearer ${token}`}}); 
      const data=await res.json(); 
      if(!data.success){ alert('Failed to load profile: '+data.message); return; } 
      const profile=data.profile; 
      document.getElementById('profile-username').value=profile.username||''; 
      document.getElementById('profile-role').value=profile.role||''; 
      document.getElementById('profile-fullname').value=profile.full_name||''; 
      document.getElementById('profile-email').value=profile.email||''; 
      document.getElementById('profile-phone').value=profile.phone||''; 
      document.getElementById('profile-department').value=profile.department||''; 
      document.getElementById('profile-created').value=profile.created_at?new Date(profile.created_at).toLocaleString():''; 
      document.getElementById('profile-updated').value=profile.updated_at?new Date(profile.updated_at).toLocaleString():''; 
    }catch(err){ alert('Error loading profile: '+err.message); } 
  }
  async function saveProfile(){ 
    try{ 
      const token=localStorage.getItem('token'); 
      if(!token){ alert('Session expired'); window.location.reload(); return; } 
      const profileData={ full_name:document.getElementById('profile-fullname').value, email:document.getElementById('profile-email').value, phone:document.getElementById('profile-phone').value, department:document.getElementById('profile-department').value }; 
      const res=await fetch(`${API_BASE}/api/auth/profile`,{method:'PUT',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify(profileData)}); 
      const data=await res.json(); 
      if(!data.success){ alert('Failed to update profile: '+data.message); return; } 
      alert('Profile updated successfully!'); 
      await loadProfile(); 
    }catch(err){ alert('Error updating profile: '+err.message); } 
  }

  // ---- CMDB ----
  function renderCMDB(){ if(CMDB_ITEMS.length===0){loadCMDBItemsFromAPI();return;} const sel=document.getElementById('cmdb-customer'); const current=sel.value; sel.innerHTML='<option value="">All customers</option>'; [...new Set(CMDB_ITEMS.map(i=>i.customer||''))].sort().forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent = c || 'â€”'; if(c===current) o.selected=true; sel.appendChild(o); }); const q=(document.getElementById('cmdb-search').value||'').toLowerCase(); const custFilter = role==='customer' ? (tenant || '') : sel.value; const body=document.getElementById('cmdb-body'); body.innerHTML=''; CMDB_ITEMS.filter(i=>(!custFilter || i.customer===custFilter) && (!q || (i.name||'').toLowerCase().includes(q) || (i.customer||'').toLowerCase().includes(q))).forEach(i=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i.customer||'â€”'}</td><td>${i.name}</td><td><button class='btn primary' onclick='openItem("${i.cmdb_id}")'>Open</button></td>`; body.appendChild(tr); }); }
  function openItem(id){ currentItemId=id; switchView('cmdb-detail'); }
  async function renderCMDBDetail(){ 
    const item = CMDB_ITEMS.find(i=>i.cmdb_id===currentItemId) || {}; 
    document.getElementById('cmdb-name-h').textContent = item.name || '(Unnamed)'; 
    document.getElementById('cmdb-customer-h').textContent = item.customer || 'â€”'; 
    document.getElementById('cmdb-id-h').textContent = currentItemId || 'â€”'; 
    // Load CIs from API if not cached
    let list = CIS_BY_ITEM[currentItemId];
    if (!list) { list = await loadCIsForItem(currentItemId); }
    const head = document.getElementById('ci-head'); 
    const body = document.getElementById('ci-body'); 
    head.innerHTML=''; body.innerHTML=''; 
    if(!list || list.length===0){ head.innerHTML='<tr><th>CI Name</th></tr>'; body.innerHTML='<tr><td class="subtitle">No CIs</td></tr>'; return; } 
    const ignore = new Set(['ci_id','cmdb_id']); 
    const cols = Object.keys(list[0]).filter(k=>!ignore.has(k)); 
    head.innerHTML = '<tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr>'; 
    list.forEach(ci=>{ const tr = document.createElement('tr'); tr.innerHTML = cols.map(c=>`<td>${ci[c]||''}</td>`).join(''); body.appendChild(tr); }); 
  }
  function showCreateCMDBForm(){
    window.open('/public/cmdb-management.html', '_blank');
  }
  function showImportCMDBDialog(){
    window.open('/public/cmdb-management.html', '_blank');
  }
  
  // ---- Manage CMDB Types ----
  async function loadManageCMDB(){ 
    try{ 
      const token=localStorage.getItem('token'); 
      if(!token){ alert('Session expired'); window.location.reload(); return; } 
      const res=await fetch(`${API_BASE}/api/cmdb-types/apoyar/item-types`,{headers:{'Authorization':`Bearer ${token}`}}); 
      const data=await res.json(); 
      if(!data.success){ alert('Failed to load CMDB types: '+data.message); return; } 
      const body=document.getElementById('item-types-body'); body.innerHTML=''; data.itemTypes.forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.name}</td><td>${t.description||'â€”'}</td><td>${t.ci_count||0}</td><td><span class="badge ${t.is_active?'success':'danger'}">${t.is_active?'Active':'Inactive'}</span></td><td><button class="btn" onclick='viewCITypes(${t.id},\"${t.name}\")'>View CI Types</button></td>`; body.appendChild(tr); }); 
    }catch(err){ alert('Error loading CMDB types: '+err.message); } 
  }
  async function viewCITypes(itemTypeId, itemTypeName){ 
    document.getElementById('selected-item-type-name').textContent=itemTypeName; 
    document.getElementById('ci-types-section').style.display='block'; 
    try{ 
      const token=localStorage.getItem('token'); 
      const res=await fetch(`${API_BASE}/api/cmdb-types/apoyar/item-types/${itemTypeId}/ci-types`,{headers:{'Authorization':`Bearer ${token}`}}); 
      const data=await res.json(); 
      if(!data.success){ alert('Failed to load CI types: '+data.message); return; } 
      const body=document.getElementById('ci-types-body'); body.innerHTML=''; data.ciTypes.forEach(ci=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${ci.name}</td><td>${ci.description||'â€”'}</td><td><span class="badge ${ci.is_active?'success':'danger'}">${ci.is_active?'Active':'Inactive'}</span></td><td><button class="btn">Edit</button></td>`; body.appendChild(tr); }); 
    }catch(err){ alert('Error loading CI types: '+err.message); } 
  }
  function showCreateItemTypeForm(){ alert('To add a new CMDB Item Type, contact the database administrator or use the API.'); }
  function showCreateCITypeForm(){ alert('To add a new CI Type, select an Item Type first and click "Add CI Type" button.'); }

  // ---- Raise Request ----
  async function loadRaiseFormOptions(){ 
    const sItem=document.getElementById('rq-item'); 
    const sCI=document.getElementById('rq-ci'); 
    if(!sItem||!sCI) return; 
    
    // Show customer field for experts/admins ONLY
    const customerField = document.getElementById('rq-customer-field');
    const currentRole = window.role || role;
    
    if (currentRole === 'expert' || currentRole === 'admin') {
      customerField.style.display = 'block';
      await loadCustomersForRaiseRequest();
    } else {
      // Customer role - hide the customer selector completely
      customerField.style.display = 'none';
    }
    
    const relevant=CMDB_ITEMS.filter(i => currentRole!=='customer' || !tenant || i.customer===tenant); 
    sItem.innerHTML = '<option value=\"\">â€”</option>' + relevant.map(i => `<option value="${i.cmdb_id}">${i.name}</option>`).join(''); 
    sCI.innerHTML = '<option value=\"\">â€”</option>'; 
    sItem.onchange = () => { const id = sItem.value; const cies = CIS_BY_ITEM[id] || []; sCI.innerHTML = '<option value=\"\">â€”</option>' + cies.map(ci => `<option value="${ci.ci_id}">${ci.name}</option>`).join(''); }; 
  }
  
  async function loadCustomersForRaiseRequest() {
    try {
      const token = localStorage.getItem('token');
      const res = await fetch(`${API_BASE}/api/auth/customers`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.success) return;
      
      const select = document.getElementById('rq-customer');
      select.innerHTML = '<option value="">â€” Select Customer â€”</option>';
      data.customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.full_name || customer.username} (${customer.company || ''})`;
        select.appendChild(option);
      });
    } catch (err) {
      console.error('Error loading customers:', err);
    }
  }
  
  async function loadCMDBForCustomer() {
    const customerId = document.getElementById('rq-customer').value;
    if (!customerId) {
      document.getElementById('rq-item').innerHTML = '<option value="">â€”</option>';
      return;
    }
    
    try {
      const token = localStorage.getItem('token');
      const res = await fetch(`${API_BASE}/api/cmdb/apoyar/items?customer_id=${customerId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (!data.success) return;
      
      const sItem = document.getElementById('rq-item');
      sItem.innerHTML = '<option value="">â€”</option>';
      data.items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        sItem.appendChild(option);
      });
    } catch (err) {
      console.error('Error loading CMDB items:', err);
    }
  }
  async function submitRequest(){ 
    const title=document.getElementById('rq-title').value.trim(); 
    const desc=document.getElementById('rq-desc').value.trim(); 
    const priority=document.getElementById('rq-priority').value || 'Normal'; 
    const itemId=document.getElementById('rq-item').value; 
    const ciId=document.getElementById('rq-ci').value; 
    if (!title || !desc) { startChat('assist', {title, desc, priority, itemId, ciId}); return; }
    
    // Get customer ID - either from selection (expert/admin) or current user (customer)
    const token = localStorage.getItem('token');
    const currentRole = window.role || role;
    let customerId = null;
    
    if (currentRole === 'expert' || currentRole === 'admin') {
      // For experts/admins, get from dropdown selection
      customerId = document.getElementById('rq-customer').value;
      if (!customerId) {
        alert('Please select a customer');
        return;
      }
    } else if (currentRole === 'customer') {
      // For customers, use the logged-in user's ID automatically
      customerId = window.currentUser?.id;
      if (!customerId) {
        alert('Error: Unable to identify customer. Please log in again.');
        console.error('window.currentUser:', window.currentUser);
        return;
      }
    }
    
    // Create ticket via API
    try {
      const tenantCode = tenant || 'apoyar';
      const res = await fetch(`${API_BASE}/api/tickets/${tenantCode}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          description: desc,
          priority: priority || undefined,
          customer_id: customerId,
          ...(itemId && { cmdb_item_id: parseInt(itemId) }),
          ...(ciId && { ci_id: parseInt(ciId) })
        })
      });
      
      const data = await res.json();
      if (data.success) {
        alert('Request submitted as ticket #' + data.ticket.id);
        switchView('tickets');
        renderList();
        document.getElementById('rq-title').value='';
        document.getElementById('rq-desc').value='';
        document.getElementById('rq-priority').value='';
        document.getElementById('rq-item').value='';
        document.getElementById('rq-ci').value='';
      } else {
        // Show detailed validation errors if available
        let errorMessage = data.message || 'Failed to submit request';
        if (data.errors && data.errors.length > 0) {
          errorMessage += ':\n' + data.errors.map(e => `- ${e.field}: ${e.message}`).join('\n');
        }
        alert(errorMessage);
      }
    } catch (err) {
      console.error('Error submitting request:', err);
      alert('Error submitting request: ' + err.message);
    }
  }

  // ---- Chatbot ----
  const chatToggle = document.getElementById('chat-toggle');
  const chat = document.getElementById('chat');
  const chatBody = document.getElementById('chat-body');
  const chatInput = document.getElementById('chat-input');
  chatToggle.onclick = () => { chat.style.display = (chat.style.display==='flex' ? 'none' : 'flex'); chat.style.display==='flex' && chatInput.focus(); if (!chatBody.dataset.boot) bootChat(); };
  document.addEventListener('keydown', (e)=>{ if(e.key==='F7') chatToggle.click(); });
  function bootChat() { chatBody.dataset.boot = '1'; addAI('Hi! I can help you raise a request. What do you need help with?'); }
  function addAI(text) { const d=document.createElement('div'); d.className='msg ai'; d.textContent=text; chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight; }
  function addMe(text) { const d=document.createElement('div'); d.className='msg me'; d.textContent=text; chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight; }
  function startChat(reason, payload) { chat.style.display='flex'; if (!chatBody.dataset.boot) bootChat(); if (reason) addAI('I noticed some details are missing. I can fill them in for you.'); if (payload) { if (!payload.title) { pending = 'title'; addAI('First, what is a short title for your request?'); return; } if (!payload.desc)  { pending = 'desc'; addAI('Thanks. Could you briefly describe the issue?'); return; } if (!payload.priority) { pending = 'priority'; addAI('Do you want to set a priority? (Low/Medium/High/Critical). You can also say \"skip\".'); return; } if (!payload.itemId) { pending = 'item'; addAI('Do you want to link a CMDB Item? You can reply with the item name or say \"skip\".'); return; } if (payload.itemId && !payload.ciId) { pending = 'ci'; addAI('Do you want to link a CI under that item? You can reply with the CI name or say \"skip\".'); return; } addAI('Looks like everything is provided already â€” you can submit!'); } }
  function sendChat() {
    const text = chatInput.value.trim();
    if (!text) return;
    addMe(text);
    chatInput.value='';
    const t = text.toLowerCase();
    if (!pending) {
      addAI('Got it. If you want, say "raise" to create a request or tell me what you need.');
      return;
    }
    if (pending==='title') {
      document.getElementById('rq-title').value = text;
      pending = 'desc';
      addAI('Thanks. Please describe the issue.');
      return;
    }
    if (pending==='desc') {
      document.getElementById('rq-desc').value = text;
      pending='priority';
      addAI('Set a priority? (Low/Medium/High/Critical). You can say "skip".');
      return;
    }
    if (pending==='priority') {
      if (t==='skip' || !/(low|medium|high|critical)/.test(t)) {
        document.getElementById('rq-priority').value='';
        addAI('Skipping priority. Link a CMDB Item? Reply with item name or "skip".');
        pending='item';
        return;
      }
      const priorityMap = {low:'Low', medium:'Medium', high:'High', critical:'Critical'};
      const p = /critical/.test(t)?'critical':(/high/.test(t)?'high':(/low/.test(t)?'low':'medium'));
      document.getElementById('rq-priority').value=p;
      addAI('Priority set to '+priorityMap[p]+'. Link a CMDB Item? Reply with item name or "skip".');
      pending='item';
      return;
    }
    if (pending==='item') {
      if (t==='skip') {
        document.getElementById('rq-item').value='';
        addAI('Skipping item. Link a CI? You can say "skip".');
        pending='ci';
        return;
      }
      const pool = CMDB_ITEMS.filter(i => role!=='customer' || !tenant || i.customer===tenant);
      const hit = pool.find(i => (i.name||'').toLowerCase().includes(t));
      if (hit) {
        document.getElementById('rq-item').value = hit.cmdb_id;
        const cies = CIS_BY_ITEM[hit.cmdb_id]||[];
        const sCI=document.getElementById('rq-ci');
        sCI.innerHTML='<option value="">â€”</option>'+cies.map(ci=>'<option value="'+ci.ci_id+'">'+ci.name+'</option>').join('');
        addAI('Linked to item: '+hit.name+'. Do you want to link a CI? Reply with CI name or "skip".');
        pending='ci';
        return;
      } else {
        addAI('Hmm, I did not find that item. Try a different name or say "skip".');
        return;
      }
    }
    if (pending==='ci') {
      if (t==='skip') {
        document.getElementById('rq-ci').value='';
        pending=null;
        addAI('All set. Press "Submit request" to create the ticket.');
        return;
      }
      const itemId = document.getElementById('rq-item').value;
      const cies = CIS_BY_ITEM[itemId]||[];
      const hit = cies.find(ci => (ci.name||'').toLowerCase().includes(t));
      if (hit) {
        document.getElementById('rq-ci').value = hit.ci_id;
        pending=null;
        addAI('Linked CI: '+hit.name+'. You can now press "Submit request".');
        return;
      } else {
        addAI('Couldn\'t find that CI. Try again or say "skip".');
        return;
      }
    }
  }


  // ====== System Control Functions ======

  let systemControlAuditLog = [];

  async function loadSystemControlSettings() {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      console.log('Loading system control settings for tenant:', tenantCode);

      const response = await fetch(`${API_BASE}/api/tickets/settings/${tenantCode}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();
      console.log('Settings response:', data);

      if (data.success && data.settings) {
        // Update Send Emails to Experts toggle
        const sendExpertsCheckbox = document.getElementById('sc-send-emails-experts');
        const sendExpertsValue = data.settings.send_emails_experts;
        const sendExpertsEnabled = sendExpertsValue !== 'false';
        console.log('send_emails_experts value:', sendExpertsValue, 'enabled:', sendExpertsEnabled);
        if (sendExpertsCheckbox) {
          sendExpertsCheckbox.checked = sendExpertsEnabled;
        }
        updateSystemSettingStatus('send_emails_experts', sendExpertsEnabled);

        // Update Send Emails to Customers toggle
        const sendCustomersCheckbox = document.getElementById('sc-send-emails-customers');
        const sendCustomersValue = data.settings.send_emails_customers;
        const sendCustomersEnabled = sendCustomersValue !== 'false';
        console.log('send_emails_customers value:', sendCustomersValue, 'enabled:', sendCustomersEnabled);
        if (sendCustomersCheckbox) {
          sendCustomersCheckbox.checked = sendCustomersEnabled;
        }
        updateSystemSettingStatus('send_emails_customers', sendCustomersEnabled);

        // Update Process Emails toggle - check explicitly for 'false' string
        const processEmailsCheckbox = document.getElementById('sc-process-emails');
        const processEmailsValue = data.settings.process_emails;
        // Only disabled if explicitly set to 'false'
        const processEmailsEnabled = processEmailsValue !== 'false';
        console.log('process_emails value:', processEmailsValue, 'enabled:', processEmailsEnabled);
        if (processEmailsCheckbox) {
          processEmailsCheckbox.checked = processEmailsEnabled;
        }
        updateSystemSettingStatus('process_emails', processEmailsEnabled);
      } else {
        console.log('No settings found, defaulting to enabled');
        // Default to enabled if no settings found
        const sendExpertsCheckbox = document.getElementById('sc-send-emails-experts');
        const sendCustomersCheckbox = document.getElementById('sc-send-emails-customers');
        const processCheckbox = document.getElementById('sc-process-emails');
        if (sendExpertsCheckbox) sendExpertsCheckbox.checked = true;
        if (sendCustomersCheckbox) sendCustomersCheckbox.checked = true;
        if (processCheckbox) processCheckbox.checked = true;
        updateSystemSettingStatus('send_emails_experts', true);
        updateSystemSettingStatus('send_emails_customers', true);
        updateSystemSettingStatus('process_emails', true);
      }

      // Update status log
      updateSystemStatusLog();

      // Update last updated timestamp
      const lastUpdated = document.getElementById('sc-last-updated');
      if (lastUpdated) lastUpdated.textContent = new Date().toLocaleString();

      // Load audit log
      loadSystemControlAuditLog();

    } catch (error) {
      console.error('Error loading system control settings:', error);
      const statusLog = document.getElementById('sc-status-log');
      if (statusLog) statusLog.innerHTML = '<div style="color:#b91c1c">Error loading system settings</div>';
    }
  }

  function updateSystemSettingStatus(setting, enabled) {
    const statusDiv = document.getElementById(`sc-${setting.replace(/_/g, '-')}-status`);
    if (statusDiv) {
      let enabledMsg = '';
      let disabledMsg = '';

      switch(setting) {
        case 'send_emails_experts':
          enabledMsg = 'Email notifications to experts are enabled';
          disabledMsg = 'Email notifications to experts are disabled';
          break;
        case 'send_emails_customers':
          enabledMsg = 'Email notifications to customers are enabled';
          disabledMsg = 'Email notifications to customers are disabled';
          break;
        case 'process_emails':
          enabledMsg = 'Inbound emails will be processed';
          disabledMsg = 'No inbound emails will be processed';
          break;
        default:
          enabledMsg = 'Setting is enabled';
          disabledMsg = 'Setting is disabled';
      }

      if (enabled) {
        statusDiv.style.background = '#dcfce7';
        statusDiv.style.color = '#166534';
        statusDiv.innerHTML = 'âœ“ <strong>ENABLED</strong> - ' + enabledMsg;
      } else {
        statusDiv.style.background = '#fef2f2';
        statusDiv.style.color = '#b91c1c';
        statusDiv.innerHTML = 'âœ— <strong>DISABLED</strong> - ' + disabledMsg;
      }
    }
  }

  async function toggleSystemSetting(setting, enabled) {
    try {
      const token = localStorage.getItem('token');
      const tenantCode = window.tenant || 'apoyar';

      const response = await fetch(`${API_BASE}/api/tickets/settings/${tenantCode}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          key: setting,
          value: enabled ? 'true' : 'false'
        })
      });

      const data = await response.json();

      if (data.success) {
        updateSystemSettingStatus(setting, enabled);

        // Add to local audit log
        const username = localStorage.getItem('username') || 'Unknown';
        const settingNames = {
          'send_emails_experts': 'Send to Experts',
          'send_emails_customers': 'Send to Customers',
          'process_emails': 'Process Emails'
        };
        systemControlAuditLog.unshift({
          setting: settingNames[setting] || setting,
          old_value: enabled ? 'OFF' : 'ON',
          new_value: enabled ? 'ON' : 'OFF',
          changed_by: username,
          time: new Date().toLocaleString()
        });

        renderSystemControlAuditLog();
        updateSystemStatusLog();
      } else {
        alert('Failed to update setting: ' + (data.message || 'Unknown error'));
        // Revert the checkbox
        document.getElementById(`sc-${setting.replace(/_/g, '-')}`).checked = !enabled;
      }
    } catch (error) {
      console.error('Error toggling system setting:', error);
      alert('Error updating setting. Please try again.');
      // Revert the checkbox
      document.getElementById(`sc-${setting.replace(/_/g, '-')}`).checked = !enabled;
    }
  }

  function updateSystemStatusLog() {
    const statusLog = document.getElementById('sc-status-log');
    const sendExperts = document.getElementById('sc-send-emails-experts')?.checked;
    const sendCustomers = document.getElementById('sc-send-emails-customers')?.checked;
    const processEmails = document.getElementById('sc-process-emails')?.checked;

    let logHtml = '';
    logHtml += `<div style="margin-bottom:8px">[${new Date().toLocaleTimeString()}] System Control Status Check</div>`;
    logHtml += `<div style="margin-bottom:4px;color:${sendExperts ? '#166534' : '#b91c1c'}">  â†’ send_to_experts: ${sendExperts ? 'ENABLED' : 'DISABLED'}</div>`;
    logHtml += `<div style="margin-bottom:4px;color:${sendCustomers ? '#166534' : '#b91c1c'}">  â†’ send_to_customers: ${sendCustomers ? 'ENABLED' : 'DISABLED'}</div>`;
    logHtml += `<div style="margin-bottom:4px;color:${processEmails ? '#166534' : '#b91c1c'}">  â†’ process_emails: ${processEmails ? 'ENABLED' : 'DISABLED'}</div>`;
    logHtml += `<div style="margin-top:8px;border-top:1px solid #e2e8f0;padding-top:8px">`;

    if (!sendExperts || !sendCustomers || !processEmails) {
      logHtml += `<div style="color:#b45309">âš ï¸ Warning: Some email functionality is disabled</div>`;
    } else {
      logHtml += `<div style="color:#166534">âœ“ All email systems operational</div>`;
    }
    logHtml += '</div>';

    statusLog.innerHTML = logHtml;
  }

  async function loadSystemControlAuditLog() {
    // For now, just show the in-memory audit log
    // In a full implementation, this would fetch from the backend
    renderSystemControlAuditLog();
  }

  function renderSystemControlAuditLog() {
    const tbody = document.getElementById('sc-audit-log');

    if (systemControlAuditLog.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="subtitle" style="text-align:center">No recent changes</td></tr>';
      return;
    }

    tbody.innerHTML = systemControlAuditLog.slice(0, 10).map(log => `
      <tr>
        <td>${log.setting}</td>
        <td><span class="badge" style="background:${log.old_value === 'ON' ? '#dcfce7' : '#fef2f2'}">${log.old_value}</span></td>
        <td><span class="badge" style="background:${log.new_value === 'ON' ? '#dcfce7' : '#fef2f2'}">${log.new_value}</span></td>
        <td>${log.changed_by}</td>
        <td>${log.time}</td>
      </tr>
    `).join('');
  }

  // ====== AI Insights Functions ======

let aiInsightsData = null;
let aiInsightsLoading = false;

async function loadAIInsights() {
  // Prevent multiple simultaneous requests
  if (aiInsightsLoading) {
    console.log('AI Insights already loading, skipping duplicate request');
    return;
  }

  aiInsightsLoading = true;
  console.log('loadAIInsights() called');

  const period = document.getElementById('ai-period')?.value || 7;
  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/analytics/${tenantCode}/ai-insights?period=${period}`;
    console.log('Fetching AI insights from:', url);

    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      aiInsightsData = data.data;
      displayAIInsights(aiInsightsData);
    } else {
      console.error('AI Insights API error:', data);
      document.getElementById('ai-insights-list').innerHTML =
        '<div class="subtitle" style="color:#f56565">Failed to load AI insights</div>';
    }
  } catch (error) {
    console.error('Error loading AI insights:', error);
    document.getElementById('ai-insights-list').innerHTML =
      '<div class="subtitle" style="color:#f56565">Error loading AI insights. Make sure the server is running.</div>';
  } finally {
    aiInsightsLoading = false;
  }
}

async function displayAIInsights(data) {
  console.log('Displaying AI insights:', data);

  // Display insights/alerts
  const insightsList = document.getElementById('ai-insights-list');
  if (data.insights && data.insights.length > 0) {
    // Fetch ticket details for all insights with affected tickets
    await enrichInsightsWithTicketDetails(data.insights);

    insightsList.innerHTML = data.insights.map(insight => {
      const severityColors = {
        critical: '#f56565',
        warning: '#ed8936',
        info: '#4299e1'
      };
      const severityColor = severityColors[insight.severity] || '#718096';
      const severityIcon = {
        critical: 'ğŸ”´',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      }[insight.severity] || 'ğŸ“Š';

      // Generate ticket summary HTML
      const ticketSummaryHTML = generateTicketSummary(insight);

      return `
        <div class="card p-12 mb-8" style="border-left:4px solid ${severityColor};cursor:pointer"
             onclick="event.stopPropagation()">
          <div class="row space">
            <div style="flex:1">
              <div class="row" style="gap:8px;align-items:center;margin-bottom:4px">
                <span style="font-size:18px">${severityIcon}</span>
                <strong>${insight.title}</strong>
                <span class="badge" style="background:${severityColor};color:white;text-transform:uppercase;font-size:10px;padding:2px 6px;border-radius:4px">${insight.severity}</span>
              </div>
              <div class="subtitle">${insight.description}</div>

              ${ticketSummaryHTML}

              ${insight.affected_tickets && insight.affected_tickets.length > 0 ?
                `<div style="margin-top:8px">
                  <button class="btn ghost" style="padding:4px 12px;font-size:12px"
                          onclick="openTicketsFromInsight([${insight.affected_tickets.join(',')}], '${insight.title}')">
                    ğŸ“‹ View ${insight.affected_tickets.length} Ticket${insight.affected_tickets.length > 1 ? 's' : ''}
                  </button>
                </div>` :
                ''
              }
              <div class="subtitle" style="margin-top:4px;font-size:11px;color:#a0aec0">${new Date(insight.created_at).toLocaleString()}</div>
            </div>
            <div class="row" style="gap:4px">
              <button class="btn ghost" style="padding:4px 8px;font-size:12px" onclick="acknowledgeInsight(${insight.id})">âœ“ Acknowledge</button>
              <button class="btn ghost" style="padding:4px 8px;font-size:12px" onclick="dismissInsight(${insight.id})">âœ• Dismiss</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  } else {
    insightsList.innerHTML = '<div class="subtitle">âœ… No active insights. Everything looks good!</div>';
  }

  // Display performance metrics
  if (data.performance) {
    document.getElementById('ai-tickets-analyzed').textContent = data.performance.total_analyzed || 0;

    const avgConf = parseFloat(data.performance.avg_confidence);
    document.getElementById('ai-avg-confidence').textContent = !isNaN(avgConf) ? avgConf.toFixed(1) + '%' : '--';

    const avgTime = parseFloat(data.performance.avg_processing_time);
    document.getElementById('ai-avg-time').textContent = !isNaN(avgTime) ? avgTime.toFixed(0) + 'ms' : '--';
  }

  // Display sentiment chart
  if (data.sentiment && data.sentiment.distribution) {
    renderSentimentChart(data.sentiment.distribution);
  }

  // Display categories chart
  if (data.categories && data.categories.length > 0) {
    renderCategoriesChart(data.categories);
  }

  // Display root causes chart
  if (data.rootCauses && data.rootCauses.length > 0) {
    renderRootCausesChart(data.rootCauses);
  }
}

// Enrich insights with ticket details
async function enrichInsightsWithTicketDetails(insights) {
  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');

  for (const insight of insights) {
    if (insight.affected_tickets && insight.affected_tickets.length > 0) {
      try {
        // Fetch tickets in batches to avoid overwhelming the API
        const ticketIds = insight.affected_tickets.slice(0, 50); // Limit to first 50
        const ticketsPromises = ticketIds.map(async (ticketId) => {
          try {
            const url = window.location.protocol + '//' + window.location.host +
                       `/api/tickets/${tenantCode}/${ticketId}`;
            const response = await fetch(url, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            return data.success ? data.ticket : null;
          } catch (error) {
            console.error(`Error fetching ticket ${ticketId}:`, error);
            return null;
          }
        });

        const tickets = (await Promise.all(ticketsPromises)).filter(t => t !== null);
        insight.ticketDetails = tickets;
      } catch (error) {
        console.error('Error enriching insight with ticket details:', error);
        insight.ticketDetails = [];
      }
    }
  }
}

// Generate ticket summary HTML with grouping
function generateTicketSummary(insight) {
  if (!insight.ticketDetails || insight.ticketDetails.length === 0) {
    return '';
  }

  // Group tickets by title
  const groupedTickets = {};
  const ticketDates = [];

  insight.ticketDetails.forEach(ticket => {
    const title = ticket.title || 'Untitled';
    if (!groupedTickets[title]) {
      groupedTickets[title] = {
        title: title,
        count: 0,
        tickets: [],
        earliestDate: null,
        latestDate: null
      };
    }

    groupedTickets[title].count++;
    groupedTickets[title].tickets.push(ticket);

    const ticketDate = new Date(ticket.created_at);
    ticketDates.push(ticketDate);

    if (!groupedTickets[title].earliestDate || ticketDate < groupedTickets[title].earliestDate) {
      groupedTickets[title].earliestDate = ticketDate;
    }
    if (!groupedTickets[title].latestDate || ticketDate > groupedTickets[title].latestDate) {
      groupedTickets[title].latestDate = ticketDate;
    }
  });

  // Get overall time span
  const earliestDate = ticketDates.length > 0 ? new Date(Math.min(...ticketDates)) : null;
  const latestDate = ticketDates.length > 0 ? new Date(Math.max(...ticketDates)) : null;

  let html = '<div style="margin-top:12px;padding:12px;background:#f7fafc;border-radius:6px">';
  html += '<div style="font-weight:600;margin-bottom:8px;font-size:13px">ğŸ“Š Ticket Summary</div>';

  // Overall time span
  if (earliestDate && latestDate) {
    const timeSpan = formatTimeSpan(earliestDate, latestDate);
    html += `<div class="subtitle" style="margin-bottom:8px;font-size:12px">
      ğŸ“… Time span: ${timeSpan}
    </div>`;
  }

  // Grouped tickets
  const groups = Object.values(groupedTickets).sort((a, b) => b.count - a.count);

  html += '<div style="margin-top:8px">';
  groups.slice(0, 5).forEach(group => {
    const ticketIds = group.tickets.map(t => t.id);
    const timeSpan = formatTimeSpan(group.earliestDate, group.latestDate);

    html += `
      <div style="margin-bottom:6px;padding:6px;background:white;border-radius:4px;cursor:pointer"
           onclick="openTicketsFromInsight([${ticketIds.join(',')}], '${escapeHtml(group.title)}')">
        <div style="font-weight:600;font-size:12px;color:#2d3748">
          ${group.count} Ã— ${escapeHtml(group.title)}
        </div>
        <div class="subtitle" style="font-size:11px;margin-top:2px">
          ${timeSpan} â€¢ Click to view tickets
        </div>
      </div>
    `;
  });

  if (groups.length > 5) {
    html += `<div class="subtitle" style="font-size:11px;margin-top:4px">
      ...and ${groups.length - 5} more groups
    </div>`;
  }
  html += '</div>';

  html += '</div>';
  return html;
}

// Format time span
function formatTimeSpan(startDate, endDate) {
  const start = new Date(startDate);
  const end = new Date(endDate);

  if (start.toDateString() === end.toDateString()) {
    return `${start.toLocaleDateString()} ${start.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})} - ${end.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;
  } else {
    const diffMs = end - start;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

    if (diffDays > 0) {
      return `${start.toLocaleDateString()} to ${end.toLocaleDateString()} (${diffDays}d ${diffHours}h)`;
    } else {
      return `${start.toLocaleDateString()} (${diffHours}h)`;
    }
  }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Open tickets from insight
async function openTicketsFromInsight(ticketIds, insightTitle) {
  console.log('Opening tickets from insight:', ticketIds);

  // Store the filter in window object
  window.insightTicketFilter = ticketIds;
  window.insightTitle = insightTitle || 'Insight Tickets';

  // Navigate to tickets view
  switchView('tickets');

  // Wait for view to render
  await new Promise(resolve => setTimeout(resolve, 100));

  // Apply the insight filter
  await renderList();
}

function renderSentimentChart(distribution) {
  const container = document.getElementById('sentiment-chart');
  const total = Object.values(distribution).reduce((sum, val) => sum + val, 0);

  if (total === 0) {
    container.innerHTML = '<div class="subtitle">No data available</div>';
    return;
  }

  const sentimentColors = {
    urgent: '#f56565',
    negative: '#ed8936',
    neutral: '#a0aec0',
    positive: '#48bb78'
  };

  const sentimentIcons = {
    urgent: 'ğŸ”´',
    negative: 'ğŸ˜',
    neutral: 'ğŸ˜¶',
    positive: 'ğŸ˜Š'
  };

  container.innerHTML = Object.entries(distribution).map(([sentiment, count]) => {
    const percent = ((count / total) * 100).toFixed(1);
    const color = sentimentColors[sentiment] || '#a0aec0';
    const icon = sentimentIcons[sentiment] || 'ğŸ“Š';

    return `
      <div style="margin-bottom:12px">
        <div class="row space" style="margin-bottom:4px">
          <span class="subtitle">${icon} ${sentiment.charAt(0).toUpperCase() + sentiment.slice(1)}</span>
          <span class="subtitle"><strong>${count}</strong> (${percent}%)</span>
        </div>
        <div style="width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden">
          <div style="width:${percent}%;height:100%;background:${color};border-radius:4px"></div>
        </div>
      </div>
    `;
  }).join('');
}

function renderCategoriesChart(categories) {
  const container = document.getElementById('categories-chart');
  const maxCount = Math.max(...categories.map(c => c.count));

  container.innerHTML = categories.slice(0, 5).map(cat => {
    const percent = ((cat.count / maxCount) * 100).toFixed(1);
    const conf = parseFloat(cat.avg_confidence);
    const confStr = !isNaN(conf) ? ` (${conf.toFixed(0)}% confidence)` : '';

    return `
      <div style="margin-bottom:12px">
        <div class="row space" style="margin-bottom:4px">
          <span class="subtitle">${cat.ai_category}</span>
          <span class="subtitle"><strong>${cat.count}</strong>${confStr}</span>
        </div>
        <div style="width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden">
          <div style="width:${percent}%;height:100%;background:#667eea;border-radius:4px"></div>
        </div>
      </div>
    `;
  }).join('');
}

function renderRootCausesChart(rootCauses) {
  const container = document.getElementById('root-causes-chart');
  const total = rootCauses.reduce((sum, rc) => sum + rc.count, 0);

  const rootCauseColors = {
    system: '#667eea',
    hardware: '#ed8936',
    software: '#4299e1',
    network: '#48bb78',
    database: '#9f7aea',
    resource: '#f56565',
    unknown: '#a0aec0'
  };

  container.innerHTML = `
    <div class="row" style="gap:8px;flex-wrap:wrap">
      ${rootCauses.map(rc => {
        const percent = ((rc.count / total) * 100).toFixed(1);
        const color = rootCauseColors[rc.root_cause_type] || '#a0aec0';

        return `
          <div class="card p-12" style="flex:1;min-width:120px;border-left:4px solid ${color}">
            <div class="subtitle" style="margin-bottom:4px">${rc.root_cause_type || 'unknown'}</div>
            <div style="font-size:24px;font-weight:800;color:${color}">${rc.count}</div>
            <div class="subtitle" style="font-size:11px">${percent}% of total</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

async function refreshAIInsights() {
  // Show loading indicator
  const insightsList = document.getElementById('ai-insights-list');
  if (insightsList) {
    insightsList.innerHTML = '<div class="subtitle">ğŸ”„ Loading insights...</div>';
  }

  await loadAIInsights();
}

async function triggerTrendDetection(evt) {
  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');

  // Get the button element
  const btn = evt?.target || document.querySelector('button[onclick*="triggerTrendDetection"]');

  try {
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'â³ Detecting...';
    }

    const url = window.location.protocol + '//' + window.location.host + `/api/analytics/${tenantCode}/detect-trends`;
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ timeRangeHours: 24 })
    });

    const data = await response.json();

    if (data.success) {
      alert(`âœ… Trend detection complete!\n\n${data.message}\n\nRefreshing dashboard...`);
      await refreshAIInsights();
    } else {
      alert('âŒ Failed to detect trends. Check console for details.');
    }
  } catch (error) {
    console.error('Error triggering trend detection:', error);
    alert('âŒ Error detecting trends: ' + error.message);
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'ğŸ” Detect Trends';
    }
  }
}

async function acknowledgeInsight(insightId) {
  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/analytics/${tenantCode}/insights/${insightId}/acknowledge`;
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      await refreshAIInsights();
    } else {
      alert('Failed to acknowledge insight');
    }
  } catch (error) {
    console.error('Error acknowledging insight:', error);
    alert('Error acknowledging insight: ' + error.message);
  }
}

async function dismissInsight(insightId) {
  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/analytics/${tenantCode}/insights/${insightId}/dismiss`;
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      await refreshAIInsights();
    } else {
      alert('Failed to dismiss insight');
    }
  } catch (error) {
    console.error('Error dismissing insight:', error);
    alert('Error dismissing insight: ' + error.message);
  }
}

// ADD TO THE nav() FUNCTION SWITCH STATEMENT:
// case 'ai-insights': loadAIInsights(); break;
// case 'ticket-rules': loadTicketRules(); break;

// ============================================
// TICKET PROCESSING RULES FUNCTIONS
// ============================================

let currentRuleId = null;
let ruleExperts = [];
let ruleCustomers = [];

// Load all rules for the current tenant
async function loadTicketRules() {
  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    // Load rules
    const rulesUrl = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}`;
    const rulesResponse = await fetch(rulesUrl, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const rulesData = await rulesResponse.json();

    // Load statistics
    const statsUrl = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/statistics`;
    const statsResponse = await fetch(statsUrl, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const statsData = await statsResponse.json();

    // Update statistics display
    if (statsData.success) {
      document.getElementById('rules-total').textContent = statsData.statistics.total_rules || 0;
      document.getElementById('rules-enabled').textContent = statsData.statistics.enabled_rules || 0;
      document.getElementById('rules-executions-24h').textContent = statsData.statistics.executions_last_24h || 0;
    }

    // Display rules
    if (rulesData.success && rulesData.rules.length > 0) {
      displayRules(rulesData.rules);
    } else {
      document.getElementById('rules-list').innerHTML = '<div class="subtitle">No rules found. Create your first rule to get started.</div>';
    }

    // Load experts and customers for dropdowns
    await loadExpertsAndCustomers();
  } catch (error) {
    console.error('Error loading ticket rules:', error);
    document.getElementById('rules-list').innerHTML = '<div class="subtitle" style="color:#f56565">Error loading rules</div>';
  }
}

// Display rules in the list
function displayRules(rules) {
  const rulesList = document.getElementById('rules-list');

  const actionIcons = {
    delete: 'ğŸ—‘ï¸',
    assign_to_expert: 'ğŸ‘¤',
    create_for_customer: 'ğŸ“‹',
    set_priority: 'âš¡',
    set_status: 'ğŸ“Š',
    add_tag: 'ğŸ·ï¸'
  };

  const actionLabels = {
    delete: 'Delete Ticket',
    assign_to_expert: 'Assign to Expert',
    create_for_customer: 'Create for Customer',
    set_priority: 'Set Priority',
    set_status: 'Set Status',
    add_tag: 'Add Tag'
  };

  rulesList.innerHTML = rules.map(rule => {
    const actionIcon = actionIcons[rule.action_type] || 'âš™ï¸';
    const actionLabel = actionLabels[rule.action_type] || rule.action_type;
    const enabledBadge = rule.enabled
      ? '<span style="padding:4px 8px;background:#48bb78;color:white;border-radius:4px;font-size:11px;font-weight:600">ENABLED</span>'
      : '<span style="padding:4px 8px;background:#a0aec0;color:white;border-radius:4px;font-size:11px;font-weight:600">DISABLED</span>';

    return `
      <div class="card p-12 mb-8" style="border-left:4px solid ${rule.enabled ? '#48bb78' : '#a0aec0'}">
        <div class="row space mb-8">
          <div>
            <div class="row" style="gap:8px;align-items:center;margin-bottom:4px">
              <h4 style="margin:0">${escapeHtml(rule.rule_name)}</h4>
              ${enabledBadge}
            </div>
            ${rule.description ? `<div class="subtitle">${escapeHtml(rule.description)}</div>` : ''}
          </div>
          <div class="row" style="gap:4px">
            <button class="btn ghost" onclick="testRule(${rule.id})" title="Test this rule">ğŸ§ª Test</button>
            <button class="btn ghost" onclick="editRule(${rule.id})">âœï¸ Edit</button>
            <button class="btn ghost" onclick="deleteRule(${rule.id})" title="Delete this rule">ğŸ—‘ï¸</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px">
          <div>
            <div class="subtitle" style="margin-bottom:4px">ğŸ” Search Criteria</div>
            <div><strong>Search in:</strong> ${rule.search_in}</div>
            <div><strong>Text:</strong> "${escapeHtml(rule.search_text)}"</div>
            <div><strong>Case sensitive:</strong> ${rule.case_sensitive ? 'Yes' : 'No'}</div>
          </div>
          <div>
            <div class="subtitle" style="margin-bottom:4px">${actionIcon} Action</div>
            <div><strong>${actionLabel}</strong></div>
            ${formatActionParams(rule.action_type, rule.action_params)}
          </div>
        </div>

        ${rule.times_triggered > 0 ? `
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;font-size:12px;color:#718096">
            Triggered ${rule.times_triggered} time(s)
            ${rule.last_triggered_at ? ` â€¢ Last: ${new Date(rule.last_triggered_at).toLocaleString()}` : ''}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

// Format action parameters for display
function formatActionParams(actionType, params) {
  if (!params) return '';

  switch (actionType) {
    case 'assign_to_expert':
      return `<div>Expert ID: ${params.expert_id}</div>`;
    case 'create_for_customer':
      return `<div>Customer ID: ${params.customer_id}</div>`;
    case 'set_priority':
      return `<div>Priority: ${params.priority}</div>`;
    case 'set_status':
      return `<div>Status: ${params.status}</div>`;
    case 'add_tag':
      return `<div>Tag: ${params.tag}</div>`;
    default:
      return '';
  }
}

// Load experts and customers for dropdowns
async function loadExpertsAndCustomers() {
  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    // Load experts
    const expertsUrl = window.location.protocol + '//' + window.location.host + `/api/experts/${tenantCode}`;
    const expertsResponse = await fetch(expertsUrl, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const expertsData = await expertsResponse.json();
    if (expertsData.success) {
      ruleExperts = expertsData.experts;
    }

    // Load customers
    const customersUrl = window.location.protocol + '//' + window.location.host + `/api/customers`;
    const customersResponse = await fetch(customersUrl, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const customersData = await customersResponse.json();
    if (customersData.success) {
      ruleCustomers = customersData.customers;
    }
  } catch (error) {
    console.error('Error loading experts/customers:', error);
  }
}

// Show create rule modal
function showCreateRuleModal() {
  currentRuleId = null;
  document.getElementById('rule-modal-title').textContent = 'Create Rule';
  document.getElementById('rule-form').reset();
  document.getElementById('rule-id').value = '';
  document.getElementById('rule-enabled').checked = true;
  document.getElementById('rule-action-type').value = 'delete';
  updateActionParams();
  document.getElementById('rule-modal').style.display = 'block';
}

// Close rule modal
function closeRuleModal() {
  document.getElementById('rule-modal').style.display = 'none';
}

// Update action parameters based on selected action type
function updateActionParams() {
  const actionType = document.getElementById('rule-action-type').value;
  const container = document.getElementById('action-params-container');

  if (!actionType) {
    container.innerHTML = '';
    return;
  }

  let html = '';

  switch (actionType) {
    case 'delete':
      html = '<div class="subtitle" style="margin-top:8px">âš ï¸ This will permanently delete matching tickets</div>';
      break;

    case 'assign_to_expert':
      html = `
        <div class="mb-12">
          <label style="display:block;margin-bottom:4px;font-weight:600">Select Expert *</label>
          <select id="param-expert-id" class="input" required style="width:100%">
            <option value="">Choose an expert...</option>
            ${ruleExperts.map(expert => `<option value="${expert.id}">${expert.full_name || expert.username} (${expert.email})</option>`).join('')}
          </select>
        </div>
      `;
      break;

    case 'create_for_customer':
      html = `
        <div class="mb-12">
          <label style="display:block;margin-bottom:4px;font-weight:600">Select Customer *</label>
          <select id="param-customer-id" class="input" required style="width:100%">
            <option value="">Choose a customer...</option>
            ${ruleCustomers.map(customer => `<option value="${customer.id}">${customer.company_name || customer.full_name || customer.username} (${customer.email})</option>`).join('')}
          </select>
        </div>
      `;
      break;

    case 'set_priority':
      html = `
        <div class="mb-12">
          <label style="display:block;margin-bottom:4px;font-weight:600">Priority *</label>
          <select id="param-priority" class="input" required style="width:100%">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
      `;
      break;

    case 'set_status':
      html = `
        <div class="mb-12">
          <label style="display:block;margin-bottom:4px;font-weight:600">Status *</label>
          <select id="param-status" class="input" required style="width:100%">
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Pending">Pending</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>
        </div>
      `;
      break;

    case 'add_tag':
      html = `
        <div class="mb-12">
          <label style="display:block;margin-bottom:4px;font-weight:600">Tag *</label>
          <input type="text" id="param-tag" class="input" placeholder="e.g., auto-processed" required style="width:100%">
        </div>
      `;
      break;
  }

  container.innerHTML = html;
}

// Save rule (create or update)
async function saveRule(event) {
  event.preventDefault();

  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');
  const ruleId = document.getElementById('rule-id').value;

  // Gather form data
  const ruleData = {
    rule_name: document.getElementById('rule-name').value,
    description: document.getElementById('rule-description').value || null,
    enabled: document.getElementById('rule-enabled').checked,
    search_in: document.getElementById('rule-search-in').value,
    search_text: document.getElementById('rule-search-text').value,
    case_sensitive: document.getElementById('rule-case-sensitive').checked,
    action_type: document.getElementById('rule-action-type').value,
    action_params: getActionParams()
  };

  try {
    let url, method;
    if (ruleId) {
      url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/${ruleId}`;
      method = 'PUT';
    } else {
      url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}`;
      method = 'POST';
    }

    const response = await fetch(url, {
      method: method,
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(ruleData)
    });

    const data = await response.json();

    if (data.success) {
      closeRuleModal();
      await loadTicketRules();
      alert(ruleId ? 'âœ… Rule updated successfully!' : 'âœ… Rule created successfully!');
    } else {
      alert('âŒ Failed to save rule: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error saving rule:', error);
    alert('âŒ Error saving rule: ' + error.message);
  }
}

// Get action parameters from form
function getActionParams() {
  const actionType = document.getElementById('rule-action-type').value;
  const params = {};

  switch (actionType) {
    case 'assign_to_expert':
      const expertId = document.getElementById('param-expert-id').value;
      params.expert_id = parseInt(expertId);
      const expert = ruleExperts.find(e => e.id === parseInt(expertId));
      if (expert) {
        params.expert_name = expert.full_name || expert.username;
      }
      break;

    case 'create_for_customer':
      params.customer_id = parseInt(document.getElementById('param-customer-id').value);
      break;

    case 'set_priority':
      params.priority = document.getElementById('param-priority').value;
      break;

    case 'set_status':
      params.status = document.getElementById('param-status').value;
      break;

    case 'add_tag':
      params.tag = document.getElementById('param-tag').value;
      break;
  }

  return params;
}

// Edit rule
async function editRule(ruleId) {
  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/${ruleId}`;
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      const rule = data.rule;
      currentRuleId = ruleId;

      // Populate form
      document.getElementById('rule-modal-title').textContent = 'Edit Rule';
      document.getElementById('rule-id').value = rule.id;
      document.getElementById('rule-name').value = rule.rule_name;
      document.getElementById('rule-description').value = rule.description || '';
      document.getElementById('rule-enabled').checked = rule.enabled;
      document.getElementById('rule-search-in').value = rule.search_in;
      document.getElementById('rule-search-text').value = rule.search_text;
      document.getElementById('rule-case-sensitive').checked = rule.case_sensitive;
      document.getElementById('rule-action-type').value = rule.action_type;

      // Update action params
      updateActionParams();

      // Populate action params
      setTimeout(() => {
        switch (rule.action_type) {
          case 'assign_to_expert':
            if (rule.action_params.expert_id) {
              document.getElementById('param-expert-id').value = rule.action_params.expert_id;
            }
            break;
          case 'create_for_customer':
            if (rule.action_params.customer_id) {
              document.getElementById('param-customer-id').value = rule.action_params.customer_id;
            }
            break;
          case 'set_priority':
            if (rule.action_params.priority) {
              document.getElementById('param-priority').value = rule.action_params.priority;
            }
            break;
          case 'set_status':
            if (rule.action_params.status) {
              document.getElementById('param-status').value = rule.action_params.status;
            }
            break;
          case 'add_tag':
            if (rule.action_params.tag) {
              document.getElementById('param-tag').value = rule.action_params.tag;
            }
            break;
        }
      }, 100);

      // Show modal
      document.getElementById('rule-modal').style.display = 'block';
    } else {
      alert('Failed to load rule details');
    }
  } catch (error) {
    console.error('Error loading rule:', error);
    alert('Error loading rule: ' + error.message);
  }
}

// Delete rule
async function deleteRule(ruleId) {
  if (!confirm('Are you sure you want to delete this rule? This action cannot be undone.')) {
    return;
  }

  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/${ruleId}`;
    const response = await fetch(url, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      await loadTicketRules();
      alert('âœ… Rule deleted successfully!');
    } else {
      alert('âŒ Failed to delete rule: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error deleting rule:', error);
    alert('âŒ Error deleting rule: ' + error.message);
  }
}

// Test rule
async function testRule(ruleId) {
  const tenantCode = window.currentTenant || 'apoyar';
  const token = localStorage.getItem('token');

  try {
    const url = window.location.protocol + '//' + window.location.host + `/api/ticket-rules/${tenantCode}/${ruleId}/test`;
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const data = await response.json();

    if (data.success) {
      const matchingTickets = data.matching_tickets;
      const count = matchingTickets.length;

      if (count === 0) {
        alert('ğŸ” Test Results\n\nNo tickets match this rule.');
      } else {
        const ticketList = matchingTickets.slice(0, 10).map(t => `#${t.id}: ${t.title}`).join('\n');
        const more = count > 10 ? `\n... and ${count - 10} more` : '';
        alert(`ğŸ” Test Results\n\nThis rule would affect ${count} ticket(s):\n\n${ticketList}${more}`);
      }
    } else {
      alert('âŒ Test failed: ' + (data.message || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error testing rule:', error);
    alert('âŒ Error testing rule: ' + error.message);
  }
}



  </script>
<script>
// Register Service Worker for PWA
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function() {
    navigator.serviceWorker.register("/sw.js")
      .then(function(registration) {
        console.log("[PWA] ServiceWorker registered:", registration.scope);
      })
      .catch(function(error) {
        console.log("[PWA] ServiceWorker registration failed:", error);
      });
  });
}
</script>
</body>
</html>
